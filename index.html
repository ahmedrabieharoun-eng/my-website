<!DOCTYPE html>
<html lang="bn">
<head>
    <meta name='admaven-placement' content='Bqja6qdC7'>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TON Rewards</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <!-- SDK Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª -->
    <script src="//libtl.com/sdk.js" data-zone="10058786" data-sdk="show_10058786" async></script>
    
    <style>
        :root {
            --font-family: 'Poppins', sans-serif;
            --primary-color: #0088cc;
            --secondary-color: #00bcd4;
            --accent-color: #ff9800;
            --background-light: #f0f8ff;
            --surface-light: #ffffff;
            --text-primary-light: #1a237e;
            --text-secondary-light: #546e7a;
            --border-light: #bbdefb;
            --background-dark: #0a1a2a;
            --surface-dark: #1a2b3c;
            --text-primary-dark: #e3f2fd;
            --text-secondary-dark: #90a4ae;
            --border-dark: #37474f;
            --success: #4caf50;
            --danger: #f44336;
            --pending: #ff9800;
            --ship-gold: #ffd700;
            --ship-silver: #c0c0c0;
            --ocean-blue: #006994;
            --deck-wood: #8b4513;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: var(--font-family); 
            transition: background-color 0.3s, color 0.3s; 
            -webkit-font-smoothing: antialiased;
            background: linear-gradient(135deg, var(--background-dark) 0%, #0a2a3a 100%);
            color: var(--text-primary-dark);
            overflow-x: hidden;
        }

        .ship-container {
            position: relative;
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            background: linear-gradient(to bottom, #0a1a2a 0%, #0a2a3a 50%, #0a3a4a 100%);
            box-shadow: 0 0 30px rgba(0, 100, 200, 0.3);
            overflow: hidden;
        }

        .ship-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to bottom, var(--deck-wood) 0%, #6b3300 100%);
            z-index: 1;
            border-bottom: 3px solid var(--ship-gold);
        }

        .ship-container::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(to top, var(--deck-wood) 0%, #6b3300 100%);
            z-index: 1;
            border-top: 3px solid var(--ship-gold);
        }

        .wave {
            position: absolute;
            bottom: 80px;
            left: 0;
            width: 100%;
            height: 20px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 120" fill="%23006994"><path d="M0,64L80,58.7C160,53,320,43,480,48C640,53,800,75,960,74.7C1120,75,1280,53,1360,42.7L1440,32L1440,120L1360,120C1280,120,1120,120,960,120C800,120,640,120,480,120C320,120,160,120,80,120L0,120Z"></path></svg>');
            background-size: cover;
            opacity: 0.6;
            z-index: 0;
        }

        .wave-2 {
            bottom: 70px;
            height: 15px;
            opacity: 0.4;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 120" fill="%230088cc"><path d="M0,96L80,90.7C160,85,320,75,480,80C640,85,800,107,960,106.7C1120,107,1280,85,1360,74.7L1440,64L1440,120L1360,120C1280,120,1120,120,960,120C800,120,640,120,480,120C320,120,160,120,80,120L0,120Z"></path></svg>');
            background-size: cover;
        }

        .ship-bridge {
            position: relative;
            padding: 15px;
            background: linear-gradient(to bottom, rgba(10, 26, 42, 0.9) 0%, rgba(10, 42, 58, 0.7) 100%);
            border-bottom: 2px solid var(--ship-gold);
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ship-compass {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, var(--ship-silver) 0%, #888 100%);
            border: 2px solid var(--ship-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary-dark);
            font-size: 18px;
        }

        #user-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--ship-gold);
            object-fit: cover;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            flex-shrink: 0;
        }

        .user-info-compact {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        #user-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--ship-gold);
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .balance-display-compact {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
        }

        .balance-item-compact {
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 10px;
            border-radius: 15px;
            border: 1px solid var(--ship-silver);
            white-space: nowrap;
        }

        .balance-item-compact span {
            font-weight: 700;
            color: var(--ship-gold);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px;
            z-index: 2;
            position: relative;
        }

        .stat-card {
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            background: rgba(26, 43, 60, 0.8);
            border: 1px solid var(--border-dark);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .stat-card h3 {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            color: var(--text-secondary-dark);
        }

        .stat-card p {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--ship-gold);
        }

        .contest-status-box {
            padding: 15px;
            border-radius: 12px;
            margin: 15px;
            background: rgba(26, 43, 60, 0.8);
            border: 1px solid var(--border-dark);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            text-align: center;
        }

        .contest-status-active {
            border-color: var(--success);
            background: rgba(39, 174, 96, 0.1);
        }

        .contest-status-ended {
            border-color: var(--danger);
            background: rgba(231, 76, 60, 0.1);
        }

        .contest-status-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--ship-gold);
        }

        .contest-status-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--ship-gold);
        }

        .contest-status-message {
            font-size: 0.9rem;
            color: var(--text-secondary-dark);
            margin-top: 8px;
        }

        .converter-container, .contest-container, .withdraw-container {
            padding: 20px;
            border-radius: 12px;
            margin: 20px 15px;
            background: rgba(26, 43, 60, 0.8);
            border: 1px solid var(--border-dark);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            z-index: 2;
            position: relative;
        }

        .converter-header, .withdraw-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .converter-header i, .withdraw-header i {
            font-size: 1.5rem;
            color: var(--ship-gold);
        }

        .converter-header h3, .withdraw-header h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--ship-gold);
            margin: 0;
        }

        .converter-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .converter-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .converter-input-group input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-dark);
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary-dark);
        }

        .converter-currency {
            font-weight: 700;
            min-width: 60px;
            text-align: center;
            color: var(--ship-gold);
        }

        .converter-arrow {
            text-align: center;
            font-size: 1.5rem;
            color: var(--ship-gold);
        }

        .converter-rate {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary-dark);
            margin-top: 10px;
        }

        .ship-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            background: linear-gradient(to top, var(--deck-wood) 0%, #6b3300 100%);
            border-top: 3px solid var(--ship-gold);
            z-index: 1000;
        }

        .control-wheel {
            background: radial-gradient(circle, var(--ship-silver) 0%, #888 100%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--ship-gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            color: var(--text-primary-dark);
            font-size: 0.75rem;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .control-wheel::before {
            content: "";
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            background: 
                radial-gradient(circle, transparent 55%, var(--ship-gold) 55%, var(--ship-gold) 60%, transparent 60%),
                radial-gradient(circle, transparent 65%, var(--ship-gold) 65%, var(--ship-gold) 70%, transparent 70%);
            border-radius: 50%;
            z-index: -1;
            animation: rotateGear 10s linear infinite;
        }

        @keyframes rotateGear {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .control-wheel i {
            font-size: 1.5rem;
            margin-bottom: 4px;
            position: relative;
            z-index: 2;
        }

        .control-wheel span {
            position: relative;
            z-index: 2;
        }

        .control-wheel.active {
            background: radial-gradient(circle, var(--ship-gold) 0%, #daa520 100%);
            color: #000;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
        }

        .control-wheel:hover {
            transform: scale(1.05);
            box-shadow: 0 0 12px rgba(255, 215, 0, 0.7);
        }

        #app-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, var(--background-dark) 0%, #0a2a3a 100%);
        }

        .ship-anchor {
            width: 80px;
            height: 80px;
            position: relative;
            animation: anchorSwing 2s infinite ease-in-out;
        }

        .ship-anchor::before {
            content: "âš“";
            font-size: 80px;
            color: var(--ship-silver);
        }

        @keyframes anchorSwing {
            0%, 100% { transform: rotate(-10deg); }
            50% { transform: rotate(10deg); }
        }

        .ship-wheel-loader {
            width: 100px;
            height: 100px;
            position: relative;
            margin-bottom: 20px;
        }

        .ship-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, var(--ship-silver) 0%, #888 100%);
            border: 5px solid var(--ship-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: wheelRotate 3s linear infinite;
            position: relative;
        }

        .ship-wheel::before {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--ship-gold);
            border-radius: 50%;
        }

        .ship-wheel::after {
            content: "";
            position: absolute;
            width: 80%;
            height: 80%;
            border: 2px dashed var(--ship-gold);
            border-radius: 50%;
            animation: wheelRotateReverse 2s linear infinite;
        }

        @keyframes wheelRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes wheelRotateReverse {
            from { transform: rotate(0deg); }
            to { transform: rotate(-360deg); }
        }

        .ship-floating {
            animation: shipFloat 2s ease-in-out infinite;
        }

        @keyframes shipFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        #loading-text {
            margin-top: 20px;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--ship-gold);
        }

        .page {
            display: none;
            padding: 15px;
            padding-bottom: 100px;
            position: relative;
            z-index: 2;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.4s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .action-btn, .convert-btn, .withdraw-btn, .claim-daily-btn, .claim-referral-btn, .redeem-code-btn, .subscribe-ad-btn, .check-subscription-btn {
            padding: 12px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #000;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
            background: linear-gradient(45deg, var(--ship-gold), #ffa500);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
        }

        .action-btn:disabled, .convert-btn:disabled, .withdraw-btn:disabled, .claim-daily-btn:disabled, .claim-referral-btn:disabled, .redeem-code-btn:disabled, .subscribe-ad-btn:disabled {
            background: #808B96;
            cursor: not-allowed;
        }

        .action-btn:hover:not(:disabled), .convert-btn:hover:not(:disabled), .withdraw-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .task-container {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(26, 43, 60, 0.8);
            border: 1px solid var(--border-dark);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
        }

        .task-icon-img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
        }

        .task-info {
            flex: 1;
        }

        .task-info h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary-dark);
            margin-bottom: 4px;
        }

        .task-info p {
            font-size: 0.8rem;
            color: var(--text-secondary-dark);
            margin-bottom: 3px;
        }

        .ad-progress-inline {
            font-size: 0.75rem;
            color: var(--ship-gold);
            font-weight: 600;
            margin-top: 5px;
        }

        .add-task-btn {
            background: linear-gradient(45deg, var(--ship-gold), #ffa500);
            color: #000;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 20px auto;
            width: 90%;
            max-width: 300px;
            animation: pulse 2s infinite;
            font-size: 1rem;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        .add-task-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.8);
            animation: none;
        }

        .add-task-btn i {
            font-size: 1.1rem;
        }

        .progress-container-inline {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .progress-info-inline {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .progress-bar-bg-inline {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
        }

        .progress-bar-fg-inline {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--ship-gold), #ffa500);
            transition: width 0.3s ease;
        }

        .banned-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #c0392b, #e74c3c);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .banned-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .banned-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .banned-message {
            font-size: 1.1rem;
            margin-bottom: 25px;
            max-width: 400px;
        }

        .banned-contact {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 5s infinite ease-in-out;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }

        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .popup-content { padding: 30px; border-radius: 15px; text-align: center; max-width: 80%; background: rgba(26, 43, 60, 0.95); border: 2px solid var(--ship-gold); position: relative; }
        .popup-content h2 { margin-bottom: 15px; color: var(--ship-gold); }
        .popup-content p { margin-bottom: 20px; color: var(--text-primary-dark); }
        .popup-close-btn { padding: 10px 25px; border: none; border-radius: 8px; color: #fff; background: linear-gradient(45deg, var(--ship-gold), #ffa500); cursor: pointer; }
        .popup-loader .spinner { width: 40px; height: 40px; border-radius: 50%; border: 4px solid var(--ship-gold); border-top-color: transparent; animation: spin 1s linear infinite; margin: 0 auto 15px;}

        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-radius: 10px; margin-bottom: 10px; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); }
        .history-details p { margin: 0; } .history-details p:first-child { font-weight: 600; }
        .history-status { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: white; text-transform: capitalize; }
        .status-completed { background-color: var(--success); } .status-pending { background-color: var(--pending); } .status-rejected { background-color: var(--danger); }

        .subscription-container { padding: 20px; border-radius: 12px; margin: 20px 0; text-align: center; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); }
        .channel-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; margin: 10px 0; border-radius: 8px; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); }
        .channel-info { display: flex; align-items: center; gap: 10px; }
        .channel-icon { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .channel-status { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600; }
        .status-subscribed { background-color: var(--success); color: white; }
        .status-not-subscribed { background-color: var(--danger); color: white; }

        .countdown-display { font-size: 1.2rem; font-weight: 700; color: var(--ship-gold); margin: 10px 0; padding: 10px; border-radius: 8px; background: rgba(255, 215, 0, 0.1); text-align: center; }

        .form-group { margin-bottom: 15px; position: relative; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text-primary-dark); }
        .input-with-icon { position: relative; display: flex; align-items: center; }
        .input-with-icon i { position: absolute; left: 12px; color: var(--text-secondary-dark); z-index: 1; }
        .input-with-icon input { width: 100%; padding: 12px 12px 12px 40px; border-radius: 8px; border: 1px solid var(--border-dark); background: rgba(255, 255, 255, 0.1); color: var(--text-primary-dark); font-family: monospace; font-size: 0.9rem; }
        .input-with-icon input:focus { outline: none; border-color: var(--ship-gold) !important; box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2); }

        .validation-message { font-size: 0.8rem; margin-top: 5px; display: flex; align-items: center; gap: 5px; }
        .validation-success { color: var(--success); }
        .validation-error { color: var(--danger); }
        .validation-info { color: var(--text-secondary-dark); }

        .referral-notice { font-size: 0.85rem; text-align: center; margin-bottom: 15px; padding: 10px; border-radius: 8px; background: rgba(255, 215, 0, 0.1); }

        .daily-login-task { background: linear-gradient(45deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1)); border: 2px solid var(--ship-gold); flex-direction: column; align-items: stretch; }

        .contest-timer { background: linear-gradient(45deg, var(--ship-gold), #ffa500); color: #000; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 20px; font-weight: 700; font-size: 1.1rem; }

        .contest-info-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .contest-info-card { padding: 15px; border-radius: 10px; text-align: center; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); }
        .contest-info-value { font-size: 1.8rem; font-weight: 700; color: var(--ship-gold); margin: 5px 0; }
        .contest-info-label { font-size: 0.9rem; color: var(--text-secondary-dark); }

        .contest-guide-popup { 
            background: rgba(255, 215, 0, 0.1); 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            border-left: 4px solid var(--ship-gold);
            cursor: pointer;
            transition: all 0.3s;
        }

        .contest-guide-popup:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateX(5px);
        }

        .contest-guide-popup h4 { 
            margin-bottom: 10px; 
            color: var(--ship-gold); 
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contest-guide-content {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
        }

        .contest-prizes-compact { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .prize-compact-item { padding: 12px; border-radius: 8px; text-align: center; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); }
        .prize-rank-compact { font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; }
        .prize-amount-compact { font-weight: 700; color: var(--ship-gold); font-size: 1rem; }

        .contest-leaderboard-item-compact { display: flex; align-items: center; padding: 10px; margin: 6px 0; border-radius: 8px; transition: all 0.3s; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); }
        .contest-leaderboard-item-compact.current-user { background: linear-gradient(45deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.2)); border: 2px solid var(--ship-gold); }
        .contest-rank-compact { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(45deg, var(--ship-gold), #ffa500); display: flex; align-items: center; justify-content: center; color: #000; font-weight: 700; margin-right: 12px; font-size: 0.85rem; }
        .contest-user-name-compact { font-weight: 600; margin-bottom: 2px; font-size: 0.9rem; }
        .contest-user-points-compact { font-size: 0.8rem; color: var(--text-secondary-dark); }
        .contest-user-score-compact { font-weight: 700; color: var(--ship-gold); font-size: 1rem; margin-right: 10px; }
        .contest-user-prize { font-size: 0.8rem; color: var(--success); font-weight: 600; background: rgba(39, 174, 96, 0.1); padding: 4px 8px; border-radius: 12px; white-space: nowrap; }

        .view-full-btn { background: transparent; border: 1px solid var(--ship-gold); color: var(--ship-gold); padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s; }
        .view-full-btn:hover { background: var(--ship-gold); color: #000; }

        .referral-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .referral-stat-card { padding: 15px; border-radius: 10px; text-align: center; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); }
        .referral-stat-value { font-size: 1.4rem; font-weight: 700; color: var(--ship-gold); margin-bottom: 5px; }
        .referral-stat-label { font-size: 0.8rem; color: var(--text-secondary-dark); }

        .referral-list { max-height: 200px; overflow-y: auto; margin: 15px 0; border-radius: 10px; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); }
        .referral-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--border-dark); }
        .referral-list-item:last-child { border-bottom: none; }
        .referral-user-info { display: flex; align-items: center; gap: 10px; }
        .referral-user-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
        .referral-user-name { font-weight: 600; font-size: 0.9rem; }
        .referral-earnings { font-weight: 700; color: var(--success); font-size: 0.9rem; }

        .code-input-container { display: flex; gap: 10px; margin: 15px 0; }
        .code-input { flex: 1; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border-dark); background: rgba(255, 255, 255, 0.1); color: var(--text-primary-dark); font-family: monospace; font-weight: 600; text-transform: uppercase; }
        .code-input:focus { outline: none; border-color: var(--ship-gold); box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2); }
        .code-info { font-size: 0.8rem; color: var(--text-secondary-dark); margin-top: 10px; text-align: center; }

        .ad-channel-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; margin: 10px 0; border-radius: 8px; background: linear-gradient(45deg, rgba(52, 152, 219, 0.1), rgba(155, 89, 182, 0.1)); border: 1px solid var(--border-dark); }
        .ad-channel-info { display: flex; align-items: center; gap: 10px; flex: 1; }
        .ad-channel-icon { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .ad-channel-name { font-weight: 600; margin-bottom: 3px; }
        .ad-channel-description { font-size: 0.8rem; color: var(--text-secondary-dark); margin-bottom: 5px; }
        .ad-channel-contact { font-size: 0.75rem; color: var(--ship-gold); font-weight: 600; }
        .ad-channel-reward { text-align: right; margin-right: 15px; }
        .ad-reward-amount { font-size: 1.1rem; font-weight: 700; color: var(--ship-gold); margin-bottom: 5px; }
        .ad-reward-label { font-size: 0.75rem; color: var(--text-secondary-dark); }

        .daily-calendar-popup { max-width: 450px !important; position: relative; }
        .close-popup-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: var(--ship-gold);
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-popup-btn:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .streak-calendar-compact { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin: 15px 0; }
        .calendar-day-compact { padding: 10px; border-radius: 8px; text-align: center; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); }
        .calendar-day-compact.completed { background: rgba(76, 175, 80, 0.2); border-color: var(--success); }
        .calendar-day-compact.current { background: rgba(255, 215, 0, 0.2); border: 2px solid var(--ship-gold); }
        .calendar-day-compact.future { background: rgba(255, 255, 255, 0.05); opacity: 0.6; }
        .day-number-compact { font-weight: 700; margin-bottom: 5px; }
        .day-reward-compact { font-size: 0.8rem; color: var(--ship-gold); font-weight: 600; }
        .day-status-compact { font-size: 0.7rem; margin-top: 3px; }

        .daily-login-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 215, 0, 0.1);
            font-size: 0.9rem;
        }

        .referrals-container { padding: 20px; border-radius: 12px; margin: 20px 15px; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); backdrop-filter: blur(5px); }

        .withdrawal-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .withdrawal-option {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            border: 1px solid var(--border-dark);
            background: rgba(26, 43, 60, 0.8);
            transition: all 0.3s;
        }

        .withdrawal-option.active {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--ship-gold);
        }

        .withdrawal-option i {
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: var(--ship-gold);
        }

        .withdrawal-option h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary-dark);
        }

        .withdrawal-details {
            display: none;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.2);
            margin-bottom: 20px;
        }

        .withdrawal-details.active {
            display: block;
        }

        .withdrawal-info {
            font-size: 0.85rem;
            color: var(--text-secondary-dark);
            margin-bottom: 15px;
        }

        .withdrawal-info ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .withdrawal-info li {
            margin-bottom: 5px;
        }

        .method-details {
            display: none;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.2);
            margin-bottom: 20px;
        }

        .method-details.active {
            display: block;
        }

        .withdraw-amount-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-top: 5px;
            color: var(--text-secondary-dark);
        }

        .withdraw-btn-disabled {
            background: #808B96 !important;
            cursor: not-allowed !important;
        }

        .withdraw-btn-enabled {
            background: linear-gradient(45deg, var(--ship-gold), #ffa500) !important;
        }

        .contest-info-compact {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .contest-info-item {
            text-align: center;
            padding: 10px;
        }

        .contest-info-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--ship-gold);
            margin-bottom: 5px;
        }

        .contest-info-item .label {
            font-size: 0.8rem;
            color: var(--text-secondary-dark);
        }

        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--ship-gold);
        }

        #subscription-page {
            display: none;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--background-dark) 0%, #0a2a3a 100%);
            padding: 10px;
            position: relative;
            z-index: 2;
        }

        #subscription-page.active {
            display: block;
            animation: fadeIn 0.4s ease-in-out;
        }

        .subscription-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 12px;
            border-radius: 12px;
            background: rgba(26, 43, 60, 0.9);
            border: 2px solid var(--ship-gold);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
        }

        .channel-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            margin: 6px 0;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-dark);
            transition: all 0.3s;
            flex-wrap: wrap;
            gap: 6px;
        }

        .channel-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .channel-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .channel-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid var(--ship-gold);
            flex-shrink: 0;
        }

        .channel-info > div {
            min-width: 0;
            flex: 1;
        }

        .channel-info h4 {
            margin: 0;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .channel-info small {
            font-size: 0.65rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 0.8;
        }

        .channel-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin: 0 4px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .status-subscribed {
            background-color: var(--success);
            color: white;
        }

        .status-not-subscribed {
            background-color: var(--danger);
            color: white;
        }

        .join-channel-btn {
            background: linear-gradient(45deg, var(--ship-gold), #ffa500);
            color: #000;
            border: none;
            padding: 5px 10px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 0.75rem;
            flex-shrink: 0;
            min-width: 55px;
        }

        .join-channel-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }

        .check-subscription-btn {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 10px;
            border-radius: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 12px;
            font-size: 0.85rem;
        }

        .check-subscription-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 136, 204, 0.4);
        }

        .check-subscription-btn:disabled {
            background: #808B96;
            cursor: not-allowed;
        }

        /* Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ø§Ù„Ù…ØµØºØ±Ø© */
        .manual-task-compact {
            background: linear-gradient(45deg, rgba(155, 89, 182, 0.1), rgba(142, 68, 173, 0.1));
            border: 2px solid #9b59b6;
            flex-direction: column;
            align-items: stretch;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 10px;
        }

        .task-header-compact {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .task-icon-compact {
            width: 35px;
            height: 35px;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid var(--ship-gold);
        }

        .task-details-compact {
            flex: 1;
        }

        .task-title-compact {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary-dark);
            margin-bottom: 4px;
        }

        .task-description-compact {
            font-size: 0.75rem;
            color: var(--text-secondary-dark);
            margin-bottom: 5px;
        }

        .task-reward-compact {
            font-size: 0.8rem;
            color: var(--ship-gold);
            font-weight: 600;
        }

        .task-actions-compact {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .open-task-btn {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.75rem;
            font-weight: 600;
            flex: 1;
        }

        .open-task-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.4);
        }

        .upload-screenshot-btn {
            background: transparent;
            border: 1px solid var(--ship-gold);
            color: var(--ship-gold);
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            flex: 1;
        }

        .upload-screenshot-btn:hover {
            background: rgba(255, 215, 0, 0.1);
        }

        .task-status-compact {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 8px;
            text-align: center;
        }

        .status-pending {
            background: rgba(255, 165, 0, 0.2);
            color: var(--pending);
            border: 1px solid var(--pending);
        }

        .status-approved {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-rejected {
            background: rgba(244, 67, 54, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .screenshot-upload-area {
            border: 2px dashed var(--ship-gold);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s;
        }

        .screenshot-upload-area:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .screenshot-preview {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .upload-btn {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.4);
        }

        .change-screenshot-btn {
            background: transparent;
            border: 1px solid var(--ship-gold);
            color: var(--ship-gold);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            cursor: pointer;
            margin-top: 5px;
        }

        .change-screenshot-btn:hover {
            background: rgba(255, 215, 0, 0.1);
        }

        @media (max-width: 380px) {
            .subscription-container {
                padding: 8px;
            }
            
            .channel-item {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
                padding: 8px;
            }
            
            .channel-info {
                justify-content: center;
                margin-bottom: 6px;
                flex-wrap: wrap;
            }
            
            .channel-info h4 {
                font-size: 0.75rem;
            }
            
            .channel-info small {
                font-size: 0.6rem;
            }
            
            .channel-icon {
                width: 28px;
                height: 28px;
            }
            
            .channel-status {
                margin: 4px 0;
                order: 2;
                width: 100%;
                font-size: 0.65rem;
                padding: 3px 6px;
            }
            
            .join-channel-btn {
                order: 3;
                width: 100%;
                margin-top: 4px;
                font-size: 0.7rem;
                padding: 4px 8px;
            }
        }

        @media (max-width: 480px) {
            .channel-item {
                padding: 8px;
            }
            
            .channel-info h4 {
                font-size: 0.75rem;
            }
            
            .channel-info small {
                font-size: 0.6rem;
            }
            
            .channel-icon {
                width: 30px;
                height: 30px;
            }
            
            .join-channel-btn {
                padding: 4px 8px;
                font-size: 0.7rem;
                min-width: 50px;
            }
        }

        @media (min-width: 481px) {
            .channel-item {
                flex-wrap: nowrap;
            }
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¸Ø± -->
    <div id="banned-page" class="banned-container">
        <div class="banned-icon">ðŸš«</div>
        <div class="banned-title">Account Banned</div>
        <div class="banned-message" id="banned-reason">Your account has been suspended for violating our terms of service.</div>
        <div class="banned-contact">If you believe this is a mistake, please contact @aborabie777</div>
    </div>

    <!-- Ø§Ù„Ù†Ø¬ÙˆÙ… ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© -->
    <div class="stars" id="stars"></div>

    <div id="app-loader">
        <div class="ship-wheel-loader ship-floating">
            <div class="ship-wheel"></div>
        </div>
        <p id="loading-text">Preparing Your Ship...</p>
    </div>
    
    <!-- Ø§Ù„Ø¨ÙˆØ¨ Ø£Ø¨ -->
    <div id="popup" class="popup-overlay">
        <div class="popup-content">
            <div id="popup-body"></div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© -->
    <div id="daily-calendar-popup" class="popup-overlay" style="display: none;">
        <div class="popup-content daily-calendar-popup">
            <button class="close-popup-btn" onclick="closeDailyCalendar()">Ã—</button>
            <h2>ðŸ“… Daily Login Calendar</h2>
            <div id="streak-calendar-compact" class="streak-calendar-compact">
                <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙŠØ§Ù… Ù‡Ù†Ø§ -->
            </div>
            <div id="daily-login-status" class="daily-login-status">
                <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© -->
            </div>
            <div style="margin-top: 15px; padding: 10px; background: rgba(255, 215, 0, 0.1); border-radius: 8px;">
                <p style="margin: 0; font-size: 0.9rem;">Current Streak: <strong id="current-streak-display">0 days</strong></p>
            </div>
            <button class="popup-close-btn" onclick="closeDailyCalendar()" style="margin-top: 15px;">Close</button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø´Ø±Ø­ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© -->
    <div id="contest-guide-popup" class="popup-overlay" style="display: none;">
        <div class="popup-content" style="max-width: 400px;">
            <button class="close-popup-btn" onclick="closeContestGuide()">Ã—</button>
            <h2>ðŸŽ¯ How to Earn Points</h2>
            <div style="text-align: left; margin: 20px 0;">
                <p><strong>+1 Point</strong> for every ad watched</p>
                <p><strong>+15 Points</strong> for every successful referral</p>
                <p><strong>+10-50 Points</strong> for redeeming codes</p>
                <p>Compete for <strong>2 TON</strong> in total prizes!</p>
            </div>
            
            <h3>ðŸ† Prize Distribution</h3>
            <div class="contest-prizes-compact" style="margin: 15px 0;">
                <div class="prize-compact-item">
                    <div class="prize-rank-compact">ðŸ¥‡ 1st</div>
                    <div class="prize-amount-compact">0.6 TON</div>
                </div>
                <div class="prize-compact-item">
                    <div class="prize-rank-compact">ðŸ¥ˆ 2nd</div>
                    <div class="prize-amount-compact">0.4 TON</div>
                </div>
                <div class="prize-compact-item">
                    <div class="prize-rank-compact">ðŸ¥‰ 3rd</div>
                    <div class="prize-amount-compact">0.3 TON</div>
                </div>
                <div class="prize-compact-item">
                    <div class="prize-rank-compact">4th-5th</div>
                    <div class="prize-amount-compact">0.15 TON</div>
                </div>
                <div class="prize-compact-item">
                    <div class="prize-rank-compact">6th-8th</div>
                    <div class="prize-amount-compact">0.1 TON</div>
                </div>
                <div class="prize-compact-item">
                    <div class="prize-rank-compact">9th-10th</div>
                    <div class="prize-amount-compact">0.05 TON</div>
                </div>
            </div>
            <button class="popup-close-btn" onclick="closeContestGuide()">Close</button>
        </div>
    </div>
    
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ -->
    <div id="subscription-page">
        <div class="subscription-container">
            <h2 style="color: var(--ship-gold); margin-bottom: 10px;">ðŸ“¢ Required Subscription</h2>
            <p style="margin-bottom: 20px;">You must subscribe to our channels to use the bot and earn rewards!</p>
            
            <div id="channels-list">
                <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
            
            <!-- Ù‚Ø³Ù… Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù‚Ù†ÙˆØ§Øª -->
            <div id="ad-channels-section" style="margin-top: 30px; display: none;">
                <h3 style="color: var(--ship-gold); margin-bottom: 15px;">ðŸŽ¯ Advertised Channels</h3>
                <p style="margin-bottom: 15px; font-size: 0.9rem;">Subscribe to these channels for extra rewards!</p>
                <div id="ad-channels-list">
                    <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>
                <p style="margin-top: 15px; font-size: 0.8rem; color: var(--text-secondary-dark); text-align: center;">
                    ðŸ’¡ Want to advertise your channel here? Contact @aborabie777
                </p>
            </div>
            
            <button id="check-subscription-btn" class="check-subscription-btn" style="margin-top: 20px; width: 100%;">
                ðŸ”„ Check Subscription
            </button>
            
            <p style="margin-top: 15px; font-size: 0.9rem; opacity: 0.8;">
                After subscribing, click the button above to verify
            </p>

            <!-- Ø²Ø± Ø§Ù„ØªØ®Ø·ÙŠ Ù„Ù„ØªØ·ÙˆÙŠØ± ÙÙ‚Ø· -->
            <button id="skip-subscription-btn" style="margin-top: 10px; padding: 8px 15px; background: transparent; color: var(--ship-gold); border: 1px solid var(--ship-gold); border-radius: 5px; cursor: pointer; font-size: 0.8rem;">
                ðŸš¨ Skip for Testing (Dev Only)
            </button>
        </div>
    </div>

    <!-- ØªØµÙ…ÙŠÙ… Ø§Ù„Ø³ÙÙŠÙ†Ø© -->
    <div class="ship-container">
        <!-- Ø§Ù„Ø£Ù…ÙˆØ§Ø¬ -->
        <div class="wave"></div>
        <div class="wave wave-2"></div>

        <!-- Ø§Ù„Ø¬Ø³Ø± (Ø§Ù„Ø±Ø£Ø³) Ø§Ù„Ù…Ø¹Ø¯Ù„ -->
        <header class="ship-bridge">
            <img id="user-photo" src="https://ui-avatars.com/api/?name=User&background=random&size=80" alt="User">
            <div class="user-info-compact">
                <h1 id="user-name">Loading...</h1>
                <div class="balance-display-compact">
                    <div class="balance-item-compact">Main: <span id="user-balance">0.0000</span> TON</div>
                    <div class="balance-item-compact">RR: <span id="user-rr-balance">0</span></div>
                </div>
            </div>
            <div class="ship-compass">
                <i class="fas fa-compass"></i>
            </div>
        </header>

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <main id="main-content">
            <div id="home-page" class="page active">
                <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© -->
                <div class="contest-status-box contest-status-active" id="contest-status-box">
                    <div class="contest-status-title">Contest Status</div>
                    <div class="contest-status-value" id="contest-status-value">Active</div>
                    <div class="contest-status-message" id="contest-status-message">You are currently ranked #7 in the contest</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card"><h3>Today's Ads</h3><p id="daily-ads-watched">0 / 0</p></div>
                    <div class="stat-card"><h3>Total Ads Watched</h3><p id="total-ads-watched">0</p></div>
                </div>
                <div id="converter-container" class="converter-container">
                    <div class="converter-header">
                        <i class="fas fa-exchange-alt"></i>
                        <h3>RR to TON Converter</h3>
                    </div>
                    <div class="converter-form">
                        <div class="converter-input-group">
                            <input type="number" id="rr-amount" placeholder="0" min="0" step="100">
                            <div class="converter-currency">RR</div>
                        </div>
                        <div class="converter-arrow">â‡…</div>
                        <div class="converter-input-group">
                            <input type="number" id="ton-amount" placeholder="0.0000" min="0" step="0.0001" readonly>
                            <div class="converter-currency">TON</div>
                        </div>
                        <div class="converter-rate">
                            ðŸ’± Exchange Rate: 10,000,000 RR = 0.1 TON
                        </div>
                        <button id="convert-rr-btn" class="convert-btn" disabled>Convert to TON</button>
                    </div>
                </div>
                <div id="dynamic-links-container" style="margin-top: 20px;"></div>
            </div>

            <div id="tasks-page" class="page">
                <!-- ØªÙ… Ø¥Ø²Ø§Ù„Ø© Earning Wallet -->
                
                <div id="ad-progress-container" class="progress-container-inline"></div>
                <div id="ad-task-container"></div>
                
                <!-- Ø®Ø§Ù†Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ØµØºØ±Ø© -->
                <div id="redeem-code-container">
                    <div class="task-container" style="flex-direction: row; align-items: center; padding: 12px;">
                        <i class="fas fa-ticket-alt" style="font-size: 1.2rem; color: var(--ship-gold); margin-right: 10px;"></i>
                        <div class="task-info" style="flex: 1;">
                            <h3 style="font-size: 1rem;">Redeem Code</h3>
                            <p style="font-size: 0.8rem;">Enter code for rewards</p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="redeem-code-input" class="code-input" 
                                   placeholder="CODE" maxlength="20" style="width: 100px; padding: 8px;">
                            <button id="redeem-code-btn" class="redeem-code-btn" style="padding: 8px 12px;">
                                Redeem
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯ - ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
                <button class="add-task-btn" id="add-task-main-btn">
                    <i class="fas fa-plus-circle"></i> Add Task
                </button>
                
                <h2>Bonus Tasks</h2>
                <div id="dynamic-tasks-container"></div>
                
                <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ø§Ù„Ù…ØµØºØ±Ø© -->
                <h2>Manual Tasks</h2>
                <div id="manual-tasks-container"></div>
            </div>

            <div id="contest-page" class="page">
                <div class="contest-container">
                    <div class="contest-header">
                        <h2>ðŸ† Weekly Contest</h2>
                        <p>Compete with other users and win amazing prizes!</p>
                    </div>
                    
                    <div class="contest-timer">
                        <div id="contest-countdown">Loading...</div>
                    </div>
                    
                    <!-- Ù‚Ø³Ù… Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¯Ù…Ø¬ -->
                    <div class="contest-info-compact">
                        <div class="contest-info-item">
                            <div class="value" id="user-contest-points">0</div>
                            <div class="label">Your Points</div>
                        </div>
                        <div class="contest-info-item">
                            <div class="value" id="user-contest-rank">-</div>
                            <div class="label">Your Rank</div>
                        </div>
                    </div>
                    
                    <!-- Ø²Ø± Ø´Ø±Ø­ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ -->
                    <div class="contest-guide-popup" id="contest-guide-trigger">
                        <h4>
                            <i class="fas fa-question-circle" style="font-size: 1.5rem;"></i>
                            How to Earn Points & Prize Distribution
                        </h4>
                        <div class="contest-guide-content" id="contest-guide-content">
                            <p><strong>+1 Point</strong> for every ad watched</p>
                            <p><strong>+15 Points</strong> for every successful referral</p>
                            <p><strong>+10-50 Points</strong> for redeeming codes</p>
                            <p>Compete for <strong>2 TON</strong> in total prizes!</p>
                            
                            <div class="contest-prizes-compact" style="margin-top: 15px;">
                                <div class="prize-compact-item">
                                    <div class="prize-rank-compact">ðŸ¥‡ 1st</div>
                                    <div class="prize-amount-compact">0.6 TON</div>
                                </div>
                                <div class="prize-compact-item">
                                    <div class="prize-rank-compact">ðŸ¥ˆ 2nd</div>
                                    <div class="prize-amount-compact">0.4 TON</div>
                                </div>
                                <div class="prize-compact-item">
                                    <div class="prize-rank-compact">ðŸ¥‰ 3rd</div>
                                    <div class="prize-amount-compact">0.3 TON</div>
                                </div>
                                <div class="prize-compact-item">
                                    <div class="prize-rank-compact">4th-5th</div>
                                    <div class="prize-amount-compact">0.15 TON</div>
                                </div>
                                <div class="prize-compact-item">
                                    <div class="prize-rank-compact">6th-8th</div>
                                    <div class="prize-amount-compact">0.1 TON</div>
                                </div>
                                <div class="prize-compact-item">
                                    <div class="prize-rank-compact">9th-10th</div>
                                    <div class="prize-amount-compact">0.05 TON</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="contest-leaderboard-compact">
                        <h3>ðŸ… Top 10 Leaders</h3>
                        <div id="contest-leaderboard-compact-list">
                            <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† Ø§Ù„Ù…Ø®ØªØµØ±Ø© Ù‡Ù†Ø§ -->
                        </div>
                        <div class="view-full-leaderboard">
                            <button class="view-full-btn" onclick="showFullLeaderboard()">
                                View Full Leaderboard (Top 50)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ØµÙØ­Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
            <div id="referrals-page" class="page">
                <div class="referrals-container">
                    <h2>ðŸ‘¥ Refer & Earn</h2>
                    <p>Invite friends and earn <strong>15% of their earnings</strong></p>
                    
                    <div class="referral-stats">
                        <div class="referral-stat-card">
                            <div class="referral-stat-value" id="total-referrals-display">0</div>
                            <div class="referral-stat-label">Total Referrals</div>
                        </div>
                        <div class="referral-stat-card">
                            <div class="referral-stat-value" id="total-earnings-display">0.0000</div>
                            <div class="referral-stat-label">Total Earnings</div>
                        </div>
                        <div class="referral-stat-card">
                            <div class="referral-stat-value" id="pending-earnings-display">0.0000</div>
                            <div class="referral-stat-label">Pending Earnings</div>
                        </div>
                        <div class="referral-stat-card">
                            <div class="referral-stat-value">15%</div>
                            <div class="referral-stat-label">Commission Rate</div>
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>ðŸ“‹ Your Referral Link</h4>
                        <input type="text" id="referral-link" readonly style="width: 100%; padding: 12px; border-radius: 8px; border: 1px dashed var(--ship-gold); background: transparent; color: inherit; text-align: center; margin: 10px 0;">
                        <button id="copy-ref-link-btn" class="action-btn" style="width: 100%;">
                            ðŸ“‹ Copy Referral Link
                        </button>
                    </div>

                    <div style="margin-top: 20px;">
                        <h4>ðŸ‘¤ Your Referrals</h4>
                        <div class="referral-list" id="referrals-list-container">
                            <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ù‡Ù†Ø§ -->
                        </div>
                    </div>
                    
                    <button class="claim-referral-btn" id="claim-referral-earnings-btn" style="width: 100%; margin-top: 15px;" disabled>
                        ðŸŽ Claim Referral Earnings
                    </button>
                </div>
            </div>

            <div id="profile-page" class="page">
                <!-- ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ù…Ù† Ù‡Ù†Ø§ -->
                <div id="withdraw-section"></div>
                <div id="withdrawal-history-section" style="margin-top: 20px;">
                    <h2>Withdrawal History</h2>
                    <div id="withdrawal-history-list"></div>
                </div>
            </div>
        </main>

        <!-- Ø¹Ø¬Ù„Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©) -->
        <nav class="ship-controls">
            <div class="control-wheel active" data-page="home-page">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <div class="control-wheel" data-page="tasks-page">
                <i class="fas fa-tasks"></i>
                <span>Tasks</span>
            </div>
            <div class="control-wheel" data-page="contest-page">
                <i class="fas fa-trophy"></i>
                <span>Contest</span>
            </div>
            <div class="control-wheel" data-page="referrals-page">
                <i class="fas fa-users"></i>
                <span>Referrals</span>
            </div>
            <div class="control-wheel" data-page="profile-page">
                <i class="fas fa-user-alt"></i>
                <span>Profile</span>
            </div>
        </nav>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const tg = window.Telegram?.WebApp || {};
        
        // âœ… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        const firebaseConfig = {
  apiKey: "AIzaSyAk909CcFWn4ZMeBEM1yxRbQbW9w6UNo58",
  authDomain: "earn-money-c3bad.firebaseapp.com",
  databaseURL: "https://earn-money-c3bad-default-rtdb.firebaseio.com",
  projectId: "earn-money-c3bad",
  storageBucket: "earn-money-c3bad.firebasestorage.app",
  messagingSenderId: "1022688566011",
  appId: "1:1022688566011:web:690f6faa19dd3337a2ee5e",
  measurementId: "G-0CH1LBFLH2"
        };
        const NOTIFICATION_USERNAME = "aborabie777";

        // âœ… Ù…ØªØºÙŠØ±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Firebase
        let dailyLoginRewards = [0.0001, 0.0002, 0.0004, 0.0008, 0.0016, 0.0032, 0.0064];
        
        // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØºÙŠÙŠØ± ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù…Ù† 15 Ø¥Ù„Ù‰ 5 Ø«ÙˆØ§Ù†ÙŠ
        let minAdDuration = 5000; // 5 Ø«ÙˆØ§Ù†ÙŠ ÙÙ‚Ø·

        // ðŸš« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© ÙÙ‚Ø·
        const bannedCountries = [
            'IN', // India
            'RU', // Russian Federation
            'LY', // Libyan Arab Jamahiriya
            'AF', // Afghanistan
            'NL'  // Netherlands
        ];

        let isUserBanned = false;
        let banReason = "";

        // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ
        let lastAdWatchTime = 0;
        let adStartTime = 0;
        let isAdInProgress = false;
        let adWatchTimer = null;

        let appConfig = {}; let userState = {}; let tgUser = {}; let earningWalletBalance = 0;
        let userTransactions = [];
        let isSubscribedToAllChannels = false;

        // âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
        let contestData = {
            userPoints: 0,
            userRank: 0,
            leaderboard: [],
            endTime: null,
            durationDays: 7,
            isActive: true // Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
        };

        // âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ
        let dailyLoginData = {
            currentStreak: 0,
            lastLoginDate: null,
            claimedDays: []
        };

        // âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
        let referralData = {
            totalEarnings: 0,
            pendingEarnings: 0,
            referredUsers: []
        };

        // âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
        let redeemedCodes = [];

        // âœ… Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„ØµÙØ±Ø§Ø¡
        let userRRBalance = 0;
        const RR_TO_TON_RATE = 10000000;

        // âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
        let manualTasks = [];
        let userManualTasks = {};

        // ðŸŒ Ù…ØªØºÙŠØ±Ø§Øª ÙƒØ´Ù Ø§Ù„Ø¯ÙˆÙ„Ø©
        let userCountryData = null;
        let isUserCountryAllowed = true; // Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ø³Ù…ÙˆØ­ Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„ÙƒØ´Ù

        // âœ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        const requiredChannels = [
            {
                id: 'earnmoney174688',
                name: 'Earn Money Public',
                username: 'earnmoney174688',
                url: 'https://t.me/earnmoney174688',
                icon: 'https://img.icons8.com/ios-filled/100/group.png'
            },
            {
                id: 'earnmoney139482',
                name: 'Earn Money Withdrawals',
                username: 'earnmoney139482', 
                url: 'https://t.me/earnmoney139482',
                icon: 'https://img.icons8.com/ios-filled/100/money-bag.png'
            },
            {
                id: 'earnmoneywithredone',
                name: 'Earn Money With Redone',
                username: 'EarnMoneyWithRedone',
                url: 'https://t.me/EarnMoneyWithRedone',
                icon: 'https://img.icons8.com/ios-filled/100/rocket.png'
            }
        ];

        // âœ… Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
        let adChannels = [];

        const popup = document.getElementById('popup');
        const popupBody = document.getElementById('popup-body');
        const loadingText = document.getElementById('loading-text');

        // âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø¬ÙˆÙ… ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const starCount = 100;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                
                const left = Math.random() * 100;
                const top = Math.random() * 100;
                const size = Math.random() * 3;
                const duration = 3 + Math.random() * 7;
                const delay = Math.random() * 5;
                
                star.style.left = `${left}%`;
                star.style.top = `${top}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.animationDuration = `${duration}s`;
                star.style.animationDelay = `${delay}s`;
                
                starsContainer.appendChild(star);
            }
        }

        const showPopup = (content) => { popupBody.innerHTML = content; popup.style.display = 'flex'; };
        const closePopup = () => { popup.style.display = 'none'; };

        // âœ… Ø¯Ø§Ù„Ø© ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø© Telegram - ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        const openTelegramContact = () => {
            const telegramUrl = 'https://t.me/aborabie777';
            try {
                if (tg.openLink) {
                    tg.openLink(telegramUrl);
                } else {
                    window.open(telegramUrl, '_blank');
                }
            } catch (error) {
                window.open(telegramUrl, '_blank');
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø´Ø±Ø­ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© - ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§
        window.openContestGuide = () => {
            document.getElementById('contest-guide-popup').style.display = 'flex';
        };

        // âœ… Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø´Ø±Ø­ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
        window.closeContestGuide = () => {
            document.getElementById('contest-guide-popup').style.display = 'none';
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Firebase
        const authenticateFirebase = async () => {
            try {
                const auth = firebase.auth();
                await auth.signInAnonymously();
                console.log("âœ… ØªÙ… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Firebase Ø¨Ù†Ø¬Ø§Ø­");
                return true;
            } catch (error) {
                console.error("âŒ ÙØ´Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Firebase:", error);
                return false;
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±
        const checkUserBanStatus = async (db) => {
            try {
                const banRef = db.ref(`bannedUsers/${tgUser.id}`);
                const banSnap = await banRef.once('value');
                const banData = banSnap.val();
                
                if (banData && banData.isBanned) {
                    isUserBanned = true;
                    banReason = banData.reason || "Violation of terms of service";
                    showBannedPage();
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error checking ban status:', error);
                return false;
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø­Ø¸Ø±
        const showBannedPage = () => {
            document.getElementById('banned-reason').textContent = banReason;
            document.getElementById('banned-page').style.display = 'flex';
            document.getElementById('app-loader').style.display = 'none';
            document.getElementById('subscription-page').classList.remove('active');
            document.querySelector('.ship-container').style.display = 'none';
        };

        // ðŸ“ Ø¯Ø§Ù„Ø© Ù„ÙƒØ´Ù Ø§Ù„Ø¯ÙˆÙ„Ø©
        const detectUserCountry = async () => {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                return {
                    countryCode: data.country_code,
                    countryName: data.country_name,
                    ip: data.ip
                };
            } catch (error) {
                console.error('Error detecting country:', error);
                return {
                    countryCode: 'UNKNOWN',
                    countryName: 'Unknown',
                    ip: 'Unknown'
                };
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© (Ù…Ø¨Ø³Ø·Ø©)
        const isCountryAllowed = (countryCode) => {
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯ÙˆÙ„Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©
            if (bannedCountries.includes(countryCode)) {
                return false;
            }
            
            // ÙƒÙ„ Ø§Ù„Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø®Ø±Ù‰ Ù…Ø³Ù…ÙˆØ­Ø©
            return true;
        };

        // ðŸŽ¯ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© - ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§
        const showMandatoryBonusAd = async () => {
            return new Promise((resolve) => {
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø£Ù† Ù‡Ù†Ø§Ùƒ Ø¥Ø¹Ù„Ø§Ù† Ø¥Ø¶Ø§ÙÙŠ Ù…Ø·Ù„ÙˆØ¨
                showPopup(`
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">âš¡</div>
                        <h2 style="color: var(--ship-gold); margin-bottom: 10px;">Almost There!</h2>
                        <p style="margin-bottom: 20px; color: var(--text-primary-dark);">
                            Watch one quick ad to claim your <strong>1,000 RR</strong> reward!
                        </p>
                        <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary-dark);">
                                â±ï¸ This ad is required to receive your reward
                            </p>
                        </div>
                        <button class="popup-close-btn" id="start-mandatory-ad-btn" 
                                style="background: linear-gradient(45deg, var(--ship-gold), #ffa500); color: #000; width: 100%;">
                            Watch Ad to Claim Reward
                        </button>
                    </div>
                `);

                // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø­Ø¯Ø« Ù„Ù„Ø²Ø±
                setTimeout(() => {
                    const button = document.getElementById('start-mandatory-ad-btn');
                    if (button) {
                        button.addEventListener('click', async () => {
                            closePopup();
                            try {
                                await window.startMandatoryAd();
                                resolve(true);
                            } catch (error) {
                                resolve(false);
                            }
                        });
                    }
                }, 100);
            });
        };

        // âš¡ Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ - ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§
        window.startMandatoryAd = async () => {
            closePopup();
            
            showPopup(`
                <div style="text-align: center;">
                    <div class="spinner" style="width:40px;height:40px;border-radius:50%;border:4px solid var(--ship-gold);border-top-color:transparent;animation:spin 1s linear infinite;margin:0 auto 15px;"></div>
                    <h2>Loading Reward Ad</h2>
                    <p>Final step to claim your reward...</p>
                </div>
            `);

            return new Promise((resolve, reject) => {
                try {
                    if (typeof show_10058786 === 'function') {
                        show_10058786('pop').then(() => {
                            closePopup();
                            resolve(true);
                        }).catch(error => {
                            closePopup();
                            reject(error);
                        });
                    } else {
                        closePopup();
                        reject(new Error('Ad function not available'));
                    }
                } catch (error) {
                    closePopup();
                    reject(error);
                }
            });
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† - Ù…Ø¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
        const handleWatchAd = async () => {
            // ðŸŒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© Ø£ÙˆÙ„Ø§Ù‹
            if (!isUserCountryAllowed) {
                const countryName = userCountryData.countryName || 'your country';
                try{ 
                    if (tg.showAlert) tg.showAlert(`ðŸš« Ads are not available in ${countryName}. Thank you for your understanding.`); 
                }catch{} 
                return; 
            }

            if (isUserBanned) {
                try{ 
                    if (tg.showAlert) tg.showAlert("Your account is banned. Contact support."); 
                }catch{} 
                return; 
            }

            if (!isSubscribedToAllChannels) {
                try{ 
                    if (tg.showAlert) tg.showAlert("Please subscribe to all required channels first!"); 
                }catch{} 
                return; 
            }

            if (userState.dailyAdCount >= appConfig.dailyAdLimit) { 
                try{ 
                    if (tg.showAlert) tg.showAlert("You have reached your daily ad watch limit."); 
                }catch{} 
                return; 
            }
            
            const currentTime = Date.now();
            if (userState.breakUntil && currentTime < userState.breakUntil) {
                const remaining = Math.ceil((userState.breakUntil - currentTime) / 60000);
                try{ 
                    if (tg.showAlert) tg.showAlert(`Please wait for ${remaining} more minutes.`); 
                }catch{} 
                return;
            }

            const adFunction = window['show_' + appConfig.adZoneId];
            if (typeof adFunction !== 'function') {
                try{ 
                    if (tg.showAlert) tg.showAlert("Ad network is not ready yet. Please wait a few seconds and try again."); 
                }catch{} 
                return;
            }

            const watchBtn = document.getElementById('watch-ad-btn');
            if (watchBtn) {
                watchBtn.disabled = true;
                watchBtn.textContent = 'Loading...';
            }

            showPopup(`
                <div style="margin-bottom:10px;">
                    <div class="spinner" style="width:40px;height:40px;border-radius:50%;border:4px solid var(--ship-gold);border-top-color:transparent;animation:spin 1s linear infinite;margin:0 auto;"></div>
                </div>
                <h2>Loading Ad</h2>
                <p>Please wait a moment...</p>
            `);

            try {
                adStartTime = Date.now();
                isAdInProgress = true;

                // ðŸŽ¬ Ø§Ù„Ø®Ø·ÙˆØ© 1: Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                await adFunction();
                
                // âœ… Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©
                const bonusWatched = await showMandatoryBonusAd();
                
                if (!bonusWatched) {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ…Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØŒ Ù„Ø§ ÙŠØ¹Ø·ÙŠ Ù…ÙƒØ§ÙØ£Ø©
                    try{ 
                        if (tg.showAlert) tg.showAlert("You need to complete the bonus ad to receive your reward."); 
                    }catch{}
                    
                    if (watchBtn) {
                        watchBtn.disabled = false;
                        watchBtn.textContent = 'Watch Ad';
                    }
                    
                    isAdInProgress = false;
                    return;
                }

                closePopup();
                
                const adEndTime = Date.now();
                const adDuration = adEndTime - adStartTime;
                
                // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† 5 Ø«ÙˆØ§Ù†ÙŠ ÙÙ‚Ø·
                if (adDuration < minAdDuration) {
                    try{ 
                        if (tg.showAlert) tg.showAlert(`Ad watched too quickly! Please watch the ad for at least ${minAdDuration/1000} seconds to earn rewards.`); 
                    }catch{}
                    
                    if (watchBtn) {
                        watchBtn.disabled = false;
                        watchBtn.textContent = 'Watch Ad';
                    }
                    
                    isAdInProgress = false;
                    return;
                }
                
                lastAdWatchTime = Date.now();
                const adValueRR = 1000;

                // ðŸŽ Ù…Ù†Ø­ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙÙŠØ©)
                userRRBalance += adValueRR;
                localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());

                userState.dailyAdCount++;
                userState.lifetimeAdCount++;
                userState.totalEarned = (userState.totalEarned || 0) + (adValueRR / RR_TO_TON_RATE);

                const db = firebase.database(); 
                const userRef = db.ref(`users/${tgUser.id}`);
                const updates = {};
                updates.dailyAdCount = userState.dailyAdCount;
                updates.lifetimeAdCount = userState.lifetimeAdCount;
                updates.totalEarned = userState.totalEarned;
                
                if ((userState.dailyAdCount) % (appConfig.adsPerBreak || 0) === 0 && (appConfig.adsPerBreak || 0) > 0) {
                    updates.breakUntil = Date.now() + ((appConfig.breakDuration || 0) * 60000);
                    userState.breakUntil = updates.breakUntil;
                }
                await userRef.update(updates);

                const today = new Date().toISOString().slice(0, 10);
                await db.ref(`userEarnings/${tgUser.id}/${today}`).set(firebase.database.ServerValue.increment(adValueRR / RR_TO_TON_RATE));

                if (userState.referredBy) {
                    await updateReferralEarnings(tgUser.id, adValueRR);
                }

                // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù†Ø´Ø·Ø©
                if (contestData.isActive) {
                    await updateContestPointsOnAdWatch();
                }

                // âœ… Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                let rewardMessage = `+${adValueRR.toLocaleString()} RR added to your balance.`;
                if (contestData.isActive) {
                    rewardMessage += ` +1 Contest Point!`;
                }
                
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert(rewardMessage); 
                }catch{}
                
                renderUI();

            } catch (error) {
                console.error("Ad failed to load:", error);
                closePopup();
                try{ 
                    if (tg.showAlert) tg.showAlert("Ad could not be loaded. Please try again."); 
                }catch{}
                
                if (watchBtn) {
                    watchBtn.disabled = false;
                    watchBtn.textContent = 'Watch Ad';
                }
                isAdInProgress = false;
            }
        };

        // ðŸš« Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ø¯ÙˆÙ„Ø©
        const showCountryRestrictionMessage = () => {
            const homePage = document.getElementById('home-page');
            if (homePage) {
                const existingMessage = document.getElementById('country-restriction-message');
                if (!existingMessage) {
                    const restrictionMessage = document.createElement('div');
                    restrictionMessage.id = 'country-restriction-message';
                    restrictionMessage.style.cssText = `
                        background: linear-gradient(45deg, #ff6b6b, #ee5a52);
                        color: white;
                        padding: 15px;
                        border-radius: 10px;
                        margin: 15px;
                        text-align: center;
                        border: 2px solid #ffd700;
                        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
                    `;
                    restrictionMessage.innerHTML = `
                        <h3 style="margin-bottom: 8px; color: white;">ðŸš« Regional Restriction</h3>
                        <p style="margin: 0; font-size: 0.9rem;">
                            Ads are not available in ${userCountryData.countryName}. 
                            You can still use other features of the app.
                        </p>
                    `;
                    homePage.insertBefore(restrictionMessage, homePage.firstChild);
                }
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Firebase
        const loadDynamicSettings = async (db) => {
            try {
                const settingsRef = db.ref('settings');
                const settingsSnap = await settingsRef.once('value');
                const settings = settingsSnap.val();
                
                if (settings) {
                    if (settings.dailyLoginRewards && Array.isArray(settings.dailyLoginRewards)) {
                        dailyLoginRewards = settings.dailyLoginRewards;
                    }
                    
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† 5 Ø«ÙˆØ§Ù†ÙŠ
                    minAdDuration = 5000;
                    
                    console.log('âœ… Dynamic settings loaded:', { dailyLoginRewards, minAdDuration });
                }
            } catch (error) {
                console.error('Error loading dynamic settings:', error);
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        const loadUserData = async (db) => {
            const isBanned = await checkUserBanStatus(db);
            if (isBanned) {
                return;
            }

            const referralParam = getReferralParam();
            let referralIdCandidate = null;

            if (referralParam && referralParam.trim() !== '') {
                const cleanParam = referralParam.trim();
                if (!isNaN(Number(cleanParam))) {
                    referralIdCandidate = Number(cleanParam);
                    console.log('âœ… Valid referral ID found:', referralIdCandidate);
                } else {
                    console.log('âŒ Invalid referral ID format:', cleanParam);
                }
            }

            const localUserId = (tgUser && tgUser.id) ? tgUser.id : ('guest_' + (Date.now()));

            const userRef = db.ref(`users/${localUserId}`);
            
            try {
                const snapshot = await userRef.once('value');
                let userData = snapshot.val();

                if (!userData) {
                    // âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                    const newUserData = {
                        id: localUserId,
                        firstName: (tgUser && tgUser.first_name) || '',
                        lastName: (tgUser && tgUser.last_name) || '',
                        username: (tgUser && tgUser.username) || '',
                        photoUrl: (tgUser && tgUser.photo_url) || '',
                        balance: 0, 
                        referrals: 0, 
                        referredBy: referralIdCandidate, 
                        totalEarned: 0,
                        lifetimeAdCount: 0, 
                        lastAdWatchDate: new Date().toISOString().slice(0, 10), 
                        dailyAdCount: 0, 
                        breakUntil: 0, 
                        completedTasks: {}, 
                        welcomed: false,
                        joinDate: new Date().toISOString(),
                        subscribedToChannels: isSubscribedToAllChannels,
                        lastActive: new Date().toISOString(),
                        language: (tgUser && tgUser.language_code) || 'en'
                    };
                    
                    // âœ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
                    try {
                        await userRef.set(newUserData);
                        userData = newUserData;
                        console.log('âœ… New user created successfully with ID:', localUserId);
                        
                        // âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­
                        if (referralIdCandidate && referralIdCandidate != localUserId && isSubscribedToAllChannels) {
                            console.log('ðŸ”„ Processing referral for new user:', referralIdCandidate);
                            try {
                                await processReferral(referralIdCandidate, localUserId, db);
                                console.log('âœ… Referral processed successfully for new user');
                            } catch (referralError) {
                                console.error('âŒ Failed to process referral for new user:', referralError);
                            }
                        }
                    } catch (createError) {
                        console.error('âŒ Failed to create new user in Firebase:', createError);
                        // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© Ù…Ø¤Ù‚ØªØ© ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸
                        userData = newUserData;
                        console.log('ðŸ”„ Using local user data due to Firebase error');
                    }
                } else {
                    // âœ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                    const updates = {};
                    
                    if (referralIdCandidate && referralIdCandidate != localUserId && !userData.referredBy && isSubscribedToAllChannels) {
                        updates.referredBy = referralIdCandidate;
                        console.log('ðŸ”„ Processing referral for existing user:', referralIdCandidate);
                    }
                    
                    // âœ… ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
                    const today = new Date().toISOString().slice(0, 10);
                    if (userData.lastAdWatchDate !== today) {
                        updates.dailyAdCount = 0;
                        updates.lastAdWatchDate = today;
                    }
                    
                    // âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø£ÙŠ
                    if (Object.keys(updates).length > 0) {
                        try {
                            await userRef.update(updates);
                            userData = { ...userData, ...updates };
                        } catch (updateError) {
                            console.error('âŒ Failed to update user data:', updateError);
                        }
                    }
                    
                    // âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                    if (referralIdCandidate && referralIdCandidate != localUserId && !userData.referredBy && isSubscribedToAllChannels) {
                        try {
                            await processReferral(referralIdCandidate, localUserId, db);
                        } catch (referralError) {
                            console.error('âŒ Failed to process referral for existing user:', referralError);
                        }
                    }
                }
                
                userState = userData;
                
            } catch (error) {
                console.error('âŒ Error in loadUserData:', error);
                // âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© Ù…Ø¤Ù‚ØªØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
                userState = {
                    id: localUserId,
                    firstName: (tgUser && tgUser.first_name) || '',
                    lastName: (tgUser && tgUser.last_name) || '',
                    username: (tgUser && tgUser.username) || '',
                    balance: 0,
                    dailyAdCount: 0,
                    lastAdWatchDate: new Date().toISOString().slice(0, 10),
                    subscribedToChannels: isSubscribedToAllChannels
                };
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const initApp = async () => {
            try {
                createStars();
                
                if (tg.ready) { tg.ready(); try { tg.expand(); } catch(e){} }
                
                tgUser = (tg.initDataUnsafe && tg.initDataUnsafe.user) || {};
                if (!tgUser || !tgUser.id) { 
                    console.warn("Telegram user not available in this environment."); 
                    tgUser = { id: 'dev_user_' + Date.now(), first_name: 'Dev', last_name: 'User' };
                }

                console.log('ðŸ“± Telegram WebApp Data:', {
                    user: tgUser,
                    initData: tg.initData,
                    initDataUnsafe: tg.initDataUnsafe
                });

                firebase.initializeApp(firebaseConfig); 
                const db = firebase.database();

                // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Firebase Ø£ÙˆÙ„Ø§Ù‹
                const isAuthenticated = await authenticateFirebase();
                if (!isAuthenticated) {
                    console.error("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¯ÙˆÙ† Ù…ØµØ§Ø¯Ù‚Ø© Firebase");
                    return;
                }

                await loadDynamicSettings(db);

                const configSnapshot = await db.ref('config').once('value');
                appConfig = configSnapshot.val() || {};
                
                appConfig.referralBonus = appConfig.referralBonus || 0.001;
                appConfig.botUsername = appConfig.botUsername || "Aborabie777_bot";
                appConfig.minimumWithdrawReferrals = appConfig.minimumWithdrawReferrals || 0;
                
                console.log('ðŸ”§ Firebase Config Loaded:', {
                    botToken: appConfig.botToken ? 'âœ… Loaded' : 'âŒ Missing',
                    botUsername: appConfig.botUsername,
                    adValue: appConfig.adValue,
                    dailyAdLimit: appConfig.dailyAdLimit
                });

                // ðŸŒ ÙƒØ´Ù Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                console.log('ðŸŒ Detecting user country...');
                const userCountry = await detectUserCountry();
                console.log('ðŸ“ User country detected:', userCountry);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©
                const isAllowed = isCountryAllowed(userCountry.countryCode);
                console.log(`ðŸŽ¯ Country ${userCountry.countryCode} allowed:`, isAllowed);
                
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆÙ„Ø©
                userCountryData = userCountry;
                isUserCountryAllowed = isAllowed;

                await loadContestData(db);

                await loadDailyLoginData(db);

                await loadReferralData(db);

                await loadRedeemedCodes(db);

                await loadAdChannels(db);

                // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
                await loadManualTasks(db);

                userRRBalance = parseInt(localStorage.getItem(`userRRBalance_${tgUser.id || 'guest'}`) || '0');

                showPopup(`
                    <div style="margin-bottom:10px;">
                        <div class="spinner" style="width:40px;height:40px;border-radius:50%;border:4px solid var(--ship-gold);border-top-color:transparent;animation:spin 1s linear infinite;margin:0 auto;"></div>
                    </div>
                    <h2>Checking Subscription</h2>
                    <p>Verifying channel subscriptions...</p>
                `);

                const { subscriptionResults, allSubscribed, allSuccessful } = await checkAllSubscriptions();
                closePopup();
                
                if (!allSubscribed) {
                    document.getElementById('app-loader').style.display = 'none';
                    document.getElementById('subscription-page').classList.add('active');
                    document.querySelector('.ship-container').style.display = 'none';
                    updateSubscriptionUI(subscriptionResults);
                    await renderAdChannels();
                    
                    document.getElementById('check-subscription-btn').addEventListener('click', async () => {
                        document.getElementById('check-subscription-btn').disabled = true;
                        document.getElementById('check-subscription-btn').textContent = 'Checking...';
                        
                        showPopup(`
                            <div style="margin-bottom:10px;">
                                <div class="spinner" style="width:40px;height:40px;border-radius:50%;border:4px solid var(--ship-gold);border-top-color:transparent;animation:spin 1s linear infinite;margin:0 auto;"></div>
                            </div>
                            <h2>Checking Subscription</h2>
                            <p>Verifying channel subscriptions...</p>
                        `);

                        const newResults = await checkAllSubscriptions();
                        closePopup();
                        
                        document.getElementById('check-subscription-btn').disabled = false;
                        document.getElementById('check-subscription-btn').textContent = 'ðŸ”„ Check Subscription';
                        
                        updateSubscriptionUI(newResults.subscriptionResults);
                        await renderAdChannels();
                        
                        if (newResults.allSubscribed) {
                            document.getElementById('subscription-page').classList.remove('active');
                            await continueAppInitialization(db);
                        } else {
                            try {
                                if (tg.showAlert) tg.showAlert("Please subscribe to all channels first!");
                            } catch(e) {}
                        }
                    });

                    document.getElementById('skip-subscription-btn').addEventListener('click', () => {
                        if (confirm('ðŸš¨ This is for development only! Are you sure you want to skip subscription?')) {
                            skipSubscription();
                        }
                    });
                    
                    return;
                }
                
                await continueAppInitialization(db);
                
            } catch (error) { 
                console.error("Initialization failed:", error); 
                try { 
                    if (tg.showAlert) tg.showAlert("Failed to load app data. Please try again."); 
                } catch(e){} 
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        const continueAppInitialization = async (db) => {
            try {
                await loadUserData(db);

                const historyPromise = loadTransactionHistory(db);
                await historyPromise;

                loadAdSdk(appConfig.adZoneId);

                renderUI(); 
                setupNavigation(); 
                setupEventListeners();

                setTimeout(() => {
                    document.getElementById('app-loader').style.display = 'none';
                    document.getElementById('subscription-page').classList.remove('active');
                    document.querySelector('.ship-container').style.display = 'block';
                }, 300);
            } catch (error) {
                console.error("Error in continueAppInitialization:", error);
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
        const loadContestData = async (db) => {
            try {
                const contestRef = db.ref('contest');
                const contestSnap = await contestRef.once('value');
                const contestConfig = contestSnap.val() || {};
                
                contestData.durationDays = contestConfig.durationDays || 7;
                contestData.isActive = contestConfig.isActive !== false;
                
                if (!contestConfig.endTime) {
                    const endTime = new Date();
                    endTime.setDate(endTime.getDate() + contestData.durationDays);
                    contestData.endTime = endTime.getTime();
                    await contestRef.child('endTime').set(contestData.endTime);
                } else {
                    contestData.endTime = contestConfig.endTime;
                }
                
                const userContestRef = db.ref(`contest/participants/${tgUser.id}`);
                const userContestSnap = await userContestRef.once('value');
                const userContestData = userContestSnap.val() || { points: 0, adsWatched: 0, referrals: 0 };
                
                contestData.userPoints = userContestData.points || 0;
                
                const leaderboardRef = db.ref('contest/participants').orderByChild('points').limitToLast(50);
                const leaderboardSnap = await leaderboardRef.once('value');
                
                contestData.leaderboard = [];
                leaderboardSnap.forEach(child => {
                    const participant = child.val();
                    contestData.leaderboard.unshift(participant);
                });
                
                contestData.userRank = 0;
                contestData.leaderboard.forEach((participant, index) => {
                    if (participant.userId === tgUser.id) {
                        contestData.userRank = index + 1;
                    }
                });
                
            } catch (error) {
                console.error('Error loading contest data:', error);
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ - ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§
        const loadDailyLoginData = async (db) => {
            try {
                const dailyLoginRef = db.ref(`dailyLogin/${tgUser.id}`);
                const dailyLoginSnap = await dailyLoginRef.once('value');
                const savedData = dailyLoginSnap.val();
                
                if (savedData) {
                    dailyLoginData = savedData;
                }
                
                await checkDailyLogin(db);
                
            } catch (error) {
                console.error('Error loading daily login data:', error);
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ - ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§
        const checkDailyLogin = async (db) => {
            const today = new Date().toDateString();
            const lastLogin = dailyLoginData.lastLoginDate;
            
            if (lastLogin !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();
                
                if (lastLogin === yesterdayStr) {
                    dailyLoginData.currentStreak = (dailyLoginData.currentStreak || 0) + 1;
                } else if (lastLogin !== today) {
                    dailyLoginData.currentStreak = 1;
                }
                
                dailyLoginData.lastLoginDate = today;
                
                const dailyLoginRef = db.ref(`dailyLogin/${tgUser.id}`);
                await dailyLoginRef.set(dailyLoginData);
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ - ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„ØªØ¹Ù…Ù„ Ø¨Ù€ RR
        const loadReferralData = async (db) => {
            try {
                const referralRef = db.ref(`referrals/${tgUser.id}`);
                const referralSnap = await referralRef.once('value');
                const savedData = referralSnap.val();
                
                if (savedData) {
                    referralData = savedData;
                }
                
                const referredUsersRef = db.ref('users').orderByChild('referredBy').equalTo(tgUser.id);
                const referredUsersSnap = await referredUsersRef.once('value');
                
                referralData.referredUsers = [];
                referredUsersSnap.forEach(child => {
                    const user = child.val();
                    referralData.referredUsers.push({
                        id: user.id,
                        name: `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'User',
                        username: user.username || '',
                        photoUrl: user.photoUrl || 'https://ui-avatars.com/api/?name=User&background=random&size=35',
                        joinDate: user.joinDate,
                        totalEarned: user.totalEarned || 0
                    });
                });
                
            } catch (error) {
                console.error('Error loading referral data:', error);
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
        const loadRedeemedCodes = async (db) => {
            try {
                const redeemedCodesRef = db.ref(`redeemedCodes/${tgUser.id}`);
                const redeemedCodesSnap = await redeemedCodesRef.once('value');
                const savedCodes = redeemedCodesSnap.val();
                
                if (savedCodes) {
                    redeemedCodes = savedCodes;
                }
                
            } catch (error) {
                console.error('Error loading redeemed codes:', error);
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
        const loadAdChannels = async (db) => {
            try {
                const adChannelsRef = db.ref('adChannels');
                const adChannelsSnap = await adChannelsRef.once('value');
                const savedChannels = adChannelsSnap.val();
                
                if (savedChannels) {
                    adChannels = Object.values(savedChannels).filter(channel => channel.active !== false);
                }
                
            } catch (error) {
                console.error('Error loading ad channels:', error);
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
        const loadManualTasks = async (db) => {
            try {
                const manualTasksRef = db.ref('manualTasks');
                const manualTasksSnap = await manualTasksRef.once('value');
                const savedTasks = manualTasksSnap.val();
                
                if (savedTasks) {
                    // ØªØµÙÙŠØ© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù†Ø´Ø·Ø© ÙÙ‚Ø·
                    manualTasks = Object.values(savedTasks).filter(task => task.active !== false);
                }
                
                // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                const userManualTasksRef = db.ref(`userManualTasks/${tgUser.id}`);
                const userManualTasksSnap = await userManualTasksRef.once('value');
                const userTasksData = userManualTasksSnap.val();
                
                if (userTasksData) {
                    userManualTasks = userTasksData;
                }
                
            } catch (error) {
                console.error('Error loading manual tasks:', error);
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù†ÙˆØ§Øª
        const checkAllSubscriptions = async () => {
            console.log('ðŸ” Checking REAL channel subscriptions...');
            
            const subscriptionResults = [];
            let allSuccessful = true;
            
            for (const channel of requiredChannels) {
                try {
                    const isSubscribed = await checkRealSubscription(channel.username);
                    subscriptionResults.push({
                        ...channel,
                        subscribed: isSubscribed
                    });
                    
                    if (!isSubscribed) {
                        allSuccessful = false;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (channelError) {
                    console.error(`âŒ Error checking channel ${channel.username}:`, channelError);
                    subscriptionResults.push({
                        ...channel,
                        subscribed: false,
                        error: true
                    });
                    allSuccessful = false;
                }
            }
            
            const allSubscribed = subscriptionResults.every(channel => channel.subscribed);
            isSubscribedToAllChannels = allSubscribed;
            
            console.log('ðŸ“Š REAL Subscription results:', subscriptionResults);
            console.log('âœ… All channels subscribed:', allSubscribed);
            
            return { 
                subscriptionResults, 
                allSubscribed,
                allSuccessful 
            };
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        const updateSubscriptionUI = (subscriptionResults) => {
            const channelsList = document.getElementById('channels-list');
            channelsList.innerHTML = '';
            
            subscriptionResults.forEach(channel => {
                const channelElement = document.createElement('div');
                channelElement.className = 'channel-item';
                
                let statusText = 'âŒ Not Subscribed';
                let statusClass = 'status-not-subscribed';
                
                if (channel.subscribed) {
                    statusText = 'âœ… Subscribed';
                    statusClass = 'status-subscribed';
                } else if (channel.error) {
                    statusText = 'âš ï¸ Check Failed';
                    statusClass = 'status-not-subscribed';
                }
                
                channelElement.innerHTML = `
                    <div class="channel-info">
                        <img src="${channel.icon}" alt="${channel.name}" class="channel-icon">
                        <div style="text-align: left;">
                            <h4 style="margin: 0; font-size: 1rem;">${channel.name}</h4>
                            <small style="opacity: 0.7;">@${channel.username}</small>
                        </div>
                    </div>
                    <span class="channel-status ${statusClass}">
                        ${statusText}
                    </span>
                    <button class="action-btn join-channel-btn" data-channel-url="${channel.url}" style="padding: 8px 12px; font-size: 0.8rem;">
                        Join
                    </button>
                `;
                channelsList.appendChild(channelElement);
            });

            // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ø£Ø²Ø±Ø§Ø± Join
            document.querySelectorAll('.join-channel-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const channelUrl = this.getAttribute('data-channel-url');
                    try {
                        if (tg.openLink) {
                            tg.openLink(channelUrl);
                        } else {
                            window.open(channelUrl, '_blank');
                        }
                    } catch (error) {
                        window.open(channelUrl, '_blank');
                    }
                });
            });
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
        const renderAdChannels = async () => {
            const adChannelsList = document.getElementById('ad-channels-list');
            const adChannelsSection = document.getElementById('ad-channels-section');
            
            if (!adChannels || adChannels.length === 0) {
                adChannelsSection.style.display = 'none';
                return;
            }
            
            adChannelsSection.style.display = 'block';
            adChannelsList.innerHTML = '';
            
            for (const channel of adChannels) {
                const isSubscribed = await checkAdChannelSubscription(channel.username);
                
                const channelElement = document.createElement('div');
                channelElement.className = 'ad-channel-item';
                
                channelElement.innerHTML = `
                    <div class="ad-channel-info">
                        <img src="${channel.icon}" alt="${channel.name}" class="ad-channel-icon">
                        <div class="ad-channel-details">
                            <div class="ad-channel-name">${channel.name}</div>
                            <div class="ad-channel-description">${channel.description || 'Subscribe for rewards'}</div>
                            <div class="ad-channel-contact">Contact: @${channel.contact || 'aborabie777'}</div>
                        </div>
                    </div>
                    <div class="ad-channel-reward">
                        <div class="ad-reward-amount">+${channel.reward || 0} Points</div>
                        <div class="ad-reward-label">Contest Points</div>
                    </div>
                    <button class="action-btn subscribe-ad-btn" data-channel-url="${channel.url}" ${isSubscribed ? 'disabled' : ''} style="padding: 8px 12px; font-size: 0.8rem;">
                        ${isSubscribed ? 'âœ… Subscribed' : 'Subscribe'}
                    </button>
                `;
                adChannelsList.appendChild(channelElement);
            }

            // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ø£Ø²Ø±Ø§Ø± Subscribe
            document.querySelectorAll('.subscribe-ad-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!this.disabled) {
                        const channelUrl = this.getAttribute('data-channel-url');
                        try {
                            if (tg.openLink) {
                                tg.openLink(channelUrl);
                            } else {
                                window.open(channelUrl, '_blank');
                            }
                        } catch (error) {
                            window.open(channelUrl, '_blank');
                        }
                    }
                });
            });
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
        const checkAdChannelSubscription = async (channelUsername) => {
            try {
                if (!tgUser || !tgUser.id) {
                    console.log('âŒ No Telegram user data available');
                    return false;
                }

                const botToken = appConfig.botToken;
                
                if (!botToken) {
                    console.error('âŒ Bot token not configured in Firebase');
                    return false;
                }

                console.log(`ðŸ” Checking AD channel subscription for ${channelUsername}, user: ${tgUser.id}`);

                try {
                    const response = await fetch(`https://api.telegram.org/bot${botToken}/getChatMember`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: '@' + channelUsername,
                            user_id: tgUser.id
                        })
                    });

                    if (!response.ok) {
                        console.error(`âŒ HTTP error! status: ${response.status} for ${channelUsername}`);
                        return false;
                    }

                    const data = await response.json();
                    console.log(`ðŸ“Š Bot API response for AD channel ${channelUsername}:`, data);
                    
                    if (data.ok) {
                        const status = data.result.status;
                        const isSubscribed = ['member', 'administrator', 'creator'].includes(status);
                        console.log(`ðŸ“¢ AD channel subscription status for ${channelUsername}: ${status} -> ${isSubscribed}`);
                        return isSubscribed;
                    } else {
                        console.error(`âŒ Bot API error for AD channel ${channelUsername}:`, data.description);
                        return false;
                    }
                } catch (fetchError) {
                    console.error(`âŒ Fetch error for AD channel ${channelUsername}:`, fetchError);
                    return false;
                }
                
            } catch (error) {
                console.error('Error checking AD channel subscription:', error);
                return false;
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ®Ø·ÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (Ù„Ù„ØªØ·ÙˆÙŠØ± ÙÙ‚Ø·)
        const skipSubscription = () => {
            console.log('ðŸš¨ Skipping subscription check for development');
            isSubscribedToAllChannels = true;
            document.getElementById('subscription-page').classList.remove('active');
            document.getElementById('app-loader').style.display = 'none';
            document.querySelector('.ship-container').style.display = 'block';
            
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            
            loadBasicUserData(db).then(() => {
                renderUI();
                setupNavigation();
                setupEventListeners();
            });
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¨Ø¯ÙˆÙ† Ø§Ø´ØªØ±Ø§Ùƒ
        const loadBasicUserData = async (db) => {
            const localUserId = (tgUser && tgUser.id) ? tgUser.id : ('guest_' + (Date.now()));

            const userRef = db.ref(`users/${localUserId}`);
            const snapshot = await userRef.once('value');
            let userData = snapshot.val();

            if (!userData) {
                userData = {
                    id: localUserId,
                    firstName: (tgUser && tgUser.first_name) || '',
                    lastName: (tgUser && tgUser.last_name) || '',
                    username: (tgUser && tgUser.username) || '',
                    photoUrl: (tgUser && tgUser.photo_url) || '',
                    balance: 0, 
                    referrals: 0, 
                    totalEarned: 0,
                    lifetimeAdCount: 0, 
                    lastAdWatchDate: '1970-01-01', 
                    dailyAdCount: 0, 
                    breakUntil: 0, 
                    completedTasks: {}, 
                    welcomed: false,
                    joinDate: new Date().toISOString(),
                    subscribedToChannels: false
                };
                await userRef.set(userData);
            }

            const today = new Date().toISOString().slice(0, 10);
            if (userData.lastAdWatchDate !== today) {
                userData.dailyAdCount = 0; 
                userData.lastAdWatchDate = today;
                await userRef.update({ dailyAdCount: 0, lastAdWatchDate: today });
            }
            userState = userData;
        };

        const loadAdSdk = (zoneId) => {
            if (!zoneId) { 
                console.error("Ad Zone ID is missing from Firebase config!"); 
                return; 
            }
            
            // Ù…Ù†Ø¹ ØªØ­Ù…ÙŠÙ„ SDK Ù…ÙƒØ±Ø±
            if (document.querySelector(`script[data-zone='${zoneId}']`)) return;
            
            const script = document.createElement('script');
            script.src = `//libtl.com/sdk.js`;
            script.setAttribute('data-zone', zoneId);
            script.setAttribute('data-sdk', `show_${zoneId}`);
            script.async = true;
            document.body.appendChild(script);
            
            console.log(`âœ… Loaded ad SDK for zone: ${zoneId}`);
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¹Ù†Ø¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¥Ø¹Ù„Ø§Ù† - Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
        const updateContestPointsOnAdWatch = async () => {
            try {
                // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù†Ø´Ø·Ø© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø·
                if (!contestData.isActive) {
                    console.log('â„¹ï¸ Contest is not active, skipping points update');
                    return;
                }

                const db = firebase.database();
                const userContestRef = db.ref(`contest/participants/${tgUser.id}`);
                
                const userContestSnap = await userContestRef.once('value');
                const currentData = userContestSnap.val() || { 
                    points: 0, 
                    adsWatched: 0, 
                    referrals: 0,
                    userName: `${userState.firstName || ''} ${userState.lastName || ''}`.trim(),
                    username: tgUser.username || '',
                    userId: tgUser.id
                };
                
                const newPoints = (currentData.points || 0) + 1;
                const newAdsWatched = (currentData.adsWatched || 0) + 1;
                
                await userContestRef.update({
                    points: newPoints,
                    adsWatched: newAdsWatched,
                    userName: `${userState.firstName || ''} ${userState.lastName || ''}`.trim(),
                    username: tgUser.username || '',
                    userId: tgUser.id,
                    lastActivity: firebase.database.ServerValue.TIMESTAMP
                });
                
                contestData.userPoints = newPoints;
                
            } catch (error) {
                console.error('Error updating contest points:', error);
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© - Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
        const updateContestPointsOnReferral = async (referrerId) => {
            try {
                // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù†Ø´Ø·Ø© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø·
                if (!contestData.isActive) {
                    console.log('â„¹ï¸ Contest is not active, skipping referral points update');
                    return;
                }

                const db = firebase.database();
                const userContestRef = db.ref(`contest/participants/${referrerId}`);
                
                const userContestSnap = await userContestRef.once('value');
                const currentData = userContestSnap.val() || { 
                    points: 0, 
                    adsWatched: 0, 
                    referrals: 0,
                    userName: '',
                    username: '',
                    userId: referrerId
                };
                
                const newPoints = (currentData.points || 0) + 15;
                const newReferrals = (currentData.referrals || 0) + 1;
                
                await userContestRef.update({
                    points: newPoints,
                    referrals: newReferrals,
                    userName: currentData.userName || '',
                    username: currentData.username || '',
                    userId: referrerId,
                    lastActivity: firebase.database.ServerValue.TIMESTAMP
                });
                
                console.log(`ðŸŽ¯ Contest points updated for referrer ${referrerId}: +15 points`);
                
            } catch (error) {
                console.error('Error updating contest referral points:', error);
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª - ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„ØªØ¹Ù…Ù„ Ø¨Ù€ RR
        const updateReferralEarnings = async (referredUserId, earningsRR) => {
            try {
                const db = firebase.database();
                const referrerId = userState.referredBy;
                
                if (!referrerId) return;
                
                const referralRef = db.ref(`referrals/${referrerId}`);
                const referralSnap = await referralRef.once('value');
                const currentData = referralSnap.val() || { totalEarnings: 0, pendingEarnings: 0, referredUsers: [] };
                
                // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù† 10% Ø¥Ù„Ù‰ 15%
                const referralBonusRR = earningsRR * 0.15; // 15% Ù…Ù† Ø£Ø±Ø¨Ø§Ø­ RR
                
                currentData.pendingEarnings = (currentData.pendingEarnings || 0) + referralBonusRR;
                
                await referralRef.set(currentData);
                
                console.log(`ðŸŽ¯ Referral earnings updated for ${referrerId}: +${referralBonusRR.toLocaleString()} RR from ${referredUserId}`);
                
            } catch (error) {
                console.error('Error updating referral earnings:', error);
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª
        const processReferral = async (referrerId, newUserId, db) => {
            try {
                const referrerRef = db.ref(`users/${referrerId}`);
                const refSnap = await referrerRef.once('value');
                
                if (refSnap.exists()) {
                    const referrerData = refSnap.val();
                    
                    // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ© 10,000 RR
                    // Ù†Ø­ØªÙØ¸ ÙÙ‚Ø· Ø¨Ù†Ø³Ø¨Ø© 15% Ù…Ù† Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø§Ù„
                    
                    await referrerRef.update({
                        referrals: firebase.database.ServerValue.increment(1)
                    });
                    
                    console.log(`ðŸŽ‰ Referral credited: ${referrerId} referred ${newUserId}`);
                        
                    await updateContestPointsOnReferral(referrerId);
                } else {
                    console.warn("âŒ Referrer not found:", referrerId);
                }
            } catch (error) {
                console.error("Error processing referral:", error);
            }
        };

        const loadTransactionHistory = async (db) => {
            userTransactions = [];
            const statuses = ['pending', 'completed', 'rejected'];
            const historyPromises = statuses.map(status => 
                db.ref(`withdrawals/${status}`).orderByChild('userId').equalTo(tgUser.id).once('value')
            );
            const snapshots = await Promise.all(historyPromises);
            snapshots.forEach(snap => { 
                snap.forEach(childSnap => { 
                    userTransactions.push(childSnap.val()); 
                }); 
            });
            userTransactions.sort((a, b) => b.timestamp - a.timestamp);
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù€ renderUI
        const renderUI = () => {
            document.getElementById('user-photo').src = userState.photoUrl || 'https://ui-avatars.com/api/?name=User&background=random&size=80';
            document.getElementById('user-name').textContent = `${userState.firstName || ''} ${userState.lastName || ''}`.trim() || 'User';
            document.getElementById('user-balance').textContent = (userState.balance || 0).toFixed(4);
            document.getElementById('user-rr-balance').textContent = userRRBalance.toLocaleString();
            document.getElementById('daily-ads-watched').textContent = `${userState.dailyAdCount || 0} / ${appConfig.dailyAdLimit || 0}`;
            document.getElementById('total-ads-watched').textContent = userState.lifetimeAdCount || 0;
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
            updateContestStatus();
            
            // ðŸŒ Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙˆÙ„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø­Ø¸ÙˆØ±Ø©
            if (!isUserCountryAllowed && userCountryData) {
                showCountryRestrictionMessage();
            }
            
            renderAdTask(); 
            renderAdProgress(); 
            renderDynamicTasks(); 
            renderManualTasks();
            renderReferralsPage();
            renderWithdrawSection(); 
            renderConverter(); 
            renderDynamicLinks();
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠÙŠÙ†
            setupAdditionalEventListeners();
        };

        const renderAdProgress = () => {
            const container = document.getElementById('ad-progress-container');
            const dailyLimit = appConfig.dailyAdLimit || 1;
            const watchedCount = userState.dailyAdCount || 0;
            const percentage = Math.min(100, (watchedCount / dailyLimit) * 100);
            container.innerHTML = `
                <div class="progress-info-inline">
                    <span>Daily Ad Progress</span>
                    <span>${watchedCount} / ${dailyLimit}</span>
                </div>
                <div class="progress-bar-bg-inline">
                    <div class="progress-bar-fg-inline" style="width: ${percentage}%;"></div>
                </div>`;
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù…Ø­ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„Ø©
        const renderConverter = () => {
            const rrInput = document.getElementById('rr-amount');
            const tonInput = document.getElementById('ton-amount');
            const convertBtn = document.getElementById('convert-rr-btn');
            
            if (rrInput && tonInput && convertBtn) {
                rrInput.value = '';
                tonInput.value = '';
                convertBtn.disabled = true;
                
                rrInput.addEventListener('input', () => {
                    const rrValue = parseFloat(rrInput.value) || 0;
                    const tonValue = rrValue / RR_TO_TON_RATE;
                    tonInput.value = tonValue.toFixed(4);
                    convertBtn.disabled = rrValue <= 0 || rrValue > userRRBalance;
                });
                
                convertBtn.addEventListener('click', convertRRToTON);
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ RR Ø¥Ù„Ù‰ TON
        const convertRRToTON = async () => {
            const rrAmount = parseFloat(document.getElementById('rr-amount').value) || 0;
            
            if (rrAmount <= 0) {
                try{ 
                    if (tg.showAlert) tg.showAlert("Please enter a valid amount of RR to convert."); 
                }catch{} 
                return;
            }
            
            if (rrAmount > userRRBalance) {
                try{ 
                    if (tg.showAlert) tg.showAlert("You don't have enough RR to convert."); 
                }catch{} 
                return;
            }
            
            const tonAmount = rrAmount / RR_TO_TON_RATE;
            
            try {
                const db = firebase.database();
                const userRef = db.ref(`users/${tgUser.id}`);
                
                userRRBalance -= rrAmount;
                localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
                
                await userRef.child('balance').set(firebase.database.ServerValue.increment(tonAmount));
                userState.balance = (userState.balance || 0) + tonAmount;
                
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert(`Successfully converted ${rrAmount.toLocaleString()} RR to ${tonAmount.toFixed(4)} TON!`); 
                }catch{}
                
                renderUI();
                
            } catch (error) {
                console.error('Error converting RR to TON:', error);
                try{ 
                    if (tg.showAlert) tg.showAlert("Failed to convert RR. Please try again."); 
                }catch{} 
            }
        };

        const renderWithdrawalHistory = () => {
            const listEl = document.getElementById('withdrawal-history-list');
            if (userTransactions.length === 0) { 
                listEl.innerHTML = '<p>No withdrawal history found.</p>'; 
                return; 
            }
            listEl.innerHTML = userTransactions.map(item => `
                <div class="history-item">
                    <div class="history-details">
                        <p>${Number(item.amount).toFixed(4)} TON - ${item.method}</p>
                        <small>${new Date(item.timestamp).toLocaleString()}</small>
                    </div>
                    <span class="history-status status-${item.status}">${item.status}</span>
                </div>`).join('');
        };

        const setupNavigation = () => {
            const controlWheels = document.querySelectorAll('.control-wheel'); 
            const pages = document.querySelectorAll('.page');
            controlWheels.forEach(wheel => {
                wheel.addEventListener('click', () => {
                    const pageId = wheel.dataset.page;
                    pages.forEach(page => page.classList.remove('active'));
                    document.getElementById(pageId).classList.add('active');
                    controlWheels.forEach(w => w.classList.remove('active'));
                    wheel.classList.add('active');
                    if (pageId === 'profile-page') { 
                        renderWithdrawalHistory(); 
                    }
                    if (pageId === 'contest-page') { 
                        renderContestPage(); 
                    }
                    if (pageId === 'referrals-page') {
                        renderReferralsPage();
                    }
                });
            });
        };

        const setupEventListeners = () => {
            popup.addEventListener('click', (e) => { 
                if (e.target.classList.contains('popup-close-btn') || e.target.id === 'popup') closePopup(); 
            });
            document.getElementById('dynamic-tasks-container').addEventListener('click', (e) => handleClaimTask(e));
            document.getElementById('profile-page').addEventListener('submit', (e) => handleWithdraw(e));
            document.getElementById('redeem-code-btn').addEventListener('click', redeemCode);
            document.getElementById('redeem-code-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    redeemCode();
                }
            });
        };

        // âœ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
        const setupAdditionalEventListeners = () => {
            // Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© - ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            document.getElementById('add-task-main-btn').addEventListener('click', openTelegramContact);
            
            // Ø²Ø± Ø´Ø±Ø­ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© - ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡
            document.getElementById('contest-guide-trigger').addEventListener('click', function() {
                const content = document.getElementById('contest-guide-content');
                content.style.display = content.style.display === 'block' ? 'none' : 'block';
            });
        };

        const renderAdTask = () => {
            const container = document.getElementById('ad-task-container');
            const now = Date.now();
            const onBreak = userState.breakUntil && now < userState.breakUntil;
            const limitReached = userState.dailyAdCount >= appConfig.dailyAdLimit;
            
            // ðŸŒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙˆÙ„Ø© Ø£ÙˆÙ„Ø§Ù‹
            if (!isUserCountryAllowed) {
                const countryName = userCountryData.countryName || 'your region';
                container.innerHTML = `
                    <div class="task-container">
                        <img class="task-icon-img" src="https://img.icons8.com/ios-filled/100/globe.png" alt="icon">
                        <div class="task-info">
                            <h3>Regional Restriction</h3>
                            <p>Ads are not available in ${countryName}.</p>
                            <p style="color: var(--text-secondary-dark); font-size: 0.8rem;">
                                Thank you for your understanding.
                            </p>
                        </div>
                        <button class="action-btn" disabled>Not Available</button>
                    </div>`;
                return;
            }
            
            let html = '';
            if (onBreak) {
                const remaining = Math.ceil((userState.breakUntil - now) / 60000);
                html = `
                    <div class="task-container">
                        <img class="task-icon-img" src="https://img.icons8.com/ios-filled/100/hourglass.png" alt="icon">
                        <div class="task-info">
                            <h3>Break Time!</h3>
                            <p>Please wait for ${remaining} more minutes.</p>
                        </div>
                        <button class="action-btn" disabled>Waiting</button>
                    </div>`;
            } else if (limitReached) {
                html = `
                    <div class="task-container">
                        <img class="task-icon-img" src="https://img.icons8.com/ios-filled/100/stop-circled.png" alt="icon">
                        <div class="task-info">
                            <h3>Daily Limit Reached</h3>
                            <p>Come back tomorrow for more ads.</p>
                        </div>
                        <button class="action-btn" disabled>Limit</button>
                    </div>`;
            } else {
                const adValueRR = 1000;
                html = `
                    <div class="task-container">
                        <img class="task-icon-img" src="https://img.icons8.com/ios-filled/100/play-button-circled.png" alt="icon">
                        <div class="task-info">
                            <h3>Watch Ad</h3>
                            <p>Earn ${adValueRR.toLocaleString()} RR for every ad.</p>
                            <p class="ad-progress-inline">
                                â±ï¸ Must watch for 5+ seconds to earn
                            </p>
                        </div>
                        <button id="watch-ad-btn" class="action-btn">Watch Ad</button>
                    </div>`;
            }
            container.innerHTML = html;
            if (!onBreak && !limitReached) { 
                const btn = document.getElementById('watch-ad-btn'); 
                if (btn) btn.addEventListener('click', handleWatchAd); 
            }
        };

        const copyReferralLink = () => {
            const refLinkInput = document.getElementById('referral-link');
            refLinkInput.select();
            refLinkInput.setSelectionRange(0, 99999);
            try {
                navigator.clipboard.writeText(refLinkInput.value).then(() => {
                    try{ 
                        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                        if (tg.showAlert) tg.showAlert("Referral link copied!"); 
                    }catch{}
                });
            } catch (err) {
                document.execCommand('copy');
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert("Referral link copied!"); 
                }catch{}
            }
        };

        const renderDynamicTasks = () => {
            const container = document.getElementById('dynamic-tasks-container'); 
            container.innerHTML = '';
            if (appConfig.tasks) {
                const tasks = [];
                for(const key in appConfig.tasks) { 
                    tasks.push({key, ...appConfig.tasks[key]}); 
                }
                tasks.reverse();
                tasks.forEach(task => {
                    const isCompleted = userState.completedTasks && userState.completedTasks[task.key];
                    const rewardAmountRR = Math.round(task.reward * RR_TO_TON_RATE);
                    const el = document.createElement('div'); 
                    el.className = 'task-container';
                    el.innerHTML = `
                        <img class="task-icon-img" src="${task.icon}" alt="icon">
                        <div class="task-info">
                            <h3>${task.name}</h3>
                            <p>Get ${rewardAmountRR.toLocaleString()} RR.</p>
                        </div>
                        <button class="action-btn" data-task-id="${task.key}" data-task-url="${task.url}" ${isCompleted ? 'disabled' : ''}>
                            ${isCompleted ? 'Claimed' : 'Claim Bonus'}
                        </button>`;
                    container.appendChild(el);
                });
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ø§Ù„Ù…ØµØºØ±Ø©
        const renderManualTasks = () => {
            const container = document.getElementById('manual-tasks-container');
            container.innerHTML = '';
            
            if (manualTasks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary-dark); padding: 20px;">No manual tasks available at the moment.</p>';
                return;
            }
            
            manualTasks.forEach(task => {
                const userTask = userManualTasks && userManualTasks[task.id];
                const isCompleted = userTask && userTask.status === 'approved';
                const isPending = userTask && userTask.status === 'pending';
                const isRejected = userTask && userTask.status === 'rejected';
                
                let statusText = '';
                let statusClass = '';
                
                if (isCompleted) {
                    statusText = 'âœ… Approved';
                    statusClass = 'status-approved';
                } else if (isPending) {
                    statusText = 'â³ Pending Review';
                    statusClass = 'status-pending';
                } else if (isRejected) {
                    statusText = 'âŒ Rejected';
                    statusClass = 'status-rejected';
                }
                
                const taskElement = document.createElement('div');
                taskElement.className = 'manual-task-compact';
                taskElement.innerHTML = `
                    <div class="task-header-compact">
                        <img class="task-icon-compact" src="${task.icon}" alt="icon">
                        <div class="task-details-compact">
                            <div class="task-title-compact">${task.name}</div>
                            <div class="task-description-compact">${task.description}</div>
                            <div class="task-reward-compact">
                                Reward: ${task.rewardType === 'TON' ? task.rewardValue + ' TON' : 
                                        task.rewardType === 'RR' ? task.rewardValue.toLocaleString() + ' RR' : 
                                        task.rewardValue + ' Points'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="task-actions-compact">
                        <button class="open-task-btn" onclick="openManualTask('${task.id}', '${task.botUrl || task.url}')">
                            <i class="fas fa-external-link-alt"></i> Open Task
                        </button>
                        <button class="upload-screenshot-btn" onclick="openScreenshotUpload('${task.id}')">
                            <i class="fas fa-camera"></i> Upload Proof
                        </button>
                    </div>
                    
                    ${statusText ? `<div class="task-status-compact ${statusClass}">${statusText}</div>` : ''}
                    
                    <!-- Ù…Ù†Ø·Ù‚Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± (Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹) -->
                    <div id="screenshot-section-${task.id}" style="display: none; margin-top: 10px;">
                        <div class="screenshot-upload-area" id="upload-area-${task.id}">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 1.5rem; color: var(--ship-gold); margin-bottom: 8px;"></i>
                            <p style="font-size: 0.8rem;">Click to upload screenshot proof</p>
                            <p style="font-size: 0.7rem; color: var(--text-secondary-dark);">
                                Upload a clear screenshot showing you completed the task
                            </p>
                            <input type="file" id="screenshot-input-${task.id}" accept="image/*" style="display: none;">
                            <img class="screenshot-preview" id="preview-${task.id}">
                        </div>
                        
                        <div style="display: ${userTask && userTask.screenshot ? 'block' : 'none'};" id="submission-section-${task.id}">
                            <p style="color: var(--success); margin-bottom: 8px; font-size: 0.8rem;">
                                <i class="fas fa-check-circle"></i> Screenshot uploaded successfully!
                            </p>
                            <button class="change-screenshot-btn" onclick="changeScreenshot('${task.id}')">
                                Change Screenshot
                            </button>
                            <button class="upload-btn" onclick="submitManualTask('${task.id}')">
                                Submit for Review
                            </button>
                        </div>
                    </div>
                    
                    ${isPending ? `
                    <div style="background: rgba(255, 165, 0, 0.1); padding: 8px; border-radius: 8px; margin-top: 8px;">
                        <p style="margin: 0; color: var(--pending); font-size: 0.8rem;">
                            <i class="fas fa-clock"></i> Your submission is under review. Please wait for admin approval.
                        </p>
                    </div>
                    ` : ''}
                    
                    ${isRejected ? `
                    <div style="background: rgba(244, 67, 54, 0.1); padding: 8px; border-radius: 8px; margin-top: 8px;">
                        <p style="margin: 0; color: var(--danger); font-size: 0.8rem;">
                            <i class="fas fa-exclamation-triangle"></i> Your submission was rejected. 
                            ${userTask.rejectionReason ? `Reason: ${userTask.rejectionReason}` : 'Please try again with a clearer screenshot.'}
                        </p>
                        <button class="change-screenshot-btn" onclick="openScreenshotUpload('${task.id}')" style="margin-top: 6px;">
                            Upload New Screenshot
                        </button>
                    </div>
                    ` : ''}
                `;
                
                container.appendChild(taskElement);
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø±ÙØ¹
                if (!isCompleted && !isPending) {
                    setupScreenshotUpload(task.id);
                }
            });
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„ÙØªØ­ Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙŠ Ø¨ÙˆØª Ø¢Ø®Ø±
        window.openManualTask = (taskId, botUrl) => {
            try {
                if (tg.openLink) {
                    tg.openLink(botUrl);
                } else {
                    window.open(botUrl, '_blank');
                }
                console.log(`ðŸ“± Opening manual task ${taskId} in bot: ${botUrl}`);
            } catch (error) {
                window.open(botUrl, '_blank');
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
        window.openScreenshotUpload = (taskId) => {
            const screenshotSection = document.getElementById(`screenshot-section-${taskId}`);
            if (screenshotSection) {
                screenshotSection.style.display = screenshotSection.style.display === 'block' ? 'none' : 'block';
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
        const setupScreenshotUpload = (taskId) => {
            const uploadArea = document.getElementById(`upload-area-${taskId}`);
            const fileInput = document.getElementById(`screenshot-input-${taskId}`);
            const preview = document.getElementById(`preview-${taskId}`);
            const submissionSection = document.getElementById(`submission-section-${taskId}`);
            
            if (uploadArea && fileInput) {
                uploadArea.addEventListener('click', () => {
                    fileInput.click();
                });
                
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            preview.src = e.target.result;
                            preview.style.display = 'block';
                            submissionSection.style.display = 'block';
                            
                            // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
                            if (!userManualTasks[taskId]) {
                                userManualTasks[taskId] = {};
                            }
                            userManualTasks[taskId].screenshot = e.target.result;
                            userManualTasks[taskId].timestamp = Date.now();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©
        window.changeScreenshot = (taskId) => {
            const fileInput = document.getElementById(`screenshot-input-${taskId}`);
            if (fileInput) {
                fileInput.click();
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
        window.submitManualTask = async (taskId) => {
            try {
                const task = manualTasks.find(t => t.id === taskId);
                if (!task) {
                    try{ 
                        if (tg.showAlert) tg.showAlert("Task not found!"); 
                    }catch{} 
                    return;
                }
                
                const userTask = userManualTasks[taskId];
                if (!userTask || !userTask.screenshot) {
                    try{ 
                        if (tg.showAlert) tg.showAlert("Please upload a screenshot first!"); 
                    }catch{} 
                    return;
                }
                
                const db = firebase.database();
                
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø© Ø¥Ù„Ù‰ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                userManualTasks[taskId].status = 'pending';
                userManualTasks[taskId].submittedAt = Date.now();
                
                const userManualTasksRef = db.ref(`userManualTasks/${tgUser.id}`);
                await userManualTasksRef.set(userManualTasks);
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¥Ø¯Ù…Ù†
                await sendManualTaskNotification(task, userTask);
                
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert("Task submitted for review! We will notify you once it's approved."); 
                }catch{}
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                renderManualTasks();
                
            } catch (error) {
                console.error('Error submitting manual task:', error);
                try{ 
                    if (tg.showAlert) tg.showAlert("Failed to submit task. Please try again."); 
                }catch{} 
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
        const sendManualTaskNotification = async (task, userTask) => {
            try {
                const botToken = appConfig.botToken;
                
                if (!botToken) {
                    console.error('âŒ Bot token not configured in Firebase');
                    return;
                }

                const adminMessage = `
ðŸ“‹ NEW MANUAL TASK SUBMISSION

ðŸ‘¤ User Information:
â€¢ Name: ${userState.firstName || ''} ${userState.lastName || ''}
â€¢ Username: @${tgUser.username || 'N/A'}
â€¢ User ID: ${tgUser.id}

ðŸ“ Task Details:
â€¢ Task: ${task.name}
â€¢ Description: ${task.description}
â€¢ Reward: ${task.rewardValue} ${task.rewardType}
â€¢ Submitted: ${new Date().toLocaleString()}

ðŸ–¼ï¸ Screenshot uploaded and ready for review.

âœ… Please review the submission in Firebase:
/database/userManualTasks/${tgUser.id}/${task.id}
                `.trim();

                const adminChatId = appConfig.adminChatId || "6294480939";
                
                const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: adminChatId,
                        text: adminMessage
                    })
                });

                const result = await response.json();
                console.log('ðŸ“¨ Manual task notification sent:', result.ok);
                
            } catch (error) {
                console.error('Error sending manual task notification:', error);
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª - ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„ØªØ¹Ù…Ù„ Ø¨Ù€ RR
        const renderReferralsPage = () => {
            const botUsername = appConfig.botUsername || "Aborabie777_bot";
            const userId = tgUser.id || '';
            
            const refLink = `https://t.me/${botUsername}?startapp=${userId}`;
            
            document.getElementById('total-referrals-display').textContent = userState.referrals || 0;
            document.getElementById('total-earnings-display').textContent = (referralData.totalEarnings || 0).toLocaleString() + ' RR';
            document.getElementById('pending-earnings-display').textContent = (referralData.pendingEarnings || 0).toLocaleString() + ' RR';
            document.getElementById('referral-link').value = refLink;
            
            let referredUsersHTML = '';
            if (referralData.referredUsers.length > 0) {
                referralData.referredUsers.forEach(user => {
                    referredUsersHTML += `
                        <div class="referral-list-item">
                            <div class="referral-user-info">
                                <img src="${user.photoUrl}" alt="${user.name}" class="referral-user-avatar">
                                <div>
                                    <div class="referral-user-name">${user.name}</div>
                                    <small style="color: var(--text-secondary-dark);">Joined: ${new Date(user.joinDate).toLocaleDateString()}</small>
                                </div>
                            </div>
                            <div class="referral-earnings">+${((user.totalEarned || 0) * 0.15 * RR_TO_TON_RATE).toLocaleString()} RR</div>
                        </div>
                    `;
                });
            } else {
                referredUsersHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary-dark);">No referrals yet. Share your link to start earning!</div>';
            }
            
            document.getElementById('referrals-list-container').innerHTML = referredUsersHTML;
            
            const claimBtn = document.getElementById('claim-referral-earnings-btn');
            if (referralData.pendingEarnings > 0) {
                claimBtn.disabled = false;
                claimBtn.textContent = `ðŸŽ Claim ${referralData.pendingEarnings.toLocaleString()} RR`;
            } else {
                claimBtn.disabled = true;
                claimBtn.textContent = 'ðŸŽ Claim Referral Earnings';
            }
            
            // Ø¥Ø¶Ø§ÙØ© event listener Ù„Ø²Ø± Ø§Ù„Ù†Ø³Ø®
            document.getElementById('copy-ref-link-btn').addEventListener('click', copyReferralLink);
            document.getElementById('claim-referral-earnings-btn').addEventListener('click', claimReferralEarnings);
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª - ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„ØªØ¹Ù…Ù„ Ø¨Ù€ RR
        const claimReferralEarnings = async () => {
            try {
                const db = firebase.database();
                
                if (referralData.pendingEarnings <= 0) {
                    try{ 
                        if (tg.showAlert) tg.showAlert("No pending referral earnings to claim!"); 
                    }catch{} 
                    return;
                }
                
                // Ø¥Ø¶Ø§ÙØ© Ø£Ø±Ø¨Ø§Ø­ RR Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                userRRBalance += referralData.pendingEarnings;
                localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
                
                referralData.totalEarnings += referralData.pendingEarnings;
                referralData.pendingEarnings = 0;
                
                const referralRef = db.ref(`referrals/${tgUser.id}`);
                await referralRef.set(referralData);
                
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert(`ðŸŽ‰ Referral earnings claimed! +${referralData.totalEarnings.toLocaleString()} RR`); 
                }catch{}
                
                renderUI();
                
            } catch (error) {
                console.error('Error claiming referral earnings:', error);
                try{ 
                    if (tg.showAlert) tg.showAlert("Failed to claim referral earnings. Please try again."); 
                }catch{} 
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø¹Ø±Ø¶ Ù‚Ø³Ù… Ø§Ù„Ø³Ø­Ø¨ - ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§
        const renderWithdrawSection = () => {
            const container = document.getElementById('withdraw-section'); 
            
            const withdrawMethods = [
                { name: 'FaucetPay', min: 0.0001, icon: 'fas fa-envelope' },
                { name: 'TON', min: 0.05, icon: 'fas fa-wallet' }
            ];
            
            if (appConfig.withdrawMethods) { 
                appConfig.withdrawMethods.forEach(method => { 
                    withdrawMethods.push(method);
                }); 
            }

            const minRefs = appConfig.minimumWithdrawReferrals || 0;
            let referralNotice = '';
            if (minRefs > 0) {
                referralNotice = `
                    <div class="referral-notice">
                        <i class="fas fa-info-circle"></i> You need at least <b>${minRefs} referrals</b> to be eligible for withdrawal.
                        <br>You currently have <b>${userState.referrals || 0} referrals</b>.
                    </div>`;
            }

            container.innerHTML = `
                <div class="withdraw-container">
                    <div class="withdraw-header">
                        <i class="fas fa-wallet"></i>
                        <h3>Withdraw Funds</h3>
                    </div>
                    
                    ${referralNotice}
                    
                    <div class="withdrawal-options">
                        <div class="withdrawal-option active" data-method="faucetpay">
                            <i class="fas fa-envelope"></i>
                            <h4>FaucetPay</h4>
                        </div>
                        <div class="withdrawal-option" data-method="ton">
                            <i class="fas fa-wallet"></i>
                            <h4>TON Wallet</h4>
                        </div>
                    </div>
                    
                    <!-- ØªÙØ§ØµÙŠÙ„ Ø³Ø­Ø¨ FaucetPay -->
                    <div class="withdrawal-details active" id="faucetpay-details">
                        <div class="withdrawal-info">
                            <p><strong>FaucetPay Withdrawal</strong></p>
                            <p>Enter your Gmail address registered with FaucetPay</p>
                            <ul>
                                <li>Minimum withdrawal: 0.0001 TON</li>
                                <li>âœ… No fees - We cover all transaction costs</li>
                                <li>â³ Processing time: Up to 12 hours</li>
                                <li>Withdrawals are processed manually</li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="faucetpay-email">FaucetPay Email</label>
                            <div class="input-with-icon">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="faucetpay-email" placeholder="your-email@gmail.com">
                            </div>
                            <div class="validation-message validation-info" id="faucetpay-validation">
                                <i class="fas fa-info-circle"></i> Enter your FaucetPay registered email
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="withdraw-amount-faucetpay">Amount (TON)</label>
                            <div class="input-with-icon">
                                <i class="fas fa-coins"></i>
                                <input type="number" id="withdraw-amount-faucetpay" placeholder="0.0001" min="0.0001" step="0.0001">
                            </div>
                            <div class="validation-message validation-info" id="amount-validation-faucetpay">
                                <i class="fas fa-info-circle"></i> Minimum: 0.0001 TON
                            </div>
                        </div>
                        <button class="withdraw-btn" id="withdraw-faucetpay-btn">Withdraw via FaucetPay</button>
                    </div>

                    <!-- ØªÙØ§ØµÙŠÙ„ Ø³Ø­Ø¨ TON -->
                    <div class="withdrawal-details" id="ton-details">
                        <div class="withdrawal-info">
                            <p><strong>TON Withdrawal</strong></p>
                            <p>Enter your TON wallet address (starts with UQ, EQ, or kQ)</p>
                            <ul>
                                <li>Minimum withdrawal: 0.05 TON</li>
                                <li>âœ… No fees - We cover all transaction costs</li>
                                <li>â³ Processing time: Up to 24 hours</li>
                                <li>Optional: Add memo for exchange deposits</li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="ton-address">TON Wallet Address</label>
                            <div class="input-with-icon">
                                <i class="fas fa-wallet"></i>
                                <input type="text" id="ton-address" placeholder="UQ...">
                            </div>
                            <div class="validation-message validation-info" id="ton-address-validation">
                                <i class="fas fa-info-circle"></i> Enter your TON wallet address
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="ton-memo">Memo (Optional)</label>
                            <div class="input-with-icon">
                                <i class="fas fa-sticky-note"></i>
                                <input type="text" id="ton-memo" placeholder="For exchange deposits">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="withdraw-amount-ton">Amount (TON)</label>
                            <div class="input-with-icon">
                                <i class="fas fa-coins"></i>
                                <input type="number" id="withdraw-amount-ton" placeholder="0.05" min="0.05" step="0.01">
                            </div>
                            <div class="validation-message validation-info" id="amount-validation-ton">
                                <i class="fas fa-info-circle"></i> Minimum: 0.05 TON
                            </div>
                        </div>
                        <button class="withdraw-btn" id="withdraw-ton-btn">Withdraw to TON Wallet</button>
                    </div>
                </div>`;

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            setupWithdrawalEventListeners();
        };

        // âœ… Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø³Ø­Ø¨
        const setupWithdrawalEventListeners = () => {
            // ØªØ¨Ø¯ÙŠÙ„ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø­Ø¨
            document.querySelectorAll('.withdrawal-option').forEach(option => {
                option.addEventListener('click', function() {
                    const method = this.getAttribute('data-method');
                    switchWithdrawalMethod(method);
                    
                    document.querySelectorAll('.withdrawal-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            document.getElementById('ton-address').addEventListener('input', validateTONAddress);
            document.getElementById('faucetpay-email').addEventListener('input', validateFaucetPayEmail);
            
            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø­Ø¨
            document.getElementById('withdraw-faucetpay-btn').addEventListener('click', handleFaucetPayWithdrawal);
            document.getElementById('withdraw-ton-btn').addEventListener('click', handleTONWithdrawal);
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ¨Ø¯ÙŠÙ„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø­Ø¨
        const switchWithdrawalMethod = (method) => {
            document.getElementById('faucetpay-details').classList.toggle('active', method === 'faucetpay');
            document.getElementById('ton-details').classList.toggle('active', method === 'ton');
        };

        // âœ… Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµØ­Ø©
        const validateTONAddress = () => {
            const address = document.getElementById('ton-address').value.trim();
            const validation = document.getElementById('ton-address-validation');
            
            if (address === '') {
                validation.className = 'validation-message validation-info';
                validation.innerHTML = '<i class="fas fa-info-circle"></i> Enter your TON wallet address';
            } else if (/^(UQ|EQ|kQ)/.test(address)) {
                validation.className = 'validation-message validation-success';
                validation.innerHTML = '<i class="fas fa-check-circle"></i> Valid TON address';
            } else {
                validation.className = 'validation-message validation-error';
                validation.innerHTML = '<i class="fas fa-exclamation-circle"></i> TON address should start with UQ, EQ, or kQ';
            }
        };

        const validateFaucetPayEmail = () => {
            const email = document.getElementById('faucetpay-email').value.trim();
            const validation = document.getElementById('faucetpay-validation');
            
            if (email === '') {
                validation.className = 'validation-message validation-info';
                validation.innerHTML = '<i class="fas fa-info-circle"></i> Enter your FaucetPay registered email';
            } else if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                validation.className = 'validation-message validation-success';
                validation.innerHTML = '<i class="fas fa-check-circle"></i> Valid email format';
            } else {
                validation.className = 'validation-message validation-error';
                validation.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please enter a valid email address';
            }
        };

        // âœ… Ø¯ÙˆØ§Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³Ø­Ø¨
        const handleFaucetPayWithdrawal = async () => {
            const email = document.getElementById('faucetpay-email').value;
            const amount = parseFloat(document.getElementById('withdraw-amount-faucetpay').value);
            
            if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                alert('Please enter a valid FaucetPay email');
                return;
            }
            
            if (!amount || amount < 0.0001) {
                alert('Minimum withdrawal is 0.0001 TON');
                return;
            }
            
            if (amount > userState.balance) {
                alert('Insufficient TON balance');
                return;
            }

            const minRefsRequired = appConfig.minimumWithdrawReferrals || 0;
            const userReferrals = userState.referrals || 0;

            if (minRefsRequired > 0 && userReferrals < minRefsRequired) {
                alert(`Withdrawal failed. You need at least ${minRefsRequired} referrals to make a withdrawal. You currently have ${userReferrals}.`);
                return;
            }

            const btn = document.getElementById('withdraw-faucetpay-btn'); 
            btn.disabled = true; 
            btn.textContent = 'Submitting...';
            const db = firebase.database();
            try {
                const userRef = db.ref(`users/${tgUser.id}`);
                userState.balance = (userState.balance || 0) - amount;
                renderUI();

                await userRef.child('balance').set(firebase.database.ServerValue.increment(-amount));
                const reqId = db.ref('withdrawals/pending').push().key;
                const newRequest = { 
                    id: reqId, 
                    userId: tgUser.id, 
                    userName: `${userState.firstName || ''} ${userState.lastName || ''}`.trim(), 
                    username: tgUser.username || '',
                    method: 'FaucetPay', 
                    account: email, 
                    amount: amount, 
                    status: 'pending', 
                    timestamp: firebase.database.ServerValue.TIMESTAMP 
                };
                await db.ref(`withdrawals/pending/${reqId}`).set(newRequest);

                userTransactions.unshift(newRequest);
                renderWithdrawalHistory();

                await sendWithdrawalNotification(newRequest);

                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert("Withdrawal request submitted successfully!"); 
                }catch{}
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.getElementById('faucetpay-email').value = '';
                document.getElementById('withdraw-amount-faucetpay').value = '';
                
            } catch (error) {
                userState.balance = (userState.balance || 0) + amount;
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error'); 
                    if (tg.showAlert) tg.showAlert("Failed to submit request. Your balance has been restored."); 
                }catch{}
            } finally {
                renderUI();
                btn.disabled = false;
                btn.textContent = 'Withdraw via FaucetPay';
            }
        };

        const handleTONWithdrawal = async () => {
            const address = document.getElementById('ton-address').value;
            const memo = document.getElementById('ton-memo').value;
            const amount = parseFloat(document.getElementById('withdraw-amount-ton').value);
            
            if (!address || !/^(UQ|EQ|kQ)/.test(address)) {
                alert('Please enter a valid TON wallet address');
                return;
            }
            
            if (!amount || amount < 0.05) {
                alert('Minimum withdrawal is 0.05 TON');
                return;
            }
            
            if (amount > userState.balance) {
                alert('Insufficient TON balance');
                return;
            }

            const minRefsRequired = appConfig.minimumWithdrawReferrals || 0;
            const userReferrals = userState.referrals || 0;

            if (minRefsRequired > 0 && userReferrals < minRefsRequired) {
                alert(`Withdrawal failed. You need at least ${minRefsRequired} referrals to make a withdrawal. You currently have ${userReferrals}.`);
                return;
            }

            const btn = document.getElementById('withdraw-ton-btn'); 
            btn.disabled = true; 
            btn.textContent = 'Submitting...';
            const db = firebase.database();
            try {
                const userRef = db.ref(`users/${tgUser.id}`);
                userState.balance = (userState.balance || 0) - amount;
                renderUI();

                await userRef.child('balance').set(firebase.database.ServerValue.increment(-amount));
                const reqId = db.ref('withdrawals/pending').push().key;
                const newRequest = { 
                    id: reqId, 
                    userId: tgUser.id, 
                    userName: `${userState.firstName || ''} ${userState.lastName || ''}`.trim(), 
                    username: tgUser.username || '',
                    method: 'TON', 
                    account: address, 
                    memo: memo,
                    amount: amount, 
                    status: 'pending', 
                    timestamp: firebase.database.ServerValue.TIMESTAMP 
                };
                await db.ref(`withdrawals/pending/${reqId}`).set(newRequest);

                userTransactions.unshift(newRequest);
                renderWithdrawalHistory();

                await sendWithdrawalNotification(newRequest);

                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert("Withdrawal request submitted successfully!"); 
                }catch{}
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.getElementById('ton-address').value = '';
                document.getElementById('ton-memo').value = '';
                document.getElementById('withdraw-amount-ton').value = '';
                
            } catch (error) {
                userState.balance = (userState.balance || 0) + amount;
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error'); 
                    if (tg.showAlert) tg.showAlert("Failed to submit request. Your balance has been restored."); 
                }catch{}
            } finally {
                renderUI();
                btn.disabled = false;
                btn.textContent = 'Withdraw to TON Wallet';
            }
        };

        const renderDynamicLinks = () => {
            const container = document.getElementById('dynamic-links-container'); 
            container.innerHTML = '';
            if (appConfig.links) {
                const links = [];
                for (const key in appConfig.links) { 
                    links.push({key, ...appConfig.links[key]}); 
                }
                links.reverse();
                links.forEach(link => {
                    const el = document.createElement('div'); 
                    el.className = 'task-container';
                    el.innerHTML = `
                        <img class="task-icon-img" src="${link.icon}" alt="icon">
                        <div class="task-info">
                            <h3>${link.name}</h3>
                        </div>
                        <button class="action-btn" onclick="window.Telegram?.WebApp?.openLink ? window.Telegram.WebApp.openLink('${link.url}') : window.open('${link.url}','_blank')">
                            Visit
                        </button>`;
                    container.appendChild(el);
                });
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø¨Ø³Ø·Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¹Ù†ÙˆØ§Ù† TON
        const isValidTONAddress = (address) => {
            if (!address || typeof address !== 'string') return false;
            const cleanAddress = address.trim();
            const validPrefixes = ['UQ', 'EQ', 'kQ'];
            const hasValidPrefix = validPrefixes.some(prefix => cleanAddress.startsWith(prefix));
            return hasValidPrefix;
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù„Ù€ FaucetPay
        const isValidFaucetPayEmail = (email) => {
            if (!email || typeof email !== 'string') return false;
            const cleanEmail = email.trim().toLowerCase();
            if (!cleanEmail.includes('@') || !cleanEmail.includes('.')) {
                return false;
            }
            return true;
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø­Ø¨
        const validateWithdrawalAccount = (method, account) => {
            if (!method || !account) return false;
            const cleanAccount = account.trim();
            
            if (method === 'FaucetPay') {
                return isValidFaucetPayEmail(cleanAccount);
            } else if (method === 'TON') {
                return isValidTONAddress(cleanAccount);
            } else {
                return cleanAccount.length > 0;
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø³Ø­Ø¨
        const sendWithdrawalNotification = async (withdrawalData) => {
            try {
                console.log('ðŸ” Starting withdrawal notification process...');
                const botToken = appConfig.botToken;
                
                if (!botToken) {
                    console.error('âŒ Bot token not found in Firebase config');
                    return;
                }

                const currentDate = new Date();
                const formattedDate = `${currentDate.getDate()}/${currentDate.getMonth() + 1}/${currentDate.getFullYear()} ${currentDate.getHours()}:${currentDate.getMinutes()}`;
                
                const memoInfo = withdrawalData.memo ? `\nâ€¢ Memo: ${withdrawalData.memo}` : '';
                
                const adminMessage = `
ðŸª™ NEW WITHDRAWAL REQUEST ðŸª™

ðŸ‘¤ User Information:
â€¢ Name: ${withdrawalData.userName || 'N/A'}
â€¢ Username: @${withdrawalData.username || 'N/A'}
â€¢ User ID: ${withdrawalData.userId}

ðŸ’Ž Withdrawal Details:
â€¢ Amount: ${Number(withdrawalData.amount).toFixed(4)} TON
â€¢ Method: ${withdrawalData.method}
â€¢ Wallet: ${withdrawalData.account}${memoInfo}

ðŸ“… Date & Time: ${formattedDate}
ðŸ†” Request ID: ${withdrawalData.id}

âœ… Status: Pending Approval
                `.trim();

                const adminChatId = appConfig.adminChatId || "6294480939";
                
                console.log('ðŸ“¤ Sending withdrawal notification to admin:', adminChatId);
                
                const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: adminChatId,
                        text: adminMessage
                    })
                });

                const result = await response.json();
                console.log('ðŸ“¨ Telegram API Response:', result);
                
                if (result.ok) {
                    console.log('âœ… Withdrawal notification sent successfully to admin');
                    return true;
                } else {
                    console.error('âŒ Failed to send notification:', result);
                    return false;
                }
                
            } catch (error) {
                console.error('âŒ Error sending withdrawal notification:', error);
                return false;
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
        const getReferralParam = () => {
            try {
                if (tg.initDataUnsafe?.start_param) {
                    console.log('ðŸ”— Found start_param in initDataUnsafe:', tg.initDataUnsafe.start_param);
                    return tg.initDataUnsafe.start_param;
                }
                
                if (tg.initData) {
                    const params = new URLSearchParams(tg.initData);
                    const startParam = params.get('startparam') || params.get('start_param');
                    if (startParam) {
                        console.log('ðŸ”— Found start_param in initData:', startParam);
                        return startParam;
                    }
                }
                
                const urlParams = new URLSearchParams(window.location.search);
                const refFromUrl = urlParams.get('start') || urlParams.get('ref');
                if (refFromUrl) {
                    console.log('ðŸ”— Found referral in URL:', refFromUrl);
                    return refFromUrl;
                }
                
                console.log('ðŸ” No referral parameter found');
                return null;
            } catch (error) {
                console.error('Error getting referral param:', error);
                return null;
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø³Ø­Ø¨
        const handleWithdraw = async (e) => {
            if (!isSubscribedToAllChannels) {
                try{ 
                    if (tg.showAlert) tg.showAlert("Please subscribe to all required channels first!"); 
                }catch{} 
                return; 
            }

            if(e.target.id !== 'withdraw-form') return;
            e.preventDefault();

            const minRefsRequired = appConfig.minimumWithdrawReferrals || 0;
            const userReferrals = userState.referrals || 0;

            if (minRefsRequired > 0 && userReferrals < minRefsRequired) {
                try{ 
                    if (tg.showAlert) tg.showAlert(`Withdrawal failed. You need at least ${minRefsRequired} referrals to make a withdrawal. You currently have ${userReferrals}.`); 
                }catch{}
                return;
            }

            const methodEl = document.getElementById('withdraw-method');
            const accountNumber = document.getElementById('account-number').value.trim();
            const memo = document.getElementById('withdraw-memo') ? document.getElementById('withdraw-memo').value.trim() : '';
            const amount = parseFloat(document.getElementById('amount').value);
            const selectedMethod = methodEl.value;

            if (!validateWithdrawalAccount(selectedMethod, accountNumber)) {
                try{ 
                    if (tg.showAlert) tg.showAlert(`âŒ Invalid account details for ${selectedMethod}. Please check the requirements.`); 
                }catch{}
                return;
            }

            if (isNaN(amount) || amount <= 0) { 
                try{ 
                    if (tg.showAlert) tg.showAlert("Please enter a valid amount."); 
                }catch{} 
                return; 
            }
            
            let minAmount = 0.001;
            if (selectedMethod === 'FaucetPay') {
                minAmount = 0.0001;
            } else if (selectedMethod === 'TON') {
                minAmount = 0.05;
            }
            
            if (amount < minAmount) { 
                try{ 
                    if (tg.showAlert) tg.showAlert(`Minimum withdrawal for ${selectedMethod} is ${Number(minAmount).toFixed(4)} TON.`); 
                }catch{} 
                return; 
            }
            
            if (amount > userState.balance) { 
                try{ 
                    if (tg.showAlert) tg.showAlert("You don't have enough balance."); 
                }catch{} 
                return; 
            }

            const btn = document.getElementById('withdraw-submit-btn'); 
            btn.disabled = true; 
            btn.textContent = 'Submitting...';
            const db = firebase.database();
            try {
                const userRef = db.ref(`users/${tgUser.id}`);
                userState.balance = (userState.balance || 0) - amount;
                renderUI();

                await userRef.child('balance').set(firebase.database.ServerValue.increment(-amount));
                const reqId = db.ref('withdrawals/pending').push().key;
                const newRequest = { 
                    id: reqId, 
                    userId: tgUser.id, 
                    userName: `${userState.firstName || ''} ${userState.lastName || ''}`.trim(), 
                    username: tgUser.username || '',
                    method: selectedMethod, 
                    account: accountNumber, 
                    memo: memo,
                    amount: amount, 
                    status: 'pending', 
                    timestamp: firebase.database.ServerValue.TIMESTAMP 
                };
                await db.ref(`withdrawals/pending/${reqId}`).set(newRequest);

                userTransactions.unshift(newRequest);
                renderWithdrawalHistory();

                await sendWithdrawalNotification(newRequest);

                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert("Withdrawal request submitted successfully!"); 
                }catch{}
                document.getElementById('withdraw-form').reset();
                
                const validationMessage = document.getElementById('account-validation');
                if (validationMessage) {
                    validationMessage.innerHTML = '<i class="fas fa-info-circle"></i> Select a method to see requirements';
                    validationMessage.className = 'validation-message validation-info';
                }
                
                document.querySelectorAll('.method-details').forEach(detail => {
                    detail.classList.remove('active');
                });
                
                const withdrawBtn = document.getElementById('withdraw-submit-btn');
                if (withdrawBtn) {
                    withdrawBtn.disabled = true;
                    withdrawBtn.className = 'withdraw-btn withdraw-btn-disabled';
                    withdrawBtn.innerHTML = '<i class="fas fa-wallet"></i> Submit Withdrawal';
                }
                
            } catch (error) {
                userState.balance = (userState.balance || 0) + amount;
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error'); 
                    if (tg.showAlert) tg.showAlert("Failed to submit request. Your balance has been restored."); 
                }catch{}
            } finally {
                renderUI();
                btn.disabled = false;
                btn.textContent = 'Submit Request';
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ - ØªØ¯Ø¹Ù… Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
        const redeemCode = async () => {
            try {
                const codeInput = document.getElementById('redeem-code-input');
                const redeemBtn = document.getElementById('redeem-code-btn');
                
                const code = codeInput.value.trim().toUpperCase();
                
                if (!code) {
                    try{ 
                        if (tg.showAlert) tg.showAlert("Please enter a code!"); 
                    }catch{} 
                    return;
                }
                
                if (redeemedCodes.includes(code)) {
                    try{ 
                        if (tg.showAlert) tg.showAlert("You have already used this code!"); 
                    }catch{} 
                    return;
                }
                
                redeemBtn.disabled = true;
                redeemBtn.textContent = 'Checking...';
                
                const db = firebase.database();
                const codesRef = db.ref('codes');
                const codeSnap = await codesRef.child(code).once('value');
                const codeData = codeSnap.val();
                
                if (!codeData) {
                    try{ 
                        if (tg.showAlert) tg.showAlert("Invalid code!"); 
                    }catch{} 
                    redeemBtn.disabled = false;
                    redeemBtn.textContent = 'Redeem';
                    return;
                }
                
                if (codeData.usedCount >= codeData.maxUses) {
                    try{ 
                        if (tg.showAlert) tg.showAlert("This code has reached its usage limit!"); 
                    }catch{} 
                    redeemBtn.disabled = false;
                    redeemBtn.textContent = 'Redeem';
                    return;
                }
                
                if (codeData.expires && Date.now() > codeData.expires) {
                    try{ 
                        if (tg.showAlert) tg.showAlert("This code has expired!"); 
                    }catch{} 
                    redeemBtn.disabled = false;
                    redeemBtn.textContent = 'Redeem';
                    return;
                }
                
                // âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
                let successMessage = '';
                
                if (codeData.rewardType === 'TON') {
                    // Ù…ÙƒØ§ÙØ£Ø© TON Ù…Ø¨Ø§Ø´Ø±Ø©
                    const tonAmount = codeData.rewardValue || 0;
                    userState.balance = (userState.balance || 0) + tonAmount;
                    successMessage = `ðŸŽ‰ Code redeemed! You earned ${tonAmount.toFixed(4)} TON!`;
                    
                    // ØªØ­Ø¯ÙŠØ« ÙÙŠ Firebase
                    const userRef = db.ref(`users/${tgUser.id}`);
                    await userRef.child('balance').set(firebase.database.ServerValue.increment(tonAmount));
                    
                } else if (codeData.rewardType === 'RR') {
                    // Ù…ÙƒØ§ÙØ£Ø© RR
                    const rrAmount = codeData.rewardValue || 0;
                    userRRBalance += rrAmount;
                    localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
                    successMessage = `ðŸŽ‰ Code redeemed! You earned ${rrAmount.toLocaleString()} RR!`;
                    
                } else if (codeData.rewardType === 'points') {
                    // Ù…ÙƒØ§ÙØ£Ø© Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
                    const points = codeData.rewardValue || 0;
                    if (contestData.isActive) {
                        await awardContestPoints(points);
                        successMessage = `ðŸŽ‰ Code redeemed! You earned ${points} contest points!`;
                    } else {
                        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ØºÙŠØ± Ù†Ø´Ø·Ø©ØŒ Ø¥Ø¹Ø·Ø§Ø¡ Ù…ÙƒØ§ÙØ£Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù…Ù† RR
                        const rewardAmountRR = points * 100;
                        userRRBalance += rewardAmountRR;
                        localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
                        successMessage = `ðŸŽ‰ Code redeemed! You earned ${rewardAmountRR.toLocaleString()} RR!`;
                    }
                } else {
                    // Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©)
                    const points = codeData.rewardValue || 10;
                    if (contestData.isActive) {
                        await awardContestPoints(points);
                        successMessage = `ðŸŽ‰ Code redeemed! You earned ${points} contest points!`;
                    } else {
                        const rewardAmountRR = points * 100;
                        userRRBalance += rewardAmountRR;
                        localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
                        successMessage = `ðŸŽ‰ Code redeemed! You earned ${rewardAmountRR.toLocaleString()} RR!`;
                    }
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙˆØ¯
                await codesRef.child(code).update({
                    usedCount: firebase.database.ServerValue.increment(1),
                    lastUsed: firebase.database.ServerValue.TIMESTAMP,
                    lastUsedBy: tgUser.id
                });
                
                redeemedCodes.push(code);
                const redeemedCodesRef = db.ref(`redeemedCodes/${tgUser.id}`);
                await redeemedCodesRef.set(redeemedCodes);
                
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert(successMessage); 
                }catch{}
                
                codeInput.value = '';
                redeemBtn.disabled = false;
                redeemBtn.textContent = 'Redeem';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                renderUI();
                
            } catch (error) {
                console.error('Error redeeming code:', error);
                try{ 
                    if (tg.showAlert) tg.showAlert("Failed to redeem code. Please try again."); 
                }catch{}
                
                const redeemBtn = document.getElementById('redeem-code-btn');
                redeemBtn.disabled = false;
                redeemBtn.textContent = 'Redeem';
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù…Ù†Ø­ Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© - Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
        const awardContestPoints = async (points) => {
            try {
                // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù†Ø´Ø·Ø© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø·
                if (!contestData.isActive) {
                    console.log('â„¹ï¸ Contest is not active, skipping points award');
                    return;
                }

                const db = firebase.database();
                const userContestRef = db.ref(`contest/participants/${tgUser.id}`);
                
                const userContestSnap = await userContestRef.once('value');
                const currentData = userContestSnap.val() || { 
                    points: 0, 
                    adsWatched: 0, 
                    referrals: 0,
                    userName: `${userState.firstName || ''} ${userState.lastName || ''}`.trim(),
                    username: tgUser.username || '',
                    userId: tgUser.id
                };
                
                const newPoints = (currentData.points || 0) + points;
                
                await userContestRef.update({
                    points: newPoints,
                    userName: `${userState.firstName || ''} ${userState.lastName || ''}`.trim(),
                    username: tgUser.username || '',
                    userId: tgUser.id,
                    lastActivity: firebase.database.ServerValue.TIMESTAMP
                });
                
                contestData.userPoints = newPoints;
                
            } catch (error) {
                console.error('Error awarding contest points:', error);
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ù‚Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
        const updateContestTimer = () => {
            const countdownEl = document.getElementById('contest-countdown');
            if (!contestData.endTime) {
                countdownEl.textContent = 'Contest not started';
                return;
            }
            
            const now = new Date().getTime();
            const distance = contestData.endTime - now;
            
            if (distance < 0) {
                countdownEl.textContent = 'Contest Ended!';
                contestData.isActive = false; // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
                updateContestStatus(); // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                return;
            }
            
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            countdownEl.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§
        const updateContestStatus = () => {
            const statusBox = document.getElementById('contest-status-box');
            const statusValue = document.getElementById('contest-status-value');
            const statusMessage = document.getElementById('contest-status-message');
            
            if (!contestData.isActive) {
                statusBox.className = 'contest-status-box contest-status-ended';
                statusValue.textContent = 'Ended';
                statusMessage.textContent = 'The contest has ended. Check results soon!';
            } else {
                statusBox.className = 'contest-status-box contest-status-active';
                statusValue.textContent = 'Active';
                if (contestData.userRank > 0) {
                    statusMessage.textContent = `You are currently ranked #${contestData.userRank} in the contest`;
                } else {
                    statusMessage.textContent = 'Join the contest to start earning points!';
                }
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
        const renderContestPage = () => {
            updateContestTimer();
            document.getElementById('user-contest-points').textContent = contestData.userPoints;
            document.getElementById('user-contest-rank').textContent = contestData.userRank > 0 ? `#${contestData.userRank}` : '-';
            renderCompactLeaderboard();
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† Ø§Ù„Ù…Ø®ØªØµØ±Ø© - Ù…Ø¹ ØµÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        const renderCompactLeaderboard = () => {
            const leaderboardList = document.getElementById('contest-leaderboard-compact-list');
            leaderboardList.innerHTML = '';
            
            if (contestData.leaderboard.length === 0) {
                leaderboardList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-secondary-dark);">No participants yet. Be the first to join!</p>';
                return;
            }
            
            const top10 = contestData.leaderboard.slice(0, 10);
            
            top10.forEach((participant, index) => {
                const rank = index + 1;
                const isCurrentUser = participant.userId === tgUser.id;
                
                let rankIcon = rank;
                if (rank === 1) rankIcon = 'ðŸ¥‡';
                else if (rank === 2) rankIcon = 'ðŸ¥ˆ';
                else if (rank === 3) rankIcon = 'ðŸ¥‰';
                
                let displayName = 'Unknown User';
                if (participant.userName && participant.userName.trim() !== '') {
                    displayName = participant.userName;
                } else if (participant.username) {
                    displayName = `@${participant.username}`;
                } else if (participant.userId) {
                    displayName = `User ${participant.userId}`;
                }
                
                const prizeAmount = getPrizeForRank(rank);
                const prizeText = prizeAmount > 0 ? `${prizeAmount} TON` : '';
                
                const item = document.createElement('div');
                item.className = `contest-leaderboard-item-compact ${isCurrentUser ? 'current-user' : ''}`;
                item.innerHTML = `
                    <div class="contest-rank-compact ${rank <= 3 ? 'top-3' : ''}">
                        ${rankIcon}
                    </div>
                    <div class="contest-user-info-compact" style="flex: 1; display: flex; justify-content: space-between; align-items: center;">
                        <div class="contest-user-details">
                            <div class="contest-user-name-compact">${displayName}</div>
                            <div class="contest-user-points-compact">${participant.points || 0} points</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="contest-user-score-compact">${participant.points || 0}</div>
                            ${prizeText ? `<div class="contest-user-prize">${prizeText}</div>` : ''}
                        </div>
                    </div>
                `;
                leaderboardList.appendChild(item);
            });
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ²
        const getPrizeForRank = (rank) => {
            const prizes = {
                1: 0.6,
                2: 0.4,
                3: 0.3,
                4: 0.15,
                5: 0.15,
                6: 0.1,
                7: 0.1,
                8: 0.1,
                9: 0.05,
                10: 0.05
            };
            
            return prizes[rank] || 0;
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† Ø§Ù„ÙƒØ§Ù…Ù„Ø©
        window.showFullLeaderboard = () => {
            showPopup(`
                <div style="text-align: left; max-height: 70vh; overflow-y: auto;">
                    <h2 style="margin-bottom: 15px; color: var(--ship-gold);">ðŸ† Full Leaderboard</h2>
                    <div style="margin-bottom: 15px; font-size: 0.9rem; color: var(--text-secondary-dark);">
                        Showing top 50 participants
                    </div>
                    <div id="full-leaderboard-content">
                        ${generateFullLeaderboardHTML()}
                    </div>
                    <button class="popup-close-btn" onclick="closePopup()" style="margin-top: 15px; width: 100%;">Close</button>
                </div>
            `);
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„ØªÙˆÙ„ÙŠØ¯ HTML Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† Ø§Ù„ÙƒØ§Ù…Ù„Ø©
        const generateFullLeaderboardHTML = () => {
            if (contestData.leaderboard.length === 0) {
                return '<p style="text-align: center; padding: 20px;">No participants yet.</p>';
            }
            
            let html = '';
            const top50 = contestData.leaderboard.slice(0, 50);
            
            top50.forEach((participant, index) => {
                const rank = index + 1;
                const isCurrentUser = participant.userId === tgUser.id;
                const prizeAmount = getPrizeForRank(rank);
                const prizeText = prizeAmount > 0 ? `${prizeAmount} TON` : '';
                
                let displayName = 'Unknown User';
                if (participant.userName && participant.userName.trim() !== '') {
                    displayName = participant.userName;
                } else if (participant.username) {
                    displayName = `@${participant.username}`;
                } else if (participant.userId) {
                    displayName = `User ${participant.userId}`;
                }
                
                let rankIcon = rank;
                if (rank === 1) rankIcon = 'ðŸ¥‡';
                else if (rank === 2) rankIcon = 'ðŸ¥ˆ';
                else if (rank === 3) rankIcon = 'ðŸ¥‰';
                
                html += `
                    <div style="display: flex; align-items: center; padding: 10px; margin: 5px 0; border-radius: 8px; ${
                        isCurrentUser ? 'background: rgba(255, 215, 0, 0.1); border: 2px solid var(--ship-gold);' : 'background: rgba(255,255,255,0.05);'
                    }">
                        <div style="width: 35px; height: 35px; border-radius: 50%; background: linear-gradient(45deg, var(--ship-gold), #ffa500); 
                             display: flex; align-items: center; justify-content: center; color: #000; font-weight: 700; margin-right: 12px; font-size: 0.9rem;">
                            ${rankIcon}
                        </div>
                        <div style="flex-grow: 1;">
                            <div style="font-weight: 600; ${isCurrentUser ? 'color: var(--ship-gold);' : ''}">${displayName}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary-dark);">${participant.points || 0} points â€¢ ${participant.adsWatched || 0} ads â€¢ ${participant.referrals || 0} referrals</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 700; color: var(--ship-gold);">${participant.points || 0}</div>
                            ${prizeText ? `<div style="font-size: 0.75rem; color: var(--success); margin-top: 2px;">${prizeText}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            return html;
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙˆØª ÙˆØ§Ø­Ø¯
        const checkRealSubscription = async (channelUsername) => {
            try {
                if (!tgUser || !tgUser.id) {
                    console.log('âŒ No Telegram user data available');
                    return false;
                }

                const botToken = appConfig.botToken;
                
                if (!botToken) {
                    console.error('âŒ Bot token not configured in Firebase');
                    return false;
                }

                console.log(`ðŸ” Checking REAL subscription for ${channelUsername}, user: ${tgUser.id}`);

                try {
                    const response = await fetch(`https://api.telegram.org/bot${botToken}/getChatMember`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: '@' + channelUsername,
                            user_id: tgUser.id
                        })
                    });

                    if (!response.ok) {
                        console.error(`âŒ HTTP error! status: ${response.status} for ${channelUsername}`);
                        return false;
                    }

                    const data = await response.json();
                    console.log(`ðŸ“Š Bot API response for ${channelUsername}:`, data);
                    
                    if (data.ok) {
                        const status = data.result.status;
                        const isSubscribed = ['member', 'administrator', 'creator'].includes(status);
                        console.log(`ðŸ“¢ REAL subscription status for ${channelUsername}: ${status} -> ${isSubscribed}`);
                        return isSubscribed;
                    } else {
                        console.error(`âŒ Bot API error for ${channelUsername}:`, data.description);
                        return false;
                    }
                } catch (fetchError) {
                    console.error(`âŒ Fetch error for ${channelUsername}:`, fetchError);
                    return false;
                }
                
            } catch (error) {
                console.error('Error checking real subscription:', error);
                return false;
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
        const checkTaskSubscription = async (task) => {
            try {
                if (!tgUser || !tgUser.id) {
                    console.log('âŒ No Telegram user data available');
                    return false;
                }

                const botToken = appConfig.botToken;
                
                if (!botToken) {
                    console.error('âŒ Bot token not configured in Firebase');
                    return false;
                }

                const channelMatch = task.url.match(/t\.me\/([^\/]+)/);
                if (!channelMatch) {
                    console.error('âŒ Invalid channel URL in task:', task.url);
                    return false;
                }

                const channelUsername = channelMatch[1];
                console.log(`ðŸ” Checking task subscription for ${channelUsername}, user: ${tgUser.id}`);

                try {
                    const response = await fetch(`https://api.telegram.org/bot${botToken}/getChatMember`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: '@' + channelUsername,
                            user_id: tgUser.id
                        })
                    });

                    if (!response.ok) {
                        console.error(`âŒ HTTP error! status: ${response.status} for ${channelUsername}`);
                        return false;
                    }

                    const data = await response.json();
                    console.log(`ðŸ“Š Bot API response for task channel ${channelUsername}:`, data);
                    
                    if (data.ok) {
                        const status = data.result.status;
                        const isSubscribed = ['member', 'administrator', 'creator'].includes(status);
                        console.log(`ðŸ“¢ Task subscription status for ${channelUsername}: ${status} -> ${isSubscribed}`);
                        return isSubscribed;
                    } else {
                        console.error(`âŒ Bot API error for task channel ${channelUsername}:`, data.description);
                        return false;
                    }
                } catch (fetchError) {
                    console.error(`âŒ Fetch error for task channel ${channelUsername}:`, fetchError);
                    return false;
                }
                
            } catch (error) {
                console.error('Error checking task subscription:', error);
                return false;
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
        const handleClaimTask = async (e) => {
            if (isUserBanned) {
                try{ 
                    if (tg.showAlert) tg.showAlert("Your account is banned. Contact support."); 
                }catch{} 
                return; 
            }

            if (!isSubscribedToAllChannels) {
                try{ 
                    if (tg.showAlert) tg.showAlert("Please subscribe to all required channels first!"); 
                }catch{} 
                return; 
            }

            if (e.target.classList.contains('action-btn') && e.target.dataset.taskId) {
                const taskId = e.target.dataset.taskId;
                const task = appConfig.tasks[taskId];
                if (!task || (userState.completedTasks && userState.completedTasks[taskId])) { 
                    try{ 
                        if (tg.showAlert) tg.showAlert('You have already claimed this bonus.'); 
                    }catch{} 
                    return; 
                }

                showPopup(`
                    <div style="margin-bottom:10px;">
                        <div class="spinner" style="width:40px;height:40px;border-radius:50%;border:4px solid var(--ship-gold);border-top-color:transparent;animation:spin 1s linear infinite;margin:0 auto;"></div>
                    </div>
                    <h2>Verifying Subscription</h2>
                    <p>Checking channel subscription...</p>
                `);

                const isSubscribed = await checkTaskSubscription(task);
                closePopup();

                if (!isSubscribed) {
                    try{ 
                        if (tg.showAlert) tg.showAlert("Please subscribe to the channel first to claim this bonus!"); 
                    }catch{} 
                    
                    try{ 
                        if (tg.openLink) tg.openLink(task.url); 
                    }catch{ 
                        window.open(task.url, '_blank'); 
                    }
                    return;
                }

                e.target.disabled = true; 
                e.target.textContent = 'Claiming...';
                
                try {
                    const db = firebase.database(); 
                    const userRef = db.ref(`users/${tgUser.id}`);
                    
                    const rewardAmountRR = Math.round(task.reward * RR_TO_TON_RATE);
                    userRRBalance += rewardAmountRR;
                    localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
                    
                    await userRef.child(`completedTasks/${taskId}`).set(true);
                    if (!userState.completedTasks) userState.completedTasks = {};
                    userState.completedTasks[taskId] = true;
                    try{ 
                        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                        if (tg.showAlert) tg.showAlert(`Thank you! You received ${rewardAmountRR.toLocaleString()} RR.`); 
                    }catch{}
                    renderUI();
                } catch (error) { 
                    try{ 
                        if (tg.showAlert) tg.showAlert('Failed to claim bonus.'); 
                    }catch{} 
                    e.target.disabled = false; 
                    e.target.textContent = 'Claim Bonus'; 
                }
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ - ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        window.claimDailyLoginBonus = async () => {
            try {
                const db = firebase.database();
                const today = new Date().toDateString();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø§Ù„ÙŠÙˆÙ…
                if (dailyLoginData.claimedDays && dailyLoginData.claimedDays.includes(today)) {
                    try{ 
                        if (tg.showAlert) tg.showAlert("You have already claimed your daily bonus today!"); 
                    }catch{} 
                    return;
                }
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ streak
                const currentStreak = dailyLoginData.currentStreak || 1;
                const rewardIndex = Math.min(currentStreak - 1, dailyLoginRewards.length - 1);
                const rewardAmount = dailyLoginRewards[rewardIndex] || dailyLoginRewards[dailyLoginRewards.length - 1] || 0.0001;
                
                const rewardAmountRR = Math.round(rewardAmount * RR_TO_TON_RATE);
                userRRBalance += rewardAmountRR;
                localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
                
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ
                if (!dailyLoginData.claimedDays) {
                    dailyLoginData.claimedDays = [];
                }
                dailyLoginData.claimedDays.push(today);
                dailyLoginData.lastLoginDate = today;
                
                const dailyLoginRef = db.ref(`dailyLogin/${tgUser.id}`);
                await dailyLoginRef.set(dailyLoginData);
                
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert(`ðŸŽ‰ Daily login bonus claimed! +${rewardAmountRR.toLocaleString()} RR (Day ${currentStreak})`); 
                }catch{}
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                renderUI();
                
                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
                setTimeout(() => {
                    closeDailyCalendar();
                }, 1500);
                
            } catch (error) {
                console.error('Error claiming daily login bonus:', error);
                try{ 
                    if (tg.showAlert) tg.showAlert("Failed to claim daily bonus. Please try again."); 
                }catch{} 
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© - ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        window.openDailyCalendar = () => {
            const today = new Date().toDateString();
            const isClaimedToday = dailyLoginData.claimedDays && dailyLoginData.claimedDays.includes(today);
            const currentStreak = dailyLoginData.currentStreak || 1;
            
            let calendarHTML = '';
            for (let day = 1; day <= dailyLoginRewards.length; day++) {
                const rewardAmount = dailyLoginRewards[day - 1];
                const rewardAmountRR = Math.round(rewardAmount * RR_TO_TON_RATE);
                let dayClass = 'calendar-day-compact future';
                let statusText = 'Future';
                
                if (day < currentStreak) {
                    dayClass = 'calendar-day-compact completed';
                    statusText = 'Claimed';
                } else if (day === currentStreak) {
                    if (isClaimedToday) {
                        dayClass = 'calendar-day-compact completed';
                        statusText = 'Claimed';
                    } else {
                        dayClass = 'calendar-day-compact current';
                        statusText = 'Claim Now';
                    }
                }
                
                calendarHTML += `
                    <div class="${dayClass}">
                        <div class="day-number-compact">Day ${day}</div>
                        <div class="day-reward-compact">${rewardAmountRR.toLocaleString()} RR</div>
                        <div class="day-status-compact">${statusText}</div>
                    </div>
                `;
            }
            
            document.getElementById('streak-calendar-compact').innerHTML = calendarHTML;
            document.getElementById('current-streak-display').textContent = `${currentStreak} days`;
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
            const statusElement = document.getElementById('daily-login-status');
            if (isClaimedToday) {
                statusElement.innerHTML = `
                    <div style="color: var(--success);">
                        <i class="fas fa-check-circle"></i> Today's bonus already claimed!
                    </div>
                `;
            } else {
                statusElement.innerHTML = `
                    <div style="color: var(--ship-gold);">
                        <i class="fas fa-gift"></i> Today's bonus available! 
                        <button onclick="claimDailyLoginBonus()" class="action-btn" style="padding: 5px 10px; font-size: 0.8rem; margin-left: 10px;">
                            Claim Now
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('daily-calendar-popup').style.display = 'flex';
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„ÙŠÙˆÙ…ÙŠ - ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§
        window.closeDailyCalendar = () => {
            document.getElementById('daily-calendar-popup').style.display = 'none';
        };

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        initApp();
    });

    // Ø¥Ø¶Ø§ÙØ© keyframes Ù„Ù„Ù€ spinner
    (function addSpinKeyframes(){ 
        const style = document.createElement('style'); 
        style.innerHTML='@keyframes spin{to{transform:rotate(360deg)}}'; 
        document.head.appendChild(style); 
    })();
    </script>

<!-- START: Anti-Multi-Account (IP + Fingerprint) with Firebase v8 transactions -->
<script>
// ======= Anti-Multi helpers (global) =======
function getDBv8() {
  if (window.firebase && window.firebase.database) return window.firebase.database();
  throw new Error('Firebase DB not ready.');
}

async function generateFingerprint() {
  try {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 200; canvas.height = 50;
    ctx.textBaseline = 'top';
    ctx.font = '16px "Arial"';
    ctx.fillStyle = '#f60'; ctx.fillRect(125,1,62,20);
    ctx.fillStyle = '#069'; ctx.fillText('fp-' + navigator.userAgent, 2, 2);
    const dataUrl = canvas.toDataURL();
    const features = [
      navigator.userAgent || '',
      navigator.platform || '',
      navigator.language || '',
      (screen.width + 'x' + screen.height),
      (new Date()).getTimezoneOffset(),
      (Intl && Intl.DateTimeFormat ? Intl.DateTimeFormat().resolvedOptions().timeZone || '' : ''),
      (localStorage.getItem('app_device_id') || ''),
      dataUrl.slice(-120)
    ].join('||');
    if (!localStorage.getItem('app_device_id')) localStorage.setItem('app_device_id', 'dev_' + Date.now());
    const enc = new TextEncoder();
    const buf = await crypto.subtle.digest('SHA-256', enc.encode(features));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
  } catch (e) {
    console.error('generateFingerprint error', e);
    return null;
  }
}

function tryClaimIndexTx(indexPath, ownerId) {
  const db = getDBv8();
  const ref = db.ref(indexPath);
  return new Promise((resolve) => {
    ref.transaction(current => {
      if (current === null) return ownerId;     // empty -> claim
      if (current === ownerId) return;          // already ours -> ok (no change)
      return;                                   // someone else -> no change (fail commit)
    }, (error, committed, snapshot) => {
      if (error) return resolve({ success: False, error });
      const val = snapshot ? snapshot.val() : null;
      if (!committed && val && val !== ownerId) {
        return resolve({ success: false, owner: val });
      }
      return resolve({ success: true, owner: val });
    }, false);
  });
}

async function releaseIndexIfOwned(indexPath, ownerId) {
  try {
    const db = getDBv8();
    const snap = await db.ref(indexPath).once('value');
    if (snap.val() === ownerId) {
      await db.ref(indexPath).remove();
      return true;
    }
    return false;
  } catch (e) {
    console.error('releaseIndexIfOwned error', e);
    return false;
  }
}

function showMultiBlock(reason) {
  const modal = document.getElementById('multiAccountModal');
  if (modal) {
    modal.style.display = 'flex';
    const txt = modal.querySelector('p');
    if (txt) txt.textContent = reason || 'Multiple accounts are not allowed.';
  } else {
    alert(reason || 'Multiple accounts are not allowed.');
  }
}

async function enforceAntiMultiOrBlock() {
  try {
    // Ensure Firebase auth (anonymous) exists
    if (!firebase.auth().currentUser) {
      try { await firebase.auth().signInAnonymously(); } catch (e) { console.warn('Anonymous auth failed (may already be signed in).', e); }
    }

    // Owner id prefers Telegram ID; fallback to Firebase auth uid
    const tgId = (window.tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) ? String(tg.initDataUnsafe.user.id) : null;
    const ownerId = tgId ? ('tg_' + tgId) : (firebase.auth().currentUser ? firebase.auth().currentUser.uid : null);
    if (!ownerId) return { success: false, reason: 'no_owner' };

    // Gather IP + fingerprint
    const ip = await getIpAddress(); // from existing code
    const fp = await generateFingerprint();

    const claims = [];

    // Claim IP index
    if (ip) {
      const ipKey = encodeURIComponent(ip);
      const resIp = await tryClaimIndexTx(`ipIndex/${ipKey}`, ownerId);
      if (!resIp.success) {
        showMultiBlock('This IP is already linked to another account.');
        return { success: false, reason: 'duplicate_ip', detail: resIp };
      }
      claims.push({ path: `ipIndex/${ipKey}` });
    }

    // Claim fingerprint index
    if (fp) {
      const fpKey = encodeURIComponent(fp);
      const resFp = await tryClaimIndexTx(`fpIndex/${fpKey}`, ownerId);
      if (!resFp.success) {
        // rollback previous claim(s)
        for (const c of claims) { await releaseIndexIfOwned(c.path, ownerId); }
        showMultiBlock('This device is already linked to another account.');
        return { success: false, reason: 'duplicate_fp', detail: resFp };
      }
      claims.push({ path: `fpIndex/${fpKey}` });
    }

    // Optionally persist on /users/{ownerId} for auditing
    try {
      await getDBv8().ref(`users/${ownerId}`).update({
        lastSeenIp: ip || null,
        lastSeenFingerprint: fp || null,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      });
    } catch (e) { console.warn('Could not update user audit node', e); }

    return { success: true, ownerId, ip, fp };
  } catch (e) {
    console.error('enforceAntiMultiOrBlock error', e);
    return { success: false, reason: 'error', error: e };
  }
}
</script>
<!-- END: Anti-Multi-Account -->

</body>
</html>

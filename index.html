<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <title>TON Deposit</title>

    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- TonConnect -->
    <script src="https://unpkg.com/@tonconnect/ui@0.1.39/dist/tonconnect-ui.min.js"></script>

    <!-- TON Core (علشان payload) -->
    <script src="https://unpkg.com/@ton/core@0.56.3/dist/index.js"></script>

    <style>
        body {
            font-family: Arial;
            background: #0f172a;
            color: #fff;
            padding: 20px;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        .box {
            margin-top: 20px;
            padding: 15px;
            background: #020617;
            border-radius: 8px;
        }
    </style>
</head>
<body>

<h2>إيداع TON</h2>

<div class="box">
    <p><b>عنوان الإيداع:</b></p>
    <p id="wallet"></p>

    <p><b>Comment (انسخه كما هو):</b></p>
    <p id="comment"></p>
</div>

<br>

<button onclick="depositFromSite()">إيداع من الموقع</button>

<div class="box" id="status"></div>

<script>
const MAIN_WALLET = "UQBnwSS4Kox3ZZmF69KxWLfvfCc2-dLV8sT5nJe-aV7HfCyG";

const tg = Telegram.WebApp;
tg.ready();

const user = tg.initDataUnsafe.user;
if (!user || !user.id) {
    alert("Telegram user not found");
}

document.getElementById("wallet").innerText = MAIN_WALLET;
document.getElementById("comment").innerText = `tg:${user.id}`;

// TonConnect init
const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: location.origin + "/tonconnect-manifest.json"
});

// إنشاء payload صحيح (Cell)
function createCommentPayload(text) {
    const { beginCell } = tonCore;
    return beginCell()
        .storeUint(0, 32)
        .storeStringTail(text)
        .endCell()
        .toBoc()
        .toString("base64");
}

async function depositFromSite() {
    try {
        const amountTON = 0.1;
        const comment = `tg:${user.id}`;
        const payload = createCommentPayload(comment);

        await tonConnectUI.sendTransaction({
            validUntil: Math.floor(Date.now() / 1000) + 300,
            messages: [{
                address: MAIN_WALLET,
                amount: (amountTON * 1e9).toString(),
                payload: payload
            }]
        });

        document.getElementById("status").innerHTML =
            "✅ تم إرسال المعاملة<br>⏳ جاري التأكيد خلال 1 – 3 دقائق";

    } catch (e) {
        document.getElementById("status").innerText =
            "❌ فشل الإرسال: " + e.message;
    }
}
</script>

</body>
</html>

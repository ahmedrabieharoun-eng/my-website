<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>GLX Galaxy</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="//libtl.com/sdk.js" data-zone="10058786" data-sdk="show_10058786" async></script>
<script src="https://ad.gigapub.tech/script?id=4102"></script>
<script src="https://sad.adsgram.ai/js/sad.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
/* ŸÜŸÅÿ≥ CSS ÿßŸÑÿ≥ÿßÿ®ŸÇ ÿ®ÿØŸàŸÜ ÿ™ÿ∫ŸäŸäÿ± */
:root{--primary-green:#a855f7;--deep-Galaxy:#202020;--gold:#d6bcfa;--gold-glow:rgba(168,85,247,0.4);--glass-bg:rgba(32,32,32,0.7);--glass-border:rgba(255,255,255,0.1);--text-color:#ffffff;--text-muted:#b0b0b0;--nav-bg:rgba(40,40,40,0.98);--success-color:#a855f7;}*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}body{font-family:'Outfit',sans-serif;color:var(--text-color);overflow-x:hidden;background-image:url('https://i.ibb.co/RGFp67kJ/121.jpg');background-size:cover;background-position:center;background-attachment:fixed;min-height:100vh;}body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at center,rgba(50,50,50,0.3)0%,rgba(30,30,30,0.85)100%);z-index:-1;}.app-container{padding:20px;padding-bottom:110px;max-width:500px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;}.content-section{display:none;animation:fadeIn 0.4s ease;}.content-section.active{display:flex;flex-direction:column;flex:1;}@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}h1{font-size:26px;font-weight:800;color:#fff;margin-bottom:5px;text-transform:uppercase;letter-spacing:1px;}h2{font-size:18px;font-weight:700;margin:20px 0 10px;color:var(--gold);display:flex;align-items:center;gap:8px;}p{font-size:13px;color:var(--text-muted);line-height:1.4;}.page-header{text-align:center;margin-bottom:20px;padding-top:10px;}.card{background:var(--glass-bg);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);border-radius:24px;padding:20px;margin-bottom:12px;border:1px solid var(--glass-border);box-shadow:0 4px 20px rgba(0,0,0,0.4);}.btn{display:flex;align-items:center;justify-content:center;width:100%;padding:16px;border-radius:18px;font-size:16px;font-weight:800;cursor:pointer;border:none;outline:none;gap:8px;text-transform:uppercase;letter-spacing:0.5px;transition:transform 0.1s;}.btn:active{transform:scale(0.96);}.btn:disabled{opacity:0.5;cursor:not-allowed;filter:grayscale(1);}.btn-primary{background:linear-gradient(90deg,#a855f7,#7c3aed);color:#fff;box-shadow:0 0 15px rgba(168,85,247,0.4);}.btn-ton{background:linear-gradient(90deg,#0088cc,#0099ff);color:#fff;box-shadow:0 0 15px rgba(0,136,204,0.4);}.btn-check{background:linear-gradient(90deg,#a855f7,#7c3aed);color:#fff;box-shadow:0 0 15px rgba(168,85,247,0.4);}.btn-action{background:rgba(0,0,0,0.3)!important;backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,0.1)!important;color:#b0b0b0!important;flex-direction:column;padding:12px;font-size:12px;gap:5px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.2);transition:all 0.3s ease;}.btn-action svg{width:24px;height:24px;stroke:#b0b0b0!important;fill:none;stroke-width:2.5;transition:all 0.3s ease;}.btn-action:active{background:rgba(0,0,0,0.4)!important;transform:scale(0.98);}.hud-container{display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,0.5);border-radius:50px;padding:10px 15px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.05);}.user-name{font-weight:700;font-size:14px;}.user-rank{font-size:10px;color:var(--primary-green);text-transform:uppercase;}.hud-avatar{width:50px;height:50px;border-radius:50%;overflow:hidden;border:2px solid var(--primary-green);}.hud-avatar img{width:100%;height:100%;object-fit:cover;}.hud-balance{display:flex;flex-direction:column;align-items:flex-end;gap:5px;}.hud-balance-item{display:flex;align-items:center;gap:5px;font-size:12px;font-weight:600;}.hud-glx{color:var(--gold);}.hud-ton{color:#0088cc;}.main-coin-section{text-align:center;margin:10px 0 30px;position:relative;}.main-coin-img{width:160px;height:160px;border-radius:50%;box-shadow:0 0 50px rgba(168,85,247,0.3);animation:float 4s ease-in-out infinite;object-fit:cover;border:4px solid var(--primary-green);}@keyframes float{0%{transform:translateY(0px);}50%{transform:translateY(-10px);}100%{transform:translateY(0px);}}.balance-display{margin-top:15px;}.balance-amount{font-size:48px;font-weight:800;background:linear-gradient(to bottom,#fff,#b3b3b3);-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1;}.balance-unit{font-size:16px;color:var(--primary-green);font-weight:700;letter-spacing:2px;}.stats-pill{display:inline-flex;align-items:center;gap:15px;background:rgba(255,255,255,0.05);padding:8px 16px;border-radius:20px;margin-top:10px;font-size:12px;font-weight:600;}.ton-val{color:var(--primary-green);display:flex;align-items:center;gap:4px;}.action-bar{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:25px;}.list-card{display:flex;align-items:center;background:rgba(0,0,0,0.3);border-radius:16px;padding:12px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.05);cursor:pointer;}.lc-icon{width:42px;height:42px;border-radius:12px;background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;margin-right:12px;flex-shrink:0;}.lc-icon img{width:100%;height:100%;object-fit:cover;border-radius:12px;}.lc-content{flex:1;}.lc-title{font-size:14px;font-weight:600;margin-bottom:2px;}.lc-sub{font-size:11px;color:var(--text-muted);}.lc-end{text-align:right;}.lc-val{font-weight:700;color:var(--primary-green);font-size:14px;}.daily-row{display:flex;overflow-x:auto;gap:8px;padding-bottom:10px;margin-bottom:15px;scrollbar-width:none;}.daily-box{min-width:70px;background:rgba(255,255,255,0.05);border-radius:12px;padding:10px 5px;text-align:center;border:1px solid transparent;opacity:0.5;}.daily-box.active{opacity:1;border-color:var(--gold);background:rgba(255,215,0,0.1);}.daily-box.claimed{opacity:1;background:var(--primary-green);color:#000;}.slots-machine{background:rgba(0,0,0,0.6);border-radius:20px;padding:20px;margin-bottom:20px;border:2px solid var(--primary-green);box-shadow:0 0 25px rgba(168,85,247,0.4);text-align:center;}.slots-reels{display:flex;justify-content:center;align-items:center;gap:15px;margin:20px 0;padding:10px;}.reel-container{position:relative;width:70px;height:70px;overflow:hidden;border-radius:12px;background:rgba(0,0,0,0.8);border:2px solid rgba(168,85,247,0.5);box-shadow:0 0 15px rgba(168,85,247,0.3);display:flex;justify-content:center;align-items:center;}.reel{display:flex;flex-direction:column;transition:transform 2s cubic-bezier(0.1,0,0.2,1);}.slot-item{width:70px;height:70px;display:flex;align-items:center;justify-content:center;font-size:32px;}.slots-result{background:rgba(0,0,0,0.8);border-radius:15px;padding:15px;margin-top:20px;border:1px solid rgba(255,255,255,0.1);text-align:center;}.payout-table{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:15px;font-size:11px;}.payout-item{background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;text-align:center;}.jackpot{color:#FFD700;font-weight:800;text-shadow:0 0 10px rgba(255,215,0,0.8);}.input-wrap{background:rgba(0,0,0,0.4);border-radius:16px;padding:15px;margin-bottom:15px;border:1px solid rgba(255,255,255,0.1);}.input-label{font-size:11px;color:var(--text-muted);display:block;margin-bottom:5px;text-transform:uppercase;}.custom-input{width:100%;background:transparent;border:none;color:#fff;font-size:16px;font-weight:600;outline:none;font-family:inherit;}.cat-select{display:flex;gap:10px;margin-bottom:20px;}.cat-opt{flex:1;padding:12px;text-align:center;background:rgba(255,255,255,0.05);border-radius:12px;font-size:12px;cursor:pointer;border:1px solid transparent;}.cat-opt.active{background:var(--primary-green);color:#000;border-color:var(--primary-green);font-weight:700;}.price-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:15px;}.price-opt{padding:10px;background:rgba(255,255,255,0.05);border-radius:10px;text-align:center;cursor:pointer;border:1px solid transparent;}.price-opt.active{border-color:var(--gold);background:rgba(255,215,0,0.1);}.price-count{font-size:14px;font-weight:700;color:#fff;}.price-cost{font-size:10px;color:var(--primary-green);margin-top:2px;}.terms-box{background:rgba(0,0,0,0.3);border-radius:16px;padding:15px;height:300px;overflow-y:auto;font-size:12px;color:var(--text-muted);border:1px solid rgba(255,255,255,0.05);line-height:1.6;}.terms-box h3{color:#fff;font-size:14px;margin-top:15px;margin-bottom:5px;}.terms-box h3:first-child{margin-top:0;}.bottom-nav{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);width:90%;max-width:400px;height:65px;background:var(--nav-bg);border-radius:32px;display:flex;justify-content:space-around;align-items:center;box-shadow:0 10px 30px rgba(0,0,0,0.5);z-index:100;border:1px solid rgba(255,255,255,0.1);}.nav-item{display:flex;flex-direction:column;align-items:center;color:#666;transition:0.3s;cursor:pointer;position:relative;width:50px;}.nav-item svg{width:22px;height:22px;margin-bottom:4px;stroke:currentColor;fill:none;stroke-width:2.5;transition:all 0.3s;}.nav-item.active{color:var(--primary-green);transform:translateY(-2px);}.nav-item.active svg{stroke:var(--primary-green);filter:drop-shadow(0 0 8px rgba(168,85,247,0.6));}.nav-text{font-size:9px;font-weight:700;text-transform:uppercase;}.hidden{display:none!important;}.leader-tabs{display:flex;background:rgba(0,0,0,0.3);border-radius:50px;padding:4px;margin-bottom:20px;}.tab-btn{flex:1;text-align:center;padding:10px;border-radius:50px;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.3s;}.tab-btn.active{background:var(--primary-green);color:#000;}.withdrawal-type-selector{display:flex;background:rgba(0,0,0,0.3);border-radius:50px;padding:4px;margin-bottom:20px;}.withdrawal-type-btn{flex:1;text-align:center;padding:12px;border-radius:50px;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.3s;border:1px solid transparent;}.withdrawal-type-btn.active{background:var(--primary-green);color:#000;border-color:var(--primary-green);}.info-box{background:rgba(255,179,0,0.1);border:1px solid var(--gold);border-radius:12px;padding:12px;margin-bottom:15px;font-size:11px;line-height:1.5;}.info-box.success{background:rgba(39,174,96,0.1);border-color:#27ae60;}.info-icon{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;margin-right:5px;border-radius:50%;background:var(--gold);color:#000;font-size:10px;font-weight:bold;}.info-box.success .info-icon{background:#27ae60;color:#fff;}.floating-add-task{position:fixed;bottom:85px;left:50%;transform:translateX(-50%);width:160px!important;min-width:140px!important;max-width:180px!important;background:rgba(168,85,247,0.15)!important;backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);border-radius:18px;padding:10px 16px!important;border:1px solid rgba(168,85,247,0.3);box-shadow:0 4px 20px rgba(168,85,247,0.2);z-index:99;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.3s;}.floating-add-task:active{transform:translateX(-50%)scale(0.98);background:rgba(168,85,247,0.25)!important;}.floating-add-task:hover{background:rgba(168,85,247,0.2)!important;}.floating-add-task-content{display:flex;align-items:center;justify-content:center;gap:6px!important;}.floating-add-task-icon{width:30px;height:30px;background:rgba(168,85,247,0.3);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold;color:#fff;border:1px solid rgba(168,85,247,0.5);}.floating-add-task-text{font-size:13px!important;font-weight:700;color:rgba(255,255,255,0.9);text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap!important;}.spins-display{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.08);border-radius:15px;padding:12px 15px;margin-bottom:15px;border:1px solid var(--glass-border);}.spins-count{font-size:20px;font-weight:800;color:var(--primary-green);}.referred-users-list{max-height:300px;overflow-y:auto;margin-top:15px;}.referred-user-item{display:flex;align-items:center;padding:10px;background:rgba(255,255,255,0.05);border-radius:12px;margin-bottom:8px;}.referred-user-avatar{width:40px;height:40px;border-radius:50%;margin-right:12px;border:2px solid var(--primary-green);}.referred-user-info{flex:1;}.referred-user-name{font-size:14px;font-weight:600;}.referred-user-date{font-size:11px;color:var(--text-muted);}.referred-user-status{font-size:10px;padding:2px 8px;border-radius:10px;background:var(--primary-green);color:#000;font-weight:700;}.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;}.stat-card{background:rgba(168,85,247,0.1);padding:15px;border-radius:12px;text-align:center;border:1px solid rgba(168,85,247,0.3);}.stat-value{font-size:24px;font-weight:800;color:var(--primary-green);margin-top:5px;}.stat-label{font-size:12px;color:var(--text-muted);}.promo-card,.code-channel-card{transition:all 0.3s ease;animation:cardFloat 3s ease-in-out infinite alternate;}@keyframes cardFloat{0%{transform:translateY(0);}100%{transform:translateY(-5px);}}.code-channel-card:active{transform:scale(0.98);}#promo-code-input:focus{box-shadow:0 0 15px rgba(168,85,247,0.4);border-color:#a855f7;}.max-btn,.withdraw-max-btn{min-width:60px!important;height:44px!important;padding:10px 15px!important;font-size:12px!important;font-weight:800!important;white-space:nowrap!important;border:2px solid rgba(168,85,247,0.5)!important;background:rgba(168,85,247,0.2)!important;color:white!important;border-radius:12px!important;cursor:pointer!important;}@keyframes cupShine{0%{filter:drop-shadow(0 0 5px rgba(255,215,0,0.7));}50%{filter:drop-shadow(0 0 15px rgba(255,215,0,0.9));}100%{filter:drop-shadow(0 0 5px rgba(255,215,0,0.7));}}@keyframes pulseArrow{0%{transform:translateY(0);opacity:1;}50%{transform:translateY(-2px);opacity:0.7;}100%{transform:translateY(0);opacity:1;}}@media (max-width:480px){.max-btn,.withdraw-max-btn{min-width:50px!important;padding:8px 12px!important;font-size:11px!important;height:42px!important;}.ticket-input,.bet-input{font-size:16px!important;padding:12px!important;height:44px!important;}.coin-bet-controls,.ticket-controls{display:flex!important;align-items:center!important;gap:8px!important;width:100%!important;}.bet-input,.ticket-input{flex:1!important;min-width:0!important;font-size:16px!important;padding:12px!important;height:44px!important;}.app-container{padding:10px;padding-bottom:80px;}.main-coin-img{width:120px;height:120px;}.balance-amount{font-size:36px;}.bottom-nav{width:95%;height:60px;}.nav-text{font-size:8px;}.bottom-nav{width:96%;padding:0 5px;}.nav-item{width:45px;}.nav-text{font-size:7px;}.slots-reels{gap:8px;}.reel-container{width:60px;height:60px;}.slot-item{width:60px;height:60px;font-size:28px;}.floating-add-task{width:140px!important;padding:8px 12px!important;bottom:80px;}.floating-add-task-icon{width:28px;height:28px;font-size:16px;}.floating-add-task-text{font-size:12px!important;}}input[type="number"]{-webkit-appearance:none;-moz-appearance:textfield;appearance:none;font-size:18px!important;}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0;}.coin-flip-game{background:rgba(0,0,0,0.6);border-radius:20px;padding:20px;margin-bottom:20px;border:2px solid var(--primary-green);box-shadow:0 0 25px rgba(168,85,247,0.4);}.coin-bet-controls{display:flex;align-items:center;gap:10px;margin-bottom:20px;}.bet-input{flex:1;padding:12px 15px;border-radius:12px;background:rgba(0,0,0,0.3);border:2px solid rgba(168,85,247,0.6);color:white;font-family:inherit;font-size:16px;font-weight:700;text-align:center;outline:none;min-height:44px;}.bet-input:focus{box-shadow:0 0 15px rgba(168,85,247,0.6);border-color:#a855f7;}.bet-buttons{display:flex;gap:8px;margin-top:15px;}.bet-btn{padding:12px 15px;background:rgba(168,85,247,0.2);border:2px solid rgba(168,85,247,0.5);border-radius:10px;color:white;cursor:pointer;font-size:14px;font-weight:700;min-width:65px;text-align:center;flex:1;}.bet-btn.active{background:linear-gradient(135deg,#a855f7,#7c3aed);border-color:#a855f7;box-shadow:0 5px 15px rgba(168,85,247,0.4);}.coin-container{width:150px;height:150px;margin:0 auto 20px;perspective:1000px;}.coin{width:100%;height:100%;position:relative;transform-style:preserve-3d;transform:rotateY(0deg);transition:none;}.coin-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 0 20px rgba(0,0,0,0.5);overflow:hidden;}.coin-face img{width:100%;height:100%;object-fit:cover;}.coin-front{background:linear-gradient(45deg,#a855f7,#7c3aed);transform:rotateY(0deg);}.coin-back{background:linear-gradient(45deg,#7c3aed,#a855f7);transform:rotateY(180deg);}.gold-side{filter:sepia(1)saturate(2)hue-rotate(10deg)brightness(1.2);}@keyframes coinSpin{0%{transform:rotateY(0);}25%{transform:rotateY(180deg)translateY(-20px);}50%{transform:rotateY(360deg)translateY(0);}75%{transform:rotateY(540deg)translateY(-10px);}100%{transform:rotateY(var(--final-rotation,720deg))translateY(0);}}.coin-spinning{animation:coinSpin 2.5s cubic-bezier(0.4,2.4,0.8,0.9)forwards;}.coin-final{animation:none!important;transform:rotateY(var(--final-rotation,0deg))!important;}.game-result{background:rgba(0,0,0,0.8);border-radius:15px;padding:15px;margin-top:20px;text-align:center;}.result-text{font-size:18px;font-weight:700;margin-bottom:10px;}.win-amount{font-size:24px;font-weight:800;color:#27ae60;}.loss-amount{font-size:24px;font-weight:800;color:#e74c3c;}.bonus-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;}.bonus-game-card{background:var(--glass-bg);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);border-radius:16px;overflow:hidden;border:1px solid var(--glass-border);cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(0,0,0,0.3);}.bonus-game-card:active{transform:scale(0.97);}.game-banner{width:100%;height:120px;object-fit:cover;display:block;}.game-content{padding:12px;}.game-title{font-size:14px;font-weight:700;color:white;margin-bottom:4px;text-align:center;}.game-description{font-size:11px;color:var(--text-muted);text-align:center;line-height:1.3;}.game-icon{font-size:20px;margin-bottom:8px;text-align:center;color:var(--primary-green);}.side-selection{display:flex;gap:10px;margin-bottom:20px;}.side-btn{flex:1;padding:20px 15px;border-radius:15px;background:rgba(255,255,255,0.05);border:2px solid transparent;cursor:pointer;text-align:center;transition:all 0.3s;min-height:140px;display:flex;flex-direction:column;justify-content:center;align-items:center;}.side-btn.active{border-color:var(--primary-green);background:rgba(168,85,247,0.2);box-shadow:0 5px 20px rgba(168,85,247,0.3);}.side-btn.win{border-color:#27ae60;background:rgba(39,174,96,0.2);}.side-btn.lose{border-color:#e74c3c;background:rgba(231,76,60,0.2);}.side-icon{font-size:24px;margin-bottom:10px;width:70px;height:70px;display:flex;align-items:center;justify-content:center;}.side-name{font-size:16px;font-weight:700;margin-bottom:5px;}.side-description{font-size:12px;color:var(--text-muted);text-align:center;}.probability-display{display:none!important;}.competition-nav-item{position:relative;}.competition-nav-icon{position:relative;display:flex;align-items:center;justify-content:center;}@keyframes trophyGlow{0%,100%{filter:drop-shadow(0 0 8px rgba(255,215,0,0.7));}50%{filter:drop-shadow(0 0 20px rgba(255,215,0,0.9));}}.nav-item.competition-nav-item.active svg{animation:trophyGlow 2s infinite alternate;}.nav-item[data-target="withdrawal-history"] svg{filter:drop-shadow(0 0 8px rgba(168,85,247,0.4));animation:none;}.galaxy-log-icon{width:40px;height:40px;background:rgba(168,85,247,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(168,85,247,0.4);transition:all 0.3s;}.galaxy-log-icon:hover{transform:scale(1.05);background:rgba(168,85,247,0.3);border-color:#a855f7;}.btn-filter{padding:8px 15px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--text-muted);font-size:12px;cursor:pointer;transition:all 0.3s;}.btn-filter.active{background:var(--primary-green);color:#000;font-weight:700;border-color:var(--primary-green);}.btn-filter.small{padding:5px 10px;font-size:10px;}.log-stat-card{background:rgba(0,0,0,0.3);border-radius:12px;padding:12px;text-align:center;border:1px solid rgba(255,255,255,0.1);}.log-item{display:flex;align-items:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:12px;margin-bottom:8px;border-left:4px solid transparent;}.log-item.earn{border-left-color:#27ae60;background:rgba(39,174,96,0.1);}.log-item.spend{border-left-color:#e74c3c;background:rgba(231,76,60,0.1);}.log-item.swap{border-left-color:#3498db;background:rgba(52,152,219,0.1);}.log-item.withdraw{border-left-color:#9b59b6;background:rgba(155,89,182,0.1);}.support-channel-card{background:rgba(255,255,255,0.05);border-radius:12px;padding:15px;margin-bottom:10px;cursor:pointer;transition:all 0.3s;border:1px solid rgba(255,255,255,0.1);}.support-channel-card:hover{background:rgba(255,255,255,0.08);transform:translateY(-2px);border-color:rgba(168,85,247,0.4);}.withdrawal-overview{text-align:center;margin-bottom:20px;}.coin-game-rules{margin-top:25px;padding:20px;background:rgba(0,0,0,0.4);border-radius:15px;border:1px solid rgba(255,255,255,0.1);}.coin-game-rules h4{font-size:14px;color:var(--gold);margin-bottom:15px;}.coin-game-rules ul{font-size:12px;color:var(--text-muted);padding-left:20px;}.coin-game-rules li{margin-bottom:8px;}.competition-timer-card{background:linear-gradient(135deg,rgba(168,85,247,0.2),rgba(123,97,255,0.2));border:2px solid rgba(168,85,247,0.3);border-radius:20px;padding:25px;margin-bottom:20px;text-align:center;box-shadow:0 10px 30px rgba(168,85,247,0.2);}.countdown-display{font-size:36px;font-weight:800;color:#fff;text-shadow:0 0 15px rgba(168,85,247,0.8);margin-bottom:8px;font-family:'Courier New',monospace;}.timer-label{font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;}.status-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px;}.status-card{background:var(--glass-bg);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);border-radius:16px;padding:20px;text-align:center;border:1px solid var(--glass-border);}.status-icon{font-size:30px;margin-bottom:10px;}.status-value{font-size:24px;font-weight:800;color:#fff;margin-bottom:5px;}.status-label{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;}.ticket-price-note{background:rgba(168,85,247,0.1);border-radius:12px;padding:15px;margin-bottom:20px;text-align:center;font-size:12px;border:1px solid rgba(168,85,247,0.3);}.ticket-controls{display:flex;align-items:center;gap:10px;margin-bottom:20px;}.ticket-input{flex:1;padding:15px;border-radius:12px;background:rgba(0,0,0,0.3);border:2px solid rgba(168,85,247,0.5);color:white;font-size:18px;font-weight:700;text-align:center;outline:none;min-height:44px;}.competition-leaderboard{margin-top:25px;}.leaderboard-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.1);}.previous-winners-card{background:var(--glass-bg);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);border-radius:16px;padding:20px;margin-top:20px;border:1px solid var(--glass-border);}.winner-item{display:flex;align-items:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:12px;margin-bottom:10px;}.winner-rank{width:30px;height:30px;background:var(--primary-green);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;margin-right:15px;}.winner-avatar{width:40px;height:40px;border-radius:50%;margin-right:12px;border:2px solid var(--primary-green);}.winner-info{flex:1;}.winner-name{font-size:14px;font-weight:600;margin-bottom:2px;}.winner-date{font-size:10px;color:var(--text-muted);}.winner-prize{font-size:14px;font-weight:700;color:var(--primary-green);}.withdraw-max-btn{position:absolute;right:15px;top:50%;transform:translateY(-50%);background:rgba(168,85,247,0.2);border:1px solid rgba(168,85,247,0.5);border-radius:8px;padding:6px 12px;color:white;font-size:10px;cursor:pointer;font-weight:700;z-index:10;}.bet-btn.k-style{min-width:55px;padding:10px 12px;font-size:13px;flex:1;}.user-withdrawal-item{background:rgba(255,255,255,0.05);border-radius:12px;padding:12px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.1);}.withdrawal-status{font-size:10px;padding:3px 10px;border-radius:20px;font-weight:700;}.status-completed{background:rgba(39,174,96,0.2);color:#27ae60;}.status-pending{background:rgba(255,193,7,0.2);color:#FFC107;}.status-rejected{background:rgba(231,76,60,0.2);color:#e74c3c;}.masked-email{font-family:'Courier New',monospace;letter-spacing:1px;}.competition-rank-card{display:flex;align-items:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:12px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.1);}.competition-rank{width:30px;font-weight:800;font-size:14px;text-align:center;margin-right:10px;}.rank-1 .competition-rank{color:#27ae60;font-weight:900;}.rank-2 .competition-rank{color:#C0C0C0;}.rank-3 .competition-rank{color:#CD7F32;}.competition-user-avatar{width:36px;height:36px;border-radius:50%;margin-right:12px;border:2px solid var(--primary-green);}.competition-user-info{flex:1;}.competition-user-name{font-size:13px;font-weight:600;margin-bottom:2px;}.competition-ticket-count{font-size:14px;font-weight:700;color:var(--primary-green);}.competition-rules-card{background:rgba(0,0,0,0.4);border-radius:16px;padding:20px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.1);}.rules-header{display:flex;align-items:center;gap:10px;margin-bottom:15px;color:var(--gold);font-size:16px;font-weight:700;}.rules-list{font-size:12px;color:var(--text-muted);line-height:1.6;padding-left:20px;}.rules-list li{margin-bottom:8px;}.winner-highlight{color:#27ae60;font-weight:700;}.loser-note{color:#e74c3c;font-weight:600;}.important-note{background:rgba(255,193,7,0.1);border-left:3px solid #FFC107;padding:10px;margin-top:15px;border-radius:5px;font-size:11px;}.swap-direction-selector{display:flex;background:rgba(0,0,0,0.3);border-radius:50px;padding:4px;margin-bottom:20px;}.swap-direction-btn{flex:1;text-align:center;padding:12px;border-radius:50px;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.3s;border:1px solid transparent;}.swap-direction-btn.active{background:var(--primary-green);color:#000;border-color:var(--primary-green);}.withdraw-input-with-max{position:relative;}.withdraw-input-with-max .custom-input{padding-right:70px;}.email-display{font-family:'Courier New',monospace;background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;border:1px solid rgba(255,255,255,0.2);font-size:16px;letter-spacing:2px;color:white;text-align:center;margin-top:10px;}.swap-mode-text{font-size:12px;color:var(--text-muted);text-align:center;margin:10px 0;}.verification-container{background:var(--glass-bg);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:24px;padding:30px;margin:20px;text-align:center;border:2px solid rgba(168,85,247,0.3);box-shadow:0 10px 40px rgba(0,0,0,0.5);}.verification-step{display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,0.3);border-radius:12px;padding:15px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.1);transition:all 0.3s ease;}.verification-step.active{border-color:var(--primary-green);background:rgba(168,85,247,0.1);}.verification-step.completed{border-color:#27ae60;background:rgba(39,174,96,0.1);}.verification-step.failed{border-color:#e74c3c;background:rgba(231,76,60,0.1);}.step-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold;}.step-info{flex:1;text-align:left;padding:0 15px;}.step-title{font-size:14px;font-weight:600;color:white;margin-bottom:3px;}.step-description{font-size:11px;color:var(--text-muted);}.step-status{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;}.security-message{background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.3);border-radius:12px;padding:15px;margin:15px 0;color:#e74c3c;font-size:14px;}.verification-progress{width:100%;height:8px;background:rgba(255,255,255,0.1);border-radius:4px;margin:20px 0;overflow:hidden;}.progress-bar{height:100%;background:linear-gradient(90deg,var(--primary-green),#7c3aed);border-radius:4px;transition:width 0.5s ease;}.blocked-container{background:rgba(0,0,0,0.8);border-radius:24px;padding:40px 30px;text-align:center;margin:20px;border:2px solid rgba(231,76,60,0.3);animation:pulse 2s infinite;}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(231,76,60,0.4);}70%{box-shadow:0 0 0 10px rgba(231,76,60,0);}100%{box-shadow:0 0 0 0 rgba(231,76,60,0);}}.blocked-icon{font-size:60px;margin-bottom:20px;color:#e74c3c;}.blocked-title{font-size:24px;font-weight:800;color:#e74c3c;margin-bottom:15px;}.blocked-reason{background:rgba(231,76,60,0.1);border-radius:12px;padding:15px;margin:20px 0;font-size:14px;line-height:1.5;}.verification-loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:var(--primary-green);animation:spin 1s ease-in-out infinite;}@keyframes spin{to{transform:rotate(360deg);}}.ip-display{background:rgba(0,0,0,0.5);padding:10px;border-radius:8px;font-family:'Courier New',monospace;font-size:12px;color:#fff;margin-top:5px;}.notification-message{position:fixed;top:100px;left:50%;transform:translateX(-50%);z-index:1000;background:var(--glass-bg);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:15px;padding:15px 20px;max-width:90%;width:400px;text-align:center;box-shadow:0 5px 20px rgba(0,0,0,0.3);animation:fadeIn 0.3s ease;}.notification-success{border-color:#27ae60;background:rgba(39,174,96,0.1);}.notification-error{border-color:#e74c3c;background:rgba(231,76,60,0.1);}.notification-warning{border-color:#FFC107;background:rgba(255,193,7,0.1);}.notification-info{border-color:#3498db;background:rgba(52,152,219,0.1);}.deposit-processing{animation:processingPulse 1s infinite alternate;}@keyframes processingPulse{from{opacity:0.7;}to{opacity:1;}}@keyframes fadeOut{from{opacity:1;}to{opacity:0;}}.status-card[style*="grid-column:span 2"]{grid-column:span 2!important;min-height:120px;display:flex;flex-direction:column;justify-content:center;align-items:center;}.status-card[style*="grid-column:span 2"] .status-value{font-size:32px!important;margin-bottom:10px;font-weight:900!important;color:var(--primary-green)!important;}.status-card[style*="grid-column:span 2"] .status-label{font-size:12px;letter-spacing:1px;text-transform:uppercase;font-weight:700;}@keyframes shake{0%,100%{transform:translateX(0);}10%,30%,50%,70%,90%{transform:translateX(-5px);}20%,40%,60%,80%{transform:translateX(5px);}}.shake-animation{animation:shake 0.8s ease-in-out;}#global-loading-page{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#1a1a1a,#0a0a0a);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999999;text-align:center;padding:20px;}.loading-logo{width:120px;height:120px;border-radius:50%;margin-bottom:25px;border:4px solid var(--primary-green);animation:float 2s ease-in-out infinite;}.loading-title{font-size:32px;font-weight:800;color:#fff;margin-bottom:10px;text-transform:uppercase;letter-spacing:2px;background:linear-gradient(90deg,#a855f7,#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}.loading-subtitle{font-size:14px;color:var(--text-muted);margin-bottom:30px;max-width:300px;line-height:1.5;}.loading-progress-container{width:80%;max-width:300px;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;margin:20px 0;}.loading-progress-bar{height:100%;background:linear-gradient(90deg,var(--primary-green),#7c3aed);border-radius:3px;width:0%;transition:width 0.3s ease;}.loading-timer{font-size:12px;color:var(--text-muted);margin-top:10px;font-family:'Courier New',monospace;}.btn-blocked{background:rgba(231,76,60,0.2)!important;border:1px solid rgba(231,76,60,0.5)!important;color:#e74c3c!important;cursor:not-allowed!important;opacity:0.7!important;}@media (max-width:480px){.loading-logo{width:100px;height:100px;}.loading-title{font-size:24px;}.loading-subtitle{font-size:12px;}}.btn-processing{background:rgba(128,128,128,0.3)!important;border-color:rgba(128,128,128,0.5)!important;color:#888!important;cursor:not-allowed!important;opacity:0.7!important;}.task-btn-disabled{pointer-events:none!important;opacity:0.5!important;filter:grayscale(1)!important;}.coin-flip-btn-processing{background:linear-gradient(90deg,#666,#888)!important;color:#ccc!important;cursor:wait!important;}.coin-flip-btn-processing:hover{transform:none!important;}.coin-flip-result-details{font-size:12px;margin-top:5px;opacity:0.8;}.net-profit{color:#27ae60;font-weight:bold;}.net-loss{color:#e74c3c;font-weight:bold;}.withdraw-disabled{background:rgba(128,128,128,0.3)!important;border-color:rgba(128,128,128,0.5)!important;color:#aaa!important;cursor:not-allowed!important;opacity:0.7!important;}.daily-limit-reached{position:relative;}.daily-limit-reached::after{content:"2/2 Daily Limit";position:absolute;top:-8px;right:-8px;background:#e74c3c;color:white;font-size:9px;padding:2px 6px;border-radius:10px;font-weight:bold;z-index:1;}.withdrawals-counter{background:rgba(168,85,247,0.2);border-radius:8px;padding:8px 12px;margin-bottom:15px;text-align:center;font-size:12px;border:1px solid rgba(168,85,247,0.3);}.withdrawals-counter .count{font-weight:bold;color:var(--primary-green);font-size:14px;}.withdrawals-counter .limit-reached{color:#e74c3c;font-weight:bold;}.withdrawals-counter .reset-time{color:#FFC107;margin-top:5px;font-size:10px;}.security-status-icon{position:fixed;top:15px;right:70px;background:rgba(255,255,255,0.1);border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;z-index:1000;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);transition:all 0.3s ease;}.security-status-icon:hover{background:rgba(255,255,255,0.2);transform:scale(1.1);}.security-status-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1);}.security-label{font-weight:bold;color:#fff;}.security-value{font-weight:bold;padding:4px 8px;border-radius:4px;font-size:12px;}.security-value.valid{background:rgba(76,175,80,0.2);color:#4CAF50;}.security-value.invalid{background:rgba(244,67,54,0.2);color:#F44336;}.security-value.checking{background:rgba(255,193,7,0.2);color:#FFC107;}.security-info{margin-top:15px;padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;font-size:12px;color:rgba(255,255,255,0.7);}.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:9999;backdrop-filter:blur(5px);}.modal-content{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);border-radius:15px;padding:20px;border:1px solid rgba(255,255,255,0.1);box-shadow:0 10px 30px rgba(0,0,0,0.5);}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.1);}.modal-header h3{margin:0;color:#fff;}.close-modal{font-size:24px;cursor:pointer;color:rgba(255,255,255,0.7);transition:color 0.3s ease;}.close-modal:hover{color:#fff;}.modal-body{margin-bottom:20px;}.modal-footer{display:flex;justify-content:flex-end;gap:10px;}
</style>
<script>
// ==================== ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑÿ¢ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿ≥ŸÜ ====================

class SecureAdSystem {
    constructor() {
        this.apiUrl = 'https://silent-block-bedf.ahmedrabieharoun.workers.dev';
        this.securityToken = null;
        this.hardwareFingerprint = null;
        this.sessionSecret = null;
        this.requestQueue = [];
        this.isProcessing = false;
        this.adClickDelay = 3000;
        this.lastAdClickTime = 0;
    }
    
    async initialize() {
        try {
            console.log('üõ°Ô∏è ÿ®ÿØÿ° ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑÿ¢ŸÖŸÜ...');
            
            if (!this.checkCryptoSupport()) {
                throw new Error('Web Crypto API ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ™ÿµŸÅÿ≠');
            }
            
            this.hardwareFingerprint = await this.generateAdvancedHardwareFingerprint();
            console.log('ÿ™ŸÖ ÿ™ŸàŸÑŸäÿØ ÿ®ÿµŸÖÿ© ÿßŸÑÿ¨Ÿáÿßÿ≤');
            
            await this.initializeSecuritySettings();
            
            this.startActivityMonitoring();
            
            console.log('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑÿ¢ŸÖŸÜ ÿ®ŸÜÿ¨ÿßÿ≠');
            return true;
            
        } catch (error) {
            console.error('ŸÅÿ¥ŸÑ ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑÿ¢ŸÖŸÜ:', error);
            return false;
        }
    }
    
    async watchAd(adType) {
        const requestId = `ad_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        try {
            if (!await this.preFlightChecks()) {
                throw new Error('ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ£ŸàŸÑŸä');
            }
            
            if (!this.canClickAd()) {
                throw new Error('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± 3 ÿ´ŸàÿßŸÜŸä ÿ®ŸäŸÜ ÿßŸÑŸÜŸÇÿ±ÿßÿ™');
            }
            
            this.lastAdClickTime = Date.now();
            
            const requestData = await this.prepareAdRequest(adType, requestId);
            
            const initialResponse = await this.sendInitialRequest(requestData);
            
            if (initialResponse.requiresAdvancedChallenge) {
                const solutions = await this.solveChallenges(initialResponse.challenges);
                
                const finalResponse = await this.sendFinalRequest(
                    requestData, 
                    solutions, 
                    initialResponse.securityToken
                );
                
                return this.handleFinalResponse(finalResponse, adType);
            }
            
            return this.handleFinalResponse(initialResponse, adType);
            
        } catch (error) {
            console.error(`ŸÅÿ¥ŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿ•ÿπŸÑÿßŸÜ ${requestId}:`, error);
            return this.handleError(error, adType);
        }
    }
    
    async generateAdvancedHardwareFingerprint() {
        try {
            const components = [];
            
            components.push(navigator.userAgent);
            components.push(navigator.platform);
            components.push(navigator.language);
            components.push(navigator.hardwareConcurrency || 'unknown');
            components.push(screen.width + 'x' + screen.height + 'x' + screen.colorDepth);
            
            const webglFP = await this.getWebGLFingerprint();
            components.push(webglFP);
            
            const canvasFP = this.getCanvasFingerprint();
            components.push(canvasFP);
            
            const audioFP = await this.getAudioFingerprint();
            components.push(audioFP);
            
            components.push(performance.now().toString());
            components.push(Date.now().toString());
            
            const combined = components.join(':::');
            const encoder = new TextEncoder();
            const data = encoder.encode(combined);
            
            let hashBuffer = await crypto.subtle.digest('SHA-512', data);
            
            const secondRound = await crypto.subtle.digest('SHA-256', hashBuffer);
            
            const hashArray = Array.from(new Uint8Array(secondRound));
            let hexString = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            const dynamicPart = Math.random().toString(36).substring(2, 10);
            const timestampPart = Date.now().toString(36);
            const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || '0';
            const userPart = (parseInt(userId) % 1000).toString(36);
            
            const finalFingerprint = `${hexString}-${dynamicPart}-${timestampPart}-${userPart}`;
            
            localStorage.setItem('secure_hardware_fp', finalFingerprint);
            
            return finalFingerprint;
            
        } catch (error) {
            console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿ®ÿµŸÖÿ© ÿßŸÑÿ¨Ÿáÿßÿ≤:', error);
            return this.generateFallbackFingerprint();
        }
    }
    
    async getWebGLFingerprint() {
        try {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            
            if (!gl) return 'no_webgl';
            
            const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
            const vendor = debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : 'unknown';
            const renderer = debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'unknown';
            
            const shaderPrecision = gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER, gl.HIGH_FLOAT);
            const maxTextureSize = gl.getParameter(gl.MAX_TEXTURE_SIZE);
            
            const fingerprintData = {
                vendor: vendor,
                renderer: renderer,
                precision: shaderPrecision ? `${shaderPrecision.precision} bits` : 'unknown',
                maxTextureSize: maxTextureSize,
                extensions: gl.getSupportedExtensions().length
            };
            
            const encoder = new TextEncoder();
            const data = encoder.encode(JSON.stringify(fingerprintData));
            const hash = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hash));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
        } catch (error) {
            return 'webgl_error';
        }
    }
    
    getCanvasFingerprint() {
        try {
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 50;
            const ctx = canvas.getContext('2d');
            
            if (!ctx) return 'no_canvas';
            
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillStyle = '#f00';
            ctx.fillRect(0, 0, 200, 50);
            
            ctx.fillStyle = '#000';
            ctx.fillText('SECURITY_FINGERPRINT', 2, 2);
            
            ctx.fillStyle = '#fff';
            ctx.fillText('SECURITY_FINGERPRINT', 4, 4);
            
            const gradient = ctx.createLinearGradient(0, 0, 200, 0);
            gradient.addColorStop(0, '#00f');
            gradient.addColorStop(1, '#f00');
            ctx.fillStyle = gradient;
            ctx.fillText('SECURITY_FINGERPRINT', 3, 20);
            
            const dataUrl = canvas.toDataURL();
            
            let hash = 0;
            for (let i = 0; i < dataUrl.length; i++) {
                const char = dataUrl.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            return hash.toString(36);
            
        } catch (error) {
            return 'canvas_error';
        }
    }
    
    async getAudioFingerprint() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            const analyser = audioContext.createAnalyser();
            
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.connect(gainNode);
            gainNode.connect(analyser);
            analyser.connect(audioContext.destination);
            
            analyser.fftSize = 2048;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1);
            
            await new Promise(resolve => setTimeout(resolve, 50));
            
            analyser.getByteFrequencyData(dataArray);
            audioContext.close();
            
            const encoder = new TextEncoder();
            const data = encoder.encode(dataArray.join(','));
            const hash = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hash));
            
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
        } catch (error) {
            return 'audio_error';
        }
    }
    
    generateFallbackFingerprint() {
        const components = [];
        
        for (let i = 0; i < 10; i++) {
            const randomPart = Math.random().toString(36).substring(2, 10);
            const timePart = (Date.now() + i).toString(36);
            const mathPart = Math.sin(i * Math.PI).toString(36).substring(2, 6);
            components.push(`${randomPart}-${timePart}-${mathPart}`);
        }
        
        return `fallback-${components.join('-')}-${navigator.userAgent.length}`;
    }
    
    async preFlightChecks() {
        if (!navigator.onLine) {
            throw new Error('ŸÑÿß ŸäŸàÿ¨ÿØ ÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™');
        }
        
        if (typeof window === 'undefined') {
            throw new Error('JavaScript ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ');
        }
        
        if (!window.Telegram?.WebApp) {
            throw new Error('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ Telegram WebApp');
        }
        
        if (!this.hardwareFingerprint) {
            throw new Error('ÿ®ÿµŸÖÿ© ÿßŸÑÿ¨Ÿáÿßÿ≤ ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ÿ©');
        }
        
        if (this.isDevToolsOpen()) {
            console.warn('ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± - ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿ®ÿ≠ÿ∞ÿ±');
        }
        
        const processorSpeed = await this.checkProcessorSpeed();
        if (processorSpeed.tooFast) {
            throw new Error('ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ≥ÿ±ÿπÿ© ŸÖÿπÿßŸÑÿ¨ ÿ∫Ÿäÿ± ÿ∑ÿ®ŸäÿπŸäÿ©');
        }
        
        console.log('ÿ™ŸÖ ÿßÿ¨ÿ™Ÿäÿßÿ≤ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ£ŸàŸÑŸä');
        return true;
    }
    
    isDevToolsOpen() {
        const widthThreshold = window.outerWidth - window.innerWidth > 160;
        const heightThreshold = window.outerHeight - window.innerHeight > 160;
        
        return widthThreshold || heightThreshold;
    }
    
    async checkProcessorSpeed() {
        const start = performance.now();
        
        let sum = 0;
        for (let i = 0; i < 1000000; i++) {
            sum += Math.sqrt(i) * Math.sin(i);
        }
        
        const end = performance.now();
        const duration = end - start;
        
        return {
            duration: duration,
            tooFast: duration < 10,
            normalRange: duration >= 10 && duration < 1000
        };
    }
    
    canClickAd() {
        const now = Date.now();
        return (now - this.lastAdClickTime) >= this.adClickDelay;
    }
    
    async prepareAdRequest(adType, requestId) {
        const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
        const telegramData = window.Telegram?.WebApp?.initData || '';
        
        let adNumber = 1;
        const adCountField = `ads${this.capitalizeFirstLetter(adType)}`;
        if (window.appData && window.appData[adCountField]) {
            adNumber = window.appData[adCountField] + 1;
        }
        
        const clientNonce = await this.generateSecureNonce();
        
        return {
            requestId: requestId,
            userId: userId,
            telegramData: telegramData,
            adType: adType,
            reward: 500,
            adNumber: adNumber,
            clientTimestamp: Date.now(),
            clientNonce: clientNonce,
            hardwareFingerprint: this.hardwareFingerprint,
            userAgent: navigator.userAgent,
            screenInfo: `${screen.width}x${screen.height}`,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            language: navigator.language,
            platform: navigator.platform,
            referrer: document.referrer || 'direct',
            sessionId: localStorage.getItem('sessionId') || this.generateSessionId()
        };
    }
    
    async generateSecureNonce() {
        const timestamp = Date.now();
        const random1 = Math.random().toString(36).substring(2, 15);
        const random2 = Math.random().toString(36).substring(2, 15);
        const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || '0';
        
        const baseString = `${timestamp}:${random1}:${random2}:${userId}:${this.hardwareFingerprint}`;
        
        const encoder = new TextEncoder();
        const data = encoder.encode(baseString);
        
        try {
            const hash = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hash));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        } catch (error) {
            return `${timestamp}_${random1}_${random2}`;
        }
    }
    
    generateSessionId() {
        const sessionId = `sess_${Date.now()}_${Math.random().toString(36).substr(2, 16)}`;
        localStorage.setItem('sessionId', sessionId);
        return sessionId;
    }
    
    async sendInitialRequest(requestData) {
        console.log('ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿßŸÑÿ£ŸàŸÑŸä:', {
            requestId: requestData.requestId,
            adType: requestData.adType,
            timestamp: requestData.clientTimestamp
        });
        
        const headers = {
            'Content-Type': 'application/json',
            'X-Request-ID': requestData.requestId,
            'X-User-ID': requestData.userId,
            'X-Telegram-Data': requestData.telegramData,
            'X-Client-Timestamp': requestData.clientTimestamp.toString(),
            'X-Hardware-Fingerprint': requestData.hardwareFingerprint,
            'X-Client-Nonce': requestData.clientNonce,
            'X-Security-Level': 'maximum'
        };
        
        const payload = {
            action: 'handleAdClickSecure',
            data: {
                ...requestData,
                clientNonce: requestData.clientNonce
            }
        };
        
        const response = await fetch(this.apiUrl, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload),
            credentials: 'omit',
            mode: 'cors'
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        
        if (result.data?.securityToken) {
            this.securityToken = result.data.securityToken;
            localStorage.setItem('securityToken', this.securityToken);
        }
        
        return result;
    }
    
    async solveChallenges(challenges) {
        console.log('ÿ≠ŸÑ ÿ™ÿ≠ÿØŸäÿßÿ™ ÿßŸÑÿ£ŸÖÿßŸÜ:', challenges);
        
        const solutions = {
            crypto: null,
            math: null,
            pattern: null
        };
        
        if (challenges.crypto) {
            solutions.crypto = await this.solveCryptoChallenge(challenges.crypto);
        }
        
        if (challenges.math) {
            solutions.math = this.solveMathChallenge(challenges.math);
        }
        
        if (challenges.pattern) {
            solutions.pattern = this.solvePatternChallenge(challenges.pattern);
        }
        
        console.log('ÿ≠ŸÑŸàŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™:', solutions);
        return solutions;
    }
    
    async solveCryptoChallenge(challenge) {
        try {
            const { data, salt, operation } = challenge;
            
            if (operation === 'sha256') {
                const encoder = new TextEncoder();
                const input = data + salt;
                const dataBuffer = encoder.encode(input);
                
                const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }
            
            throw new Error(`ÿπŸÖŸÑŸäÿ© ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖÿ©: ${operation}`);
        } catch (error) {
            console.error('ŸÅÿ¥ŸÑ ÿ≠ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±Ÿä:', error);
            return 'error';
        }
    }
    
    solveMathChallenge(challenge) {
        try {
            const { problem } = challenge;
            
            const parts = problem.split(' ');
            if (parts.length !== 3) {
                throw new Error('ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸÖÿ≥ÿ£ŸÑÿ© ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿ© ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠');
            }
            
            const a = parseInt(parts[0]);
            const operator = parts[1];
            const b = parseInt(parts[2]);
            
            let result;
            switch (operator) {
                case '+': result = a + b; break;
                case '-': result = a - b; break;
                case '*': result = a * b; break;
                case '/': result = a / b; break;
                default: throw new Error(`ÿπÿßŸÖŸÑ ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ: ${operator}`);
            }
            
            return result.toString();
        } catch (error) {
            console.error('ŸÅÿ¥ŸÑ ÿ≠ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑÿ±Ÿäÿßÿ∂Ÿä:', error);
            return '0';
        }
    }
    
    solvePatternChallenge(challenge) {
        try {
            const { sequence } = challenge;
            
            if (!Array.isArray(sequence) || sequence.length < 2) {
                throw new Error('ÿ™ÿ≥ŸÑÿ≥ŸÑ ÿßŸÑŸÜŸÖÿ∑ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠');
            }
            
            const diffs = [];
            for (let i = 1; i < sequence.length; i++) {
                diffs.push(sequence[i] - sequence[i - 1]);
            }
            
            const isConstantDiff = diffs.every(diff => diff === diffs[0]);
            if (isConstantDiff) {
                return (sequence[sequence.length - 1] + diffs[0]).toString();
            }
            
            const ratios = [];
            for (let i = 1; i < sequence.length; i++) {
                if (sequence[i - 1] !== 0) {
                    ratios.push(sequence[i] / sequence[i - 1]);
                }
            }
            
            const isConstantRatio = ratios.length > 0 && 
                ratios.every(ratio => Math.abs(ratio - ratios[0]) < 0.001);
            
            if (isConstantRatio) {
                return (sequence[sequence.length - 1] * ratios[0]).toString();
            }
            
            if (sequence.length >= 3) {
                let isFibonacci = true;
                for (let i = 2; i < sequence.length; i++) {
                    if (sequence[i] !== sequence[i - 1] + sequence[i - 2]) {
                        isFibonacci = false;
                        break;
                    }
                }
                
                if (isFibonacci) {
                    const next = sequence[sequence.length - 1] + sequence[sequence.length - 2];
                    return next.toString();
                }
            }
            
            console.warn('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑŸÜŸÖÿ∑ÿå ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÇŸäŸÖÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©');
            return (sequence[sequence.length - 1] + 1).toString();
            
        } catch (error) {
            console.error('ŸÅÿ¥ŸÑ ÿ≠ŸÑ ÿ™ÿ≠ÿØŸâ ÿßŸÑÿ£ŸÜŸÖÿßÿ∑:', error);
            return '0';
        }
    }
    
    async sendFinalRequest(originalData, solutions, securityToken) {
        console.log('ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸÖÿπ ÿßŸÑÿ≠ŸÑŸàŸÑ');
        
        const finalData = {
            ...originalData,
            challengeSolutions: solutions,
            originalData: originalData,
            securityToken: securityToken,
            finalTimestamp: Date.now(),
            requestHash: await this.calculateRequestHash(originalData, solutions)
        };
        
        const headers = {
            'Content-Type': 'application/json',
            'X-Request-ID': originalData.requestId,
            'X-User-ID': originalData.userId,
            'X-Security-Token': securityToken,
            'X-Final-Request': 'true',
            'X-Client-Timestamp': Date.now().toString()
        };
        
        const payload = {
            action: 'handleAdClickSecure',
            data: finalData
        };
        
        const response = await fetch(this.apiUrl, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        return await response.json();
    }
    
    async calculateRequestHash(data, solutions) {
        try {
            const combined = JSON.stringify({ data, solutions, timestamp: Date.now() });
            const encoder = new TextEncoder();
            const buffer = encoder.encode(combined);
            
            const hash = await crypto.subtle.digest('SHA-512', buffer);
            const hashArray = Array.from(new Uint8Array(hash));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        } catch (error) {
            return 'hash_error';
        }
    }
    
    handleFinalResponse(response, adType) {
        if (!response.success) {
            throw new Error(response.error || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ');
        }
        
        if (window.appData && response.data) {
            const adCountField = `ads${this.capitalizeFirstLetter(adType)}`;
            
            window.appData[adCountField] = response.data[adCountField] || 
                (window.appData[adCountField] || 0) + 1;
            
            window.appData.adsWatched = response.data.adsWatched || 
                (window.appData.adsWatched || 0) + 1;
            
            window.appData.dogsBalance = response.data.newBalance || 
                (window.appData.dogsBalance || 0) + 500;
            
            if (typeof renderUI === 'function') {
                renderUI({ id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id });
            }
        }
        
        this.logSecurityEvent('AD_COMPLETED_SECURE', {
            adType: adType,
            reward: 500,
            success: true,
            securityLevel: response.data?.security?.level || 'unknown',
            timestamp: Date.now()
        });
        
        return {
            success: true,
            data: response.data,
            message: '‚úÖ ÿ™ŸÖ ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿ®ŸÜÿ¨ÿßÿ≠ ŸÖÿπ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ£ŸÇÿµŸâ ŸÑŸÑÿ£ŸÖÿßŸÜ'
        };
    }
    
    handleError(error, adType) {
        const errorData = {
            type: 'AD_REQUEST_ERROR',
            adType: adType,
            error: error.message,
            timestamp: Date.now(),
            hardwareFingerprint: this.hardwareFingerprint,
            userAgent: navigator.userAgent
        };
        
        this.logSecurityEvent('AD_ERROR', errorData);
        
        let userMessage = 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ';
        
        if (error.message.includes('SECURITY') || error.message.includes('BLOCKED')) {
            userMessage = 'ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ£ŸÖŸÜŸä. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸàÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.';
        } else if (error.message.includes('CHALLENGE')) {
            userMessage = 'ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑÿ£ŸÖŸÜŸä. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.';
        } else if (error.message.includes('TIMEOUT')) {
            userMessage = 'ÿßŸÜÿ™Ÿáÿ™ ŸÖŸáŸÑÿ© ÿßŸÑÿ∑ŸÑÿ®. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑŸÉ.';
        } else if (error.message.includes('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±')) {
            userMessage = error.message;
        }
        
        if (typeof showNotification === 'function') {
            showNotification(userMessage, 'error');
        }
        
        return {
            success: false,
            error: error.message,
            userMessage: userMessage,
            data: errorData
        };
    }
    
    startActivityMonitoring() {
        window.addEventListener('resize', () => {
            if (this.isDevToolsOpen()) {
                this.logSecurityEvent('DEVTOOLS_DETECTED', {
                    widthDiff: window.outerWidth - window.innerWidth,
                    heightDiff: window.outerHeight - window.innerHeight,
                    timestamp: Date.now()
                });
            }
        });
        
        window.addEventListener('blur', () => {
            this.logSecurityEvent('WINDOW_BLUR', {
                timestamp: Date.now(),
                activeElement: document.activeElement?.tagName
            });
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                this.logSecurityEvent('DEVTOOLS_SHORTCUT', {
                    key: e.key,
                    timestamp: Date.now()
                });
            }
        });
    }
    
    logSecurityEvent(type, data) {
        const event = {
            type: type,
            ...data,
            timestamp: Date.now(),
            sessionId: localStorage.getItem('sessionId'),
            userId: window.Telegram?.WebApp?.initDataUnsafe?.user?.id
        };
        
        const securityLog = JSON.parse(localStorage.getItem('securityLog') || '[]');
        securityLog.push(event);
        localStorage.setItem('securityLog', JSON.stringify(securityLog.slice(-100)));
        
        this.sendSecurityLogToServer(event).catch(console.error);
        
        console.log(`ÿ≠ÿØÿ´ ÿßŸÑÿ£ŸÖÿßŸÜ: ${type}`, event);
    }
    
    async sendSecurityLogToServer(event) {
        try {
            await fetch(`${this.apiUrl}/security-log`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(event),
                keepalive: true
            });
        } catch (error) {
        }
    }
    
    checkCryptoSupport() {
        return !!crypto.subtle && 
               typeof crypto.subtle.digest === 'function' &&
               typeof crypto.getRandomValues === 'function';
    }
    
    capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    async initializeSecuritySettings() {
        try {
            const response = await fetch(`${this.apiUrl}/security-settings`);
            if (response.ok) {
                const settings = await response.json();
                localStorage.setItem('securitySettings', JSON.stringify(settings));
            }
        } catch (error) {
            console.warn('ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ŸÖÿßŸÜ:', error);
        }
    }
}

// ==================== ÿßŸÑÿ™ŸÉÿßŸÖŸÑ ŸÖÿπ ŸÖÿπÿßŸÑÿ¨ÿßÿ™ ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿßŸÑÿ≠ÿßŸÑŸäÿ© ====================

window.SecureAdSystem = new SecureAdSystem();

async function handleMonetagAdSecure() {
    if (!window.SecureAdSystem) {
        console.error('SecureAdSystem ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
        return;
    }
    
    if (!window.SecureAdSystem.canClickAd()) {
        showNotification("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± 3 ÿ´ŸàÿßŸÜŸä ÿ®ŸäŸÜ ÿßŸÑŸÜŸÇÿ±ÿßÿ™", "warning");
        return;
    }
    
    const result = await window.SecureAdSystem.watchAd('monetag');
    
    if (result.success) {
        showNotification(`‚úÖ +500 GLX ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ£ŸÖŸÜŸä!`, "success");
        
        if (typeof show_10058786 === 'function') {
            try {
                await show_10058786({ ymid: window.Telegram?.WebApp?.initDataUnsafe?.user?.id });
            } catch (adError) {
                console.warn('ÿÆÿ∑ÿ£ ÿ¥ÿ®ŸÉÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ:', adError);
            }
        }
    } else {
        showNotification(result.userMessage || "ŸÅÿ¥ŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜ", "error");
    }
}

async function handleGigaAdSecure() {
    if (!window.SecureAdSystem) {
        console.error('SecureAdSystem ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
        return;
    }
    
    if (!window.SecureAdSystem.canClickAd()) {
        showNotification("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± 3 ÿ´ŸàÿßŸÜŸä ÿ®ŸäŸÜ ÿßŸÑŸÜŸÇÿ±ÿßÿ™", "warning");
        return;
    }
    
    const result = await window.SecureAdSystem.watchAd('giga');
    
    if (result.success) {
        showNotification(`‚úÖ +500 GLX ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ£ŸÖŸÜŸä!`, "success");
        
        if (typeof window.showGiga === 'function') {
            try {
                await window.showGiga();
            } catch (adError) {
                console.warn('ÿÆÿ∑ÿ£ ÿ•ÿπŸÑÿßŸÜ Giga:', adError);
            }
        }
    } else {
        showNotification(result.userMessage || "ŸÅÿ¥ŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜ", "error");
    }
}

async function handleAdsgramAdSecure() {
    if (!window.SecureAdSystem) {
        console.error('SecureAdSystem ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
        return;
    }
    
    if (!window.SecureAdSystem.canClickAd()) {
        showNotification("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± 3 ÿ´ŸàÿßŸÜŸä ÿ®ŸäŸÜ ÿßŸÑŸÜŸÇÿ±ÿßÿ™", "warning");
        return;
    }
    
    const result = await window.SecureAdSystem.watchAd('adsgram');
    
    if (result.success) {
        showNotification(`‚úÖ +500 GLX ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ£ŸÖŸÜŸä!`, "success");
        
        if (window.AdController && typeof window.AdController.show === 'function') {
            try {
                await window.AdController.show();
            } catch (adError) {
                console.warn('ÿÆÿ∑ÿ£ Adsgram:', adError);
            }
        }
    } else {
        showNotification(result.userMessage || "ŸÅÿ¥ŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜ", "error");
    }
}

// ==================== ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ====================

document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ ÿ®ÿØÿ° ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑÿ¢ŸÖŸÜ...');
    
    setTimeout(async () => {
        try {
            const initialized = await window.SecureAdSystem.initialize();
            
            if (initialized) {
                console.log('‚úÖ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑÿ¢ŸÖŸÜ ÿ¨ÿßŸáÿ≤');
                
                const monetagBtn = document.getElementById('monetag-ad-task');
                const gigaBtn = document.getElementById('gigapub-ad-task');
                const adsgramBtn = document.getElementById('adsgram-ad-task');
                
                if (monetagBtn) {
                    monetagBtn.replaceWith(monetagBtn.cloneNode(true));
                    document.getElementById('monetag-ad-task').addEventListener('click', handleMonetagAdSecure);
                }
                
                if (gigaBtn) {
                    gigaBtn.replaceWith(gigaBtn.cloneNode(true));
                    document.getElementById('gigapub-ad-task').addEventListener('click', handleGigaAdSecure);
                }
                
                if (adsgramBtn) {
                    adsgramBtn.replaceWith(adsgramBtn.cloneNode(true));
                    document.getElementById('adsgram-ad-task').addEventListener('click', handleAdsgramAdSecure);
                }
                
                addSecurityIndicator();
            }
        } catch (error) {
            console.error('ŸÅÿ¥ŸÑ ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑÿ¢ŸÖŸÜ:', error);
            showNotification("ŸÅÿ¥ŸÑ ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ£ŸÖŸÜŸä. ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä.", "warning");
        }
    }, 1000);
});

function addSecurityIndicator() {
    const securityBadge = document.createElement('div');
    securityBadge.id = 'security-badge';
    securityBadge.innerHTML = `
        <div style="
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #00c853;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        ">
            <span>üõ°Ô∏è</span>
            <span>ÿßŸÑÿ£ŸÖÿßŸÜ ÿßŸÑÿ£ŸÇÿµŸâ</span>
        </div>
    `;
    
    document.body.appendChild(securityBadge);
}

Object.freeze(window.SecureAdSystem);
Object.seal(window.SecureAdSystem);

// ==================== ÿ®ŸÇŸäÿ© ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ£ÿµŸÑŸä ====================

function getDeviceId(){
    let deviceId=localStorage.getItem("device_id");
    if(!deviceId){
        deviceId=crypto.randomUUID();
        localStorage.setItem("device_id",deviceId);
    }
    return deviceId;
}

const API_URL="https://silent-block-bedf.ahmedrabieharoun.workers.dev";
const isCryptoSupported=typeof crypto!=='undefined'&&crypto.subtle;
let sessionSecret=null;
let sessionSecretPromise=null;
let SecuritySystem=null;

async function generateSessionSecret(){
    if(!isCryptoSupported){
        console.error("Web Crypto API not supported");
        return null;
    }
    try{
        const timestamp=Date.now().toString();
        const randomBytes=new Uint8Array(32);
        crypto.getRandomValues(randomBytes);
        const combined=timestamp+Array.from(randomBytes).map(b=>b.toString(16).padStart(2,'0')).join('');
        const encoder=new TextEncoder();
        const data=encoder.encode(combined);
        const hashBuffer=await crypto.subtle.digest('SHA-256',data);
        const hashArray=Array.from(new Uint8Array(hashBuffer));
        const hashHex=hashArray.map(b=>b.toString(16).padStart(2,'0')).join('');
        sessionSecret=hashHex.substring(0,64);
        console.log("‚úÖ Session secret generated");
        return sessionSecret;
    }catch(error){
        console.error("Error generating session secret:",error);
        return null;
    }
}

async function generateAdToken(userId,deviceFingerprint,adNumber,clientTimestamp){
    if(!isCryptoSupported||!sessionSecret){
        console.error("Security prerequisites not met");
        return null;
    }
    try{
        const dataToSign={
            userId:userId,
            deviceFingerprint:deviceFingerprint,
            adNumber:adNumber,
            clientTimestamp:clientTimestamp,
            sessionSecret:sessionSecret,
            action:'handleAdClick'
        };
        const dataString=JSON.stringify(dataToSign);
        const encoder=new TextEncoder();
        const data=encoder.encode(dataString);
        const keyMaterial=await crypto.subtle.importKey('raw',encoder.encode(sessionSecret),{name:'HMAC',hash:'SHA-256'},false,['sign']);
        const signature=await crypto.subtle.sign('HMAC',keyMaterial,data);
        const signatureArray=Array.from(new Uint8Array(signature));
        const signatureHex=signatureArray.map(b=>b.toString(16).padStart(2,'0')).join('');
        return signatureHex;
    }catch(error){
        console.error("Error generating ad token:",error);
        return null;
    }
}

async function sendSecureAdRequest(adType,reward){
    const userId=window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    if(!userId){
        console.error("No user ID found");
        showNotification("Please log in first.","error");
        return{success:false,error:'USER_NOT_FOUND'};
    }
    let deviceFingerprint=await getOrGenerateDeviceFingerprint();
    if(!deviceFingerprint){
        console.error("Device fingerprint required");
        showNotification("Security error: Device verification failed.","error");
        return{success:false,error:'DEVICE_FINGERPRINT_REQUIRED'};
    }
    const clientTimestamp=Date.now();
    if(!sessionSecretPromise){
        sessionSecretPromise=generateSessionSecret();
    }
    await sessionSecretPromise;
    if(!sessionSecret||!isCryptoSupported){
        console.error("Missing required values for ad request");
        showNotification("Security error. Please refresh the page.","error");
        return{success:false,error:'SECURITY_CHECK_FAILED'};
    }
    let adNumber=0;
    switch(adType){
        case'monetag':adNumber=(appData.adsMonetag||0)+1;break;
        case'giga':adNumber=(appData.adsGiga||0)+1;break;
        case'adsgram':adNumber=(appData.adsAdsgram||0)+1;break;
        default:adNumber=Date.now();
    }
    const adToken=await generateAdToken(userId.toString(),deviceFingerprint,adNumber,clientTimestamp);
    if(!adToken){
        showNotification("Security error. Please try again.","error");
        return{success:false,error:'TOKEN_GENERATION_FAILED'};
    }
    const requestData={
        action:'handleAdClick',
        data:{
            adType:adType,
            reward:reward,
            deviceFingerprint:deviceFingerprint,
            adNumber:adNumber,
            clientTimestamp:clientTimestamp
        }
    };
    try{
        const response=await fetch(`${API_URL}/api`,{
            method:'POST',
            headers:{
                'Content-Type':'application/json',
                'X-Action':'handleAdClick',
                'X-User-ID':userId.toString(),
                'X-Telegram-Data':window.Telegram?.WebApp?.initData||'',
                'X-Device-Fingerprint':deviceFingerprint,
                'X-Ad-Token':adToken,
                'X-Client-Timestamp':clientTimestamp.toString(),
                'X-Ad-Number':adNumber.toString(),
                'X-Session-Key':sessionSecret
            },
            body:JSON.stringify(requestData)
        });
        if(!response.ok){
            throw new Error(`API Error: ${response.status}`);
        }
        const result=await response.json();
        return result;
    }catch(error){
        console.error("Secure ad request failed:",error);
        return{success:false,error:error.message};
    }
}

async function getOrGenerateDeviceFingerprint(){
    if(window.localStorage){
        const storedFingerprint=localStorage.getItem('deviceFingerprint');
        if(storedFingerprint){
            return storedFingerprint;
        }
    }
    return await generateDeviceFingerprint();
}

async function generateDeviceFingerprint(){
    try{
        const userAgent=navigator.userAgent;
        const platform=navigator.platform;
        const language=navigator.language;
        const timezone=Intl.DateTimeFormat().resolvedOptions().timeZone;
        const screenInfo=`${screen.width}x${screen.height}x${screen.colorDepth}`;
        const hardwareConcurrency=navigator.hardwareConcurrency||'unknown';
        const deviceData={
            userAgent:userAgent,
            platform:platform,
            language:language,
            timezone:timezone,
            screenInfo:screenInfo,
            hardwareConcurrency:hardwareConcurrency,
            timestamp:Date.now(),
            random:Math.random().toString(36).substring(2)
        };
        const dataString=JSON.stringify(deviceData);
        const encoder=new TextEncoder();
        const data=encoder.encode(dataString);
        const hashBuffer=await crypto.subtle.digest('SHA-256',data);
        const hashArray=Array.from(new Uint8Array(hashBuffer));
        const hashHex=hashArray.map(b=>b.toString(16).padStart(2,'0')).join('');
        if(window.localStorage){
            localStorage.setItem('deviceFingerprint',hashHex);
        }
        return hashHex;
    }catch(error){
        console.error('Error generating device fingerprint:',error);
        return`fallback_fingerprint_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;
    }
}

function performInitialSecurityCheck(){
    if(!isCryptoSupported){
        return{success:false,error:'CRYPTO_NOT_SUPPORTED',message:'Web Crypto API is not supported in this browser'};
    }
    return{success:true,message:'Security checks passed'};
}

async function checkUserSecurityStatus(userId){
    try{
        const deviceFingerprint=await getOrGenerateDeviceFingerprint();
        const response=await callAPI('checkDeviceFingerprint',{deviceFingerprint:deviceFingerprint});
        return response;
    }catch(error){
        console.error('Security status check failed:',error);
        return{success:false,error:'SECURITY_CHECK_FAILED',message:error.message};
    }
}

function logSecurityEvent(eventType,details){
    const timestamp=new Date().toISOString();
    const event={
        type:eventType,
        timestamp:timestamp,
        userId:window.Telegram?.WebApp?.initDataUnsafe?.user?.id||'unknown',
        details:details
    };
    console.log(`üîí Security Event [${eventType}]:`,event);
}

function blockDirectAdRequests(){
    const originalCallAPI=window.callAPI;
    window.callAPI=async function(action,data={}){
        if(action==='handleAdClick'){
            console.error("Direct handleAdClick calls are blocked.");
            logSecurityEvent('BLOCKED_DIRECT_AD_REQUEST',{action:action,data:data});
            return{success:false,error:'DIRECT_AD_CALL_BLOCKED',message:'Use secure ad request system'};
        }
        return originalCallAPI.call(this,action,data);
    };
}

async function initializeSecuritySystem(){
    console.log("üõ°Ô∏è Initializing security system...");
    const securityCheck=performInitialSecurityCheck();
    if(!securityCheck.success){
        throw new Error(securityCheck.message);
    }
    sessionSecretPromise=generateSessionSecret();
    await sessionSecretPromise;
    blockDirectAdRequests();
    logSecurityEvent('SESSION_STARTED',{
        userAgent:navigator.userAgent,
        platform:navigator.platform,
        timestamp:new Date().toISOString()
    });
    console.log("‚úÖ Security system initialized successfully");
    return true;
}

function isSessionValid(){
    return sessionSecret!==null&&isCryptoSupported;
}

function getSecurityStatus(){
    return{
        isCryptoSupported:isCryptoSupported,
        sessionSecretReady:sessionSecret!==null,
        securityInitialized:isSessionValid(),
        deviceFingerprintReady:true
    };
}

SecuritySystem={
    initialize:initializeSecuritySystem,
    sendSecureAdRequest:sendSecureAdRequest,
    getSecurityStatus:getSecurityStatus,
    logSecurityEvent:logSecurityEvent,
    generateDeviceFingerprint:generateDeviceFingerprint,
    isSessionValid:isSessionValid,
    getOrGenerateDeviceFingerprint:getOrGenerateDeviceFingerprint
};

function showSecurityStatus(){
    const modal=document.getElementById('security-status-modal');
    if(modal){
        modal.style.display='flex';
        updateSecurityStatusDisplay();
    }
}

function closeSecurityStatus(){
    const modal=document.getElementById('security-status-modal');
    if(modal){
        modal.style.display='none';
    }
}

async function updateSecurityStatusDisplay(){
    const cryptoStatus=document.getElementById('crypto-status');
    if(cryptoStatus){
        cryptoStatus.textContent=isCryptoSupported?'Supported ‚úÖ':'Not Supported ‚ùå';
        cryptoStatus.className='security-value '+(isCryptoSupported?'valid':'invalid');
    }
    const sessionStatus=document.getElementById('session-status');
    if(sessionStatus){
        const isValid=SecuritySystem?SecuritySystem.isSessionValid():false;
        sessionStatus.textContent=isValid?'Active ‚úÖ':'Inactive ‚ùå';
        sessionStatus.className='security-value '+(isValid?'valid':'invalid');
    }
    const deviceStatus=document.getElementById('device-status');
    if(deviceStatus){
        try{
            const fingerprint=await getDeviceFingerprint();
            deviceStatus.textContent=fingerprint&&fingerprint!=='unknown'?'Verified ‚úÖ':'Not Verified ‚ùå';
            deviceStatus.className='security-value '+(fingerprint&&fingerprint!=='unknown'?'valid':'invalid');
        }catch(error){
            deviceStatus.textContent='Error ‚ùå';
            deviceStatus.className='security-value invalid';
        }
    }
    const adSecurityStatus=document.getElementById('ad-security-status');
    if(adSecurityStatus){
        const allGood=isCryptoSupported&&(SecuritySystem?SecuritySystem.isSessionValid():false);
        adSecurityStatus.textContent=allGood?'Secure ‚úÖ':'At Risk ‚ö†Ô∏è';
        adSecurityStatus.className='security-value '+(allGood?'valid':'invalid');
    }
}

function refreshSecurityStatus(){
    updateSecurityStatusDisplay();
    showNotification("Security status refreshed","info");
}
</script>
</head>
<body>
<div id="global-loading-page">
<img src="https://i.ibb.co/tTkJX1Qy/logo.png" alt="GLX Galaxy" class="loading-logo">
<h1 class="loading-title">GLX GALAXY</h1>
<p class="loading-subtitle">Loading your cosmic experience...</p>
<div class="loading-progress-container">
<div class="loading-progress-bar" id="loading-progress-bar"></div>
</div>
<div class="loading-timer" id="loading-timer">10 seconds</div>
<div style="margin-top:30px;font-size:11px;color:var(--text-muted);max-width:300px;">
<i class="fas fa-shield-alt" style="margin-right:5px;"></i>
Performing security checks & loading your data
</div>
</div>
<div id="security-verification" class="verification-container" style="display:none;">
<div style="margin-bottom:25px;"><img src="https://i.ibb.co/tTkJX1Qy/logo.png" alt="GLX Galaxy" style="width:80px;height:80px;border-radius:50%;margin-bottom:15px;border:3px solid var(--primary-green);"><h1 style="font-size:24px;margin-bottom:8px;color:#fff;">GLX Galaxy Security</h1><p style="color:var(--text-muted);font-size:13px;">Secure verification process in progress</p></div>
<div class="verification-progress"><div id="verification-progress-bar" class="progress-bar" style="width:0%"></div></div>
<div id="verification-steps"></div>
<div id="verification-result" style="display:none;margin-top:20px;"></div>
</div>
<div id="blocked-access" class="blocked-container" style="display:none;">
<div class="blocked-icon">üö´</div>
<div class="blocked-title">ACCESS BLOCKED</div>
<div id="blocked-reason" class="blocked-reason"></div>
<p style="color:var(--text-muted);font-size:12px;margin-top:20px;">If you believe this is an error, please contact support.</p>
</div>
<div id="security-status-modal" class="modal" style="display:none;">
<div class="modal-content" style="max-width:400px;">
<div class="modal-header">
<h3>üîí Security Status</h3>
<span class="close-modal" onclick="closeSecurityStatus()">&times;</span>
</div>
<div class="modal-body">
<div class="security-status-item">
<span class="security-label">Web Crypto API:</span>
<span id="crypto-status" class="security-value">Checking...</span>
</div>
<div class="security-status-item">
<span class="security-label">Session:</span>
<span id="session-status" class="security-value">Checking...</span>
</div>
<div class="security-status-item">
<span class="security-label">Device Fingerprint:</span>
<span id="device-status" class="security-value">Checking...</span>
</div>
<div class="security-status-item">
<span class="security-label">Ad Security:</span>
<span id="ad-security-status" class="security-value">Checking...</span>
</div>
<div class="security-info">
<p><small>All security features must be active for ad rewards.</small></p>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeSecurityStatus()">Close</button>
<button class="btn btn-primary" onclick="refreshSecurityStatus()">Refresh</button>
</div>
</div>
</div>
<div class="app-container" style="display:none;" id="app-container">
<div class="hud-container">
<div><div class="user-name" id="home-username">Explorer</div><div class="user-rank" id="home-user-level" style="display:none;"></div><div style="display:flex;align-items:center;gap:15px;margin-top:5px;"><div class="stats-pill" style="margin:0;padding:6px 12px;"><span style="color:var(--gold);">GLX:</span><span id="hud-glx-balance" style="color:#fff;font-weight:700;">0</span></div><div class="stats-pill" style="margin:0;padding:6px 12px;"><span style="color:var(--gold);">TON:</span><span id="hud-ton-balance" style="color:#fff;font-weight:700;">0</span></div></div></div>
<div style="display:flex;align-items:center;gap:10px;"><div class="galaxy-log-icon" id="galaxy-log-button"><span style="font-size:20px;">üìú</span></div><div class="hud-avatar"><img src="https://i.ibb.co/tTkJX1Qy/logo.png" alt="User"></div></div>
</div>
<main id="home" class="content-section active">
<div class="main-coin-section"><img src="https://i.ibb.co/tTkJX1Qy/logo.png" class="main-coin-img" alt="GLX"><div class="balance-display"><div class="balance-amount" id="total-GLX-balance">0</div><div class="balance-unit">GLX</div></div><div class="stats-pill"><span class="ton-val"><img src="https://i.ibb.co/8DsyHqwK/toncoin-ton-logo.png" style="width:16px;border-radius:50%;"><span id="home-ton-balance">0.0000</span> TON</span><span style="opacity:0.3">|</span><span style="font-size:10px;opacity:0.8;">100K = 0.01 TON</span></div></div>
<div class="action-bar">
<div class="btn btn-action nav-link" data-target="swap-page"><svg viewBox="0 0 24 24"><path d="M7 16V4m0 0L3 8m4-4 4 4m6 0v12m0 0 4-4m-4 4-4-4"/></svg><span>Swap</span></div>
<div class="btn btn-action nav-link" data-target="withdraw"><svg viewBox="0 0 24 24"><path d="M12 5v14m0 0-6-6m6 6 6-6"/></svg><span>Withdraw</span></div>
<div class="btn btn-action nav-link" data-target="user-withdrawals"><svg viewBox="0 0 24 24"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg><span>My Withdrawals</span></div>
<div class="btn btn-action nav-link" data-target="deposit"><svg viewBox="0 0 24 24"><path d="M12 5v14m0 0-6-6m6 6 6-6" transform="rotate(180,12,12)"/></svg><span>Deposit</span></div>
</div>
<div class="card" style="margin-top:12px;">
<h2 style="display:flex;align-items:center;gap:8px;">
<i class="fa-solid fa-bullhorn"></i>Updates & News
</h2>
<div class="support-channel-card" onclick="window.open('https://t.me/earnmoney174688','_blank')" style="margin-bottom:10px;">
<div style="display:flex;align-items:center;gap:12px;">
<div style="width:50px;height:50px;background:linear-gradient(135deg,#9b59b6,#8e44ad);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:white;">
<i class="fa-solid fa-bell"></i>
</div>
<div style="flex:1;">
<div style="font-size:14px;font-weight:700;color:white;margin-bottom:5px;">Bot Updates & News</div>
<div style="font-size:11px;color:var(--text-muted);">Latest updates, announcements, and news about the bot</div>
<div style="font-size:10px;color:#9b59b6;margin-top:5px;">
<i class="fa-solid fa-users"></i> @earnmoney174688
</div>
</div>
<div style="color:#9b59b6;font-size:18px;">
<i class="fa-solid fa-arrow-right"></i>
</div>
</div>
</div>
</div>
<div class="card" style="margin-top:12px;">
<h2 style="display:flex;align-items:center;gap:8px;">
<i class="fa-solid fa-headset"></i>Support & Help
</h2>
<div class="support-channel-card" onclick="window.open('https://t.me/aborabie777','_blank')" style="margin-bottom:10px;">
<div style="display:flex;align-items:center;gap:12px;">
<div style="width:50px;height:50px;background:linear-gradient(135deg,#3498db,#2980b9);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:white;">
<i class="fa-solid fa-user-gear"></i>
</div>
<div style="flex:1;">
<div style="font-size:14px;font-weight:700;color:white;margin-bottom:5px;">Technical Support</div>
<div style="font-size:11px;color:var(--text-muted);">Get help with technical issues and account problems</div>
</div>
<div style="color:#3498db;font-size:18px;">
<i class="fa-solid fa-arrow-right"></i>
</div>
</div>
</div>
<div class="support-channel-card" onclick="window.open('https://t.me/Elsayed_1_Elgohary','_blank')">
<div style="display:flex;align-items:center;gap:12px;">
<div style="width:50px;height:50px;background:linear-gradient(135deg,#27ae60,#2ecc71);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:white;">
<i class="fa-solid fa-circle-question"></i>
</div>
<div style="flex:1;">
<div style="font-size:14px;font-weight:700;color:white;margin-bottom:5px;">General Support & FAQ</div>
<div style="font-size:11px;color:var(--text-muted);">Get answers to common questions and general help</div>
</div>
<div style="color:#27ae60;font-size:18px;">
<i class="fa-solid fa-arrow-right"></i>
</div>
</div>
</div>
</div>
</main>
<main id="galaxy-log-page" class="content-section">
<div class="page-header"><h1>Galaxy Log</h1><p>Complete transaction history</p></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
<div class="log-stat-card"><div style="font-size:12px;color:var(--text-muted);">Total Earned</div><div style="font-size:18px;font-weight:700;color:#27ae60;" id="total-earned">0 GLX</div></div>
<div class="log-stat-card"><div style="font-size:12px;color:var(--text-muted);">Total Spent</div><div style="font-size:18px;font-weight:700;color:#e74c3c;" id="total-spent">0 GLX</div></div>
</div>
<div id="galaxy-log-filtered-list" style="max-height:500px;overflow-y:auto;"></div>
</main>
<main id="deposit" class="content-section">
<div class="page-header"><h1>Deposit TON</h1><p>Add funds to your account</p></div>
<div class="card">
<div style="text-align:center;margin-bottom:20px;"><div style="font-size:16px;font-weight:700;color:var(--gold);margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:8px;"><i class="fa-solid fa-arrow-down-to-line" style="color:#27ae60;"></i>Deposit TON</div><div style="font-size:12px;color:var(--text-muted);">Add TON directly to your account</div></div>
<div style="display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,0.3);padding:12px;border-radius:12px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.1);"><div><div style="font-size:11px;color:var(--text-muted);">Current Balance</div><div style="font-size:20px;font-weight:700;color:#fff;"><span class="user-ton-balance">0.0000</span> TON</div></div></div>
<div class="input-wrap"><span class="input-label">Deposit Amount (TON)</span><input type="number" id="deposit-amount" class="custom-input" placeholder="0.01" step="0.001" min="0.01" value="0.01"><div style="text-align:right;font-size:10px;color:var(--text-muted);margin-top:5px;">Minimum: 0.01 TON</div></div>
<button class="btn btn-ton" id="deposit-pay-btn" onclick="initiateDeposit()"><img src="https://i.ibb.co/8DsyHqwK/toncoin-ton-logo.png" style="width:20px;border-radius:50%;">Pay with Tonkeeper</button>
<div id="deposit-status" style="display:none;text-align:center;margin-top:15px;"><div id="deposit-status-message" style="font-size:12px;color:var(--text-muted);"></div><button class="btn btn-check" id="check-deposit-btn" onclick="verifyDeposit()" style="margin-top:10px;">Check Payment</button></div>
<div class="info-box" style="background:rgba(52,152,219,0.1);border-color:rgba(52,152,219,0.3);margin-top:15px;"><div style="display:flex;align-items:flex-start;gap:10px;"><div style="color:#3498db;font-size:14px;"><i class="fa-solid fa-circle-info"></i></div><div style="font-size:11px;line-height:1.5;"><strong>Deposit Instructions:</strong><br>1. Enter the TON amount you want to deposit<br>2. Click "Pay with Tonkeeper"<br>3. Confirm the payment in your Tonkeeper wallet<br>4. Click "Check Payment" to verify<br>5. Funds will be added to your account immediately</div></div></div>
</div>
<div class="card" style="margin-top:15px;"><div style="text-align:center;"><div style="font-size:16px;font-weight:700;color:var(--gold);margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:8px;"><i class="fa-solid fa-headset" style="color:#3498db;"></i>Need Help with Deposit?</div><div style="font-size:12px;color:var(--text-muted);margin-bottom:15px;">If you're having issues with deposit, contact our support team</div><button class="btn btn-ton" onclick="window.open('https://t.me/Elsayed_1_Elgohary','_blank')" style="background:linear-gradient(90deg,#3498db,#2980b9);"><i class="fab fa-telegram"></i>Contact Support</button></div></div>
</main>
<main id="user-withdrawals" class="content-section">
<div class="page-header"><h1>My Withdrawals</h1><p>Track your withdrawal requests</p></div>
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;"><h3 style="color:var(--gold);font-size:14px;">Withdrawal History</h3><div style="display:flex;gap:5px;"><button class="btn-filter small active" onclick="filterUserWithdrawals('all')">All</button><button class="btn-filter small" onclick="filterUserWithdrawals('pending')">Pending</button><button class="btn-filter small" onclick="filterUserWithdrawals('completed')">Completed</button></div></div>
<div id="user-withdrawals-list" style="max-height:400px;overflow-y:auto;display:flex;flex-direction:column-reverse;"></div>
</div>
</main>
<main id="competition" class="content-section">
<div class="page-header"><h1>Daily Competition</h1><p>Win Big with Tickets</p></div>
<div class="competition-timer-card"><div class="countdown-display" id="countdown-timer">24:00:00</div><div class="timer-label">TIME UNTIL NEXT COMPETITION</div></div>
<div class="status-grid">
<div class="status-card"><div class="status-icon">üèÅ</div><div class="status-value" id="competition-status">ACTIVE</div><div class="status-label">COMPETITION STATUS</div></div>
<div class="status-card"><div class="status-value" id="prize-pool">0.000 TON</div><div class="status-label">TOTAL PRIZE POOL</div></div>
<div class="status-card" style="grid-column:span 2;"><div class="status-value" id="total-tickets" style="font-size:32px;">0</div><div class="status-label">TOTAL TICKETS SOLD</div></div>
</div>
<div class="ticket-price-note">
<p>üé´ <strong>Each ticket = 10,000 GLX = 0.001 TON</strong></p>
<p style="font-size:11px;margin-top:5px;">Prize Pool = Total Tickets √ó 0.001 TON</p>
</div>
<div class="competition-rules-card">
<div class="rules-header"><i class="fa-solid fa-circle-info"></i><span>Competition Rules</span></div>
<ul class="rules-list">
<li><span class="winner-highlight">üèÜ ONLY THE FIRST PLACE WINS!</span> - The user with the most tickets wins the entire prize pool.</li>
<li><span class="loser-note">‚ùå ALL OTHER PARTICIPANTS LOSE</span> - Only #1 gets the prize, others get nothing.</li>
<li>üé´ Each ticket costs <strong>10,000 GLX (0.001 TON)</strong></li>
<li>üí∞ Prize Pool = Total Tickets √ó 0.001 TON</li>
<li>‚è∞ Competition runs for 24 hours, followed by 1 hour break</li>
<li>üìä Winner is automatically selected after competition ends</li>
</ul>
<div class="important-note"><i class="fa-solid fa-exclamation-triangle"></i><strong>Important:</strong> Buy more tickets to increase your chance of winning! Only #1 position matters.</div>
</div>
<div class="card">
<h3 style="color:var(--gold);margin-bottom:15px;">üéüÔ∏è Buy Competition Tickets</h3>
<div class="ticket-controls"><input type="number" id="ticket-amount" class="ticket-input" placeholder="Enter tickets amount" min="1" value="1"><button class="max-btn" onclick="setMaxTickets()">MAX</button></div>
<div class="price-info">
<div style="display:flex;justify-content:space-between;margin-bottom:10px;font-size:12px;"><span style="color:var(--text-muted);">Tickets:</span><span id="tickets-count-display">1</span></div>
<div style="display:flex;justify-content:space-between;margin-bottom:15px;font-size:12px;"><span style="color:var(--text-muted);">Cost:</span><span id="tickets-cost-display">10,000 GLX</span></div>
</div>
<button class="btn btn-primary" id="buy-tickets-btn" onclick="buyTickets()"><i class="fa-solid fa-ticket"></i>BUY TICKETS</button>
<p id="buy-tickets-status" style="text-align:center;font-size:11px;margin-top:10px;color:var(--text-muted);"></p>
</div>
<div class="competition-leaderboard">
<div class="leaderboard-header"><h3 style="font-size:16px;color:var(--gold);">üèÜ Top 10 Leaders</h3><span style="font-size:10px;color:var(--text-muted);">Live Ranking</span></div>
<div id="competition-leaderboard-list" style="max-height:300px;overflow-y:auto;padding-bottom:10px;"><p style="text-align:center;padding:20px;color:var(--text-muted);">Loading leaderboard...</p></div>
</div>
<div class="previous-winners-card"><h3 style="font-size:16px;color:var(--gold);margin-bottom:15px;">üìÖ Yesterday's Winners</h3><div id="previous-winners-list"><p style="text-align:center;padding:20px;color:var(--text-muted);">No previous winners yet</p></div></div>
</main>
<main id="bonus" class="content-section">
<div class="page-header"><h1>Galaxy Bonus</h1><p>Daily rewards & fun games</p></div>
<div class="bonus-grid">
<div class="bonus-game-card" onclick="openGame('coin-flip')"><img src="https://i.ibb.co/gLT3myT3/Coin-Flip-Game.png" alt="Coin Flip Game" class="game-banner"><div class="game-content"><div class="game-icon">ü™ô</div><div class="game-title">Coin Flip Game</div><div class="game-description">Heads or Tails? Win 2x your bet!</div></div></div>
<div class="bonus-game-card" onclick="openGame('promo-codes')"><img src="https://i.ibb.co/jnp9cTb/Promo-Codes-Rewards.png" alt="Promo Codes & Rewards" class="game-banner"><div class="game-content"><div class="game-icon">üéÅ</div><div class="game-title">Promo Codes</div><div class="game-description">Redeem codes for free rewards</div></div></div>
<div class="bonus-game-card" onclick="openGame('daily-streak')"><img src="https://i.ibb.co/GQQ0BnsT/Daily-Streak.png" alt="Daily Streak" class="game-banner"><div class="game-content"><div class="game-icon">üìÖ</div><div class="game-title">Daily Streak</div><div class="game-description">Claim daily rewards up to 7 days</div></div></div>
<div class="bonus-game-card" onclick="openGame('galaxy-slots')"><img src="https://i.ibb.co/204QyBWX/Galaxy-Slots-Game.png" alt="Galaxy Slots Game" class="game-banner"><div class="game-content"><div class="game-icon">üé∞</div><div class="game-title">Galaxy Slots</div><div class="game-description">Spin the reels & win big jackpots</div></div></div>
</div>
<div id="coin-flip-section" class="card" style="display:none;">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;"><h3 style="font-size:14px;color:var(--gold);display:flex;align-items:center;gap:8px;"><i class="fa-solid fa-coins" style="color:#a855f7;"></i>Coin Flip Game</h3><button class="btn btn-action" onclick="closeGame()" style="width:auto;padding:8px 12px;font-size:11px;"><i class="fa-solid fa-arrow-left"></i>Back</button></div>
<div class="probability-display" style="display:none;"><div class="prob-item"><div class="prob-value win-prob">45%</div><div class="prob-label">Win Chance</div></div><div class="prob-item"><div class="prob-value loss-prob">55%</div><div class="prob-label">Loss Chance</div></div></div>
<div class="coin-flip-game">
<div class="coin-bet-controls"><input type="number" id="coin-bet-amount" class="bet-input" placeholder="Enter bet amount" min="1000" value="1000"><button class="max-btn" onclick="setMaxBet()" style="width:auto;padding:12px 15px;">MAX</button></div>
<div class="bet-buttons"><button class="bet-btn k-style active" onclick="setBetAmount(1000)">1k</button><button class="bet-btn k-style" onclick="setBetAmount(5000)">5k</button><button class="bet-btn k-style" onclick="setBetAmount(10000)">10k</button><button class="bet-btn k-style" onclick="setBetAmount(25000)">25k</button></div>
<div class="side-selection">
<div class="side-btn active" id="choose-glx" onclick="chooseSide('glx')"><div class="side-icon"><img src="https://i.ibb.co/tTkJX1Qy/logo.png" style="width:70px;height:70px;border-radius:50%;"></div><div class="side-name">GLX Side</div><div class="side-description">Win 2x if GLX appears</div></div>
<div class="side-btn" id="choose-gold" onclick="chooseSide('gold')"><div class="side-icon"><img src="https://i.ibb.co/tTkJX1Qy/logo.png" style="width:70px;height:70px;border-radius:50%;filter:sepia(1)saturate(2)hue-rotate(10deg)brightness(1.2);"></div><div class="side-name">Gold Side</div><div class="side-description">Win 2x if Gold appears</div></div>
</div>
<div class="coin-container"><div class="coin" id="coin"><div class="coin-face coin-front"><img src="https://i.ibb.co/tTkJX1Qy/logo.png" alt="GLX Coin"></div><div class="coin-face coin-back"><img src="https://i.ibb.co/tTkJX1Qy/logo.png" alt="Gold Coin" class="gold-side"></div></div></div>
<button class="btn btn-primary" id="flip-coin-btn" onclick="flipCoin()"><i class="fa-solid fa-play"></i>FLIP COIN</button>
<div class="game-result" id="coin-game-result" style="display:none;"><div class="result-text" id="coin-result-text"></div><div class="win-amount" id="coin-win-amount"></div><div class="loss-amount" id="coin-loss-amount"></div></div>
<div class="coin-game-rules">
<h4><i class="fa-solid fa-circle-info"></i>Game Rules</h4>
<ul>
<li><strong>Minimum bet:</strong> 1,000 GLX</li>
<li><strong>Choose:</strong> GLX Side or Gold Side</li>
<li><strong>If you win:</strong> Get 2x your bet (net profit: bet amount)</li>
<li><strong>If you lose:</strong> Lose your bet amount</li>
<li><strong>Note:</strong> Bet amount is deducted immediately when you flip</li>
</ul>
</div>
</div>
</div>
<div id="promo-codes-section" class="card" style="display:none;">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;"><h3 style="font-size:14px;color:var(--gold);display:flex;align-items:center;gap:8px;"><i class="fa-solid fa-gift" style="color:#a855f7;"></i>Promo Codes & Rewards</h3><button class="btn btn-action" onclick="closeGame()" style="width:auto;padding:8px 12px;font-size:11px;"><i class="fa-solid fa-arrow-left"></i>Back</button></div>
<div class="promo-card" style="background:linear-gradient(135deg,rgba(168,85,247,0.2),rgba(123,97,255,0.2));border-radius:20px;padding:20px;margin-bottom:15px;border:2px solid rgba(168,85,247,0.3);position:relative;overflow:hidden;">
<div style="position:absolute;top:-50px;right:-50px;width:100px;height:100px;background:rgba(168,85,247,0.1);border-radius:50%;"></div>
<div style="position:absolute;bottom:-30px;left:-30px;width:80px;height:80px;background:rgba(123,97,255,0.1);border-radius:50%;"></div>
<div style="position:relative;z-index:2;">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;"><div style="width:50px;height:50px;background:linear-gradient(135deg,#a855f7,#7b61ff);border-radius:15px;display:flex;align-items:center;justify-content:center;font-size:24px;color:white;"><i class="fa-solid fa-key"></i></div><div><div style="font-size:16px;font-weight:800;color:white;">Redeem Code</div><div style="font-size:12px;color:rgba(255,255,255,0.7);">Enter promo code for rewards</div></div></div>
<div style="display:flex;gap:10px;margin-bottom:15px;"><input type="text" id="promo-code-input" placeholder="Enter promo code..." style="flex:1;padding:12px 15px;border-radius:12px;background:rgba(0,0,0,0.3);border:1px solid rgba(168,85,247,0.5);color:white;font-family:inherit;font-size:14px;outline:none;"><button id="redeem-code-btn" style="padding:12px 20px;background:linear-gradient(135deg,#a855f7,#7b61ff);border:none;border-radius:12px;color:white;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:8px;"><i class="fa-solid fa-gift"></i>Redeem</button></div>
<div id="promo-result" style="padding:10px;border-radius:10px;font-size:12px;text-align:center;display:none;"></div>
</div>
</div>
<div class="code-channel-card" style="background:linear-gradient(135deg,rgba(255,193,7,0.2),rgba(255,152,0,0.2));border-radius:20px;padding:20px;border:2px solid rgba(255,193,7,0.3);position:relative;overflow:hidden;cursor:pointer;" onclick="window.open('https://t.me/earnmoney1685','_blank')">
<div style="position:absolute;top:-30px;right:-30px;width:80px;height:80px;background:rgba(255,193,7,0.1);border-radius:50%;"></div>
<div style="position:relative;z-index:2;">
<div style="display:flex;align-items:center;gap:15px;"><div style="width:60px;height:60px;background:linear-gradient(135deg,#FFC107,#FF9800);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;color:white;"><i class="fab fa-telegram"></i></div><div style="flex:1;"><div style="font-size:16px;font-weight:800;color:white;margin-bottom:5px;"><i class="fa-solid fa-bolt" style="color:#FFC107;"></i>Codes Channel</div><div style="font-size:12px;color:rgba(255,255,255,0.8);margin-bottom:8px;">Get exclusive promo codes & daily rewards</div><div style="display:flex;align-items:center;gap:5px;"><span style="font-size:11px;color:#FFC107;font-weight:700;"><i class="fa-solid fa-users"></i>Join Now</span><span style="font-size:11px;color:rgba(255,255,255,0.6);">@earnmoney1685</span></div></div><div style="width:40px;height:40px;background:rgba(255,255,255,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#FFC107;font-size:18px;"><i class="fa-solid fa-arrow-right"></i></div></div>
</div>
</div>
</div>
<div id="daily-streak-section" class="card" style="display:none;">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;"><h3 style="font-size:14px;color:var(--gold);display:flex;align-items:center;gap:8px;"><i class="fa-solid fa-calendar-check" style="color:#a855f7;"></i>Daily Streak</h3><button class="btn btn-action" onclick="closeGame()" style="width:auto;padding:8px 12px;font-size:11px;"><i class="fa-solid fa-arrow-left"></i>Back</button></div>
<div class="daily-row" id="daily-checkin-grid"></div>
<button class="btn btn-primary" id="claim-daily-btn">Claim Bonus</button>
<p id="next-claim-timer" style="text-align:center;font-size:11px;margin-top:8px;opacity:0.7;"></p>
</div>
<div id="galaxy-slots-section" class="card" style="display:none;text-align:center;">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;"><h3 style="font-size:14px;color:var(--gold);display:flex;align-items:center;gap:8px;"><i class="fa-solid fa-slot-machine" style="color:#a855f7;"></i>Galaxy Slots Game</h3><button class="btn btn-action" onclick="closeGame()" style="width:auto;padding:8px 12px;font-size:11px;"><i class="fa-solid fa-arrow-left"></i>Back</button></div>
<div class="spins-display">
<div><div style="font-size:12px;color:var(--text-muted);">Available Spins</div><div class="spins-count" id="available-spins">1</div></div>
<button class="btn btn-ton" onclick="getExtraSpin()" style="width:auto;padding:8px 15px;">üé¨ Watch Ad for Extra Spin</button>
</div>
<div class="slots-machine">
<div class="slots-reels">
<div class="reel-container"><div class="reel" id="reel1"></div></div>
<div class="reel-container"><div class="reel" id="reel2"></div></div>
<div class="reel-container"><div class="reel" id="reel3"></div></div>
</div>
<div class="slots-result">
<div id="slots-result-text" style="font-size:14px;margin-bottom:10px;">Press SPIN to play!</div>
<div id="slots-win-amount" style="font-size:24px;font-weight:800;color:var(--primary-green);">0 GLX</div>
</div>
</div>
<button class="btn btn-primary" id="slots-spin-btn" style="margin-bottom:15px;">üöÄ SPIN NOW</button>
<div class="payout-table">
<div class="payout-item">3x üåü = <span class="jackpot">10000 GLX</span></div>
<div class="payout-item">3x ü™ê = 5000 GLX</div>
<div class="payout-item">3x üí´ = 2500 GLX</div>
<div class="payout-item">3x ‚≠ê = 1200 GLX</div>
<div class="payout-item">2x üåü = 700 GLX</div>
<div class="payout-item">Any Match = 500 GLX</div>
</div>
</div>
</main>
<main id="tasks" class="content-section">
<div class="page-header"><h1>Missions</h1><p>Complete tasks to earn GLX</p></div>
<div class="card">
<div style="display:flex;justify-content:space-between;margin-bottom:10px;font-size:12px;font-weight:700;"><span>Daily Ad Limit</span><span style="color:var(--gold);">650 Total</span></div>
<div id="monetag-ad-task" class="list-card" style="background:rgba(255,255,255,0.08);border-color:var(--primary-green);margin-bottom:10px;">
<div class="lc-icon"><img src="https://i.ibb.co/tTkJX1Qy/logo.png" alt="Ad"></div>
<div class="lc-content"><div class="lc-title">Monetag Ad</div><div class="lc-sub"><span id="monetag-count">0</span>/<span id="monetag-limit">50</span></div></div>
<div class="lc-end"><div class="lc-val">+500</div></div>
</div>
<div id="gigapub-ad-task" class="list-card" style="background:rgba(255,255,255,0.08);border-color:var(--primary-green);margin-bottom:10px;">
<div class="lc-icon"><img src="https://i.ibb.co/tTkJX1Qy/logo.png" alt="Ad"></div>
<div class="lc-content"><div class="lc-title">GigaPub Ad</div><div class="lc-sub"><span id="giga-count">0</span>/<span id="giga-limit">300</span></div></div>
<div class="lc-end"><div class="lc-val">+500</div></div>
</div>
<div id="adsgram-ad-task" class="list-card" style="background:rgba(255,255,255,0.08);border-color:var(--primary-green);">
<div class="lc-icon"><img src="https://i.ibb.co/tTkJX1Qy/logo.png" alt="Ad"></div>
<div class="lc-content"><div class="lc-title">AdsGram Ad</div><div class="lc-sub"><span id="adsgram-count">0</span>/<span id="adsgram-limit">300</span></div></div>
<div class="lc-end"><div class="lc-val">+500</div></div>
</div>
</div>
<h2>Community</h2>
<div id="community-tasks-card"><div id="community-tasks-list"></div></div>
</main>
<main id="create-task-page" class="content-section">
<div class="page-header"><h1>Add Mission</h1><p>Promote your channel or bot</p></div>
<div class="card">
<div class="input-wrap"><span class="input-label">Task Name</span><input type="text" id="new-task-name" class="custom-input" placeholder="e.g. Join Galaxy Channel"></div>
<div class="input-wrap"><span class="input-label">Link</span><input type="text" id="new-task-link" class="custom-input" placeholder="https://t.me/..."></div>
<div class="input-label" style="margin-bottom:10px;">Category</div>
<div class="cat-select">
<div class="cat-opt active" onclick="selectCat(this,'channel')">Channel / Group</div>
<div class="cat-opt" onclick="selectCat(this,'bot')">Website / Bot</div>
</div>
<div id="admin-required-msg" style="background:rgba(255,179,0,0.15);border:1px solid #ffb300;border-radius:12px;padding:12px;margin-bottom:20px;font-size:12px;color:#ffb300;display:block;line-height:1.5;"><i class="fa-solid fa-triangle-exclamation" style="margin-right:5px;"></i><strong>Action Required:</strong> You must add <u>@RealEarnBot_bot</u> as an <strong>Admin</strong> in your Channel/Group for tracking to work.</div>
<div class="input-label" style="margin-bottom:10px;">Number of Completions</div>
<div class="price-grid" id="price-options"></div>
<div id="payment-step-1"><button class="btn btn-ton" id="pay-task-btn" onclick="initiatePayment()"><img src="https://i.ibb.co/8DsyHqwK/toncoin-ton-logo.png" style="width:20px;border-radius:50%;">Pay <span id="pay-amount-display">0</span> TON</button></div>
<div id="payment-step-2" style="display:none;text-align:center;"><p style="font-size:12px;margin-bottom:10px;color:#fff;">Payment sent? Verify below:</p><button class="btn btn-check" id="check-payment-btn" onclick="verifyPayment()">Check Payment</button><p id="payment-status-msg" style="font-size:11px;margin-top:8px;color:var(--text-muted);">Waiting for transaction...</p></div>
</div>
<button class="btn btn-action nav-link" data-target="tasks" style="margin-top:10px;">Cancel</button>
</main>
<main id="history" class="content-section">
<div class="page-header"><h1>Ledger</h1><p>Transaction History</p></div>
<div id="full-history-list" style="padding-bottom:20px;"></div>
</main>
<main id="withdrawal-history" class="content-section">
<div class="page-header"><h1>Withdrawal History</h1><p>All completed withdrawals</p></div>
<div class="card" style="margin-top:15px;">
<h2 style="display:flex;align-items:center;gap:8px;"><i class="fa-solid fa-credit-card"></i>Payments Channel</h2>
<div class="support-channel-card" onclick="window.open('https://t.me/earnmoney139482','_blank')">
<div style="display:flex;align-items:center;gap:12px;"><div style="width:50px;height:50px;background:linear-gradient(135deg,#a855f7,#7b61ff);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:white;"><i class="fab fa-telegram"></i></div><div style="flex:1;"><div style="font-size:14px;font-weight:700;color:white;margin-bottom:5px;">Payments & Withdrawals Channel</div><div style="font-size:11px;color:var(--text-muted);">Track payments, withdrawals, and transaction updates</div><div style="font-size:10px;color:#ffb300;margin-top:5px;"><i class="fa-solid fa-users"></i> @earnmoney139482</div></div><div style="color:var(--primary-green);font-size:18px;"><i class="fa-solid fa-arrow-right"></i></div></div>
</div>
</div>
<div id="withdrawal-history-list" style="max-height:500px;overflow-y:auto;"></div>
</main>
<main id="swap-page" class="content-section">
<div class="page-header"><h1>Swap Market</h1><p>100K GLX = 0.01 TON</p></div>
<div class="swap-direction-selector">
<div class="swap-direction-btn active" onclick="selectSwapDirection('glx_to_ton')">GLX ‚Üí TON</div>
<div class="swap-direction-btn" onclick="selectSwapDirection('ton_to_glx')">TON ‚Üí GLX</div>
</div>
<div class="card">
<div id="glx-to-ton-section">
<div class="input-wrap"><span class="input-label">You Give (GLX)</span><input type="number" id="swap-input-amount" class="custom-input" placeholder="Min 1,000" oninput="calculateSwap()"><div style="text-align:right;font-size:10px;color:var(--text-muted);margin-top:5px;">Max:<span id="swap-max-GLX">0</span><button onclick="setMaxSwap('glx')" style="margin-left:10px;background:var(--primary-green);color:#000;border:none;padding:4px 8px;border-radius:6px;font-size:10px;cursor:pointer;">MAX</button></div></div>
<div class="input-wrap"><span class="input-label">You Get (TON)</span><div style="display:flex;align-items:center;gap:10px;"><img src="https://i.ibb.co/8DsyHqwK/toncoin-ton-logo.png" style="width:24px;"><span id="swap-output-amount" class="custom-input">0.0000000</span></div></div>
<div class="swap-mode-text">Rate: 100,000 GLX = 0.01 TON</div>
</div>
<div id="ton-to-glx-section" style="display:none;">
<div class="input-wrap"><span class="input-label">You Give (TON)</span><input type="number" id="ton-input-amount" class="custom-input" placeholder="Min 0.0001" oninput="calculateSwap()"><div style="text-align:right;font-size:10px;color:var(--text-muted);margin-top:5px;">Max:<span id="swap-max-TON">0.0000</span><button onclick="setMaxSwap('ton')" style="margin-left:10px;background:var(--primary-green);color:#000;border:none;padding:4px 8px;border-radius:6px;font-size:10px;cursor:pointer;">MAX</button></div></div>
<div class="input-wrap"><span class="input-label">You Get (GLX)</span><div style="display:flex;align-items:center;gap:10px;"><img src="https://i.ibb.co/tTkJX1Qy/logo.png" style="width:24px;height:24px;border-radius:50%;"><span id="ton-output-amount" class="custom-input">0</span></div></div>
<div class="swap-mode-text">Rate: 0.01 TON = 100,000 GLX</div>
</div>
<button class="btn btn-primary" id="execute-swap-btn" onclick="executeSwap()">Confirm Swap</button>
</div>
</main>
<main id="withdraw" class="content-section">
<div class="page-header"><h1>Withdraw</h1><p>GLX out to TON Wallet</p></div>
<div class="withdrawals-counter" id="daily-withdrawals-counter">
<div>Today's Withdrawals: <span class="count" id="today-withdrawals-count">0</span>/2</div>
<div class="reset-time" id="withdraw-reset-timer">Resets in: 24h 00m</div>
</div>
<div class="withdrawal-type-selector">
<div class="withdrawal-type-btn active" data-type="faucetpay" onclick="selectWithdrawalType('faucetpay')"><i class="fa-solid fa-envelope"></i>FaucetPay</div>
<div class="withdrawal-type-btn" data-type="tonwallet" onclick="selectWithdrawalType('tonwallet')"><i class="fa-solid fa-wallet"></i>TON Wallet</div>
</div>
<div id="faucetpay-form" class="card">
<div class="input-wrap"><span class="input-label">FaucetPay Email Address</span><input type="email" id="faucetpay-email" class="custom-input" placeholder="example@gmail.com" oninput="maskEmail()"><div id="email-preview" class="email-display masked-email" style="display:none;margin-top:8px;font-size:12px;color:#a855f7;font-family:'Courier New',monospace;"></div></div>
<div class="input-wrap withdraw-input-with-max"><span class="input-label">Withdrawal Amount (TON)</span><div style="display:flex;align-items:center;gap:8px;"><input type="number" id="faucetpay-amount" class="custom-input" placeholder="0.0001" step="0.0001" min="0.0001" value="0.0001" style="flex:1;"><button class="max-btn" onclick="setMaxFaucetPay()">MAX</button></div><div style="text-align:right;font-size:10px;color:var(--text-muted);margin-top:5px;">Minimum: 0.0001 TON</div></div>
<div class="info-box"><div style="display:flex;align-items:flex-start;gap:8px;"><div class="info-icon">!</div><div style="font-size:11px;line-height:1.4;"><strong>Important Information:</strong><br>‚Ä¢ Enter the email registered with your FaucetPay account<br>‚Ä¢ Minimum withdrawal: 0.0001 TON<br>‚Ä¢ <span style="color:#27ae60;">‚úÖ No fees</span> - We cover all transaction costs<br>‚Ä¢ Processing time: Up to 1 minute<br>‚Ä¢ Your email will be partially hidden for privacy</div></div></div>
<button class="btn btn-primary" id="withdraw-faucetpay-btn" onclick="handleFaucetPayWithdraw()"><i class="fa-solid fa-paper-plane"></i>WITHDRAW VIA FAUCETPAY</button>
</div>
<div id="tonwallet-form" class="card" style="display:none;">
<div class="input-wrap"><span class="input-label">TON Wallet Address</span><input type="text" id="ton-wallet-address" class="custom-input" placeholder="UQ... or EQ... or kQ..."><div style="text-align:right;font-size:10px;color:var(--text-muted);margin-top:5px;">Enter your TON wallet address (starts with UQ, EQ, or kQ)</div></div>
<div class="input-wrap"><span class="input-label">Memo (Optional)</span><input type="text" id="ton-memo" class="custom-input" placeholder="For exchange deposits only"><div style="text-align:right;font-size:10px;color:var(--text-muted);margin-top:5px;">Optional: Required by some exchanges for deposits</div></div>
<div class="input-wrap withdraw-input-with-max"><span class="input-label">Withdrawal Amount (TON)</span><div style="display:flex;align-items:center;gap:8px;"><input type="number" id="ton-withdraw-amount" class="custom-input" placeholder="0.05" step="0.01" min="0.05" value="0.05" style="flex:1;"><button class="max-btn" onclick="setMaxTonWallet()">MAX</button></div><div style="text-align:right;font-size:10px;color:var(--text-muted);margin-top:5px;">Minimum: 0.05 TON</div></div>
<div class="info-box success"><div style="display:flex;align-items:flex-start;gap:8px;"><div class="info-icon">‚úì</div><div style="font-size:11px;line-height:1.4;"><strong>Withdrawal Details:</strong><br>‚Ä¢ Minimum withdrawal: 0.05 TON<br>‚Ä¢ <span style="color:#27ae60;">‚úÖ No fees</span> - We cover all transaction costs<br>‚Ä¢ Processing time: Up to 24 hours<br>‚Ä¢ Memo is only needed for exchange deposits<br>‚Ä¢ Ensure address is correct - transactions are irreversible</div></div></div>
<button class="btn btn-primary" id="withdraw-ton-now-btn" onclick="handleTonWalletWithdraw()"><i class="fa-solid fa-wallet"></i>WITHDRAW TO TON WALLET</button>
</div>
</main>
<main id="leaderboard" class="content-section">
<div class="page-header"><h1>Top Kings</h1><p>The richest in the Galaxy</p></div>
<div class="leader-tabs"><div class="tab-btn active" data-target="invites-leaderboard-list">Invites</div><div class="tab-btn" data-target="earnings-leaderboard-list">Holders</div></div>
<div class="podium-list" id="invites-leaderboard-list"></div>
<div class="podium-list hidden" id="earnings-leaderboard-list"></div>
</main>
<main id="referrals" class="content-section">
<div class="page-header"><h1>Referrals</h1><p>Invite friends, earn together</p></div>
<div class="card" style="text-align:center;">
<img src="https://i.ibb.co/tTkJX1Qy/logo.png" style="width:80px;margin-bottom:15px;">
<div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:12px;margin-bottom:20px;"><div style="font-size:12px;color:var(--text-muted);">Total Referrals</div><div style="font-size:24px;font-weight:800;color:#fff;" id="referral-count-display">0</div></div>
<p>Earn <strong>+100K GLX</strong> for every friend.</p>
<div id="referral-link-display" style="background:#000;padding:10px;border-radius:8px;font-family:monospace;font-size:10px;color:#aaa;margin:15px 0;word-break:break-all;">...</div>
<button class="btn btn-primary" id="share-referral-btn">Invite Friends</button>
<button class="btn btn-outline" id="copy-referral-btn" style="margin-top:10px;">Copy Link</button>
</div>
</main>
</div>
<div class="floating-add-task hidden" id="floatingAddTask" onclick="switchTab('create-task-page')">
<div class="floating-add-task-content">
<div class="floating-add-task-icon">+</div>
<div class="floating-add-task-text">Add Task</div>
</div>
</div>
<nav class="bottom-nav">
<div class="nav-item active" data-target="home"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg><span class="nav-text">Home</span></div>
<div class="nav-item" data-target="tasks"><svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg><span class="nav-text">Tasks</span></div>
<div class="nav-item" data-target="bonus"><svg viewBox="0 0 24 24"><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"/><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"/></svg><span class="nav-text">Bonus</span></div>
<div class="nav-item competition-nav-item" data-target="competition">
<div class="competition-nav-icon"><svg viewBox="0 0 32 32" width="28" height="28"><circle cx="16" cy="16" r="14" fill="rgba(255,215,0,0.15)" opacity="0.8"/><path d="M9 13 L16 8 L23 13 L21 21 L11 21 Z" fill="none" stroke="#FFD700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16 5 L17.5 10 L22 10 L18.5 13 L19.5 18 L16 15 L12.5 18 L13.5 13 L10 10 L14.5 10 Z" fill="#FFD700" stroke="#FFA500" stroke-width="1.5"/><circle cx="16" cy="16" r="6" fill="none" stroke="#FFD700" stroke-width="1.5" stroke-dasharray="2 2"/><circle cx="16" cy="16" r="8" fill="none" stroke="rgba(255,215,0,0.3)" stroke-width="3"/></svg></div>
<span class="nav-text">Competition</span>
</div>
<div class="nav-item" data-target="referrals"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span class="nav-text">Referrals</span></div>
<div class="nav-item" data-target="withdrawal-history"><svg viewBox="0 0 24 24" style="filter:drop-shadow(0 0 8px rgba(168,85,247,0.4));"><path d="M12 2v20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M8 12l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span class="nav-text">Withdrawals</span></div>
</nav>
<script>
// ==================== ÿ®ŸÇŸäÿ© ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ£ÿµŸÑŸä ====================

let loadingProgress=0;
let loadingSeconds=10;
let loadingTimerInterval;

function startGlobalLoading(){
    const loadingPage=document.getElementById('global-loading-page');
    const progressBar=document.getElementById('loading-progress-bar');
    const timerElement=document.getElementById('loading-timer');
    if(!loadingPage||!progressBar||!timerElement)return;
    document.getElementById('security-verification').style.display='none';
    document.getElementById('blocked-access').style.display='none';
    document.getElementById('app-container').style.display='none';
    loadingPage.style.display='flex';
    loadingTimerInterval=setInterval(()=>{
        loadingSeconds--;
        if(loadingSeconds<=0){
            loadingSeconds=0;
            timerElement.textContent="Complete!";
        }else{
            timerElement.textContent=loadingSeconds+" second"+(loadingSeconds!==1?'s':'');
        }
        loadingProgress=((10-loadingSeconds)/10)*100;
        progressBar.style.width=loadingProgress+'%';
        if(loadingSeconds<=0){
            clearInterval(loadingTimerInterval);
            finishLoading();
        }
    },1000);
}

async function checkUserBlockStatus(){
    try{
        const userId=window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
        if(!userId)return null;
        const result=await callAPI('checkUserBlocked');
        return result;
    }catch(error){
        console.error("Block check error:",error);
        return null;
    }
}

async function checkBeforeAction(actionName){
    const blockCheck=await checkUserBlockStatus();
    if(blockCheck&&blockCheck.success===false&&blockCheck.error==='ACCOUNT_BLOCKED'){
        console.log("Account blocked for action:",actionName);
        showNotification("Your account has been blocked.","error");
        return false;
    }
    return true;
}

let isCompetitionDataLoaded=false;
let competitionUpdateInterval=null;
let lastLeaderboardUpdate=0;
const LEADERBOARD_UPDATE_INTERVAL=60000;
let isCompetitionPageVisible=false;

async function checkMandatorySubscriptions(){
    const userId=window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    if(!userId)return false;
    try{
        const result=await callAPI('checkMandatorySubscriptions',{userId:userId});
        console.log("Subscription check result:",result);
        if(result.success&&result.data){
            if(result.data.allSubscribed===true){
                console.log("User is subscribed to all channels");
                return true;
            }
            if(result.data.subscriptionStatus){
                const subscriptionStatus=result.data.subscriptionStatus;
                const allSubscribed=Object.values(subscriptionStatus).every(status=>status===true);
                if(allSubscribed){
                    console.log("User is subscribed to all channels (via subscriptionStatus)");
                    return true;
                }
            }
            console.log("User is NOT subscribed to all channels:",result.data);
            return false;
        }else if(result.success===false&&result.error==='MANDATORY_SUBSCRIPTION_REQUIRED'){
            console.log("Mandatory subscription required, showing subscription screen");
            return false;
        }
        return false;
    }catch(error){
        console.error("Subscription check error:",error);
        return false;
    }
}

function showMandatorySubscriptionScreen(){
    const requiredChannels=[
        {username:'@earnmoney174688',link:'https://t.me/earnmoney174688',name:'News Channel',description:'Latest updates & announcements'},
        {username:'@earnmoney1685',link:'https://t.me/earnmoney1685',name:'Codes Channel',description:'Daily promo codes & rewards'},
        {username:'@earnmoney139482',link:'https://t.me/earnmoney139482',name:'Payments Channel',description:'Track payments & withdrawals'},
        {username:'@EarnMoneyWithRedone',link:'https://t.me/EarnMoneyWithRedone',name:'Partner Channel',description:'Bot partner channel'}
    ];
    
    let channelsHTML='';
    requiredChannels.forEach(channel=>{
        channelsHTML+=`<div class="support-channel-card" onclick="window.open('${channel.link}','_blank')" style="margin-bottom:10px;">
            <div style="display:flex;align-items:center;gap:12px;">
                <div style="width:50px;height:50px;background:linear-gradient(135deg,#a855f7,#7c3aed);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:white;">
                    <i class="fab fa-telegram"></i>
                </div>
                <div style="flex:1;">
                    <div style="font-size:14px;font-weight:700;color:white;margin-bottom:5px;">${channel.name}</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:3px;">${channel.description}</div>
                    <div style="font-size:10px;color:#FFC107;"><i class="fa-solid fa-users"></i> ${channel.username}</div>
                </div>
                <div style="color:var(--primary-green);font-size:18px;">
                    <i class="fa-solid fa-external-link-alt"></i>
                </div>
            </div>
        </div>`;
    });
    
    const subscriptionHTML=`<div style="padding:20px;max-width:500px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;justify-content:center;">
        <div class="card" style="text-align:center;">
            <img src="https://i.ibb.co/tTkJX1Qy/logo.png" alt="GLX Galaxy" style="width:80px;height:80px;border-radius:50%;margin-bottom:15px;border:3px solid var(--primary-green);">
            <h1 style="font-size:24px;margin-bottom:8px;color:#fff;">‚ö†Ô∏è Subscription Required</h1>
            <p style="color:var(--text-muted);margin-bottom:20px;font-size:14px;">You must subscribe to all channels below to access GLX Galaxy</p>
            <div style="background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.3);border-radius:12px;padding:12px;margin-bottom:20px;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <div style="color:#e74c3c;font-size:18px;"><i class="fa-solid fa-triangle-exclamation"></i></div>
                    <div style="font-size:12px;color:#e74c3c;"><strong>Important:</strong> Join all channels and stay subscribed to use the bot</div>
                </div>
            </div>
            <div style="text-align:left;margin-bottom:25px;">
                <h2 style="font-size:16px;color:var(--gold);margin-bottom:15px;display:flex;align-items:center;gap:8px;">
                    <i class="fa-solid fa-list-check"></i> Required Channels (4)
                </h2>
                ${channelsHTML}
            </div>
            <button class="btn btn-primary" onclick="verifySubscriptions()" style="margin-bottom:10px;padding:15px;">
                <i class="fa-solid fa-check-circle"></i> I'VE SUBSCRIBED TO ALL CHANNELS
            </button>
            <p style="font-size:11px;color:var(--text-muted);margin-top:15px;">After subscribing, click the button above to verify</p>
        </div>
    </div>`;
    
    document.getElementById('app-container').innerHTML=subscriptionHTML;
    document.getElementById('app-container').style.display='block';
}

async function verifySubscriptions(){
    const userId=window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    if(!userId)return;
    
    const verifyBtn=document.querySelector('button[onclick="verifySubscriptions()"]');
    if(verifyBtn){
        verifyBtn.disabled=true;
        verifyBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> VERIFYING...';
    }
    
    showNotification("‚è≥ Verifying your subscriptions...","info");
    
    try{
        const result=await callAPI('checkMandatorySubscriptions',{userId:userId});
        if(result.success&&result.data){
            if(result.data.allSubscribed===true){
                showNotification("‚úÖ All subscriptions verified! Loading app...","success");
                setTimeout(()=>{
                    location.reload();
                },2000);
            }else{
                const unsubscribedChannels=result.data?.missingChannels||[];
                let errorMessage="You need to subscribe to all channels:";
                unsubscribedChannels.forEach(channel=>{
                    errorMessage+=`\n- ${channel}`;
                });
                showNotification(errorMessage,"error");
                if(verifyBtn){
                    verifyBtn.disabled=false;
                    verifyBtn.innerHTML='<i class="fa-solid fa-check-circle"></i> I\'VE SUBSCRIBED TO ALL CHANNELS';
                }
            }
        }else{
            showNotification("Error verifying subscriptions. Please try again.","error");
            if(verifyBtn){
                verifyBtn.disabled=false;
                verifyBtn.innerHTML='<i class="fa-solid fa-check-circle"></i> I\'VE SUBSCRIBED TO ALL CHANNELS';
            }
        }
    }catch(error){
        console.error("Verification error:",error);
        showNotification("Error verifying subscriptions. Please try again.","error");
        if(verifyBtn){
            verifyBtn.disabled=false;
            verifyBtn.innerHTML='<i class="fa-solid fa-check-circle"></i> I\'VE SUBSCRIBED TO ALL CHANNELS';
        }
    }
}

async function finishLoading(){
    const loadingPage=document.getElementById('global-loading-page');
    try{
        const isSubscribed=await checkMandatorySubscriptions();
        if(!isSubscribed){
            if(loadingPage){
                loadingPage.style.display='none';
            }
            showMandatorySubscriptionScreen();
            return;
        }
        
        const isTelegramEnv=window.location.hostname.includes('web.telegram.org')||window.location.hostname.includes('t.me')||(window.Telegram&&window.Telegram.WebApp);
        if(!isTelegramEnv){
            console.log("Not in Telegram environment, but continuing anyway");
        }
        
        if(window.Telegram?.WebApp?.initDataUnsafe?.user){
            const tgUser=window.Telegram.WebApp.initDataUnsafe.user;
            const blockCheck=await checkUserBlockStatus();
            if(blockCheck&&blockCheck.success===false&&blockCheck.error==='ACCOUNT_BLOCKED'){
                const blockedMessage=blockCheck.data?.blockedMessage||"Your account has been suspended due to violation of our terms of service.";
                console.log("Account blocked:",blockedMessage);
                showNotification(blockedMessage,"error");
                return;
            }
            
            try{
                const checkResult=await simulateAccountCheck(tgUser.id.toString());
                if(checkResult.blocked){
                    console.log("Account blocked by security check");
                    showNotification("Your account has been suspended.","error");
                    return;
                }
            }catch(error){
                console.error("Account check error:",error);
            }
        }else{
            console.log("Telegram user authentication failed");
        }
        
        showMainApp();
    }catch(error){
        console.error("Loading error:",error);
        showMainApp();
        showNotification("Loading completed with some limitations.","warning");
    }finally{
        if(loadingPage){
            loadingPage.style.display='none';
        }
    }
}

async function simulateAccountCheck(userId){
    await new Promise(resolve=>setTimeout(resolve,1000));
    return{
        blocked:false,
        status:"active",
        lastLogin:Date.now(),
        isBlocked:false
    };
}

const API_RealEarnBot_bot="https://silent-block-bedf.ahmedrabieharoun.workers.dev";

async function callAPI(action,data={}){
    if(action==='handleAdClick'){
        console.error("Direct handleAdClick calls are blocked.");
        logSecurityEvent('BLOCKED_DIRECT_AD_REQUEST',{action:action,data:data});
        return{success:false,error:'DIRECT_AD_CALL_BLOCKED',message:'Use secure ad request system'};
    }
    
    try{
        const userId=window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
        const response=await fetch(`${API_RealEarnBot_bot}/api`,{
            method:'POST',
            headers:{
                'Content-Type':'application/json',
                'X-User-ID':userId||'',
                'X-Telegram-Data':window.Telegram?.WebApp?.initData||'',
                'X-Action':action
            },
            body:JSON.stringify({
                action:action,
                data:data,
                userId:userId,
                timestamp:Date.now()
            })
        });
        
        if(!response.ok){
            throw new Error(`API Error: ${response.status}`);
        }
        
        const result=await response.json();
        
        if(!result.success&&result.error&&result.error==='ACCOUNT_BLOCKED'){
            console.log("Account blocked:",result.data?.blockedMessage);
            showNotification("Your account has been blocked.","error");
            return{success:false,error:'ACCOUNT_BLOCKED',data:result.data};
        }
        
        if(!result.success&&result.error&&result.error.includes('Connection error')){
            console.log("Connection error");
            showNotification("Connection error. Please try again.","error");
            return{success:false,error:result.error};
        }
        
        if(action==='flipCoin'&&result.success){
            if(!result.data.currentBalance){
                result.data.currentBalance=result.data.newBalance||result.data.finalBalance;
            }
        }
        
        if(action==='getCompetitionData'&&result.success){
            if(result.data.competitionData&&!result.data.competitionData.userTickets){
                result.data.competitionData.userTickets={};
            }
        }
        
        return result;
    }catch(error){
        console.error('API call failed:',error);
        if(error.message&&error.message.includes('Connection error')||error.message&&error.message.includes('Failed to fetch')){
            console.log("Connection error occurred");
            showNotification("Connection error. Please try again.","error");
        }else{
            showNotification("Connection error. Please try again.","error");
        }
        return{success:false,error:error.message};
    }
}

async function flipCoin(){
    if(coinGame.isFlipping)return;
    const betAmount=coinGame.betAmount;
    const currentBalance=appData.dogsBalance||0;
    if(betAmount<1000){
        showNotification("Minimum bet is 1,000 GLX","warning");
        return;
    }
    if(betAmount>currentBalance){
        showNotification("Insufficient GLX balance","warning");
        return;
    }
    
    const isAllowed=await checkBeforeAction("flip coin");
    if(!isAllowed)return;
    
    const flipButton=document.getElementById('flip-coin-btn');
    if(flipButton){
        flipButton.disabled=true;
        flipButton.classList.add('coin-flip-btn-processing');
        flipButton.innerHTML='<i class="fas fa-spinner fa-spin"></i> PROCESSING...';
    }
    
    coinGame.isFlipping=true;
    
    try{
        const result=await callAPI('flipCoin',{
            betAmount:betAmount,
            chosenSide:coinGame.chosenSide
        });
        
        if(result.success){
            const isWin=result.data.isWin;
            const resultSide=result.data.resultSide;
            const winAmount=result.data.winAmount||0;
            const betAmountNum=result.data.betAmount||betAmount;
            
            appData.dogsBalance=result.data.currentBalance;
            renderUI({id:window.Telegram?.WebApp?.initDataUnsafe?.user?.id});
            
            const coin=document.getElementById('coin');
            if(coin){
                coin.classList.remove('coin-spinning','coin-final');
                coin.style.transition='transform 2.5s cubic-bezier(0.4,2.4,0.8,0.9)';
                const finalRotation=resultSide==='glx'?720:900;
                coin.style.setProperty('--final-rotation',finalRotation+'deg');
                coin.classList.add('coin-spinning');
                
                setTimeout(()=>{
                    coin.classList.remove('coin-spinning');
                    coin.classList.add('coin-final');
                    coin.style.transform=`rotateY(${finalRotation}deg)`;
                    
                    showCoinFlipResult(isWin,resultSide,betAmountNum,winAmount,finalRotation);
                    
                    if(isWin){
                        const netProfit=winAmount-betAmountNum;
                        setTimeout(()=>{
                            showNotification(`üéâ You won ${winAmount.toLocaleString()} GLX! (Net Profit: +${netProfit.toLocaleString()} GLX)`,"success");
                        },500);
                    }else{
                        setTimeout(()=>{
                            showNotification(`üò¢ You lost ${betAmountNum.toLocaleString()} GLX`,"error");
                        },500);
                    }
                },2500);
            }
        }else{
            if(result.error==='ACCOUNT_BLOCKED'){
                showNotification("Your account has been blocked.","error");
            }else{
                showNotification("Error: "+result.error,"error");
            }
        }
    }catch(error){
        console.error("Coin flip error:",error);
        showNotification("Error flipping coin. Please try again.","error");
    }finally{
        setTimeout(()=>{
            coinGame.isFlipping=false;
            if(flipButton){
                flipButton.disabled=false;
                flipButton.classList.remove('coin-flip-btn-processing');
                flipButton.innerHTML='<i class="fa-solid fa-play"></i> FLIP COIN';
            }
        },3000);
    }
}

function showCoinFlipResult(isWin,resultSide,betAmount,winAmount,finalRotation){
    const resultElement=document.getElementById('coin-game-result');
    const resultText=document.getElementById('coin-result-text');
    const winAmountElement=document.getElementById('coin-win-amount');
    const lossAmountElement=document.getElementById('coin-loss-amount');
    
    winAmountElement.style.display='none';
    lossAmountElement.style.display='none';
    
    if(isWin){
        const netProfit=winAmount-betAmount;
        resultText.innerHTML=`üéâ <strong>YOU WIN!</strong><br>${coinGame.chosenSide.toUpperCase()} appeared!<br><small>Net Profit: <span class="net-profit">+${netProfit.toLocaleString()} GLX</span></small>`;
        resultText.style.color='#27ae60';
        
        winAmountElement.innerHTML=`+${winAmount.toLocaleString()} GLX<br><small style="font-size:12px;opacity:0.8;">(Bet: ${betAmount.toLocaleString()} GLX)</small>`;
        winAmountElement.style.display='block';
        
        const selectedBtn=coinGame.chosenSide==='glx'?document.getElementById('choose-glx'):document.getElementById('choose-gold');
        selectedBtn.classList.add('win');
        selectedBtn.classList.remove('active');
    }else{
        resultText.innerHTML=`üò¢ <strong>YOU LOSE</strong><br>${resultSide.toUpperCase()} appeared<br><small>Loss: <span class="net-loss">${betAmount.toLocaleString()} GLX</span></small>`;
        resultText.style.color='#e74c3c';
        
        lossAmountElement.textContent=`-${betAmount.toLocaleString()} GLX`;
        lossAmountElement.style.display='block';
        
        const selectedBtn=coinGame.chosenSide==='glx'?document.getElementById('choose-glx'):document.getElementById('choose-gold');
        selectedBtn.classList.add('lose');
        selectedBtn.classList.remove('active');
    }
    
    resultElement.style.display='block';
}

async function handleDailyClaim(){
    const isAllowed=await checkBeforeAction("claim daily bonus");
    if(!isAllowed)return;
    
    const claimButton=document.getElementById('claim-daily-btn');
    if(!claimButton)return;
    
    claimButton.disabled=true;
    claimButton.classList.add('btn-processing');
    claimButton.innerHTML='<i class="fas fa-spinner fa-spin"></i> PROCESSING...';
    
    try{
        const result=await callAPI('claimDailyBonus');
        if(result.success){
            appData.lastDailyClaim=result.data.lastDailyClaim;
            appData.dailyStreak=result.data.dailyStreak;
            appData.dogsBalance=result.data.newBalance;
            
            showNotification(`üéâ Daily bonus claimed! +${result.data.reward} GLX`,"success");
            renderDailyBonusUI();
            renderUI({id:window.Telegram?.WebApp?.initDataUnsafe?.user?.id});
        }else{
            if(result.error==='ACCOUNT_BLOCKED'){
                showNotification("Your account has been blocked.","error");
            }else{
                showNotification("Error: "+result.error,"error");
            }
        }
    }catch(error){
        console.error("Daily claim error:",error);
        showNotification("Error claiming daily bonus","error");
    }finally{
        setTimeout(()=>{
            if(claimButton){
                claimButton.disabled=false;
                claimButton.classList.remove('btn-processing');
                claimButton.textContent="Claim Bonus";
            }
        },2000);
    }
}

const SECURITY_CONFIG={
    errorStyle:{
        background:'rgba(231,76,60,0.1)',
        border:'1px solid rgba(231,76,60,0.3)',
        color:'#e74c3c',
        borderRadius:'12px',
        padding:'15px',
        margin:'15px 0'
    },
    warningStyle:{
        background:'rgba(255,193,7,0.1)',
        border:'1px solid rgba(255,193,7,0.3)',
        color:'#FFC107',
        borderRadius:'12px',
        padding:'15px',
        margin:'15px 0'
    },
    successStyle:{
        background:'rgba(39,174,96,0.1)',
        border:'1px solid rgba(39,174,96,0.3)',
        color:'#27ae60',
        borderRadius:'12px',
        padding:'15px',
        margin:'15px 0'
    },
    infoStyle:{
        background:'rgba(52,152,219,0.1)',
        border:'1px solid rgba(52,152,219,0.3)',
        color:'#3498db',
        borderRadius:'12px',
        padding:'15px',
        margin:'15px 0'
    }
};

const APP_CONFIG={
    botUsername:'RealEarnBot_bot',
    botWallet:'UQB2IqqJtC8NtRgxksq80c_FC8RqShxpGDKA3e4aJFwjvwgv',
    botToken:'7066931017:AAHwuXbgaKHNrHrbf6jaoC8LDk0lSCPimgI',
    defaultSettings:{
        adRewardMonetag:500,
        adRewardGiga:500,
        adRewardAdsgram:500,
        limitMonetag:50,
        limitGiga:300,
        limitAdsgram:300,
        minTonWithdrawal:0.05,
        minFaucetPayWithdrawal:0.0001,
        referralReward:100000,
        pricePerClick:0.0015,
        glxToTonRate:0.0000001,
        tonToGlxRate:10000000,
        ticketPrice:10000,
        ticketTonValue:0.0001,
        competitionDuration:24*60*60*1000,
        breakDuration:60*60*1000,
        dailyRewards:[2000,3000,5000,7000,9000,12000,15000],
        coinFlipWinChance:45,
        slotsPayouts:{
            'üåüüåüüåü':10000,
            'ü™êü™êü™ê':5000,
            'üí´üí´üí´':2500,
            '‚≠ê‚≠ê‚≠ê':1200,
            'üåüüåü':700,
            'default':500
        },
        promoCodeRewards:5000,
        dailyWithdrawalLimit:2
    }
};

const BOT_USERNAME=APP_CONFIG.botUsername;
const BOT_WALLET=APP_CONFIG.botWallet;
const BOT_TOKEN=APP_CONFIG.botToken;

const firebaseConfig={
    apiKey:"YOUR_API_KEY_HERE",
    authDomain:"YOUR_PROJECT_ID.firebaseapp.com",
    projectId:"YOUR_PROJECT_ID",
    storageBucket:"YOUR_PROJECT_ID.appspot.com",
    messagingSenderId:"YOUR_SENDER_ID",
    appId:"YOUR_APP_ID"
};

let db=null;
try{
    if(firebase&&firebase.initializeApp){
        firebase.initializeApp(firebaseConfig);
        db=firebase.firestore();
        console.log("‚úÖ Firebase initialized successfully");
    }
}catch(error){
    console.error("‚ùå Firebase initialization error:",error);
}

function showNotification(message,type='info',duration=5000){
    const notification=document.createElement('div');
    notification.className=`notification-message notification-${type}`;
    notification.innerHTML=`<div style="font-size:14px;font-weight:600;">${message}</div>`;
    document.body.appendChild(notification);
    
    setTimeout(()=>{
        notification.style.animation='fadeOut 0.3s ease';
        setTimeout(()=>{
            if(notification.parentNode){
                notification.parentNode.removeChild(notification);
            }
        },300);
    },duration);
}

function showStyledMessage(message,type='error',containerId='app-container'){
    const container=document.getElementById(containerId);
    if(!container)return;
    
    const existingMsg=container.querySelector('.security-message');
    if(existingMsg)existingMsg.remove();
    
    const messageDiv=document.createElement('div');
    messageDiv.className='security-message';
    const style=SECURITY_CONFIG[type+'Style']||SECURITY_CONFIG.errorStyle;
    Object.assign(messageDiv.style,style);
    
    let icon='‚ùå';
    if(type==='warning')icon='‚ö†Ô∏è';
    if(type==='success')icon='‚úÖ';
    if(type==='info')icon='‚ÑπÔ∏è';
    
    messageDiv.innerHTML=`<div style="display:flex;align-items:center;gap:10px;font-size:14px;">
        <div style="font-size:20px;">${icon}</div>
        <div>${message}</div>
    </div>`;
    
    container.insertBefore(messageDiv,container.firstChild);
    
    setTimeout(()=>{
        if(messageDiv.parentNode){
            messageDiv.style.opacity='0';
            messageDiv.style.transition='opacity 0.5s';
            setTimeout(()=>{
                if(messageDiv.parentNode){
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            },500);
        }
    },5000);
    
    return messageDiv;
}

function isTelegramMobileApp(){
    const userAgent=navigator.userAgent.toLowerCase();
    return userAgent.includes('telegram')||userAgent.includes('webview');
}

function isTelegramWeb(){
    const hostname=window.location.hostname;
    return hostname.includes('web.telegram.org')||hostname.includes('t.me')||hostname.includes('telegram.me');
}

function createVerificationStep(stepNumber,title,description,status='pending'){
    let icon='üîí';
    let statusIcon='<div class="verification-loading"></div>';
    let statusClass='';
    
    if(status==='completed'){
        icon='‚úÖ';
        statusIcon='‚úì';
        statusClass='completed';
    }else if(status==='failed'){
        icon='‚ùå';
        statusIcon='‚úó';
        statusClass='failed';
    }else if(status==='active'){
        icon='‚è≥';
        statusClass='active';
    }
    
    return `<div class="verification-step ${statusClass}">
        <div class="step-icon">${icon}</div>
        <div class="step-info">
            <div class="step-title">${title}</div>
            <div class="step-description">${description}</div>
        </div>
        <div class="step-status">${statusIcon}</div>
    </div>`;
}

async function performSecurityVerification(){
    const stepsContainer=document.getElementById('verification-steps');
    const progressBar=document.getElementById('verification-progress-bar');
    const resultContainer=document.getElementById('verification-result');
    
    stepsContainer.innerHTML=createVerificationStep(1,'Telegram Check','Verifying Telegram environment','active');
    progressBar.style.width='20%';
    
    const isTelegramWeb=window.location.hostname.includes('web.telegram.org')||window.location.hostname.includes('t.me');
    const isTelegramWebApp=window.Telegram&&window.Telegram.WebApp;
    
    if(!isTelegramWeb&&!isTelegramWebApp){
        console.log("Not in Telegram environment");
        return null;
    }
    
    stepsContainer.innerHTML=createVerificationStep(1,'Telegram Check','Telegram environment verified','completed');
    progressBar.style.width='40%';
    
    await new Promise(resolve=>setTimeout(resolve,800));
    
    stepsContainer.innerHTML+=createVerificationStep(2,'Device Security','Generating device fingerprint','active');
    progressBar.style.width='60%';
    
    const deviceFingerprint=await generateDeviceFingerprint();
    console.log("Device Fingerprint:",deviceFingerprint);
    
    stepsContainer.innerHTML=createVerificationStep(1,'Telegram Check','Telegram environment verified','completed');
    stepsContainer.innerHTML+=createVerificationStep(2,'Device Security','Device fingerprint generated','completed');
    progressBar.style.width='80%';
    
    stepsContainer.innerHTML+=createVerificationStep(3,'User Authentication','Loading Telegram user data','active');
    progressBar.style.width='100%';
    
    let user=null;
    let isExisting=false;
    
    if(window.Telegram?.WebApp?.initDataUnsafe?.user){
        const tgUser=window.Telegram.WebApp.initDataUnsafe.user;
        user={
            id:tgUser.id.toString(),
            first_name:tgUser.first_name,
            last_name:tgUser.last_name||'',
            username:tgUser.username||''
        };
        isExisting=true;
        user.deviceFingerprint=deviceFingerprint;
        
        stepsContainer.innerHTML=createVerificationStep(1,'Telegram Check','Telegram environment verified','completed');
        stepsContainer.innerHTML+=createVerificationStep(2,'Device Security','Device fingerprint generated','completed');
        stepsContainer.innerHTML+=createVerificationStep(3,'User Authentication','Telegram user authenticated','completed');
        
        resultContainer.innerHTML=`<div style="background:rgba(39,174,96,0.1);border:1px solid rgba(39,174,96,0.3);border-radius:12px;padding:15px;text-align:center;">
            <div style="font-size:20px;margin-bottom:10px;">‚úÖ</div>
            <div style="font-weight:700;color:#27ae60;margin-bottom:5px;">Security Verified</div>
            <div style="font-size:12px;color:var(--text-muted);">Welcome, ${user.first_name}!</div>
        </div>`;
    }else{
        stepsContainer.innerHTML=createVerificationStep(1,'Telegram Check','Telegram environment verified','completed');
        stepsContainer.innerHTML+=createVerificationStep(2,'Device Security','Device fingerprint generated','completed');
        stepsContainer.innerHTML+=createVerificationStep(3,'User Authentication','Telegram user not found','failed');
        console.log("Telegram user authentication failed");
        return null;
    }
    
    await new Promise(resolve=>setTimeout(resolve,1500));
    
    return{user,isExisting,deviceFingerprint};
}

function showBlockedAccess(reason){
    document.getElementById('security-verification').style.display='none';
    document.getElementById('blocked-access').style.display='block';
    document.getElementById('blocked-reason').innerHTML=reason;
}

function showMainApp(){
    document.getElementById('global-loading-page').style.display='none';
    document.getElementById('security-verification').style.display='none';
    document.getElementById('blocked-access').style.display='none';
    document.getElementById('app-container').style.display='block';
}

const GLX_TO_TON_RATE=0.0000001;
const TON_TO_GLX_RATE=10000000;
const TICKET_PRICE=10000;
const TICKET_TON_VALUE=0.001;
const COMPETITION_DURATION=24*60*60*1000;
const BREAK_DURATION=60*60*1000;
const ADSGRAM_BLOCK_ID='int-18879';

let appData={};
let appSettings={...APP_CONFIG.defaultSettings};
let isAdScriptLoaded=false;
let isLeaderboardLoaded=false;
let AdController=null;
let selectedCategory='channel';
let selectedCount=100;
let selectedCost=0.15;
let currentTaskId='';
let depositTransactionId='';
let isSpinning=false;
const slotsSymbols=['üåü','ü™ê','üí´','‚≠ê','üöÄ','üåå'];
const slotsPayouts={
    'üåüüåüüåü':10000,
    'ü™êü™êü™ê':5000,
    'üí´üí´üí´':2500,
    '‚≠ê‚≠ê‚≠ê':1200,
    'üåüüåü':700,
    'default':500
};

let coinGame={
    isFlipping:false,
    chosenSide:'glx',
    betAmount:1000,
    lastFlipResult:null,
    winChance:45,
    lossChance:55,
    currentRotation:0,
    animationId:null
};

let withdrawalType='faucetpay';
let swapDirection='glx_to_ton';
let countdownInterval=null;
let competitionData={
    isActive:true,
    startTime:Date.now(),
    endTime:Date.now()+COMPETITION_DURATION,
    totalTickets:0,
    prizePool:0,
    userTickets:{},
    winners:[]
};

let lastAdClickTime=0;
const AD_CLICK_DELAY=3000;

let gigaAdRequired=false;
let gigaAdCallback=null;

let dailyWithdrawals={
    count:0,
    lastReset:Date.now(),
    limit:2
};

function showGigaAdBeforeAction(actionName,callback){
    if(typeof window.showGiga==='function'){
        gigaAdRequired=true;
        gigaAdCallback=callback;
        showNotification(`Please watch an ad to ${actionName}`,"info");
        
        window.showGiga().then(()=>{
            gigaAdRequired=false;
            if(gigaAdCallback){
                gigaAdCallback();
                gigaAdCallback=null;
            }
        }).catch(()=>{
            showNotification("Ad failed or was skipped","warning");
            gigaAdRequired=false;
            gigaAdCallback=null;
        });
    }else{
        callback();
    }
}

function protectedDailyClaim(){
    if(gigaAdRequired){
        showNotification("Please complete the ad first","warning");
        return;
    }
    showGigaAdBeforeAction("claim daily bonus",handleDailyClaim);
}

async function handlePromoCode(){
    const isAllowed=await checkBeforeAction("redeem promo code");
    if(!isAllowed)return;
    
    const codeInput=document.getElementById('promo-code-input');
    const resultDiv=document.getElementById('promo-result');
    const redeemBtn=document.getElementById('redeem-code-btn');
    
    if(!codeInput||!resultDiv||!redeemBtn)return;
    
    const code=codeInput.value.trim().toUpperCase();
    if(!code){
        showPromoResult('Please enter a promo code','error');
        return;
    }
    
    redeemBtn.disabled=true;
    redeemBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Checking...';
    
    const result=await callAPI('redeemPromoCode',{code:code});
    
    if(result.success){
        const rewardType=result.data.rewardType||'glx';
        const reward=result.data.reward;
        
        if(rewardType==='glx'){
            appData.dogsBalance=result.data.newBalance;
            showPromoResult(`üéâ Success! You got +${reward} GLX`,'success');
        }else if(rewardType==='ton'){
            appData.tonBalance=result.data.newTONBalance;
            showPromoResult(`üéâ Success! You got +${reward} TON`,'success');
        }else if(rewardType==='ticket'){
            appData.competitionTickets=(appData.competitionTickets||0)+reward;
            showPromoResult(`üéâ Success! You got +${reward} Competition Ticket(s)`,'success');
            
            if(competitionData&&competitionData.userTickets){
                const userId=window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
                if(userId){
                    competitionData.userTickets[userId]=(competitionData.userTickets[userId]||0)+reward;
                    competitionData.totalTickets=(competitionData.totalTickets||0)+reward;
                    competitionData.prizePool=competitionData.totalTickets*TICKET_TON_VALUE;
                }
            }
        }
        
        codeInput.value='';
        renderUI({id:window.Telegram?.WebApp?.initDataUnsafe?.user?.id});
        if(rewardType==='ticket'){
            updateCompetitionUI();
        }
    }else{
        if(result.error==='ACCOUNT_BLOCKED'){
            showNotification("Your account has been blocked.","error");
        }else{
            showPromoResult('‚ùå '+result.error,'error');
        }
    }
    
    redeemBtn.disabled=false;
    redeemBtn.innerHTML='<i class="fa-solid fa-gift"></i> Redeem';
}

function showPromoResult(message,type){
    const resultDiv=document.getElementById('promo-result');
    if(!resultDiv)return;
    
    resultDiv.textContent=message;
    resultDiv.style.display='block';
    
    if(type==='success'){
        resultDiv.style.background='rgba(39,174,96,0.2)';
        resultDiv.style.border='1px solid rgba(39,174,96,0.5)';
        resultDiv.style.color='#27ae60';
    }else if(type==='error'){
        resultDiv.style.background='rgba(231,76,60,0.2)';
        resultDiv.style.border='1px solid rgba(231,76,60,0.5)';
        resultDiv.style.color='#e74c3c';
    }else{
        resultDiv.style.background='rgba(255,193,7,0.2)';
        resultDiv.style.border='1px solid rgba(255,193,7,0.5)';
        resultDiv.style.color='#FFC107';
    }
    
    setTimeout(()=>{
        resultDiv.style.display='none';
    },5000);
}

async function fetchAppSettings(){
    if(!db){
        console.log("Firebase not available, using default settings");
        return appSettings;
    }
    
    try{
        const doc=await db.collection('settings').doc('appSettings').get();
        if(doc.exists){
            const firebaseSettings=doc.data();
            const updatedSettings={...appSettings,...firebaseSettings};
            console.log("‚úÖ Settings loaded from Firebase:",updatedSettings);
            return updatedSettings;
        }else{
            console.log("No settings found in Firebase, using defaults");
            return appSettings;
        }
    }catch(error){
        console.error("Error fetching settings from Firebase:",error);
        return appSettings;
    }
}

async function getUpdatedSettings(){
    const newSettings=await fetchAppSettings();
    appSettings=newSettings;
    return newSettings;
}

async function initializeUser(user,deviceFingerprint){
    const isNewUser=await callAPI('checkIsNewUser',{userId:user.id});
    if(isNewUser.success&&isNewUser.data.isNew){
        const fingerprintCheck=await callAPI('checkDeviceFingerprint',{userId:user.id,deviceFingerprint:deviceFingerprint});
        if(!fingerprintCheck.success){
            console.log("Device security check failed");
            return;
        }
        if(fingerprintCheck.data&&fingerprintCheck.data.deviceLimitExceeded){
            console.log("Multiple accounts detected from same device");
            return;
        }
        const saveResult=await callAPI('saveDeviceFingerprint',{userId:user.id,deviceFingerprint:deviceFingerprint});
        if(!saveResult.success){
            console.warn("Failed to save device fingerprint:",saveResult.error);
        }
    }
    
    const result=await callAPI('initializeUser',{user,deviceFingerprint:deviceFingerprint});
    if(result.success){
        appData=result.data.userData||{};
        await getUpdatedSettings();
        await loadDailyWithdrawalsData();
        renderUI(user);
        renderDailyBonusUI();
        updateAvailableSpins();
        handleReferral(user);
    }else{
        if(result.error&&result.error.includes('banned')){
            console.log("Account banned");
            return;
        }
        console.error('Error initializing user:',result.error);
    }
}

async function loadDailyWithdrawalsData(){
    const userId=window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    if(!userId)return;
    
    try{
        const result=await callAPI('getDailyWithdrawals',{userId:userId});
        if(result.success){
            dailyWithdrawals={
                count:result.data.todayWithdrawals||0,
                lastReset:result.data.lastReset||Date.now(),
                limit:appSettings.dailyWithdrawalLimit||2
            };
            updateWithdrawalsCounterUI();
            checkWithdrawalLimit();
        }
    }catch(error){
        console.error("Error loading daily withdrawals:",error);
    }
}

function updateWithdrawalsCounterUI(){
    const counterElement=document.getElementById('daily-withdrawals-counter');
    const countElement=document.getElementById('today-withdrawals-count');
    const timerElement=document.getElementById('withdraw-reset-timer');
    
    if(!counterElement||!countElement||!timerElement)return;
    
    countElement.textContent=dailyWithdrawals.count;
    updateWithdrawalsResetTimer();
    
    if(dailyWithdrawals.count>=dailyWithdrawals.limit){
        counterElement.style.background='rgba(231,76,60,0.2)';
        counterElement.style.borderColor='rgba(231,76,60,0.3)';
        countElement.style.color='#e74c3c';
        timerElement.style.color='#ffb3b3';
    }else{
        counterElement.style.background='rgba(168,85,247,0.2)';
        counterElement.style.borderColor='rgba(168,85,247,0.3)';
        countElement.style.color='var(--primary-green)';
        timerElement.style.color='#FFC107';
    }
}

function updateWithdrawalsResetTimer(){
    const timerElement=document.getElementById('withdraw-reset-timer');
    if(!timerElement)return;
    
    const now=Date.now();
    const nextReset=dailyWithdrawals.lastReset+(24*60*60*1000);
    const timeLeft=nextReset-now;
    
    if(timeLeft<=0){
        timerElement.textContent="Resets now!";
        resetDailyWithdrawals();
    }else{
        const hours=Math.floor(timeLeft/(1000*60*60));
        const minutes=Math.floor((timeLeft%(1000*60*60))/(1000*60));
        timerElement.textContent=`Resets in: ${hours}h ${minutes}m`;
    }
}

async function resetDailyWithdrawals(){
    dailyWithdrawals.count=0;
    dailyWithdrawals.lastReset=Date.now();
    updateWithdrawalsCounterUI();
    checkWithdrawalLimit();
    
    const userId=window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    if(userId){
        try{
            await callAPI('resetDailyWithdrawals',{userId:userId,resetTime:dailyWithdrawals.lastReset});
        }catch(error){
            console.error("Error resetting daily withdrawals:",error);
        }
    }
}

function checkWithdrawalLimit(){
    const faucetpayBtn=document.getElementById('withdraw-faucetpay-btn');
    const tonwalletBtn=document.getElementById('withdraw-ton-now-btn');
    
    const isLimitReached=dailyWithdrawals.count>=dailyWithdrawals.limit;
    
    if(faucetpayBtn){
        if(isLimitReached){
            faucetpayBtn.disabled=true;
            faucetpayBtn.classList.add('withdraw-disabled');
            faucetpayBtn.classList.add('daily-limit-reached');
            faucetpayBtn.innerHTML='<i class="fa-solid fa-ban"></i> DAILY LIMIT REACHED (2/2)';
        }else{
            faucetpayBtn.disabled=false;
            faucetpayBtn.classList.remove('withdraw-disabled');
            faucetpayBtn.classList.remove('daily-limit-reached');
            faucetpayBtn.innerHTML='<i class="fa-solid fa-paper-plane"></i> WITHDRAW VIA FAUCETPAY';
        }
    }
    
    if(tonwalletBtn){
        if(isLimitReached){
            tonwalletBtn.disabled=true;
            tonwalletBtn.classList.add('withdraw-disabled');
            tonwalletBtn.classList.add('daily-limit-reached');
            tonwalletBtn.innerHTML='<i class="fa-solid fa-ban"></i> DAILY LIMIT REACHED (2/2)';
        }else{
            tonwalletBtn.disabled=false;
            tonwalletBtn.classList.remove('withdraw-disabled');
            tonwalletBtn.classList.remove('daily-limit-reached');
            tonwalletBtn.innerHTML='<i class="fa-solid fa-wallet"></i> WITHDRAW TO TON WALLET';
        }
    }
    
    return!isLimitReached;
}

async function incrementDailyWithdrawals(){
    dailyWithdrawals.count++;
    updateWithdrawalsCounterUI();
    checkWithdrawalLimit();
    
    const userId=window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    if(userId){
        try{
            await callAPI('incrementDailyWithdrawals',{userId:userId,count:dailyWithdrawals.count});
        }catch(error){
            console.error("Error incrementing daily withdrawals:",error);
        }
    }
}

function initializeApp(user){
    const fullName=`${user.first_name} ${user.last_name}`.trim();
    document.getElementById('home-username').textContent=fullName;
    document.getElementById('referral-link-display').textContent=`https://t.me/${BOT_USERNAME}?startapp=ref${user.id}`;
    
    if(SecuritySystem&&typeof SecuritySystem.initialize==='function'){
        SecuritySystem.initialize().then(success=>{
            if(success){
                console.log("‚úÖ Security system initialized for user");
            }else{
                console.warn("‚ö†Ô∏è Security system initialization failed");
            }
        }).catch(error=>{
            console.error("‚ùå Security system error:",error);
        });
    }
    
    if(window.Adsgram){
        AdController=window.Adsgram.init({blockId:ADSGRAM_BLOCK_ID});
    }
    
    setupEventListeners(user);
    setupGalaxyLogButton();
    renderCreateTaskUI();
    initSlotsGame();
    initCoinFlipGame();
    initPromoCodes();
    
    setTimeout(()=>{
        isAdScriptLoaded=typeof show_10058786==="function";
    },2500);
    
    selectWithdrawalType('faucetpay');
    selectSwapDirection('glx_to_ton');
    
    const ticketInput=document.getElementById('ticket-amount');
    if(ticketInput){
        ticketInput.addEventListener('input',updateTicketCostDisplay);
        updateTicketCostDisplay();
    }
    
    initializeCompetition();
    loadUserCompetitionData();
    
    setInterval(updateWithdrawalsResetTimer,60000);
    
    if(SecuritySystem){
        SecuritySystem.logSecurityEvent('APP_INITIALIZED',{
            userId:user.id,
            userName:fullName,
            timestamp:new Date().toISOString()
        });
    }
}

async function handleReferral(user){
    const tg=window.Telegram?.WebApp;
    const startParam=tg?.initDataUnsafe?.start_param;
    if(startParam&&startParam.startsWith('ref')){
        const referrerId=startParam.replace('ref','');
        if(referrerId&&referrerId!==user.id){
            const result=await callAPI('handleReferral',{
                userId:user.id,
                referrerId:referrerId,
                rewardAmount:100000
            });
            if(result.success){
                showNotification("üéâ Welcome bonus activated! +100K GLX","success");
            }
        }
    }
}

function renderUI(user){
    if(!appData)return;
    
    const GLX=Math.floor(appData.dogsBalance||0);
    const ton=(appData.tonBalance||0).toFixed(7);
    const userLevel=getLevel(GLX);
    
    document.getElementById('home-user-level').textContent=`Level ${userLevel}`;
    document.getElementById('total-GLX-balance').textContent=GLX.toLocaleString();
    document.getElementById('home-ton-balance').textContent=parseFloat(ton).toFixed(4);
    document.getElementById('swap-max-GLX').textContent=GLX.toLocaleString();
    document.getElementById('swap-max-TON').textContent=parseFloat(ton).toFixed(4);
    
    document.querySelectorAll('.user-ton-balance').forEach(el=>{
        el.textContent=parseFloat(ton).toFixed(4);
    });
    
    document.getElementById('referral-count-display').textContent=(appData.referrals||0);
    document.getElementById('hud-glx-balance').textContent=GLX.toLocaleString();
    document.getElementById('hud-ton-balance').textContent=parseFloat(ton).toFixed(4);
    
    const monetagCount=appData.adsMonetag||0;
    const gigaCount=appData.adsGiga||0;
    const adsgramCount=appData.adsAdsgram||0;
    
    const limitM=appSettings.limitMonetag||50;
    const limitG=appSettings.limitGiga||300;
    const limitA=appSettings.limitAdsgram||300;
    
    document.getElementById('monetag-count').textContent=monetagCount;
    document.getElementById('monetag-limit').textContent=limitM;
    document.getElementById('giga-count').textContent=gigaCount;
    document.getElementById('giga-limit').textContent=limitG;
    document.getElementById('adsgram-count').textContent=adsgramCount;
    document.getElementById('adsgram-limit').textContent=limitA;
    
    if(monetagCount>=limitM){
        const el=document.getElementById('monetag-ad-task');
        el.style.opacity='0.5';
        el.style.pointerEvents='none';
    }
    if(gigaCount>=limitG){
        const el=document.getElementById('gigapub-ad-task');
        el.style.opacity='0.5';
        el.style.pointerEvents='none';
    }
    if(adsgramCount>=limitA){
        const el=document.getElementById('adsgram-ad-task');
        el.style.opacity='0.5';
        el.style.pointerEvents='none';
    }
    
    fetchAndRenderTasks(user);
    renderHistory(document.getElementById('full-history-list'),50,user);
    calculateSwap();
}

window.selectSwapDirection=function(direction){
    swapDirection=direction;
    document.querySelectorAll('.swap-direction-btn').forEach(btn=>btn.classList.remove('active'));
    document.querySelectorAll('.swap-direction-btn').forEach(btn=>{
        if(btn.textContent.includes(direction==='glx_to_ton'?'GLX ‚Üí TON':'TON ‚Üí GLX')){
            btn.classList.add('active');
        }
    });
    
    if(direction==='glx_to_ton'){
        document.getElementById('glx-to-ton-section').style.display='block';
        document.getElementById('ton-to-glx-section').style.display='none';
        document.querySelector('.page-header p').textContent='100K GLX = 0.01 TON';
    }else{
        document.getElementById('glx-to-ton-section').style.display='none';
        document.getElementById('ton-to-glx-section').style.display='block';
        document.querySelector('.page-header p').textContent='0.01 TON = 100K GLX';
    }
    
    calculateSwap();
};

window.calculateSwap=function(){
    if(swapDirection==='glx_to_ton'){
        const GLXInput=parseFloat(document.getElementById('swap-input-amount').value)||0;
        const tonOutput=GLXInput*GLX_TO_TON_RATE;
        document.getElementById('swap-output-amount').textContent=tonOutput.toFixed(7);
    }else{
        const TONInput=parseFloat(document.getElementById('ton-input-amount').value)||0;
        const glxOutput=TONInput*TON_TO_GLX_RATE;
        document.getElementById('ton-output-amount').textContent=Math.floor(glxOutput).toLocaleString();
    }
};

window.setMaxSwap=function(type){
    if(type==='glx'||swapDirection==='glx_to_ton'){
        const currentBalance=appData.dogsBalance||0;
        if(currentBalance<1000){
            showNotification("Minimum swap is 1,000 GLX","warning");
            return;
        }
        document.getElementById('swap-input-amount').value=currentBalance;
        calculateSwap();
    }else{
        const currentBalance=appData.tonBalance||0;
        if(currentBalance<0.0001){
            showNotification("Minimum swap is 0.0001 TON","warning");
            return;
        }
        document.getElementById('ton-input-amount').value=currentBalance.toFixed(4);
        calculateSwap();
    }
};

window.executeSwap=function(){
    if(swapDirection==='glx_to_ton'){
        executeGLXtoTONSwap();
    }else{
        executeTONtoGLXSwap();
    }
};

async function executeGLXtoTONSwap(){
    const isAllowed=await checkBeforeAction("swap");
    if(!isAllowed)return;
    
    const GLXInput=parseFloat(document.getElementById('swap-input-amount').value)||0;
    const currentGLX=appData.dogsBalance||0;
    
    if(GLXInput<1000){
        showNotification("Min swap: 1,000 GLX","warning");
        return;
    }
    if(GLXInput>currentGLX){
        showNotification("Insufficient GLX Balance","warning");
        return;
    }
    
    const tonValue=GLXInput*GLX_TO_TON_RATE;
    
    if(!confirm(`Swap ${GLXInput.toLocaleString()} GLX for ${tonValue.toFixed(7)} TON?\n\nRate: 100,000 GLX = 0.01 TON`))return;
    
    const result=await callAPI('executeSwap',{
        type:'glx_to_ton',
        amount:GLXInput,
        tonValue:tonValue
    });
    
    if(result.success){
        appData.dogsBalance=result.data.newGLXBalance;
        appData.tonBalance=result.data.newTONBalance;
        
        showNotification(`Swap Complete!\n\n-${GLXInput.toLocaleString()} GLX\n+${tonValue.toFixed(7)} TON`,"success");
        
        document.getElementById('swap-input-amount').value='';
        document.getElementById('swap-output-amount').textContent='0.0000000';
        switchTab('home');
        renderUI({id:window.Telegram?.WebApp?.initDataUnsafe?.user?.id});
    }else{
        if(result.error==='ACCOUNT_BLOCKED'){
            showNotification("Your account has been blocked.","error");
        }else{
            showNotification("Error: "+result.error,"error");
        }
    }
}

async function executeTONtoGLXSwap(){
    const isAllowed=await checkBeforeAction("swap");
    if(!isAllowed)return;
    
    const TONInput=parseFloat(document.getElementById('ton-input-amount').value)||0;
    const currentTON=appData.tonBalance||0;
    
    if(TONInput<0.0001){
        showNotification("Min swap: 0.0001 TON","warning");
        return;
    }
    if(TONInput>currentTON){
        showNotification("Insufficient TON Balance","warning");
        return;
    }
    
    const glxValue=TONInput*TON_TO_GLX_RATE;
    
    if(!confirm(`Swap ${TONInput.toFixed(4)} TON for ${glxValue.toLocaleString()} GLX?\n\nRate: 0.01 TON = 100,000 GLX`))return;
    
    const result=await callAPI('executeSwap',{
        type:'ton_to_glx',
        amount:TONInput,
        glxValue:glxValue
    });
    
    if(result.success){
        appData.tonBalance=result.data.newTONBalance;
        appData.dogsBalance=result.data.newGLXBalance;
        
        showNotification(`Swap Complete!\n\n-${TONInput.toFixed(4)} TON\n+${glxValue.toLocaleString()} GLX`,"success");
        
        document.getElementById('ton-input-amount').value='';
        document.getElementById('ton-output-amount').textContent='0';
        switchTab('home');
        renderUI({id:window.Telegram?.WebApp?.initDataUnsafe?.user?.id});
    }else{
        if(result.error==='ACCOUNT_BLOCKED'){
            showNotification("Your account has been blocked.","error");
        }else{
            showNotification("Error: "+result.error,"error");
        }
    }
}

window.openGame=function(gameType){
    document.getElementById('coin-flip-section').style.display='none';
    document.getElementById('promo-codes-section').style.display='none';
    document.getElementById('daily-streak-section').style.display='none';
    document.getElementById('galaxy-slots-section').style.display='none';
    
    const grid=document.querySelector('.bonus-grid');
    grid.style.display='none';
    
    document.getElementById(gameType+'-section').style.display='block';
    
    if(gameType==='coin-flip'){
        resetCoinFlipGame();
    }else if(gameType==='galaxy-slots'){
        initSlotsGame();
        updateAvailableSpins();
    }else if(gameType==='daily-streak'){
        renderDailyBonusUI();
    }
};

window.closeGame=function(){
    document.getElementById('coin-flip-section').style.display='none';
    document.getElementById('promo-codes-section').style.display='none';
    document.getElementById('daily-streak-section').style.display='none';
    document.getElementById('galaxy-slots-section').style.display='none';
    
    const grid=document.querySelector('.bonus-grid');
    grid.style.display='grid';
};

function setupGalaxyLogButton(){
    const galaxyLogBtn=document.getElementById('galaxy-log-button');
    if(galaxyLogBtn){
        galaxyLogBtn.addEventListener('click',function(){
            switchTab('galaxy-log-page');
        });
    }
}

async function initializeCompetition(){
    if(isCompetitionDataLoaded)return;
    
    try{
        const result=await callAPI('getCompetitionData');
        if(result.success){
            competitionData=result.data.competitionData||competitionData;
            isCompetitionDataLoaded=true;
            
            if(!competitionData.isActive){
                await createNewCompetition();
            }else{
                startCountdown();
                updateCompetitionUI();
                loadPreviousWinners();
            }
        }else{
            if(result.error==='ACCOUNT_BLOCKED'){
                showNotification("Your account has been blocked.","error");
                return;
            }
            await createNewCompetition();
        }
    }catch(error){
        console.error("Error initializing competition:",error);
        await createNewCompetition();
    }
}

async function createNewCompetition(){
    const now=Date.now();
    competitionData={
        isActive:true,
        breakMode:false,
        startTime:now,
        endTime:now+COMPETITION_DURATION,
        totalTickets:0,
        prizePool:0,
        userTickets:{},
        winners:[]
    };
    
    await callAPI('createCompetition',{
        startTime:now,
        endTime:now+COMPETITION_DURATION
    });
    
    startCountdown();
    updateCompetitionUI();
}

function updateCompetitionUI(){
    const now=Date.now();
    const userId=window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    if(!userId){
        console.error("User ID not found");
        return;
    }
    
    document.getElementById('competition-status').textContent=competitionData.isActive?'ACTIVE':'ENDED';
    document.getElementById('competition-status').style.color=competitionData.isActive?'#27ae60':'#e74c3c';
    
    const prizePool=competitionData.totalTickets*TICKET_TON_VALUE;
    document.getElementById('prize-pool').textContent=prizePool.toFixed(4)+' TON';
    document.getElementById('total-tickets').textContent=(competitionData.totalTickets||0).toLocaleString();
    
    const ticketInput=document.getElementById('ticket-amount');
    if(ticketInput){
        updateTicketCostDisplay();
    }
    
    const buyBtn=document.getElementById('buy-tickets-btn');
    if(buyBtn){
        const isBreak=competitionData.breakMode||false;
        buyBtn.disabled=isBreak||!competitionData.isActive;
        buyBtn.style.opacity=isBreak||!competitionData.isActive?'0.5':'1';
    }
    
    if(isCompetitionPageVisible){
        updateCompetitionLeaderboard();
    }
}

async function loadUserCompetitionData(){
    const userId=window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    if(!userId){
        return;
    }
    
    const result=await callAPI('getUserCompetitionData',{userId:userId});
    if(result.success&&result.data){
        if(result.data.userTickets||result.data.competitionTickets){
            if(!competitionData.userTickets){
                competitionData.userTickets={};
            }
            const ticketsFromAPI=result.data.userTickets||result.data.competitionTickets||0;
            competitionData.userTickets[userId]=ticketsFromAPI;
            appData.competitionTickets=ticketsFromAPI;
            updateCompetitionUI();
        }
    }else{
        appData.competitionTickets=appData.competitionTickets||0;
    }
}

function startCountdown(){
    if(countdownInterval)clearInterval(countdownInterval);
    
    const updateTimer=()=>{
        const now=Date.now();
        if(competitionData.endTime){
            let timeRemaining=Math.max(0,competitionData.endTime-now);
            
            if(timeRemaining<=0&&competitionData.isActive){
                timeRemaining=0;
                competitionData.isActive=false;
                setTimeout(()=>{
                    createNewCompetition();
                },BREAK_DURATION);
            }
            
            const hours=Math.floor(timeRemaining/(1000*60*60));
            const minutes=Math.floor((timeRemaining%(1000*60*60))/(1000*60));
            const seconds=Math.floor((timeRemaining%(1000*60))/1000);
            
            const formattedTime=`${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            const timerElement=document.getElementById('countdown-timer');
            if(timerElement){
                timerElement.textContent=formattedTime;
            }
        }
        
        if(isCompetitionPageVisible){
            updateCompetitionUI();
        }
    };
    
    updateTimer();
    countdownInterval=setInterval(updateTimer,1000);
}

function updateTicketCostDisplay(){
    const ticketInput=document.getElementById('ticket-amount');
    if(!ticketInput)return;
    
    const tickets=parseInt(ticketInput.value)||1;
    const cost=tickets*TICKET_PRICE;
    
    document.getElementById('tickets-count-display').textContent=tickets;
    document.getElementById('tickets-cost-display').textContent=cost.toLocaleString()+' GLX';
}

window.setMaxTickets=function(){
    const currentBalance=appData.dogsBalance||0;
    const maxTickets=Math.floor(currentBalance/TICKET_PRICE);
    
    if(maxTickets<1){
        showNotification("You don't have enough GLX to buy a ticket (10,000 GLX required)","warning");
        return;
    }
    
    const ticketInput=document.getElementById('ticket-amount');
    ticketInput.value=maxTickets;
    updateTicketCostDisplay();
};

window.buyTickets=async function(){
    const userId=window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    if(!userId){
        showNotification("User authentication error. Please restart the bot.","error");
        return;
    }
    
    const isAllowed=await checkBeforeAction("buy tickets");
    if(!isAllowed)return;
    
    const buyBtn=document.getElementById('buy-tickets-btn');
    if(buyBtn.disabled){
        return;
    }
    
    if(competitionData.breakMode){
        showNotification("Competition is on break. Please wait for the next round.","warning");
        return;
    }
    
    if(!competitionData.isActive){
        showNotification("Competition has ended. Please wait for the next round.","warning");
        return;
    }
    
    const ticketInput=document.getElementById('ticket-amount');
    const tickets=parseInt(ticketInput.value)||0;
    
    if(tickets<1){
        showNotification("Please enter at least 1 ticket","warning");
        return;
    }
    
    const totalCost=tickets*TICKET_PRICE;
    const currentBalance=appData.dogsBalance||0;
    
    if(totalCost>currentBalance){
        showNotification(`Insufficient GLX balance. You need ${totalCost.toLocaleString()} GLX`,"warning");
        return;
    }
    
    let isConfirming=false;
    if(isConfirming)return;
    isConfirming=true;
    
    const userConfirmed=confirm(`Buy ${tickets} ticket${tickets>1?'s':''} for ${totalCost.toLocaleString()} GLX?\n\nEach ticket = 10,000 GLX = 0.001 TON\n\nüèÜ Remember: Only #1 wins, all others lose!`);
    if(!userConfirmed){
        isConfirming=false;
        return;
    }
    
    buyBtn.disabled=true;
    buyBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    const statusMsg=document.getElementById('buy-tickets-status');
    statusMsg.textContent="Processing your purchase...";
    statusMsg.style.color="#FFC107";
    
    try{
        const result=await callAPI('buyTickets',{
            userId:userId,
            tickets:tickets,
            totalCost:totalCost
        });
        
        if(result.success){
            appData.dogsBalance=result.data.newBalance;
            appData.competitionTickets=(appData.competitionTickets||0)+tickets;
            
            competitionData={
                ...competitionData,
                userTickets:result.data.userTickets||competitionData.userTickets,
                totalTickets:result.data.totalTickets||competitionData.totalTickets,
                prizePool:result.data.totalTickets*TICKET_TON_VALUE
            };
            
            buyBtn.disabled=false;
            buyBtn.innerHTML='<i class="fa-solid fa-ticket"></i> BUY TICKETS';
            statusMsg.textContent=`‚úÖ Successfully purchased ${tickets} ticket${tickets>1?'s':''}!`;
            statusMsg.style.color="#27ae60";
            
            ticketInput.value=1;
            updateTicketCostDisplay();
            
            setTimeout(()=>{
                statusMsg.textContent="";
            },3000);
            
            renderUI({id:userId});
            updateCompetitionUI();
        }else{
            if(result.error==='ACCOUNT_BLOCKED'){
                showNotification("Your account has been blocked.","error");
            }else{
                throw new Error(result.error||"Unknown error");
            }
        }
    }catch(error){
        console.error("Ticket purchase error:",error);
        showNotification("Error: "+error.message,"error");
        buyBtn.disabled=false;
        buyBtn.innerHTML='<i class="fa-solid fa-ticket"></i> BUY TICKETS';
        statusMsg.textContent="‚ùå Error processing purchase";
        statusMsg.style.color="#e74c3c";
    }finally{
        isConfirming=false;
    }
};

async function updateCompetitionLeaderboard(){
    const now=Date.now();
    if(now-lastLeaderboardUpdate<LEADERBOARD_UPDATE_INTERVAL){
        return;
    }
    
    lastLeaderboardUpdate=now;
    if(!isCompetitionPageVisible)return;
    
    try{
        const result=await callAPI('getCompetitionLeaderboard');
        if(result.success){
            const leaderboardContainer=document.getElementById('competition-leaderboard-list');
            const leaderboardData=result.data.leaderboard||[];
            
            if(leaderboardData.length===0){
                leaderboardContainer.innerHTML='<p style="text-align:center;padding:20px;color:var(--text-muted);">No tickets purchased yet</p>';
                return;
            }
            
            leaderboardContainer.innerHTML='';
            leaderboardData.forEach((entry,index)=>{
                const rankClass=index===0?'rank-1':index===1?'rank-2':index===2?'rank-3':'';
                const html=`<div class="competition-rank-card ${rankClass}">
                    <div class="competition-rank">#${index+1}</div>
                    <img src="${entry.photoRealEarnBot_bot||'https://i.ibb.co/tTkJX1Qy/logo.png'}" class="competition-user-avatar" alt="${entry.name}">
                    <div class="competition-user-info">
                        <div class="competition-user-name">${entry.name}</div>
                    </div>
                    <div class="competition-ticket-count">${entry.tickets} ticket${entry.tickets!==1?'s':''}</div>
                </div>`;
                leaderboardContainer.insertAdjacentHTML('beforeend',html);
            });
        }
    }catch(error){
        console.error("Error updating leaderboard:",error);
    }
}

async function loadPreviousWinners(){
    const result=await callAPI('getPreviousWinners');
    if(result.success){
        const winnersContainer=document.getElementById('previous-winners-list');
        const winners=result.data.winners||[];
        
        if(winners.length===0){
            winnersContainer.innerHTML='<p style="text-align:center;padding:20px;color:var(--text-muted);">No previous winners yet</p>';
            return;
        }
        
        winnersContainer.innerHTML='';
        winners.forEach(winner=>{
            const winnerDate=new Date(winner.timestamp).toLocaleDateString();
            const prizeAmount=winner.prize?parseFloat(winner.prize).toFixed(4):'0.0000';
            
            const html=`<div class="winner-item">
                <div class="winner-rank">üèÜ</div>
                <img src="${winner.photoRealEarnBot_bot||'https://i.ibb.co/tTkJX1Qy/logo.png'}" class="winner-avatar" alt="${winner.name}">
                <div class="winner-info">
                    <div class="winner-name">${winner.name}</div>
                    <div class="winner-date">${winnerDate}</div>
                </div>
                <div class="winner-prize">${prizeAmount} TON</div>
            </div>`;
            winnersContainer.insertAdjacentHTML('beforeend',html);
        });
    }
}

window.maskEmail=function(){
    const emailInput=document.getElementById('faucetpay-email');
    const emailPreview=document.getElementById('email-preview');
    if(!emailInput||!emailPreview)return;
    
    const email=emailInput.value.trim();
    if(!email||typeof email!=='string'||!email.includes('@')){
        emailPreview.style.display='none';
        return;
    }
    
    const[localPart,domain]=email.split('@');
    if(!localPart||!domain){
        emailPreview.style.display='none';
        return;
    }
    
    if(localPart.length>3){
        const maskedLocal=localPart.charAt(0)+'*'.repeat(Math.max(3,localPart.length-2))+localPart.charAt(localPart.length-1);
        const maskedEmail=`${maskedLocal}@${domain}`;
        emailPreview.textContent=maskedEmail;
        emailPreview.style.display='block';
    }else{
        emailPreview.style.display='none';
    }
};

window.setMaxFaucetPay=function(){
    const currentBalance=appData.tonBalance||0;
    const minAmount=0.0001;
    
    if(currentBalance<minAmount){
        showNotification(`Minimum withdrawal is ${minAmount} TON`,"warning");
        return;
    }
    
    document.getElementById('faucetpay-amount').value=currentBalance.toFixed(4);
};

window.setMaxTonWallet=function(){
    const currentBalance=appData.tonBalance||0;
    const minAmount=0.05;
    
    if(currentBalance<minAmount){
        showNotification(`Minimum withdrawal is ${minAmount} TON`,"warning");
        return;
    }
    
    document.getElementById('ton-withdraw-amount').value=currentBalance.toFixed(2);
};

window.renderGalaxyLog=async function(){
    const result=await callAPI('getTransactionHistory');
    if(result.success){
        const historyData=result.data.history||[];
        
        let totalEarned=0;
        let totalSpent=0;
        
        historyData.forEach(item=>{
            if(item.type.includes('earn')||item.type==='referral'){
                totalEarned+=parseFloat(item.amount)||0;
            }else if(item.type.includes('spend')||item.type.includes('loss')||item.type.includes('withdraw')){
                totalSpent+=parseFloat(item.amount)||0;
            }
        });
        
        document.getElementById('total-earned').textContent=Math.floor(totalEarned).toLocaleString()+' GLX';
        document.getElementById('total-spent').textContent=Math.floor(totalSpent).toLocaleString()+' GLX';
        
        const container=document.getElementById('galaxy-log-filtered-list');
        container.innerHTML='';
        
        historyData.forEach(item=>{
            let icon='üìú';
            let color='#fff';
            let typeClass='';
            
            if(item.type.includes('earn')||item.type==='referral'){
                icon='üí∞';
                color='#27ae60';
                typeClass='earn';
            }else if(item.type.includes('spend')||item.type.includes('loss')){
                icon='üìâ';
                color='#e74c3c';
                typeClass='spend';
            }else if(item.type.includes('swap')){
                icon='üîÑ';
                color='#3498db';
                typeClass='swap';
            }else if(item.type.includes('withdraw')){
                icon='üè¶';
                color='#9b59b6';
                typeClass='withdraw';
            }
            
            const amount=item.currency==='TON'?parseFloat(item.amount).toFixed(4)+' TON':Math.floor(item.amount).toLocaleString()+' GLX';
            
            const html=`<div class="log-item ${typeClass}">
                <div style="font-size:20px;margin-right:12px;">${icon}</div>
                <div style="flex:1;">
                    <div style="font-size:13px;font-weight:600;margin-bottom:2px;">${item.description}</div>
                    <div style="font-size:10px;color:var(--text-muted);">${new Date(item.date).toLocaleString()}</div>
                </div>
                <div style="font-size:14px;font-weight:700;color:${color};">${amount}</div>
            </div>`;
            
            container.insertAdjacentHTML('beforeend',html);
        });
    }
};

window.filterUserWithdrawals=async function(type){
    await updateUserWithdrawalsList(type);
};

async function updateUserWithdrawalsStats(){
    const result=await callAPI('getUserWithdrawals');
    if(result.success){
        const withdrawals=result.data.withdrawals||[];
        await updateUserWithdrawalsList('all',withdrawals);
    }
}

async function updateUserWithdrawalsList(filterType,withdrawalsData){
    if(!withdrawalsData){
        const result=await callAPI('getUserWithdrawals');
        if(result.success){
            withdrawalsData=result.data.withdrawals||[];
        }else{
            withdrawalsData=[];
        }
    }
    
    const container=document.getElementById('user-withdrawals-list');
    container.innerHTML='';
    
    const filteredWithdrawals=withdrawalsData.filter(withdrawal=>{
        if(filterType==='all')return true;
        if(filterType==='pending'){
            return withdrawal.status==='pending'||withdrawal.processed===false;
        }
        if(filterType==='completed'){
            return withdrawal.status==='completed'||withdrawal.processed===true;
        }
        return true;
    });
    
    filteredWithdrawals.sort((a,b)=>b.timestamp-a.timestamp);
    
    if(filteredWithdrawals.length===0){
        container.innerHTML='<p style="text-align:center;padding:20px;color:var(--text-muted);">No withdrawals found</p>';
        return;
    }
    
    filteredWithdrawals.forEach(withdrawal=>{
        const timeAgo=getTimeAgo(withdrawal.timestamp);
        const amount=parseFloat(withdrawal.amount||0).toFixed(7);
        
        let status='';
        let statusText='';
        let statusClass='';
        
        if(withdrawal.status==='rejected'){
            status='rejected';
            statusText='‚ùå Rejected';
            statusClass='status-rejected';
        }else if(withdrawal.status==='completed'||withdrawal.processed===true){
            status='completed';
            statusText='‚úÖ Completed';
            statusClass='status-completed';
        }else{
            status='pending';
            statusText='‚è≥ Pending';
            statusClass='status-pending';
        }
        
        let maskedAccount=withdrawal.account||'';
        if(withdrawal.method==='faucetpay'&&maskedAccount.includes('@')){
            const[localPart,domain]=maskedAccount.split('@');
            if(localPart.length>3){
                maskedAccount=localPart.charAt(0)+'*'.repeat(Math.max(3,localPart.length-2))+localPart.charAt(localPart.length-1)+'@'+domain;
            }
        }else if(withdrawal.method==='ton'){
            if(maskedAccount.length>16){
                maskedAccount=maskedAccount.substring(0,8)+'...'+maskedAccount.substring(maskedAccount.length-4);
            }
        }
        
        const html=`<div class="user-withdrawal-item">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                <div style="font-size:12px;font-weight:600;">${withdrawal.method==='ton'?'TON Wallet':'FaucetPay'}</div>
                <div class="withdrawal-status ${statusClass}">${statusText}</div>
            </div>
            <div style="font-size:11px;color:var(--text-muted);margin-bottom:5px;" class="masked-email">${maskedAccount}</div>
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-size:14px;font-weight:700;color:var(--primary-green);">${amount} TON</div>
                <div style="font-size:9px;color:var(--text-muted);">${timeAgo}</div>
            </div>
        </div>`;
        
        container.insertAdjacentHTML('beforeend',html);
    });
}

function getTimeAgo(timestamp){
    if(!timestamp)return"Unknown time";
    const now=Date.now();
    const diff=now-timestamp;
    const seconds=Math.floor(diff/1000);
    const minutes=Math.floor(seconds/60);
    const hours=Math.floor(minutes/60);
    const days=Math.floor(hours/24);
    
    if(days>0)return`${days} day${days>1?'s':''} ago`;
    if(hours>0)return`${hours} hour${hours>1?'s':''} ago`;
    if(minutes>0)return`${minutes} minute${minutes>1?'s':''} ago`;
    if(seconds>0)return`${seconds} second${seconds!==1?'s':''} ago`;
    return"Just now";
}

window.setMaxBet=function(){
    const currentBalance=appData.dogsBalance||0;
    const maxBet=Math.floor(currentBalance/1000)*1000;
    
    if(maxBet<1000){
        showNotification("Minimum bet is 1,000 GLX","warning");
        return;
    }
    
    document.getElementById('coin-bet-amount').value=maxBet;
    coinGame.betAmount=maxBet;
};

window.setBetAmount=function(amount){
    coinGame.betAmount=amount;
    document.getElementById('coin-bet-amount').value=amount;
    
    document.querySelectorAll('.bet-btn').forEach(btn=>{
        btn.classList.remove('active');
        const btnAmount=parseInt(btn.dataset.amount)||0;
        if(btnAmount===amount){
            btn.classList.add('active');
        }
    });
};

window.chooseSide=function(side){
    coinGame.chosenSide=side;
    document.querySelectorAll('.side-btn').forEach(btn=>{
        btn.classList.remove('active');
        btn.classList.remove('win');
        btn.classList.remove('lose');
    });
    
    const selectedBtn=side==='glx'?document.getElementById('choose-glx'):document.getElementById('choose-gold');
    selectedBtn.classList.add('active');
};

window.verifyDeposit=async function(){
    const isAllowed=await checkBeforeAction("verify deposit");
    if(!isAllowed)return;
    
    const btn=document.getElementById('check-deposit-btn');
    const msg=document.getElementById('deposit-status-message');
    if(!btn||!msg)return;
    
    btn.disabled=true;
    btn.textContent="Processing...";
    btn.classList.add('deposit-processing');
    
    msg.textContent="‚è≥ Verifying payment on blockchain... This may take up to 30 seconds";
    msg.style.color="#FFC107";
    
    try{
        await new Promise(resolve=>setTimeout(resolve,30000));
        
        const result=await callAPI('verifyDeposit',{transactionId:depositTransactionId});
        
        if(result.success){
            if(result.data&&result.data.verified){
                msg.textContent=`‚úÖ Payment verified! Your deposit of ${result.data.amount||'0'} TON will be added within 1 hour after manual review.`;
                msg.style.color="#27ae60";
                
                setTimeout(()=>{
                    document.getElementById('deposit-status').style.display='none';
                    document.getElementById('deposit-amount').value="0.01";
                    depositTransactionId='';
                    renderUI({id:window.Telegram?.WebApp?.initDataUnsafe?.user?.id});
                },5000);
            }else{
                msg.textContent="Payment not found yet. Please wait 10-30 seconds and try again.";
                msg.style.color="#e74c3c";
                btn.disabled=false;
                btn.textContent="Check Again";
            }
        }else{
            if(result.error==='ACCOUNT_BLOCKED'){
                showNotification("Your account has been blocked.","error");
            }else{
                msg.textContent="Error: "+(result.error||"Unknown error");
                msg.style.color="#e74c3c";
                btn.disabled=false;
                btn.textContent="Check Again";
            }
        }
    }catch(error){
        console.error("Deposit verification error:",error);
        msg.textContent="Connection error. Please try again.";
        msg.style.color="#e74c3c";
        btn.disabled=false;
        btn.textContent="Check Again";
    }finally{
        btn.classList.remove('deposit-processing');
    }
};

window.verifyPayment=async function(){
    const isAllowed=await checkBeforeAction("verify payment");
    if(!isAllowed)return;
    
    const btn=document.getElementById('check-payment-btn');
    const msg=document.getElementById('payment-status-msg');
    if(!btn||!msg)return;
    
    btn.disabled=true;
    btn.textContent="Processing...";
    btn.classList.add('deposit-processing');
    
    msg.textContent="‚è≥ Connecting to TON API... This may take up to 30 seconds";
    msg.style.color="#ffb300";
    
    try{
        await new Promise(resolve=>setTimeout(resolve,30000));
        
        const result=await callAPI('verifyTaskPayment',{taskId:currentTaskId});
        
        if(result.success){
            msg.textContent="Payment Verified! Activating Mission...";
            msg.style.color="#a855f7";
            showNotification("‚úÖ Payment verified! Mission will be activated within 1 hour after manual review.","success");
            
            document.getElementById('payment-step-1').style.display='block';
            document.getElementById('payment-step-2').style.display='none';
            document.getElementById('new-task-name').value='';
            document.getElementById('new-task-link').value='';
            
            btn.disabled=false;
            btn.textContent="Check Payment";
            
            const userId=window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
            if(userId){
                fetchAndRenderTasks({id:userId});
            }
            
            switchTab('tasks');
        }else{
            if(result.error==='ACCOUNT_BLOCKED'){
                showNotification("Your account has been blocked.","error");
            }else{
                msg.textContent="Payment not found yet. Please wait 10s and try again.";
                msg.style.color="#e74c3c";
                btn.disabled=false;
                btn.textContent="Check Again";
            }
        }
    }catch(e){
        console.error(e);
        msg.textContent="Error checking payment. Try again.";
        btn.disabled=false;
        btn.textContent="Check Again";
    }finally{
        btn.classList.remove('deposit-processing');
    }
};

function resetCoinFlipGame(){
    const coin=document.getElementById('coin');
    coin.classList.remove('coin-spinning','coin-final');
    coin.style.transform='rotateY(0deg)';
    coin.style.transition='none';
    
    document.getElementById('coin-game-result').style.display='none';
    
    document.querySelectorAll('.side-btn').forEach(btn=>{
        btn.classList.remove('win','lose');
        if(btn.id==='choose-glx'){
            btn.classList.add('active');
        }else{
            btn.classList.remove('active');
        }
    });
    
    coinGame.isFlipping=false;
    coinGame.chosenSide='glx';
    coinGame.betAmount=1000;
    coinGame.currentRotation=0;
    
    document.getElementById('coin-bet-amount').value=1000;
    updateBetButtons();
}

window.initCoinFlipGame=function(){
    resetCoinFlipGame();
};

function updateBetButtons(){
    const amounts=[1000,5000,10000,25000];
    const buttons=document.querySelectorAll('.bet-btn');
    
    buttons.forEach((btn,index)=>{
        if(index<amounts.length){
            btn.textContent=amounts[index]>=1000?(amounts[index]/1000)+'k':amounts[index];
            btn.dataset.amount=amounts[index];
            if(amounts[index]===1000){
                btn.classList.add('active');
            }else{
                btn.classList.remove('active');
            }
        }
    });
}

function initPromoCodes(){
    const redeemBtn=document.getElementById('redeem-code-btn');
    const promoInput=document.getElementById('promo-code-input');
    
    if(redeemBtn){
        redeemBtn.addEventListener('click',handlePromoCode);
    }
    
    if(promoInput){
        promoInput.addEventListener('keypress',function(e){
            if(e.key==='Enter'){
                handlePromoCode();
            }
        });
    }
}

window.selectCat=function(el,cat){
    document.querySelectorAll('.cat-opt').forEach(e=>e.classList.remove('active'));
    el.classList.add('active');
    selectedCategory=cat;
    
    const warningEl=document.getElementById('admin-required-msg');
    if(cat==='channel'){
        warningEl.style.display='block';
    }else{
        warningEl.style.display='none';
    }
};

function renderCreateTaskUI(){
    const container=document.getElementById('price-options');
    container.innerHTML='';
    
    const options=[100,500,1000,2000,5000,10000];
    options.forEach((opt,idx)=>{
        const html=`<div class="price-opt ${idx===0?'active':''}" data-count="${opt}" onclick="selectPrice(this)">
            <div class="price-count">${opt.toLocaleString()}</div>
            <div class="price-cost" id="cost-${opt}">Loading...</div>
        </div>`;
        container.insertAdjacentHTML('beforeend',html);
    });
    
    calculateCost();
}

window.selectPrice=function(el){
    document.querySelectorAll('.price-opt').forEach(e=>e.classList.remove('active'));
    el.classList.add('active');
    selectedCount=parseInt(el.dataset.count);
    calculateCost();
};

function calculateCost(){
    const rate=appSettings.pricePerClick||0.0015;
    
    document.querySelectorAll('.price-opt').forEach(el=>{
        const cnt=parseInt(el.dataset.count);
        const cst=(cnt*rate).toFixed(4);
        const costDiv=el.querySelector('.price-cost');
        if(costDiv)costDiv.textContent=`${cst} TON`;
    });
    
    selectedCost=(selectedCount*rate).toFixed(4);
    document.getElementById('pay-amount-display').textContent=selectedCost;
}

window.initiatePayment=async function(){
    const isAllowed=await checkBeforeAction("create task");
    if(!isAllowed)return;
    
    const name=document.getElementById('new-task-name').value.trim();
    const link=document.getElementById('new-task-link').value.trim();
    
    if(!name||!link){
        showNotification("Please fill all fields.","warning");
        return;
    }
    
    if(!link.startsWith('http')){
        showNotification("Invalid link.","warning");
        return;
    }
    
    currentTaskId='task_'+Math.floor(Date.now()/1000);
    
    const result=await callAPI('createTask',{
        taskId:currentTaskId,
        name:name,
        link:link,
        category:selectedCategory,
        count:selectedCount,
        cost:selectedCost
    });
    
    if(result.success){
        const nanoTon=Math.floor(selectedCost*1000000000);
        const paymentRealEarnBot_bot=`https://app.tonkeeper.com/transfer/${BOT_WALLET}?amount=${nanoTon}&text=${currentTaskId}`;
        
        if(window.Telegram?.WebApp){
            window.Telegram.WebApp.openLink(paymentRealEarnBot_bot);
        }else{
            window.open(paymentRealEarnBot_bot,'_blank');
        }
        
        document.getElementById('payment-step-1').style.display='none';
        document.getElementById('payment-step-2').style.display='block';
    }else{
        if(result.error==='ACCOUNT_BLOCKED'){
            showNotification("Your account has been blocked.","error");
        }else{
            showNotification("Error: "+result.error,"error");
        }
    }
};

function initSlotsGame(){
    for(let i=1;i<=3;i++){
        const reel=document.getElementById(`reel${i}`);
        reel.innerHTML='';
        for(let j=0;j<10;j++){
            slotsSymbols.forEach(symbol=>{
                const item=document.createElement('div');
                item.className='slot-item';
                item.textContent=symbol;
                reel.appendChild(item);
            });
        }
    }
    
    document.getElementById('slots-spin-btn').addEventListener('click',handleSlotsSpin);
}

function updateAvailableSpins(){
    const extraSpins=appData.extraSpins||0;
    document.getElementById('available-spins').textContent=extraSpins;
    
    const spinBtn=document.getElementById('slots-spin-btn');
    if(extraSpins>0){
        spinBtn.disabled=false;
        spinBtn.classList.remove('btn-disabled');
        spinBtn.textContent=`üöÄ SPIN NOW (${extraSpins} left)`;
    }else{
        spinBtn.disabled=true;
        spinBtn.classList.add('btn-disabled');
        spinBtn.textContent="üöÄ NO SPINS LEFT";
    }
}

async function handleSlotsSpin(){
    if(isSpinning)return;
    
    const isAllowed=await checkBeforeAction("spin slots");
    if(!isAllowed)return;
    
    const extraSpins=appData.extraSpins||0;
    if(extraSpins<=0){
        showNotification("You don't have any spins left! Watch an ad to get more spins.","warning");
        return;
    }
    
    isSpinning=true;
    const spinBtn=document.getElementById('slots-spin-btn');
    const resultText=document.getElementById('slots-result-text');
    const winAmount=document.getElementById('slots-win-amount');
    
    spinBtn.disabled=true;
    resultText.textContent="Spinning...";
    winAmount.textContent="0 GLX";
    
    const result=await callAPI('spinSlots');
    
    if(result.success){
        const results=result.data.results;
        const winGLX=result.data.winAmount;
        const newBalance=result.data.newBalance;
        const newSpins=result.data.newSpins;
        
        const reelPositions=[0,0,0];
        for(let i=0;i<3;i++){
            const targetIndex=slotsSymbols.indexOf(results[i]);
            reelPositions[i]=-((targetIndex+5)*70);
        }
        
        const reels=[document.getElementById('reel1'),document.getElementById('reel2'),document.getElementById('reel3')];
        reels.forEach((reel,index)=>{
            reel.style.transition='transform 2s cubic-bezier(0.1,0,0.2,1)';
            reel.style.transform=`translateY(${reelPositions[index]}px)`;
        });
        
        setTimeout(()=>{
            const resultString=results.join('');
            
            if(winGLX>0){
                resultText.textContent=`üéâ You won! (${resultString})`;
                winAmount.textContent=`+${winGLX} GLX`;
                
                appData.dogsBalance=newBalance;
                appData.extraSpins=newSpins;
                
                if(winGLX>=1000){
                    setTimeout(()=>{
                        showNotification(`üéä JACKPOT! You won ${winGLX} GLX!`,"success");
                    },500);
                }
            }else{
                resultText.textContent=`No win this time (${resultString})`;
                winAmount.textContent="0 GLX";
                appData.extraSpins=newSpins;
            }
            
            setTimeout(()=>{
                isSpinning=false;
                updateAvailableSpins();
                renderUI({id:window.Telegram?.WebApp?.initDataUnsafe?.user?.id});
            },1000);
        },2000);
    }else{
        if(result.error==='ACCOUNT_BLOCKED'){
            showNotification("Your account has been blocked.","error");
        }else{
            showNotification("Error: "+result.error,"error");
        }
        isSpinning=false;
        spinBtn.disabled=false;
    }
}

window.getExtraSpin=async function(){
    const isAllowed=await checkBeforeAction("get extra spin");
    if(!isAllowed)return;
    
    if(typeof window.showGiga==='function'){
        try{
            await window.showGiga();
            const result=await callAPI('addExtraSpin');
            if(result.success){
                appData.extraSpins=result.data.newSpins;
                showNotification("üéâ You earned an extra spin!","success");
                updateAvailableSpins();
            }
        }catch(e){
            console.error("Ad error:",e);
            showNotification("Ad not available.","warning");
        }
    }else{
        showNotification("Ads system loading...","info");
    }
};

function renderDailyBonusUI(){
    const container=document.getElementById('daily-checkin-grid');
    container.innerHTML='';
    
    const streak=appData.dailyStreak||0;
    const lastClaim=appData.lastDailyClaim||0;
    const now=Date.now();
    const msInDay=86400000;
    
    const canClaim=(now-lastClaim)>=msInDay;
    const rewards=appSettings.dailyRewards||[2000,3000,5000,7000,9000,12000,15000];
    
    for(let i=0;i<7;i++){
        let statusClass='';
        if(i<streak)statusClass='claimed';
        else if(i===streak&&canClaim)statusClass='active';
        
        const html=`<div class="daily-box ${statusClass}">
            <div style="font-size:9px;">DAY ${i+1}</div>
            <div style="font-weight:700;">+${rewards[i]}</div>
        </div>`;
        container.insertAdjacentHTML('beforeend',html);
    }
    
    const btn=document.getElementById('claim-daily-btn');
    const timer=document.getElementById('next-claim-timer');
    
    if(canClaim){
        btn.disabled=false;
        btn.classList.remove('btn-disabled');
        btn.textContent=`Claim +${rewards[streak]||100}`;
        timer.textContent="Ready to claim!";
    }else{
        btn.disabled=true;
        btn.classList.add('btn-disabled');
        btn.textContent="Claimed";
        const timeLeft=msInDay-(now-lastClaim);
        const hours=Math.floor(timeLeft/(1000*60*60));
        const mins=Math.floor((timeLeft%(1000*60*60))/(1000*60));
        timer.textContent=`Next reward in: ${hours}h ${mins}m`;
    }
}

async function renderHistory(container,limit,user){
    container.innerHTML='';
    const result=await callAPI('getTransactionHistory',{limit:limit});
    
    if(result.success){
        const historyData=result.data.history||[];
        if(historyData.length===0){
            container.innerHTML='<p style="text-align:center;padding:20px 0;font-size:12px;color:var(--text-muted);">No logs yet.</p>';
            return;
        }
        
        historyData.forEach(item=>{
            const isMinus=item.type.includes('withdraw')||item.type.includes('loss')||item.type.includes('swap_out');
            const sign=isMinus?'-':'+';
            const color=isMinus?'#fff':'var(--primary-green)';
            
            let displayAmount=item.amount;
            if(item.currency==='TON'){
                displayAmount=parseFloat(item.amount).toFixed(7);
            }else{
                displayAmount=Number(item.amount).toLocaleString();
            }
            
            let iconImg='https://i.ibb.co/tTkJX1Qy/logo.png';
            const desc=item.description.toLowerCase();
            if(item.currency==='TON')iconImg='https://i.ibb.co/8DsyHqwK/toncoin-ton-logo.png';
            else if(desc.includes('ad'))iconImg='https://i.ibb.co/tTkJX1Qy/logo.png';
            else if(desc.includes('telegram')||desc.includes('channel')||desc.includes('group'))iconImg='https://i.ibb.co/s9YygTBd/20251203-195134.png';
            else if(desc.includes('youtube')||desc.includes('subscribe'))iconImg='https://i.ibb.co/CSz6kg9/20251203-200546.png';
            else if(desc.includes('twitter')||desc.includes('follow'))iconImg='https://i.ibb.co/60jp6MsF/20251203-200516.png';
            else if(desc.includes('instagram'))iconImg='https://img.icons8.com/fluency/96/instagram-new.png';
            else if(desc.includes('coin flip'))iconImg='https://i.ibb.co/tTkJX1Qy/logo.png';
            
            const html=`<div class="list-card">
                <div class="lc-icon"><img src="${iconImg}"></div>
                <div class="lc-content">
                    <div class="lc-title">${item.description}</div>
                    <div class="lc-sub">${new Date(item.date).toLocaleDateString()}</div>
                </div>
                <div class="lc-end">
                    <div class="lc-val" style="color:${color}">${sign}${displayAmount} ${item.currency}</div>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend',html);
        });
    }
}

async function renderWithdrawalHistory(){
    const result=await callAPI('getWithdrawalHistory');
    if(result.success){
        const container=document.getElementById('withdrawal-history-list');
        container.innerHTML='';
        
        const withdrawals=result.data.withdrawals||[];
        if(withdrawals.length===0){
            container.innerHTML='<p style="text-align:center;padding:20px;color:var(--text-muted);">No withdrawals yet.</p>';
            return;
        }
        
        withdrawals.forEach(withdrawal=>{
            const timeAgo=getTimeAgo(withdrawal.timestamp);
            const amount=parseFloat(withdrawal.amount||0).toFixed(7);
            
            let maskedAccount=withdrawal.account||'';
            if(withdrawal.method==='faucetpay'&&maskedAccount.includes('@')){
                const[localPart,domain]=maskedAccount.split('@');
                if(localPart.length>3){
                    maskedAccount=localPart.charAt(0)+'*'.repeat(Math.max(3,localPart.length-2))+localPart.charAt(localPart.length-1)+'@'+domain;
                }
            }else if(withdrawal.method==='ton'){
                if(maskedAccount.length>16){
                    maskedAccount=maskedAccount.substring(0,8)+'...'+maskedAccount.substring(maskedAccount.length-4);
                }
            }
            
            const html=`<div class="list-card" style="margin-bottom:8px;">
                <div class="lc-icon"><img src="${withdrawal.photoRealEarnBot_bot||'https://i.ibb.co/tTkJX1Qy/logo.png'}" style="border-radius:50%;"></div>
                <div class="lc-content">
                    <div class="lc-title">${withdrawal.name||'Anonymous'}</div>
                    <div class="lc-sub">${withdrawal.method==='ton'?'TON Wallet: '+maskedAccount:'FaucetPay: '+maskedAccount}</div>
                </div>
                <div class="lc-end">
                    <div class="lc-val" style="color:var(--primary-green);">${amount} TON</div>
                    <div class="lc-sub" style="font-size:9px;">${timeAgo}</div>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend',html);
        });
    }
}

async function initiateDeposit(){
    const isAllowed=await checkBeforeAction("make deposit");
    if(!isAllowed)return;
    
    const amount=parseFloat(document.getElementById('deposit-amount').value)||0.01;
    if(amount<0.01){
        showNotification("Minimum deposit is 0.01 TON","warning");
        return;
    }
    
    const userId=window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    if(!userId){
        showNotification("User authentication error","error");
        return;
    }
    
    depositTransactionId='deposit_'+Date.now()+'_'+userId;
    const nanoTon=Math.floor(amount*1000000000);
    const paymentRealEarnBot_bot=`https://app.tonkeeper.com/transfer/${BOT_WALLET}?amount=${nanoTon}&text=${depositTransactionId}`;
    
    document.getElementById('deposit-status').style.display='block';
    document.getElementById('deposit-status-message').textContent="Payment link generated. Opening Tonkeeper...";
    document.getElementById('deposit-status-message').style.color="#FFC107";
    
    if(window.Telegram?.WebApp){
        window.Telegram.WebApp.openLink(paymentRealEarnBot_bot);
    }else{
        window.open(paymentRealEarnBot_bot,'_blank');
    }
}

async function verifyTelegramMembership(channelUsername,userId){
    try{
        const username=channelUsername.replace('@','');
        const result=await callAPI('verifyTelegramMembership',{
            channelUsername:username,
            userId:userId
        });
        return result.success&&result.data.isMember===true;
    }catch(error){
        console.error('Error verifying Telegram membership:',error);
        return false;
    }
}

async function verifyTaskChannel(taskId,channelUsername){
    try{
        const username=channelUsername.replace('@','');
        const result=await callAPI('verifyTaskChannel',{
            taskId:taskId,
            channelUsername:username
        });
        return result;
    }catch(error){
        console.error('Error verifying task channel:',error);
        return{success:false,error:error.message};
    }
}

function extractChannelUsernameFromLink(link){
    try{
        if(link.includes('t.me/')){
            const url=new URL(link);
            const pathParts=url.pathname.split('/');
            const username=pathParts[1];
            if(username&&!username.includes('joinchat')&&!username.includes('+')){
                return'@'+username;
            }
        }
        return null;
    }catch(e){
        console.error('Error parsing link:',e);
        return null;
    }
}

async function fetchAndRenderTasks(user){
    const result=await callAPI('getTasks');
    const cCont=document.getElementById('community-tasks-list');
    
    if(result.success){
        cCont.innerHTML='';
        const tasks=result.data.tasks||[];
        const completedTasks=appData.completedTasks||{};
        
        tasks.forEach(task=>{
            if(task.status!=='active'||(task.remaining!==undefined&&task.remaining<=0))return;
            
            const isDone=completedTasks[task.id];
            let iconImg='https://img.icons8.com/fluency/96/task.png';
            const lt=task.title.toLowerCase();
            const ll=(task.link||'').toLowerCase();
            
            if(lt.includes('bot')||ll.includes('bot')||ll.includes('start=')){
                iconImg='https://i.ibb.co/Myz4Gkmy/Picsart-25-12-10-04-34-59-799.png';
            }else if(lt.includes('telegram')||lt.includes('channel')||lt.includes('group')||lt.includes('join')||ll.includes('t.me')){
                iconImg='https://i.ibb.co/5WZRG8fw/tele.png';
            }else if(lt.includes('youtube')||lt.includes('subscribe'))iconImg='https://i.ibb.co/CSz6kg9/20251203-200546.png';
            else if(lt.includes('twitter')||lt.includes('retweet')||lt.includes('follow')||lt.includes('x '))iconImg='https://i.ibb.co/60jp6MsF/20251203-200516.png';
            else if(lt.includes('instagram'))iconImg='https://img.icons8.com/fluency/96/instagram-new.png';
            
            const html=`<div class="list-card dynamic-task ${isDone?'disabled':''}" style="${isDone?'opacity:0.5;pointer-events:none;':''}" data-id="${task.id}" data-reward="${task.reward}" data-title="${task.title}" data-link="${task.link}" onclick="handleDynamicTask(this)">
                <div class="lc-icon"><img src="${iconImg}"></div>
                <div class="lc-content">
                    <div class="lc-title">${task.title}</div>
                    <div class="lc-sub" id="status-${task.id}">${task.description}</div>
                </div>
                <div class="lc-end">
                    <div class="lc-val" id="reward-${task.id}">+${task.reward}</div>
                </div>
            </div>`;
            
            if(task.category==='community'){
                cCont.insertAdjacentHTML('beforeend',html);
            }
        });
        
        if(cCont.innerHTML===''){
            document.getElementById('community-tasks-card').style.display='none';
        }else{
            document.getElementById('community-tasks-card').style.display='block';
        }
    }
}

function setupEventListeners(user){
    document.querySelectorAll('.nav-item').forEach(btn=>{
        btn.addEventListener('click',()=>switchTab(btn.dataset.target));
    });
    
    document.querySelectorAll('.nav-link').forEach(link=>{
        link.addEventListener('click',(e)=>{
            e.preventDefault();
            switchTab(link.dataset.target);
        });
    });
    
    // ÿ™ŸÖ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ŸÖÿπÿßŸÑÿ¨ÿßÿ™ ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿ®ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¢ŸÖŸÜ
    
    document.getElementById('share-referral-btn').addEventListener('click',()=>{
        const link=document.getElementById('referral-link-display').textContent;
        window.Telegram?.WebApp.openTelegramLink(`https://t.me/share/RealEarnBot_bot?RealEarnBot_bot=${link}&text=Join GLX Galaxy!`);
    });
    
    document.getElementById('copy-referral-btn').addEventListener('click',()=>{
        navigator.clipboard.writeText(document.getElementById('referral-link-display').textContent).then(()=>{
            showNotification("Copied!","success");
        });
    });
    
    document.querySelectorAll('.tab-btn').forEach(btn=>{
        btn.addEventListener('click',(e)=>{
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.podium-list').forEach(l=>l.classList.add('hidden'));
            e.target.classList.add('active');
            document.getElementById(e.target.dataset.target).classList.remove('hidden');
        });
    });
    
    document.getElementById('claim-daily-btn').addEventListener('click',protectedDailyClaim);
    document.getElementById('buy-tickets-btn').addEventListener('click',buyTickets);
    document.getElementById('flip-coin-btn').addEventListener('click',flipCoin);
    
    document.getElementById('coin-bet-amount').addEventListener('input',function(){
        const value=parseInt(this.value);
        if(value&&value>=1000){
            coinGame.betAmount=value;
        }
    });
    
    document.getElementById('floatingAddTask').addEventListener('click',function(){
        switchTab('create-task-page');
    });
    
    document.getElementById('faucetpay-email')?.addEventListener('input',maskEmail);
    
    document.querySelectorAll('.btn-filter').forEach(btn=>{
        if(!btn.hasAttribute('data-setup')){
            btn.addEventListener('click',function(){
                document.querySelectorAll('.btn-filter').forEach(b=>b.classList.remove('active'));
                this.classList.add('active');
            });
            btn.setAttribute('data-setup','true');
        }
    });
}

function canClickAd(){
    const now=Date.now();
    return(now-lastAdClickTime)>=AD_CLICK_DELAY;
}

// ÿ™ŸÖ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ Ÿáÿ∞Ÿá ÿßŸÑÿØŸàÿßŸÑ ÿ®ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¢ŸÖŸÜ
// handleMonetagAd, handleGigaAd, handleAdsgramAd

window.selectWithdrawalType=function(type){
    withdrawalType=type;
    document.querySelectorAll('.withdrawal-type-btn').forEach(btn=>btn.classList.remove('active'));
    document.querySelector(`.withdrawal-type-btn[data-type="${type}"]`).classList.add('active');
    
    if(type==='faucetpay'){
        document.getElementById('faucetpay-form').style.display='block';
        document.getElementById('tonwallet-form').style.display='none';
    }else{
        document.getElementById('faucetpay-form').style.display='none';
        document.getElementById('tonwallet-form').style.display='block';
    }
};

async function handleFaucetPayWithdraw(){
    const isAllowed=await checkBeforeAction("withdraw");
    if(!isAllowed)return;
    
    const canWithdraw=checkWithdrawalLimit();
    if(!canWithdraw){
        showNotification("‚ö†Ô∏è Daily withdrawal limit reached! You can make only 2 withdrawals per day. Try again tomorrow.","warning");
        return;
    }
    
    const email=document.getElementById('faucetpay-email').value.trim();
    const amount=parseFloat(document.getElementById('faucetpay-amount').value);
    const minAmount=appSettings.minFaucetPayWithdrawal||0.0001;
    const currentBalance=appData.tonBalance||0;
    
    if(!email||!email.includes('@')){
        showNotification("Please enter a valid email address.","warning");
        return;
    }
    
    if(amount<minAmount){
        showNotification(`Minimum withdrawal is ${minAmount} TON for FaucetPay.`,"warning");
        return;
    }
    
    if(amount>=currentBalance){
        showNotification(`Insufficient TON balance. You need at least ${(amount+0.000001).toFixed(6)} TON.`,"warning");
        return;
    }
    
    const[localPart,domain]=email.split('@');
    let maskedEmail='';
    if(localPart.length>3){
        maskedEmail=localPart.charAt(0)+'*'.repeat(Math.max(3,localPart.length-2))+localPart.charAt(localPart.length-1)+'@'+domain;
    }else{
        maskedEmail='*'.repeat(localPart.length)+'@'+domain;
    }
    
    if(!confirm(`Withdraw ${amount} TON to ${maskedEmail} via FaucetPay?\n\nEmail will be partially hidden for privacy.\n\nToday's withdrawals: ${dailyWithdrawals.count}/2`)){
        return;
    }
    
    const result=await callAPI('submitWithdrawal',{
        method:'faucetpay',
        account:email,
        amount:amount,
        maskedAccount:maskedEmail
    });
    
    if(result.success){
        appData.tonBalance=result.data.newBalance;
        await incrementDailyWithdrawals();
        
        showNotification(`‚úÖ Withdrawal request submitted!\n\n${amount} TON will be sent to ${maskedEmail} within 1 minute.\n\nToday's withdrawals: ${dailyWithdrawals.count}/2`,"success");
        
        document.getElementById('faucetpay-email').value='';
        document.getElementById('faucetpay-amount').value=minAmount;
        document.getElementById('email-preview').style.display='none';
        
        switchTab('home');
        renderUI({id:window.Telegram?.WebApp?.initDataUnsafe?.user?.id});
    }else{
        if(result.error==='ACCOUNT_BLOCKED'){
            showNotification("Your account has been blocked.","error");
        }else{
            showNotification("Error: "+result.error,"error");
        }
    }
}

async function handleTonWalletWithdraw(){
    const isAllowed=await checkBeforeAction("withdraw");
    if(!isAllowed)return;
    
    const canWithdraw=checkWithdrawalLimit();
    if(!canWithdraw){
        showNotification("‚ö†Ô∏è Daily withdrawal limit reached! You can make only 2 withdrawals per day. Try again tomorrow.","warning");
        return;
    }
    
    const address=document.getElementById('ton-wallet-address').value.trim();
    const amount=parseFloat(document.getElementById('ton-withdraw-amount').value);
    const memo=document.getElementById('ton-memo').value.trim();
    const minAmount=appSettings.minTonWithdrawal||0.05;
    const currentBalance=appData.tonBalance||0;
    
    if(!address||address.length<5){
        showNotification("Please enter a valid TON wallet address.","warning");
        return;
    }
    
    if(amount<minAmount){
        showNotification(`Minimum withdrawal is ${minAmount} TON for TON Wallet.`,"warning");
        return;
    }
    
    if(amount>=currentBalance){
        showNotification(`Insufficient TON balance. You need at least ${(amount+0.0001).toFixed(4)} TON.`,"warning");
        return;
    }
    
    let shortAddress=address;
    if(address.length>16){
        shortAddress=address.substring(0,8)+'...'+address.substring(address.length-4);
    }
    
    if(!confirm(`Withdraw ${amount} TON to ${shortAddress}?\n\nAddress: ${shortAddress}\n${memo?'Memo: '+memo+'\n':''}\n\nToday's withdrawals: ${dailyWithdrawals.count}/2`)){
        return;
    }
    
    const result=await callAPI('submitWithdrawal',{
        method:'ton',
        account:address,
        amount:amount,
        memo:memo||''
    });
    
    if(result.success){
        appData.tonBalance=result.data.newBalance;
        await incrementDailyWithdrawals();
        
        showNotification(`‚úÖ Withdrawal request submitted!\n\n${amount} TON will be sent to your wallet within 24 hours.\n\nAddress: ${shortAddress}\n\nToday's withdrawals: ${dailyWithdrawals.count}/2`,"success");
        
        document.getElementById('ton-wallet-address').value='';
        document.getElementById('ton-memo').value='';
        document.getElementById('ton-withdraw-amount').value=minAmount;
        
        switchTab('home');
        renderUI({id:window.Telegram?.WebApp?.initDataUnsafe?.user?.id});
    }else{
        if(result.error==='ACCOUNT_BLOCKED'){
            showNotification("Your account has been blocked.","error");
        }else{
            showNotification("Error: "+result.error,"error");
        }
    }
}

window.handleDynamicTask=async function(element){
    const{id,reward,title,link}=element.dataset;
    const statusEl=document.getElementById(`status-${id}`);
    const rewardEl=document.getElementById(`reward-${id}`);
    
    if(element.classList.contains('waiting-verify')){
        await verifyMembership(element,link,id,reward,title);
        return;
    }
    
    if(window.Telegram?.WebApp){
        window.Telegram.WebApp.openLink(link);
    }else{
        window.open(link,'_blank');
    }
    
    element.classList.add('waiting-verify');
    statusEl.textContent="Tap again to Verify";
    statusEl.style.color="#ffb300";
    rewardEl.textContent="Check";
    rewardEl.style.fontSize="12px";
};

async function verifyMembership(element,link,taskId,reward,title){
    const userId=window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    if(!userId){
        showNotification("‚ùå User authentication error","error");
        element.classList.remove('waiting-verify');
        return;
    }
    
    const channelUsername=extractChannelUsernameFromLink(link);
    if(!channelUsername){
        showNotification("‚ùå Invalid channel link","error");
        element.classList.remove('waiting-verify');
        return;
    }
    
    const statusEl=document.getElementById(`status-${taskId}`);
    if(!statusEl)return;
    
    element.style.pointerEvents='none';
    element.classList.add('task-btn-disabled');
    statusEl.textContent="Verifying...";
    statusEl.style.color="#FFC107";
    
    try{
        const isAllowed=await checkBeforeAction("verify task");
        if(!isAllowed){
            element.classList.remove('waiting-verify');
            statusEl.textContent="Join First!";
            statusEl.style.color="#ff4444";
            return;
        }
        
        const verificationResult=await verifyTaskChannel(taskId,channelUsername);
        if(!verificationResult.success){
            showNotification("‚ùå Verification failed: "+(verificationResult.error||"Unknown error"),"error");
            element.classList.remove('waiting-verify');
            statusEl.textContent="Join First!";
            statusEl.style.color="#ff4444";
            setTimeout(()=>{
                element.style.pointerEvents='auto';
                element.classList.remove('task-btn-disabled');
            },2000);
            return;
        }
        
        const isVerified=verificationResult.data?.verified;
        const taskStatus=verificationResult.data?.taskStatus;
        const isMember=verificationResult.data?.isMember;
        const taskCompleted=verificationResult.data?.taskCompleted;
        
        const verificationSuccessful=(isVerified===true||isMember===true||taskCompleted===true)&&(taskStatus==="completed"||verificationResult.data?.status==="completed");
        
        if(verificationSuccessful){
            const result=await callAPI('verifyTaskCompletion',{
                taskId:taskId,
                reward:reward,
                title:title,
                link:link,
                channelUsername:channelUsername,
                verified:true
            });
            
            if(result.success){
                if(result.data.updatedUserData){
                    appData={...appData,...result.data.updatedUserData};
                }else if(result.data.userDataUpdate){
                    appData={...appData,...result.data.userDataUpdate};
                }else{
                    appData.dogsBalance=result.data.newBalance||appData.dogsBalance;
                    if(result.data.newGLXBalance!==undefined){
                        appData.dogsBalance=result.data.newGLXBalance;
                    }
                }
                
                appData.completedTasks=appData.completedTasks||{};
                appData.completedTasks[taskId]=true;
                
                element.style.opacity='0.5';
                element.style.pointerEvents='none';
                element.classList.remove('waiting-verify');
                statusEl.textContent="‚úÖ Verified ‚úì";
                statusEl.style.color="#27ae60";
                
                const rewardEl=document.getElementById(`reward-${taskId}`);
                if(rewardEl){
                    rewardEl.textContent="Done";
                    rewardEl.style.color="#27ae60";
                }
                
                const user={id:userId};
                renderUI(user);
                showNotification(`‚úÖ Channel Verified! +${reward} GLX`,"success");
            }else{
                if(result.error==='ACCOUNT_BLOCKED'){
                    showNotification("Your account has been blocked.","error");
                }else{
                    showNotification("‚ùå Failed to save verification: "+result.error,"warning");
                    element.classList.remove('waiting-verify');
                    statusEl.textContent="Join First!";
                    statusEl.style.color="#ff4444";
                }
            }
        }else{
            showNotification("‚ùå You must join the channel first!","warning");
            element.classList.remove('waiting-verify');
            statusEl.textContent="Join First!";
            statusEl.style.color="#ff4444";
        }
    }catch(error){
        console.error("Verification error:",error);
        showNotification("‚ùå Verification error. Please try again.","error");
        element.classList.remove('waiting-verify');
        statusEl.textContent="Error - Try Again";
        statusEl.style.color="#ff4444";
    }finally{
        setTimeout(()=>{
            element.style.pointerEvents='auto';
            element.classList.remove('task-btn-disabled');
        },2000);
    }
}

function switchTab(targetId){
    document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
    
    document.getElementById(targetId).classList.add('active');
    document.querySelector(`.nav-item[data-target="${targetId}"]`)?.classList.add('active');
    
    const floatingBtn=document.getElementById('floatingAddTask');
    if(targetId==='tasks'){
        floatingBtn.classList.remove('hidden');
    }else{
        floatingBtn.classList.add('hidden');
    }
    
    if(targetId==='leaderboard'&&!isLeaderboardLoaded){
        renderLeaderboard();
        isLeaderboardLoaded=true;
    }
    
    if(targetId==='bonus'){
        const grid=document.querySelector('.bonus-grid');
        grid.style.display='grid';
        document.getElementById('coin-flip-section').style.display='none';
        document.getElementById('promo-codes-section').style.display='none';
        document.getElementById('daily-streak-section').style.display='none';
        document.getElementById('galaxy-slots-section').style.display='none';
        
        renderDailyBonusUI();
        updateAvailableSpins();
        resetCoinFlipGame();
    }
    
    if(targetId==='withdrawal-history'){
        renderWithdrawalHistory();
    }
    
    if(targetId==='competition'){
        isCompetitionPageVisible=true;
        if(!isCompetitionDataLoaded){
            initializeCompetition();
        }
        updateCompetitionUI();
        updateCompetitionLeaderboard();
        
        if(competitionUpdateInterval){
            clearInterval(competitionUpdateInterval);
        }
        competitionUpdateInterval=setInterval(()=>{
            if(isCompetitionPageVisible){
                updateCompetitionLeaderboard();
            }
        },LEADERBOARD_UPDATE_INTERVAL);
    }else{
        isCompetitionPageVisible=false;
        if(competitionUpdateInterval){
            clearInterval(competitionUpdateInterval);
            competitionUpdateInterval=null;
        }
    }
    
    if(targetId==='galaxy-log-page'){
        renderGalaxyLog();
    }
    
    if(targetId==='user-withdrawals'){
        updateUserWithdrawalsStats();
    }
    
    if(targetId==='withdraw'){
        updateWithdrawalsCounterUI();
        checkWithdrawalLimit();
    }
    
    window.scrollTo(0,0);
}

async function renderLeaderboard(){
    const result=await callAPI('getLeaderboard');
    if(result.success){
        const byInv=result.data.byInvites||[];
        const byGLX=result.data.byGLX||[];
        fillList(byInv,'invites-leaderboard-list','referrals','Frens');
        fillList(byGLX,'earnings-leaderboard-list','dogsBalance','GLX');
    }
}

function fillList(data,containerId,key,suffix){
    const container=document.getElementById(containerId);
    container.innerHTML='';
    
    if(data.length===0){
        container.innerHTML='<p style="text-align:center;padding:20px;">No Data</p>';
        return;
    }
    
    data.slice(0,50).forEach((u,idx)=>{
        const val=key==='dogsBalance'?Math.floor(u[key]||0).toLocaleString():(u[key]||0);
        const html=`<div class="list-card">
            <div style="width:30px;font-weight:800;color:#fff;">#${idx+1}</div>
            <div class="lc-content">
                <div class="lc-title">${u.name||'Anonymous'}</div>
            </div>
            <div class="lc-end">
                <div class="lc-val" style="color:#fff;">${val} ${suffix}</div>
            </div>
        </div>`;
        container.insertAdjacentHTML('beforeend',html);
    });
}

function getLevel(balance){
    if(balance>=5000000)return 10;
    if(balance>=2500000)return 9;
    if(balance>=1000000)return 8;
    if(balance>=500000)return 7;
    if(balance>=250000)return 6;
    if(balance>=100000)return 5;
    if(balance>=50000)return 4;
    if(balance>=25000)return 3;
    if(balance>=5000)return 2;
    return 1;
}

async function getDeviceFingerprint(){
    if(SecuritySystem&&typeof SecuritySystem.getOrGenerateDeviceFingerprint==='function'){
        return await SecuritySystem.getOrGenerateDeviceFingerprint();
    }
    return'unknown';
}

document.addEventListener('DOMContentLoaded',async function(){
    if(!isCryptoSupported){
        console.error("Web Crypto API is not supported in this browser");
        showNotification("Your browser does not support required security features. Please update your browser.","error");
        return;
    }
    
    startGlobalLoading();
    
    setTimeout(async()=>{
        try{
            if(SecuritySystem&&typeof SecuritySystem.initialize==='function'){
                await SecuritySystem.initialize();
            }
        }catch(securityError){
            console.warn("Security system initialization warning:",securityError);
        }
        
        const verificationResult=await performSecurityVerification();
        if(!verificationResult){
            return;
        }
        
        const blockCheck=await checkUserBlockStatus();
        if(blockCheck&&blockCheck.success===false&&blockCheck.error==='ACCOUNT_BLOCKED'){
            const blockedMessage=blockCheck.data?.blockedMessage||"Your account has been suspended due to violation of our terms of service.";
            showNotification(blockedMessage,"error");
            return;
        }
        
        showMainApp();
        
        const{user,isExisting,deviceFingerprint}=verificationResult;
        
        if(window.Telegram?.WebApp){
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            window.Telegram.WebApp.headerColor='#202020';
            window.Telegram.WebApp.backgroundColor='#202020';
        }
        
        await initializeUser(user,deviceFingerprint);
        initializeApp(user);
    },10000);
});
</script>
</body>
</html>

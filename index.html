<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TON Rewards</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #050816;
            color: #fff;
            display: flex;
            justify-content: center;
        }
        .app {
            width: 100%;
            max-width: 480px;
            min-height: 100vh;
            padding: 16px;
            box-sizing: border-box;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .small {
            font-size: 13px;
            opacity: 0.7;
        }
        .balance {
            font-size: 28px;
            font-weight: 700;
            margin: 10px 0;
        }
        .btn {
            width: 100%;
            padding: 12px;
            border-radius: 999px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }
        .btn-primary {
            background: #16a34a;
            color: #fff;
        }
        .btn-secondary {
            background: #1f2933;
            color: #fff;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .field {
            margin-top: 8px;
        }
        .field label {
            display: block;
            font-size: 13px;
            margin-bottom: 4px;
        }
        .field input, .field select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(15,23,42,0.8);
            color: #fff;
            outline: none;
            box-sizing: border-box;
        }
        .status {
            font-size: 13px;
            margin-top: 6px;
            min-height: 18px;
        }
        .status.ok { color: #22c55e; }
        .status.err { color: #f97373; }
        .loader {
            text-align: center;
            padding: 40px 0;
            font-size: 14px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
<div class="app">
    <div id="loader" class="loader">
        Loading TON Rewards...
    </div>

    <div id="content" style="display:none;">
        <!-- User info & balance -->
        <div class="card">
            <div class="title">Welcome, <span id="user-name">User</span> üëã</div>
            <div class="small">Your current balance:</div>
            <div class="balance">
                <span id="user-balance">0</span> <span id="currency-symbol">TON</span>
            </div>
            <div class="small">
                Total earned: <span id="user-total-earned">0</span>
            </div>
        </div>

        <!-- Watch Ad -->
        <div class="card">
            <div class="title">Earn by watching ads üì∫</div>
            <div class="small">
                Click the button below to watch an ad and earn rewards.
            </div>
            <button id="watch-ad-btn" class="btn btn-primary">
                Watch Ad
            </button>
            <div id="ad-status" class="status"></div>
        </div>

        <!-- Withdraw -->
        <div class="card">
            <div class="title">Withdraw üí∏</div>
            <div class="small">
                Fill your method and address then request withdraw.
            </div>

            <div class="field">
                <label for="withdraw-method">Method</label>
                <select id="withdraw-method">
                    <option value="TON Wallet">TON Wallet</option>
                    <option value="USDT">USDT</option>
                </select>
            </div>

            <div class="field">
                <label for="withdraw-account">Address / Account</label>
                <input id="withdraw-account" type="text" placeholder="Your wallet address">
            </div>

            <div class="field">
                <label for="withdraw-amount">Amount</label>
                <input id="withdraw-amount" type="number" min="0" step="0.000001" placeholder="0.1">
            </div>

            <button id="withdraw-btn" class="btn btn-secondary">
                Request Withdraw
            </button>
            <div id="withdraw-status" class="status"></div>
        </div>
    </div>
</div>

<script>
    // üî¥ ÿ∫ŸäŸëÿ± ÿßŸÑÿ≥ÿ∑ÿ± ÿØŸá ŸÑŸÑŸäŸÜŸÉ ÿ®ÿ™ÿßÿπ Railway ÿßŸÑÿÆÿßÿµ ÿ®ŸäŸÉ
    const API_BASE = "https://ton-backend-production-83d3.up.railway.app";

    const tg = window.Telegram.WebApp || {};
    let tgUser = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;

    // Ÿàÿ∂ÿπ ÿ™ÿ∑ŸàŸäÿ± (ŸÑŸà ŸÅÿ™ÿ≠ÿ™ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÖŸÜ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÖÿ¥ ŸÖŸÜ ÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ)
    if (!tgUser) {
        tgUser = {
            id: 123456789,
            first_name: "Dev",
            last_name: "User",
            username: "devuser"
        };
        console.log("‚ö†Ô∏è Running in DEV mode, fake user:", tgUser);
    }

    async function api(path, options = {}) {
        try {
            const res = await fetch(API_BASE + path, {
                headers: { 
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                ...options
            });
            
            if (!res.ok) {
                const errorText = await res.text();
                console.error(`API Error ${res.status}:`, errorText);
                throw new Error(`API error: ${errorText}`);
            }
            
            return await res.json();
        } catch (error) {
            console.error('Network error:', error);
            throw new Error('Network error: ' + error.message);
        }
    }

    let appConfig = {
        currencySymbol: "TON"
    };
    let userState = {
        balance: 0,
        totalEarned: 0
    };

    function updateUI() {
        document.getElementById("user-name").textContent =
            (tgUser.first_name || "") + (tgUser.last_name ? (" " + tgUser.last_name) : "");

        document.getElementById("user-balance").textContent =
            Number(userState.balance || 0).toFixed(6);

        document.getElementById("user-total-earned").textContent =
            Number(userState.totalEarned || 0).toFixed(6);

        document.getElementById("currency-symbol").textContent =
            appConfig.currencySymbol || "TON";
    }

    async function initApp() {
        try {
            const loader = document.getElementById("loader");
            const content = document.getElementById("content");

            loader.textContent = "Loading configuration...";

            // 1) ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸÖŸÜ ÿßŸÑÿ®ÿßŸÉ ÿ•ŸÜÿØ
            const config = await api("/api/config");
            appConfig = { ...appConfig, ...config };

            loader.textContent = "Loading user data...";

            // 2) ÿ•ŸÜÿ¥ÿßÿ° / ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ ÿßŸÑÿ®ÿßŸÉ ÿ•ŸÜÿØ
            const userResponse = await api("/api/user/init", {
                method: "POST",
                body: JSON.stringify({
                    tgUser: tgUser,
                    referralParam: null,
                    isSubscribedToAllChannels: true
                })
            });

            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ©
            if (userResponse.ok && userResponse.user) {
                userState = {
                    balance: Number(userResponse.user.balance || 0),
                    totalEarned: Number(userResponse.user.total_earned || 0)
                };
            } else {
                // ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸáŸÜÿßŸÉ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≥ÿ™ÿÆÿØŸÖÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
                userState = {
                    balance: 0,
                    totalEarned: 0
                };
            }

            // 3) ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸàÿßÿ¨Ÿáÿ©
            loader.style.display = "none";
            content.style.display = "block";
            updateUI();

            console.log("‚úÖ App initialized", { config: appConfig, user: userState });

        } catch (err) {
            console.error("Initialization error:", err);
            const loader = document.getElementById("loader");
            loader.textContent = "Failed to init app: " + err.message;
            loader.style.color = "#f97373";
        }
    }

    async function handleWatchAd() {
        const btn = document.getElementById("watch-ad-btn");
        const status = document.getElementById("ad-status");

        try {
            btn.disabled = true;
            btn.textContent = "Loading ad...";
            status.textContent = "";
            status.className = "status";

            // ŸÖÿ≠ÿßŸÉÿßÿ© ŸÖÿ¥ÿßŸáÿØÿ© ÿ•ÿπŸÑÿßŸÜ
            await new Promise(r => setTimeout(r, 3000));

            // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ŸÑŸÑÿ®ÿßŸÉ ÿ•ŸÜÿØ ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ŸÖÿ¥ÿßŸáÿØÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ
            const result = await api("/api/ad/watch", {
                method: "POST",
                body: JSON.stringify({ 
                    userId: tgUser.id.toString(),
                    tgUser: tgUser,
                    adId: `ad_${Date.now()}`,
                    platform: 'telegram'
                })
            });

            if (result.ok) {
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿµŸäÿØ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ©
                const earnedAmount = result.reward || 10;
                userState.balance = Number((userState.balance + earnedAmount).toFixed(6));
                userState.totalEarned = Number((userState.totalEarned + earnedAmount).toFixed(6));
                
                updateUI();

                status.textContent = `+${earnedAmount} ${appConfig.currencySymbol || "TON"} added!`;
                status.className = "status ok";
            } else {
                throw new Error(result.error || "Failed to record ad watch");
            }

        } catch (err) {
            console.error("Watch ad error:", err);
            status.textContent = err.message || "Failed to watch ad";
            status.className = "status err";
        } finally {
            btn.textContent = "Watch Ad";
            btn.disabled = false;
        }
    }

    async function handleWithdraw() {
        const methodEl = document.getElementById("withdraw-method");
        const accountEl = document.getElementById("withdraw-account");
        const amountEl = document.getElementById("withdraw-amount");
        const status = document.getElementById("withdraw-status");
        const btn = document.getElementById("withdraw-btn");

        const method = methodEl.value;
        const account = accountEl.value.trim();
        const amount = parseFloat(amountEl.value);

        if (!account) {
            status.textContent = "Please enter your wallet / account.";
            status.className = "status err";
            return;
        }
        if (isNaN(amount) || amount <= 0) {
            status.textContent = "Please enter a valid amount.";
            status.className = "status err";
            return;
        }
        if (amount > userState.balance) {
            status.textContent = "Insufficient balance.";
            status.className = "status err";
            return;
        }

        try {
            btn.disabled = true;
            btn.textContent = "Sending request...";
            status.textContent = "";
            status.className = "status";

            const resp = await api("/api/withdraw", {
                method: "POST",
                body: JSON.stringify({
                    userId: tgUser.id.toString(),
                    method: method,
                    account: account,
                    amount: amount,
                    tgUser: tgUser
                })
            });

            if (resp.ok) {
                status.textContent = "Withdraw request sent successfully ‚úÖ";
                status.className = "status ok";

                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿµŸäÿØ ÿ®ÿπÿØ ÿßŸÑÿ≥ÿ≠ÿ®
                userState.balance = Number((userState.balance - amount).toFixed(6));
                updateUI();

                // ŸÖÿ≥ÿ≠ ÿßŸÑÿ≠ŸÇŸàŸÑ
                accountEl.value = "";
                amountEl.value = "";
            } else {
                status.textContent = resp.error || "Failed to send withdraw request.";
                status.className = "status err";
            }

        } catch (err) {
            console.error("Withdraw error:", err);
            status.textContent = err.message || "Error in withdraw request.";
            status.className = "status err";
        } finally {
            btn.disabled = false;
            btn.textContent = "Request Withdraw";
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        // ÿ±ÿ®ÿ∑ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
        document.getElementById("watch-ad-btn").addEventListener("click", handleWatchAd);
        document.getElementById("withdraw-btn").addEventListener("click", handleWithdraw);

        // ÿ®ÿØÿ° ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
        initApp();
    });
</script>
</body>
</html>

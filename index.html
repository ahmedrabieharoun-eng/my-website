<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Farm Economy</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- TON Connect SDK -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    
    <style>
        /* ==================== RESET & BASE STYLES ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            /* Colors - Dark Modern Glass Theme */
            --bg-primary: #0B0F1A;
            --bg-secondary: #111827;
            --bg-gradient: linear-gradient(135deg, #0B0F1A 0%, #111827 50%, #0F172A 100%);
            --card-bg: rgba(255, 255, 255, 0.04);
            --card-border: rgba(255, 255, 255, 0.08);
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            
            --primary-green: #00B894;
            --primary-yellow: #FDCB6E;
            --primary-purple: #6C5CE7;
            --primary-red: #D63031;
            --primary-blue: #0984E3;
            --diamond-color: #00CEC9;
            
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.5);
            
            --success: #00D4AA;
            --warning: #FDCB6E;
            --danger: #FF5252;
            --info: #0984E3;
            
            --ton-color: #0088CC;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            position: relative;
            padding-bottom: 90px;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 184, 148, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(108, 92, 231, 0.08) 0%, transparent 50%);
            z-index: -1;
            pointer-events: none;
        }
        
        /* ==================== TOP STATUS BAR - ROW 1 ==================== */
        .status-bar-row1 {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(11, 15, 26, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--card-border);
            z-index: 100;
        }
        
        .status-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 12px 8px;
            box-shadow: var(--card-shadow);
        }
        
        .status-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .status-balance {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1.2;
            margin-bottom: 4px;
        }
        
        .status-rate {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-rate i {
            color: var(--success);
            font-size: 10px;
        }
        
        /* ==================== TOP STATUS BAR - ROW 2 ==================== */
        .status-bar-row2 {
            position: fixed;
            top: 95px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            background: rgba(11, 15, 26, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--card-border);
            z-index: 99;
        }
        
        .ton-status {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            border-radius: 40px;
            padding: 6px 12px 6px 16px;
            box-shadow: var(--card-shadow);
        }
        
        .ton-icon {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 700;
            color: var(--ton-color);
        }
        
        .ton-balance {
            font-size: 18px;
            font-weight: 800;
            color: var(--text-primary);
        }
        
        .deposit-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-purple), #8B5CF6);
            border: none;
            color: white;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
        }
        
        .deposit-btn:active {
            transform: scale(0.95);
        }
        
        /* ==================== HELP FLOATING BUTTON ==================== */
        .help-floating-btn {
            position: fixed;
            bottom: 100px;
            right: 16px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-purple), #8B5CF6);
            border: none;
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4);
            transition: all 0.3s ease;
        }
        
        .help-floating-btn:hover {
            transform: scale(1.1);
        }
        
        /* ==================== HELP MODAL ==================== */
        .help-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 24px;
            z-index: 2000;
            display: none;
            box-shadow: var(--card-shadow);
        }
        
        .help-modal.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .help-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .help-header h2 {
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
        }
        
        .help-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
        }
        
        .help-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .help-section {
            border-bottom: 1px solid var(--card-border);
            padding-bottom: 16px;
        }
        
        .help-section:last-child {
            border-bottom: none;
        }
        
        .help-section h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--primary-green);
        }
        
        .help-section p {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 4px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1999;
            display: none;
        }
        
        .modal-overlay.active {
            display: block;
        }
        
        /* ==================== MAIN CONTAINER ==================== */
        .app-container {
            padding-top: 160px;
            padding-left: 16px;
            padding-right: 16px;
            padding-bottom: 20px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .content-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ==================== CARDS ==================== */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-purple));
            opacity: 0.5;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* ==================== MACHINE CARDS ==================== */
        .machine-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .machine-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            position: relative;
        }
        
        .machine-card.locked {
            opacity: 0.7;
            filter: grayscale(0.5);
        }
        
        .machine-card.sold-out {
            opacity: 0.8;
        }
        
        .machine-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .machine-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }
        
        .machine-icon.cow { color: var(--primary-brown, #6D4C41); }
        .machine-icon.chicken { color: var(--primary-yellow); }
        .machine-icon.diamond { color: var(--diamond-color); }
        
        .machine-info {
            flex: 1;
        }
        
        .machine-name-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .machine-name {
            font-size: 18px;
            font-weight: 700;
        }
        
        .machine-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-owned {
            background: rgba(0, 212, 170, 0.15);
            color: var(--success);
            border: 1px solid rgba(0, 212, 170, 0.3);
        }
        
        .badge-sold-out {
            background: rgba(214, 48, 49, 0.15);
            color: var(--danger);
            border: 1px solid rgba(214, 48, 49, 0.3);
        }
        
        .badge-locked {
            background: rgba(108, 92, 231, 0.15);
            color: var(--primary-purple);
            border: 1px solid rgba(108, 92, 231, 0.3);
        }
        
        .machine-price {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .machine-price i {
            color: var(--ton-color);
        }
        
        .machine-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
        }
        
        .machine-stat {
            text-align: center;
        }
        
        .machine-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        
        .machine-stat-value {
            font-size: 16px;
            font-weight: 700;
        }
        
        .global-supply {
            margin: 16px 0;
        }
        
        .supply-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-yellow));
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .unlock-text {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .unlock-text i {
            color: var(--primary-purple);
        }
        
        /* ==================== BUTTONS ==================== */
        .btn {
            padding: 14px 20px;
            border-radius: 16px;
            border: none;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-green), #00A884);
            color: white;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
        }
        
        .btn-buy {
            background: linear-gradient(135deg, var(--primary-green), #00A884);
            color: white;
        }
        
        .btn-hatch {
            background: linear-gradient(135deg, var(--primary-purple), #8B5CF6);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: #000;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        /* ==================== HATCH MODAL ==================== */
        .hatch-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 24px;
            z-index: 2000;
            display: none;
            box-shadow: var(--card-shadow);
        }
        
        .hatch-modal.active {
            display: block;
        }
        
        .hatch-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--card-border);
        }
        
        .hatch-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .hatch-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .hatch-details {
            display: flex;
            flex-direction: column;
        }
        
        .hatch-title {
            font-size: 16px;
            font-weight: 700;
        }
        
        .hatch-cost {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .hatch-amount {
            text-align: right;
        }
        
        .hatch-available {
            font-size: 18px;
            font-weight: 700;
        }
        
        .hatch-label {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        /* ==================== MARKET GRID ==================== */
        .market-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.04);
            padding: 4px;
            border-radius: 40px;
            border: 1px solid var(--card-border);
        }
        
        .market-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 40px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .market-tab.active {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            color: var(--text-primary);
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
        }
        
        .resource-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .resource-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 40px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .resource-option.active {
            background: var(--primary-green);
            border-color: var(--primary-green);
            color: white;
        }
        
        .resource-option .fa-times-circle {
            color: var(--text-muted);
            font-size: 14px;
        }
        
        .resource-option.active .fa-times-circle {
            color: white;
        }
        
        .orders-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .order-card {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 16px;
            position: relative;
        }
        
        .order-card.best {
            border: 2px solid var(--primary-yellow);
        }
        
        .best-badge {
            position: absolute;
            top: -10px;
            right: 12px;
            background: var(--primary-yellow);
            color: #000;
            font-size: 11px;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 20px;
        }
        
        .order-resource {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .order-amount {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .order-total {
            font-size: 18px;
            font-weight: 700;
            color: var(--ton-color);
            margin-bottom: 4px;
        }
        
        .order-perunit {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        
        /* ==================== CREATE ORDER BUTTON ==================== */
        .create-order-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary-purple), #8B5CF6);
            border: none;
            border-radius: 20px;
            color: white;
            font-weight: 700;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            margin-top: 16px;
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.3);
        }
        
        /* ==================== ORDER MODAL ==================== */
        .order-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 24px;
            z-index: 2000;
            display: none;
            box-shadow: var(--card-shadow);
        }
        
        .order-modal.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .form-input {
            width: 100%;
            padding: 14px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 16px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-green);
        }
        
        .available-balance {
            margin-top: 8px;
            font-size: 13px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }
        
        .best-price-info {
            background: rgba(0, 184, 148, 0.1);
            padding: 12px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        
        /* ==================== DIAMOND ENGINE ==================== */
        .diamond-card {
            background: linear-gradient(135deg, rgba(0, 206, 201, 0.1), rgba(108, 92, 231, 0.1));
            border: 1px solid rgba(0, 206, 201, 0.3);
        }
        
        .production-costs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }
        
        .cost-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 16px;
            text-align: center;
        }
        
        .cost-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .cost-value {
            font-size: 18px;
            font-weight: 700;
        }
        
        .cost-label {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .diamond-price-big {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 28px;
            font-weight: 800;
            margin: 20px 0;
            color: var(--diamond-color);
        }
        
        /* ==================== REFERRAL SECTION ==================== */
        .referral-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
        }
        
        .referral-stat-card {
            background: rgba(255, 255, 255, 0.04);
            padding: 16px;
            border-radius: 16px;
            text-align: center;
        }
        
        .referral-stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary-green);
            margin-bottom: 4px;
        }
        
        .referral-stat-label {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        /* ==================== BOTTOM NAVIGATION ==================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(11, 15, 26, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--card-border);
            display: flex;
            justify-content: space-around;
            padding: 12px 16px;
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            padding: 8px;
            border-radius: 16px;
            min-width: 64px;
        }
        
        .nav-item.active {
            color: var(--primary-green);
            background: rgba(0, 184, 148, 0.1);
        }
        
        .nav-icon {
            font-size: 22px;
        }
        
        .nav-text {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* ==================== LOADING SCREEN ==================== */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-logo {
            font-size: 72px;
            margin-bottom: 24px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .loading-title {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-green), var(--primary-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .loading-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 30px;
        }
        
        .loading-progress {
            width: 240px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-yellow));
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* ==================== TRANSACTION MODAL ==================== */
        .tx-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 350px;
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 24px;
            z-index: 2000;
            display: none;
            text-align: center;
        }
        
        .tx-modal.active {
            display: block;
        }
        
        .tx-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .tx-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .tx-message {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        
        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 380px) {
            .status-balance {
                font-size: 18px;
            }
            
            .machine-icon {
                width: 50px;
                height: 50px;
                font-size: 26px;
            }
            
            .machine-name {
                font-size: 16px;
            }
            
            .orders-grid {
                grid-template-columns: 1fr;
            }
            
            .referral-stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ==================== LOADING SCREEN ==================== -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">üöú</div>
        <h1 class="loading-title">Farm Economy</h1>
        <div class="loading-subtitle">Loading your farm...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgress"></div>
        </div>
    </div>

    <!-- ==================== TOP STATUS BAR - ROW 1 (3 CARDS) ==================== -->
    <div class="status-bar-row1">
        <!-- Milk Card -->
        <div class="status-card">
            <div class="status-header">
                <span>ü•õ</span>
                <span>Milk</span>
            </div>
            <div class="status-balance" id="statusMilk">0</div>
            <div class="status-rate" id="statusMilkRate">
                <i class="fas fa-arrow-up"></i> 0 / hour
            </div>
        </div>
        
        <!-- Eggs Card -->
        <div class="status-card">
            <div class="status-header">
                <span>ü•ö</span>
                <span>Eggs</span>
            </div>
            <div class="status-balance" id="statusEggs">0</div>
            <div class="status-rate" id="statusEggsRate">
                <i class="fas fa-arrow-up"></i> 0 / hour
            </div>
        </div>
        
        <!-- Diamond Card -->
        <div class="status-card">
            <div class="status-header">
                <span>üíé</span>
                <span>Diamond</span>
            </div>
            <div class="status-balance" id="statusDiamond">0</div>
            <div class="status-rate">
                <i class="fas fa-gem"></i> Asset
            </div>
        </div>
    </div>

    <!-- ==================== TOP STATUS BAR - ROW 2 (TON + DEPOSIT) ==================== -->
    <div class="status-bar-row2">
        <div class="ton-status">
            <div class="ton-icon">
                <i class="fas fa-bolt"></i>
                <span>TON</span>
            </div>
            <span class="ton-balance" id="statusTon">0.0000</span>
        </div>
        
        <button class="deposit-btn" onclick="openDepositModal()">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- ==================== HELP FLOATING BUTTON ==================== -->
    <button class="help-floating-btn" onclick="toggleHelpModal()">
        <i class="fas fa-question"></i>
    </button>

    <!-- ==================== HELP MODAL ==================== -->
    <div class="modal-overlay" id="helpOverlay" onclick="toggleHelpModal()"></div>
    <div class="help-modal" id="helpModal">
        <div class="help-header">
            <h2>
                <i class="fas fa-question-circle" style="color: var(--primary-green);"></i>
                How to Play
            </h2>
            <button class="help-close" onclick="toggleHelpModal()">√ó</button>
        </div>
        <div class="help-content">
            <div class="help-section">
                <h3>üêÆ Cow Machine</h3>
                <p>Price: 1 TON</p>
                <p>Production: 41 Milk/hour</p>
                <p>Global Supply: 1000 machines max</p>
                <p style="color: var(--text-muted); font-size: 12px;">Each user can buy only one</p>
            </div>
            
            <div class="help-section">
                <h3>üêî Chicken Machine</h3>
                <p>Price: 1 TON</p>
                <p>Production: 41 Eggs/hour</p>
                <p>üîì Unlocks after all 1000 Cows are sold</p>
            </div>
            
            <div class="help-section">
                <h3>üíé Diamond Engine</h3>
                <p>Price: 20 TON</p>
                <p>Production: 20,000 Milk + 20,000 Eggs = 1 Diamond</p>
                <p>üîì Unlocks after all 1000 Cows AND 1000 Chickens are sold</p>
            </div>
            
            <div class="help-section">
                <h3>üîÑ Hatch System</h3>
                <p>Convert resources directly into machines:</p>
                <p>ü•õ 10,000 Milk = 1 Cow Machine</p>
                <p>ü•ö 10,000 Eggs = 1 Chicken Machine</p>
                <p style="color: var(--text-muted);">‚ö†Ô∏è Hatch does NOT affect global supply</p>
            </div>
            
            <div class="help-section">
                <h3>üìä P2P Market</h3>
                <p>Trade Milk and Eggs with other players</p>
                <p>You set the price - Free market economy</p>
                <p>üî• Best price orders are highlighted</p>
            </div>
            
            <div class="help-section">
                <h3>üí∞ Diamond Conversion</h3>
                <p>Convert Diamonds ‚Üí TON</p>
                <p>1 Diamond = Dynamic price (set by team)</p>
            </div>
            
            <div class="help-section">
                <h3>üë• Referral System</h3>
                <p>Earn 10% commission on every TON purchase made by your friends</p>
                <p>üîó Use your unique referral link</p>
            </div>
        </div>
    </div>

    <!-- ==================== HATCH MODAL ==================== -->
    <div class="modal-overlay" id="hatchOverlay" onclick="closeHatchModal()"></div>
    <div class="hatch-modal" id="hatchModal">
        <div class="help-header">
            <h2>
                <i class="fas fa-egg" style="color: var(--primary-yellow);"></i>
                Hatch Machine
            </h2>
            <button class="help-close" onclick="closeHatchModal()">√ó</button>
        </div>
        
        <div style="margin-bottom: 20px;">
            <p style="color: var(--text-secondary); font-size: 14px;">
                Convert resources directly into machines. This does NOT affect global supply.
            </p>
        </div>
        
        <!-- Hatch Cow Option -->
        <div class="hatch-option">
            <div class="hatch-info">
                <div class="hatch-icon">üêÆ</div>
                <div class="hatch-details">
                    <div class="hatch-title">Cow Machine</div>
                    <div class="hatch-cost">10,000 ü•õ Milk</div>
                </div>
            </div>
            <div class="hatch-amount">
                <div class="hatch-available" id="hatchCowsAvailable">0</div>
                <div class="hatch-label">Owned</div>
            </div>
        </div>
        
        <button class="btn btn-hatch" id="hatchCowBtn" onclick="hatchCow()" style="margin-bottom: 16px;">
            <i class="fas fa-flask"></i>
            Hatch Cow (10,000 Milk)
        </button>
        
        <!-- Hatch Chicken Option -->
        <div class="hatch-option">
            <div class="hatch-info">
                <div class="hatch-icon">üêî</div>
                <div class="hatch-details">
                    <div class="hatch-title">Chicken Machine</div>
                    <div class="hatch-cost">10,000 ü•ö Eggs</div>
                </div>
            </div>
            <div class="hatch-amount">
                <div class="hatch-available" id="hatchChickensAvailable">0</div>
                <div class="hatch-label">Owned</div>
            </div>
        </div>
        
        <button class="btn btn-hatch" id="hatchChickenBtn" onclick="hatchChicken()">
            <i class="fas fa-flask"></i>
            Hatch Chicken (10,000 Eggs)
        </button>
    </div>

    <!-- ==================== CREATE ORDER MODAL ==================== -->
    <div class="modal-overlay" id="orderOverlay" onclick="closeOrderModal()"></div>
    <div class="order-modal" id="orderModal">
        <div class="help-header">
            <h2>
                <i class="fas fa-plus-circle" style="color: var(--primary-purple);"></i>
                Create Order
            </h2>
            <button class="help-close" onclick="closeOrderModal()">√ó</button>
        </div>
        
        <div style="margin-bottom: 20px;">
            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                <button class="btn btn-secondary" id="orderTypeSellBtn" style="flex: 1;" onclick="setOrderType('sell')">
                    <i class="fas fa-tag"></i> Sell
                </button>
                <button class="btn btn-secondary" id="orderTypeBuyBtn" style="flex: 1;" onclick="setOrderType('buy')">
                    <i class="fas fa-cart-shopping"></i> Buy
                </button>
            </div>
            
            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                <button class="btn btn-secondary" id="orderResourceMilkBtn" style="flex: 1;" onclick="setOrderResource('milk')">
                    ü•õ Milk
                </button>
                <button class="btn btn-secondary" id="orderResourceEggsBtn" style="flex: 1;" onclick="setOrderResource('eggs')">
                    ü•ö Eggs
                </button>
            </div>
        </div>
        
        <div class="best-price-info" id="bestPriceInfo">
            <span>üî• Best price:</span>
            <span id="bestPriceValue">0.0000 TON</span>
        </div>
        
        <div class="form-group">
            <label class="form-label">Quantity</label>
            <input type="number" id="orderQuantity" class="form-input" placeholder="1000" min="100">
            <div class="available-balance">
                <span>Available:</span>
                <span id="availableBalance">0</span>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Price per unit (TON)</label>
            <input type="number" id="orderPrice" class="form-input" placeholder="0.01" step="0.0001" min="0.0001">
        </div>
        
        <button class="btn btn-primary" id="createOrderBtn" onclick="createOrder()">
            <i class="fas fa-check-circle"></i>
            Create Order
        </button>
    </div>

    <!-- ==================== DEPOSIT MODAL ==================== -->
    <div class="modal-overlay" id="depositOverlay" onclick="closeDepositModal()"></div>
    <div class="order-modal" id="depositModal">
        <div class="help-header">
            <h2>
                <i class="fas fa-arrow-down" style="color: var(--success);"></i>
                Deposit TON
            </h2>
            <button class="help-close" onclick="closeDepositModal()">√ó</button>
        </div>
        
        <!-- Wallet Status -->
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: rgba(255,255,255,0.04); border-radius: 16px; margin-bottom: 20px;">
            <div>
                <div style="font-size: 14px; font-weight: 600;">Wallet</div>
                <div style="font-size: 12px; color: var(--text-secondary);" id="depositWalletAddress">Not connected</div>
            </div>
            <button class="btn btn-primary" onclick="connectWallet()" id="connectWalletBtn" style="width: auto; padding: 10px 20px;">
                <i class="fas fa-plug"></i> Connect
            </button>
        </div>
        
        <div class="form-group">
            <label class="form-label">Amount (TON)</label>
            <input type="number" id="depositAmount" class="form-input" placeholder="0.1" step="0.1" min="0.1">
            <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button class="btn btn-secondary" style="flex: 1; padding: 8px;" onclick="setDepositAmount(0.5)">0.5</button>
                <button class="btn btn-secondary" style="flex: 1; padding: 8px;" onclick="setDepositAmount(1)">1</button>
                <button class="btn btn-secondary" style="flex: 1; padding: 8px;" onclick="setDepositAmount(5)">5</button>
                <button class="btn btn-secondary" style="flex: 1; padding: 8px;" onclick="setDepositAmount(10)">10</button>
            </div>
        </div>
        
        <div style="background: rgba(253, 203, 110, 0.1); padding: 16px; border-radius: 16px; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <i class="fas fa-info-circle" style="color: var(--warning);"></i>
                <span style="font-size: 13px; font-weight: 600;">Important: Comment must be your User ID only</span>
            </div>
            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 12px; font-family: monospace; font-size: 16px; font-weight: 700; color: var(--warning); text-align: center;" id="depositUserIdDisplay">
                123456789
            </div>
        </div>
        
        <button class="btn btn-success" onclick="initiateDeposit()" id="depositSubmitBtn" disabled style="width: 100%; margin-bottom: 12px;">
            <i class="fas fa-paper-plane"></i>
            Send Transaction
        </button>
    </div>

    <!-- ==================== TRANSACTION SUCCESS MODAL ==================== -->
    <div class="modal-overlay" id="txOverlay" onclick="closeTxModal()"></div>
    <div class="tx-modal" id="txModal">
        <div class="tx-icon">‚úÖ</div>
        <div class="tx-title" id="txTitle">Transaction Sent!</div>
        <div class="tx-message" id="txMessage">
            Your deposit has been submitted.<br>
            Balance will be credited within 1-3 minutes.
        </div>
        <button class="btn btn-primary" onclick="closeTxModal()" style="width: 100%;">
            Done
        </button>
    </div>

    <!-- ==================== MAIN CONTAINER ==================== -->
    <div class="app-container" id="appContainer" style="display: none;">
        
        <!-- ==================== HOME TAB (FARM) ==================== -->
        <div id="homeTab" class="content-section active">
            <div class="machine-grid">
                <!-- Cow Machine Card -->
                <div class="machine-card" id="cowMachineCard">
                    <div class="machine-header">
                        <div class="machine-icon cow">üêÆ</div>
                        <div class="machine-info">
                            <div class="machine-name-row">
                                <span class="machine-name">Cow Machine</span>
                                <span class="machine-badge" id="cowBadge">Available</span>
                            </div>
                            <div class="machine-price">
                                <i class="fas fa-bolt"></i> 1 TON
                            </div>
                        </div>
                    </div>
                    
                    <div class="machine-stats-grid">
                        <div class="machine-stat">
                            <div class="machine-stat-label">Production</div>
                            <div class="machine-stat-value">41 ü•õ/h</div>
                        </div>
                        <div class="machine-stat">
                            <div class="machine-stat-label">Owned</div>
                            <div class="machine-stat-value" id="cowsOwned">0</div>
                        </div>
                    </div>
                    
                    <div class="global-supply">
                        <div class="supply-header">
                            <span>Global Supply</span>
                            <span id="cowProgressText">0/1000</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="cowProgressFill" style="width: 0%;"></div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="buyCowBtn" onclick="buyCow()" style="flex: 2;">
                            <i class="fas fa-shopping-cart"></i> Buy
                        </button>
                        <button class="btn btn-hatch" id="hatchCowBtnMain" onclick="openHatchModal('cow')" style="flex: 1;" disabled>
                            <i class="fas fa-flask"></i> Hatch
                        </button>
                    </div>
                </div>
                
                <!-- Chicken Machine Card -->
                <div class="machine-card" id="chickenMachineCard">
                    <div class="machine-header">
                        <div class="machine-icon chicken">üêî</div>
                        <div class="machine-info">
                            <div class="machine-name-row">
                                <span class="machine-name">Chicken Machine</span>
                                <span class="machine-badge" id="chickenBadge">Locked</span>
                            </div>
                            <div class="machine-price">
                                <i class="fas fa-bolt"></i> 1 TON
                            </div>
                        </div>
                    </div>
                    
                    <div class="machine-stats-grid">
                        <div class="machine-stat">
                            <div class="machine-stat-label">Production</div>
                            <div class="machine-stat-value">41 ü•ö/h</div>
                        </div>
                        <div class="machine-stat">
                            <div class="machine-stat-label">Owned</div>
                            <div class="machine-stat-value" id="chickensOwned">0</div>
                        </div>
                    </div>
                    
                    <div class="global-supply">
                        <div class="supply-header">
                            <span>Global Supply</span>
                            <span id="chickenProgressText">0/1000</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="chickenProgressFill" style="width: 0%;"></div>
                        </div>
                        <div class="unlock-text" id="chickenUnlockText">
                            <i class="fas fa-lock"></i> Unlocks after Cow batch ends
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="buyChickenBtn" onclick="buyChicken()" style="flex: 2;" disabled>
                            <i class="fas fa-lock"></i> Locked
                        </button>
                        <button class="btn btn-hatch" id="hatchChickenBtnMain" onclick="openHatchModal('chicken')" style="flex: 1;" disabled>
                            <i class="fas fa-flask"></i> Hatch
                        </button>
                    </div>
                </div>
                
                <!-- Diamond Engine Card -->
                <div class="machine-card diamond-card" id="diamondEngineCard">
                    <div class="machine-header">
                        <div class="machine-icon diamond">üíé</div>
                        <div class="machine-info">
                            <div class="machine-name-row">
                                <span class="machine-name">Diamond Engine</span>
                                <span class="machine-badge" id="diamondBadge">Locked</span>
                            </div>
                            <div class="machine-price">
                                <i class="fas fa-bolt"></i> 20 TON
                            </div>
                        </div>
                    </div>
                    
                    <div class="production-costs">
                        <div class="cost-item">
                            <div class="cost-icon">ü•õ</div>
                            <div class="cost-value" id="diamondCostMilk">20,000</div>
                            <div class="cost-label">Milk</div>
                        </div>
                        <div class="cost-item">
                            <div class="cost-icon">ü•ö</div>
                            <div class="cost-value" id="diamondCostEggs">20,000</div>
                            <div class="cost-label">Eggs</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin: 16px 0; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 16px;">
                        <div style="text-align: center; flex: 1;">
                            <div style="font-size: 11px; color: var(--text-muted);">Owned</div>
                            <div style="font-size: 20px; font-weight: 700;" id="diamondEnginesOwned">0</div>
                        </div>
                        <div style="text-align: center; flex: 1;">
                            <div style="font-size: 11px; color: var(--text-muted);">Yield</div>
                            <div style="font-size: 20px; font-weight: 700;">1 üíé</div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="buyDiamondBtn" onclick="buyDiamondEngine()" style="flex: 1;" disabled>
                            <i class="fas fa-shopping-cart"></i> Buy
                        </button>
                        <button class="btn btn-success" id="startDiamondBtn" onclick="startDiamondProduction()" style="flex: 1;" disabled>
                            <i class="fas fa-play"></i> Start
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== MARKET TAB ==================== -->
        <div id="marketTab" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-chart-line"></i>
                        P2P Market
                    </h2>
                </div>
                
                <!-- Market Tabs -->
                <div class="market-tabs">
                    <div class="market-tab active" onclick="switchMarketTab('market')">Market</div>
                    <div class="market-tab" onclick="switchMarketTab('myorders')">My Orders</div>
                </div>
                
                <!-- Market Section -->
                <div id="marketSection">
                    <!-- Resource Toggle -->
                    <div class="resource-toggle">
                        <div class="resource-option active" id="resourceMilkBtn" onclick="switchMarketResource('milk')">
                            ü•õ Milk
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="resource-option" id="resourceEggsBtn" onclick="switchMarketResource('eggs')">
                            ü•ö Eggs
                            <i class="fas fa-times-circle"></i>
                        </div>
                    </div>
                    
                    <!-- Orders Grid -->
                    <div style="margin-bottom: 16px;">
                        <h3 style="font-size: 15px; margin-bottom: 12px; color: var(--text-secondary);">
                            üî• Sell Orders
                        </h3>
                        <div class="orders-grid" id="sellOrdersGrid">
                            <!-- Will be populated by JS -->
                            <div style="grid-column: span 2; text-align: center; padding: 30px; color: var(--text-muted);">
                                <i class="fas fa-inbox" style="font-size: 40px; margin-bottom: 12px; opacity: 0.5;"></i>
                                <p>No active orders</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- My Orders Section -->
                <div id="myOrdersSection" style="display: none;">
                    <div id="myOrdersList">
                        <div style="text-align: center; padding: 30px; color: var(--text-muted);">
                            <i class="fas fa-clipboard-list" style="font-size: 40px; margin-bottom: 12px; opacity: 0.5;"></i>
                            <p>You have no active orders</p>
                        </div>
                    </div>
                </div>
                
                <!-- Create Order Button -->
                <button class="create-order-btn" onclick="openOrderModal()">
                    <i class="fas fa-plus-circle"></i>
                    Create Order
                </button>
            </div>
        </div>
        
        <!-- ==================== DIAMOND TAB ==================== -->
        <div id="diamondTab" class="content-section">
            <div class="card diamond-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-gem"></i>
                        Diamond Conversion
                    </h2>
                </div>
                
                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="font-size: 56px; margin-bottom: 8px;">üíé</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">
                        Convert Diamonds to TON
                    </div>
                </div>
                
                <div class="diamond-price-big">
                    <span>1 üíé =</span>
                    <span style="color: var(--ton-color);" id="diamondPrice">5</span>
                    <span>TON</span>
                </div>
                
                <div style="display: flex; align-items: center; justify-content: space-between; margin: 24px 0; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: var(--text-muted);">Your Diamonds</div>
                        <div style="font-size: 32px; font-weight: 800;" id="diamondBalance">0</div>
                    </div>
                    <div>
                        <i class="fas fa-arrow-right" style="font-size: 24px; color: var(--text-muted);"></i>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: var(--text-muted);">You Receive</div>
                        <div style="font-size: 32px; font-weight: 800; color: var(--ton-color);" id="tonReceive">0</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <input type="number" id="convertAmount" class="form-input" placeholder="Amount" min="1" style="flex: 1;">
                    <button class="btn btn-primary" onclick="convertDiamond()" style="width: 120px;">
                        Convert
                    </button>
                </div>
                
                <div style="font-size: 12px; color: var(--text-muted); text-align: center;">
                    <i class="fas fa-info-circle"></i>
                    Diamond price is dynamic and set by the team
                </div>
            </div>
        </div>
        
        <!-- ==================== FRIENDS TAB ==================== -->
        <div id="friendsTab" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-users"></i>
                        Referral Program
                    </h2>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(0,184,148,0.1), rgba(108,92,231,0.1)); padding: 20px; border-radius: 20px; margin-bottom: 20px;">
                    <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px;">
                        Earn 10% Commission
                    </div>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
                        Invite friends and earn 10% of every TON purchase they make!
                    </p>
                    
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="referralLink" class="form-input" readonly style="flex: 1;">
                        <button class="btn btn-primary" onclick="copyReferralLink()" style="width: 50px; padding: 0;">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="referral-stats-grid">
                    <div class="referral-stat-card">
                        <div class="referral-stat-value" id="totalReferrals">0</div>
                        <div class="referral-stat-label">Friends</div>
                    </div>
                    <div class="referral-stat-card">
                        <div class="referral-stat-value" id="referralEarnings">0</div>
                        <div class="referral-stat-label">Earned (TON)</div>
                    </div>
                    <div class="referral-stat-card">
                        <div class="referral-stat-value" id="referralClaimed">0</div>
                        <div class="referral-stat-label">Claimed</div>
                    </div>
                </div>
                
                <button class="btn btn-success" id="claimReferralBtn" onclick="claimReferralEarnings()" style="width: 100%; margin-top: 8px;" disabled>
                    <i class="fas fa-hand-holding-usd"></i>
                    Claim Earnings
                </button>
            </div>
            
            <div class="card">
                <h2 class="card-title">
                    <i class="fas fa-clock"></i>
                    Recent Referrals
                </h2>
                <div id="recentReferralsList" style="color: var(--text-secondary);">
                    <div style="text-align: center; padding: 20px;">
                        No referrals yet
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== PROFILE TAB ==================== -->
        <div id="profileTab" class="content-section">
            <div class="card">
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                    <div style="width: 70px; height: 70px; background: linear-gradient(135deg, var(--primary-green), var(--primary-purple)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 36px;">
                        üë®‚Äçüåæ
                    </div>
                    <div>
                        <div style="font-size: 22px; font-weight: 700;" id="profileName">Farmer</div>
                        <div style="font-size: 14px; color: var(--text-secondary);" id="profileUsername">@username</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div style="background: rgba(255,255,255,0.04); padding: 16px; border-radius: 16px;">
                        <div style="font-size: 12px; color: var(--text-muted);">Total Machines</div>
                        <div style="font-size: 28px; font-weight: 700;" id="totalMachines">0</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.04); padding: 16px; border-radius: 16px;">
                        <div style="font-size: 12px; color: var(--text-muted);">Production</div>
                        <div style="font-size: 28px; font-weight: 700;" id="totalProduction">0/h</div>
                    </div>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.04); border-radius: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ü•õ</div>
                            <div>
                                <div style="font-weight: 600;">Milk</div>
                                <div style="font-size: 11px; color: var(--text-muted);" id="profileMilkRate">0/h</div>
                            </div>
                        </div>
                        <div style="font-size: 22px; font-weight: 700;" id="profileMilk">0</div>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.04); border-radius: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ü•ö</div>
                            <div>
                                <div style="font-weight: 600;">Eggs</div>
                                <div style="font-size: 11px; color: var(--text-muted);" id="profileEggsRate">0/h</div>
                            </div>
                        </div>
                        <div style="font-size: 22px; font-weight: 700;" id="profileEggs">0</div>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.04); border-radius: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px;">üíé</div>
                            <div>
                                <div style="font-weight: 600;">Diamond</div>
                                <div style="font-size: 11px; color: var(--text-muted);">1 üíé = <span id="profileDiamondPrice">5</span> TON</div>
                            </div>
                        </div>
                        <div style="font-size: 22px; font-weight: 700;" id="profileDiamond">0</div>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.04); border-radius: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px;">‚ö°</div>
                            <div>
                                <div style="font-weight: 600;">TON</div>
                                <div style="font-size: 11px; color: var(--text-muted);">Balance</div>
                            </div>
                        </div>
                        <div style="font-size: 22px; font-weight: 700;" id="profileTon">0.0000</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">
                    <i class="fas fa-arrow-up"></i>
                    Withdraw TON
                </h2>
                
                <div class="form-group">
                    <label class="form-label">Amount (Min 0.5 TON)</label>
                    <input type="number" id="withdrawAmount" class="form-input" placeholder="0.5" step="0.1" min="0.5">
                </div>
                
                <div class="form-group">
                    <label class="form-label">TON Wallet Address</label>
                    <input type="text" id="withdrawAddress" class="form-input" placeholder="EQD...">
                </div>
                
                <div style="background: rgba(255,255,255,0.04); padding: 16px; border-radius: 16px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--text-muted);">Fee (5%):</span>
                        <span id="withdrawFee">0 TON</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 18px;">
                        <span>You receive:</span>
                        <span id="withdrawNet">0 TON</span>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="withdrawTON()" style="width: 100%;">
                    <i class="fas fa-paper-plane"></i>
                    Withdraw TON
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== BOTTOM NAVIGATION ==================== -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('homeTab')">
            <div class="nav-icon">üè†</div>
            <div class="nav-text">Farm</div>
        </div>
        <div class="nav-item" onclick="switchTab('marketTab')">
            <div class="nav-icon">üìä</div>
            <div class="nav-text">Market</div>
        </div>
        <div class="nav-item" onclick="switchTab('diamondTab')">
            <div class="nav-icon">üíé</div>
            <div class="nav-text">Diamond</div>
        </div>
        <div class="nav-item" onclick="switchTab('friendsTab')">
            <div class="nav-icon">üë•</div>
            <div class="nav-text">Friends</div>
        </div>
        <div class="nav-item" onclick="switchTab('profileTab')">
            <div class="nav-icon">üë§</div>
            <div class="nav-text">Profile</div>
        </div>
    </nav>

    <script>
        // ==============================================
        // CONFIGURATION
        // ==============================================
        const API_BASE = 'https://silent-block-bedf.ahmedrabieharoun.workers.dev';
        const DEPOSIT_ADDRESS = 'UQBnwSS4Kox3ZZmF69KxWLfvfCc2-dLV8sT5nJe-aV7HfCyG';
        const BOT_USERNAME = 'testtt1257bot';
        
        // ==============================================
        // GAME STATE
        // ==============================================
        let gameState = {
            user: {
                tonBalance: 0,
                milk: 0,
                eggs: 0,
                diamond: 0,
                cows_owned: 0,
                chickens_owned: 0,
                diamond_engines_owned: 0,
                milkPerHour: 0,
                eggsPerHour: 0,
                lastProduction: Date.now(),
                referralCode: '',
                referralEarnings: 0,
                referralEarningsClaimed: 0,
                referredBy: null
            },
            global: {
                cows_sold: 0,
                cows_cap: 1000,
                chickens_sold: 0,
                chickens_cap: 1000,
                chicken_unlocked: false,
                diamond_unlocked: false,
                diamond_price: 5
            },
            market: {
                milk: { sellOrders: [], buyOrders: [] },
                eggs: { sellOrders: [], buyOrders: [] }
            },
            referral: {
                totalReferrals: 0,
                totalRewards: 0,
                referralList: []
            }
        };
        
        // ==============================================
        // UI STATE
        // ==============================================
        let USER_ID = null;
        let TELEGRAM_INIT_DATA = '';
        let TELEGRAM_START_PARAM = null;
        let connectedWallet = null;
        let tonConnectUI = null;
        let isTONConnectInitialized = false;
        
        // UI States
        let currentMarketResource = 'milk';
        let currentOrderType = 'sell';
        let currentOrderResource = 'milk';
        
        // ==============================================
        // INITIALIZATION
        // ==============================================
        async function initialize() {
            console.log('üöú Initializing Farm Economy...');
            
            // 1. Setup Telegram
            await setupTelegram();
            
            // 2. Initialize TON Connect
            setTimeout(() => initTONConnect(), 1000);
            
            // 3. Loading animation
            let progress = 0;
            const loadingInterval = setInterval(() => {
                progress += 10;
                document.getElementById('loadingProgress').style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(loadingInterval);
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';
                    
                    // 4. Initialize user and load state
                    initializeUser();
                    
                    // 5. Auto refresh every 10 seconds
                    setInterval(loadGameState, 10000);
                    
                    console.log('‚úÖ Farm Economy initialized');
                }
            }, 100);
        }
        
        // ==============================================
        // TELEGRAM SETUP
        // ==============================================
        async function setupTelegram() {
            if (window.Telegram?.WebApp) {
                const webapp = window.Telegram.WebApp;
                webapp.ready();
                webapp.expand();
                
                // Get init data
                TELEGRAM_INIT_DATA = webapp.initData || '';
                
                // Get start param (for referral) - using startapp NOT start
                if (webapp.initDataUnsafe?.start_param) {
                    const param = webapp.initDataUnsafe.start_param;
                    if (param.startsWith('ref_')) {
                        TELEGRAM_START_PARAM = param.replace('ref_', '');
                        console.log('üë• Referrer detected:', TELEGRAM_START_PARAM);
                    }
                }
                
                // Get user data
                if (webapp.initDataUnsafe?.user) {
                    const user = webapp.initDataUnsafe.user;
                    USER_ID = String(user.id);
                    
                    document.getElementById('profileName').textContent = 
                        `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Farmer';
                    document.getElementById('profileUsername').textContent = 
                        user.username ? `@${user.username}` : `User ${user.id}`;
                    document.getElementById('depositUserIdDisplay').textContent = USER_ID;
                }
            }
            
            // Fallback for testing
            if (!USER_ID) {
                USER_ID = 'test_user_' + Math.floor(Math.random() * 1000000);
                document.getElementById('profileName').textContent = 'Test Farmer';
                document.getElementById('profileUsername').textContent = '@tester';
                document.getElementById('depositUserIdDisplay').textContent = USER_ID;
            }
        }
        
        // ==============================================
        // TON CONNECT
        // ==============================================
        async function initTONConnect() {
            if (isTONConnectInitialized) return;
            
            try {
                const manifestUrl = `${API_BASE}/tonconnect-manifest.json`;
                
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: manifestUrl,
                    language: 'en',
                    uiPreferences: { theme: 'DARK' }
                });
                
                tonConnectUI.onStatusChange((wallet) => {
                    if (wallet) {
                        connectedWallet = {
                            address: wallet.account.address,
                            chain: wallet.account.chain,
                            app: wallet.device.appName
                        };
                        
                        const shortAddress = `${connectedWallet.address.substring(0, 6)}...${connectedWallet.address.substring(connectedWallet.address.length - 4)}`;
                        document.getElementById('depositWalletAddress').textContent = shortAddress;
                        document.getElementById('depositSubmitBtn').disabled = false;
                        document.getElementById('connectWalletBtn').innerHTML = '<i class="fas fa-check"></i> Connected';
                    } else {
                        connectedWallet = null;
                        document.getElementById('depositWalletAddress').textContent = 'Not connected';
                        document.getElementById('depositSubmitBtn').disabled = true;
                        document.getElementById('connectWalletBtn').innerHTML = '<i class="fas fa-plug"></i> Connect';
                    }
                });
                
                isTONConnectInitialized = true;
                
            } catch (error) {
                console.error('TON Connect init error:', error);
            }
        }
        
        async function connectWallet() {
            if (!tonConnectUI) await initTONConnect();
            await tonConnectUI.openModal();
        }
        
        // ==============================================
        // API CALLS
        // ==============================================
        async function callAPI(action, data = {}) {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    'X-Action': action,
                    'Authorization': `Telegram ${TELEGRAM_INIT_DATA}`
                };
                
                const response = await fetch(`${API_BASE}/api`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ action, data })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    return result.data;
                } else {
                    throw new Error(result.error || 'API Error');
                }
                
            } catch (error) {
                console.error(`API Error (${action}):`, error);
                throw error;
            }
        }
        
        // ==============================================
        // USER INITIALIZATION
        // ==============================================
        async function initializeUser() {
            try {
                // Send referrer if exists
                if (TELEGRAM_START_PARAM) {
                    await callAPI('initializeUser', {
                        user: { id: USER_ID },
                        referredBy: TELEGRAM_START_PARAM
                    }).catch(() => {});
                }
                
                // Load game state
                await loadGameState();
                
            } catch (error) {
                console.error('User init error:', error);
            }
        }
        
        // ==============================================
        // LOAD GAME STATE
        // ==============================================
        async function loadGameState() {
            try {
                const data = await callAPI('getState');
                gameState = data;
                updateUI();
                updateMarketUI();
                updateReferralUI();
            } catch (error) {
                console.error('Load state error:', error);
            }
        }
        
        // ==============================================
        // PRODUCTION CALCULATION (NO CRON)
        // ==============================================
        function calculateProduction(user) {
            const now = Date.now();
            const lastProduction = user.lastProduction || now;
            
            // Calculate hours passed since last production
            const hoursPassed = Math.floor((now - lastProduction) / (60 * 60 * 1000));
            
            if (hoursPassed > 0) {
                // Milk production
                const milkProduced = (user.cows_owned || 0) * 41 * hoursPassed;
                // Eggs production
                const eggsProduced = (user.chickens_owned || 0) * 41 * hoursPassed;
                
                // Update last production timestamp
                user.lastProduction = lastProduction + (hoursPassed * 60 * 60 * 1000);
                user.milk = (user.milk || 0) + milkProduced;
                user.eggs = (user.eggs || 0) + eggsProduced;
            }
            
            return user;
        }
        
        // ==============================================
        // MACHINE PURCHASES
        // ==============================================
        async function buyCow() {
            try {
                const data = await callAPI('buyCow', {
                    referredBy: TELEGRAM_START_PARAM
                });
                
                gameState.user.cows_owned = 1;
                gameState.user.tonBalance = data.newTonBalance;
                gameState.global.cows_sold = data.cows_sold;
                gameState.global.chicken_unlocked = data.chicken_unlocked;
                
                updateUI();
                showTxModal('‚úÖ Success!', 'Cow machine purchased successfully!');
                
            } catch (error) {
                alert(error.message);
            }
        }
        
        async function buyChicken() {
            try {
                const data = await callAPI('buyChicken', {});
                
                gameState.user.chickens_owned = 1;
                gameState.user.tonBalance = data.newTonBalance;
                gameState.global.chickens_sold = data.chickens_sold;
                gameState.global.diamond_unlocked = data.diamond_unlocked;
                
                updateUI();
                showTxModal('‚úÖ Success!', 'Chicken machine purchased successfully!');
                
            } catch (error) {
                alert(error.message);
            }
        }
        
        async function buyDiamondEngine() {
            try {
                const data = await callAPI('buyDiamondEngine', {});
                
                gameState.user.diamond_engines_owned = 1;
                gameState.user.tonBalance = data.newTonBalance;
                
                updateUI();
                showTxModal('‚úÖ Success!', 'Diamond Engine purchased successfully!');
                
            } catch (error) {
                alert(error.message);
            }
        }
        
        // ==============================================
        // HATCH SYSTEM (CONVERT RESOURCES TO MACHINES)
        // ==============================================
        async function hatchCow() {
            try {
                const data = await callAPI('hatchCow', {});
                
                gameState.user.milk = data.newMilk;
                gameState.user.cows_owned = data.newCowsOwned;
                
                updateUI();
                closeHatchModal();
                showTxModal('‚úÖ Hatch Successful!', 'You converted 10,000 Milk into 1 Cow Machine!');
                
            } catch (error) {
                alert(error.message);
            }
        }
        
        async function hatchChicken() {
            try {
                const data = await callAPI('hatchChicken', {});
                
                gameState.user.eggs = data.newEggs;
                gameState.user.chickens_owned = data.newChickensOwned;
                
                updateUI();
                closeHatchModal();
                showTxModal('‚úÖ Hatch Successful!', 'You converted 10,000 Eggs into 1 Chicken Machine!');
                
            } catch (error) {
                alert(error.message);
            }
        }
        
        // ==============================================
        // DIAMOND PRODUCTION
        // ==============================================
        async function startDiamondProduction() {
            try {
                const data = await callAPI('startDiamondProduction', {});
                
                gameState.user.milk = data.newMilk;
                gameState.user.eggs = data.newEggs;
                gameState.user.diamond = data.newDiamond;
                
                updateUI();
                showTxModal('üíé Production Complete!', 'You produced 1 Diamond!');
                
            } catch (error) {
                alert(error.message);
            }
        }
        
        // ==============================================
        // DIAMOND CONVERSION
        // ==============================================
        async function convertDiamond() {
            const amount = parseInt(document.getElementById('convertAmount').value);
            
            if (!amount || amount <= 0) {
                alert('Enter a valid amount');
                return;
            }
            
            if (amount > gameState.user.diamond) {
                alert('Insufficient diamonds');
                return;
            }
            
            try {
                const data = await callAPI('convertDiamond', { amount });
                
                gameState.user.diamond = data.newDiamond;
                gameState.user.tonBalance = data.newTonBalance;
                
                updateUI();
                document.getElementById('convertAmount').value = '';
                showTxModal('‚úÖ Conversion Complete!', `Converted ${amount} Diamonds to ${data.tonReceived} TON!`);
                
            } catch (error) {
                alert(error.message);
            }
        }
        
        // ==============================================
        // MARKET ORDERS
        // ==============================================
        async function createOrder() {
            const quantity = parseInt(document.getElementById('orderQuantity').value);
            const price = parseFloat(document.getElementById('orderPrice').value);
            
            if (!quantity || quantity < 100) {
                alert('Minimum order quantity is 100');
                return;
            }
            
            if (!price || price <= 0) {
                alert('Enter a valid price');
                return;
            }
            
            try {
                const data = await callAPI('createOrder', {
                    type: currentOrderType,
                    resource: currentOrderResource,
                    quantity: quantity,
                    price: price
                });
                
                closeOrderModal();
                showTxModal('‚úÖ Order Created!', 'Your order has been placed successfully!');
                loadGameState();
                
            } catch (error) {
                alert(error.message);
            }
        }
        
        async function buyOrder(orderId, quantity) {
            try {
                const data = await callAPI('buyOrder', {
                    orderId: orderId,
                    quantity: quantity
                });
                
                showTxModal('‚úÖ Purchase Successful!', `You bought ${data.quantity} ${data.resource} for ${data.tonPaid} TON!`);
                loadGameState();
                
            } catch (error) {
                alert(error.message);
            }
        }
        
        // ==============================================
        // REFERRAL SYSTEM
        // ==============================================
        async function claimReferralEarnings() {
            try {
                const data = await callAPI('claimReferralEarnings', {});
                
                gameState.user.tonBalance = data.newTonBalance;
                gameState.user.referralEarnings = 0;
                gameState.user.referralEarningsClaimed += data.claimedAmount;
                
                updateUI();
                showTxModal('‚úÖ Claimed!', `You claimed ${data.claimedAmount} TON from referrals!`);
                
            } catch (error) {
                alert(error.message);
            }
        }
        
        function copyReferralLink() {
            const input = document.getElementById('referralLink');
            input.select();
            navigator.clipboard.writeText(input.value);
            alert('‚úÖ Referral link copied!');
        }
        
        // ==============================================
        // DEPOSIT (TON CONNECT - COMMENT = USER ID ONLY)
        // ==============================================
        async function initiateDeposit() {
            if (!connectedWallet) {
                alert('Please connect your wallet first');
                return;
            }
            
            const amount = parseFloat(document.getElementById('depositAmount').value);
            
            if (!amount || amount < 0.1) {
                alert('Minimum deposit is 0.1 TON');
                return;
            }
            
            try {
                // IMPORTANT: Comment must be ONLY the User ID
                // Using proper cell encoding for comment
                const comment = USER_ID;
                
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 300,
                    messages: [
                        {
                            address: DEPOSIT_ADDRESS,
                            amount: String(Math.floor(amount * 1000000000)), // Convert to nanoTON
                            payload: comment // User ID only - no extra text
                        }
                    ]
                };
                
                const result = await tonConnectUI.sendTransaction(transaction);
                
                // Send confirmation to server
                await callAPI('deposit/confirm', {
                    txHash: result.boc,
                    amount: amount,
                    user_address: connectedWallet.address,
                    comment: comment
                }).catch(() => {});
                
                // Close deposit modal and show success
                closeDepositModal();
                showTxModal(
                    '‚úÖ Transaction Sent!', 
                    'Your deposit has been submitted.\nBalance will be credited within 1-3 minutes.'
                );
                
                document.getElementById('depositAmount').value = '';
                
            } catch (error) {
                console.error('Deposit error:', error);
                alert('Transaction failed: ' + error.message);
            }
        }
        
        // ==============================================
        // WITHDRAWAL
        // ==============================================
        async function withdrawTON() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const address = document.getElementById('withdrawAddress').value;
            
            if (!amount || amount < 0.5) {
                alert('Minimum withdrawal is 0.5 TON');
                return;
            }
            
            if (!address || address.length < 10) {
                alert('Enter a valid TON address');
                return;
            }
            
            if (amount > gameState.user.tonBalance) {
                alert('Insufficient balance');
                return;
            }
            
            try {
                const data = await callAPI('withdrawTON', {
                    amount: amount,
                    address: address
                });
                
                gameState.user.tonBalance = data.newBalance;
                updateUI();
                
                showTxModal('‚úÖ Withdrawal Submitted!', `You will receive ${data.netAmount} TON within 24 hours.`);
                
                document.getElementById('withdrawAmount').value = '';
                document.getElementById('withdrawAddress').value = '';
                
            } catch (error) {
                alert(error.message);
            }
        }
        
        // ==============================================
        // UI UPDATE
        // ==============================================
        function updateUI() {
            // Calculate production first
            gameState.user = calculateProduction(gameState.user);
            
            // ===== STATUS BAR =====
            document.getElementById('statusMilk').textContent = formatNumber(gameState.user.milk);
            document.getElementById('statusEggs').textContent = formatNumber(gameState.user.eggs);
            document.getElementById('statusDiamond').textContent = formatNumber(gameState.user.diamond);
            document.getElementById('statusTon').textContent = formatTON(gameState.user.tonBalance);
            
            // Production rates
            const milkRate = (gameState.user.cows_owned || 0) * 41;
            const eggsRate = (gameState.user.chickens_owned || 0) * 41;
            
            document.getElementById('statusMilkRate').innerHTML = `<i class="fas fa-arrow-up"></i> ${milkRate} / hour`;
            document.getElementById('statusEggsRate').innerHTML = `<i class="fas fa-arrow-up"></i> ${eggsRate} / hour`;
            
            // ===== COW MACHINE =====
            document.getElementById('cowsOwned').textContent = gameState.user.cows_owned || 0;
            document.getElementById('cowProgressText').textContent = `${gameState.global.cows_sold || 0}/${gameState.global.cows_cap}`;
            document.getElementById('cowProgressFill').style.width = `${((gameState.global.cows_sold || 0) / gameState.global.cows_cap) * 100}%`;
            
            const cowBtn = document.getElementById('buyCowBtn');
            const cowBadge = document.getElementById('cowBadge');
            const hatchCowBtnMain = document.getElementById('hatchCowBtnMain');
            
            if (gameState.user.cows_owned > 0) {
                cowBtn.disabled = true;
                cowBtn.innerHTML = '<i class="fas fa-check"></i> Owned';
                cowBadge.textContent = 'OWNED';
                cowBadge.className = 'machine-badge badge-owned';
            } else if (gameState.global.cows_sold >= gameState.global.cows_cap) {
                cowBtn.disabled = true;
                cowBtn.innerHTML = '<i class="fas fa-ban"></i> Sold Out';
                cowBadge.textContent = 'SOLD OUT';
                cowBadge.className = 'machine-badge badge-sold-out';
                document.getElementById('cowMachineCard').classList.add('sold-out');
            } else {
                cowBtn.disabled = gameState.user.tonBalance < 1;
                cowBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Buy';
                cowBadge.textContent = `${gameState.global.cows_cap - gameState.global.cows_sold} LEFT`;
                cowBadge.className = 'machine-badge';
                cowBadge.style.background = 'rgba(0,184,148,0.15)';
                cowBadge.style.color = 'var(--success)';
            }
            
            // Enable/disable Hatch button
            hatchCowBtnMain.disabled = (gameState.user.milk || 0) < 10000;
            document.getElementById('hatchCowsAvailable').textContent = gameState.user.cows_owned || 0;
            document.getElementById('hatchCowBtn').disabled = (gameState.user.milk || 0) < 10000;
            
            // ===== CHICKEN MACHINE =====
            document.getElementById('chickensOwned').textContent = gameState.user.chickens_owned || 0;
            document.getElementById('chickenProgressText').textContent = `${gameState.global.chickens_sold || 0}/${gameState.global.chickens_cap}`;
            document.getElementById('chickenProgressFill').style.width = `${((gameState.global.chickens_sold || 0) / gameState.global.chickens_cap) * 100}%`;
            
            const chickenBtn = document.getElementById('buyChickenBtn');
            const chickenBadge = document.getElementById('chickenBadge');
            const hatchChickenBtnMain = document.getElementById('hatchChickenBtnMain');
            const chickenUnlockText = document.getElementById('chickenUnlockText');
            
            if (!gameState.global.chicken_unlocked) {
                chickenBtn.disabled = true;
                chickenBtn.innerHTML = '<i class="fas fa-lock"></i> Locked';
                chickenBadge.textContent = 'LOCKED';
                chickenBadge.className = 'machine-badge badge-locked';
                chickenUnlockText.innerHTML = '<i class="fas fa-lock"></i> Unlocks after Cow batch ends';
                document.getElementById('chickenMachineCard').classList.add('locked');
            } else if (gameState.user.chickens_owned > 0) {
                chickenBtn.disabled = true;
                chickenBtn.innerHTML = '<i class="fas fa-check"></i> Owned';
                chickenBadge.textContent = 'OWNED';
                chickenBadge.className = 'machine-badge badge-owned';
                chickenUnlockText.style.display = 'none';
                document.getElementById('chickenMachineCard').classList.remove('locked');
            } else if (gameState.global.chickens_sold >= gameState.global.chickens_cap) {
                chickenBtn.disabled = true;
                chickenBtn.innerHTML = '<i class="fas fa-ban"></i> Sold Out';
                chickenBadge.textContent = 'SOLD OUT';
                chickenBadge.className = 'machine-badge badge-sold-out';
                chickenUnlockText.style.display = 'none';
            } else {
                chickenBtn.disabled = gameState.user.tonBalance < 1;
                chickenBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Buy';
                chickenBadge.textContent = `${gameState.global.chickens_cap - gameState.global.chickens_sold} LEFT`;
                chickenBadge.className = 'machine-badge';
                chickenBadge.style.background = 'rgba(0,184,148,0.15)';
                chickenBadge.style.color = 'var(--success)';
                chickenUnlockText.style.display = 'none';
                document.getElementById('chickenMachineCard').classList.remove('locked');
            }
            
            hatchChickenBtnMain.disabled = (gameState.user.eggs || 0) < 10000;
            document.getElementById('hatchChickensAvailable').textContent = gameState.user.chickens_owned || 0;
            document.getElementById('hatchChickenBtn').disabled = (gameState.user.eggs || 0) < 10000;
            
            // ===== DIAMOND ENGINE =====
            document.getElementById('diamondEnginesOwned').textContent = gameState.user.diamond_engines_owned || 0;
            
            const diamondBuyBtn = document.getElementById('buyDiamondBtn');
            const diamondStartBtn = document.getElementById('startDiamondBtn');
            const diamondBadge = document.getElementById('diamondBadge');
            
            if (!gameState.global.diamond_unlocked) {
                diamondBuyBtn.disabled = true;
                diamondBuyBtn.innerHTML = '<i class="fas fa-lock"></i> Locked';
                diamondStartBtn.disabled = true;
                diamondBadge.textContent = 'LOCKED';
                diamondBadge.className = 'machine-badge badge-locked';
                document.getElementById('diamondEngineCard').classList.add('locked');
            } else if (gameState.user.diamond_engines_owned > 0) {
                diamondBuyBtn.disabled = true;
                diamondBuyBtn.innerHTML = '<i class="fas fa-check"></i> Owned';
                diamondBadge.textContent = 'OWNED';
                diamondBadge.className = 'machine-badge badge-owned';
                
                const hasMilk = (gameState.user.milk || 0) >= 20000;
                const hasEggs = (gameState.user.eggs || 0) >= 20000;
                diamondStartBtn.disabled = !(hasMilk && hasEggs);
                diamondStartBtn.innerHTML = hasMilk && hasEggs ? 
                    '<i class="fas fa-play"></i> Start' : 
                    '<i class="fas fa-ban"></i> Insufficient';
                
                document.getElementById('diamondEngineCard').classList.remove('locked');
            } else {
                diamondBuyBtn.disabled = gameState.user.tonBalance < 20;
                diamondBuyBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Buy (20 TON)';
                diamondStartBtn.disabled = true;
                diamondStartBtn.innerHTML = '<i class="fas fa-play"></i> Start';
                diamondBadge.textContent = 'AVAILABLE';
                diamondBadge.className = 'machine-badge';
                diamondBadge.style.background = 'rgba(0,184,148,0.15)';
                diamondBadge.style.color = 'var(--success)';
                document.getElementById('diamondEngineCard').classList.remove('locked');
            }
            
            // ===== DIAMOND CONVERSION =====
            document.getElementById('diamondPrice').textContent = gameState.global.diamond_price || 5;
            document.getElementById('profileDiamondPrice').textContent = gameState.global.diamond_price || 5;
            document.getElementById('diamondBalance').textContent = formatNumber(gameState.user.diamond || 0);
            
            const convertAmount = document.getElementById('convertAmount').value || 0;
            const tonReceive = convertAmount * (gameState.global.diamond_price || 5);
            document.getElementById('tonReceive').textContent = formatTON(tonReceive);
            
            // ===== PROFILE =====
            document.getElementById('profileMilk').textContent = formatNumber(gameState.user.milk || 0);
            document.getElementById('profileEggs').textContent = formatNumber(gameState.user.eggs || 0);
            document.getElementById('profileDiamond').textContent = formatNumber(gameState.user.diamond || 0);
            document.getElementById('profileTon').textContent = formatTON(gameState.user.tonBalance || 0);
            
            document.getElementById('profileMilkRate').textContent = `${milkRate}/h`;
            document.getElementById('profileEggsRate').textContent = `${eggsRate}/h`;
            
            const totalMachines = (gameState.user.cows_owned || 0) + (gameState.user.chickens_owned || 0) + (gameState.user.diamond_engines_owned || 0);
            document.getElementById('totalMachines').textContent = totalMachines;
            document.getElementById('totalProduction').textContent = `${milkRate + eggsRate}/h`;
            
            // ===== REFERRAL =====
            if (gameState.user.referralCode) {
                const referralLink = `https://t.me/${BOT_USERNAME.replace('@', '')}?startapp=ref_${gameState.user.referralCode}`;
                document.getElementById('referralLink').value = referralLink;
            }
            
            document.getElementById('totalReferrals').textContent = gameState.referral?.totalReferrals || 0;
            document.getElementById('referralEarnings').textContent = formatTON(gameState.user.referralEarnings || 0);
            document.getElementById('referralClaimed').textContent = formatTON(gameState.user.referralEarningsClaimed || 0);
            
            const claimBtn = document.getElementById('claimReferralBtn');
            if (gameState.user.referralEarnings > 0) {
                claimBtn.disabled = false;
                claimBtn.innerHTML = `<i class="fas fa-hand-holding-usd"></i> Claim ${formatTON(gameState.user.referralEarnings)} TON`;
            } else {
                claimBtn.disabled = true;
                claimBtn.innerHTML = '<i class="fas fa-hand-holding-usd"></i> No Earnings';
            }
            
            // ===== WITHDRAWAL PREVIEW =====
            const withdrawAmount = parseFloat(document.getElementById('withdrawAmount').value) || 0;
            const withdrawFee = withdrawAmount * 0.05;
            const withdrawNet = withdrawAmount - withdrawFee;
            document.getElementById('withdrawFee').textContent = `${formatTON(withdrawFee)} TON`;
            document.getElementById('withdrawNet').textContent = `${formatTON(withdrawNet)} TON`;
        }
        
        // ==============================================
        // MARKET UI
        // ==============================================
        function updateMarketUI() {
            const resource = currentMarketResource;
            const marketData = gameState.market?.[resource] || { sellOrders: [] };
            
            const sellOrdersGrid = document.getElementById('sellOrdersGrid');
            
            if (marketData.sellOrders && marketData.sellOrders.length > 0) {
                // Sort by price (lowest first)
                const sortedOrders = [...marketData.sellOrders].sort((a, b) => a.price - b.price);
                const bestPrice = sortedOrders[0].price;
                
                let html = '';
                
                sortedOrders.forEach(order => {
                    const totalPrice = (order.quantity * order.price).toFixed(2);
                    const isBest = order.price === bestPrice;
                    
                    html += `
                        <div class="order-card ${isBest ? 'best' : ''}">
                            ${isBest ? '<div class="best-badge">üî• BEST</div>' : ''}
                            <div class="order-resource">
                                ${resource === 'milk' ? 'ü•õ' : 'ü•ö'} ${resource === 'milk' ? 'Milk' : 'Eggs'}
                            </div>
                            <div class="order-amount">${formatNumber(order.quantity)}</div>
                            <div class="order-total">${totalPrice} TON</div>
                            <div class="order-perunit">${order.price.toFixed(4)} TON/unit</div>
                            <button class="btn btn-primary" onclick="buyOrder('${order.id}', ${order.quantity})" style="padding: 10px; font-size: 13px;">
                                <i class="fas fa-cart-shopping"></i> Buy
                            </button>
                        </div>
                    `;
                });
                
                sellOrdersGrid.innerHTML = html;
            } else {
                sellOrdersGrid.innerHTML = `
                    <div style="grid-column: span 2; text-align: center; padding: 30px; color: var(--text-muted);">
                        <i class="fas fa-inbox" style="font-size: 40px; margin-bottom: 12px; opacity: 0.5;"></i>
                        <p>No active sell orders</p>
                    </div>
                `;
            }
        }
        
        function updateReferralUI() {
            const recentList = document.getElementById('recentReferralsList');
            
            if (gameState.referral?.referralList?.length > 0) {
                let html = '';
                gameState.referral.referralList.slice(0, 5).forEach(ref => {
                    const date = new Date(ref.timestamp).toLocaleDateString();
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--card-border);">
                            <div>
                                <div style="font-weight: 600;">User ${ref.userId.substring(0, 6)}...</div>
                                <div style="font-size: 11px; color: var(--text-muted);">${ref.type}</div>
                            </div>
                            <div style="color: var(--success); font-weight: 700;">+${ref.reward} TON</div>
                        </div>
                    `;
                });
                recentList.innerHTML = html;
            }
        }
        
        // ==============================================
        // UI ACTIONS
        // ==============================================
        function switchTab(tabId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.nav-item[onclick*="${tabId}"]`).classList.add('active');
        }
        
        function switchMarketTab(tab) {
            document.querySelectorAll('.market-tab').forEach(t => t.classList.remove('active'));
            
            if (tab === 'market') {
                document.querySelectorAll('.market-tab')[0].classList.add('active');
                document.getElementById('marketSection').style.display = 'block';
                document.getElementById('myOrdersSection').style.display = 'none';
            } else {
                document.querySelectorAll('.market-tab')[1].classList.add('active');
                document.getElementById('marketSection').style.display = 'none';
                document.getElementById('myOrdersSection').style.display = 'block';
            }
        }
        
        function switchMarketResource(resource) {
            currentMarketResource = resource;
            
            document.getElementById('resourceMilkBtn').classList.toggle('active', resource === 'milk');
            document.getElementById('resourceEggsBtn').classList.toggle('active', resource === 'eggs');
            
            updateMarketUI();
        }
        
        function openHatchModal(type) {
            document.getElementById('hatchModal').classList.add('active');
            document.getElementById('hatchOverlay').classList.add('active');
        }
        
        function closeHatchModal() {
            document.getElementById('hatchModal').classList.remove('active');
            document.getElementById('hatchOverlay').classList.remove('active');
        }
        
        function openOrderModal() {
            document.getElementById('orderModal').classList.add('active');
            document.getElementById('orderOverlay').classList.add('active');
            
            // Set default resource
            setOrderResource(currentMarketResource);
            setOrderType('sell');
            
            // Update available balance
            updateOrderModalBalance();
        }
        
        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
            document.getElementById('orderOverlay').classList.remove('active');
        }
        
        function setOrderType(type) {
            currentOrderType = type;
            
            document.getElementById('orderTypeSellBtn').classList.toggle('btn-primary', type === 'sell');
            document.getElementById('orderTypeSellBtn').classList.toggle('btn-secondary', type !== 'sell');
            
            document.getElementById('orderTypeBuyBtn').classList.toggle('btn-primary', type === 'buy');
            document.getElementById('orderTypeBuyBtn').classList.toggle('btn-secondary', type !== 'buy');
            
            updateOrderModalBalance();
        }
        
        function setOrderResource(resource) {
            currentOrderResource = resource;
            
            document.getElementById('orderResourceMilkBtn').classList.toggle('btn-primary', resource === 'milk');
            document.getElementById('orderResourceMilkBtn').classList.toggle('btn-secondary', resource !== 'milk');
            
            document.getElementById('orderResourceEggsBtn').classList.toggle('btn-primary', resource === 'eggs');
            document.getElementById('orderResourceEggsBtn').classList.toggle('btn-secondary', resource !== 'eggs');
            
            updateOrderModalBalance();
        }
        
        function updateOrderModalBalance() {
            if (currentOrderType === 'sell') {
                const balance = currentOrderResource === 'milk' ? gameState.user.milk : gameState.user.eggs;
                document.getElementById('availableBalance').textContent = formatNumber(balance || 0);
            } else {
                document.getElementById('availableBalance').textContent = formatTON(gameState.user.tonBalance || 0);
            }
            
            // Update best price
            const marketData = gameState.market?.[currentOrderResource];
            let bestPrice = 0;
            
            if (currentOrderType === 'sell') {
                bestPrice = marketData?.bestBuyPrice || 0.01;
            } else {
                bestPrice = marketData?.bestSellPrice || 0.01;
            }
            
            document.getElementById('bestPriceValue').textContent = `${bestPrice.toFixed(4)} TON`;
        }
        
        function openDepositModal() {
            document.getElementById('depositModal').classList.add('active');
            document.getElementById('depositOverlay').classList.add('active');
        }
        
        function closeDepositModal() {
            document.getElementById('depositModal').classList.remove('active');
            document.getElementById('depositOverlay').classList.remove('active');
        }
        
        function setDepositAmount(amount) {
            document.getElementById('depositAmount').value = amount;
        }
        
        function toggleHelpModal() {
            document.getElementById('helpModal').classList.toggle('active');
            document.getElementById('helpOverlay').classList.toggle('active');
        }
        
        function showTxModal(title, message) {
            document.getElementById('txTitle').textContent = title;
            document.getElementById('txMessage').textContent = message;
            document.getElementById('txModal').classList.add('active');
            document.getElementById('txOverlay').classList.add('active');
            
            setTimeout(() => closeTxModal(), 3000);
        }
        
        function closeTxModal() {
            document.getElementById('txModal').classList.remove('active');
            document.getElementById('txOverlay').classList.remove('active');
        }
        
        // ==============================================
        // UTILITIES
        // ==============================================
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }
        
        function formatTON(amount) {
            if (amount === null || amount === undefined) return '0.0000';
            return parseFloat(amount).toFixed(4);
        }
        
        // ==============================================
        // EVENT LISTENERS
        // ==============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Withdrawal amount input
            document.getElementById('withdrawAmount').addEventListener('input', updateUI);
            
            // Convert amount input
            document.getElementById('convertAmount').addEventListener('input', updateUI);
            
            // Close modals on overlay click
            document.getElementById('helpOverlay').addEventListener('click', toggleHelpModal);
            document.getElementById('hatchOverlay').addEventListener('click', closeHatchModal);
            document.getElementById('orderOverlay').addEventListener('click', closeOrderModal);
            document.getElementById('depositOverlay').addEventListener('click', closeDepositModal);
            document.getElementById('txOverlay').addEventListener('click', closeTxModal);
        });
        
        // Start the app
        initialize();
    </script>
</body>
</html>

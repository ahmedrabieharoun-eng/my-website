<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Farm Economy</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- TON Connect SDK -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    
    <style>
        /* ==================== RESET & BASE STYLES ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            /* Colors - Farm Theme */
            --primary-green: #00B894;
            --primary-yellow: #FDCB6E;
            --primary-brown: #6D4C41;
            --primary-blue: #0984E3;
            --primary-purple: #6C5CE7;
            --primary-red: #D63031;
            
            --dark-bg: #0A0A0F;
            --dark-card: #12121F;
            --dark-border: #1E1E2E;
            --text-primary: #FFFFFF;
            --text-secondary: #A0A0B0;
            --text-muted: #6C6C7C;
            
            --success: #00D4AA;
            --warning: #FDCB6E;
            --danger: #FF5252;
            --info: #0984E3;
            
            /* Resource Colors */
            --milk-color: #FFFFFF;
            --egg-color: #FDCB6E;
            --diamond-color: #00CEC9;
            --ton-color: #0088CC;
            
            /* Machine Colors */
            --cow-color: #6D4C41;
            --chicken-color: #FDCB6E;
            --diamond-engine-color: #00CEC9;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, #0F0F1F 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 184, 148, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(253, 203, 110, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 206, 201, 0.06) 0%, transparent 50%);
            z-index: -1;
            pointer-events: none;
        }
        
        /* ==================== TOP STATUS BAR ==================== */
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(18, 18, 31, 0.98);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--dark-border);
            padding: 12px 16px;
            z-index: 1000;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            align-items: center;
            gap: 8px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }
        
        .status-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 14px;
        }
        
        .status-value {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .status-label {
            color: var(--text-secondary);
            font-size: 10px;
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-info {
            display: flex;
            flex-direction: column;
        }
        
        .status-rate {
            font-size: 10px;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        /* ==================== MAIN CONTAINER ==================== */
        .app-container {
            padding-top: 85px;
            padding-bottom: 85px;
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            padding-left: 16px;
            padding-right: 16px;
        }
        
        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .content-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ==================== CARDS ==================== */
        .card {
            background: var(--dark-card);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--dark-border);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-yellow));
            opacity: 0.5;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-title i {
            color: var(--primary-green);
        }
        
        /* ==================== MACHINE CARDS ==================== */
        .machine-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .machine-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--dark-border);
            position: relative;
            transition: all 0.3s ease;
        }
        
        .machine-card.sold-out {
            opacity: 0.8;
            filter: grayscale(0.5);
        }
        
        .machine-card.locked {
            opacity: 0.7;
            filter: blur(0.5px);
        }
        
        .machine-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .machine-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }
        
        .machine-icon.cow { color: var(--cow-color); background: rgba(109, 76, 65, 0.2); }
        .machine-icon.chicken { color: var(--chicken-color); background: rgba(253, 203, 110, 0.2); }
        .machine-icon.diamond { color: var(--diamond-color); background: rgba(0, 206, 201, 0.2); }
        
        .machine-info {
            flex: 1;
        }
        
        .machine-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .machine-price {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .machine-price i {
            color: var(--ton-color);
        }
        
        .machine-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-sold-out {
            background: rgba(214, 48, 49, 0.2);
            color: var(--danger);
            border: 1px solid rgba(214, 48, 49, 0.3);
        }
        
        .badge-locked {
            background: rgba(108, 92, 231, 0.2);
            color: var(--primary-purple);
            border: 1px solid rgba(108, 92, 231, 0.3);
        }
        
        .badge-owned {
            background: rgba(0, 212, 170, 0.2);
            color: var(--success);
            border: 1px solid rgba(0, 212, 170, 0.3);
        }
        
        .machine-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }
        
        .machine-stat {
            text-align: center;
        }
        
        .machine-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .machine-stat-value {
            font-size: 16px;
            font-weight: 700;
        }
        
        .machine-progress {
            margin: 16px 0;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
        }
        
        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-yellow));
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        /* ==================== DIAMOND ENGINE ==================== */
        .diamond-engine {
            background: linear-gradient(135deg, rgba(0, 206, 201, 0.1), rgba(108, 92, 231, 0.1));
            border: 1px solid rgba(0, 206, 201, 0.3);
        }
        
        .production-costs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }
        
        .cost-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
        }
        
        .cost-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .cost-value {
            font-size: 14px;
            font-weight: 600;
        }
        
        .cost-label {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        /* ==================== MARKET SECTION ==================== */
        .market-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 16px;
        }
        
        .market-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        
        .market-tab.active {
            background: var(--dark-card);
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .resource-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .resource-tab {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .resource-tab.active {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-green);
        }
        
        .order-book {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-price {
            font-weight: 700;
            color: var(--success);
        }
        
        .order-amount {
            color: var(--text-primary);
        }
        
        .order-user {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        /* ==================== DIAMOND CONVERSION ==================== */
        .conversion-card {
            background: linear-gradient(135deg, rgba(0, 206, 201, 0.15), rgba(108, 92, 231, 0.15));
            border: 1px solid rgba(0, 206, 201, 0.4);
        }
        
        .diamond-price {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 24px;
            font-weight: 800;
            margin: 20px 0;
            color: var(--diamond-color);
        }
        
        .conversion-input {
            display: flex;
            gap: 12px;
            margin: 20px 0;
        }
        
        /* ==================== REFERRAL SECTION ==================== */
        .referral-section {
            background: linear-gradient(135deg, rgba(0, 184, 148, 0.15), rgba(253, 203, 110, 0.15));
        }
        
        .referral-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 16px 0;
        }
        
        .referral-stat-item {
            text-align: center;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }
        
        .referral-stat-value {
            font-size: 20px;
            font-weight: 800;
            color: var(--primary-green);
            margin-bottom: 4px;
        }
        
        .referral-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .claim-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary-green), var(--primary-yellow));
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .claim-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ==================== BUTTONS ==================== */
        .btn {
            padding: 14px 20px;
            border-radius: 14px;
            border: none;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-green), var(--primary-yellow));
            color: white;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--dark-border);
        }
        
        .btn-success {
            background: var(--success);
            color: black;
        }
        
        .btn-buy {
            background: var(--primary-green);
            color: white;
        }
        
        .btn-sell {
            background: var(--primary-red);
            color: white;
        }
        
        /* ==================== FORM ELEMENTS ==================== */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .form-input {
            width: 100%;
            padding: 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 16px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-green);
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        
        .preset-btn {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
        }
        
        .preset-btn.active {
            background: var(--primary-green);
            border-color: var(--primary-green);
        }
        
        /* ==================== BOTTOM NAVIGATION ==================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(18, 18, 31, 0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--dark-border);
            padding: 12px 16px;
            display: flex;
            justify-content: space-around;
            z-index: 1000;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            padding: 8px;
            border-radius: 12px;
            min-width: 64px;
        }
        
        .nav-item.active {
            color: var(--primary-green);
            background: rgba(0, 184, 148, 0.1);
        }
        
        .nav-icon {
            font-size: 20px;
        }
        
        .nav-text {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* ==================== DEPOSIT STATUS ==================== */
        .deposit-status {
            margin-top: 16px;
            padding: 16px;
            background: rgba(0, 212, 170, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(0, 212, 170, 0.3);
            display: none;
        }
        
        .deposit-status.verifying {
            background: rgba(253, 203, 110, 0.1);
            border: 1px solid rgba(253, 203, 110, 0.3);
        }
        
        .deposit-status.success {
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid rgba(0, 212, 170, 0.3);
        }
        
        .deposit-status.error {
            background: rgba(255, 82, 82, 0.1);
            border: 1px solid rgba(255, 82, 82, 0.3);
        }
        
        .status-icon {
            font-size: 24px;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .status-message {
            font-size: 14px;
            margin-bottom: 8px;
            text-align: center;
            font-weight: 600;
        }
        
        .status-details {
            font-size: 12px;
            color: var(--text-secondary);
            word-break: break-all;
            text-align: center;
        }
        
        /* ==================== HELP MODAL ==================== */
        .help-button {
            position: fixed;
            top: 12px;
            right: 16px;
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-secondary);
            cursor: pointer;
            z-index: 1001;
            backdrop-filter: blur(10px);
            border: 1px solid var(--dark-border);
        }
        
        .help-modal {
            position: fixed;
            top: 60px;
            right: 16px;
            left: 16px;
            background: var(--dark-card);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid var(--dark-border);
            z-index: 1002;
            display: none;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .help-modal.active {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .help-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .help-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .close-help {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }
        
        .help-content {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
        }
        
        .help-item {
            margin-bottom: 16px;
        }
        
        .help-item strong {
            color: var(--primary-green);
        }
        
        /* ==================== LOADING SCREEN ==================== */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--dark-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .loading-logo {
            font-size: 64px;
            margin-bottom: 24px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .loading-title {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-green), var(--primary-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 30px;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-yellow));
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 480px) {
            .status-bar {
                padding: 8px 12px;
                gap: 4px;
            }
            
            .status-item {
                padding: 4px 8px;
                font-size: 12px;
            }
            
            .status-icon {
                width: 24px;
                height: 24px;
                font-size: 12px;
            }
            
            .status-value {
                font-size: 13px;
            }
            
            .machine-grid {
                gap: 12px;
            }
            
            .machine-card {
                padding: 16px;
            }
            
            .machine-icon {
                width: 45px;
                height: 45px;
                font-size: 24px;
            }
            
            .machine-name {
                font-size: 16px;
            }
            
            .referral-stats {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .bottom-nav {
                padding: 8px 12px;
            }
            
            .nav-item {
                min-width: 56px;
                padding: 6px;
            }
            
            .nav-icon {
                font-size: 18px;
            }
            
            .nav-text {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- ==================== LOADING SCREEN ==================== -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">üöú</div>
        <h1 class="loading-title">Farm Economy</h1>
        <p style="color: var(--text-secondary); font-size: 14px;">Loading your farm...</p>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgress"></div>
        </div>
    </div>

    <!-- ==================== HELP BUTTON ==================== -->
    <div class="help-button" onclick="toggleHelpModal()">
        <i class="fas fa-question"></i>
    </div>

    <!-- ==================== HELP MODAL ==================== -->
    <div class="help-modal" id="helpModal">
        <div class="help-header">
            <h2 class="help-title">
                <i class="fas fa-question-circle" style="color: var(--primary-green);"></i>
                How to Play
            </h2>
            <button class="close-help" onclick="toggleHelpModal()">√ó</button>
        </div>
        <div class="help-content">
            <div class="help-item">
                <strong>ü•õ Cow Machine</strong>
                <p>Price: 1 TON | Production: 41 Milk/hour</p>
                <p style="font-size: 12px;">Limited to 1000 machines globally. Each user can buy one.</p>
            </div>
            
            <div class="help-item">
                <strong>ü•ö Chicken Machine</strong>
                <p>Price: 1 TON | Production: 41 Eggs/hour</p>
                <p style="font-size: 12px;">Unlocks after all 1000 Cows are sold.</p>
            </div>
            
            <div class="help-item">
                <strong>üíé Diamond Engine</strong>
                <p>Price: 20 TON</p>
                <p style="font-size: 12px;">Unlocks after all 1000 Chickens are sold. Manual production: 20,000 Milk + 20,000 Eggs = 1 Diamond</p>
            </div>
            
            <div class="help-item">
                <strong>üí∞ Diamond Conversion</strong>
                <p>Convert Diamonds to TON at dynamic market price.</p>
            </div>
            
            <div class="help-item">
                <strong>üîÑ Market</strong>
                <p>Buy and sell Milk and Eggs with other players.</p>
            </div>
            
            <div class="help-item">
                <strong>üë• Referral System</strong>
                <p>Earn 10% of every machine purchase made by your friends!</p>
            </div>
        </div>
    </div>

    <!-- ==================== TOP STATUS BAR ==================== -->
    <div class="status-bar">
        <!-- Milk Status -->
        <div class="status-item">
            <div class="status-icon" style="background: rgba(255, 255, 255, 0.15);">
                ü•õ
            </div>
            <div class="status-info">
                <div class="status-value" id="statusMilk">0</div>
                <div class="status-rate" id="statusMilkRate">
                    <i class="fas fa-arrow-up"></i> 0/hour
                </div>
            </div>
        </div>
        
        <!-- Eggs Status -->
        <div class="status-item">
            <div class="status-icon" style="background: rgba(253, 203, 110, 0.15);">
                ü•ö
            </div>
            <div class="status-info">
                <div class="status-value" id="statusEggs">0</div>
                <div class="status-rate" id="statusEggsRate">
                    <i class="fas fa-arrow-up"></i> 0/hour
                </div>
            </div>
        </div>
        
        <!-- Diamond Status -->
        <div class="status-item">
            <div class="status-icon" style="background: rgba(0, 206, 201, 0.15);">
                üíé
            </div>
            <div class="status-info">
                <div class="status-value" id="statusDiamond">0</div>
                <div class="status-rate">
                    <i class="fas fa-gem"></i>
                </div>
            </div>
        </div>
        
        <!-- TON Status -->
        <div class="status-item">
            <div class="status-icon" style="background: rgba(0, 136, 204, 0.15);">
                ‚ö°
            </div>
            <div class="status-info">
                <div class="status-value" id="statusTon">0.0000</div>
                <div class="status-rate">
                    <i class="fas fa-coins"></i> TON
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== MAIN CONTAINER ==================== -->
    <div class="app-container" id="appContainer" style="display: none;">
        
        <!-- ==================== HOME TAB ==================== -->
        <div id="homeTab" class="content-section active">
            <!-- Cow Machine -->
            <div class="machine-card" id="cowMachineCard">
                <div class="machine-header">
                    <div class="machine-icon cow">
                        üêÆ
                    </div>
                    <div class="machine-info">
                        <div class="machine-name">
                            Cow Machine
                            <span class="machine-badge" id="cowBadge">Available</span>
                        </div>
                        <div class="machine-price">
                            <i class="fas fa-bolt"></i> 1 TON
                        </div>
                    </div>
                </div>
                
                <div class="machine-stats">
                    <div class="machine-stat">
                        <div class="machine-stat-label">Production</div>
                        <div class="machine-stat-value">41 ü•õ/hour</div>
                    </div>
                    <div class="machine-stat">
                        <div class="machine-stat-label">Owned</div>
                        <div class="machine-stat-value" id="cowsOwned">0</div>
                    </div>
                </div>
                
                <div class="machine-progress">
                    <div class="progress-header">
                        <span>Global Supply</span>
                        <span id="cowProgressText">0/1000</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="cowProgressFill" style="width: 0%;"></div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="buyCowBtn" onclick="buyCow()" style="width: 100%;">
                    <i class="fas fa-shopping-cart"></i>
                    Buy Cow Machine
                </button>
            </div>
            
            <!-- Chicken Machine -->
            <div class="machine-card" id="chickenMachineCard">
                <div class="machine-header">
                    <div class="machine-icon chicken">
                        üêî
                    </div>
                    <div class="machine-info">
                        <div class="machine-name">
                            Chicken Machine
                            <span class="machine-badge" id="chickenBadge">Locked</span>
                        </div>
                        <div class="machine-price">
                            <i class="fas fa-bolt"></i> 1 TON
                        </div>
                    </div>
                </div>
                
                <div class="machine-stats">
                    <div class="machine-stat">
                        <div class="machine-stat-label">Production</div>
                        <div class="machine-stat-value">41 ü•ö/hour</div>
                    </div>
                    <div class="machine-stat">
                        <div class="machine-stat-label">Owned</div>
                        <div class="machine-stat-value" id="chickensOwned">0</div>
                    </div>
                </div>
                
                <div class="machine-progress">
                    <div class="progress-header">
                        <span>Global Supply</span>
                        <span id="chickenProgressText">0/1000</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="chickenProgressFill" style="width: 0%;"></div>
                    </div>
                </div>
                
                <button class="btn btn-secondary" id="buyChickenBtn" onclick="buyChicken()" style="width: 100%;" disabled>
                    <i class="fas fa-lock"></i>
                    Locked
                </button>
            </div>
            
            <!-- Diamond Engine -->
            <div class="machine-card diamond-engine" id="diamondEngineCard">
                <div class="machine-header">
                    <div class="machine-icon diamond">
                        üíé
                    </div>
                    <div class="machine-info">
                        <div class="machine-name">
                            Diamond Engine
                            <span class="machine-badge" id="diamondBadge">Locked</span>
                        </div>
                        <div class="machine-price">
                            <i class="fas fa-bolt"></i> 20 TON
                        </div>
                    </div>
                </div>
                
                <div class="production-costs">
                    <div class="cost-item">
                        <div class="cost-icon">ü•õ</div>
                        <div class="cost-value" id="diamondCostMilk">20,000</div>
                        <div class="cost-label">Milk</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-icon">ü•ö</div>
                        <div class="cost-value" id="diamondCostEggs">20,000</div>
                        <div class="cost-label">Eggs</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; margin: 16px 0;">
                    <div style="flex: 1; text-align: center; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px;">
                        <div style="font-size: 11px; color: var(--text-secondary);">Owned</div>
                        <div style="font-size: 18px; font-weight: 700;" id="diamondEnginesOwned">0</div>
                    </div>
                    <div style="flex: 1; text-align: center; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px;">
                        <div style="font-size: 11px; color: var(--text-secondary);">Yield</div>
                        <div style="font-size: 18px; font-weight: 700;">1 üíé</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" id="buyDiamondBtn" onclick="buyDiamondEngine()" style="flex: 1;" disabled>
                        <i class="fas fa-lock"></i>
                        Buy
                    </button>
                    <button class="btn btn-primary" id="startDiamondBtn" onclick="startDiamondProduction()" style="flex: 1;" disabled>
                        <i class="fas fa-play"></i>
                        Start
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ==================== MARKET TAB ==================== -->
        <div id="marketTab" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-chart-line"></i>
                        Market
                    </h2>
                </div>
                
                <div class="market-tabs">
                    <div class="market-tab active" onclick="switchMarketMode('buy')">Buy</div>
                    <div class="market-tab" onclick="switchMarketMode('sell')">Sell</div>
                    <div class="market-tab" onclick="switchMarketMode('my')">My Orders</div>
                </div>
                
                <div class="resource-tabs">
                    <div class="resource-tab active" onclick="switchMarketResource('milk')">
                        ü•õ Milk
                    </div>
                    <div class="resource-tab" onclick="switchMarketResource('eggs')">
                        ü•ö Eggs
                    </div>
                </div>
                
                <!-- Buy Section -->
                <div id="marketBuySection" style="display: block;">
                    <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--text-secondary);">
                        <i class="fas fa-tag"></i> Sell Orders
                    </h3>
                    <div class="order-book" id="sellOrdersList">
                        <!-- Sell orders will be populated here -->
                        <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                            <i class="fas fa-inbox" style="font-size: 36px; margin-bottom: 12px; opacity: 0.5;"></i>
                            <p>No active orders</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--text-secondary);">
                            <i class="fas fa-plus-circle"></i> Create Buy Order
                        </h3>
                        
                        <div class="form-group">
                            <label class="form-label">Price per unit (TON)</label>
                            <input type="number" id="buyPrice" class="form-input" placeholder="0.01" step="0.0001" min="0.0001">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Amount</label>
                            <input type="number" id="buyAmount" class="form-input" placeholder="100" min="100">
                            <div class="preset-buttons">
                                <div class="preset-btn" onclick="setBuyAmountPercent(25)">25%</div>
                                <div class="preset-btn" onclick="setBuyAmountPercent(50)">50%</div>
                                <div class="preset-btn" onclick="setBuyAmountPercent(75)">75%</div>
                                <div class="preset-btn" onclick="setBuyAmountMax()">MAX</div>
                            </div>
                        </div>
                        
                        <button class="btn btn-buy" onclick="createBuyOrder()" style="width: 100%;">
                            <i class="fas fa-check-circle"></i>
                            Place Buy Order
                        </button>
                    </div>
                </div>
                
                <!-- Sell Section -->
                <div id="marketSellSection" style="display: none;">
                    <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--text-secondary);">
                        <i class="fas fa-tag"></i> Buy Orders
                    </h3>
                    <div class="order-book" id="buyOrdersList">
                        <!-- Buy orders will be populated here -->
                        <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                            <i class="fas fa-inbox" style="font-size: 36px; margin-bottom: 12px; opacity: 0.5;"></i>
                            <p>No active orders</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--text-secondary);">
                            <i class="fas fa-plus-circle"></i> Create Sell Order
                        </h3>
                        
                        <div class="form-group">
                            <label class="form-label">Price per unit (TON)</label>
                            <input type="number" id="sellPrice" class="form-input" placeholder="0.01" step="0.0001" min="0.0001">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Amount</label>
                            <input type="number" id="sellAmount" class="form-input" placeholder="100" min="100">
                            <div class="preset-buttons">
                                <div class="preset-btn" onclick="setSellAmountPercent(25)">25%</div>
                                <div class="preset-btn" onclick="setSellAmountPercent(50)">50%</div>
                                <div class="preset-btn" onclick="setSellAmountPercent(75)">75%</div>
                                <div class="preset-btn" onclick="setSellAmountMax()">MAX</div>
                            </div>
                        </div>
                        
                        <button class="btn btn-sell" onclick="createSellOrder()" style="width: 100%;">
                            <i class="fas fa-check-circle"></i>
                            Place Sell Order
                        </button>
                    </div>
                </div>
                
                <!-- My Orders Section -->
                <div id="marketMyOrdersSection" style="display: none;">
                    <div id="myOrdersList">
                        <!-- My orders will be populated here -->
                        <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                            <i class="fas fa-clipboard-list" style="font-size: 36px; margin-bottom: 12px; opacity: 0.5;"></i>
                            <p>No active orders</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== DIAMOND TAB ==================== -->
        <div id="diamondTab" class="content-section">
            <div class="card conversion-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-gem"></i>
                        Diamond Conversion
                    </h2>
                </div>
                
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üíé</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">
                        Convert your Diamonds to TON
                    </div>
                </div>
                
                <div class="diamond-price">
                    <span>1 üíé =</span>
                    <span style="color: var(--ton-color);" id="diamondPrice">5</span>
                    <span>‚ö° TON</span>
                </div>
                
                <div style="display: flex; align-items: center; justify-content: space-between; margin: 20px 0; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 16px;">
                    <div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Your Diamonds</div>
                        <div style="font-size: 28px; font-weight: 800;" id="diamondBalance">0</div>
                    </div>
                    <div>
                        <i class="fas fa-arrow-right" style="font-size: 24px; color: var(--text-secondary);"></i>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: var(--text-secondary);">You Receive</div>
                        <div style="font-size: 28px; font-weight: 800; color: var(--ton-color);" id="tonReceive">0</div>
                    </div>
                </div>
                
                <div class="conversion-input">
                    <input type="number" id="convertAmount" class="form-input" placeholder="Amount of diamonds" min="1" style="flex: 1;">
                    <button class="btn btn-primary" onclick="convertDiamond()" style="min-width: 100px;">
                        Convert
                    </button>
                </div>
                
                <div style="font-size: 12px; color: var(--text-secondary); text-align: center; margin-top: 16px;">
                    <i class="fas fa-info-circle"></i>
                    Diamond price is dynamic and can be adjusted by the team
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">
                    <i class="fas fa-history"></i>
                    Production History
                </h2>
                <div id="diamondHistory" style="color: var(--text-secondary); font-size: 13px;">
                    <div style="text-align: center; padding: 20px;">
                        No production history yet
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== FRIENDS TAB ==================== -->
        <div id="friendsTab" class="content-section">
            <div class="card referral-section">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-users"></i>
                        Referral Program
                    </h2>
                </div>
                
                <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
                    Invite friends and earn <strong style="color: var(--primary-green);">10%</strong> of every machine they purchase!
                </p>
                
                <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                    <input type="text" id="referralLink" class="form-input" readonly style="flex: 1;">
                    <button class="btn btn-primary" onclick="copyReferralLink()" style="width: auto; padding: 0 20px;">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                
                <div class="referral-stats">
                    <div class="referral-stat-item">
                        <div class="referral-stat-value" id="totalReferrals">0</div>
                        <div class="referral-stat-label">Friends</div>
                    </div>
                    <div class="referral-stat-item">
                        <div class="referral-stat-value" id="referralEarnings">0</div>
                        <div class="referral-stat-label">Earned (TON)</div>
                    </div>
                    <div class="referral-stat-item">
                        <div class="referral-stat-value" id="referralClaimed">0</div>
                        <div class="referral-stat-label">Claimed</div>
                    </div>
                </div>
                
                <button class="claim-button" id="claimReferralBtn" onclick="claimReferralEarnings()">
                    <i class="fas fa-hand-holding-usd"></i>
                    Claim Earnings
                </button>
            </div>
            
            <div class="card">
                <h2 class="card-title">
                    <i class="fas fa-trophy"></i>
                    Recent Referrals
                </h2>
                <div id="recentReferrals" style="color: var(--text-secondary); font-size: 13px;">
                    <div style="text-align: center; padding: 20px;">
                        No referrals yet
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== PROFILE TAB ==================== -->
        <div id="profileTab" class="content-section">
            <div class="card">
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                    <div style="width: 60px; height: 60px; background: rgba(0, 184, 148, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px;">
                        üë®‚Äçüåæ
                    </div>
                    <div>
                        <div style="font-size: 20px; font-weight: 700;" id="profileName">Farmer</div>
                        <div style="font-size: 14px; color: var(--text-secondary);" id="profileUsername">@username</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                    <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 16px;">
                        <div style="font-size: 12px; color: var(--text-secondary);">Machines</div>
                        <div style="font-size: 24px; font-weight: 700;" id="totalMachines">0</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 16px;">
                        <div style="font-size: 12px; color: var(--text-secondary);">Production</div>
                        <div style="font-size: 24px; font-weight: 700;" id="totalProduction">0/h</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">
                    <i class="fas fa-wallet"></i>
                    Your Assets
                </h2>
                
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                ü•õ
                            </div>
                            <div>
                                <div style="font-weight: 600;">Milk</div>
                                <div style="font-size: 12px; color: var(--text-secondary);" id="profileMilkRate">0/hour</div>
                            </div>
                        </div>
                        <div style="font-size: 20px; font-weight: 700;" id="profileMilk">0</div>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                ü•ö
                            </div>
                            <div>
                                <div style="font-weight: 600;">Eggs</div>
                                <div style="font-size: 12px; color: var(--text-secondary);" id="profileEggsRate">0/hour</div>
                            </div>
                        </div>
                        <div style="font-size: 20px; font-weight: 700;" id="profileEggs">0</div>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                üíé
                            </div>
                            <div>
                                <div style="font-weight: 600;">Diamond</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">1 üíé = <span id="profileDiamondPrice">5</span> TON</div>
                            </div>
                        </div>
                        <div style="font-size: 20px; font-weight: 700;" id="profileDiamond">0</div>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                ‚ö°
                            </div>
                            <div>
                                <div style="font-weight: 600;">TON</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Balance</div>
                            </div>
                        </div>
                        <div style="font-size: 20px; font-weight: 700;" id="profileTon">0.0000</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">
                    <i class="fas fa-arrow-up"></i>
                    Withdraw TON
                </h2>
                
                <div class="form-group">
                    <label class="form-label">Amount (Minimum 0.5 TON)</label>
                    <input type="number" id="withdrawAmount" class="form-input" placeholder="0.5" step="0.1" min="0.5">
                </div>
                
                <div class="form-group">
                    <label class="form-label">TON Wallet Address</label>
                    <input type="text" id="withdrawAddress" class="form-input" placeholder="EQD...">
                </div>
                
                <div style="background: rgba(253, 203, 110, 0.1); padding: 12px; border-radius: 12px; margin-bottom: 16px; font-size: 13px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span>Fee (5%):</span>
                        <span id="withdrawFee">0 TON</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: 600;">
                        <span>You receive:</span>
                        <span id="withdrawNet">0 TON</span>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="withdrawTON()" style="width: 100%;">
                    <i class="fas fa-paper-plane"></i>
                    Withdraw TON
                </button>
            </div>
        </div>
        
        <!-- ==================== FINANCE TAB ==================== -->
        <div id="financeTab" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-coins"></i>
                        Deposit TON
                    </h2>
                </div>
                
                <!-- Wallet Status -->
                <div id="walletStatus" style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 16px; margin-bottom: 20px;">
                    <div>
                        <div style="font-size: 14px; font-weight: 600;">Wallet Status</div>
                        <div style="font-size: 12px; color: var(--text-secondary);" id="walletAddress">Not connected</div>
                    </div>
                    <button class="btn btn-primary" onclick="connectWallet()" id="connectWalletBtn" style="width: auto;">
                        <i class="fas fa-plug"></i> Connect
                    </button>
                </div>
                
                <!-- Deposit Form -->
                <div class="form-group">
                    <label class="form-label">Amount (TON)</label>
                    <input type="number" id="depositAmount" class="form-input" placeholder="0.1" step="0.1" min="0.1">
                    <div class="preset-buttons">
                        <div class="preset-btn" onclick="setDepositAmount(0.5)">0.5</div>
                        <div class="preset-btn" onclick="setDepositAmount(1)">1</div>
                        <div class="preset-btn" onclick="setDepositAmount(2)">2</div>
                        <div class="preset-btn" onclick="setDepositAmount(5)">5</div>
                        <div class="preset-btn" onclick="setDepositAmount(10)">10</div>
                    </div>
                </div>
                
                <div style="background: rgba(0, 184, 148, 0.1); padding: 12px; border-radius: 12px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-info-circle" style="color: var(--primary-green);"></i>
                        <span style="font-size: 12px;">IMPORTANT: Your User ID <strong id="depositUserId"><?= $userId ?></strong> must be the ONLY comment in the transaction.</span>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="initiateDeposit()" id="depositBtn" style="width: 100%; margin-bottom: 16px;" disabled>
                    <i class="fas fa-arrow-down"></i>
                    Deposit TON
                </button>
                
                <!-- Deposit Status -->
                <div id="depositStatus" class="deposit-status">
                    <div class="status-icon">‚è≥</div>
                    <div class="status-message">Processing deposit...</div>
                    <div class="status-details"></div>
                </div>
                
                <!-- Deposit Details (hidden by default) -->
                <div id="depositDetails" style="display: none; margin-top: 20px; padding: 16px; background: rgba(0,0,0,0.3); border-radius: 16px;">
                    <h3 style="font-size: 16px; margin-bottom: 12px;">Deposit Details</h3>
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: var(--text-secondary);">Send exactly:</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="depositExactAmount">0 TON</div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: var(--text-secondary);">To address:</div>
                        <div style="font-size: 12px; font-family: monospace; word-break: break-all; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px;" id="depositAddress"></div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: var(--text-secondary);">Comment (MUST include):</div>
                        <div style="font-size: 16px; font-weight: 700; color: var(--warning);" id="depositComment"></div>
                    </div>
                    <button class="btn btn-success" onclick="sendDepositTransaction()" style="width: 100%; margin-top: 8px;">
                        <i class="fas fa-check-circle"></i>
                        Confirm & Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== BOTTOM NAVIGATION ==================== -->
    <nav class="bottom-nav">
        <div class="nav-item active" data-tab="homeTab">
            <div class="nav-icon">üè†</div>
            <div class="nav-text">Farm</div>
        </div>
        <div class="nav-item" data-tab="marketTab">
            <div class="nav-icon">üìä</div>
            <div class="nav-text">Market</div>
        </div>
        <div class="nav-item" data-tab="diamondTab">
            <div class="nav-icon">üíé</div>
            <div class="nav-text">Diamond</div>
        </div>
        <div class="nav-item" data-tab="friendsTab">
            <div class="nav-icon">üë•</div>
            <div class="nav-text">Friends</div>
        </div>
        <div class="nav-item" data-tab="profileTab">
            <div class="nav-icon">üë§</div>
            <div class="nav-text">Profile</div>
        </div>
        <div class="nav-item" data-tab="financeTab">
            <div class="nav-icon">üí∞</div>
            <div class="nav-text">Wallet</div>
        </div>
    </nav>

    <!-- ==================== MODALS ==================== -->
    <div class="modal-overlay" id="productionModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: var(--dark-card); border-radius: 20px; padding: 24px; max-width: 350px; width: 90%; border: 1px solid var(--dark-border);">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 16px;">üíé</div>
                <h3 style="font-size: 20px; margin-bottom: 8px;">Diamond Production</h3>
                <p style="color: var(--text-secondary); font-size: 14px;" id="productionModalMessage">Processing...</p>
            </div>
            <button class="btn btn-secondary" onclick="closeProductionModal()" style="width: 100%;">Close</button>
        </div>
    </div>

    <script>
        // ==============================================
        // CONFIGURATION
        // ==============================================
        const API_BASE = 'https://silent-block-bedf.ahmedrabieharoun.workers.dev';
        const TON_DEPOSIT_ADDRESS = 'UQBnwSS4Kox3ZZmF69KxWLfvfCc2-dLV8sT5nJe-aV7HfCyG';
        const TELEGRAM_BOT_USERNAME = '@testtt1257bot';
        
        // ==============================================
        // GAME STATE
        // ==============================================
        let gameState = {
            user: {
                tonBalance: 0,
                milk: 0,
                eggs: 0,
                diamond: 0,
                cows_owned: 0,
                chickens_owned: 0,
                diamond_engines_owned: 0,
                milkPerHour: 0,
                eggsPerHour: 0,
                referralCode: '',
                referralEarnings: 0,
                referralEarningsClaimed: 0,
                secondsUntilNext: 0
            },
            global: {
                cows_sold: 0,
                cows_cap: 1000,
                chickens_sold: 0,
                chickens_cap: 1000,
                chicken_unlocked: false,
                diamond_unlocked: false,
                diamond_price: 5
            },
            market: {
                milk: { bestBuyPrice: 0, bestSellPrice: 0 },
                eggs: { bestBuyPrice: 0, bestSellPrice: 0 }
            },
            referral: {
                totalReferrals: 0,
                totalRewards: 0,
                referralList: []
            }
        };
        
        // ==============================================
        // UI STATE
        // ==============================================
        let USER_ID = 'demo_user';
        let TELEGRAM_DATA = '';
        let connectedWallet = null;
        let tonConnectUI = null;
        let isTONConnectInitialized = false;
        let currentMarketMode = 'buy';
        let currentMarketResource = 'milk';
        let currentDepositInfo = null;
        let depositCheckInterval = null;
        
        // ==============================================
        // TELEGRAM AUTH
        // ==============================================
        async function setupTelegramAuth() {
            console.log('Setting up Telegram auth...');
            
            if (window.Telegram && window.Telegram.WebApp) {
                if (window.Telegram.WebApp.initData) {
                    TELEGRAM_DATA = window.Telegram.WebApp.initData;
                }
                
                const initData = new URLSearchParams(TELEGRAM_DATA);
                const userParam = initData.get('user');
                
                if (userParam) {
                    try {
                        const userData = JSON.parse(decodeURIComponent(userParam));
                        USER_ID = String(userData.id);
                        
                        document.getElementById('profileName').textContent = 
                            `${userData.first_name || ''} ${userData.last_name || ''}`.trim() || 'Farmer';
                        document.getElementById('profileUsername').textContent = 
                            userData.username ? `@${userData.username}` : 'User';
                        
                        document.getElementById('depositUserId').textContent = USER_ID;
                        
                        return userData;
                    } catch (error) {
                        console.error('Failed to parse Telegram user data:', error);
                    }
                }
            }
            
            return null;
        }
        
        // ==============================================
        // TON CONNECT
        // ==============================================
        async function initTONConnect() {
            if (isTONConnectInitialized) return;
            
            try {
                const manifestUrl = `${API_BASE}/tonconnect-manifest.json`;
                
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: manifestUrl,
                    language: 'en',
                    uiPreferences: { theme: 'DARK' }
                });
                
                tonConnectUI.onStatusChange(async (walletInfo) => {
                    if (walletInfo) {
                        await handleWalletConnected(walletInfo);
                    } else {
                        handleWalletDisconnected();
                    }
                });
                
                isTONConnectInitialized = true;
                
            } catch (error) {
                console.error('Failed to initialize TON Connect:', error);
            }
        }
        
        async function handleWalletConnected(walletInfo) {
            connectedWallet = {
                address: walletInfo.account.address,
                chain: walletInfo.account.chain,
                wallet: walletInfo.device.appName
            };
            
            const walletStatus = document.getElementById('walletStatus');
            const shortAddress = `${connectedWallet.address.substring(0, 6)}...${connectedWallet.address.substring(connectedWallet.address.length - 4)}`;
            
            walletStatus.innerHTML = `
                <div>
                    <div style="font-size: 14px; font-weight: 600; color: var(--success);">
                        <i class="fas fa-check-circle"></i> ${connectedWallet.wallet}
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary);" title="${connectedWallet.address}">
                        ${shortAddress}
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="disconnectWallet()" style="width: auto;">
                    <i class="fas fa-unplug"></i> Disconnect
                </button>
            `;
            
            document.getElementById('depositBtn').disabled = false;
        }
        
        function handleWalletDisconnected() {
            connectedWallet = null;
            currentDepositInfo = null;
            
            const walletStatus = document.getElementById('walletStatus');
            walletStatus.innerHTML = `
                <div>
                    <div style="font-size: 14px; font-weight: 600;">Wallet Status</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Not connected</div>
                </div>
                <button class="btn btn-primary" onclick="connectWallet()" style="width: auto;">
                    <i class="fas fa-plug"></i> Connect
                </button>
            `;
            
            document.getElementById('depositBtn').disabled = true;
            document.getElementById('depositDetails').style.display = 'none';
        }
        
        async function connectWallet() {
            try {
                if (!tonConnectUI) await initTONConnect();
                await tonConnectUI.openModal();
            } catch (error) {
                console.error('Failed to connect wallet:', error);
            }
        }
        
        function disconnectWallet() {
            if (tonConnectUI) tonConnectUI.disconnect();
            else handleWalletDisconnected();
        }
        
        // ==============================================
        // API CALLS
        // ==============================================
        async function callAPI(action, data = {}) {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    'X-Action': action
                };
                
                if (TELEGRAM_DATA) {
                    headers['Authorization'] = `Telegram ${TELEGRAM_DATA}`;
                }
                
                const response = await fetch(`${API_BASE}/api`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ action, data })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    return result.data;
                } else {
                    console.error(`API Error: ${result.error}`);
                    alert(result.error || 'An error occurred');
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }
        
        // ==============================================
        // GAME ACTIONS
        // ==============================================
        
        // Buy Cow Machine
        async function buyCow() {
            try {
                const referredBy = getReferrerFromURL();
                const data = await callAPI('buyCow', { referredBy });
                
                gameState.user.cows_owned = 1;
                gameState.user.tonBalance = data.newTonBalance;
                gameState.global.cows_sold = data.cows_sold;
                gameState.global.chicken_unlocked = data.chicken_unlocked;
                
                updateUI();
                
                alert('‚úÖ Cow machine purchased successfully! You now produce 41 Milk per hour.');
                
            } catch (error) {
                console.error('Buy cow failed:', error);
            }
        }
        
        // Buy Chicken Machine
        async function buyChicken() {
            try {
                const data = await callAPI('buyChicken', {});
                
                gameState.user.chickens_owned = 1;
                gameState.user.tonBalance = data.newTonBalance;
                gameState.global.chickens_sold = data.chickens_sold;
                gameState.global.diamond_unlocked = data.diamond_unlocked;
                
                updateUI();
                
                alert('‚úÖ Chicken machine purchased successfully! You now produce 41 Eggs per hour.');
                
            } catch (error) {
                console.error('Buy chicken failed:', error);
            }
        }
        
        // Buy Diamond Engine
        async function buyDiamondEngine() {
            try {
                const data = await callAPI('buyDiamondEngine', {});
                
                gameState.user.diamond_engines_owned = 1;
                gameState.user.tonBalance = data.newTonBalance;
                gameState.global.diamond_engines_sold = data.diamond_engines_sold;
                
                updateUI();
                
                alert('‚úÖ Diamond Engine purchased successfully! You can now produce Diamonds.');
                
            } catch (error) {
                console.error('Buy diamond engine failed:', error);
            }
        }
        
        // Start Diamond Production
        async function startDiamondProduction() {
            try {
                const data = await callAPI('startDiamondProduction', {});
                
                gameState.user.milk = data.newMilk;
                gameState.user.eggs = data.newEggs;
                gameState.user.diamond = data.newDiamond;
                
                updateUI();
                
                showProductionModal('‚úÖ Production successful! You earned 1 Diamond.');
                
            } catch (error) {
                console.error('Diamond production failed:', error);
                showProductionModal('‚ùå ' + error.message);
            }
        }
        
        // Convert Diamond to TON
        async function convertDiamond() {
            const amount = parseInt(document.getElementById('convertAmount').value);
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            if (amount > gameState.user.diamond) {
                alert('Insufficient diamonds');
                return;
            }
            
            try {
                const data = await callAPI('convertDiamond', { amount });
                
                gameState.user.diamond = data.newDiamond;
                gameState.user.tonBalance = data.newTonBalance;
                
                updateUI();
                document.getElementById('convertAmount').value = '';
                
                alert(`‚úÖ Converted ${data.diamondsConverted} Diamonds to ${data.tonReceived} TON!`);
                
            } catch (error) {
                console.error('Diamond conversion failed:', error);
            }
        }
        
        // ==============================================
        // MARKET ACTIONS
        // ==============================================
        
        async function createBuyOrder() {
            const price = parseFloat(document.getElementById('buyPrice').value);
            const amount = parseInt(document.getElementById('buyAmount').value);
            
            if (!price || price <= 0) {
                alert('Please enter a valid price');
                return;
            }
            
            if (!amount || amount < 100) {
                alert('Minimum order amount is 100');
                return;
            }
            
            try {
                const data = await callAPI('createOrder', {
                    type: 'buy',
                    resource: currentMarketResource,
                    price,
                    amount
                });
                
                alert('‚úÖ Buy order created successfully!');
                loadGameState();
                
                document.getElementById('buyPrice').value = '';
                document.getElementById('buyAmount').value = '';
                
            } catch (error) {
                console.error('Create buy order failed:', error);
            }
        }
        
        async function createSellOrder() {
            const price = parseFloat(document.getElementById('sellPrice').value);
            const amount = parseInt(document.getElementById('sellAmount').value);
            
            if (!price || price <= 0) {
                alert('Please enter a valid price');
                return;
            }
            
            if (!amount || amount < 100) {
                alert('Minimum order amount is 100');
                return;
            }
            
            try {
                const data = await callAPI('createOrder', {
                    type: 'sell',
                    resource: currentMarketResource,
                    price,
                    amount
                });
                
                alert('‚úÖ Sell order created successfully!');
                loadGameState();
                
                document.getElementById('sellPrice').value = '';
                document.getElementById('sellAmount').value = '';
                
            } catch (error) {
                console.error('Create sell order failed:', error);
            }
        }
        
        async function buyOrder(orderId, amount) {
            try {
                const data = await callAPI('buyOrder', { orderId, amount });
                
                alert(`‚úÖ Purchased ${data.amount} ${data.resource} for ${data.tonPaid} TON`);
                loadGameState();
                
            } catch (error) {
                console.error('Buy order failed:', error);
            }
        }
        
        // ==============================================
        // REFERRAL SYSTEM
        // ==============================================
        
        function getReferrerFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const startParam = urlParams.get('start');
            
            if (startParam && startParam.startsWith('ref_')) {
                return startParam.replace('ref_', '');
            }
            
            return null;
        }
        
        async function claimReferralEarnings() {
            try {
                const data = await callAPI('claimReferralEarnings', {});
                
                gameState.user.tonBalance = data.newTonBalance;
                gameState.user.referralEarnings = 0;
                gameState.user.referralEarningsClaimed += data.claimedAmount;
                
                updateUI();
                
                alert(`‚úÖ Claimed ${data.claimedAmount} TON from referral earnings!`);
                
            } catch (error) {
                console.error('Claim referral earnings failed:', error);
            }
        }
        
        function copyReferralLink() {
            const input = document.getElementById('referralLink');
            input.select();
            navigator.clipboard.writeText(input.value);
            alert('‚úÖ Referral link copied to clipboard!');
        }
        
        // ==============================================
        // DEPOSIT SYSTEM
        // ==============================================
        
        async function initiateDeposit() {
            if (!connectedWallet) {
                alert('Please connect your wallet first.');
                return;
            }
            
            const amount = parseFloat(document.getElementById('depositAmount').value);
            
            if (!amount || amount < 0.1) {
                alert('Minimum deposit amount is 0.1 TON');
                return;
            }
            
            try {
                const data = await callAPI('deposit/init', {
                    amount,
                    wallet_address: connectedWallet.address
                });
                
                currentDepositInfo = {
                    depositId: data.depositId,
                    amount: amount,
                    address: data.address
                };
                
                // Show deposit details
                document.getElementById('depositExactAmount').textContent = `${amount.toFixed(2)} TON`;
                document.getElementById('depositAddress').textContent = data.address;
                document.getElementById('depositComment').textContent = USER_ID;
                document.getElementById('depositDetails').style.display = 'block';
                
            } catch (error) {
                console.error('Initiate deposit failed:', error);
            }
        }
        
        async function sendDepositTransaction() {
            if (!currentDepositInfo || !tonConnectUI) {
                alert('Please initiate a deposit first.');
                return;
            }
            
            try {
                // Send transaction with comment = USER_ID only
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 300,
                    messages: [
                        {
                            address: currentDepositInfo.address,
                            amount: String(Math.floor(currentDepositInfo.amount * 1000000000)),
                            payload: USER_ID // Comment = User ID only
                        }
                    ]
                };
                
                const result = await tonConnectUI.sendTransaction(transaction);
                
                // Show verifying status
                showDepositStatus('verifying', 
                    'Transaction sent! Verification in progress...', 
                    'Your balance will be updated within 1-3 minutes after blockchain confirmation.'
                );
                
                // Send confirmation to server
                await callAPI('deposit/confirm', {
                    depositId: currentDepositInfo.depositId,
                    amount: currentDepositInfo.amount,
                    txHash: result.boc,
                    user_address: connectedWallet.address,
                    comment: USER_ID
                });
                
                // Start verification check
                startDepositVerification(currentDepositInfo.depositId, result.boc);
                
                // Hide deposit details
                document.getElementById('depositDetails').style.display = 'none';
                document.getElementById('depositAmount').value = '';
                
            } catch (error) {
                console.error('Transaction failed:', error);
                showDepositStatus('error', 'Transaction failed', error.message);
            }
        }
        
        function startDepositVerification(depositId, txHash) {
            if (depositCheckInterval) clearInterval(depositCheckInterval);
            
            let attempts = 0;
            const maxAttempts = 18; // 3 minutes (10 seconds each)
            
            depositCheckInterval = setInterval(async () => {
                attempts++;
                
                try {
                    const verifyData = await callAPI('deposit/verify', {
                        depositId: depositId,
                        txHash: txHash
                    });
                    
                    if (verifyData.status === 'completed') {
                        clearInterval(depositCheckInterval);
                        showDepositStatus('success', 
                            '‚úÖ Deposit confirmed!', 
                            `${verifyData.amount} TON added to your balance.`
                        );
                        
                        // Reload game state
                        setTimeout(() => loadGameState(), 2000);
                        
                    } else if (attempts >= maxAttempts) {
                        clearInterval(depositCheckInterval);
                        showDepositStatus('verifying', 
                            'Still verifying...', 
                            'Your deposit is being processed. Please check back in a few minutes.'
                        );
                    }
                    
                } catch (error) {
                    console.error('Verification error:', error);
                    
                    if (attempts >= maxAttempts) {
                        clearInterval(depositCheckInterval);
                        showDepositStatus('verifying', 
                            'Verification in progress', 
                            'Your deposit will be credited automatically once confirmed on the blockchain.'
                        );
                    }
                }
            }, 10000); // Check every 10 seconds
        }
        
        function showDepositStatus(type, message, details = '') {
            const statusDiv = document.getElementById('depositStatus');
            const icon = statusDiv.querySelector('.status-icon');
            const msg = statusDiv.querySelector('.status-message');
            const det = statusDiv.querySelector('.status-details');
            
            statusDiv.className = 'deposit-status';
            statusDiv.classList.add(type);
            
            if (type === 'verifying') icon.innerHTML = '‚è≥';
            if (type === 'success') icon.innerHTML = '‚úÖ';
            if (type === 'error') icon.innerHTML = '‚ùå';
            
            msg.textContent = message;
            det.textContent = details;
            statusDiv.style.display = 'block';
        }
        
        function setDepositAmount(amount) {
            document.getElementById('depositAmount').value = amount;
        }
        
        // ==============================================
        // WITHDRAWAL
        // ==============================================
        
        async function withdrawTON() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const address = document.getElementById('withdrawAddress').value;
            
            if (!amount || amount < 0.5) {
                alert('Minimum withdrawal amount is 0.5 TON');
                return;
            }
            
            if (!address || address.length < 10) {
                alert('Please enter a valid TON wallet address');
                return;
            }
            
            if (amount > gameState.user.tonBalance) {
                alert('Insufficient balance');
                return;
            }
            
            try {
                const data = await callAPI('withdrawTON', { amount, address });
                
                gameState.user.tonBalance = data.newBalance;
                updateUI();
                
                alert(`‚úÖ Withdrawal request submitted! You will receive ${data.netAmount} TON within 24 hours.`);
                
                document.getElementById('withdrawAmount').value = '';
                document.getElementById('withdrawAddress').value = '';
                
            } catch (error) {
                console.error('Withdrawal failed:', error);
            }
        }
        
        // ==============================================
        // LOAD GAME STATE
        // ==============================================
        
        async function loadGameState() {
            try {
                const data = await callAPI('getState');
                gameState = data;
                updateUI();
                updateMarketUI();
                updateReferralUI();
                
                // Check pending deposits
                if (data.pendingDeposits && data.pendingDeposits.length > 0) {
                    data.pendingDeposits.forEach(deposit => {
                        if (deposit.status === 'verifying') {
                            startDepositVerification(deposit.depositId, deposit.txHash);
                        }
                    });
                }
                
            } catch (error) {
                console.error('Failed to load game state:', error);
            }
        }
        
        // ==============================================
        // UI UPDATE FUNCTIONS
        // ==============================================
        
        function updateUI() {
            // Status Bar
            document.getElementById('statusMilk').textContent = formatNumber(gameState.user.milk);
            document.getElementById('statusEggs').textContent = formatNumber(gameState.user.eggs);
            document.getElementById('statusDiamond').textContent = formatNumber(gameState.user.diamond);
            document.getElementById('statusTon').textContent = formatTON(gameState.user.tonBalance);
            
            // Production Rates
            document.getElementById('statusMilkRate').innerHTML = `<i class="fas fa-arrow-up"></i> ${gameState.user.milkPerHour}/hour`;
            document.getElementById('statusEggsRate').innerHTML = `<i class="fas fa-arrow-up"></i> ${gameState.user.eggsPerHour}/hour`;
            
            // Cow Machine
            document.getElementById('cowsOwned').textContent = gameState.user.cows_owned;
            document.getElementById('cowProgressText').textContent = `${gameState.global.cows_sold}/${gameState.global.cows_cap}`;
            document.getElementById('cowProgressFill').style.width = `${(gameState.global.cows_sold / gameState.global.cows_cap) * 100}%`;
            
            // Chicken Machine
            document.getElementById('chickensOwned').textContent = gameState.user.chickens_owned;
            document.getElementById('chickenProgressText').textContent = `${gameState.global.chickens_sold}/${gameState.global.chickens_cap}`;
            document.getElementById('chickenProgressFill').style.width = `${(gameState.global.chickens_sold / gameState.global.chickens_cap) * 100}%`;
            
            // Diamond Engine
            document.getElementById('diamondEnginesOwned').textContent = gameState.user.diamond_engines_owned;
            document.getElementById('diamondCostMilk').textContent = formatNumber(20000);
            document.getElementById('diamondCostEggs').textContent = formatNumber(20000);
            
            // Diamond Price
            document.getElementById('diamondPrice').textContent = gameState.global.diamond_price;
            document.getElementById('profileDiamondPrice').textContent = gameState.global.diamond_price;
            
            // Balances
            document.getElementById('diamondBalance').textContent = formatNumber(gameState.user.diamond);
            document.getElementById('profileMilk').textContent = formatNumber(gameState.user.milk);
            document.getElementById('profileEggs').textContent = formatNumber(gameState.user.eggs);
            document.getElementById('profileDiamond').textContent = formatNumber(gameState.user.diamond);
            document.getElementById('profileTon').textContent = formatTON(gameState.user.tonBalance);
            
            // Production Rates in Profile
            document.getElementById('profileMilkRate').textContent = `${gameState.user.milkPerHour}/hour`;
            document.getElementById('profileEggsRate').textContent = `${gameState.user.eggsPerHour}/hour`;
            
            // Total Machines
            const totalMachines = gameState.user.cows_owned + gameState.user.chickens_owned + gameState.user.diamond_engines_owned;
            document.getElementById('totalMachines').textContent = totalMachines;
            
            // Total Production
            const totalProduction = gameState.user.milkPerHour + gameState.user.eggsPerHour;
            document.getElementById('totalProduction').textContent = `${totalProduction}/h`;
            
            // Diamond Conversion Preview
            const convertAmount = document.getElementById('convertAmount').value || 0;
            const tonReceive = convertAmount * gameState.global.diamond_price;
            document.getElementById('tonReceive').textContent = formatTON(tonReceive);
            
            // Withdrawal Preview
            const withdrawAmount = parseFloat(document.getElementById('withdrawAmount').value) || 0;
            const withdrawFee = withdrawAmount * 0.05;
            const withdrawNet = withdrawAmount - withdrawFee;
            document.getElementById('withdrawFee').textContent = `${formatTON(withdrawFee)} TON`;
            document.getElementById('withdrawNet').textContent = `${formatTON(withdrawNet)} TON`;
            
            // ===== UPDATE MACHINE STATES =====
            
            // Cow Machine
            const cowBtn = document.getElementById('buyCowBtn');
            const cowBadge = document.getElementById('cowBadge');
            
            if (gameState.user.cows_owned > 0) {
                cowBtn.disabled = true;
                cowBtn.innerHTML = '<i class="fas fa-check"></i> Owned';
                cowBadge.textContent = 'Owned';
                cowBadge.className = 'machine-badge badge-owned';
            } else if (gameState.global.cows_sold >= gameState.global.cows_cap) {
                cowBtn.disabled = true;
                cowBtn.innerHTML = '<i class="fas fa-ban"></i> Sold Out';
                cowBadge.textContent = 'Sold Out';
                cowBadge.className = 'machine-badge badge-sold-out';
                document.getElementById('cowMachineCard').classList.add('sold-out');
            } else {
                cowBtn.disabled = gameState.user.tonBalance < 1;
                cowBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Buy Cow Machine';
                cowBadge.textContent = `${gameState.global.cows_cap - gameState.global.cows_sold} left`;
                cowBadge.className = 'machine-badge';
                cowBadge.style.background = 'rgba(0, 184, 148, 0.2)';
                cowBadge.style.color = 'var(--success)';
                document.getElementById('cowMachineCard').classList.remove('sold-out');
            }
            
            // Chicken Machine
            const chickenBtn = document.getElementById('buyChickenBtn');
            const chickenBadge = document.getElementById('chickenBadge');
            
            if (!gameState.global.chicken_unlocked) {
                chickenBtn.disabled = true;
                chickenBtn.innerHTML = '<i class="fas fa-lock"></i> Locked (Need 1000 Cows)';
                chickenBadge.textContent = 'Locked';
                chickenBadge.className = 'machine-badge badge-locked';
                document.getElementById('chickenMachineCard').classList.add('locked');
            } else if (gameState.user.chickens_owned > 0) {
                chickenBtn.disabled = true;
                chickenBtn.innerHTML = '<i class="fas fa-check"></i> Owned';
                chickenBadge.textContent = 'Owned';
                chickenBadge.className = 'machine-badge badge-owned';
                document.getElementById('chickenMachineCard').classList.remove('locked');
            } else if (gameState.global.chickens_sold >= gameState.global.chickens_cap) {
                chickenBtn.disabled = true;
                chickenBtn.innerHTML = '<i class="fas fa-ban"></i> Sold Out';
                chickenBadge.textContent = 'Sold Out';
                chickenBadge.className = 'machine-badge badge-sold-out';
                document.getElementById('chickenMachineCard').classList.add('sold-out');
            } else {
                chickenBtn.disabled = gameState.user.tonBalance < 1;
                chickenBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Buy Chicken Machine';
                chickenBadge.textContent = `${gameState.global.chickens_cap - gameState.global.chickens_sold} left`;
                chickenBadge.className = 'machine-badge';
                chickenBadge.style.background = 'rgba(0, 184, 148, 0.2)';
                chickenBadge.style.color = 'var(--success)';
                document.getElementById('chickenMachineCard').classList.remove('locked', 'sold-out');
            }
            
            // Diamond Engine
            const diamondBuyBtn = document.getElementById('buyDiamondBtn');
            const diamondStartBtn = document.getElementById('startDiamondBtn');
            const diamondBadge = document.getElementById('diamondBadge');
            
            if (!gameState.global.diamond_unlocked) {
                diamondBuyBtn.disabled = true;
                diamondBuyBtn.innerHTML = '<i class="fas fa-lock"></i> Locked';
                diamondStartBtn.disabled = true;
                diamondBadge.textContent = 'Locked';
                diamondBadge.className = 'machine-badge badge-locked';
                document.getElementById('diamondEngineCard').classList.add('locked');
            } else if (gameState.user.diamond_engines_owned > 0) {
                diamondBuyBtn.disabled = true;
                diamondBuyBtn.innerHTML = '<i class="fas fa-check"></i> Owned';
                diamondBadge.textContent = 'Owned';
                diamondBadge.className = 'machine-badge badge-owned';
                
                // Check if can start production
                const hasMilk = gameState.user.milk >= 20000;
                const hasEggs = gameState.user.eggs >= 20000;
                diamondStartBtn.disabled = !(hasMilk && hasEggs);
                diamondStartBtn.innerHTML = hasMilk && hasEggs ? 
                    '<i class="fas fa-play"></i> Start Production' : 
                    '<i class="fas fa-ban"></i> Insufficient Resources';
                
                document.getElementById('diamondEngineCard').classList.remove('locked');
            } else {
                diamondBuyBtn.disabled = gameState.user.tonBalance < 20;
                diamondBuyBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Buy Diamond Engine (20 TON)';
                diamondStartBtn.disabled = true;
                diamondStartBtn.innerHTML = '<i class="fas fa-play"></i> Start Production';
                diamondBadge.textContent = `${gameState.global.chickens_cap - gameState.global.chickens_sold} left`;
                diamondBadge.className = 'machine-badge';
                diamondBadge.style.background = 'rgba(0, 184, 148, 0.2)';
                diamondBadge.style.color = 'var(--success)';
                document.getElementById('diamondEngineCard').classList.remove('locked');
            }
            
            // Referral Link
            if (gameState.user.referralCode) {
                const referralLink = `https://t.me/${TELEGRAM_BOT_USERNAME.replace('@', '')}?start=ref_${gameState.user.referralCode}`;
                document.getElementById('referralLink').value = referralLink;
            }
            
            // Referral Stats
            document.getElementById('totalReferrals').textContent = gameState.referral?.totalReferrals || 0;
            document.getElementById('referralEarnings').textContent = formatTON(gameState.user.referralEarnings || 0);
            document.getElementById('referralClaimed').textContent = formatTON(gameState.user.referralEarningsClaimed || 0);
            
            // Claim Button
            const claimBtn = document.getElementById('claimReferralBtn');
            if (gameState.user.referralEarnings > 0) {
                claimBtn.disabled = false;
                claimBtn.innerHTML = `<i class="fas fa-hand-holding-usd"></i> Claim ${formatTON(gameState.user.referralEarnings)} TON`;
            } else {
                claimBtn.disabled = true;
                claimBtn.innerHTML = '<i class="fas fa-hand-holding-usd"></i> No Earnings to Claim';
            }
        }
        
        function updateMarketUI() {
            const resource = currentMarketResource;
            const marketData = gameState.market?.[resource] || { buyOrders: 0, sellOrders: 0, bestBuyPrice: 0, bestSellPrice: 0 };
            
            // Update order books based on current tab
            if (currentMarketMode === 'buy') {
                // Show sell orders (what others are selling)
                const sellOrdersList = document.getElementById('sellOrdersList');
                // This would be populated from API
            } else if (currentMarketMode === 'sell') {
                // Show buy orders (what others are buying)
                const buyOrdersList = document.getElementById('buyOrdersList');
                // This would be populated from API
            }
        }
        
        function updateReferralUI() {
            const recentReferrals = document.getElementById('recentReferrals');
            
            if (gameState.referral?.referralList?.length > 0) {
                let html = '';
                gameState.referral.referralList.slice(0, 5).forEach(ref => {
                    const date = new Date(ref.timestamp).toLocaleDateString();
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <div>
                                <div style="font-weight: 600;">User ${ref.userId.substring(0, 6)}...</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">${ref.type}</div>
                            </div>
                            <div style="color: var(--success); font-weight: 600;">+${ref.reward} TON</div>
                        </div>
                    `;
                });
                recentReferrals.innerHTML = html;
            } else {
                recentReferrals.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No referrals yet</div>';
            }
        }
        
        // ==============================================
        // MARKET UI FUNCTIONS
        // ==============================================
        
        function switchMarketMode(mode) {
            currentMarketMode = mode;
            
            document.querySelectorAll('.market-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.market-tab')[mode === 'buy' ? 0 : mode === 'sell' ? 1 : 2].classList.add('active');
            
            document.getElementById('marketBuySection').style.display = mode === 'buy' ? 'block' : 'none';
            document.getElementById('marketSellSection').style.display = mode === 'sell' ? 'block' : 'none';
            document.getElementById('marketMyOrdersSection').style.display = mode === 'my' ? 'block' : 'none';
            
            if (mode === 'my') {
                loadMyOrders();
            }
        }
        
        function switchMarketResource(resource) {
            currentMarketResource = resource;
            
            document.querySelectorAll('.resource-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.resource-tab')[resource === 'milk' ? 0 : 1].classList.add('active');
            
            // Reload market data
            updateMarketUI();
        }
        
        function setBuyAmountPercent(percent) {
            const maxTON = gameState.user.tonBalance;
            const bestPrice = gameState.market?.[currentMarketResource]?.bestSellPrice || 0.01;
            const maxAmount = Math.floor(maxTON / bestPrice);
            const amount = Math.floor(maxAmount * (percent / 100));
            document.getElementById('buyAmount').value = Math.max(100, amount);
        }
        
        function setBuyAmountMax() {
            const maxTON = gameState.user.tonBalance;
            const bestPrice = gameState.market?.[currentMarketResource]?.bestSellPrice || 0.01;
            const maxAmount = Math.floor(maxTON / bestPrice);
            document.getElementById('buyAmount').value = Math.max(100, maxAmount);
        }
        
        function setSellAmountPercent(percent) {
            const balance = currentMarketResource === 'milk' ? gameState.user.milk : gameState.user.eggs;
            const amount = Math.floor(balance * (percent / 100));
            document.getElementById('sellAmount').value = Math.max(100, amount);
        }
        
        function setSellAmountMax() {
            const balance = currentMarketResource === 'milk' ? gameState.user.milk : gameState.user.eggs;
            document.getElementById('sellAmount').value = Math.max(100, balance);
        }
        
        async function loadMyOrders() {
            // This would load the user's active orders
            const myOrdersList = document.getElementById('myOrdersList');
            myOrdersList.innerHTML = '<div style="text-align: center; padding: 30px; color: var(--text-secondary);"><i class="fas fa-clipboard-list" style="font-size: 36px; margin-bottom: 12px; opacity: 0.5;"></i><p>No active orders</p></div>';
        }
        
        // ==============================================
        // UTILITY FUNCTIONS
        // ==============================================
        
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toLocaleString();
        }
        
        function formatTON(amount) {
            if (amount === null || amount === undefined) return '0.0000';
            return parseFloat(amount).toFixed(4);
        }
        
        // ==============================================
        // NAVIGATION
        // ==============================================
        
        function switchTab(tabId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.nav-item[data-tab="${tabId}"]`).classList.add('active');
        }
        
        // ==============================================
        // MODAL FUNCTIONS
        // ==============================================
        
        function toggleHelpModal() {
            const modal = document.getElementById('helpModal');
            modal.classList.toggle('active');
        }
        
        function showProductionModal(message) {
            const modal = document.getElementById('productionModal');
            document.getElementById('productionModalMessage').textContent = message;
            modal.style.display = 'flex';
            
            setTimeout(() => {
                modal.style.display = 'none';
            }, 3000);
        }
        
        function closeProductionModal() {
            document.getElementById('productionModal').style.display = 'none';
        }
        
        // ==============================================
        // EVENT LISTENERS
        // ==============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => switchTab(item.dataset.tab));
            });
            
            // Withdrawal amount input
            document.getElementById('withdrawAmount').addEventListener('input', updateUI);
            
            // Convert amount input
            document.getElementById('convertAmount').addEventListener('input', updateUI);
            
            // Close help modal when clicking outside
            document.addEventListener('click', function(event) {
                const helpModal = document.getElementById('helpModal');
                const helpButton = document.querySelector('.help-button');
                
                if (helpModal.classList.contains('active') && 
                    !helpModal.contains(event.target) && 
                    !helpButton.contains(event.target)) {
                    helpModal.classList.remove('active');
                }
            });
        });
        
        // ==============================================
        // INITIALIZATION
        // ==============================================
        
        async function initialize() {
            console.log('Initializing Farm Economy...');
            
            // Setup Telegram Auth
            await setupTelegramAuth();
            
            // Initialize TON Connect
            setTimeout(() => {
                initTONConnect().catch(console.error);
            }, 1000);
            
            // Loading animation
            let progress = 0;
            const loadingInterval = setInterval(() => {
                progress += 5;
                document.getElementById('loadingProgress').style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(loadingInterval);
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';
                    
                    // Load game state
                    loadGameState();
                    
                    // Auto refresh every 30 seconds
                    setInterval(loadGameState, 30000);
                    
                    // Check for referrer in URL
                    const referrer = getReferrerFromURL();
                    if (referrer) {
                        setTimeout(() => {
                            alert(`üëã You were invited by a friend! If you buy machines, they will earn 10% commission.`);
                        }, 2000);
                    }
                    
                    console.log('Farm Economy initialized successfully');
                }
            }, 100);
        }
        
        // Start the app
        initialize();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DOGS Boss</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700;800&display=swap');
        :root { 
            --primary-color: #007AFF; 
            --primary-color-rgb: 0, 122, 255; 
            --secondary-color: #0056B3; 
            --background-color: #F0F2F5; 
            --card-background: #FFFFFF; 
            --text-color: #1D1D1F; 
            --text-light: #6E6E73; 
            --border-color: #E5E5EA; 
            --glass-bg: rgba(240, 242, 245, 0.8); 
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        [data-theme="dark"] { 
            --primary-color: #0A84FF; 
            --primary-color-rgb: 10, 132, 255; 
            --secondary-color: #3395FF; 
            --background-color: #000000; 
            --card-background: #1C1C1E; 
            --text-color: #F5F5F7; 
            --text-light: #8E8E93; 
            --border-color: #3A3A3C; 
            --glass-bg: rgba(28, 28, 30, 0.8); 
            --success-color: #34c759;
            --warning-color: #ffcc00;
            --danger-color: #ff3b30;
        }
        
        * { box-sizing: border-box; }
        html, body { overscroll-behavior-y: contain; }
        body { 
            font-family: 'Noto Sans', sans-serif; 
            margin: 0; 
            padding: 20px 15px 100px 15px; 
            background-color: var(--background-color); 
            color: var(--text-color); 
            -webkit-font-smoothing: antialiased; 
            transition: background-color 0.3s, color 0.3s; 
        }
        
        #preloader { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 9999; 
            background: var(--background-color); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            gap: 20px; 
            transition: opacity 0.5s ease; 
        }
        #preloader i { 
            font-size: 48px; 
            color: var(--primary-color); 
            animation: spin 1.5s linear infinite; 
        }
        #preloader-percentage { 
            font-size: 20px; 
            font-weight: 700; 
            color: var(--text-color); 
        }
        #preloader-footer { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            text-align: center; 
            padding: 15px; 
            z-index: 10000; 
            transition: opacity 0.5s ease; 
        }
        #preloader-footer a { 
            font-size: 14px; 
            font-weight: 500; 
            color: var(--text-light); 
            text-decoration: none; 
        }

        .container { 
            max-width: 500px; 
            margin: 0 auto; 
            display: none; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .profile-header { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 24px; 
            animation: fadeIn 0.5s ease-out; 
        }
        #profile-pic { 
            width: 52px; 
            height: 52px; 
            border-radius: 50%; 
            background-color: var(--border-color); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 26px; 
            font-weight: 700; 
            overflow: hidden; 
            border: 2px solid var(--card-background); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        #profile-pic img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        #greeting { 
            font-size: 22px; 
            font-weight: 800; 
        }
        
        .balance-card { 
            position: relative; 
            overflow: hidden; 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
            color: white; 
            padding: 28px; 
            border-radius: 24px; 
            text-align: center; 
            margin-bottom: 20px; 
            box-shadow: 0 12px 25px rgba(var(--primary-color-rgb), 0.2); 
            animation: fadeIn 0.6s ease-out; 
        }
        .balance-card::after { 
            content: '\f51e'; 
            font-family: 'Font Awesome 6 Free'; 
            font-weight: 900; 
            position: absolute; 
            right: -20px; 
            bottom: -30px; 
            font-size: 120px; 
            opacity: 0.1; 
            transform: rotate(-15deg); 
            pointer-events: none; 
        }
        .balance-card h3 { 
            margin: 0 0 8px 0; 
            font-size: 16px; 
            font-weight: 500; 
            opacity: 0.9; 
            z-index: 1; 
            position: relative; 
        }
        .balance-card .amount { 
            font-size: 48px; 
            font-weight: 800; 
            line-height: 1.2; 
            z-index: 1; 
            position: relative; 
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 16px; 
            margin-bottom: 20px; 
        }
        .stat-item { 
            position: relative; 
            overflow: hidden; 
            background-color: var(--card-background); 
            padding: 20px; 
            border-radius: 18px; 
            text-align: center; 
            border: 1px solid var(--border-color); 
            animation: fadeIn 0.7s ease-out; 
            transition: background-color 0.3s, border-color 0.3s; 
        }
        .stat-item .bg-icon { 
            position: absolute; 
            right: 5px; 
            bottom: 5px; 
            font-size: 50px; 
            opacity: 0.08; 
            color: var(--text-color); 
            pointer-events: none; 
        }
        .stat-item .icon { 
            font-size: 28px; 
            color: var(--primary-color); 
            margin-bottom: 12px; 
        }
        .stat-item .value { 
            font-size: 24px; 
            font-weight: 800; 
        }
        .stat-item .label { 
            font-size: 14px; 
            color: var(--text-light); 
        }
        
        .card { 
            background-color: var(--card-background); 
            padding: 20px; 
            border-radius: 18px; 
            margin-bottom: 20px; 
            border: 1px solid var(--border-color); 
            animation: fadeIn 0.8s ease-out; 
            transition: background-color 0.3s, border-color 0.3s; 
        }
        .card-title { 
            font-size: 18px; 
            font-weight: 700; 
            margin-bottom: 16px; 
        }
        .chart-container { 
            position: relative; 
            height: 200px; 
            width: 100%; 
        }
        
        @keyframes pulse { 
            0% { box-shadow: 0 0 0 0 rgba(var(--primary-color-rgb), 0.4); } 
            70% { box-shadow: 0 0 0 10px rgba(var(--primary-color-rgb), 0); } 
            100% { box-shadow: 0 0 0 0 rgba(var(--primary-color-rgb), 0); } 
        }
        .action-button { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 12px; 
            width: 100%; 
            padding: 18px; 
            border: none; 
            border-radius: 16px; 
            background-color: var(--primary-color); 
            color: white; 
            font-size: 18px; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.2s ease; 
        }
        .action-button.pulsing { 
            animation: pulse 2s infinite; 
        }
        .action-button:hover:not(:disabled) { 
            transform: translateY(-3px); 
            box-shadow: 0 4px 10px rgba(var(--primary-color-rgb), 0.2); 
        }
        .action-button:disabled { 
            background-color: #8E8E93; 
            cursor: not-allowed; 
        }
        .secondary-button { 
            background-color: transparent; 
            color: var(--primary-color); 
            border: 2px solid var(--primary-color); 
            margin-top: 15px; 
        }
        
        .nav-bar { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            max-width: 500px; 
            margin: 0 auto; 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            padding: 10px 15px; 
            background: var(--glass-bg); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            border-top: 1px solid var(--border-color); 
            transition: background-color 0.3s, border-color 0.3s; 
            z-index: 100; 
        }
        .nav-button { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            gap: 4px; 
            padding: 8px; 
            border-radius: 12px; 
            color: var(--text-light); 
            text-decoration: none; 
            font-size: 12px; 
            font-weight: 500; 
            border: none; 
            background: transparent; 
            cursor: pointer; 
            transition: all 0.2s ease; 
        }
        .nav-button.active, .nav-button:hover { 
            color: var(--primary-color); 
            background-color: rgba(var(--primary-color-rgb), 0.1); 
        }
        .nav-button i { 
            font-size: 20px; 
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.6); 
            align-items: flex-end; 
            animation: fadeIn 0.3s ease-out; 
        }
        .modal-content { 
            background-color: var(--card-background); 
            padding: 20px; 
            border-radius: 20px 20px 0 0; 
            width: 100%; 
            max-width: 500px; 
            margin: 0 auto; 
            box-sizing: border-box; 
            animation: slideIn 0.3s ease-out; 
            max-height: 80vh; 
            overflow-y: auto;
        }
        @keyframes slideIn { 
            from { transform: translateY(100%); } 
            to { transform: translateY(0); } 
        }
        .close-button { 
            color: #aaa; 
            float: right; 
            font-size: 28px; 
            line-height: 1; 
            font-weight: bold; 
            cursor: pointer; 
        }
        .modal-content input, .modal-content select { 
            width: 100%; 
            padding: 14px; 
            margin: 10px 0; 
            border: 1px solid var(--border-color); 
            border-radius: 10px; 
            font-family: 'Noto Sans', sans-serif; 
            font-size: 16px; 
            background-color: var(--background-color); 
            color: var(--text-color); 
            transition: border-color 0.2s, box-shadow 0.2s; 
        }
        .modal-content input:focus, .modal-content select:focus { 
            outline: none; 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.2); 
        }
        
        #bonus-tasks-list .bonus-item { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 15px; 
            background-color: var(--background-color); 
            border-radius: 12px; 
            margin-bottom: 12px; 
            border: 1px solid var(--border-color); 
        }
        .bonus-item .details { 
            display: flex; 
            flex-direction: column; 
            gap: 4px; 
        }
        .bonus-item .title { 
            font-weight: 600; 
            font-size: 16px; 
            color: var(--text-color); 
        }
        .bonus-item .reward { 
            font-size: 14px; 
            font-weight: 700; 
            color: var(--primary-color); 
        }
        .bonus-item .reward i { 
            margin-right: 5px; 
        }
        .bonus-item .claim-button { 
            padding: 10px 20px; 
            font-size: 14px; 
            font-weight: 600; 
            border-radius: 10px; 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            cursor: pointer; 
            transition: background-color 0.2s; 
        }
        .bonus-item .claim-button:disabled { 
            background-color: #28a745; 
            cursor: not-allowed; 
        }

        .history-item { 
            padding: 15px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .history-item:last-child { 
            border-bottom: none; 
        }
        .history-details { 
            display: flex; 
            flex-direction: column; 
            gap: 4px; 
        }
        .history-details .method-number { 
            font-weight: 700; 
            font-size: 16px; 
        }
        .history-details .date { 
            font-size: 12px; 
            color: var(--text-light); 
        }
        .history-amount { 
            font-size: 18px; 
            font-weight: 800; 
            text-align: right; 
        }
        .history-status { 
            font-size: 12px; 
            font-weight: 700; 
            padding: 4px 8px; 
            border-radius: 8px; 
        }
        .history-status.success { 
            color: #28a745; 
            background-color: rgba(40, 167, 69, 0.1); 
        }
        .history-status.pending { 
            color: #fd7e14; 
            background-color: rgba(253, 126, 20, 0.1); 
        }
        .no-history { 
            text-align: center; 
            padding: 40px 20px; 
            color: var(--text-light); 
        }

        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .spinner { 
            border: 2px solid #f3f3f3; 
            border-top: 2px solid var(--secondary-color); 
            border-radius: 50%; 
            width: 18px; 
            height: 18px; 
            animation: spin 1s linear infinite; 
        }
        #ad-loader-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 5000; 
            background: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(5px); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            flex-direction: column; 
            gap: 15px; 
            color: white; 
            font-size: 16px; 
        }
        .loader { 
            width: 48px; 
            height: 48px; 
            border: 5px solid #FFF; 
            border-bottom-color: var(--primary-color); 
            border-radius: 50%; 
            display: inline-block; 
            animation: rotation 1s linear infinite; 
        }
        #multiAccountModal .modal-content { 
            text-align: center; 
            border-radius: 20px; 
            max-height: initial;
        }
        #multiAccountModal { 
            align-items: center; 
            justify-content: center; 
        }

        /* Admin Panel Styles */
        .admin-panel { 
            display: none; 
            max-width: 500px; 
            margin: 0 auto; 
            animation: fadeIn 0.5s ease-out; 
        }
        .admin-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin-bottom: 20px; 
        }
        .admin-stats-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        .admin-stat-item { 
            background-color: var(--card-background); 
            padding: 16px; 
            border-radius: 14px; 
            border: 1px solid var(--border-color); 
            text-align: center; 
        }
        .admin-stat-value { 
            font-size: 24px; 
            font-weight: 800; 
            margin-bottom: 4px; 
        }
        .admin-stat-label { 
            font-size: 12px; 
            color: var(--text-light); 
        }
        .admin-section { 
            margin-bottom: 20px; 
        }
        .admin-section-title { 
            font-size: 16px; 
            font-weight: 700; 
            margin-bottom: 12px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .admin-list { 
            background-color: var(--card-background); 
            border-radius: 14px; 
            border: 1px solid var(--border-color); 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .admin-list-item { 
            padding: 14px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .admin-list-item:last-child { 
            border-bottom: none; 
        }
        .admin-user-info { 
            display: flex; 
            flex-direction: column; 
            gap: 4px; 
        }
        .admin-user-name { 
            font-weight: 600; 
            font-size: 14px; 
        }
        .admin-user-balance { 
            font-size: 12px; 
            color: var(--text-light); 
        }
        .admin-actions { 
            display: flex; 
            gap: 8px; 
        }
        .admin-btn { 
            padding: 6px 12px; 
            border: none; 
            border-radius: 8px; 
            font-size: 12px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s ease; 
        }
        .admin-btn-primary { 
            background-color: var(--primary-color); 
            color: white; 
        }
        .admin-btn-success { 
            background-color: var(--success-color); 
            color: white; 
        }
        .admin-btn-danger { 
            background-color: var(--danger-color); 
            color: white; 
        }
        .admin-btn-warning { 
            background-color: var(--warning-color); 
            color: var(--text-color); 
        }
        .admin-form-group { 
            margin-bottom: 12px; 
        }
        .admin-form-label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 600; 
            font-size: 14px; 
        }
        .admin-input { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            background-color: var(--background-color); 
            color: var(--text-color); 
            font-family: 'Noto Sans', sans-serif; 
        }
        .admin-tabs { 
            display: flex; 
            border-bottom: 1px solid var(--border-color); 
            margin-bottom: 16px; 
        }
        .admin-tab { 
            padding: 10px 16px; 
            border: none; 
            background: none; 
            color: var(--text-light); 
            font-weight: 600; 
            cursor: pointer; 
            border-bottom: 2px solid transparent; 
            transition: all 0.2s ease; 
        }
        .admin-tab.active { 
            color: var(--primary-color); 
            border-bottom-color: var(--primary-color); 
        }
        .admin-tab-content { 
            display: none; 
        }
        .admin-tab-content.active { 
            display: block; 
        }
        .admin-search { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            margin-bottom: 12px; 
            background-color: var(--background-color); 
            color: var(--text-color); 
        }
        .admin-notification { 
            position: fixed; 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            background-color: var(--card-background); 
            padding: 12px 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            z-index: 1001; 
            display: none; 
            align-items: center; 
            gap: 8px; 
            animation: fadeIn 0.3s ease-out; 
        }
        .admin-notification.success { 
            border-left: 4px solid var(--success-color); 
        }
        .admin-notification.error { 
            border-left: 4px solid var(--danger-color); 
        }
    </style>
</head>
<body>
    <div id="preloader">
        <i class="fa-solid fa-spinner"></i>
        <div id="preloader-percentage">0%</div>
    </div>
    <div id="preloader-footer">
        <a href="https://t.me/The_DogsBoss" target="_blank">DOGS Boss News</a>
    </div>
    
    <div id="ad-loader-overlay"><div class="loader"></div><span>Loading Ad...</span></div>
    
    <!-- Main User Interface -->
    <div class="container">
        <div class="profile-header">
            <div id="profile-pic"><i class="fa-solid fa-user"></i></div>
            <h1 id="greeting">Welcome!</h1>
        </div>
        <div class="balance-card">
            <h3>Your Balance</h3>
            <div class="amount" id="total-earning">0.000 DOGS</div>
        </div>
        <div class="stats-grid">
            <div class="stat-item">
                <i class="fa-solid fa-rectangle-ad bg-icon"></i>
                <div class="icon"><i class="fa-solid fa-rectangle-ad"></i></div>
                <div class="value" id="ad-count">0</div>
                <div class="label">ADS Watched</div>
            </div>
            <div class="stat-item">
                <i class="fa-solid fa-calendar-day bg-icon"></i>
                <div class="icon"><i class="fa-solid fa-calendar-day"></i></div>
                <div class="value" id="ads-today-count">0 / 15</div>
                <div class="label">Today ADS</div>
            </div>
            <div class="stat-item">
                <i class="fa-solid fa-users bg-icon"></i>
                <div class="icon"><i class="fa-solid fa-users"></i></div>
                <div class="value" id="referral-count">0</div>
                <div class="label">Referrals</div>
            </div>
        </div>
      
        <div class="card">
            <h3 class="card-title"> <i class="fa-solid fa-video"></i>   WATCH ADS</h3>
            <button class="action-button" id="watch-ad-button">
                <i class="fa-solid fa-play"></i>
                <span>Watch AD</span>
            </button>
            <button class="action-button secondary-button" id="join-channel-button">
                <i class="fa-brands fa-telegram"></i>
                <span>DOGS Boss News</span>
            </button>
        </div>

        <div class="card">
            <h3 class="card-title"> <i class="fa-solid fa-chart-line"></i> Weekly Activity</h3>
            <div class="chart-container">
                <canvas id="activityChart"></canvas>
            </div>
        </div>
    </div>
   
    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-header">
            <h1 style="font-size: 24px; font-weight: 800; margin: 0;">
                <i class="fa-solid fa-shield-halved"></i> Admin Panel
            </h1>
            <button class="admin-btn admin-btn-primary" onclick="switchToUserView()">
                <i class="fa-solid fa-arrow-left"></i> User View
            </button>
        </div>

        <div class="admin-stats-grid">
            <div class="admin-stat-item">
                <div class="admin-stat-value" id="admin-total-users">0</div>
                <div class="admin-stat-label">Total Users</div>
            </div>
            <div class="admin-stat-item">
                <div class="admin-stat-value" id="admin-total-withdrawals">0</div>
                <div class="admin-stat-label">Total Withdrawals</div>
            </div>
            <div class="admin-stat-item">
                <div class="admin-stat-value" id="admin-total-earnings">0</div>
                <div class="admin-stat-label">Total Earnings</div>
            </div>
            <div class="admin-stat-item">
                <div class="admin-stat-value" id="admin-active-referrals">0</div>
                <div class="admin-stat-label">Active Referrals</div>
            </div>
        </div>

        <div class="admin-tabs">
            <button class="admin-tab active" onclick="switchAdminTab('users')">Users</button>
            <button class="admin-tab" onclick="switchAdminTab('withdrawals')">Withdrawals</button>
            <button class="admin-tab" onclick="switchAdminTab('settings')">Settings</button>
            <button class="admin-tab" onclick="switchAdminTab('notifications')">Notifications</button>
        </div>

        <!-- Users Tab -->
        <div class="admin-tab-content active" id="usersTab">
            <div class="admin-section">
                <h3 class="admin-section-title">
                    <i class="fa-solid fa-users"></i> User Management
                </h3>
                <input type="text" class="admin-search" id="userSearch" placeholder="Search users...">
                <div class="admin-list" id="usersList">
                    <!-- Users will be populated here -->
                </div>
            </div>
        </div>

        <!-- Withdrawals Tab -->
        <div class="admin-tab-content" id="withdrawalsTab">
            <div class="admin-section">
                <h3 class="admin-section-title">
                    <i class="fa-solid fa-money-bill-wave"></i> Pending Withdrawals
                </h3>
                <div class="admin-list" id="pendingWithdrawals">
                    <!-- Pending withdrawals will be populated here -->
                </div>
            </div>
            <div class="admin-section">
                <h3 class="admin-section-title">
                    <i class="fa-solid fa-history"></i> Withdrawal History
                </h3>
                <div class="admin-list" id="withdrawalHistory">
                    <!-- Withdrawal history will be populated here -->
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="admin-tab-content" id="settingsTab">
            <div class="admin-section">
                <h3 class="admin-section-title">
                    <i class="fa-solid fa-cog"></i> App Settings
                </h3>
                <div class="admin-form-group">
                    <label class="admin-form-label">Ad Reward (DOGS)</label>
                    <input type="number" class="admin-input" id="adRewardSetting" value="5">
                </div>
                <div class="admin-form-group">
                    <label class="admin-form-label">Daily Ad Limit</label>
                    <input type="number" class="admin-input" id="dailyAdLimitSetting" value="15">
                </div>
                <div class="admin-form-group">
                    <label class="admin-form-label">Minimum Withdrawal</label>
                    <input type="number" class="admin-input" id="minWithdrawalSetting" value="2500">
                </div>
                <div class="admin-form-group">
                    <label class="admin-form-label">Referral Reward (DOGS)</label>
                    <input type="number" class="admin-input" id="referralRewardSetting" value="80">
                </div>
                <button class="action-button" onclick="saveSettings()">
                    <i class="fa-solid fa-save"></i> Save Settings
                </button>
            </div>
        </div>

        <!-- Notifications Tab -->
        <div class="admin-tab-content" id="notificationsTab">
            <div class="admin-section">
                <h3 class="admin-section-title">
                    <i class="fa-solid fa-bell"></i> Send Notification
                </h3>
                <div class="admin-form-group">
                    <label class="admin-form-label">Notification Title</label>
                    <input type="text" class="admin-input" id="notificationTitle" placeholder="Enter title...">
                </div>
                <div class="admin-form-group">
                    <label class="admin-form-label">Notification Message</label>
                    <textarea class="admin-input" id="notificationMessage" rows="4" placeholder="Enter message..."></textarea>
                </div>
                <div class="admin-form-group">
                    <label class="admin-form-label">Target Users</label>
                    <select class="admin-input" id="notificationTarget">
                        <option value="all">All Users</option>
                        <option value="active">Active Users Only</option>
                        <option value="inactive">Inactive Users Only</option>
                    </select>
                </div>
                <button class="action-button" onclick="sendNotification()">
                    <i class="fa-solid fa-paper-plane"></i> Send Notification
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Notification -->
    <div class="admin-notification" id="adminNotification"></div>
  
    <!-- Navigation Bar -->
    <div class="nav-bar">
        <button class="nav-button" onclick="showModal('withdrawModal', this)">
            <i class="fa-solid fa-wallet"></i>
            <span>Withdraw</span>
        </button>
        <button class="nav-button" onclick="showModal('historyModal', this)">
            <i class="fa-solid fa-clock"></i>
            <span>History</span>
        </button>
        <button class="nav-button" onclick="showModal('bonusTasksModal', this)">
            <i class="fa-solid fa-tasks"></i>
            <span>Tasks</span>
        </button>
        <button class="nav-button" onclick="showModal('inviteModal', this)">
            <i class="fa-solid fa-user-friends"></i>
            <span>Friends</span>
        </button>
        <button class="nav-button" id="adminNavButton" onclick="toggleAdminPanel()">
            <i class="fa-solid fa-shield-halved"></i>
            <span>Admin</span>
        </button>
    </div>
  
    <!-- All Modals -->
    <div id="welcomeModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('welcomeModal')">&times;</span>
            <h3 id="welcome-title" class="card-title" style="text-align:center;"></h3>
            <p id="welcome-message" style="line-height: 1.6; font-size: 15px; text-align: center; white-space: pre-wrap; margin: 15px 0;"></p>
            <button class="action-button" onclick="closeModal('welcomeModal')">Continue</button>
        </div>
    </div>
    
    <!-- Withdraw Modal -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('withdrawModal')">&times;</span>
            <h3 class="card-title"><i class="fa-solid fa-credit-card"></i> Withdraw Funds</h3>
            <form id="withdraw-form">
                <select id="method" name="method" required>
                    <option value="DOGS Wallet" selected>DOGS Wallet</option>
                </select>
                <input type="text" id="account-number" placeholder="Enter DOGS Wallet" required>
                <input type="number" step="0.001" id="withdraw-amount" placeholder="Enter DOGS Amount" required>
                <p><i class="fa-solid fa-info-circle"></i> Minimum Withdrawal: 2,500 DOGS</p>
                <button type="submit" class="action-button" id="withdraw-submit-button">
                    <span class="button-text">Confirm</span>
                    <div class="spinner" style="display: none;"></div>
                </button>
            </form>
        </div>
    </div>
  
    <!-- Gifts Modal -->
    <div id="supportModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('supportModal')">&times;</span>
            <h3 class="card-title">
                <i class="fa-solid fa-gift"></i> Promo Codes
            </h3>
            <p style="text-align:center;margin-bottom:15px;">
                Are you have a promo code?
            </p>
            <div style="display:flex;flex-direction:column;align-items:center;gap:10px;">
                <input id="promo-input" placeholder="Enter Promo Code" 
                    style="padding:12px;border-radius:10px;border:1px solid var(--border-color);
                    width:90%;max-width:300px;background-color:var(--background-color);
                    color:var(--text-color);text-align:center;">
                <button id="promo-btn" class="action-button" style="width:90%;max-width:300px;">
                    <span>CLAIM</span>
                </button>
            </div>
            <p id="promo-message" style="text-align:center;margin-top:10px;color:var(--text-light);font-weight:500;"></p>
        </div>
    </div>
  
    <!-- History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('historyModal')">&times;</span>
            <h3 class="card-title"> <i class="fa-solid fa-history"></i>  Withdrawal History</h3>
            <div id="history-list"></div>
        </div>
    </div>
  
    <!-- Invite Modal -->
    <div id="inviteModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('inviteModal')">&times;</span>
            <h3 class="card-title"> <i class="fa-solid fa-share-alt"></i>  Invite Friends</h3>
            <p>
                Share your referral link with your friends and earn together.
                You will get a reward for each successful referral.
            </p>
            <button class="action-button" id="copy-link-button">
                <i class="fa-solid fa-copy"></i>
                <span>Copy Link</span>
            </button>
            <button class="action-button secondary-button" id="share-link-button">
                <i class="fa-solid fa-share-nodes"></i>
                <span>Share Link</span>
            </button>
        </div>
    </div>
  
    <!-- Bonus Tasks Modal -->
    <div id="bonusTasksModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('bonusTasksModal')">&times;</span>
            <h3 class="card-title"><i class="fa-solid fa-bullseye"></i>  Available Tasks</h3>
            <p style="text-align: center; margin-bottom: 20px;">Complete tasks to earn DOGS</p>
            <div id="bonus-tasks-list"></div>
        </div>
    </div>
  
    <!-- Multi Account Modal -->
    <div id="multiAccountModal" class="modal">
        <div class="modal-content">
            <h3 class="card-title" style="text-align:center;">‚ö†Ô∏è Warning</h3>
            <p>Multiple accounts are not allowed. Only one Telegram account can be used on this device. Please use your original account to continue.</p>
        </div>
    </div>

    <script>
        // --- INSTANT THEME APPLY SCRIPT ---
        (function() {
            try {
                const tg = window.Telegram.WebApp;
                const isDark = tg.colorScheme === 'dark';
                document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            } catch (e) {
                const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            }
        })();

        const config = {
            ADMIN_IDS: [6970148965],
            BOT_USERNAME: 'DogsBossBot',
            TELEGRAM_CHANNEL_LINK: 'https://t.me/The_DogsBoss',
            ADMIN_SUPPORT_LINK: 'https://t.me/link',
            MONETAG_ZONE_ID: '10071035',
            AD_REWARD: 5,
            DAILY_AD_LIMIT: 500,
            MINIMUM_WITHDRAWAL: 2500,
            COOLDOWN_MINUTES: 1,
            firebase: {
                apiKey: "AIzaSyAcwYjMSpnOC1_MSFpBzctqiKRmhwLOtY4",
                authDomain: "dogs-boss.firebaseapp.com",
                databaseURL: "https://dogs-boss-default-rtdb.firebaseio.com",
                projectId: "dogs-boss",
                storageBucket: "dogs-boss.firebasestorage.app",
                messagingSenderId: "778183941825",
                appId: "1:778183941825:web:45a96727e1aad043bffe40",
                measurementId: "G-EY15XEGP53"
            }, 
            REFERRAL_REWARD: 80,
            bonusTasks: [
                { id: 'task_1', title: 'Dogs Boss News ü¶¥', link: 'https://t.me/The_DogsBoss', reward: 20, duration: 10 },
                { id: 'task_2', title: 'DOGS Boss Chat ü¶¥', link: 'https://t.me/DogsBoss_Chat', reward: 20, duration: 10 }, 
                { id: 'task_3', title: 'FREE TON Earning', link: 'https://t.me/FREE_TON3', reward: 20, duration: 10 }, 
                { id: 'task_4', title: 'MONEY HUB', link: 'https://t.me/MONEYHUB9_69', reward: 20, duration: 10 }, 
                { id: 'task_5', title: 'King Mining', link: 'https://t.me/HishamAlHobani', reward: 20, duration: 10 },
                { id: 'task_6', title: 'Team Hamza', link: 'https://t.me/TemHamza', reward: 20, duration: 10 },
                { id: 'task_7', title: 'Akaza roulette', link: 'https://t.me/akaza_roulette', reward: 20, duration: 10 },
                { id: 'task_8', title: 'Investor', link: 'https://t.me/+VU9Gfe09qCllYmEy', reward: 20, duration: 10 },
                { id: 'task_9', title: 'Crypto al2', link: 'https://t.me/Crypto_al2', reward: 20, duration: 10 },
                { id: 'task_10', title: 'Profit Hub', link: 'https://t.me/ProfitHubMining_Bot?start=279718', reward: 20, duration: 10 },
                { id: 'task_11', title: 'Oil Tycoon', link: 'https://t.me/OilTycoonTON_bot/game?startapp=ii_6275536124', reward: 20, duration: 10 },
                { id: 'task_12', title: 'COC Web3', link: 'https://t.me/COC_Web3_bot/prereg?startapp=WH7AKGVM', reward: 20, duration: 10 },
                { id: 'task_13', title: 'AD flow', link: 'https://t.me/AdFlowAdsBot?start=6275536124', reward: 20, duration: 10 },
                { id: 'task_14', title: 'i Miner', link: 'https://t.me/iMiner_bot/mining?startapp=r_rR8W8mTXRYYS', reward: 20, duration: 10 },
                { id: 'task_15', title: 'Aivex', link: 'https://t.me/Aivexpro_bot?start=1891231976', reward: 20, duration: 10 },
                { id: 'task_17', title: 'Candy World', link: 'https://t.me/myCandyWorldBot/myapp?startapp=6275536124', reward: 20, duration: 10 },
            ],
            welcomeNotice: {
                title: "Welcome!",
                message: `Welcome To DOGS Boss MiniApp`
            }
        };

        // --- MAIN APP LOGIC ---
        const tg = window.Telegram ? window.Telegram.WebApp : null;
        let state = { 
            totalEarning: 0.0, 
            adCount: 0, 
            adsWatchedToday: 0, 
            lastAdWatchedDate: null, 
            cooldownUntil: null, 
            weeklyActivity: [0, 0, 0, 0, 0, 0, 0], 
            withdrawalHistory: [], 
            lastUsedIp: null, 
            completedBonusTasks: [], 
            rewardedReferrals: 0, 
            originalUserId: null 
        };
      
        const dbName = 'AdBotAppDB'; 
        let db;
        let currentIpAddress = null;
        let firebaseApp, firebaseDb;

        const allDOMElements = { 
            preloader: document.getElementById('preloader'), 
            preloaderPercentage: document.getElementById('preloader-percentage'), 
            preloaderFooter: document.getElementById('preloader-footer'),
            container: document.querySelector('.container'), 
            totalEarningEl: document.getElementById('total-earning'), 
            adCountEl: document.getElementById('ad-count'), 
            adsTodayCountEl: document.getElementById('ads-today-count'), 
            referralCountEl: document.getElementById('referral-count'), 
            watchAdButton: document.getElementById('watch-ad-button'), 
            withdrawForm: document.getElementById('withdraw-form'), 
            adLoaderOverlay: document.getElementById('ad-loader-overlay'), 
            profilePicEl: document.getElementById('profile-pic'), 
            greetingEl: document.getElementById('greeting'), 
            joinChannelButton: document.getElementById('join-channel-button'), 
            adminContactButton: document.getElementById('admin-contact-button'), 
            copyLinkButton: document.getElementById('copy-link-button'), 
            shareLinkButton: document.getElementById('share-link-button'), 
            historyListEl: document.getElementById('history-list'), 
            bonusTasksListEl: document.getElementById('bonus-tasks-list'), 
            minWithdrawText: document.getElementById('min-withdraw-text'),
            welcomeTitle: document.getElementById('welcome-title'), 
            welcomeMessage: document.getElementById('welcome-message'),
            adminPanel: document.getElementById('adminPanel'),
            adminNavButton: document.getElementById('adminNavButton')
        };
        
        // --- ADMIN PANEL FUNCTIONS ---
        function toggleAdminPanel() {
            const user = tg ? tg.initDataUnsafe?.user : null;
            const isAdmin = user && config.ADMIN_IDS.includes(user.id);
            
            if (!isAdmin) {
                safeTgAlert('‚ùå Access denied. Admin privileges required.');
                return;
            }
            
            const container = allDOMElements.container;
            const adminPanel = allDOMElements.adminPanel;
            
            if (adminPanel.style.display === 'none' || !adminPanel.style.display) {
                container.style.display = 'none';
                adminPanel.style.display = 'block';
                loadAdminData();
                allDOMElements.adminNavButton.classList.add('active');
            } else {
                switchToUserView();
            }
        }
        
        function switchToUserView() {
            allDOMElements.container.style.display = 'block';
            allDOMElements.adminPanel.style.display = 'none';
            allDOMElements.adminNavButton.classList.remove('active');
        }
        
        function switchAdminTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.admin-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load data for the tab
            if (tabName === 'users') {
                loadUsersList();
            } else if (tabName === 'withdrawals') {
                loadWithdrawalsData();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }
        
        async function loadAdminData() {
            if (!firebaseDb) return;
            
            try {
                // Load total users count
                const usersRef = firebaseDb.ref('users');
                const usersSnapshot = await usersRef.once('value');
                const totalUsers = usersSnapshot.numChildren();
                document.getElementById('admin-total-users').textContent = totalUsers;
                
                // Load total withdrawals
                let totalWithdrawals = 0;
                usersSnapshot.forEach(userSnapshot => {
                    const userData = userSnapshot.val();
                    if (userData.withdrawalHistory) {
                        totalWithdrawals += Object.keys(userData.withdrawalHistory).length;
                    }
                });
                document.getElementById('admin-total-withdrawals').textContent = totalWithdrawals;
                
                // Load total earnings
                let totalEarnings = 0;
                usersSnapshot.forEach(userSnapshot => {
                    const userData = userSnapshot.val();
                    if (userData.totalEarning) {
                        totalEarnings += userData.totalEarning;
                    }
                });
                document.getElementById('admin-total-earnings').textContent = Math.floor(totalEarnings);
                
                // Load active referrals
                let activeReferrals = 0;
                usersSnapshot.forEach(userSnapshot => {
                    const userData = userSnapshot.val();
                    if (userData.referrals && userData.referrals > 0) {
                        activeReferrals += userData.referrals;
                    }
                });
                document.getElementById('admin-active-referrals').textContent = activeReferrals;
                
                // Load users list
                loadUsersList();
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                showAdminNotification('Error loading admin data', 'error');
            }
        }
        
        async function loadUsersList() {
            if (!firebaseDb) return;
            
            try {
                const usersRef = firebaseDb.ref('users');
                const snapshot = await usersRef.once('value');
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = '';
                
                snapshot.forEach(userSnapshot => {
                    const userData = userSnapshot.val();
                    const userId = userSnapshot.key;
                    
                    const userItem = document.createElement('div');
                    userItem.className = 'admin-list-item';
                    userItem.innerHTML = `
                        <div class="admin-user-info">
                            <div class="admin-user-name">User ID: ${userId}</div>
                            <div class="admin-user-balance">Balance: ${userData.totalEarning || 0} DOGS | Referrals: ${userData.referrals || 0}</div>
                        </div>
                        <div class="admin-actions">
                            <button class="admin-btn admin-btn-primary" onclick="editUserBalance('${userId}')">
                                <i class="fa-solid fa-edit"></i>
                            </button>
                            <button class="admin-btn admin-btn-danger" onclick="banUser('${userId}')">
                                <i class="fa-solid fa-ban"></i>
                            </button>
                        </div>
                    `;
                    usersList.appendChild(userItem);
                });
                
                if (snapshot.numChildren() === 0) {
                    usersList.innerHTML = '<div class="no-history">No users found</div>';
                }
                
            } catch (error) {
                console.error('Error loading users list:', error);
                showAdminNotification('Error loading users', 'error');
            }
        }
        
        async function loadWithdrawalsData() {
            if (!firebaseDb) return;
            
            try {
                const usersRef = firebaseDb.ref('users');
                const snapshot = await usersRef.once('value');
                const pendingWithdrawals = document.getElementById('pendingWithdrawals');
                const withdrawalHistory = document.getElementById('withdrawalHistory');
                
                pendingWithdrawals.innerHTML = '';
                withdrawalHistory.innerHTML = '';
                
                let hasPending = false;
                let hasHistory = false;
                
                snapshot.forEach(userSnapshot => {
                    const userData = userSnapshot.val();
                    const userId = userSnapshot.key;
                    
                    if (userData.withdrawalHistory) {
                        Object.entries(userData.withdrawalHistory).forEach(([withdrawalId, withdrawal]) => {
                            const withdrawalItem = document.createElement('div');
                            withdrawalItem.className = 'admin-list-item';
                            
                            if (withdrawal.status === 'Pending') {
                                hasPending = true;
                                withdrawalItem.innerHTML = `
                                    <div class="admin-user-info">
                                        <div class="admin-user-name">User: ${userId}</div>
                                        <div class="admin-user-balance">Amount: ${withdrawal.amount} DOGS | Method: ${withdrawal.method}</div>
                                        <div class="admin-user-balance">Wallet: ${withdrawal.number}</div>
                                    </div>
                                    <div class="admin-actions">
                                        <button class="admin-btn admin-btn-success" onclick="approveWithdrawal('${userId}', '${withdrawalId}')">
                                            <i class="fa-solid fa-check"></i>
                                        </button>
                                        <button class="admin-btn admin-btn-danger" onclick="rejectWithdrawal('${userId}', '${withdrawalId}')">
                                            <i class="fa-solid fa-times"></i>
                                        </button>
                                    </div>
                                `;
                                pendingWithdrawals.appendChild(withdrawalItem);
                            } else {
                                hasHistory = true;
                                const statusClass = withdrawal.status === 'Success' ? 'success' : 'danger';
                                withdrawalItem.innerHTML = `
                                    <div class="admin-user-info">
                                        <div class="admin-user-name">User: ${userId}</div>
                                        <div class="admin-user-balance">Amount: ${withdrawal.amount} DOGS | Method: ${withdrawal.method}</div>
                                        <div class="admin-user-balance">Status: <span class="history-status ${statusClass}">${withdrawal.status}</span></div>
                                    </div>
                                `;
                                withdrawalHistory.appendChild(withdrawalItem);
                            }
                        });
                    }
                });
                
                if (!hasPending) {
                    pendingWithdrawals.innerHTML = '<div class="no-history">No pending withdrawals</div>';
                }
                
                if (!hasHistory) {
                    withdrawalHistory.innerHTML = '<div class="no-history">No withdrawal history</div>';
                }
                
            } catch (error) {
                console.error('Error loading withdrawals data:', error);
                showAdminNotification('Error loading withdrawals', 'error');
            }
        }
        
        function loadSettings() {
            document.getElementById('adRewardSetting').value = config.AD_REWARD;
            document.getElementById('dailyAdLimitSetting').value = config.DAILY_AD_LIMIT;
            document.getElementById('minWithdrawalSetting').value = config.MINIMUM_WITHDRAWAL;
            document.getElementById('referralRewardSetting').value = config.REFERRAL_REWARD;
        }
        
        async function saveSettings() {
            try {
                config.AD_REWARD = parseInt(document.getElementById('adRewardSetting').value);
                config.DAILY_AD_LIMIT = parseInt(document.getElementById('dailyAdLimitSetting').value);
                config.MINIMUM_WITHDRAWAL = parseInt(document.getElementById('minWithdrawalSetting').value);
                config.REFERRAL_REWARD = parseInt(document.getElementById('referralRewardSetting').value);
                
                // Save to localStorage as backup
                localStorage.setItem('appSettings', JSON.stringify({
                    AD_REWARD: config.AD_REWARD,
                    DAILY_AD_LIMIT: config.DAILY_AD_LIMIT,
                    MINIMUM_WITHDRAWAL: config.MINIMUM_WITHDRAWAL,
                    REFERRAL_REWARD: config.REFERRAL_REWARD
                }));
                
                showAdminNotification('Settings saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving settings:', error);
                showAdminNotification('Error saving settings', 'error');
            }
        }
        
        async function approveWithdrawal(userId, withdrawalId) {
            if (!firebaseDb) return;
            
            try {
                const withdrawalRef = firebaseDb.ref(`users/${userId}/withdrawalHistory/${withdrawalId}`);
                await withdrawalRef.update({ status: 'Success' });
                
                showAdminNotification('Withdrawal approved!', 'success');
                loadWithdrawalsData();
            } catch (error) {
                console.error('Error approving withdrawal:', error);
                showAdminNotification('Error approving withdrawal', 'error');
            }
        }
        
        async function rejectWithdrawal(userId, withdrawalId) {
            if (!firebaseDb) return;
            
            try {
                const withdrawalRef = firebaseDb.ref(`users/${userId}/withdrawalHistory/${withdrawalId}`);
                const withdrawalSnapshot = await withdrawalRef.once('value');
                const withdrawalData = withdrawalSnapshot.val();
                
                // Return funds to user
                const userRef = firebaseDb.ref(`users/${userId}/totalEarning`);
                const userSnapshot = await userRef.once('value');
                const currentBalance = userSnapshot.val() || 0;
                await userRef.set(currentBalance + withdrawalData.amount);
                
                // Update withdrawal status
                await withdrawalRef.update({ status: 'Rejected' });
                
                showAdminNotification('Withdrawal rejected and funds returned!', 'success');
                loadWithdrawalsData();
            } catch (error) {
                console.error('Error rejecting withdrawal:', error);
                showAdminNotification('Error rejecting withdrawal', 'error');
            }
        }
        
        async function editUserBalance(userId) {
            const newBalance = prompt('Enter new balance for user ' + userId + ':', '0');
            if (newBalance !== null && !isNaN(newBalance)) {
                try {
                    const userRef = firebaseDb.ref(`users/${userId}/totalEarning`);
                    await userRef.set(parseFloat(newBalance));
                    showAdminNotification('User balance updated!', 'success');
                    loadUsersList();
                } catch (error) {
                    console.error('Error updating user balance:', error);
                    showAdminNotification('Error updating balance', 'error');
                }
            }
        }
        
        async function banUser(userId) {
            if (confirm('Are you sure you want to ban user ' + userId + '?')) {
                try {
                    const userRef = firebaseDb.ref(`users/${userId}/banned`);
                    await userRef.set(true);
                    showAdminNotification('User banned!', 'success');
                    loadUsersList();
                } catch (error) {
                    console.error('Error banning user:', error);
                    showAdminNotification('Error banning user', 'error');
                }
            }
        }
        
        async function sendNotification() {
            const title = document.getElementById('notificationTitle').value;
            const message = document.getElementById('notificationMessage').value;
            const target = document.getElementById('notificationTarget').value;
            
            if (!title || !message) {
                showAdminNotification('Please fill all fields', 'error');
                return;
            }
            
            try {
                // In a real app, you would send this to a backend service
                // that pushes notifications to users
                console.log('Notification to send:', { title, message, target });
                showAdminNotification('Notification sent to ' + target + ' users!', 'success');
                
                // Clear form
                document.getElementById('notificationTitle').value = '';
                document.getElementById('notificationMessage').value = '';
            } catch (error) {
                console.error('Error sending notification:', error);
                showAdminNotification('Error sending notification', 'error');
            }
        }
        
        function showAdminNotification(message, type) {
            const notification = document.getElementById('adminNotification');
            notification.textContent = message;
            notification.className = 'admin-notification ' + type;
            notification.style.display = 'flex';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // --- ORIGINAL APP FUNCTIONS (unchanged) ---
        function initDB() { 
            return new Promise((resolve) => { 
                try { 
                    const request = indexedDB.open(dbName, 3); 
                    request.onerror = (e) => { console.error("DB Error:", e); resolve(); }; 
                    request.onsuccess = event => { db = event.target.result; resolve(); }; 
                    request.onupgradeneeded = event => { 
                        let db = event.target.result; 
                        if (!db.objectStoreNames.contains('userState')) db.createObjectStore('userState', { keyPath: 'id' }); 
                        if (!db.objectStoreNames.contains('appUsage')) db.createObjectStore('appUsage', { keyPath: 'ip' }); 
                    }; 
                } catch (e) { resolve(); } 
            }); 
        }
        
        function saveState() { 
            if (!db) return; 
            const transaction = db.transaction(['userState'], 'readwrite'); 
            transaction.objectStore('userState').put({ id: 'currentUser', ...state }); 
        }
        
        function loadState() { 
            return new Promise(resolve => { 
                if (!db) { resolve(); return; } 
                const request = db.transaction(['userState'], 'readonly').objectStore('userState').get('currentUser'); 
                request.onsuccess = () => { 
                    if (request.result) { 
                        state = { ...state, ...request.result }; 
                        if (!state.completedBonusTasks) state.completedBonusTasks = []; 
                        if (!state.rewardedReferrals) state.rewardedReferrals = 0; 
                        if(!state.originalUserId) state.originalUserId = null; 
                    } 
                    const today = new Date().toLocaleDateString(); 
                    if (state.lastAdWatchedDate !== today) { 
                        state.adsWatchedToday = 0; 
                        state.lastAdWatchedDate = today; 
                    } 
                    resolve(); 
                }; 
                request.onerror = () => resolve(); 
            }); 
        }
        
        function checkIpInDB(ip) { 
            return new Promise(resolve => { 
                if(!db || !ip) return resolve(false); 
                const request = db.transaction(['appUsage'], 'readonly').objectStore('appUsage').get(ip); 
                request.onsuccess = () => resolve(!!request.result); 
                request.onerror = () => resolve(false); 
            }); 
        }
        
        function saveIpToDB(ip) { 
            if(!db || !ip) return; 
            const transaction = db.transaction(['appUsage'], 'readwrite'); 
            transaction.objectStore('appUsage').put({ ip: ip, timestamp: new Date().toISOString() }); 
        }

        async function getIpAddress() { 
            try { 
                const response = await fetch('https://api.ipify.org?format=json'); 
                const data = await response.json(); 
                return data.ip; 
            } catch (error) { 
                console.error("Could not fetch IP address.", error); 
                return null; 
            } 
        }
        
        function safeTgAction(action, fallback = () => {}) { 
            if (tg && tg.initData) { 
                action(tg); 
            } else { 
                fallback(); 
                console.log("Telegram WebApp is not available or not ready."); 
            } 
        }
        
        function safeTgAlert(message) { 
            safeTgAction(tg => tg.showAlert(message), () => alert(message)); 
        }
        
        function escapeHTML(str) { 
            if (!str) return ''; 
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); 
        }

        function populateWithdrawalMethods() {
            const methodSelect = document.getElementById('method');
            if (!methodSelect) return;
            config.withdrawalMethods.forEach(method => {
                const option = document.createElement('option');
                option.value = method;
                option.textContent = method;
                methodSelect.appendChild(option);
            });
        }

        let cooldownInterval;
        function updateUI() {
            if (state.cooldownUntil && new Date() >= new Date(state.cooldownUntil)) { 
                state.cooldownUntil = null; 
                state.adsWatchedToday = 0; 
                saveState(); 
            }
            allDOMElements.totalEarningEl.textContent = `${state.totalEarning.toFixed(0)} DOGS`;
            allDOMElements.adCountEl.textContent = state.adCount;
            allDOMElements.adsTodayCountEl.textContent = `${state.adsWatchedToday} / ${config.DAILY_AD_LIMIT}`;
           
            clearInterval(cooldownInterval);
            const watchAdButton = allDOMElements.watchAdButton;
            if (state.cooldownUntil && new Date() < new Date(state.cooldownUntil)) {
                watchAdButton.disabled = true;
                const updateTimer = () => {
                    const remaining = new Date(state.cooldownUntil) - new Date();
                    if (remaining <= 0) { 
                        clearInterval(cooldownInterval); 
                        state.cooldownUntil = null; 
                        state.adsWatchedToday = 0; 
                        saveState(); 
                        updateUI(); 
                        safeTgAlert(`Your break is over! Please change your IP address before starting.`); 
                    } 
                    else { 
                        const minutes = Math.floor((remaining / 1000 / 60) % 60); 
                        const seconds = Math.floor((remaining / 1000) % 60); 
                        watchAdButton.querySelector('span').textContent = `Break: ${minutes}m ${seconds}s`; 
                    }
                };
                cooldownInterval = setInterval(updateTimer, 1000); 
                updateTimer();
            } else {
                watchAdButton.disabled = state.adsWatchedToday >= config.DAILY_AD_LIMIT;
                watchAdButton.querySelector('span').textContent = state.adsWatchedToday >= config.DAILY_AD_LIMIT ? 'Take a Break' : 'Watch Ad';
            }
            watchAdButton.classList.toggle('pulsing', !watchAdButton.disabled);
            updateChart();
        }
        
        async function watchAd() {
            if (state.lastUsedIp && !state.cooldownUntil) {
                 const newIp = await getIpAddress();
                 if (newIp === state.lastUsedIp) { safeTgAlert('Unknown Error'); return; } 
                 else { state.lastUsedIp = null; saveState(); }
            }
            allDOMElements.adLoaderOverlay.style.display = 'flex';
          
            const adFunction = window[`show_${config.MONETAG_ZONE_ID}`];
            if (typeof adFunction !== 'function') { 
                safeTgAlert('Ad failed to load. Please try again.'); 
                allDOMElements.adLoaderOverlay.style.display = 'none'; 
                return; 
            }
          
            adFunction().then(() => {
                state.totalEarning += config.AD_REWARD; 
                state.adCount++; 
                state.adsWatchedToday++; 
                state.weeklyActivity[new Date().getDay()]++;
                let alertMessage = `AD watched! You have received 5 DOGS`;
                if (state.adsWatchedToday >= config.DAILY_AD_LIMIT) {
                    const cdDate = new Date(); 
                    cdDate.setMinutes(cdDate.getMinutes() + config.COOLDOWN_MINUTES);
                    state.cooldownUntil = cdDate.toISOString(); 
                    state.lastUsedIp = currentIpAddress;
                    alertMessage = `You have completed your tasks! Please take a ${config.COOLDOWN_MINUTES}-minute break.`;
                }
                saveState(); 
                updateUI();
                safeTgAction(tg => tg.HapticFeedback.notificationOccurred('success'));
                safeTgAlert(alertMessage);
            }).catch(e => { 
                console.error("AD Error:", e); 
                safeTgAlert('Ad could not be completed. Please try again.'); 
            })
            .finally(() => { 
                allDOMElements.adLoaderOverlay.style.display = 'none'; 
            });
        }
        
        async function handleWithdrawal(event) {
            event.preventDefault();
            const { withdrawForm } = allDOMElements;
            const submitButton = document.getElementById('withdraw-submit-button');
            const buttonText = submitButton.querySelector('.button-text');
            const spinner = submitButton.querySelector('.spinner');
            const amount = parseFloat(withdrawForm.elements['withdraw-amount'].value);
            const method = withdrawForm.elements.method.value;
            const accountNumber = withdrawForm.elements['account-number'].value;
            
            if (amount > state.totalEarning) return safeTgAlert('You do not have enough balance');
            if (isNaN(amount) || amount < config.MINIMUM_WITHDRAWAL) return safeTgAlert(`Minimum withdrawal is ${config.MINIMUM_WITHDRAWAL} DOGS`);

            buttonText.style.display = 'none'; 
            spinner.style.display = 'block'; 
            submitButton.disabled = true;
            const user = tg ? tg.initDataUnsafe?.user : { first_name: 'Test', last_name: 'User', username: 'testuser', id: '12345' };
            const message = `<b>üÜï New Withdrawal Request</b>\n\n‚ú¶ <b>Username:</b> @${escapeHTML(user?.username) || 'N/A'}\n‚ú¶ <b>User ID:</b> <code>${user?.id}</code>\n\n‚ú¶ <b>Wallet:</b> <code>${escapeHTML(accountNumber)}</code>\n‚ú¶ <b>Amount:</b> <code>${amount.toFixed(0)}</code><b> $DOGS\n\n‚òÖ Request from @${config.BOT_USERNAME}</b>`;
            try {
                const url = `https://api.telegram.org/bot8557334769:AAFPuE9lkToXrLNiKeymMhUgdOmE5hGc49A/sendMessage`;
                const promises = config.ADMIN_IDS.map(chat_id => fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id, text: message, parse_mode: 'HTML' }) }).then(res => res.json()));
                const results = await Promise.all(promises);
                if (results.some(r => r.ok)) {
                    state.totalEarning -= amount;
                    const pendingUntil = new Date().getTime() + (10 * 60 * 1000);
                    state.withdrawalHistory.unshift({ method, number: accountNumber, amount, date: new Date().toISOString(), status: 'Pending', pendingUntil });
                    saveState(); 
                    updateUI(); 
                    closeModal('withdrawModal'); 
                    withdrawForm.reset();
                    safeTgAlert('‚úÖ Your withdrawal request has been sent');
                    safeTgAction(tg => tg.HapticFeedback.notificationOccurred('success'));
                 } else { throw new Error(JSON.stringify(results)); }
            } catch (error) { 
                console.error("Withdrawal Error:", error); 
                safeTgAlert('Failed to send your request. Please try again later.'); 
            } 
            finally { 
                buttonText.style.display = 'inline'; 
                spinner.style.display = 'none'; 
                submitButton.disabled = false; 
            }
        }
          
        function checkPendingWithdrawals() {
            let changed = false;
            state.withdrawalHistory.forEach(item => {
                if (item.status === 'Pending' && new Date().getTime() > item.pendingUntil) {
                    item.status = 'Success';
                    changed = true;
                }
            });
            if (changed) {
                saveState();
                if (document.getElementById('historyModal').style.display === 'flex') {
                    renderHistory();
                }
            }
        }
        
        function renderHistory() {
            checkPendingWithdrawals();
            const { historyListEl } = allDOMElements;

            if (!state.withdrawalHistory || state.withdrawalHistory.length === 0) {
                historyListEl.innerHTML = '<p class="no-history">No withdrawal history found</p>';
                return;
            }

            historyListEl.innerHTML = state.withdrawalHistory.map(item => `
                <div class="history-item">
                    <div class="history-details">
                        <span class="method-number">${escapeHTML(item.method)}</span>
                        <span class="date">${new Date(item.date).toLocaleString()}</span>
                    </div>
                    <div class="history-amount" style="display:flex;flex-direction:column;align-items:center;">
                        <span style="font-weight:bold;">${item.amount.toFixed(0)} DOGS</span>
                        <div class="history-status ${item.status.toLowerCase()}"
                             style="margin-top:4px;font-size:12px;padding:2px 8px;border-radius:6px;background:#333;color:#fff;text-align:center;width:fit-content;">
                            ${item.status}
                        </div>
                    </div>
                </div>
            `).join('');
        }
      
        function renderBonusTasks() {
            const { bonusTasksListEl } = allDOMElements;
            bonusTasksListEl.innerHTML = '';
            if (config.bonusTasks.length === 0) { 
                bonusTasksListEl.innerHTML = '<p class="no-history">No tasks available now</p>'; 
                return; 
            }
            config.bonusTasks.forEach(task => {
                const isCompleted = state.completedBonusTasks.includes(task.id);
                const item = document.createElement('div');
                item.className = 'bonus-item';
                item.innerHTML = `
                    <div class="details">
                        <span class="title">${escapeHTML(task.title)}</span>
                        <span class="reward"><i class="fa-solid fa-gift"></i> Reward: ${task.reward.toFixed(0)} DOGS</span>
                    </div>
                    <button class="claim-button" ${isCompleted ? 'disabled' : ''}>
                        ${isCompleted ? 'Completed' : 'JOIN'}
                    </button>
                `;
                if (!isCompleted) { 
                    item.querySelector('.claim-button').addEventListener('click', (e) => handleBonusTask(task, e.target)); 
                }
                bonusTasksListEl.appendChild(item);
            });
        }

        function handleBonusTask(task, button) {
            button.disabled = true;
            button.textContent = 'Cheaking...';
            safeTgAction(tg => tg.openLink(task.link));
            setTimeout(() => {
                if (state.completedBonusTasks.includes(task.id)) return;
                state.totalEarning += task.reward;
                state.completedBonusTasks.push(task.id);
                saveState();
                updateUI();
                button.textContent = 'Completed';
                safeTgAction(tg => tg.HapticFeedback.notificationOccurred('success'));
               
                if (state.referrerId) {
                    const refBonus = task.reward * 0.2;
                    const refKey = 'user_' + state.referrerId;
                    let refData = JSON.parse(localStorage.getItem(refKey)) || { totalEarning: 0 };
                    refData.totalEarning = (refData.totalEarning || 0) + refBonus;
                    localStorage.setItem(refKey, JSON.stringify(refData));
                }
            }, task.duration * 1000);
        }
      
        function showModal(modalId, buttonEl) {
            document.querySelectorAll('.nav-button.active').forEach(btn => btn.classList.remove('active'));
            if (buttonEl) buttonEl.classList.add('active');
            if (modalId === 'historyModal') renderHistory();
            if (modalId === 'bonusTasksModal') renderBonusTasks();
            const modal = document.getElementById(modalId);
            if(modal) modal.style.display = 'flex';
        }
        
        function closeModal(modalId) { 
            const modal = document.getElementById(modalId); 
            if(modal) modal.style.display = 'none'; 
            if (modalId !== 'welcomeModal') { 
                document.querySelectorAll('.nav-button.active').forEach(btn => btn.classList.remove('active')); 
            } 
        }
        
        let myChart; 
        function updateChart() { 
            const ctx = document.getElementById('activityChart').getContext('2d'); 
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark'; 
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'; 
            const fontColor = isDark ? '#F5F5F7' : '#1D1D1F'; 
            if (myChart) myChart.destroy(); 
            myChart = new Chart(ctx, { 
                type: 'bar', 
                data: { 
                    labels: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'], 
                    datasets: [{ 
                        label: 'Ads Watched', 
                        data: state.weeklyActivity, 
                        backgroundColor: 'rgba(var(--primary-color-rgb), 0.2)', 
                        borderColor: 'rgb(var(--primary-color-rgb))', 
                        borderWidth: 2, 
                        borderRadius: 8, 
                        hoverBackgroundColor: 'rgba(var(--primary-color-rgb), 0.4)' 
                    }] 
                }, 
                options: { 
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            ticks: { stepSize: 5, color: fontColor }, 
                            grid: { color: gridColor } 
                        }, 
                        x: { 
                            ticks: { color: fontColor }, 
                            grid: { color: gridColor } 
                        } 
                    }, 
                    plugins: { legend: { display: false } }, 
                    responsive: true, 
                    maintainAspectRatio: false 
                } 
            }); 
        }
        
        async function handleReferral() {
            if (!firebaseDb || !tg || !tg.initDataUnsafe) return;
            const startParam = tg.initDataUnsafe.start_param;
            const currentUser = tg.initDataUnsafe.user;
            if (!startParam || isNaN(parseInt(startParam)) || parseInt(startParam) === currentUser.id) return;
            
            const referrerId = parseInt(startParam);
            const referredUserRef = firebaseDb.ref(`users/${currentUser.id}/referred_by`);
            const snapshot = await referredUserRef.once('value');
            if (snapshot.exists()) return;

            await referredUserRef.set(referrerId);
            const referrerRef = firebaseDb.ref(`users/${referrerId}/referrals`);
            await referrerRef.transaction((currentCount) => (currentCount || 0) + 1);
        }

        async function processReferralRewards() {
            if (!firebaseDb || !tg || !tg.initDataUnsafe) return;
            const userId = tg.initDataUnsafe.user.id;
            const referralsRef = firebaseDb.ref(`users/${userId}/referrals`);
            const snapshot = await referralsRef.once('value');
            const totalReferrals = snapshot.val() || 0;

            const rewardedReferrals = state.rewardedReferrals || 0;
            const newReferrals = totalReferrals - rewardedReferrals;

            if (newReferrals > 0) {
                const bonus = newReferrals * config.REFERRAL_REWARD;
                state.totalEarning += bonus;
                state.rewardedReferrals = totalReferrals;
                saveState();
            }
        }

        async function listenForReferralCount() {
            if (!firebaseDb || !tg || !tg.initDataUnsafe) return;
            const userId = tg.initDataUnsafe.user.id;
            const referralsRef = firebaseDb.ref(`users/${userId}/referrals`);
            referralsRef.on('value', (snapshot) => { 
                allDOMElements.referralCountEl.textContent = snapshot.val() || 0; 
            });
        }

        function loadMonetagSDK() {
            const script = document.createElement('script');
            script.src = `//libtl.com/sdk.js`;
            script.setAttribute('data-zone', config.MONETAG_ZONE_ID);
            script.setAttribute('data-sdk', `show_${config.MONETAG_ZONE_ID}`);
            script.async = true;
            document.body.appendChild(script);
        }

        function initFirebase() {
            try {
                firebaseApp = firebase.initializeApp(config.firebase);
                firebaseDb = firebase.database();
                firebase.auth().signInAnonymously()
                    .then(() => {
                        console.log("‚úÖ Signed in anonymously to Firebase.");
                    })
                    .catch((error) => {
                        console.error("‚ùå Firebase Anonymous Auth error:", error);
                    });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
            }
        }

        // ‚úÖ Global balance updater that syncs with state + IndexedDB + UI
        window.updateBalance = function(amount) {
            const el = document.getElementById("total-earning");
            let add = parseFloat(amount);
            if (isNaN(add)) return;

            // Update internal app state if available
            if (typeof state !== "undefined") {
                state.totalEarning = (parseFloat(state.totalEarning) || 0) + add;
                if (typeof saveState === "function") saveState();
            }

            // Update UI balance
            let current = parseFloat(el.textContent) || 0;
            let newVal = current + add;
            el.textContent = newVal.toFixed(0) + " DOGS";

            // Save also in localStorage as backup
            localStorage.setItem("userBalance", newVal);

            console.log(`You have received ${add} DOGS!`);
        };

        const promoCodes = {
            "BHVJCCBB": 50,
            "ARFJBBLL": 50,
            "PBJAVSVG": 50,
        };

        // ‚úÖ Redeem promo code function
        function redeemPromoCode(code) {
            const msg = document.getElementById("promo-message");
            const normalized = code.trim().toUpperCase();
            const usedCodes = JSON.parse(localStorage.getItem("usedPromoCodes") || "[]");

            if (usedCodes.includes(normalized)) {
                msg.style.color = "#ff5555";
                msg.textContent = "You have already used this code";
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }

            if (promoCodes[normalized]) {
                const amount = promoCodes[normalized];
                updateBalance(amount);
                usedCodes.push(normalized);
                localStorage.setItem("usedPromoCodes", JSON.stringify(usedCodes));
                msg.style.color = "#4CAF50";
                msg.textContent = `${amount} DOGS added to your balance`;
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                msg.style.color = "#ff5555";
                msg.textContent = "Invalid or expired code";
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        function getReferralLink() { 
            const userId = tg ? tg.initDataUnsafe?.user?.id : 'testuser'; 
            return `https://t.me/${config.BOT_USERNAME}?startapp=${userId}`; 
        }
        
        function copyReferralLink() {
            const link = getReferralLink();
            if (!link) return tg.showAlert('‚ùå Unable to generate referral link.');
            navigator.clipboard.writeText(link).then(() => {
                tg.HapticFeedback.notificationOccurred('success');
            }).catch(() => {
                tg.HapticFeedback.notificationOccurred('error');
            });
        }

        function shareReferralLink() {
            const link = getReferralLink();
            if (!link) return tg.showAlert('‚ùå Unable to generate referral link.');
            const text = `üê∂ Earn free $DOGS by watching ads and complete simple tasks!\n\nü¶¥ DOGS Boss is the best`;
            safeTgAction(tg => tg.openTelegramLink(
                `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`
            ));
        }

        async function initApp() {
            let appReady = false;
            let preloaderAnimationDone = false;
            
            const tryFinishLoading = () => {
                if(appReady && preloaderAnimationDone) {
                    allDOMElements.preloader.style.opacity = '0';
                    allDOMElements.preloaderFooter.style.opacity = '0';
                    setTimeout(() => {
                        allDOMElements.preloader.style.display = 'none';
                        allDOMElements.preloaderFooter.style.display = 'none';
                        allDOMElements.container.style.display = 'block';
                    }, 500);
                }
            };

            let percentage = 0;
            const interval = setInterval(() => {
                percentage += Math.floor(Math.random() * 5) + 1;
                if (percentage > 100) percentage = 100;
                allDOMElements.preloaderPercentage.textContent = `${percentage}%`;
                if (percentage >= 100) {
                    clearInterval(interval);
                    preloaderAnimationDone = true;
                    tryFinishLoading();
                }
            }, 60);

            try {
                loadMonetagSDK(); 
                initFirebase();
                populateWithdrawalMethods();

                allDOMElements.welcomeTitle.textContent = config.welcomeNotice.title;
                allDOMElements.welcomeMessage.textContent = config.welcomeNotice.message;

                await initDB(); 
                await loadState();

                const currentUserId = tg ? tg.initDataUnsafe?.user?.id : null;
                if (currentUserId) {
                    if (!state.originalUserId) {
                        state.originalUserId = currentUserId;
                        await saveState();
                    } else if (state.originalUserId !== currentUserId) {
                        document.getElementById('multiAccountModal').style.display = 'flex';
                        return;
                    }
                }

                currentIpAddress = await getIpAddress();
                const isMultiAccountIP = await checkIpInDB(currentIpAddress);
                const isNewUser = !(localStorage.getItem('userIdentified'));

                if (isMultiAccountIP && isNewUser) { 
                    document.getElementById('multiAccountModal').style.display = 'flex'; 
                    return; 
                }
                if (!isMultiAccountIP) { 
                    saveIpToDB(currentIpAddress); 
                    localStorage.setItem('userIdentified', 'true'); 
                }
                
                await handleReferral();
                await processReferralRewards();
                await listenForReferralCount();
                
                setInterval(checkPendingWithdrawals, 60 * 1000);

                const user = tg ? tg.initDataUnsafe?.user : { first_name: 'User', photo_url: null };
                if (user?.first_name) {
                    allDOMElements.greetingEl.textContent = `${escapeHTML(user.first_name)}`;
                    if (user.photo_url) { 
                        allDOMElements.profilePicEl.innerHTML = `<img src="${user.photo_url}" alt="P">`; 
                    }
                    else { 
                        allDOMElements.profilePicEl.innerHTML = `<span>${escapeHTML(user.first_name.charAt(0))}</span>`; 
                    }
                }
                
                updateUI();
                
                // Attach event listeners
                allDOMElements.watchAdButton.addEventListener('click', watchAd);
                allDOMElements.withdrawForm.addEventListener('submit', handleWithdrawal);
                allDOMElements.joinChannelButton.addEventListener('click', () => safeTgAction(tg => tg.openTelegramLink(config.TELEGRAM_CHANNEL_LINK)));
                allDOMElements.adminContactButton?.addEventListener('click', () => safeTgAction(tg => tg.openLink(config.ADMIN_SUPPORT_LINK, {try_instant_view: true})));
                allDOMElements.copyLinkButton.addEventListener('click', copyReferralLink);
                allDOMElements.shareLinkButton.addEventListener('click', shareReferralLink);
                
                // Promo code button
                document.getElementById('promo-btn').addEventListener('click', () => {
                    const code = document.getElementById('promo-input').value;
                    redeemPromoCode(code);
                });

                window.onclick = (event) => { 
                    if (event.target.classList.contains('modal')) 
                        closeModal(event.target.id); 
                }

                safeTgAction(tg => {
                    tg.ready(); 
                    tg.expand();
                    tg.onEvent('themeChanged', () => { 
                        document.documentElement.setAttribute('data-theme', tg.colorScheme); 
                        updateChart(); 
                    });
                });

                if (!sessionStorage.getItem('alreadyVisited')) { 
                    showModal('welcomeModal'); 
                    sessionStorage.setItem('alreadyVisited', 'true'); 
                }

                // Load saved balance if exists
                const saved = parseFloat(localStorage.getItem("userBalance")) || 0;
                if (saved > 0 && document.getElementById("total-earning")) {
                    document.getElementById("total-earning").textContent = saved.toFixed(0) + " DOGS";
                }
            } catch (error) { 
                console.error("Initialization failed:", error); 
            } 
            finally {
                appReady = true;
                if (percentage < 100) {
                    clearInterval(interval);
                    allDOMElements.preloaderPercentage.textContent = '100%';
                    preloaderAnimationDone = true;
                }
                tryFinishLoading();
            }
        }
        
        window.addEventListener('load', initApp);
    </script>
</body>
</html>

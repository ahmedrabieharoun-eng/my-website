<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TON Rewards</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #050816;
            color: #fff;
            display: flex;
            justify-content: center;
        }
        .app {
            width: 100%;
            max-width: 480px;
            min-height: 100vh;
            padding: 16px;
            box-sizing: border-box;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .small {
            font-size: 13px;
            opacity: 0.7;
        }
        .balance {
            font-size: 28px;
            font-weight: 700;
            margin: 10px 0;
        }
        .btn {
            width: 100%;
            padding: 12px;
            border-radius: 999px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }
        .btn-primary {
            background: #16a34a;
            color: #fff;
        }
        .btn-secondary {
            background: #1f2933;
            color: #fff;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .field {
            margin-top: 8px;
        }
        .field label {
            display: block;
            font-size: 13px;
            margin-bottom: 4px;
        }
        .field input, .field select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(15,23,42,0.8);
            color: #fff;
            outline: none;
            box-sizing: border-box;
        }
        .status {
            font-size: 13px;
            margin-top: 6px;
            min-height: 18px;
        }
        .status.ok { color: #22c55e; }
        .status.err { color: #f97373; }
        .loader {
            text-align: center;
            padding: 40px 0;
            font-size: 14px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
<div class="app">
    <div id="loader" class="loader">
        Loading TON Rewards...
    </div>

    <div id="content" style="display:none;">
        <!-- User info & balance -->
        <div class="card">
            <div class="title">Welcome, <span id="user-name">User</span> ðŸ‘‹</div>
            <div class="small">Your current balance:</div>
            <div class="balance">
                <span id="user-balance">0</span> <span id="currency-symbol">TON</span>
            </div>
            <div class="small">
                Total earned: <span id="user-total-earned">0</span>
            </div>
        </div>

        <!-- Watch Ad -->
        <div class="card">
            <div class="title">Earn by watching ads ðŸ“º</div>
            <div class="small">
                Click the button below to watch an ad and earn rewards.
            </div>
            <button id="watch-ad-btn" class="btn btn-primary">
                Watch Ad
            </button>
            <div id="ad-status" class="status"></div>
        </div>

        <!-- Withdraw -->
        <div class="card">
            <div class="title">Withdraw ðŸ’¸</div>
            <div class="small">
                Fill your method and address then request withdraw.
            </div>

            <div class="field">
                <label for="withdraw-method">Method</label>
                <select id="withdraw-method">
                    <option value="TON Wallet">TON Wallet</option>
                    <option value="USDT">USDT</option>
                </select>
            </div>

            <div class="field">
                <label for="withdraw-account">Address / Account</label>
                <input id="withdraw-account" type="text" placeholder="Your wallet address">
            </div>

            <div class="field">
                <label for="withdraw-amount">Amount</label>
                <input id="withdraw-amount" type="number" min="0" step="0.000001" placeholder="0.1">
            </div>

            <button id="withdraw-btn" class="btn btn-secondary">
                Request Withdraw
            </button>
            <div id="withdraw-status" class="status"></div>
        </div>
    </div>
</div>

<script>
    // ðŸ”´ ØºÙŠÙ‘Ø± Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ù„Ù„ÙŠÙ†Ùƒ Ø¨ØªØ§Ø¹ Railway Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠÙƒ
const API_BASE = "https://ton-backend-production.up.railway.app";

    const tg = window.Telegram.WebApp || {};
    let tgUser = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;

    // ÙˆØ¶Ø¹ ØªØ·ÙˆÙŠØ± (Ù„Ùˆ ÙØªØ­Øª Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø´ Ù…Ù† ØªÙ„ÙŠØ¬Ø±Ø§Ù…)
    if (!tgUser) {
        tgUser = {
            id: 123456789,
            first_name: "Dev",
            last_name: "User",
            username: "devuser"
        };
        console.log("âš ï¸ Running in DEV mode, fake user:", tgUser);
    }

    async function api(path, options = {}) {
        const res = await fetch(API_BASE + path, {
            headers: { "Content-Type": "application/json" },
            ...options
        });
        if (!res.ok) {
            const text = await res.text();
            throw new Error("API error: " + text);
        }
        return res.json();
    }

    let appConfig = {
        currencySymbol: "TON"
    };
    let userState = {
        balance: 0,
        totalEarned: 0
    };

    function updateUI() {
        document.getElementById("user-name").textContent =
            (tgUser.first_name || "") + (tgUser.last_name ? (" " + tgUser.last_name) : "");

        document.getElementById("user-balance").textContent =
            Number(userState.balance || 0).toFixed(6);

        document.getElementById("user-total-earned").textContent =
            Number(userState.totalEarned || 0).toFixed(6);

        document.getElementById("currency-symbol").textContent =
            appConfig.currencySymbol || "TON";
    }

    async function initApp() {
        try {
            const loader = document.getElementById("loader");
            const content = document.getElementById("content");

            loader.textContent = "Loading configuration...";

            // 1) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯
            const config = await api("/api/config");
            appConfig = { ...appConfig, ...config };

            loader.textContent = "Loading user data...";

            // 2) Ø¥Ù†Ø´Ø§Ø¡ / ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯
            const user = await api("/api/user/init", {
                method: "POST",
                body: JSON.stringify({
                    tgUser,
                    referralParam: null,
                    isSubscribedToAllChannels: true   // Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø§Ø¹ØªØ¨Ø±Ù‡ Ù…Ø´ØªØ±Ùƒ
                })
            });

            userState = {
                balance: Number(user.balance || 0),
                totalEarned: Number(user.total_earned || 0)
            };

            // 3) Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            loader.style.display = "none";
            content.style.display = "block";
            updateUI();

            console.log("âœ… App initialized", { config: appConfig, user: user });

        } catch (err) {
            console.error(err);
            const loader = document.getElementById("loader");
            loader.textContent = "Failed to init app: " + err.message;
        }
    }

    async function handleWatchAd() {
        const btn = document.getElementById("watch-ad-btn");
        const status = document.getElementById("ad-status");

        try {
            btn.disabled = true;
            btn.textContent = "Loading ad...";
            status.textContent = "";

            // Ù‡Ù†Ø§ ÙÙŠ Ù†Ø³Ø®ØªÙƒ Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù‡ØªØ´ØºÙ‘Ù„ Ø´Ø¨ÙƒØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
            // Ø¯Ù„ÙˆÙ‚ØªÙŠ Ù‡Ù†Ø¹ØªØ¨Ø± Ø¥Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§ØªØ´Ø§Ù ÙÙˆØ±Ù‹Ø§ Ù„Ù„ØªØ¬Ø±Ø¨Ø©
            await new Promise(r => setTimeout(r, 5000)); // 5 Ø«ÙˆØ§Ù†ÙŠ

            // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù„Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ø¹Ø´Ø§Ù† ÙŠØ²ÙŠØ¯ Ø§Ù„Ø±ØµÙŠØ¯
            const result = await api("/api/ad/watch", {
                method: "POST",
                body: JSON.stringify({ userId: tgUser.id })
            });

            userState.balance = Number(result.user.balance || 0);
            userState.totalEarned = Number(result.user.total_earned || 0);
            updateUI();

            status.textContent = `+${result.earned} ${appConfig.currencySymbol || "TON"} added!`;
            status.className = "status ok";

            btn.textContent = "Watch Ad";
            btn.disabled = false;

        } catch (err) {
            console.error(err);
            status.textContent = err.message || "Failed to watch ad";
            status.className = "status err";
            btn.textContent = "Watch Ad";
            btn.disabled = false;
        }
    }

    async function handleWithdraw() {
        const methodEl = document.getElementById("withdraw-method");
        const accountEl = document.getElementById("withdraw-account");
        const amountEl = document.getElementById("withdraw-amount");
        const status = document.getElementById("withdraw-status");
        const btn = document.getElementById("withdraw-btn");

        const method = methodEl.value;
        const account = accountEl.value.trim();
        const amount = parseFloat(amountEl.value);

        if (!account) {
            status.textContent = "Please enter your wallet / account.";
            status.className = "status err";
            return;
        }
        if (isNaN(amount) || amount <= 0) {
            status.textContent = "Please enter a valid amount.";
            status.className = "status err";
            return;
        }

        try {
            btn.disabled = true;
            btn.textContent = "Sending request...";
            status.textContent = "";

            const resp = await api("/api/withdraw", {
                method: "POST",
                body: JSON.stringify({
                    userId: tgUser.id,
                    method,
                    account,
                    amount
                })
            });

            if (resp.ok) {
                status.textContent = "Withdraw request sent successfully âœ…";
                status.className = "status ok";

                // Ù†Ø­Ø¯Ù‘Ø« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø­Ø¨
                const user = await api("/api/user/init", {
                    method: "POST",
                    body: JSON.stringify({
                        tgUser,
                        referralParam: null,
                        isSubscribedToAllChannels: true
                    })
                });

                userState.balance = Number(user.balance || 0);
                userState.totalEarned = Number(user.total_earned || 0);
                updateUI();
            } else {
                status.textContent = resp.error || "Failed to send withdraw request.";
                status.className = "status err";
            }

        } catch (err) {
            console.error(err);
            status.textContent = err.message || "Error in withdraw request.";
            status.className = "status err";
        } finally {
            btn.disabled = false;
            btn.textContent = "Request Withdraw";
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        document.getElementById("watch-ad-btn").addEventListener("click", handleWatchAd);
        document.getElementById("withdraw-btn").addEventListener("click", handleWithdraw);

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        initApp();
    });
</script>
</body>
</html>

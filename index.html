<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TON Rewards</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #050816;
            color: #fff;
            display: flex;
            justify-content: center;
        }
        .app {
            width: 100%;
            max-width: 480px;
            min-height: 100vh;
            padding: 16px;
            box-sizing: border-box;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .small {
            font-size: 13px;
            opacity: 0.7;
        }
        .balance {
            font-size: 28px;
            font-weight: 700;
            margin: 10px 0;
        }
        .btn {
            width: 100%;
            padding: 12px;
            border-radius: 999px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }
        .btn-primary {
            background: #16a34a;
            color: #fff;
        }
        .btn-secondary {
            background: #1f2933;
            color: #fff;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .field {
            margin-top: 8px;
        }
        .field label {
            display: block;
            font-size: 13px;
            margin-bottom: 4px;
        }
        .field input, .field select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(15,23,42,0.8);
            color: #fff;
            outline: none;
            box-sizing: border-box;
        }
        .status {
            font-size: 13px;
            margin-top: 6px;
            min-height: 18px;
        }
        .status.ok { color: #22c55e; }
        .status.err { color: #f97373; }
        .loader {
            text-align: center;
            padding: 40px 0;
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Ø¥Ø¹Ù„Ø§Ù† styles */
        .ad-container {
            margin: 20px 0;
            text-align: center;
        }
        .ad-placeholder {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .ad-timer {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .ad-progress {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .ad-progress-bar {
            height: 100%;
            background: #16a34a;
            width: 0%;
            transition: width 0.3s;
        }
        .ad-skip-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* ØªÙ„Ù…ÙŠØ­Ø§Øª Ø§Ù„Ø£Ø¯ÙˆØ§Øª */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
<div class="app">
    <div id="loader" class="loader">
        Loading TON Rewards...
    </div>

    <div id="content" style="display:none;">
        <!-- User info & balance -->
        <div class="card">
            <div class="title">Welcome, <span id="user-name">User</span> ğŸ‘‹</div>
            <div class="small">Your current balance:</div>
            <div class="balance">
                <span id="user-balance">0</span> <span id="currency-symbol">TON</span>
            </div>
            <div class="small">
                Total earned: <span id="user-total-earned">0</span> TON
            </div>
            <div class="small">
                Today's ads: <span id="daily-ads">0</span>/<span id="daily-limit">0</span>
            </div>
        </div>

        <!-- Watch Ad -->
        <div class="card">
            <div class="title">Earn by watching ads ğŸ“º</div>
            <div class="small">
                Click the button below to watch an ad and earn rewards.
                <span class="tooltip">â„¹ï¸
                    <span class="tooltiptext">Watch the ad for at least 5 seconds to earn rewards. Daily limit applies.</span>
                </span>
            </div>
            <button id="watch-ad-btn" class="btn btn-primary">
                Watch Ad +<span id="ad-reward">0.0001</span> TON
            </button>
            
            <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† -->
            <div id="ad-container" class="ad-container" style="display: none;">
                <div class="ad-placeholder">
                    <div class="small">ğŸ¥ Ad is playing...</div>
                    <div class="ad-timer" id="ad-timer">15</div>
                    <div class="ad-progress">
                        <div class="ad-progress-bar" id="ad-progress-bar"></div>
                    </div>
                    <button class="ad-skip-btn" id="ad-skip-btn" style="display: none;">Skip Ad</button>
                </div>
            </div>
            
            <div id="ad-status" class="status"></div>
        </div>

        <!-- Referral Section -->
        <div class="card">
            <div class="title">Refer & Earn ğŸ‘¥</div>
            <div class="small">
                Invite friends and earn bonus TON for each referral!
            </div>
            <div class="field">
                <label for="referral-link">Your Referral Link:</label>
                <input id="referral-link" type="text" readonly placeholder="Generate your referral link">
            </div>
            <button id="copy-referral-btn" class="btn btn-secondary">
                Copy Referral Link
            </button>
            <div class="small" style="margin-top: 8px;">
                Your referrals: <span id="referral-count">0</span> users
            </div>
            <div id="referral-status" class="status"></div>
        </div>

        <!-- Tasks Section -->
        <div class="card">
            <div class="title">Bonus Tasks ğŸ¯</div>
            <div class="small">
                Complete these tasks to earn extra TON rewards.
            </div>
            
            <div id="tasks-container">
                <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ø§Ù… Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
        </div>

        <!-- Withdraw -->
        <div class="card">
            <div class="title">Withdraw ğŸ’¸</div>
            <div class="small">
                Fill your method and address then request withdraw.
            </div>

            <div class="field">
                <label for="withdraw-method">Method</label>
                <select id="withdraw-method">
                    <option value="TON Wallet">TON Wallet</option>
                    <option value="USDT">USDT</option>
                </select>
            </div>

            <div class="field">
                <label for="withdraw-account">Address / Account</label>
                <input id="withdraw-account" type="text" placeholder="Your wallet address">
            </div>

            <div class="field">
                <label for="withdraw-amount">Amount (TON)</label>
                <input id="withdraw-amount" type="number" min="0" step="0.000001" placeholder="0.1">
            </div>

            <button id="withdraw-btn" class="btn btn-secondary">
                Request Withdraw
            </button>
            <div id="withdraw-status" class="status"></div>
        </div>

        <!-- Leaderboard -->
        <div class="card">
            <div class="title">Leaderboard ğŸ†</div>
            <div class="small">
                Top earners and referrers in the community.
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button id="top-earners-btn" class="btn" style="flex: 1; background: #1e40af;">Top Earners</button>
                <button id="top-referrers-btn" class="btn" style="flex: 1; background: #7c3aed;">Top Referrers</button>
            </div>
            
            <div id="leaderboard-container">
                <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„ÙˆØ§Ø¦Ø­ Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
        </div>
    </div>
</div>

<script>
    // ğŸ”´ ØºÙŠÙ‘Ø± Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ù„Ù„ÙŠÙ†Ùƒ Ø¨ØªØ§Ø¹ Railway Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠÙƒ
    const API_BASE = "https://ton-backend-production-83d3.up.railway.app";

    const tg = window.Telegram.WebApp || {};
    let tgUser = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;

    // ÙˆØ¶Ø¹ ØªØ·ÙˆÙŠØ± (Ù„Ùˆ ÙØªØ­Øª Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø´ Ù…Ù† ØªÙ„ÙŠØ¬Ø±Ø§Ù…)
    if (!tgUser) {
        tgUser = {
            id: 123456789,
            first_name: "Dev",
            last_name: "User",
            username: "devuser",
            photo_url: "https://via.placeholder.com/80"
        };
        console.log("âš ï¸ Running in DEV mode, fake user:", tgUser);
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù€ API
    async function api(path, options = {}) {
        try {
            const res = await fetch(API_BASE + path, {
                headers: { 
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                ...options
            });
            
            if (!res.ok) {
                const errorText = await res.text();
                console.error(`API Error ${res.status}:`, errorText);
                throw new Error(`API error: ${errorText}`);
            }
            
            return await res.json();
        } catch (error) {
            console.error('Network error:', error);
            throw new Error('Network error: ' + error.message);
        }
    }

    async function loadAppConfig() {
        return await api('/api/config');
    }

    async function initializeUser(tgUser, referralParam, isSubscribed = true) {
        return await api('/api/user/init', {
            method: 'POST',
            body: JSON.stringify({
                tgUser,
                referralParam,
                isSubscribedToAllChannels: isSubscribed
            })
        });
    }

    async function watchAd(userId, tgUser, adId) {
        return await api('/api/ad/watch', {
            method: 'POST',
            body: JSON.stringify({
                userId,
                tgUser,
                adId,
                platform: 'telegram'
            })
        });
    }

    async function requestWithdraw(userId, method, account, amount) {
        return await api('/api/withdraw', {
            method: 'POST',
            body: JSON.stringify({
                userId,
                method,
                account,
                amount
            })
        });
    }

    async function loadUserEarnings(userId, days = 7) {
        return await api(`/api/user/earnings/${userId}?days=${days}`);
    }

    async function loadLeaderboard(type = 'earning', limit = 10) {
        return await api(`/api/leaderboard/${type}?limit=${limit}`);
    }

    async function completeTask(userId, taskId) {
        return await api('/api/user/tasks', {
            method: 'POST',
            body: JSON.stringify({
                userId,
                taskId
            })
        });
    }

    // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    let appConfig = {
        currencySymbol: "TON",
        adValue: 0.0001,
        dailyAdLimit: 50
    };
    
    let userState = {
        balance: 0,
        totalEarned: 0,
        daily_ad_count: 0,
        referrals: 0,
        lifetime_ad_count: 0
    };

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
    let adTimer = null;
    let adSeconds = 15;
    let currentAdSeconds = 0;
    let earningWalletBalance = 0;

    function updateUI() {
        document.getElementById("user-name").textContent =
            (tgUser.first_name || "") + (tgUser.last_name ? (" " + tgUser.last_name) : "");

        document.getElementById("user-balance").textContent =
            Number(userState.balance || 0).toFixed(6);

        document.getElementById("user-total-earned").textContent =
            Number(userState.total_earned || 0).toFixed(6);

        document.getElementById("daily-ads").textContent = userState.daily_ad_count || 0;
        document.getElementById("daily-limit").textContent = appConfig.dailyAdLimit || 50;
        document.getElementById("referral-count").textContent = userState.referrals || 0;
        document.getElementById("ad-reward").textContent = (appConfig.adValue || 0.0001).toFixed(4);
        
        // ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
        const referralLink = `https://t.me/${appConfig.botUsername || 'Aborabie777_bot'}?start=${tgUser.id}`;
        document.getElementById('referral-link').value = referralLink;

        document.getElementById("currency-symbol").textContent =
            appConfig.currencySymbol || "TON";
    }

    async function initApp() {
        try {
            const loader = document.getElementById("loader");
            const content = document.getElementById("content");

            loader.textContent = "Loading configuration...";

            // 1) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯
            const config = await loadAppConfig();
            appConfig = { ...appConfig, ...config };
            console.log("ğŸ“‹ App config loaded:", appConfig);

            loader.textContent = "Loading user data...";

            // 2) Ø¥Ù†Ø´Ø§Ø¡ / ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯
            const userResponse = await initializeUser(tgUser, null, true);

            if (userResponse.ok && userResponse.user) {
                userState = {
                    balance: Number(userResponse.user.balance || 0),
                    total_earned: Number(userResponse.user.total_earned || 0),
                    daily_ad_count: userResponse.user.daily_ad_count || 0,
                    referrals: userResponse.user.referrals || 0,
                    lifetime_ad_count: userResponse.user.lifetime_ad_count || 0
                };
                console.log("ğŸ‘¤ User data loaded:", userState);
            } else {
                userState = {
                    balance: 0,
                    total_earned: 0,
                    daily_ad_count: 0,
                    referrals: 0,
                    lifetime_ad_count: 0
                };
            }

            // 3) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„Ù„ÙˆØ§Ø¦Ø­
            loader.textContent = "Loading tasks and leaderboard...";
            await loadTasks();
            await loadLeaderboardData();

            // 4) Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            loader.style.display = "none";
            content.style.display = "block";
            updateUI();

            console.log("âœ… App initialized successfully");

        } catch (err) {
            console.error("Initialization error:", err);
            const loader = document.getElementById("loader");
            loader.textContent = "Failed to init app: " + err.message;
            loader.style.color = "#f97373";
        }
    }

    async function loadTasks() {
        try {
            const tasksContainer = document.getElementById('tasks-container');
            const tasks = appConfig.tasks || {};
            
            let tasksHTML = '';
            for (const [taskId, task] of Object.entries(tasks)) {
                const isCompleted = userState.completed_tasks && userState.completed_tasks[taskId];
                
                tasksHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin: 8px 0;">
                        <div>
                            <div style="font-weight: 600;">${task.name}</div>
                            <div style="font-size: 12px; opacity: 0.7;">+${task.reward} TON</div>
                        </div>
                        <button class="task-btn" data-task-id="${taskId}" data-task-url="${task.url}" 
                                style="padding: 8px 16px; background: ${isCompleted ? '#6b7280' : '#16a34a'}; color: white; border: none; border-radius: 20px; cursor: ${isCompleted ? 'not-allowed' : 'pointer'};"
                                ${isCompleted ? 'disabled' : ''}>
                            ${isCompleted ? 'âœ… Completed' : 'Claim Bonus'}
                        </button>
                    </div>
                `;
            }
            
            tasksContainer.innerHTML = tasksHTML || '<div style="text-align: center; opacity: 0.7;">No tasks available at the moment.</div>';
            
            // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.task-btn').forEach(btn => {
                btn.addEventListener('click', handleTaskClaim);
            });
            
        } catch (error) {
            console.error('Error loading tasks:', error);
        }
    }

    async function loadLeaderboardData(type = 'earning') {
        try {
            const leaderboardContainer = document.getElementById('leaderboard-container');
            const data = await loadLeaderboard(type, 5);
            
            if (data.ok && data.leaderboard) {
                let leaderboardHTML = '';
                data.leaderboard.forEach((user, index) => {
                    const value = type === 'earning' ? 
                        `${Number(user.total_earned || 0).toFixed(4)} TON` : 
                        `${user.referrals || 0} users`;
                    
                    leaderboardHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; margin: 5px 0;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-weight: bold; color: #f59e0b;">#${index + 1}</span>
                                <span>${user.first_name || 'User'}</span>
                            </div>
                            <span style="font-weight: 600;">${value}</span>
                        </div>
                    `;
                });
                
                leaderboardContainer.innerHTML = leaderboardHTML;
            } else {
                leaderboardContainer.innerHTML = '<div style="text-align: center; opacity: 0.7;">No data available.</div>';
            }
            
        } catch (error) {
            console.error('Error loading leaderboard:', error);
            document.getElementById('leaderboard-container').innerHTML = '<div style="text-align: center; opacity: 0.7;">Failed to load leaderboard.</div>';
        }
    }

    function showAd() {
        const btn = document.getElementById("watch-ad-btn");
        const adContainer = document.getElementById("ad-container");
        const adTimerElement = document.getElementById("ad-timer");
        const adProgressBar = document.getElementById("ad-progress-bar");
        const adSkipBtn = document.getElementById("ad-skip-btn");

        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
        btn.style.display = "none";
        adContainer.style.display = "block";
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
        currentAdSeconds = 0;
        adTimerElement.textContent = adSeconds;
        adProgressBar.style.width = "0%";
        adSkipBtn.style.display = "none";

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª
        adTimer = setInterval(() => {
            currentAdSeconds++;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ù‚Øª ÙˆØ§Ù„Ø´Ø±ÙŠØ·
            const remaining = adSeconds - currentAdSeconds;
            adTimerElement.textContent = remaining;
            
            const progress = (currentAdSeconds / adSeconds) * 100;
            adProgressBar.style.width = progress + "%";

            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØªØ®Ø·ÙŠ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
            if (currentAdSeconds === 5) {
                adSkipBtn.style.display = "block";
            }

            // Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
            if (currentAdSeconds >= adSeconds) {
                clearInterval(adTimer);
                finishAdWatching();
            }
        }, 1000);
    }

    function hideAd() {
        const btn = document.getElementById("watch-ad-btn");
        const adContainer = document.getElementById("ad-container");
        
        clearInterval(adTimer);
        btn.style.display = "block";
        adContainer.style.display = "none";
    }

    async function finishAdWatching() {
        const status = document.getElementById("ad-status");
        
        try {
            // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù„Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
            const result = await watchAd(tgUser.id.toString(), tgUser, `ad_${Date.now()}`);

            if (result.ok) {
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                userState.balance = Number(result.user.balance);
                userState.total_earned = Number(result.user.total_earned);
                userState.daily_ad_count = result.user.daily_ad_count;
                userState.lifetime_ad_count = result.user.lifetime_ad_count;
                
                updateUI();

                status.textContent = `+${result.reward} ${appConfig.currencySymbol || "TON"} earned!`;
                status.className = "status ok";
                
                // ØªØ£Ø«ÙŠØ± Ù‡Ø§Ø¨ØªÙŠÚ©
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('light');
                }
            } else {
                throw new Error(result.error || "Failed to record ad watch");
            }

        } catch (err) {
            console.error("Watch ad error:", err);
            status.textContent = err.message || "Failed to watch ad";
            status.className = "status err";
        } finally {
            hideAd();
        }
    }

    async function handleWatchAd() {
        const btn = document.getElementById("watch-ad-btn");
        const status = document.getElementById("ad-status");

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ
        if (userState.daily_ad_count >= appConfig.dailyAdLimit) {
            status.textContent = "Daily ad limit reached! Come back tomorrow.";
            status.className = "status err";
            return;
        }

        try {
            btn.disabled = true;
            btn.textContent = "Loading ad...";
            status.textContent = "";
            status.className = "status";

            // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
            await new Promise(r => setTimeout(r, 1000));

            // Ø¨Ø¯Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
            showAd();

        } catch (err) {
            console.error("Watch ad error:", err);
            status.textContent = err.message || "Failed to load ad";
            status.className = "status err";
            btn.disabled = false;
            btn.textContent = `Watch Ad +${appConfig.adValue} TON`;
        }
    }

    async function handleTaskClaim(event) {
        const btn = event.target;
        const taskId = btn.dataset.taskId;
        const taskUrl = btn.dataset.taskUrl;

        try {
            btn.disabled = true;
            btn.textContent = "Processing...";

            // ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯Ù‡
            if (taskUrl) {
                if (tg.openLink) {
                    tg.openLink(taskUrl);
                } else {
                    window.open(taskUrl, '_blank');
                }
            }

            // Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ø«Ù… Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©
            await new Promise(r => setTimeout(r, 2000));

            const result = await completeTask(tgUser.id.toString(), taskId);

            if (result.ok) {
                userState.balance = Number(result.user.balance);
                updateUI();
                
                btn.textContent = "âœ… Completed";
                btn.style.background = '#6b7280';
                
                // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­
                if (tg.showPopup) {
                    tg.showPopup({
                        title: 'Task Completed!',
                        message: `You earned ${result.reward} TON!`
                    });
                }
            } else {
                throw new Error(result.error || "Failed to claim task");
            }

        } catch (err) {
            console.error("Task claim error:", err);
            btn.disabled = false;
            btn.textContent = "Claim Bonus";
            btn.style.background = '#16a34a';
            
            if (tg.showAlert) {
                tg.showAlert("Failed to claim task: " + err.message);
            }
        }
    }

    async function handleWithdraw() {
        const methodEl = document.getElementById("withdraw-method");
        const accountEl = document.getElementById("withdraw-account");
        const amountEl = document.getElementById("withdraw-amount");
        const status = document.getElementById("withdraw-status");
        const btn = document.getElementById("withdraw-btn");

        const method = methodEl.value;
        const account = accountEl.value.trim();
        const amount = parseFloat(amountEl.value);

        if (!account) {
            status.textContent = "Please enter your wallet / account.";
            status.className = "status err";
            return;
        }
        if (isNaN(amount) || amount <= 0) {
            status.textContent = "Please enter a valid amount.";
            status.className = "status err";
            return;
        }
        if (amount > userState.balance) {
            status.textContent = "Insufficient balance.";
            status.className = "status err";
            return;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨
        const minWithdraw = (appConfig.withdrawMethods || []).find(m => m.name === method)?.min || 0.1;
        if (amount < minWithdraw) {
            status.textContent = `Minimum withdrawal for ${method} is ${minWithdraw} TON.`;
            status.className = "status err";
            return;
        }

        try {
            btn.disabled = true;
            btn.textContent = "Sending request...";
            status.textContent = "";
            status.className = "status";

            const resp = await requestWithdraw(tgUser.id.toString(), method, account, amount);

            if (resp.ok) {
                status.textContent = "Withdraw request sent successfully âœ…";
                status.className = "status ok";

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø­Ø¨
                userState.balance = Number(resp.new_balance);
                updateUI();

                // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
                accountEl.value = "";
                amountEl.value = "";
                
                // ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ø¬Ø§Ø­
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
            } else {
                status.textContent = resp.error || "Failed to send withdraw request.";
                status.className = "status err";
            }

        } catch (err) {
            console.error("Withdraw error:", err);
            status.textContent = err.message || "Error in withdraw request.";
            status.className = "status err";
        } finally {
            btn.disabled = false;
            btn.textContent = "Request Withdraw";
        }
    }

    function copyReferralLink() {
        const referralInput = document.getElementById('referral-link');
        const status = document.getElementById('referral-status');
        
        referralInput.select();
        referralInput.setSelectionRange(0, 99999);
        
        try {
            navigator.clipboard.writeText(referralInput.value).then(() => {
                status.textContent = "Referral link copied to clipboard!";
                status.className = "status ok";
                
                // ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ø³Ø®
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('light');
                }
                
                setTimeout(() => {
                    status.textContent = "";
                }, 3000);
            });
        } catch (err) {
            // Fallback for older browsers
            document.execCommand('copy');
            status.textContent = "Referral link copied!";
            status.className = "status ok";
            
            setTimeout(() => {
                status.textContent = "";
            }, 3000);
        }
    }

    function setupEventListeners() {
        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        document.getElementById("watch-ad-btn").addEventListener("click", handleWatchAd);
        document.getElementById("withdraw-btn").addEventListener("click", handleWithdraw);
        document.getElementById("copy-referral-btn").addEventListener("click", copyReferralLink);
        document.getElementById("ad-skip-btn").addEventListener("click", hideAd);
        
        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„ÙˆØ§Ø¦Ø­
        document.getElementById("top-earners-btn").addEventListener("click", () => {
            loadLeaderboardData('earning');
            document.getElementById("top-earners-btn").style.background = '#1e40af';
            document.getElementById("top-referrers-btn").style.background = '#7c3aed';
        });
        
        document.getElementById("top-referrers-btn").addEventListener("click", () => {
            loadLeaderboardData('referral');
            document.getElementById("top-earners-btn").style.background = '#7c3aed';
            document.getElementById("top-referrers-btn").style.background = '#1e40af';
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            tgUser = tg.initDataUnsafe.user;
        }
        
        // ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙÙŠ ØªÙ„ÙŠØ¬Ø±Ø§Ù…
        if (tg.expand) {
            tg.expand();
        }
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø­Ø³Ø¨ Ø³Ù…Ø© ØªÙ„ÙŠØ¬Ø±Ø§Ù…
        if (tg.colorScheme === 'dark') {
            document.body.style.background = '#050816';
        } else {
            document.body.style.background = '#f8fafc';
            document.body.style.color = '#1e293b';
        }
        
        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        setupEventListeners();
        initApp();
    });
</script>
</body>
</html>

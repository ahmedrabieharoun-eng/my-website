
<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TON Rewards</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        :root {
            --font-family: 'Poppins', sans-serif;
            --primary-color: #E74C3C; --secondary-color: #F39C12;
            --background-light: #FDFEFE; --surface-light: #FFFFFF; --text-primary-light: #2C3E50; --text-secondary-light: #808B96; --border-light: #EAEDED;
            --background-dark: #1B2631; --surface-dark: #283747; --text-primary-dark: #FDFEFE; --text-secondary-dark: #ABB2B9; --border-dark: #566573;
            --success: #27AE60; --danger: #C0392B; --pending: #F39C12;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); transition: background-color 0.3s, color 0.3s; -webkit-font-smoothing: antialiased; }
        body.light-theme { background-color: var(--background-light); color: var(--text-primary-light); }
        body.dark-theme { background-color: var(--background-dark); color: var(--text-primary-dark); }
        #app { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }
        .page { display: none; padding: 15px; }
        .page.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .profile-header {
            padding: 25px 15px; border-bottom: 1px solid;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .light-theme .profile-header { background-color: var(--surface-light); border-bottom-color: var(--border-light); }
        .dark-theme .profile-header { background-color: var(--surface-dark); border-bottom-color: var(--border-dark); }
        #user-photo { width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--primary-color); object-fit: cover; margin-bottom: 10px; }
        #user-name { font-size: 1.4rem; font-weight: 700; margin-bottom: 5px; }
        #user-balance-container { font-size: 1rem; font-weight: 500; }
        #user-balance { font-size: 1.1rem; font-weight: 700; color: var(--primary-color); }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .stat-card { padding: 15px; border-radius: 12px; text-align: center; border: 1px solid; }
        .light-theme .stat-card { background-color: var(--surface-light); border-color: var(--border-light); }
        .dark-theme .stat-card { background-color: var(--surface-dark); border-color: var(--border-dark); }
        .stat-card h3 { font-size: 0.85rem; font-weight: 500; margin-bottom: 8px; text-transform: uppercase; }
        .light-theme .stat-card h3 { color: var(--text-secondary-light); } .dark-theme .stat-card h3 { color: var(--text-secondary-dark); }
        .stat-card p { font-size: 1.4rem; font-weight: 600; color: var(--primary-color); }
        
        .chart-container, .earning-wallet-card { padding: 20px; border-radius: 12px; margin-top: 20px; border: 1px solid; }
        .light-theme .chart-container, .light-theme .earning-wallet-card { background-color: var(--surface-light); border-color: var(--border-light); }
        .dark-theme .chart-container, .dark-theme .earning-wallet-card { background-color: var(--surface-dark); border-color: var(--border-dark); }
        .chart { display: flex; justify-content: space-around; align-items: flex-end; height: 150px; border-left: 1px solid; border-bottom: 1px solid; padding-top: 10px; }
        .light-theme .chart { border-color: var(--border-light); } .dark-theme .chart { border-color: var(--border-dark); }
        .bar { width: 12%; background: linear-gradient(to top, var(--primary-color), var(--secondary-color)); border-radius: 5px 5px 0 0; position: relative; cursor: pointer; }
        .bar .tooltip { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: var(--secondary); color: white; padding: 3px 7px; border-radius: 5px; font-size: 0.8rem; white-space: nowrap; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .bar:hover .tooltip { opacity: 1; }
        .chart-labels { display: flex; justify-content: space-around; font-size: 0.75rem; margin-top: 5px; }

        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .light-theme .history-item { background-color: var(--surface-light); border: 1px solid var(--border-light); }
        .dark-theme .history-item { background-color: var(--surface-dark); border: 1px solid var(--border-dark); }
        .history-details p { margin: 0; } .history-details p:first-child { font-weight: 600; }
        .history-status { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: white; text-transform: capitalize; }
        .status-completed { background-color: var(--success); } .status-pending { background-color: var(--pending); } .status-rejected { background-color: var(--danger); }

        .progress-container { margin-bottom: 20px; }
        .progress-info { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500; }
        .progress-bar-bg { width: 100%; height: 10px; border-radius: 5px; }
        .light-theme .progress-bar-bg { background-color: var(--border-light); }
        .dark-theme .progress-bar-bg { background-color: var(--border-dark); }
        .progress-bar-fg { height: 100%; border-radius: 5px; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); transition: width 0.3s ease; }
        
        form input, form select, form textarea { transition: all 0.2s ease-in-out; border: 1px solid; }
        .light-theme form input, .light-theme form select { border-color: var(--border-light); }
        .dark-theme form input, .dark-theme form select { border-color: var(--border-dark); }
        form input:focus, form select:focus, form textarea:focus { outline: none; border-color: var(--primary-color) !important; box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2); }

        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .popup-content { padding: 30px; border-radius: 15px; text-align: center; max-width: 80%; }
        .light-theme .popup-content { background-color: var(--surface-light); } .dark-theme .popup-content { background-color: var(--surface-dark); }
        .popup-content h2 { margin-bottom: 15px; color: var(--primary-color); } .popup-content p { margin-bottom: 20px; }
        .popup-close-btn { padding: 10px 25px; border: none; border-radius: 8px; color: #fff; background-color: var(--primary-color); cursor: pointer; }
        .popup-loader .spinner { width: 40px; height: 40px; border-radius: 50%; border: 4px solid; border-color: var(--primary-color) transparent; animation: spin 1s linear infinite; margin: 0 auto 15px;}
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .light-theme #app-loader { background-color: var(--background-light); } .dark-theme #app-loader { background-color: var(--background-dark); }
        #app-loader .spinner { width: 50px; height: 50px; border-radius: 50%; border: 5px solid; border-color: var(--primary-color) transparent; animation: spin 1s linear infinite; }
        #loading-progress { margin-top: 15px; font-size: 1.2rem; font-weight: 600; }
        .light-theme #loading-progress { color: var(--text-primary-light); } .dark-theme #loading-progress { color: var(--text-primary-dark); }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid; z-index: 1000; }
        .light-theme .bottom-nav { background-color: var(--surface-light); border-top-color: var(--border-light); }
        .dark-theme .bottom-nav { background-color: var(--surface-dark); border-top-color: var(--border-dark); }
        .nav-btn { background: none; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; font-family: var(--font-family); font-size: 0.75rem; transition: color 0.2s; flex-grow: 1; }
        .light-theme .nav-btn { color: var(--text-secondary-light); } .dark-theme .nav-btn { color: var(--text-secondary-dark); }
        .nav-btn i { font-size: 1.5rem; margin-bottom: 4px; } .nav-btn.active { color: var(--primary-color); }
        
        .task-container { padding: 20px; border-radius: 12px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; }
        .light-theme .task-container { background-color: var(--surface-light); border: 1px solid var(--border-light); }
        .dark-theme .task-container { background-color: var(--surface-dark); border: 1px solid var(--border-dark); }
        .task-icon-img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .task-info h3 { font-size: 1.1rem; font-weight: 600; } .task-info p { font-size: 0.85rem; }
        .action-btn { padding: 10px 20px; font-size: 0.9rem; font-weight: 600; color: #fff; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); margin-left: auto; white-space: nowrap; }
        .action-btn:disabled { background: #808B96; cursor: not-allowed; }
        
        .leaderboard-toggle { display: flex; justify-content: space-around; margin-bottom: 15px; }
        .toggle-btn { padding: 10px 20px; border: none; background: none; font-size: 1rem; cursor: pointer; }
        .light-theme .toggle-btn { color: var(--text-secondary-light); } .dark-theme .toggle-btn { color: var(--text-secondary-dark); }
        .toggle-btn.active { font-weight: 700; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); }
        .leaderboard-list { list-style: none; }
        .leaderboard-item { display: flex; align-items: center; padding: 10px; margin-bottom: 8px; border-radius: 8px; }
        .light-theme .leaderboard-item { background-color: var(--surface-light); } .dark-theme .leaderboard-item { background-color: var(--surface-dark); }
        .rank { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); width: 40px; }
        .leaderboard-item img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        .leaderboard-name { font-weight: 600; flex-grow: 1; } .leaderboard-score { font-weight: 600; color: var(--primary-color); }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© */
        .security-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--success);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 1001;
        }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ */
        .token-status {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 8px 12px;
            margin: 10px 15px;
            font-size: 12px;
            text-align: center;
            color: #0066cc;
        }
        .light-theme .token-status { background: #e7f3ff; border-color: #b3d9ff; }
        .dark-theme .token-status { background: #1a3a5f; border-color: #2d527a; }
    </style>
</head>
<body class="dark-theme">
    <div class="security-badge" id="security-badge">ğŸ›¡ï¸ Secure</div>
    <div id="app-loader">
        <div class="spinner"></div>
        <p id="loading-progress">0%</p>
    </div>
    <div id="popup" class="popup-overlay">
        <div class="popup-content">
            <div id="popup-body"></div>
        </div>
    </div>

    <div id="app" style="display: none;">
        <!-- Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ -->
        <div class="token-status" id="tokenStatus">
            ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
        </div>

        <header class="profile-header">
            <img id="user-photo" src="https://via.placeholder.com/80" alt="User">
            <h1 id="user-name">Loading...</h1>
            <div id="user-balance-container">Main Balance: <span id="user-balance">0.0000</span> TON</div>
        </header>
        
        <main id="main-content">
            <div id="home-page" class="page active">
                <div class="stats-grid">
                    <div class="stat-card"><h3>Today's Ads</h3><p id="daily-ads-watched">0 / 0</p></div>
                    <div class="stat-card"><h3>Total Referrals</h3><p id="referral-count">0</p></div>
                    <div class="stat-card"><h3>Total Ads Watched</h3><p id="total-ads-watched">0</p></div>
                    <div class="stat-card"><h3>Total Income</h3><p id="total-earned">0.0000</p></div>
                </div>
                <div id="earnings-graph-container" class="chart-container">
                    <h3>Last 7 Days Earnings</h3>
                    <div id="earnings-chart" class="chart"></div>
                    <div id="earnings-chart-labels" class="chart-labels"></div>
                </div>
                <div id="dynamic-links-container" style="margin-top: 20px;"></div>
            </div>
            
            <div id="tasks-page" class="page">
                <div class="earning-wallet-card">
                    <h3>Earning Wallet</h3>
                    <p style="font-size: 1.8rem; font-weight: 700; color: var(--primary-color); margin: 10px 0;">
                        <span id="earning-wallet-balance">0.0000</span> TON
                    </p>
                    <small>Minimum 0.0001 TON to move to main balance.</small>
                    <button id="move-to-balance-btn" class="action-btn" style="width:100%; margin-top: 15px;" disabled>
                        Move to Main Balance
                    </button>
                </div>
                <div id="ad-progress-container" class="progress-container" style="margin-top:20px;"></div>
                <div id="ad-task-container"></div>
                <h2>Bonus Tasks</h2>
                <div id="dynamic-tasks-container"></div>
            </div>
            
            <div id="leaderboard-page" class="page">
                <h2>Leaderboard</h2>
                <div class="leaderboard-toggle">
                    <button class="toggle-btn active" data-board="referral">Top Referrers</button>
                    <button class="toggle-btn" data-board="earning">Top Earners</button>
                </div>
                <div id="referral-board">
                    <ul class="leaderboard-list" id="referral-leaderboard-list"></ul>
                </div>
                <div id="earning-board" style="display: none;">
                    <ul class="leaderboard-list" id="earning-leaderboard-list"></ul>
                </div>
            </div>
            
            <div id="profile-page" class="page">
                <div id="referral-section"></div>
                <div id="withdraw-section"></div>
                <div id="withdrawal-history-section" style="margin-top: 20px;">
                    <h2>Withdrawal History</h2>
                    <div id="withdrawal-history-list"></div>
                </div>
            </div>
        </main>
        
        <nav class="bottom-nav">
            <button class="nav-btn active" data-page="home-page"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-btn" data-page="tasks-page"><i class="fas fa-tasks"></i><span>Tasks</span></button>
            <button class="nav-btn" data-page="leaderboard-page"><i class="fas fa-trophy"></i><span>Leaderboard</span></button>
            <button class="nav-btn" data-page="profile-page"><i class="fas fa-user-alt"></i><span>Profile</span></button>
        </nav>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª -->
    <script src="//libtl.com/sdk.js" data-zone="10189300" data-sdk="show_10189300" async></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
        
        const tg = window.Telegram?.WebApp;
        if (!tg) {
            console.error('âŒ Telegram WebApp ØºÙŠØ± Ù…ØªÙˆÙØ±');
            document.getElementById('loading-progress').textContent = 'Error: Open in Telegram';
            return;
        }

        // ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Backend
        const BACKEND_URL = 'https://ton-rewards-backend-production-5e56.up.railway.app';

        // ğŸ” Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
        let currentDynamicToken = null;

        // âœ… Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ - Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        let appConfig = {
            dailyAdLimit: 100,        // 100 Ø¥Ø¹Ù„Ø§Ù† ÙŠÙˆÙ…ÙŠØ§Ù‹
            adValue: 0.0001,          // 0.0001 TON Ù„ÙƒÙ„ Ø¥Ø¹Ù„Ø§Ù†  
            minWithdrawal: 0.0001     // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ 0.0001 TON
        }; 
        let userState = {}; 
        let tgUser = {}; 
        let userTransactions = [];

        const popup = document.getElementById('popup');
        const popupBody = document.getElementById('popup-body');
        const loadingProgress = document.getElementById('loading-progress');

        const showPopup = (content) => { 
            popupBody.innerHTML = content; 
            popup.style.display = 'flex'; 
        };
        
        const closePopup = () => { 
            popup.style.display = 'none'; 
        };
        
        const updateProgress = (percentage) => { 
            console.log(`Progress: ${percentage}%`);
            loadingProgress.textContent = `${percentage}%`; 
        };

        const showError = (message) => {
            console.error('Error:', message);
            try{ 
                if (tg.showAlert) tg.showAlert(message); 
            }catch(e){
                showPopup(`<h2>Error</h2><p>${message}</p><button class="popup-close-btn" onclick="closePopup()">OK</button>`);
            }
        };

        const showSuccess = (message) => {
            console.log('Success:', message);
            try{ 
                if (tg.showAlert) tg.showAlert(message); 
            }catch(e){
                showPopup(`<h2>Success</h2><p>${message}</p><button class="popup-close-btn" onclick="closePopup()">OK</button>`);
            }
        };

        // ğŸ”¥ Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ
        async function getCurrentToken() {
            try {
                console.log('ğŸ”„ Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ†...');
                const response = await fetch(`${BACKEND_URL}/api/token/current`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('âœ… Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ØªÙˆÙƒÙ†:', data);
                
                if (data.success) {
                    currentDynamicToken = data.token;
                    console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆÙƒÙ†:', currentDynamicToken?.substring(0, 15) + '...');
                    updateTokenStatus('ğŸŸ¢ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù†Ø´Ø·');
                    return true;
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ†:', error);
                updateTokenStatus('ğŸ”´ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
            return false;
        }

        // ğŸ”¥ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        function updateTokenStatus(message) {
            const tokenStatusEl = document.getElementById('tokenStatus');
            if (tokenStatusEl) {
                tokenStatusEl.textContent = message;
            }
        }

        // ğŸ”¥ Ø¯Ø§Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¢Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„ØªÙˆÙƒÙ†
        async function makeAuthenticatedRequest(url, options = {}) {
            if (!currentDynamicToken) {
                console.log('â³ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙˆÙƒÙ†...');
                await getCurrentToken();
            }
            
            const headers = {
                'Content-Type': 'application/json',
                'X-Dynamic-Token': currentDynamicToken,
                ...options.headers
            };
            
            try {
                console.log('ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ù„Ù‰:', url);
                const response = await fetch(url, { 
                    ...options, 
                    headers
                });
                
                if (response.status === 401) {
                    const errorData = await response.json();
                    if (errorData.code === 'INVALID_DYNAMIC_TOKEN') {
                        console.log('ğŸ”„ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù†ØªÙ‡ÙŠØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...');
                        await getCurrentToken();
                        
                        headers['X-Dynamic-Token'] = currentDynamicToken;
                        return await fetch(url, { ...options, headers });
                    }
                }
                
                return response;
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨:', error);
                throw error;
            }
        }

        // ğŸ”§ Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        async function loadAppConfig() {
            try {
                console.log('ğŸ“¥ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...');
                const response = await makeAuthenticatedRequest(`${BACKEND_URL}/api/config`);
                const data = await response.json();
                
                if (data.success) {
                    appConfig = data.config;
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', appConfig);
                } else {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
                }
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', error);
                // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙƒØ­Ù…Ø§ÙŠØ©
                appConfig = {
                    dailyAdLimit: 100,        // 100 Ø¥Ø¹Ù„Ø§Ù†
                    adValue: 0.0001,          // 0.0001 TON
                    minWithdrawal: 0.0001     // 0.0001 TON
                };
                console.log('ğŸ›¡ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©:', appConfig);
            }
        }

        // ğŸ” Ù†Ø¸Ø§Ù… Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¢Ù…Ù† Ø¨Ø§Ù„Ù€ Backend
        const secureAPI = {
            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            async getUser(userId, initData) {
                try {
                    const response = await makeAuthenticatedRequest(
                        `${BACKEND_URL}/api/user/${userId}?initData=${encodeURIComponent(initData)}`
                    );
                    return await response.json();
                } catch (error) {
                    console.error('Get user failed:', error);
                    return { success: false, error: 'Connection failed' };
                }
            },

            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            async registerUser(initData) {
                try {
                    const response = await makeAuthenticatedRequest(`${BACKEND_URL}/api/register`, {
                        method: 'POST',
                        body: JSON.stringify({ initData })
                    });
                    return await response.json();
                } catch (error) {
                    console.error('Registration failed:', error);
                    return { success: false, error: 'Connection failed' };
                }
            },

            // Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¥Ø¹Ù„Ø§Ù†
            async watchAd(initData) {
                try {
                    const response = await makeAuthenticatedRequest(`${BACKEND_URL}/api/watch-ad`, {
                        method: 'POST',
                        body: JSON.stringify({ initData })
                    });
                    return await response.json();
                } catch (error) {
                    console.error('Watch ad failed:', error);
                    return { success: false, error: 'Connection failed' };
                }
            },

            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯
            async moveToBalance(initData) {
                try {
                    const response = await makeAuthenticatedRequest(`${BACKEND_URL}/api/move-to-balance`, {
                        method: 'POST',
                        body: JSON.stringify({ initData })
                    });
                    return await response.json();
                } catch (error) {
                    console.error('Move balance failed:', error);
                    return { success: false, error: 'Connection failed' };
                }
            },

            // Ø·Ù„Ø¨ Ø³Ø­Ø¨
            async withdraw(initData, amount, walletAddress, method = 'TON Wallet') {
                try {
                    const response = await makeAuthenticatedRequest(`${BACKEND_URL}/api/withdraw`, {
                        method: 'POST',
                        body: JSON.stringify({ 
                            initData, 
                            amount, 
                            walletAddress, 
                            method 
                        })
                    });
                    return await response.json();
                } catch (error) {
                    console.error('Withdraw failed:', error);
                    return { success: false, error: 'Connection failed' };
                }
            },

            // Ø¬Ù„Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª
            async getWithdrawals(userId, initData) {
                try {
                    const response = await makeAuthenticatedRequest(
                        `${BACKEND_URL}/api/withdrawals/${userId}?initData=${encodeURIComponent(initData)}`
                    );
                    return await response.json();
                } catch (error) {
                    console.error('Get withdrawals failed:', error);
                    return { success: false, error: 'Connection failed' };
                }
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
        async function processAdReward() {
            try {
                console.log('ğŸ’° Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†...');
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ Backend Ø§Ù„Ø¢Ù…Ù†
                const result = await secureAPI.watchAd(tg.initData);
                
                if (result.success) {
                    userState.earningWallet = result.earningWallet;
                    userState.dailyAdCount = result.dailyRemaining ? (appConfig.dailyAdLimit - result.dailyRemaining) : (userState.dailyAdCount + 1);
                    userState.totalEarned = result.totalEarned;
                    userState.totalAds = (userState.totalAds || 0) + 1;

                    try{ 
                        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    }catch{}
                    
                    showSuccess(`+${result.amount.toFixed(4)} TON added to your Earning Wallet.`);
                    renderUI();
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©:', error);
                showError('Failed to process ad reward. Please try again.');
            }
        }

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø¥Ø°Ø§ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ø´ Ø´ØºØ§Ù„Ø©)
        async function simulateAd() {
            console.log('ğŸ¬ Ø¨Ø¯Ø¡ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†...');
            
            showPopup(`
                <div class="popup-loader">
                    <div class="spinner"></div>
                    <h2>Watching Ad</h2>
                    <p>Please watch the ad to earn rewards...</p>
                    <p style="font-size: 0.9rem; margin-top: 10px; opacity: 0.8;">
                        â±ï¸ Simulated ad - 5 seconds
                    </p>
                </div>
            `);

            // Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¥Ø¹Ù„Ø§Ù† Ù„Ù…Ø¯Ø© 5 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(async () => {
                closePopup();
                await processAdReward();
            }, 5000);
        }

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
        async function handleWatchAd() {
            if (userState.dailyAdCount >= appConfig.dailyAdLimit) { 
                showError("You have reached your daily ad watch limit."); 
                return; 
            }

            const watchBtn = document.getElementById('watch-ad-btn');
            if (watchBtn) {
                watchBtn.disabled = true;
                watchBtn.textContent = 'Loading...';
            }

            showPopup(`
                <div class="popup-loader">
                    <div class="spinner"></div>
                    <h2>Loading Ad</h2>
                    <p>Please wait a moment...</p>
                </div>
            `);

            try {
                // ğŸ”¥ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
                if (typeof show_10189300 === 'function') {
                    console.log('ğŸ¬ Ø¨Ø¯Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ...');
                    
                    // Ø¥ØºÙ„Ø§Ù‚ popup Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù‚Ø¨Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
                    closePopup();
                    
                    await show_10189300().then(() => {
                        // Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù‡ÙŠØ´ØªØºÙ„ Ø¨Ø¹Ø¯ Ù…Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ´ÙˆÙ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ÙƒØ§Ù…Ù„
                        console.log('âœ… ØªÙ… Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­');
                        processAdReward();
                    }).catch((error) => {
                        // Ø¥Ø°Ø§ Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†:', error);
                        showError("Failed to load ad. Please try again.");
                        if (watchBtn) {
                            watchBtn.disabled = false;
                            watchBtn.textContent = 'Watch Ad';
                        }
                    });
                } else {
                    // Ø¥Ø°Ø§ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ø´ Ù…ØªÙˆÙØ±Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
                    console.log('âš ï¸ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©');
                    closePopup();
                    simulateAd();
                }

            } catch (error) {
                console.error("Ad failed:", error);
                closePopup();
                showError("Ad could not be loaded. Please try again.");
                
                if (watchBtn) {
                    watchBtn.disabled = false;
                    watchBtn.textContent = 'Watch Ad';
                }
            }
        }

        // âœ… Ø¯ÙˆØ§Ù„ Ø£Ø®Ø±Ù‰
        async function handleMoveToBalance() {
            if((userState.earningWallet || 0) < appConfig.minWithdrawal) { 
                showError(`You need at least ${appConfig.minWithdrawal} TON to move.`); 
                return; 
            }

            const btn = document.getElementById('move-to-balance-btn'); 
            btn.disabled = true; 
            btn.textContent = 'Moving...';
            
            try {
                const result = await secureAPI.moveToBalance(tg.initData);
                
                if (result.success) {
                    userState.balance = result.newBalance;
                    userState.earningWallet = result.earningWallet;
                    
                    try{ 
                        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    }catch{}
                    showSuccess("Successfully moved to main balance!");
                    renderUI();
                } else {
                    throw new Error(result.error);
                }
            } catch(error) { 
                console.error("Move balance failed:", error); 
                showError("Failed to move balance. Please try again."); 
            } finally { 
                btn.textContent = 'Move to Main Balance'; 
                btn.disabled = (userState.earningWallet || 0) < appConfig.minWithdrawal;
            }
        }

        async function handleWithdraw(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const walletAddress = document.getElementById('wallet-address').value.trim();

            if (!amount || amount < appConfig.minWithdrawal) {
                showError(`Minimum withdrawal is ${appConfig.minWithdrawal} TON`);
                return;
            }

            if (userState.balance < amount) {
                showError('Insufficient balance');
                return;
            }

            if (!walletAddress) {
                showError('Please enter your TON wallet address');
                return;
            }

            const btn = document.getElementById('withdraw-submit-btn');
            btn.disabled = true;
            btn.textContent = 'Processing...';

            try {
                const result = await secureAPI.withdraw(tg.initData, amount, walletAddress);
                
                if (result.success) {
                    userState.balance = result.newBalance;
                    showSuccess('Withdrawal request submitted successfully!');
                    renderUI();
                    
                    // ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª
                    const withdrawalsResult = await secureAPI.getWithdrawals(tgUser.id, tg.initData);
                    if (withdrawalsResult.success) {
                        userTransactions = withdrawalsResult.withdrawals || [];
                        renderWithdrawalHistory();
                    }
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Withdraw failed:', error);
                showError('Withdrawal failed. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Submit Request';
            }
        }

        // âœ… Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        async function initializeApp() {
            try {
                updateProgress(10);

                // ØªÙ‡ÙŠØ¦Ø© Telegram WebApp
                if (tg.ready) { 
                    tg.ready(); 
                    console.log('âœ… Telegram WebApp ready');
                }
                
                if (tg.expand) {
                    try { 
                        tg.expand(); 
                        console.log('âœ… Telegram WebApp expanded');
                    } catch(e) {
                        console.log('âš ï¸ Cannot expand WebApp');
                    }
                }
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ù…Ø©
                if (tg.colorScheme && tg.colorScheme === 'dark') { 
                    document.body.className = 'dark-theme'; 
                } else { 
                    document.body.className = 'light-theme'; 
                }

                updateProgress(20);

                // ğŸ”¥ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                await loadAppConfig();
                console.log('ğŸ¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:', appConfig);
                updateProgress(30);

                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                tgUser = (tg.initDataUnsafe && tg.initDataUnsafe.user) || {};
                console.log('ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', tgUser);
                
                if (!tgUser || !tgUser.id) { 
                    throw new Error('ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† ØªÙ„ÙŠØ¬Ø±Ø§Ù…');
                }

                updateProgress(40);

                // Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ†
                console.log('ğŸ” Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ†...');
                await getCurrentToken();
                updateProgress(50);

                // ØªØ³Ø¬ÙŠÙ„/Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const initData = tg.initData;
                const userId = tgUser.id;
                
                console.log('ğŸ“¥ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...');
                const userResult = await secureAPI.getUser(userId, initData);
                
                if (userResult.success) {
                    userState = userResult.user;
                    console.log('âœ… ØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userState);
                } else {
                    // ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
                    console.log('ğŸ†• ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯...');
                    const registerResult = await secureAPI.registerUser(initData);
                    
                    if (!registerResult.success) {
                        throw new Error(registerResult.error || 'ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
                    }

                    userState = registerResult.user;
                    console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:', userState);
                }

                updateProgress(70);

                // Ø¬Ù„Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª
                console.log('ğŸ“‹ Ø¬Ù„Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª...');
                const withdrawalsResult = await secureAPI.getWithdrawals(userId, initData);
                if (withdrawalsResult.success) {
                    userTransactions = withdrawalsResult.withdrawals || [];
                    console.log('âœ… ØªÙ… Ø¬Ù„Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª:', userTransactions.length);
                }

                updateProgress(90);

                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                console.log('ğŸ¨ Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©...');
                renderUI();
                setupNavigation();
                setupEventListeners();
                updateProgress(100);

                setTimeout(() => {
                    document.getElementById('app-loader').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    console.log('ğŸš€ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø²!');
                }, 500);

            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©:', error);
                showError('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: ' + error.message);
                
                document.getElementById('app-loader').style.display = 'none';
                document.getElementById('app').style.display = 'block';
            }
        }

        // âœ… Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶
        function renderUI() {
            console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©...');
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            document.getElementById('user-photo').src = tgUser.photo_url || 'https://via.placeholder.com/80';
            document.getElementById('user-name').textContent = `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim() || 'User';
            document.getElementById('user-balance').textContent = (userState.balance || 0).toFixed(4);
            document.getElementById('daily-ads-watched').textContent = `${userState.dailyAdCount || 0} / ${appConfig.dailyAdLimit}`;
            document.getElementById('referral-count').textContent = userState.referrals || 0;
            document.getElementById('total-ads-watched').textContent = userState.totalAds || 0;
            document.getElementById('total-earned').textContent = (userState.totalEarned || 0).toFixed(4);
            document.getElementById('earning-wallet-balance').textContent = (userState.earningWallet || 0).toFixed(4);
            
            // Ø²Ø± ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯
            const moveBtn = document.getElementById('move-to-balance-btn');
            const canMove = (userState.earningWallet || 0) >= appConfig.minWithdrawal;
            moveBtn.disabled = !canMove;
            moveBtn.textContent = canMove ? 'Move to Main Balance' : `Minimum ${appConfig.minWithdrawal} TON`;
            
            renderAdTask(); 
            renderAdProgress(); 
            renderReferralSection(); 
            renderWithdrawSection(); 
            renderWithdrawalHistory();
            
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©');
        }

        function renderAdProgress() {
            const container = document.getElementById('ad-progress-container');
            const dailyLimit = appConfig.dailyAdLimit;
            const watchedCount = userState.dailyAdCount || 0;
            const percentage = Math.min(100, (watchedCount / dailyLimit) * 100);
            container.innerHTML = `
                <div class="progress-info">
                    <span>Daily Ad Progress</span>
                    <span>${watchedCount} / ${dailyLimit}</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fg" style="width: ${percentage}%;"></div>
                </div>`;
        }

        // âœ… Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„Ø£Ø­Ø¯Ø§Ø«
        function setupNavigation() {
            const navButtons = document.querySelectorAll('.nav-btn'); 
            const pages = document.querySelectorAll('.page');
            
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const pageId = button.dataset.page;
                    pages.forEach(page => page.classList.remove('active'));
                    document.getElementById(pageId).classList.add('active');
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                });
            });
        }

        function setupEventListeners() {
            popup.addEventListener('click', (e) => { 
                if (e.target.classList.contains('popup-close-btn') || e.target.id === 'popup') closePopup(); 
            });
            
            document.getElementById('move-to-balance-btn').addEventListener('click', handleMoveToBalance);
            
            const withdrawForm = document.getElementById('withdraw-form');
            if (withdrawForm) {
                withdrawForm.addEventListener('submit', handleWithdraw);
            }
        }

        // âœ… Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø±Ù‰
        function renderAdTask() {
            const container = document.getElementById('ad-task-container');
            const limitReached = userState.dailyAdCount >= appConfig.dailyAdLimit;
            
            let html = '';
            if (limitReached) {
                html = `
                    <div class="task-container">
                        <img class="task-icon-img" src="https://img.icons8.com/ios-filled/100/stop-circled.png" alt="icon">
                        <div class="task-info">
                            <h3>Daily Limit Reached</h3>
                            <p>Come back tomorrow for more ads.</p>
                        </div>
                        <button class="action-btn" disabled>Limit</button>
                    </div>`;
            } else {
                html = `
                    <div class="task-container">
                        <img class="task-icon-img" src="https://img.icons8.com/ios-filled/100/play-button-circled.png" alt="icon">
                        <div class="task-info">
                            <h3>Watch a Rewarded Ad</h3>
                            <p>Earn ${Number(appConfig.adValue).toFixed(4)} TON for every ad.</p>
                        </div>
                        <button id="watch-ad-btn" class="action-btn">Watch Ad</button>
                    </div>`;
            }
            container.innerHTML = html;
            
            if (!limitReached) { 
                const btn = document.getElementById('watch-ad-btn'); 
                if (btn) btn.addEventListener('click', handleWatchAd); 
            }
        }

        function renderReferralSection() {
            const container = document.getElementById('referral-section');
            const botUsername = "YourBotUsername"; // Ø¶Ø¹ ÙŠÙˆØ²Ø± Ø§Ù„Ø¨ÙˆØª Ù‡Ù†Ø§
            const userId = tgUser.id || '';
            const refLink = `https://t.me/${botUsername}?start=${userId}`;
            
            container.innerHTML = `
                <div class="task-container" style="flex-direction: column; align-items: stretch;">
                    <h3>ğŸ‘¥ Refer & Earn More!</h3>
                    <p>Invite friends and earn <strong>0.0005 TON</strong> per referral.</p>
                    <p style="font-size: 0.9rem; color: var(--primary-color); margin: 5px 0;">
                        ğŸ“Š Your referrals: <strong>${userState.referrals || 0}</strong>
                    </p>
                    <input type="text" id="referral-link" value="${refLink}" readonly style="padding: 10px; text-align: center; border-radius: 8px; border: 1px dashed var(--primary-color); margin: 10px 0; background: transparent; color: inherit;">
                    <button id="copy-ref-link-btn" class="action-btn">ğŸ“‹ Copy Link</button>
                </div>`;

            // Ø¥Ø¶Ø§ÙØ© event listener Ù„Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
            document.getElementById('copy-ref-link-btn').addEventListener('click', function() {
                const refLinkInput = document.getElementById('referral-link');
                refLinkInput.select();
                refLinkInput.setSelectionRange(0, 99999);
                
                try {
                    navigator.clipboard.writeText(refLinkInput.value).then(() => {
                        try{ 
                            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                        }catch{}
                        showSuccess("Referral link copied!");
                    });
                } catch (err) {
                    document.execCommand('copy');
                    try{ 
                        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    }catch{}
                    showSuccess("Referral link copied!");
                }
            });
        }

        function renderWithdrawSection() {
            const container = document.getElementById('withdraw-section');

            container.innerHTML = `
                <form id="withdraw-form" class="task-container" style="flex-direction: column; align-items: stretch;">
                    <h3>Request Withdraw</h3>
                    <div class="form-group" style="width:100%">
                        <label for="wallet-address">TON Wallet Address:</label>
                        <input type="text" id="wallet-address" required placeholder="UQB... or EQ..." style="width: 100%; padding: 10px; border-radius: 8px;">
                    </div>
                    <div class="form-group" style="width:100%">
                        <label for="withdraw-amount">Amount (TON):</label>
                        <input type="number" step="0.0001" id="withdraw-amount" required 
                               min="${appConfig.minWithdrawal}" max="${userState.balance || 0}" 
                               placeholder="${appConfig.minWithdrawal}" 
                               style="width: 100%; padding: 10px; border-radius: 8px;">
                    </div>
                    <button type="submit" id="withdraw-submit-btn" class="action-btn">Submit Request</button>
                    <p style="font-size: 0.8rem; text-align: center; margin-top: 10px; opacity: 0.7;">
                        Minimum withdrawal: ${appConfig.minWithdrawal} TON
                    </p>
                </form>`;
        }

        function renderWithdrawalHistory() {
            const container = document.getElementById('withdrawal-history-list');
            
            if (!userTransactions || userTransactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7;">No withdrawal history</p>';
                return;
            }

            container.innerHTML = userTransactions.map(transaction => `
                <div class="history-item">
                    <div class="history-details">
                        <p>${parseFloat(transaction.amount).toFixed(4)} TON</p>
                        <small>${new Date(transaction.createdAt).toLocaleDateString()}</small>
                    </div>
                    <span class="history-status status-${transaction.status}">${transaction.status}</span>
                </div>
            `).join('');
        }

        // âœ… Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        console.log('ğŸ¯ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
        initializeApp();

        // Ø¥Ø¶Ø§ÙØ© keyframes Ù„Ù„Ù€ spinner
        (function addSpinKeyframes(){ 
            const style = document.createElement('style'); 
            style.innerHTML='@keyframes spin{to{transform:rotate(360deg)}}'; 
            document.head.appendChild(style); 
        })();
    });
    </script>
</body>
</html>

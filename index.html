<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Farm Economy</title>
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- TON Connect SDK -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    
    <!-- TonWeb - ÿ∂ÿ±Ÿàÿ±Ÿä ŸÑÿ•ŸÜÿ¥ÿßÿ° Cells ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠ -->
    <script src="https://unpkg.com/tonweb@0.0.57/dist/tonweb.js"></script>
    
    <style>
        /* ==================== RESET & VARIABLES ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            /* Dark Modern Glass Theme */
            --bg-gradient-start: #0B0F1A;
            --bg-gradient-mid: #111827;
            --bg-gradient-end: #0F172A;
            
            --glass-bg: rgba(255, 255, 255, 0.04);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-card: rgba(255, 255, 255, 0.04);
            --glass-hover: rgba(255, 255, 255, 0.08);
            
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.5);
            
            --accent-green: #00D09C;
            --accent-green-glow: rgba(0, 208, 156, 0.2);
            --accent-yellow: #FFD166;
            --accent-purple: #9D7BFF;
            --accent-purple-glow: rgba(157, 123, 255, 0.2);
            --accent-blue: #5E9EFF;
            --accent-red: #FF6B6B;
            
            --milk-color: #FFFFFF;
            --egg-color: #FFD166;
            --diamond-color: #9D7BFF;
            --ton-color: #5E9EFF;
            
            --success: #00D09C;
            --warning: #FFD166;
            --danger: #FF6B6B;
            --info: #5E9EFF;
            
            --border-radius-lg: 24px;
            --border-radius-md: 20px;
            --border-radius-sm: 16px;
            --border-radius-xs: 12px;
            
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.2);
            --glow: 0 0 20px rgba(0, 208, 156, 0.2);
            
            /* Production Rates */
            --cow-rate: 41;
            --chicken-rate: 41;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-mid), var(--bg-gradient-end));
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 90px;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 208, 156, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 80% 20%, rgba(255, 209, 102, 0.06) 0%, transparent 40%),
                radial-gradient(circle at 40% 40%, rgba(157, 123, 255, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        /* ==================== TOP STATUS BAR - NEW DESIGN ==================== */
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 12px 16px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .status-row {
            display: flex;
            gap: 12px;
        }
        
        .status-row.first-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }
        
        .status-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius-sm);
            padding: 12px 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(4px);
        }
        
        .status-header {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
        }
        
        .status-header i {
            font-size: 14px;
        }
        
        .status-main {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }
        
        .status-balance {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }
        
        .status-sub {
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .ton-status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius-sm);
            padding: 8px 12px;
            border: 1px solid var(--glass-border);
        }
        
        .ton-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ton-icon {
            width: 36px;
            height: 36px;
            background: rgba(94, 158, 255, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--ton-color);
        }
        
        .ton-details {
            display: flex;
            flex-direction: column;
        }
        
        .ton-label {
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
        }
        
        .ton-amount {
            font-size: 20px;
            font-weight: 800;
            color: var(--ton-color);
            line-height: 1.2;
        }
        
        .ton-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .deposit-btn {
            width: 40px;
            height: 40px;
            background: var(--accent-green);
            border: none;
            border-radius: 14px;
            color: black;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }
        
        .deposit-btn:active {
            transform: scale(0.92);
        }
        
        .help-btn {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #9D7BFF, #7B5FFF);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }
        
        .help-btn:active {
            transform: scale(0.92);
        }
        
        /* ==================== MAIN CONTAINER ==================== */
        .app-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 110px 16px 16px 16px;
            min-height: 100vh;
        }
        
        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .content-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ==================== GLASS CARDS ==================== */
        .glass-card {
            background: var(--glass-card);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        .glass-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-purple));
            opacity: 0.3;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--accent-green);
        }
        
        /* ==================== MACHINE CARDS ==================== */
        .machine-card {
            background: var(--glass-card);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.2s;
        }
        
        .machine-card.locked {
            opacity: 0.6;
            filter: grayscale(0.5);
        }
        
        .machine-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
        }
        
        .machine-icon {
            width: 54px;
            height: 54px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }
        
        .machine-icon.cow {
            background: rgba(109, 76, 65, 0.2);
            color: #8B5E3C;
        }
        
        .machine-icon.chicken {
            background: rgba(255, 209, 102, 0.1);
            color: var(--egg-color);
        }
        
        .machine-icon.diamond {
            background: rgba(157, 123, 255, 0.1);
            color: var(--diamond-color);
        }
        
        .machine-info {
            flex: 1;
        }
        
        .machine-name-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .machine-name {
            font-size: 18px;
            font-weight: 700;
        }
        
        .machine-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-owned {
            background: rgba(0, 208, 156, 0.15);
            color: var(--success);
            border: 1px solid rgba(0, 208, 156, 0.3);
        }
        
        .badge-sold-out {
            background: rgba(255, 107, 107, 0.15);
            color: var(--danger);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        
        .badge-locked {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .badge-available {
            background: rgba(0, 208, 156, 0.15);
            color: var(--success);
            border: 1px solid rgba(0, 208, 156, 0.3);
        }
        
        .machine-price {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
        }
        
        .machine-price i {
            color: var(--ton-color);
        }
        
        .machine-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius-sm);
        }
        
        .machine-stat {
            text-align: center;
        }
        
        .machine-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
            margin-bottom: 4px;
        }
        
        .machine-stat-value {
            font-size: 18px;
            font-weight: 700;
        }
        
        .machine-progress {
            margin: 16px 0;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .progress-bar-bg {
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-yellow));
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .machine-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        /* ==================== BUTTONS ==================== */
        .btn {
            padding: 14px 20px;
            border-radius: var(--border-radius-sm);
            border: none;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }
        
        .btn:active {
            transform: scale(0.97);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-green), #00B894);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 208, 156, 0.3);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }
        
        .btn-buy {
            background: var(--accent-green);
            color: black;
            font-weight: 800;
        }
        
        .btn-sell {
            background: var(--accent-red);
            color: white;
        }
        
        .btn-hatch {
            background: linear-gradient(135deg, #FFD166, #FFB347);
            color: black;
            font-weight: 800;
        }
        
        /* ==================== MARKET GRID ==================== */
        .market-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius-sm);
            padding: 4px;
            margin-bottom: 20px;
        }
        
        .market-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        
        .market-tab.active {
            background: var(--glass-card);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }
        
        .resource-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 24px;
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 40px;
        }
        
        .resource-option {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            padding: 6px 18px;
            border-radius: 30px;
            transition: all 0.2s;
        }
        
        .resource-option.active {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .resource-option .close-icon {
            color: var(--text-secondary);
            font-size: 14px;
            opacity: 0.7;
        }
        
        .orders-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 30px;
        }
        
        .order-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius-sm);
            padding: 16px;
            border: 1px solid var(--glass-border);
            position: relative;
        }
        
        .order-card.best {
            border: 1px solid var(--accent-green);
            box-shadow: 0 0 15px rgba(0, 208, 156, 0.2);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .order-resource {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 16px;
            font-weight: 700;
        }
        
        .order-badge {
            background: rgba(0, 208, 156, 0.2);
            color: var(--success);
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 20px;
            font-weight: 700;
        }
        
        .order-quantity {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 4px;
        }
        
        .order-total-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--ton-color);
            margin-bottom: 2px;
        }
        
        .order-unit-price {
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
            margin-bottom: 16px;
        }
        
        .order-action {
            width: 100%;
            padding: 12px;
            background: var(--accent-green);
            border: none;
            border-radius: 12px;
            color: black;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .order-action:active {
            transform: scale(0.97);
        }
        
        .create-order-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #9D7BFF, #7B5FFF);
            border: none;
            border-radius: var(--border-radius-sm);
            color: white;
            font-weight: 700;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.2s;
        }
        
        .create-order-btn:active {
            transform: scale(0.98);
        }
        
        /* ==================== DIAMOND ENGINE ==================== */
        .diamond-card {
            background: linear-gradient(135deg, rgba(157, 123, 255, 0.1), rgba(94, 158, 255, 0.1));
            border: 1px solid rgba(157, 123, 255, 0.3);
        }
        
        .production-cost {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin: 20px 0;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius-sm);
        }
        
        .cost-item {
            text-align: center;
        }
        
        .cost-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .cost-amount {
            font-size: 18px;
            font-weight: 700;
        }
        
        .cost-label {
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
        }
        
        .cost-separator {
            font-size: 24px;
            color: var(--text-secondary);
            opacity: 0.5;
        }
        
        .diamond-balance-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(157, 123, 255, 0.1);
            border-radius: var(--border-radius-sm);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(157, 123, 255, 0.3);
        }
        
        .diamond-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .diamond-icon-large {
            width: 60px;
            height: 60px;
            background: rgba(157, 123, 255, 0.2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
        }
        
        .diamond-text {
            display: flex;
            flex-direction: column;
        }
        
        .diamond-label {
            font-size: 14px;
            color: var(--text-secondary);
            opacity: 0.7;
            margin-bottom: 4px;
        }
        
        .diamond-amount {
            font-size: 32px;
            font-weight: 800;
            color: var(--diamond-color);
            line-height: 1;
        }
        
        .diamond-conversion {
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius-sm);
            padding: 20px;
        }
        
        .conversion-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .conversion-price {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }
        
        .price-label {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .price-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--ton-color);
        }
        
        .price-unit {
            font-size: 16px;
            color: var(--text-secondary);
        }
        
        .conversion-input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .conversion-input {
            flex: 1;
            padding: 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-sm);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            font-weight: 600;
        }
        
        .conversion-input:focus {
            outline: none;
            border-color: var(--accent-purple);
        }
        
        /* ==================== HATCH MODAL ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--glass-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 24px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
        }
        
        .hatch-option {
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius-sm);
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--glass-border);
        }
        
        .hatch-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .hatch-icon {
            width: 48px;
            height: 48px;
            background: rgba(0, 208, 156, 0.1);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .hatch-title {
            font-size: 18px;
            font-weight: 700;
        }
        
        .hatch-desc {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        
        .hatch-cost {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        /* ==================== REFERRAL ==================== */
        .referral-card {
            background: linear-gradient(135deg, rgba(0, 208, 156, 0.1), rgba(255, 209, 102, 0.1));
            border: 1px solid rgba(0, 208, 156, 0.3);
        }
        
        .referral-link-box {
            display: flex;
            gap: 8px;
            margin: 20px 0;
        }
        
        .referral-input {
            flex: 1;
            padding: 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-sm);
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }
        
        .referral-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin: 20px 0;
        }
        
        .referral-stat-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius-sm);
            padding: 16px;
            text-align: center;
        }
        
        .referral-stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--accent-green);
            margin-bottom: 4px;
        }
        
        .referral-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* ==================== BOTTOM NAVIGATION ==================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            padding: 12px 16px;
            display: flex;
            justify-content: space-around;
            z-index: 1000;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            padding: 8px 12px;
            border-radius: var(--border-radius-sm);
        }
        
        .nav-item.active {
            color: var(--accent-green);
            background: rgba(0, 208, 156, 0.1);
        }
        
        .nav-icon {
            font-size: 20px;
        }
        
        .nav-text {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* ==================== HELP MODAL ==================== */
        .help-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            background: var(--glass-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 24px;
            z-index: 2001;
            display: none;
            box-shadow: var(--shadow);
        }
        
        .help-modal.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .help-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .help-title {
            font-size: 22px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .help-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
        }
        
        .help-content {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 8px;
        }
        
        .help-section {
            margin-bottom: 20px;
        }
        
        .help-section h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-green);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .help-section p {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        /* ==================== LOADING SCREEN ==================== */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .loading-logo {
            font-size: 72px;
            margin-bottom: 24px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        .loading-title {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .loading-progress {
            width: 240px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 40px;
        }
        
        .loading-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-purple));
            transition: width 0.3s ease;
        }
        
        /* ==================== UTILITY CLASSES ==================== */
        .hidden {
            display: none !important;
        }
        
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        .text-info { color: var(--info); }
        .text-muted { color: var(--text-muted); }
        
        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 12px; }
        .mt-4 { margin-top: 16px; }
        .mt-5 { margin-top: 20px; }
        
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-5 { margin-bottom: 20px; }
        
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        .w-100 { width: 100%; }
        
        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 380px) {
            .status-row.first-row {
                grid-template-columns: 1fr;
            }
            
            .machine-actions {
                flex-direction: column;
            }
            
            .orders-grid {
                grid-template-columns: 1fr;
            }
            
            .referral-stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ==================== LOADING SCREEN ==================== -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">üöú</div>
        <h1 class="loading-title">FARM ECONOMY</h1>
        <div style="color: var(--text-secondary); font-size: 15px; margin-top: 8px;">Loading your farm...</div>
        <div class="loading-progress">
            <div class="loading-bar" id="loadingProgress"></div>
        </div>
    </div>

    <!-- ==================== TOP STATUS BAR - NEW DESIGN ==================== -->
    <div class="status-bar">
        <!-- First Row - Milk, Eggs, Diamond -->
        <div class="status-row first-row">
            <!-- Milk -->
            <div class="status-item">
                <div class="status-header">
                    <i class="fas fa-jug" style="color: #FFFFFF;"></i>
                    <span>Milk</span>
                </div>
                <div class="status-main">
                    <span class="status-balance" id="statusMilkBalance">0</span>
                </div>
                <div class="status-sub">
                    <i class="fas fa-arrow-up"></i>
                    <span id="statusMilkRate">0</span>/h
                </div>
            </div>
            
            <!-- Eggs -->
            <div class="status-item">
                <div class="status-header">
                    <i class="fas fa-egg" style="color: #FFD166;"></i>
                    <span>Eggs</span>
                </div>
                <div class="status-main">
                    <span class="status-balance" id="statusEggsBalance">0</span>
                </div>
                <div class="status-sub">
                    <i class="fas fa-arrow-up"></i>
                    <span id="statusEggsRate">0</span>/h
                </div>
            </div>
            
            <!-- Diamond -->
            <div class="status-item">
                <div class="status-header">
                    <i class="fas fa-gem" style="color: #9D7BFF;"></i>
                    <span>Diamond</span>
                </div>
                <div class="status-main">
                    <span class="status-balance" id="statusDiamondBalance">0</span>
                </div>
                <div class="status-sub">
                    <i class="fas fa-gem"></i>
                </div>
            </div>
        </div>
        
        <!-- Second Row - TON + Actions -->
        <div class="ton-status-row">
            <div class="ton-info">
                <div class="ton-icon">
                    ‚ö°
                </div>
                <div class="ton-details">
                    <span class="ton-label">TON Balance</span>
                    <span class="ton-amount" id="statusTonBalance">0.0000</span>
                </div>
            </div>
            <div class="ton-actions">
                <button class="deposit-btn" onclick="openFinanceTab()">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="help-btn" onclick="toggleHelpModal()">
                    <i class="fas fa-question"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== HELP MODAL ==================== -->
    <div class="help-modal" id="helpModal">
        <div class="help-header">
            <h2 class="help-title">HOW TO PLAY</h2>
            <button class="help-close" onclick="toggleHelpModal()">√ó</button>
        </div>
        <div class="help-content">
            <div class="help-section">
                <h3><i class="fas fa-cow" style="color: var(--accent-green);"></i> COW MACHINE</h3>
                <p>‚Ä¢ Price: 1 TON</p>
                <p>‚Ä¢ Production: 41 Milk/hour</p>
                <p>‚Ä¢ Global Supply: 1000 machines</p>
                <p>‚Ä¢ Each user can buy 1 machine with TON</p>
                <p>‚Ä¢ HATCH: 10,000 Milk ‚Üí 1 Cow Machine (doesn't affect global supply)</p>
            </div>
            
            <div class="help-section">
                <h3><i class="fas fa-egg" style="color: var(--egg-color);"></i> CHICKEN MACHINE</h3>
                <p>‚Ä¢ Unlocks after all 1000 Cows are sold</p>
                <p>‚Ä¢ Price: 1 TON</p>
                <p>‚Ä¢ Production: 41 Eggs/hour</p>
                <p>‚Ä¢ Global Supply: 1000 machines</p>
                <p>‚Ä¢ HATCH: 10,000 Eggs ‚Üí 1 Chicken Machine</p>
            </div>
            
            <div class="help-section">
                <h3><i class="fas fa-gem" style="color: var(--diamond-color);"></i> DIAMOND ENGINE</h3>
                <p>‚Ä¢ Unlocks after all 1000 Chickens are sold</p>
                <p>‚Ä¢ Price: 20 TON</p>
                <p>‚Ä¢ Production: 20,000 Milk + 20,000 Eggs = 1 Diamond</p>
                <p>‚Ä¢ Convert Diamonds to TON at dynamic price</p>
            </div>
            
            <div class="help-section">
                <h3><i class="fas fa-chart-line"></i> P2P MARKET</h3>
                <p>‚Ä¢ Buy and sell Milk & Eggs with other players</p>
                <p>‚Ä¢ You set the price</p>
                <p>‚Ä¢ Orders are matched automatically</p>
                <p>‚Ä¢ Best price orders appear first</p>
            </div>
            
            <div class="help-section">
                <h3><i class="fas fa-users"></i> REFERRAL SYSTEM</h3>
                <p>‚Ä¢ Earn 10% commission on every TON purchase made by your friends</p>
                <p>‚Ä¢ Share your referral link</p>
                <p>‚Ä¢ Commission is added directly to your TON balance</p>
            </div>
            
            <div class="help-section">
                <h3><i class="fas fa-clock"></i> PRODUCTION SYSTEM</h3>
                <p>‚Ä¢ Production is calculated automatically based on time passed</p>
                <p>‚Ä¢ No limits, no daily caps</p>
                <p>‚Ä¢ Resources accumulate even when offline</p>
            </div>
        </div>
    </div>

    <!-- ==================== MAIN CONTAINER ==================== -->
    <div class="app-container" id="appContainer" style="display: none;">
        
        <!-- ==================== HOME / FARM TAB ==================== -->
        <div id="homeTab" class="content-section active">
            <!-- COW MACHINE CARD -->
            <div class="machine-card" id="cowMachineCard">
                <div class="machine-header">
                    <div class="machine-icon cow">
                        üêÆ
                    </div>
                    <div class="machine-info">
                        <div class="machine-name-row">
                            <span class="machine-name">Cow Machine</span>
                            <span class="machine-badge" id="cowBadge">Available</span>
                        </div>
                        <div class="machine-price">
                            <i class="fas fa-bolt"></i> 1 TON
                        </div>
                    </div>
                </div>
                
                <div class="machine-stats">
                    <div class="machine-stat">
                        <div class="machine-stat-label">Production</div>
                        <div class="machine-stat-value">41 ü•õ/h</div>
                    </div>
                    <div class="machine-stat">
                        <div class="machine-stat-label">Owned</div>
                        <div class="machine-stat-value" id="cowsOwned">0</div>
                    </div>
                </div>
                
                <div class="machine-progress">
                    <div class="progress-header">
                        <span>Global Supply</span>
                        <span id="cowProgressText">0/1000</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-fill" id="cowProgressFill" style="width: 0%;"></div>
                    </div>
                </div>
                
                <div class="machine-actions">
                    <button class="btn btn-primary" id="buyCowBtn" onclick="buyCow()">
                        <i class="fas fa-shopping-cart"></i>
                        BUY
                    </button>
                    <button class="btn btn-hatch" id="hatchCowBtn" onclick="openHatchModal('cow')" disabled>
                        <i class="fas fa-egg"></i>
                        HATCH
                    </button>
                </div>
            </div>
            
            <!-- CHICKEN MACHINE CARD -->
            <div class="machine-card" id="chickenMachineCard">
                <div class="machine-header">
                    <div class="machine-icon chicken">
                        üêî
                    </div>
                    <div class="machine-info">
                        <div class="machine-name-row">
                            <span class="machine-name">Chicken Machine</span>
                            <span class="machine-badge" id="chickenBadge">Locked</span>
                        </div>
                        <div class="machine-price">
                            <i class="fas fa-bolt"></i> 1 TON
                        </div>
                    </div>
                </div>
                
                <div class="machine-stats">
                    <div class="machine-stat">
                        <div class="machine-stat-label">Production</div>
                        <div class="machine-stat-value">41 ü•ö/h</div>
                    </div>
                    <div class="machine-stat">
                        <div class="machine-stat-label">Owned</div>
                        <div class="machine-stat-value" id="chickensOwned">0</div>
                    </div>
                </div>
                
                <div class="machine-progress">
                    <div class="progress-header">
                        <span>Global Supply</span>
                        <span id="chickenProgressText">0/1000</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-fill" id="chickenProgressFill" style="width: 0%;"></div>
                    </div>
                </div>
                
                <div class="machine-actions">
                    <button class="btn btn-primary" id="buyChickenBtn" onclick="buyChicken()" disabled>
                        <i class="fas fa-lock"></i>
                        BUY
                    </button>
                    <button class="btn btn-hatch" id="hatchChickenBtn" onclick="openHatchModal('chicken')" disabled>
                        <i class="fas fa-egg"></i>
                        HATCH
                    </button>
                </div>
                
                <div id="chickenLockMessage" style="display: none; margin-top: 12px; padding: 12px; background: rgba(255, 209, 102, 0.1); border-radius: 12px; border: 1px solid rgba(255, 209, 102, 0.2); text-align: center; font-size: 13px;">
                    <i class="fas fa-lock" style="color: var(--warning);"></i> Unlocks after Cow batch ends (1000 cows sold)
                </div>
            </div>
            
            <!-- DIAMOND ENGINE CARD -->
            <div class="machine-card diamond-card" id="diamondEngineCard">
                <div class="machine-header">
                    <div class="machine-icon diamond">
                        üíé
                    </div>
                    <div class="machine-info">
                        <div class="machine-name-row">
                            <span class="machine-name">Diamond Engine</span>
                            <span class="machine-badge" id="diamondBadge">Locked</span>
                        </div>
                        <div class="machine-price">
                            <i class="fas fa-bolt"></i> 20 TON
                        </div>
                    </div>
                </div>
                
                <div class="production-cost">
                    <div class="cost-item">
                        <div class="cost-icon">ü•õ</div>
                        <div class="cost-amount" id="diamondCostMilk">20,000</div>
                        <div class="cost-label">Milk</div>
                    </div>
                    <div class="cost-separator">+</div>
                    <div class="cost-item">
                        <div class="cost-icon">ü•ö</div>
                        <div class="cost-amount" id="diamondCostEggs">20,000</div>
                        <div class="cost-label">Eggs</div>
                    </div>
                    <div class="cost-separator">=</div>
                    <div class="cost-item">
                        <div class="cost-icon">üíé</div>
                        <div class="cost-amount">1</div>
                        <div class="cost-label">Diamond</div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin: 16px 0; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                    <div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Owned</div>
                        <div style="font-size: 20px; font-weight: 700;" id="diamondEnginesOwned">0</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Price</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--ton-color);">20 TON</div>
                    </div>
                </div>
                
                <div class="machine-actions">
                    <button class="btn btn-primary" id="buyDiamondBtn" onclick="buyDiamondEngine()" disabled>
                        <i class="fas fa-lock"></i>
                        BUY
                    </button>
                    <button class="btn btn-hatch" id="startDiamondBtn" onclick="startDiamondProduction()" disabled>
                        <i class="fas fa-play"></i>
                        PRODUCE
                    </button>
                </div>
                
                <div id="diamondLockMessage" style="display: none; margin-top: 12px; padding: 12px; background: rgba(157, 123, 255, 0.1); border-radius: 12px; border: 1px solid rgba(157, 123, 255, 0.2); text-align: center; font-size: 13px;">
                    <i class="fas fa-lock" style="color: var(--diamond-color);"></i> Unlocks after all Cows & Chickens are sold
                </div>
            </div>
        </div>
        
        <!-- ==================== MARKET TAB ==================== -->
        <div id="marketTab" class="content-section">
            <div class="glass-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-chart-line" style="color: var(--accent-green);"></i>
                        P2P MARKET
                    </h2>
                </div>
                
                <!-- Market Tabs -->
                <div class="market-tabs">
                    <div class="market-tab active" onclick="switchMarketTab('market')">MARKET</div>
                    <div class="market-tab" onclick="switchMarketTab('my')">MY ORDERS</div>
                </div>
                
                <!-- Resource Toggle -->
                <div class="resource-toggle" id="resourceToggle">
                    <div class="resource-option active" data-resource="milk" onclick="switchResource('milk')">
                        ü•õ Milk
                        <span class="close-icon" onclick="event.stopPropagation(); switchToEggs()">‚úï</span>
                    </div>
                    <div class="resource-option" data-resource="eggs" onclick="switchResource('eggs')">
                        ü•ö Eggs
                        <span class="close-icon" onclick="event.stopPropagation(); switchToMilk()">‚úï</span>
                    </div>
                </div>
                
                <!-- MARKET SECTION -->
                <div id="marketSection">
                    <!-- Orders Grid -->
                    <div id="ordersContainer">
                        <div class="orders-grid" id="sellOrdersGrid">
                            <!-- Sell orders will be populated here -->
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--text-secondary); background: rgba(0,0,0,0.2); border-radius: 16px;">
                                <i class="fas fa-inbox" style="font-size: 40px; margin-bottom: 12px; opacity: 0.5;"></i>
                                <p style="font-size: 15px;">No active orders</p>
                                <p style="font-size: 13px; margin-top: 8px;">Be the first to create an order</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Create Order Button -->
                    <button class="create-order-btn" onclick="openCreateOrderModal()">
                        <i class="fas fa-plus-circle"></i>
                        CREATE ORDER
                    </button>
                </div>
                
                <!-- MY ORDERS SECTION -->
                <div id="myOrdersSection" style="display: none;">
                    <div id="myOrdersList">
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary); background: rgba(0,0,0,0.2); border-radius: 16px;">
                            <i class="fas fa-clipboard-list" style="font-size: 40px; margin-bottom: 12px; opacity: 0.5;"></i>
                            <p style="font-size: 15px;">No active orders</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== DIAMOND TAB ==================== -->
        <div id="diamondTab" class="content-section">
            <!-- Diamond Balance Card -->
            <div class="diamond-balance-card">
                <div class="diamond-info">
                    <div class="diamond-icon-large">
                        üíé
                    </div>
                    <div class="diamond-text">
                        <span class="diamond-label">Your Diamonds</span>
                        <span class="diamond-amount" id="diamondBalance">0</span>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 12px; color: var(--text-secondary);">Price</div>
                    <div style="font-size: 24px; font-weight: 800; color: var(--ton-color);" id="diamondPrice">5</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">TON each</div>
                </div>
            </div>
            
            <!-- Conversion Card -->
            <div class="glass-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-exchange-alt"></i>
                        Convert to TON
                    </h2>
                </div>
                
                <div class="conversion-row">
                    <div class="conversion-price">
                        <span class="price-label">Current rate:</span>
                        <span class="price-value" id="conversionRate">5</span>
                        <span class="price-unit">TON / üíé</span>
                    </div>
                </div>
                
                <div class="conversion-input-group">
                    <input type="number" id="convertAmount" class="conversion-input" placeholder="Amount" min="1" step="1" value="1">
                    <button class="btn btn-primary" onclick="convertDiamond()" style="flex: 0.4; padding: 16px;">
                        CONVERT
                    </button>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 8px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                    <span style="color: var(--text-secondary);">You will receive:</span>
                    <span style="font-size: 18px; font-weight: 700; color: var(--ton-color);" id="tonReceivePreview">0.0000 TON</span>
                </div>
            </div>
            
            <!-- Production History -->
            <div class="glass-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-history"></i>
                        Production History
                    </h2>
                </div>
                <div id="diamondHistoryList">
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-clock" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                        <p>No production history yet</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== FRIENDS TAB ==================== -->
        <div id="friendsTab" class="content-section">
            <div class="glass-card referral-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-users"></i>
                        REFERRAL PROGRAM
                    </h2>
                </div>
                
                <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
                    Invite friends and earn <strong style="color: var(--accent-green); font-size: 18px;">10%</strong> commission on every TON purchase they make!
                </p>
                
                <div class="referral-link-box">
                    <input type="text" id="referralLink" class="referral-input" readonly value="Loading...">
                    <button class="btn btn-primary" onclick="copyReferralLink()" style="flex: 0.2; padding: 0;">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                
                <div class="referral-stats-grid">
                    <div class="referral-stat-item">
                        <div class="referral-stat-value" id="totalReferrals">0</div>
                        <div class="referral-stat-label">Friends</div>
                    </div>
                    <div class="referral-stat-item">
                        <div class="referral-stat-value" id="referralEarnings">0</div>
                        <div class="referral-stat-label">Earned (TON)</div>
                    </div>
                    <div class="referral-stat-item">
                        <div class="referral-stat-value" id="referralCommission">10</div>
                        <div class="referral-stat-label">Commission</div>
                    </div>
                </div>
                
                <button class="btn btn-primary w-100" id="claimReferralBtn" onclick="claimReferralEarnings()" style="margin-top: 16px;" disabled>
                    <i class="fas fa-hand-holding-usd"></i>
                    CLAIM EARNINGS
                </button>
            </div>
            
            <div class="glass-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-trophy"></i>
                        Recent Referrals
                    </h2>
                </div>
                <div id="recentReferralsList">
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-user-friends" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                        <p>No referrals yet</p>
                        <p style="font-size: 12px; margin-top: 8px;">Share your link to start earning</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== PROFILE TAB ==================== -->
        <div id="profileTab" class="content-section">
            <div class="glass-card">
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                    <div style="width: 64px; height: 64px; background: linear-gradient(135deg, var(--accent-green), var(--accent-purple)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px;">
                        üë®‚Äçüåæ
                    </div>
                    <div>
                        <div style="font-size: 22px; font-weight: 800;" id="profileName">Farmer</div>
                        <div style="font-size: 14px; color: var(--text-secondary);" id="profileUsername">@username</div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;" id="profileUserId">ID: </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 16px;">
                        <div style="font-size: 12px; color: var(--text-secondary);">Total Machines</div>
                        <div style="font-size: 28px; font-weight: 800;" id="totalMachines">0</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 16px;">
                        <div style="font-size: 12px; color: var(--text-secondary);">Production</div>
                        <div style="font-size: 28px; font-weight: 800;" id="totalProduction">0/h</div>
                    </div>
                </div>
            </div>
            
            <div class="glass-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-boxes"></i>
                        Your Resources
                    </h2>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px;">
                                ü•õ
                            </div>
                            <div>
                                <div style="font-weight: 700;">Milk</div>
                                <div style="font-size: 11px; color: var(--text-secondary);" id="profileMilkRate">0/h</div>
                            </div>
                        </div>
                        <div style="font-size: 24px; font-weight: 800;" id="profileMilk">0</div>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px;">
                                ü•ö
                            </div>
                            <div>
                                <div style="font-weight: 700;">Eggs</div>
                                <div style="font-size: 11px; color: var(--text-secondary);" id="profileEggsRate">0/h</div>
                            </div>
                        </div>
                        <div style="font-size: 24px; font-weight: 800;" id="profileEggs">0</div>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px;">
                                üíé
                            </div>
                            <div>
                                <div style="font-weight: 700;">Diamond</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">1 = <span id="profileDiamondPrice">5</span> TON</div>
                            </div>
                        </div>
                        <div style="font-size: 24px; font-weight: 800;" id="profileDiamond">0</div>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px;">
                                ‚ö°
                            </div>
                            <div>
                                <div style="font-weight: 700;">TON</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Balance</div>
                            </div>
                        </div>
                        <div style="font-size: 24px; font-weight: 800;" id="profileTon">0.0000</div>
                    </div>
                </div>
            </div>
            
            <div class="glass-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-robot"></i>
                        Your Machines
                    </h2>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 44px; height: 44px; background: rgba(109, 76, 65, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px;">
                                üêÆ
                            </div>
                            <div>
                                <div style="font-weight: 700;">Cow Machines</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">41 Milk/h each</div>
                            </div>
                        </div>
                        <div style="font-size: 24px; font-weight: 800;" id="profileCows">0</div>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 44px; height: 44px; background: rgba(255, 209, 102, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px;">
                                üêî
                            </div>
                            <div>
                                <div style="font-weight: 700;">Chicken Machines</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">41 Eggs/h each</div>
                            </div>
                        </div>
                        <div style="font-size: 24px; font-weight: 800;" id="profileChickens">0</div>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 44px; height: 44px; background: rgba(157, 123, 255, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px;">
                                üíé
                            </div>
                            <div>
                                <div style="font-weight: 700;">Diamond Engines</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">20k Milk + 20k Eggs ‚Üí 1 üíé</div>
                            </div>
                        </div>
                        <div style="font-size: 24px; font-weight: 800;" id="profileDiamondEngines">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== FINANCE / DEPOSIT TAB ==================== -->
        <div id="financeTab" class="content-section">
            <div class="glass-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-arrow-down"></i>
                        Deposit TON
                    </h2>
                </div>
                
                <!-- Wallet Connection -->
                <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 16px; border-radius: 16px; margin-bottom: 20px;">
                    <div>
                        <div style="font-size: 14px; font-weight: 600;">Wallet</div>
                        <div style="font-size: 12px; color: var(--text-secondary);" id="walletAddress">Not connected</div>
                    </div>
                    <button class="btn btn-primary" onclick="connectWallet()" id="connectWalletBtn" style="width: auto; padding: 12px 20px;">
                        <i class="fas fa-plug"></i> Connect
                    </button>
                </div>
                
                <!-- Deposit Form -->
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                        Amount (TON)
                    </label>
                    <input type="number" id="depositAmount" class="conversion-input" placeholder="0.1" step="0.1" min="0.1" value="0.1">
                </div>
                
                <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-outline" style="flex: 1; padding: 12px;" onclick="setDepositAmount(0.5)">0.5</button>
                    <button class="btn btn-outline" style="flex: 1; padding: 12px;" onclick="setDepositAmount(1)">1</button>
                    <button class="btn btn-outline" style="flex: 1; padding: 12px;" onclick="setDepositAmount(2)">2</button>
                    <button class="btn btn-outline" style="flex: 1; padding: 12px;" onclick="setDepositAmount(5)">5</button>
                    <button class="btn btn-outline" style="flex: 1; padding: 12px;" onclick="setDepositAmount(10)">10</button>
                </div>
                
                <!-- Important Note -->
                <div style="background: rgba(94, 158, 255, 0.1); border: 1px solid rgba(94, 158, 255, 0.3); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-info-circle" style="color: var(--info); font-size: 18px;"></i>
                        <span style="font-size: 13px; color: var(--text-secondary);">
                            Your User ID <strong style="color: white;" id="depositUserId">123456789</strong> will be automatically added as the transaction comment.
                        </span>
                    </div>
                </div>
                
                <button class="btn btn-primary w-100" onclick="initiateDeposit()" id="depositBtn" disabled style="padding: 16px; font-size: 16px;">
                    <i class="fas fa-arrow-down"></i>
                    DEPOSIT TON
                </button>
                
                <!-- Transaction Status -->
                <div id="depositStatusContainer" style="margin-top: 20px; display: none;">
                    <div style="background: rgba(0, 208, 156, 0.1); border: 1px solid rgba(0, 208, 156, 0.3); border-radius: 12px; padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="width: 40px; height: 40px; background: rgba(0, 208, 156, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-check-circle" style="color: var(--success); font-size: 20px;"></i>
                            </div>
                            <div>
                                <div style="font-weight: 700;" id="depositStatusTitle">Transaction Sent!</div>
                                <div style="font-size: 12px; color: var(--text-secondary);" id="depositStatusMessage">Balance will be credited within 1-3 minutes.</div>
                            </div>
                        </div>
                        <div style="font-size: 11px; color: var(--text-muted); text-align: center; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);" id="depositTxHash">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="glass-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-arrow-up"></i>
                        Withdraw TON
                    </h2>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                        Amount (Minimum 0.5 TON)
                    </label>
                    <input type="number" id="withdrawAmount" class="conversion-input" placeholder="0.5" step="0.1" min="0.5">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                        TON Wallet Address
                    </label>
                    <input type="text" id="withdrawAddress" class="conversion-input" placeholder="EQD...">
                </div>
                
                <div style="background: rgba(255, 209, 102, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--text-secondary);">Fee (5%):</span>
                        <span style="font-weight: 600;" id="withdrawFee">0.0000 TON</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 16px;">
                        <span style="font-weight: 700;">You receive:</span>
                        <span style="font-weight: 800; color: var(--ton-color);" id="withdrawNet">0.0000 TON</span>
                    </div>
                </div>
                
                <button class="btn btn-primary w-100" onclick="withdrawTON()" style="padding: 16px;">
                    <i class="fas fa-paper-plane"></i>
                    WITHDRAW TON
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== BOTTOM NAVIGATION ==================== -->
    <nav class="bottom-nav">
        <div class="nav-item active" data-tab="homeTab" onclick="switchTab('homeTab')">
            <div class="nav-icon">üöú</div>
            <div class="nav-text">FARM</div>
        </div>
        <div class="nav-item" data-tab="marketTab" onclick="switchTab('marketTab')">
            <div class="nav-icon">üìä</div>
            <div class="nav-text">MARKET</div>
        </div>
        <div class="nav-item" data-tab="diamondTab" onclick="switchTab('diamondTab')">
            <div class="nav-icon">üíé</div>
            <div class="nav-text">DIAMOND</div>
        </div>
        <div class="nav-item" data-tab="friendsTab" onclick="switchTab('friendsTab')">
            <div class="nav-icon">üë•</div>
            <div class="nav-text">FRIENDS</div>
        </div>
        <div class="nav-item" data-tab="profileTab" onclick="switchTab('profileTab')">
            <div class="nav-icon">üë§</div>
            <div class="nav-text">PROFILE</div>
        </div>
        <div class="nav-item" data-tab="financeTab" onclick="switchTab('financeTab')">
            <div class="nav-icon">üí∞</div>
            <div class="nav-text">WALLET</div>
        </div>
    </nav>

    <!-- ==================== CREATE ORDER MODAL ==================== -->
    <div class="modal-overlay" id="createOrderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-plus-circle" style="color: var(--accent-green);"></i>
                    Create Order
                </h3>
                <button class="modal-close" onclick="closeCreateOrderModal()">√ó</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <button class="btn" id="orderTypeBuyBtn" onclick="setOrderType('buy')" style="flex: 1; background: rgba(0, 208, 156, 0.2); color: var(--success); border: 1px solid var(--success);">
                        BUY
                    </button>
                    <button class="btn" id="orderTypeSellBtn" onclick="setOrderType('sell')" style="flex: 1;">
                        SELL
                    </button>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                        Resource
                    </label>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn" id="orderResourceMilkBtn" onclick="setOrderResource('milk')" style="flex: 1; background: rgba(0, 208, 156, 0.2); border: 1px solid var(--success);">
                            ü•õ Milk
                        </button>
                        <button class="btn" id="orderResourceEggsBtn" onclick="setOrderResource('eggs')" style="flex: 1;">
                            ü•ö Eggs
                        </button>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                        Quantity
                    </label>
                    <input type="number" id="orderQuantity" class="conversion-input" placeholder="Min 100" min="100" step="1">
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-outline" style="flex: 1; padding: 10px;" onclick="setOrderQuantityPercent(25)">25%</button>
                        <button class="btn btn-outline" style="flex: 1; padding: 10px;" onclick="setOrderQuantityPercent(50)">50%</button>
                        <button class="btn btn-outline" style="flex: 1; padding: 10px;" onclick="setOrderQuantityPercent(75)">75%</button>
                        <button class="btn btn-outline" style="flex: 1; padding: 10px;" onclick="setOrderQuantityMax()">MAX</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                        Price per unit (TON)
                    </label>
                    <input type="number" id="orderPrice" class="conversion-input" placeholder="0.01" step="0.0001" min="0.0001">
                </div>
                
                <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--text-secondary);">Available:</span>
                        <span style="font-weight: 700;" id="orderAvailableBalance">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Best price:</span>
                        <span style="font-weight: 700; color: var(--accent-green);" id="orderBestPrice">0.0000 TON</span>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary w-100" onclick="createOrder()" style="padding: 16px;" id="createOrderSubmitBtn">
                <i class="fas fa-check-circle"></i>
                PLACE ORDER
            </button>
        </div>
    </div>

    <!-- ==================== HATCH MODAL ==================== -->
    <div class="modal-overlay" id="hatchModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-egg" style="color: var(--warning);"></i>
                    HATCH MACHINE
                </h3>
                <button class="modal-close" onclick="closeHatchModal()">√ó</button>
            </div>
            
            <div id="hatchCowOption" class="hatch-option">
                <div class="hatch-header">
                    <div class="hatch-icon">
                        üêÆ
                    </div>
                    <div>
                        <div class="hatch-title">Cow Machine</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">10,000 Milk ‚Üí 1 Cow</div>
                    </div>
                </div>
                <div class="hatch-desc">
                    Hatching does NOT affect global supply. You can hatch unlimited machines.
                </div>
                <div class="hatch-cost">
                    <span>Your Milk:</span>
                    <span style="font-weight: 800; color: var(--milk-color);" id="hatchCowMilkBalance">0</span>
                </div>
                <button class="btn btn-hatch w-100" onclick="hatchCow()" id="hatchCowBtn">
                    HATCH COW
                </button>
            </div>
            
            <div id="hatchChickenOption" class="hatch-option">
                <div class="hatch-header">
                    <div class="hatch-icon">
                        üêî
                    </div>
                    <div>
                        <div class="hatch-title">Chicken Machine</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">10,000 Eggs ‚Üí 1 Chicken</div>
                    </div>
                </div>
                <div class="hatch-desc">
                    Hatching does NOT affect global supply. You can hatch unlimited machines.
                </div>
                <div class="hatch-cost">
                    <span>Your Eggs:</span>
                    <span style="font-weight: 800; color: var(--egg-color);" id="hatchChickenEggsBalance">0</span>
                </div>
                <button class="btn btn-hatch w-100" onclick="hatchChicken()" id="hatchChickenBtn">
                    HATCH CHICKEN
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== TRANSACTION SUCCESS MODAL ==================== -->
    <div class="modal-overlay" id="successModal">
        <div class="modal-content" style="text-align: center;">
            <div style="font-size: 64px; margin-bottom: 16px;">‚úÖ</div>
            <h3 style="font-size: 22px; margin-bottom: 12px;" id="successModalTitle">Transaction Sent!</h3>
            <p style="color: var(--text-secondary); margin-bottom: 24px;" id="successModalMessage">Your balance will be credited within 1-3 minutes.</p>
            <button class="btn btn-primary" onclick="closeSuccessModal()" style="padding: 14px 30px;">OK</button>
        </div>
    </div>

    <script>
        // ==============================================
        // FARM ECONOMY - COMPLETE FRONTEND CODE
        // ŸÖÿπ ÿ•ÿµŸÑÿßÿ≠ ŸÜŸáÿßÿ¶Ÿä ŸÑŸÖÿ¥ŸÉŸÑÿ© TON Connect Payload
        // ==============================================
        
        // ---------- CONFIGURATION ----------
        const API_BASE = 'https://silent-block-bedf.ahmedrabieharoun.workers.dev';
        const TON_DEPOSIT_ADDRESS = 'UQBnwSS4Kox3ZZmF69KxWLfvfCc2-dLV8sT5nJe-aV7HfCyG';
        const TELEGRAM_BOT_USERNAME = '@testtt1257bot';
        
        // ---------- GAME CONSTANTS ----------
        const GAME_CONSTANTS = {
            COW_PRICE: 1,
            COW_GLOBAL_CAP: 1000,
            COW_PRODUCTION_RATE: 41,
            COW_HATCH_COST: 10000,
            
            CHICKEN_PRICE: 1,
            CHICKEN_GLOBAL_CAP: 1000,
            CHICKEN_PRODUCTION_RATE: 41,
            CHICKEN_HATCH_COST: 10000,
            
            DIAMOND_ENGINE_PRICE: 20,
            DIAMOND_PRODUCTION_COST_MILK: 20000,
            DIAMOND_PRODUCTION_COST_EGGS: 20000,
            DIAMOND_PRODUCTION_YIELD: 1,
            
            MIN_ORDER_AMOUNT: 100,
            MIN_DEPOSIT_AMOUNT: 0.1,
            MIN_WITHDRAW_AMOUNT: 0.5,
            WITHDRAW_FEE_PERCENT: 5,
            REFERRAL_REWARD_PERCENT: 10
        };
        
        // ---------- GLOBAL STATE ----------
        let gameState = {
            user: {
                id: '',
                tonBalance: 0,
                milk: 0,
                eggs: 0,
                diamond: 0,
                cows_owned: 0,
                chickens_owned: 0,
                diamond_engines_owned: 0,
                milkPerHour: 0,
                eggsPerHour: 0,
                referralCode: '',
                referredBy: null,
                referralEarnings: 0,
                referralEarningsClaimed: 0,
                lastProductionTimestamp: Date.now()
            },
            global: {
                cows_sold: 0,
                cows_cap: 1000,
                chickens_sold: 0,
                chickens_cap: 1000,
                chicken_unlocked: false,
                diamond_unlocked: false,
                diamond_price: 5
            },
            market: {
                milk: { sellOrders: [], buyOrders: [] },
                eggs: { sellOrders: [], buyOrders: [] }
            },
            referral: {
                totalReferrals: 0,
                totalRewards: 0,
                referralList: []
            }
        };
        
        // ---------- UI STATE ----------
        let USER_ID = '';
        let TELEGRAM_DATA = '';
        let connectedWallet = null;
        let tonConnectUI = null;
        let currentResource = 'milk';
        let currentMarketTab = 'market';
        let currentOrderType = 'buy';
        let currentOrderResource = 'milk';
        let telegramUser = null;
        let tonwebInstance = null;
        
        // ---------- TELEGRAM AUTH ----------
        async function setupTelegramAuth() {
            console.log('Setting up Telegram auth...');
            
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.enableClosingConfirmation();
                
                if (window.Telegram.WebApp.initData) {
                    TELEGRAM_DATA = window.Telegram.WebApp.initData;
                }
                
                const initData = new URLSearchParams(TELEGRAM_DATA);
                const userParam = initData.get('user');
                
                if (userParam) {
                    try {
                        telegramUser = JSON.parse(decodeURIComponent(userParam));
                        USER_ID = String(telegramUser.id);
                        
                        document.getElementById('profileName').textContent = 
                            `${telegramUser.first_name || ''} ${telegramUser.last_name || ''}`.trim() || 'Farmer';
                        document.getElementById('profileUsername').textContent = 
                            telegramUser.username ? `@${telegramUser.username}` : 'User';
                        document.getElementById('profileUserId').textContent = `ID: ${USER_ID}`;
                        document.getElementById('depositUserId').textContent = USER_ID;
                        
                        console.log('Telegram user:', telegramUser);
                        return telegramUser;
                    } catch (error) {
                        console.error('Failed to parse Telegram user:', error);
                    }
                }
            }
            
            // Demo mode
            USER_ID = 'demo_' + Math.floor(Math.random() * 1000000);
            document.getElementById('profileName').textContent = 'Demo Farmer';
            document.getElementById('profileUsername').textContent = '@demo';
            document.getElementById('profileUserId').textContent = `ID: ${USER_ID}`;
            document.getElementById('depositUserId').textContent = USER_ID;
            
            return { id: USER_ID, first_name: 'Demo', last_name: 'Farmer' };
        }
        
        // ---------- GET REFERRER FROM STARTAPP ----------
        function getReferrerFromStartParam() {
            try {
                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
                    const startParam = window.Telegram.WebApp.initDataUnsafe.start_param;
                    console.log('Start param:', startParam);
                    
                    if (startParam && startParam.startsWith('ref_')) {
                        return startParam.replace('ref_', '');
                    }
                }
            } catch (error) {
                console.error('Error getting referrer:', error);
            }
            return null;
        }
        
        // ---------- API CALLS ----------
        async function callAPI(action, data = {}) {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    'X-Action': action
                };
                
                if (TELEGRAM_DATA) {
                    headers['Authorization'] = `Telegram ${TELEGRAM_DATA}`;
                }
                
                const response = await fetch(`${API_BASE}/api`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ action, data })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    return result.data;
                } else {
                    console.error(`API Error: ${result.error}`);
                    alert(result.error || 'Transaction failed');
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }
        
        // ---------- LOAD GAME STATE ----------
        async function loadGameState() {
            try {
                const data = await callAPI('getState');
                gameState = data;
                
                // Calculate production based on time passed
                calculateProduction();
                
                updateUI();
                updateMarketUI();
                updateReferralUI();
                
                console.log('Game state loaded:', gameState);
            } catch (error) {
                console.error('Failed to load game state:', error);
            }
        }
        
        // ---------- PRODUCTION CALCULATION (NO CRON) ----------
        function calculateProduction() {
            const now = Date.now();
            const lastProduction = gameState.user.lastProductionTimestamp || now;
            
            // Hours passed since last production
            const hoursPassed = Math.floor((now - lastProduction) / (60 * 60 * 1000));
            
            if (hoursPassed > 0) {
                // Calculate resources produced
                const milkProduced = (gameState.user.cows_owned || 0) * GAME_CONSTANTS.COW_PRODUCTION_RATE * hoursPassed;
                const eggsProduced = (gameState.user.chickens_owned || 0) * GAME_CONSTANTS.CHICKEN_PRODUCTION_RATE * hoursPassed;
                
                // Update balances
                gameState.user.milk = (gameState.user.milk || 0) + milkProduced;
                gameState.user.eggs = (gameState.user.eggs || 0) + eggsProduced;
                
                // Update timestamp
                gameState.user.lastProductionTimestamp = lastProduction + (hoursPassed * 60 * 60 * 1000);
                
                console.log(`Production calculated: +${milkProduced} Milk, +${eggsProduced} Eggs (${hoursPassed} hours)`);
            }
            
            // Update production rates
            gameState.user.milkPerHour = (gameState.user.cows_owned || 0) * GAME_CONSTANTS.COW_PRODUCTION_RATE;
            gameState.user.eggsPerHour = (gameState.user.chickens_owned || 0) * GAME_CONSTANTS.CHICKEN_PRODUCTION_RATE;
        }
        
        // ---------- MACHINE PURCHASES ----------
        async function buyCow() {
            try {
                const referredBy = getReferrerFromStartParam();
                const data = await callAPI('buyCow', { referredBy });
                
                gameState.user.cows_owned = 1;
                gameState.user.tonBalance = data.newTonBalance;
                gameState.global.cows_sold = data.cows_sold;
                gameState.global.chicken_unlocked = data.chicken_unlocked;
                
                updateUI();
                showSuccess('Cow Machine Purchased!', 'You now produce 41 Milk per hour.');
            } catch (error) {
                console.error('Buy cow failed:', error);
            }
        }
        
        async function buyChicken() {
            try {
                const data = await callAPI('buyChicken', {});
                
                gameState.user.chickens_owned = 1;
                gameState.user.tonBalance = data.newTonBalance;
                gameState.global.chickens_sold = data.chickens_sold;
                gameState.global.diamond_unlocked = data.diamond_unlocked;
                
                updateUI();
                showSuccess('Chicken Machine Purchased!', 'You now produce 41 Eggs per hour.');
            } catch (error) {
                console.error('Buy chicken failed:', error);
            }
        }
        
        async function buyDiamondEngine() {
            try {
                const data = await callAPI('buyDiamondEngine', {});
                
                gameState.user.diamond_engines_owned = 1;
                gameState.user.tonBalance = data.newTonBalance;
                
                updateUI();
                showSuccess('Diamond Engine Purchased!', 'You can now produce Diamonds.');
            } catch (error) {
                console.error('Buy diamond engine failed:', error);
            }
        }
        
        // ---------- HATCH SYSTEM ----------
        async function hatchCow() {
            try {
                const data = await callAPI('hatchCow', {});
                
                gameState.user.cows_owned = data.newCowsOwned;
                gameState.user.milk = data.newMilkBalance;
                
                updateUI();
                closeHatchModal();
                showSuccess('Hatch Successful!', 'You hatched a new Cow Machine.');
            } catch (error) {
                console.error('Hatch cow failed:', error);
                alert(error.message);
            }
        }
        
        async function hatchChicken() {
            try {
                const data = await callAPI('hatchChicken', {});
                
                gameState.user.chickens_owned = data.newChickensOwned;
                gameState.user.eggs = data.newEggsBalance;
                
                updateUI();
                closeHatchModal();
                showSuccess('Hatch Successful!', 'You hatched a new Chicken Machine.');
            } catch (error) {
                console.error('Hatch chicken failed:', error);
                alert(error.message);
            }
        }
        
        function openHatchModal(type) {
            const modal = document.getElementById('hatchModal');
            
            // Update balances
            document.getElementById('hatchCowMilkBalance').textContent = formatNumber(gameState.user.milk);
            document.getElementById('hatchChickenEggsBalance').textContent = formatNumber(gameState.user.eggs);
            
            // Show both options
            document.getElementById('hatchCowOption').style.display = 'block';
            document.getElementById('hatchChickenOption').style.display = 'block';
            
            modal.classList.add('active');
        }
        
        function closeHatchModal() {
            document.getElementById('hatchModal').classList.remove('active');
        }
        
        // ---------- DIAMOND PRODUCTION ----------
        async function startDiamondProduction() {
            try {
                const data = await callAPI('startDiamondProduction', {});
                
                gameState.user.milk = data.newMilk;
                gameState.user.eggs = data.newEggs;
                gameState.user.diamond = data.newDiamond;
                
                updateUI();
                showSuccess('Production Successful!', 'You produced 1 Diamond.');
            } catch (error) {
                console.error('Diamond production failed:', error);
                alert(error.message);
            }
        }
        
        // ---------- DIAMOND CONVERSION ----------
        async function convertDiamond() {
            const amount = parseInt(document.getElementById('convertAmount').value);
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            if (amount > gameState.user.diamond) {
                alert('Insufficient diamonds');
                return;
            }
            
            try {
                const data = await callAPI('convertDiamond', { amount });
                
                gameState.user.diamond = data.newDiamond;
                gameState.user.tonBalance = data.newTonBalance;
                
                updateUI();
                document.getElementById('convertAmount').value = '1';
                
                showSuccess('Conversion Successful!', `${data.diamondsConverted} Diamond ‚Üí ${data.tonReceived} TON`);
            } catch (error) {
                console.error('Diamond conversion failed:', error);
            }
        }
        
        // ---------- MARKET ORDERS ----------
        async function createOrder() {
            const type = currentOrderType;
            const resource = currentOrderResource;
            const quantity = parseInt(document.getElementById('orderQuantity').value);
            const price = parseFloat(document.getElementById('orderPrice').value);
            
            if (!quantity || quantity < GAME_CONSTANTS.MIN_ORDER_AMOUNT) {
                alert(`Minimum order quantity is ${GAME_CONSTANTS.MIN_ORDER_AMOUNT}`);
                return;
            }
            
            if (!price || price <= 0) {
                alert('Please enter a valid price');
                return;
            }
            
            try {
                const data = await callAPI('createOrder', {
                    type,
                    resource,
                    amount: quantity,
                    price
                });
                
                closeCreateOrderModal();
                showSuccess('Order Created!', `Your ${type} order for ${quantity} ${resource} is now active.`);
                loadGameState();
            } catch (error) {
                console.error('Create order failed:', error);
                alert(error.message);
            }
        }
        
        async function executeOrder(orderId, orderType, price, amount, resource) {
            if (orderType === 'sell') {
                try {
                    const data = await callAPI('buyOrder', { orderId, amount });
                    showSuccess('Purchase Successful!', `You bought ${data.amount} ${data.resource} for ${data.tonPaid} TON.`);
                    loadGameState();
                } catch (error) {
                    console.error('Buy order failed:', error);
                    alert(error.message);
                }
            }
        }
        
        // ---------- REFERRAL SYSTEM ----------
        async function claimReferralEarnings() {
            try {
                const data = await callAPI('claimReferralEarnings', {});
                
                gameState.user.tonBalance = data.newTonBalance;
                gameState.user.referralEarnings = 0;
                gameState.user.referralEarningsClaimed += data.claimedAmount;
                
                updateUI();
                showSuccess('Earnings Claimed!', `${data.claimedAmount} TON added to your balance.`);
            } catch (error) {
                console.error('Claim referral earnings failed:', error);
            }
        }
        
        function copyReferralLink() {
            const input = document.getElementById('referralLink');
            input.select();
            navigator.clipboard.writeText(input.value);
            alert('‚úÖ Referral link copied to clipboard!');
        }
        
        // ==============================================
        // TON CONNECT - ÿßŸÑÿ≠ŸÑ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸàÿßŸÑŸÖÿ¨ÿ±ÿ® 100%
        // ==============================================
        
        /**
         * ‚úÖ ÿ•ŸÜÿ¥ÿßÿ° Comment ÿµÿ≠Ÿäÿ≠ ŸÑŸÄ SendTransaction
         * Ÿáÿ∞Ÿá ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ÿ™ÿπŸÖŸÑ ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ÿßŸÅÿ∏:
         * - Telegram Wallet ‚úÖ
         * - Tonkeeper ‚úÖ
         * - Tonhub ‚úÖ
         * - MyTonWallet ‚úÖ
         */
        async function createTransactionComment(comment) {
            const commentStr = String(comment).trim();
            console.log('Creating transaction comment for:', commentStr);
            
            // ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© 1: TonWeb - ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ´ÿ®ÿßÿ™ÿßŸã
            if (window.tonweb) {
                try {
                    // ÿ•ŸÜÿ¥ÿßÿ° TonWeb instance
                    if (!tonwebInstance) {
                        tonwebInstance = new window.tonweb();
                    }
                    
                    // ÿ•ŸÜÿ¥ÿßÿ° Cell ÿ¨ÿØŸäÿØ
                    const cell = new tonwebInstance.boc.Cell();
                    
                    // op = 0 (text comment)
                    cell.bits.writeUint(0, 32);
                    
                    // ŸÉÿ™ÿßÿ®ÿ© ÿßŸÑŸÜÿµ - Ÿáÿ∞Ÿá ŸáŸä ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© ŸÑŸÄ SendTransaction
                    const encoder = new TextEncoder();
                    const bytes = encoder.encode(commentStr);
                    cell.bits.writeBytes(bytes);
                    
                    // ÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ BOC ÿ´ŸÖ base64
                    const boc = await cell.toBoc();
                    const base64 = tonwebInstance.utils.bytesToBase64(boc);
                    
                    console.log('‚úÖ Transaction comment created successfully');
                    return base64;
                    
                } catch (error) {
                    console.error('TonWeb error:', error);
                }
            }
            
            // ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© 2: TON_CONNECT_UI.beginCell
            if (window.TON_CONNECT_UI && window.TON_CONNECT_UI.beginCell) {
                try {
                    const cell = window.TON_CONNECT_UI.beginCell()
                        .storeUint(0, 32)
                        .storeStringTail(commentStr)
                        .endCell();
                    
                    const base64 = cell.toBoc().toString('base64');
                    console.log('‚úÖ TON_CONNECT_UI comment created');
                    return base64;
                    
                } catch (error) {
                    console.error('TON_CONNECT_UI error:', error);
                }
            }
            
            // ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© 3: Handmade Cell (ÿ¢ÿÆÿ± ÿ≠ŸÑ)
            try {
                // ÿ•ŸÜÿ¥ÿßÿ° Cell ÿ®ÿ≥Ÿäÿ∑
                const encoder = new TextEncoder();
                const bytes = encoder.encode(commentStr);
                
                // ÿ£ŸàŸÑ ÿ®ÿßŸäÿ™ = 0 (op code), ÿ®ÿßŸÇŸä ÿßŸÑÿ®ÿßŸäÿ™ÿßÿ™ = ÿßŸÑŸÜÿµ
                const cellData = new Uint8Array([0, ...bytes]);
                const base64 = btoa(String.fromCharCode(...cellData));
                
                console.log('‚ö†Ô∏è Handmade comment created');
                return base64;
                
            } catch (error) {
                console.error('Handmade cell error:', error);
            }
            
            // ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© 4: Plain text base64 (ÿ£ÿÆŸäÿ±ÿßŸã)
            console.warn('‚ö†Ô∏è Using plain text base64');
            return btoa(commentStr);
        }

        /**
         * ‚úÖ ÿ•ÿ±ÿ≥ÿßŸÑ ŸÖÿπÿßŸÖŸÑÿ© ÿßŸÑÿ•ŸäÿØÿßÿπ
         */
        async function sendDepositTransaction(amount, comment) {
            if (!tonConnectUI) {
                throw new Error('TON Connect not initialized');
            }
            
            if (!connectedWallet) {
                throw new Error('Wallet not connected');
            }
            
            try {
                // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÄ comment
                const payload = await createTransactionComment(comment);
                
                if (!payload) {
                    throw new Error('Failed to create transaction payload');
                }
                
                // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 600,
                    messages: [
                        {
                            address: TON_DEPOSIT_ADDRESS,
                            amount: String(Math.floor(amount * 1000000000)),
                            payload: payload
                        }
                    ]
                };
                
                console.log('Sending transaction...');
                
                // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©
                const result = await tonConnectUI.sendTransaction(transaction);
                
                console.log('Transaction sent successfully');
                return result;
                
            } catch (error) {
                console.error('Send transaction error:', error);
                throw error;
            }
        }

        /**
         * ‚úÖ ÿØÿßŸÑÿ© ÿßŸÑÿ•ŸäÿØÿßÿπ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
         */
        async function initiateDeposit() {
            if (!connectedWallet) {
                alert('Please connect your wallet first.');
                return;
            }
            
            const amount = parseFloat(document.getElementById('depositAmount').value);
            
            if (!amount || amount < GAME_CONSTANTS.MIN_DEPOSIT_AMOUNT) {
                alert(`Minimum deposit amount is ${GAME_CONSTANTS.MIN_DEPOSIT_AMOUNT} TON`);
                return;
            }
            
            // ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑÿ≤ÿ±
            const depositBtn = document.getElementById('depositBtn');
            depositBtn.disabled = true;
            depositBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> PROCESSING...';
            
            try {
                // ‚úÖ ŸÅŸÇÿ∑ USER ID - ŸÑÿß ÿ¥Ÿäÿ° ÿ¢ÿÆÿ±
                const comment = USER_ID;
                
                console.log('Starting deposit:', { amount, comment, address: TON_DEPOSIT_ADDRESS });
                
                // ‚úÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©
                const result = await sendDepositTransaction(amount, comment);
                
                // ‚úÖ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ•ŸäÿØÿßÿπ ŸÑŸÑÿ≥Ÿäÿ±ŸÅÿ±
                await callAPI('deposit/confirm', {
                    txHash: result.boc,
                    amount: amount,
                    user_address: connectedWallet.address,
                    comment: comment
                });
                
                // ‚úÖ ÿπÿ±ÿ∂ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠
                document.getElementById('depositStatusContainer').style.display = 'block';
                document.getElementById('depositStatusTitle').textContent = '‚úÖ Transaction Sent!';
                document.getElementById('depositStatusMessage').textContent = 'Balance will be credited within 1-3 minutes.';
                document.getElementById('depositTxHash').textContent = `TX: ${result.boc.substring(0, 16)}...`;
                
                // ‚úÖ ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
                document.getElementById('depositAmount').value = '0.1';
                
                showSuccess('Transaction Sent!', 'Your deposit will be credited within 1-3 minutes.');
                
            } catch (error) {
                console.error('Transaction failed:', error);
                
                // ‚úÖ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿÆÿ∑ÿ£ ŸÖŸÅŸáŸàŸÖÿ©
                let errorMessage = error.message || 'Transaction failed';
                
                if (errorMessage.includes('rejected') || errorMessage.includes('cancelled')) {
                    errorMessage = 'Transaction was cancelled.';
                } else if (errorMessage.includes('insufficient')) {
                    errorMessage = 'Insufficient balance in your wallet.';
                } else if (errorMessage.includes('payload')) {
                    errorMessage = 'Invalid transaction format. Please try again.';
                }
                
                alert('‚ùå ' + errorMessage);
                
            } finally {
                // ÿ•ÿπÿßÿØÿ© ÿ™ŸÖŸÉŸäŸÜ ÿßŸÑÿ≤ÿ±
                depositBtn.disabled = false;
                depositBtn.innerHTML = '<i class="fas fa-arrow-down"></i> DEPOSIT TON';
            }
        }

        /**
         * ‚úÖ ÿ™ŸáŸäÿ¶ÿ© TON Connect
         */
        async function initTONConnect() {
            if (tonConnectUI) return;
            
            try {
                const manifestUrl = `${API_BASE}/tonconnect-manifest.json`;
                
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: manifestUrl,
                    language: 'en',
                    uiPreferences: { theme: 'DARK' }
                });
                
                tonConnectUI.onStatusChange(async (walletInfo) => {
                    if (walletInfo) {
                        await handleWalletConnected(walletInfo);
                    } else {
                        handleWalletDisconnected();
                    }
                });
                
                console.log('‚úÖ TON Connect initialized');
            } catch (error) {
                console.error('Failed to initialize TON Connect:', error);
            }
        }

        async function connectWallet() {
            try {
                if (!tonConnectUI) await initTONConnect();
                await tonConnectUI.openModal();
            } catch (error) {
                console.error('Failed to connect wallet:', error);
            }
        }

        function disconnectWallet() {
            if (tonConnectUI) tonConnectUI.disconnect();
            else handleWalletDisconnected();
        }

        async function handleWalletConnected(walletInfo) {
            connectedWallet = {
                address: walletInfo.account.address,
                chain: walletInfo.account.chain,
                wallet: walletInfo.device.appName
            };
            
            const shortAddress = `${connectedWallet.address.substring(0, 6)}...${connectedWallet.address.substring(connectedWallet.address.length - 4)}`;
            document.getElementById('walletAddress').innerHTML = `
                <span style="color: var(--success);">${connectedWallet.wallet}</span><br>
                <span style="font-size: 11px;">${shortAddress}</span>
            `;
            
            document.getElementById('connectWalletBtn').innerHTML = '<i class="fas fa-unplug"></i> Disconnect';
            document.getElementById('connectWalletBtn').onclick = disconnectWallet;
            document.getElementById('depositBtn').disabled = false;
        }

        function handleWalletDisconnected() {
            connectedWallet = null;
            document.getElementById('walletAddress').textContent = 'Not connected';
            document.getElementById('connectWalletBtn').innerHTML = '<i class="fas fa-plug"></i> Connect';
            document.getElementById('connectWalletBtn').onclick = connectWallet;
            document.getElementById('depositBtn').disabled = true;
        }
        
        function setDepositAmount(amount) {
            document.getElementById('depositAmount').value = amount;
        }
        
        // ---------- WITHDRAWAL ----------
        async function withdrawTON() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const address = document.getElementById('withdrawAddress').value;
            
            if (!amount || amount < GAME_CONSTANTS.MIN_WITHDRAW_AMOUNT) {
                alert(`Minimum withdrawal amount is ${GAME_CONSTANTS.MIN_WITHDRAW_AMOUNT} TON`);
                return;
            }
            
            if (!address || address.length < 10) {
                alert('Please enter a valid TON wallet address');
                return;
            }
            
            if (amount > gameState.user.tonBalance) {
                alert('Insufficient balance');
                return;
            }
            
            try {
                const data = await callAPI('withdrawTON', { amount, address });
                
                gameState.user.tonBalance = data.newBalance;
                updateUI();
                
                showSuccess('Withdrawal Request Submitted!', `You will receive ${data.netAmount} TON within 24 hours.`);
                
                document.getElementById('withdrawAmount').value = '';
                document.getElementById('withdrawAddress').value = '';
            } catch (error) {
                console.error('Withdrawal failed:', error);
                alert(error.message);
            }
        }
        
        // ---------- UI UPDATE ----------
        function updateUI() {
            // Status Bar
            document.getElementById('statusMilkBalance').textContent = formatNumber(gameState.user.milk);
            document.getElementById('statusEggsBalance').textContent = formatNumber(gameState.user.eggs);
            document.getElementById('statusDiamondBalance').textContent = formatNumber(gameState.user.diamond);
            document.getElementById('statusTonBalance').textContent = formatTON(gameState.user.tonBalance);
            
            document.getElementById('statusMilkRate').textContent = gameState.user.milkPerHour || 0;
            document.getElementById('statusEggsRate').textContent = gameState.user.eggsPerHour || 0;
            
            // Cow Machine
            document.getElementById('cowsOwned').textContent = gameState.user.cows_owned || 0;
            document.getElementById('cowProgressText').textContent = `${gameState.global.cows_sold || 0}/${GAME_CONSTANTS.COW_GLOBAL_CAP}`;
            document.getElementById('cowProgressFill').style.width = `${((gameState.global.cows_sold || 0) / GAME_CONSTANTS.COW_GLOBAL_CAP) * 100}%`;
            
            // Chicken Machine
            document.getElementById('chickensOwned').textContent = gameState.user.chickens_owned || 0;
            document.getElementById('chickenProgressText').textContent = `${gameState.global.chickens_sold || 0}/${GAME_CONSTANTS.CHICKEN_GLOBAL_CAP}`;
            document.getElementById('chickenProgressFill').style.width = `${((gameState.global.chickens_sold || 0) / GAME_CONSTANTS.CHICKEN_GLOBAL_CAP) * 100}%`;
            
            // Diamond Engine
            document.getElementById('diamondEnginesOwned').textContent = gameState.user.diamond_engines_owned || 0;
            document.getElementById('diamondBalance').textContent = formatNumber(gameState.user.diamond || 0);
            document.getElementById('diamondPrice').textContent = gameState.global.diamond_price || 5;
            document.getElementById('conversionRate').textContent = gameState.global.diamond_price || 5;
            
            // Profile
            document.getElementById('profileMilk').textContent = formatNumber(gameState.user.milk);
            document.getElementById('profileEggs').textContent = formatNumber(gameState.user.eggs);
            document.getElementById('profileDiamond').textContent = formatNumber(gameState.user.diamond);
            document.getElementById('profileTon').textContent = formatTON(gameState.user.tonBalance);
            
            document.getElementById('profileMilkRate').textContent = `${gameState.user.milkPerHour || 0}/h`;
            document.getElementById('profileEggsRate').textContent = `${gameState.user.eggsPerHour || 0}/h`;
            document.getElementById('profileDiamondPrice').textContent = gameState.global.diamond_price || 5;
            
            document.getElementById('profileCows').textContent = gameState.user.cows_owned || 0;
            document.getElementById('profileChickens').textContent = gameState.user.chickens_owned || 0;
            document.getElementById('profileDiamondEngines').textContent = gameState.user.diamond_engines_owned || 0;
            
            const totalMachines = (gameState.user.cows_owned || 0) + (gameState.user.chickens_owned || 0) + (gameState.user.diamond_engines_owned || 0);
            document.getElementById('totalMachines').textContent = totalMachines;
            document.getElementById('totalProduction').textContent = `${(gameState.user.milkPerHour || 0) + (gameState.user.eggsPerHour || 0)}/h`;
            
            // Conversion Preview
            const convertAmount = parseInt(document.getElementById('convertAmount').value) || 0;
            const tonReceive = convertAmount * (gameState.global.diamond_price || 5);
            document.getElementById('tonReceivePreview').textContent = `${formatTON(tonReceive)} TON`;
            
            // Withdrawal Preview
            const withdrawAmount = parseFloat(document.getElementById('withdrawAmount').value) || 0;
            const withdrawFee = withdrawAmount * (GAME_CONSTANTS.WITHDRAW_FEE_PERCENT / 100);
            const withdrawNet = withdrawAmount - withdrawFee;
            document.getElementById('withdrawFee').textContent = `${formatTON(withdrawFee)} TON`;
            document.getElementById('withdrawNet').textContent = `${formatTON(withdrawNet)} TON`;
            
            // Referral
            if (gameState.user.referralCode) {
                const referralLink = `https://t.me/${TELEGRAM_BOT_USERNAME.replace('@', '')}?startapp=ref_${gameState.user.referralCode}`;
                document.getElementById('referralLink').value = referralLink;
            }
            
            document.getElementById('totalReferrals').textContent = gameState.referral?.totalReferrals || 0;
            document.getElementById('referralEarnings').textContent = formatTON(gameState.user.referralEarnings || 0);
            
            const claimBtn = document.getElementById('claimReferralBtn');
            if (gameState.user.referralEarnings > 0) {
                claimBtn.disabled = false;
                claimBtn.innerHTML = `<i class="fas fa-hand-holding-usd"></i> CLAIM ${formatTON(gameState.user.referralEarnings)} TON`;
            } else {
                claimBtn.disabled = true;
                claimBtn.innerHTML = '<i class="fas fa-hand-holding-usd"></i> NO EARNINGS';
            }
            
            // ===== UPDATE MACHINE STATES =====
            
            // Cow Machine
            const cowBuyBtn = document.getElementById('buyCowBtn');
            const cowHatchBtn = document.getElementById('hatchCowBtn');
            const cowBadge = document.getElementById('cowBadge');
            
            if (gameState.user.cows_owned > 0) {
                cowBuyBtn.disabled = true;
                cowBuyBtn.innerHTML = '<i class="fas fa-check"></i> OWNED';
                cowBadge.textContent = 'OWNED';
                cowBadge.className = 'machine-badge badge-owned';
            } else if (gameState.global.cows_sold >= GAME_CONSTANTS.COW_GLOBAL_CAP) {
                cowBuyBtn.disabled = true;
                cowBuyBtn.innerHTML = '<i class="fas fa-ban"></i> SOLD OUT';
                cowBadge.textContent = 'SOLD OUT';
                cowBadge.className = 'machine-badge badge-sold-out';
            } else {
                cowBuyBtn.disabled = gameState.user.tonBalance < GAME_CONSTANTS.COW_PRICE;
                cowBuyBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> BUY';
                cowBadge.textContent = `${GAME_CONSTANTS.COW_GLOBAL_CAP - gameState.global.cows_sold} LEFT`;
                cowBadge.className = 'machine-badge badge-available';
            }
            
            cowHatchBtn.disabled = (gameState.user.milk || 0) < GAME_CONSTANTS.COW_HATCH_COST;
            
            // Chicken Machine
            const chickenBuyBtn = document.getElementById('buyChickenBtn');
            const chickenHatchBtn = document.getElementById('hatchChickenBtn');
            const chickenBadge = document.getElementById('chickenBadge');
            const chickenLockMsg = document.getElementById('chickenLockMessage');
            
            if (!gameState.global.chicken_unlocked) {
                chickenBuyBtn.disabled = true;
                chickenBuyBtn.innerHTML = '<i class="fas fa-lock"></i> LOCKED';
                chickenBadge.textContent = 'LOCKED';
                chickenBadge.className = 'machine-badge badge-locked';
                chickenLockMsg.style.display = 'block';
                document.getElementById('chickenMachineCard').classList.add('locked');
            } else {
                chickenLockMsg.style.display = 'none';
                document.getElementById('chickenMachineCard').classList.remove('locked');
                
                if (gameState.user.chickens_owned > 0) {
                    chickenBuyBtn.disabled = true;
                    chickenBuyBtn.innerHTML = '<i class="fas fa-check"></i> OWNED';
                    chickenBadge.textContent = 'OWNED';
                    chickenBadge.className = 'machine-badge badge-owned';
                } else if (gameState.global.chickens_sold >= GAME_CONSTANTS.CHICKEN_GLOBAL_CAP) {
                    chickenBuyBtn.disabled = true;
                    chickenBuyBtn.innerHTML = '<i class="fas fa-ban"></i> SOLD OUT';
                    chickenBadge.textContent = 'SOLD OUT';
                    chickenBadge.className = 'machine-badge badge-sold-out';
                } else {
                    chickenBuyBtn.disabled = gameState.user.tonBalance < GAME_CONSTANTS.CHICKEN_PRICE;
                    chickenBuyBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> BUY';
                    chickenBadge.textContent = `${GAME_CONSTANTS.CHICKEN_GLOBAL_CAP - gameState.global.chickens_sold} LEFT`;
                    chickenBadge.className = 'machine-badge badge-available';
                }
            }
            
            chickenHatchBtn.disabled = (gameState.user.eggs || 0) < GAME_CONSTANTS.CHICKEN_HATCH_COST;
            
            // Diamond Engine
            const diamondBuyBtn = document.getElementById('buyDiamondBtn');
            const diamondStartBtn = document.getElementById('startDiamondBtn');
            const diamondBadge = document.getElementById('diamondBadge');
            const diamondLockMsg = document.getElementById('diamondLockMessage');
            
            if (!gameState.global.diamond_unlocked) {
                diamondBuyBtn.disabled = true;
                diamondBuyBtn.innerHTML = '<i class="fas fa-lock"></i> LOCKED';
                diamondStartBtn.disabled = true;
                diamondBadge.textContent = 'LOCKED';
                diamondBadge.className = 'machine-badge badge-locked';
                diamondLockMsg.style.display = 'block';
                document.getElementById('diamondEngineCard').classList.add('locked');
            } else {
                diamondLockMsg.style.display = 'none';
                document.getElementById('diamondEngineCard').classList.remove('locked');
                
                if (gameState.user.diamond_engines_owned > 0) {
                    diamondBuyBtn.disabled = true;
                    diamondBuyBtn.innerHTML = '<i class="fas fa-check"></i> OWNED';
                    diamondBadge.textContent = 'OWNED';
                    diamondBadge.className = 'machine-badge badge-owned';
                    
                    const hasMilk = (gameState.user.milk || 0) >= GAME_CONSTANTS.DIAMOND_PRODUCTION_COST_MILK;
                    const hasEggs = (gameState.user.eggs || 0) >= GAME_CONSTANTS.DIAMOND_PRODUCTION_COST_EGGS;
                    diamondStartBtn.disabled = !(hasMilk && hasEggs);
                    diamondStartBtn.innerHTML = (hasMilk && hasEggs) ? 
                        '<i class="fas fa-play"></i> PRODUCE' : 
                        '<i class="fas fa-ban"></i> NEED RESOURCES';
                } else {
                    diamondBuyBtn.disabled = gameState.user.tonBalance < GAME_CONSTANTS.DIAMOND_ENGINE_PRICE;
                    diamondBuyBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> BUY (20 TON)';
                    diamondStartBtn.disabled = true;
                    diamondBadge.textContent = 'AVAILABLE';
                    diamondBadge.className = 'machine-badge badge-available';
                }
            }
        }
        
        function updateMarketUI() {
            const resource = currentResource;
            const orders = resource === 'milk' ? gameState.market?.milk?.sellOrders || [] : gameState.market?.eggs?.sellOrders || [];
            
            const ordersGrid = document.getElementById('sellOrdersGrid');
            
            if (!orders || orders.length === 0) {
                ordersGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--text-secondary); background: rgba(0,0,0,0.2); border-radius: 16px;">
                        <i class="fas fa-inbox" style="font-size: 40px; margin-bottom: 12px; opacity: 0.5;"></i>
                        <p style="font-size: 15px;">No active ${resource} orders</p>
                        <p style="font-size: 13px; margin-top: 8px;">Be the first to create an order</p>
                    </div>
                `;
                return;
            }
            
            const sortedOrders = [...orders].sort((a, b) => a.price - b.price);
            
            let html = '';
            sortedOrders.slice(0, 6).forEach((order, index) => {
                const isBest = index === 0;
                html += `
                    <div class="order-card ${isBest ? 'best' : ''}">
                        ${isBest ? '<span style="position: absolute; top: -8px; left: 12px; background: var(--accent-green); color: black; font-size: 10px; font-weight: 800; padding: 3px 10px; border-radius: 20px;">üî• BEST PRICE</span>' : ''}
                        <div class="order-header">
                            <span class="order-resource">
                                ${resource === 'milk' ? 'ü•õ' : 'ü•ö'} ${resource === 'milk' ? 'Milk' : 'Eggs'}
                            </span>
                            <span class="order-badge">SELL</span>
                        </div>
                        <div class="order-quantity">${formatNumber(order.amount)}</div>
                        <div class="order-total-price">${formatTON(order.amount * order.price)} TON</div>
                        <div class="order-unit-price">${formatTON(order.price)} TON / unit</div>
                        <button class="order-action" onclick="executeOrder('${order.id}', 'sell', ${order.price}, ${order.amount}, '${resource}')">
                            BUY
                        </button>
                    </div>
                `;
            });
            
            ordersGrid.innerHTML = html;
        }
        
        function updateReferralUI() {
            const recentList = document.getElementById('recentReferralsList');
            
            if (gameState.referral?.referralList?.length > 0) {
                let html = '';
                gameState.referral.referralList.slice(0, 5).forEach(ref => {
                    const date = new Date(ref.timestamp).toLocaleDateString();
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <div>
                                <div style="font-weight: 600;">User ${ref.userId?.substring(0, 6) || '???'}...</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">${ref.type || 'referral'}</div>
                            </div>
                            <div style="color: var(--success); font-weight: 700;">+${ref.reward || 0} TON</div>
                        </div>
                    `;
                });
                recentList.innerHTML = html;
            } else {
                recentList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-user-friends" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                        <p>No referrals yet</p>
                        <p style="font-size: 12px; margin-top: 8px;">Share your link to start earning</p>
                    </div>
                `;
            }
        }
        
        // ---------- UI CONTROLS ----------
        function switchTab(tabId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.nav-item[data-tab="${tabId}"]`).classList.add('active');
        }
        
        function openFinanceTab() {
            switchTab('financeTab');
        }
        
        function switchMarketTab(tab) {
            currentMarketTab = tab;
            
            document.querySelectorAll('.market-tab').forEach(t => t.classList.remove('active'));
            if (tab === 'market') {
                document.querySelectorAll('.market-tab')[0].classList.add('active');
                document.getElementById('marketSection').style.display = 'block';
                document.getElementById('myOrdersSection').style.display = 'none';
            } else {
                document.querySelectorAll('.market-tab')[1].classList.add('active');
                document.getElementById('marketSection').style.display = 'none';
                document.getElementById('myOrdersSection').style.display = 'block';
            }
        }
        
        function switchResource(resource) {
            currentResource = resource;
            
            document.querySelectorAll('.resource-option').forEach(opt => {
                opt.classList.remove('active');
            });
            
            if (resource === 'milk') {
                document.querySelectorAll('.resource-option')[0].classList.add('active');
            } else {
                document.querySelectorAll('.resource-option')[1].classList.add('active');
            }
            
            updateMarketUI();
        }
        
        function switchToEggs() {
            switchResource('eggs');
        }
        
        function switchToMilk() {
            switchResource('milk');
        }
        
        function openCreateOrderModal() {
            document.getElementById('createOrderModal').classList.add('active');
            setOrderType('sell');
            setOrderResource(currentResource);
        }
        
        function closeCreateOrderModal() {
            document.getElementById('createOrderModal').classList.remove('active');
        }
        
        function setOrderType(type) {
            currentOrderType = type;
            
            const buyBtn = document.getElementById('orderTypeBuyBtn');
            const sellBtn = document.getElementById('orderTypeSellBtn');
            
            if (type === 'buy') {
                buyBtn.style.background = 'rgba(0, 208, 156, 0.2)';
                buyBtn.style.border = '1px solid var(--success)';
                sellBtn.style.background = 'transparent';
                sellBtn.style.border = '1px solid var(--glass-border)';
            } else {
                sellBtn.style.background = 'rgba(0, 208, 156, 0.2)';
                sellBtn.style.border = '1px solid var(--success)';
                buyBtn.style.background = 'transparent';
                buyBtn.style.border = '1px solid var(--glass-border)';
            }
            
            updateOrderAvailableBalance();
        }
        
        function setOrderResource(resource) {
            currentOrderResource = resource;
            
            const milkBtn = document.getElementById('orderResourceMilkBtn');
            const eggsBtn = document.getElementById('orderResourceEggsBtn');
            
            if (resource === 'milk') {
                milkBtn.style.background = 'rgba(0, 208, 156, 0.2)';
                milkBtn.style.border = '1px solid var(--success)';
                eggsBtn.style.background = 'transparent';
                eggsBtn.style.border = '1px solid var(--glass-border)';
            } else {
                eggsBtn.style.background = 'rgba(0, 208, 156, 0.2)';
                eggsBtn.style.border = '1px solid var(--success)';
                milkBtn.style.background = 'transparent';
                milkBtn.style.border = '1px solid var(--glass-border)';
            }
            
            updateOrderAvailableBalance();
        }
        
        function setOrderQuantityPercent(percent) {
            let balance = 0;
            
            if (currentOrderType === 'sell') {
                balance = currentOrderResource === 'milk' ? gameState.user.milk : gameState.user.eggs;
            } else {
                balance = gameState.user.tonBalance / 0.01;
            }
            
            const amount = Math.floor(balance * (percent / 100));
            document.getElementById('orderQuantity').value = Math.max(GAME_CONSTANTS.MIN_ORDER_AMOUNT, amount);
        }
        
        function setOrderQuantityMax() {
            let balance = 0;
            
            if (currentOrderType === 'sell') {
                balance = currentOrderResource === 'milk' ? gameState.user.milk : gameState.user.eggs;
            } else {
                balance = Math.floor(gameState.user.tonBalance / 0.01);
            }
            
            document.getElementById('orderQuantity').value = Math.max(GAME_CONSTANTS.MIN_ORDER_AMOUNT, balance);
        }
        
        function updateOrderAvailableBalance() {
            const availableSpan = document.getElementById('orderAvailableBalance');
            
            if (currentOrderType === 'sell') {
                const balance = currentOrderResource === 'milk' ? gameState.user.milk : gameState.user.eggs;
                availableSpan.textContent = formatNumber(balance) + ' ' + (currentOrderResource === 'milk' ? 'ü•õ' : 'ü•ö');
            } else {
                availableSpan.textContent = formatTON(gameState.user.tonBalance) + ' TON';
            }
            
            const bestPriceSpan = document.getElementById('orderBestPrice');
            if (currentOrderType === 'sell') {
                const bestBuyPrice = currentOrderResource === 'milk' ? 
                    gameState.market?.milk?.bestBuyPrice : gameState.market?.eggs?.bestBuyPrice;
                bestPriceSpan.textContent = bestBuyPrice ? `${formatTON(bestBuyPrice)} TON` : '0.0000 TON';
            } else {
                const bestSellPrice = currentOrderResource === 'milk' ? 
                    gameState.market?.milk?.bestSellPrice : gameState.market?.eggs?.bestSellPrice;
                bestPriceSpan.textContent = bestSellPrice ? `${formatTON(bestSellPrice)} TON` : '0.0000 TON';
            }
        }
        
        function toggleHelpModal() {
            document.getElementById('helpModal').classList.toggle('active');
        }
        
        function showSuccess(title, message) {
            document.getElementById('successModalTitle').textContent = title;
            document.getElementById('successModalMessage').textContent = message;
            document.getElementById('successModal').classList.add('active');
            
            setTimeout(() => {
                closeSuccessModal();
            }, 3000);
        }
        
        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('active');
        }
        
        // ---------- UTILITY FUNCTIONS ----------
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toLocaleString();
        }
        
        function formatTON(amount) {
            if (amount === null || amount === undefined) return '0.0000';
            return parseFloat(amount).toFixed(4);
        }
        
        // ---------- EVENT LISTENERS ----------
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('withdrawAmount').addEventListener('input', updateUI);
            document.getElementById('convertAmount').addEventListener('input', updateUI);
            
            document.addEventListener('click', function(event) {
                const helpModal = document.getElementById('helpModal');
                const helpBtn = document.querySelector('.help-btn');
                
                if (helpModal.classList.contains('active') && 
                    !helpModal.contains(event.target) && 
                    !helpBtn.contains(event.target)) {
                    helpModal.classList.remove('active');
                }
                
                const createOrderModal = document.getElementById('createOrderModal');
                if (createOrderModal.classList.contains('active') && 
                    !createOrderModal.querySelector('.modal-content').contains(event.target) &&
                    !event.target.closest('.create-order-btn')) {
                    closeCreateOrderModal();
                }
                
                const hatchModal = document.getElementById('hatchModal');
                if (hatchModal.classList.contains('active') && 
                    !hatchModal.querySelector('.modal-content').contains(event.target)) {
                    closeHatchModal();
                }
            });
        });
        
        // ---------- INITIALIZATION ----------
        async function initialize() {
            console.log('üöú Initializing Farm Economy...');
            
            await setupTelegramAuth();
            
            try {
                const referredBy = getReferrerFromStartParam();
                await callAPI('initializeUser', { 
                    user: telegramUser,
                    referredBy: referredBy 
                });
            } catch (error) {
                console.log('User may already exist:', error);
            }
            
            setTimeout(() => {
                initTONConnect().catch(console.error);
            }, 1000);
            
            let progress = 0;
            const loadingInterval = setInterval(() => {
                progress += 10;
                document.getElementById('loadingProgress').style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(loadingInterval);
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';
                    
                    loadGameState();
                    setInterval(loadGameState, 30000);
                    
                    const referrer = getReferrerFromStartParam();
                    if (referrer) {
                        setTimeout(() => {
                            alert(`üëã Welcome! You were invited by a friend. They will earn 10% commission on your TON purchases.`);
                        }, 2000);
                    }
                    
                    console.log('‚úÖ Farm Economy initialized');
                }
            }, 100);
        }
        
        initialize();
    </script>
</body>
</html>

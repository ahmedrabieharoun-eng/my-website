<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <title>GLX Galaxy</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="//libtl.com/sdk.js" data-zone="10286382" data-sdk="show_10286382" async></script>
    <script src="https://ad.gigapub.tech/script?id=4102"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root{--primary-green:#a855f7;--deep-Galaxy:#202020;--gold:#d6bcfa;--gold-glow:rgba(168,85,247,0.4);--glass-bg:rgba(32,32,32,0.7);--glass-border:rgba(255,255,255,0.1);--text-color:#fff;--text-muted:#b0b0b0;--nav-bg:rgba(40,40,40,0.98);--success-color:#a855f7}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:'Outfit',sans-serif;color:var(--text-color);overflow-x:hidden;background-image:url('https://i.ibb.co/RGFp67kJ/121.jpg');background-size:cover;background-position:center;background-attachment:fixed;min-height:100vh}
        body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at center,rgba(50,50,50,0.3) 0%,rgba(30,30,30,0.85) 100%);z-index:-1}
        .app-container{padding:20px;padding-bottom:110px;max-width:500px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
        .content-section{display:none;animation:fadeIn 0.4s ease}
        .content-section.active{display:flex;flex-direction:column;flex:1}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)}}
        h1{font-size:26px;font-weight:800;color:#fff;margin-bottom:5px;text-transform:uppercase;letter-spacing:1px}
        h2{font-size:18px;font-weight:700;margin:20px 0 10px;color:var(--gold);display:flex;align-items:center;gap:8px}
        p{font-size:13px;color:var(--text-muted);line-height:1.4}
        .page-header{text-align:center;margin-bottom:20px;padding-top:10px}
        .card{background:var(--glass-bg);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);border-radius:24px;padding:20px;margin-bottom:12px;border:1px solid var(--glass-border);box-shadow:0 4px 20px rgba(0,0,0,0.4)}
        .btn{display:flex;align-items:center;justify-content:center;width:100%;padding:16px;border-radius:18px;font-size:16px;font-weight:800;cursor:pointer;border:none;outline:none;gap:8px;text-transform:uppercase;letter-spacing:0.5px;transition:transform 0.1s}
        .btn:active{transform:scale(0.96)}
        .btn:disabled{opacity:0.5;cursor:not-allowed;filter:grayscale(1)}
        .btn-primary{background:linear-gradient(90deg,#a855f7,#7c3aed);color:#fff;box-shadow:0 0 15px rgba(168,85,247,0.4)}
        .btn-ton{background:linear-gradient(90deg,#0088cc,#0099ff);color:#fff;box-shadow:0 0 15px rgba(0,136,204,0.4)}
        .btn-check{background:linear-gradient(90deg,#a855f7,#7c3aed);color:#fff;box-shadow:0 0 15px rgba(168,85,247,0.4)}
        .btn-action{background:rgba(0,0,0,0.3)!important;backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,0.1)!important;color:#b0b0b0!important;flex-direction:column;padding:12px;font-size:12px;gap:5px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.2);transition:all 0.3s ease}
        .btn-action svg{width:24px;height:24px;stroke:#b0b0b0!important;fill:none;stroke-width:2.5;transition:all 0.3s ease}
        .btn-action:active{background:rgba(0,0,0,0.4)!important;transform:scale(0.98)}
        .hud-container{display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,0.5);border-radius:50px;padding:10px 15px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.05)}
        .user-name{font-weight:700;font-size:14px}
        .user-rank{font-size:10px;color:var(--primary-green);text-transform:uppercase}
        .hud-avatar{width:50px;height:50px;border-radius:50%;overflow:hidden;border:2px solid var(--primary-green)}
        .hud-avatar img{width:100%;height:100%;object-fit:cover}
        .hud-balance{display:flex;flex-direction:column;align-items:flex-end;gap:5px}
        .hud-balance-item{display:flex;align-items:center;gap:5px;font-size:12px;font-weight:600}
        .hud-glx{color:var(--gold)}
        .hud-ton{color:#0088cc}
        .main-coin-section{text-align:center;margin:10px 0 30px;position:relative}
        .main-coin-img{width:160px;height:160px;border-radius:50%;box-shadow:0 0 50px rgba(168,85,247,0.3);animation:float 4s ease-in-out infinite;object-fit:cover;border:4px solid var(--primary-green)}
        @keyframes float{0%{transform:translateY(0px)}50%{transform:translateY(-10px)}100%{transform:translateY(0px)}}
        .balance-display{margin-top:15px}
        .balance-amount{font-size:48px;font-weight:800;background:linear-gradient(to bottom,#fff,#b3b3b3);-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1}
        .balance-unit{font-size:16px;color:var(--primary-green);font-weight:700;letter-spacing:2px}
        .stats-pill{display:inline-flex;align-items:center;gap:15px;background:rgba(255,255,255,0.05);padding:8px 16px;border-radius:20px;margin-top:10px;font-size:12px;font-weight:600}
        .ton-val{color:var(--primary-green);display:flex;align-items:center;gap:4px}
        .action-bar{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:25px}
        .list-card{display:flex;align-items:center;background:rgba(0,0,0,0.3);border-radius:16px;padding:12px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.05);cursor:pointer}
        .lc-icon{width:42px;height:42px;border-radius:12px;background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;margin-right:12px;flex-shrink:0}
        .lc-icon img{width:100%;height:100%;object-fit:cover;border-radius:12px}
        .lc-content{flex:1}
        .lc-title{font-size:14px;font-weight:600;margin-bottom:2px}
        .lc-sub{font-size:11px;color:var(--text-muted)}
        .lc-end{text-align:right}
        .lc-val{font-weight:700;color:var(--primary-green);font-size:14px}
        .daily-row{display:flex;overflow-x:auto;gap:8px;padding-bottom:10px;margin-bottom:15px;scrollbar-width:none}
        .daily-box{min-width:70px;background:rgba(255,255,255,0.05);border-radius:12px;padding:10px 5px;text-align:center;border:1px solid transparent;opacity:0.5}
        .daily-box.active{opacity:1;border-color:var(--gold);background:rgba(255,215,0,0.1)}
        .daily-box.claimed{opacity:1;background:var(--primary-green);color:#000}
        .slots-machine{background:rgba(0,0,0,0.6);border-radius:20px;padding:20px;margin-bottom:20px;border:2px solid var(--primary-green);box-shadow:0 0 25px rgba(168,85,247,0.4)}
        .slots-reels{display:flex;justify-content:space-around;margin:20px 0;gap:10px}
        .reel-container{position:relative;width:80px;height:80px;overflow:hidden;border-radius:15px;background:rgba(0,0,0,0.7);border:2px solid rgba(255,255,255,0.2)}
        .reel{display:flex;flex-direction:column;transition:transform 2s cubic-bezier(0.1,0,0.2,1)}
        .slot-item{width:80px;height:80px;display:flex;align-items:center;justify-content:center;font-size:40px}
        .slots-result{background:rgba(0,0,0,0.8);border-radius:15px;padding:15px;margin-top:20px;border:1px solid rgba(255,255,255,0.1);text-align:center}
        .payout-table{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:15px;font-size:11px}
        .payout-item{background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;text-align:center}
        .jackpot{color:#FFD700;font-weight:800;text-shadow:0 0 10px rgba(255,215,0,0.8)}
        .input-wrap{background:rgba(0,0,0,0.4);border-radius:16px;padding:15px;margin-bottom:15px;border:1px solid rgba(255,255,255,0.1)}
        .input-label{font-size:11px;color:var(--text-muted);display:block;margin-bottom:5px;text-transform:uppercase}
        .custom-input{width:100%;background:transparent;border:none;color:#fff;font-size:16px;font-weight:600;outline:none;font-family:inherit}
        .cat-select{display:flex;gap:10px;margin-bottom:20px}
        .cat-opt{flex:1;padding:12px;text-align:center;background:rgba(255,255,255,0.05);border-radius:12px;font-size:12px;cursor:pointer;border:1px solid transparent}
        .cat-opt.active{background:var(--primary-green);color:#000;border-color:var(--primary-green);font-weight:700}
        .price-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:15px}
        .price-opt{padding:10px;background:rgba(255,255,255,0.05);border-radius:10px;text-align:center;cursor:pointer;border:1px solid transparent}
        .price-opt.active{border-color:var(--gold);background:rgba(255,215,0,0.1)}
        .price-count{font-size:14px;font-weight:700;color:#fff}
        .price-cost{font-size:10px;color:var(--primary-green);margin-top:2px}
        .terms-box{background:rgba(0,0,0,0.3);border-radius:16px;padding:15px;height:300px;overflow-y:auto;font-size:12px;color:var(--text-muted);border:1px solid rgba(255,255,255,0.05);line-height:1.6}
        .terms-box h3{color:#fff;font-size:14px;margin-top:15px;margin-bottom:5px}
        .terms-box h3:first-child{margin-top:0}
        .bottom-nav{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);width:90%;max-width:400px;height:65px;background:var(--nav-bg);border-radius:32px;display:flex;justify-content:space-around;align-items:center;box-shadow:0 10px 30px rgba(0,0,0,0.5);z-index:100;border:1px solid rgba(255,255,255,0.1)}
        .nav-item{display:flex;flex-direction:column;align-items:center;color:#666;transition:0.3s;cursor:pointer;position:relative;width:50px}
        .nav-item svg{width:22px;height:22px;margin-bottom:4px;stroke:currentColor;fill:none;stroke-width:2.5;transition:all 0.3s}
        .nav-item.active{color:var(--primary-green);transform:translateY(-2px)}
        .nav-item.active svg{stroke:var(--primary-green);filter:drop-shadow(0 0 8px rgba(168,85,247,0.6))}
        .nav-text{font-size:9px;font-weight:700;text-transform:uppercase}
        .hidden{display:none!important}
        .leader-tabs{display:flex;background:rgba(0,0,0,0.3);border-radius:50px;padding:4px;margin-bottom:20px}
        .tab-btn{flex:1;text-align:center;padding:10px;border-radius:50px;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.3s}
        .tab-btn.active{background:var(--primary-green);color:#000}
        .withdrawal-type-selector{display:flex;background:rgba(0,0,0,0.3);border-radius:50px;padding:4px;margin-bottom:20px}
        .withdrawal-type-btn{flex:1;text-align:center;padding:12px;border-radius:50px;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.3s;border:1px solid transparent}
        .withdrawal-type-btn.active{background:var(--primary-green);color:#000;border-color:var(--primary-green)}
        .info-box{background:rgba(255,179,0,0.1);border:1px solid var(--gold);border-radius:12px;padding:12px;margin-bottom:15px;font-size:11px;line-height:1.5}
        .info-box.success{background:rgba(39,174,96,0.1);border-color:#27ae60}
        .info-icon{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;margin-right:5px;border-radius:50%;background:var(--gold);color:#000;font-size:10px;font-weight:bold}
        .info-box.success .info-icon{background:#27ae60;color:#fff}
        .floating-add-task{position:fixed;bottom:85px;left:50%;transform:translateX(-50%);width:auto!important;min-width:180px!important;max-width:250px!important;background:var(--glass-bg);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:20px;padding:12px 20px!important;border:1px solid var(--primary-green);box-shadow:0 5px 30px rgba(168,85,247,0.3);z-index:99;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.3s}
        .floating-add-task:active{transform:translateX(-50%) scale(0.98)}
        .floating-add-task-content{display:flex;align-items:center;justify-content:center;gap:8px!important}
        .floating-add-task-icon{width:36px;height:36px;background:var(--primary-green);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:bold;color:#000}
        .floating-add-task-text{font-size:14px!important;font-weight:700;color:#fff;text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap!important}
        .spins-display{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.08);border-radius:15px;padding:12px 15px;margin-bottom:15px;border:1px solid var(--glass-border)}
        .spins-count{font-size:20px;font-weight:800;color:var(--primary-green)}
        .referred-users-list{max-height:300px;overflow-y:auto;margin-top:15px}
        .referred-user-item{display:flex;align-items:center;padding:10px;background:rgba(255,255,255,0.05);border-radius:12px;margin-bottom:8px}
        .referred-user-avatar{width:40px;height:40px;border-radius:50%;margin-right:12px;border:2px solid var(--primary-green)}
        .referred-user-info{flex:1}
        .referred-user-name{font-size:14px;font-weight:600}
        .referred-user-date{font-size:11px;color:var(--text-muted)}
        .referred-user-status{font-size:10px;padding:2px 8px;border-radius:10px;background:var(--primary-green);color:#000;font-weight:700}
        .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px}
        .stat-card{background:rgba(168,85,247,0.1);padding:15px;border-radius:12px;text-align:center;border:1px solid rgba(168,85,247,0.3)}
        .stat-value{font-size:24px;font-weight:800;color:var(--primary-green);margin-top:5px}
        .stat-label{font-size:12px;color:var(--text-muted)}
        .promo-card,.code-channel-card{transition:all 0.3s ease;animation:cardFloat 3s ease-in-out infinite alternate}
        @keyframes cardFloat{0%{transform:translateY(0)}100%{transform:translateY(-5px)}}
        .code-channel-card:active{transform:scale(0.98)}
        #promo-code-input:focus{box-shadow:0 0 15px rgba(168,85,247,0.4);border-color:#a855f7}
        .max-btn,.withdraw-max-btn{min-width:60px!important;height:44px!important;padding:10px 15px!important;font-size:12px!important;font-weight:800!important;white-space:nowrap!important;border:2px solid rgba(168,85,247,0.5)!important;background:rgba(168,85,247,0.2)!important;color:white!important;border-radius:12px!important;cursor:pointer!important}
        @keyframes cupShine{0%{filter:drop-shadow(0 0 5px rgba(255,215,0,0.7))}50%{filter:drop-shadow(0 0 15px rgba(255,215,0,0.9))}100%{filter:drop-shadow(0 0 5px rgba(255,215,0,0.7))}}
        @keyframes pulseArrow{0%{transform:translateY(0);opacity:1}50%{transform:translateY(-2px);opacity:0.7}100%{transform:translateY(0);opacity:1}}
        @media (max-width:480px){.max-btn,.withdraw-max-btn{min-width:50px!important;padding:8px 12px!important;font-size:11px!important;height:42px!important}.ticket-input,.bet-input{font-size:16px!important;padding:12px!important;height:44px!important}.coin-bet-controls,.ticket-controls{display:flex!important;align-items:center!important;gap:8px!important;width:100%!important}.bet-input,.ticket-input{flex:1!important;min-width:0!important;font-size:16px!important;padding:12px!important;height:44px!important}.app-container{padding:10px;padding-bottom:80px}.main-coin-img{width:120px;height:120px}.balance-amount{font-size:36px}.bottom-nav{width:95%;height:60px}.nav-text{font-size:8px}.bottom-nav{width:96%;padding:0 5px}.nav-item{width:45px}.nav-text{font-size:7px}}
        input[type="number"]{-webkit-appearance:none;-moz-appearance:textfield;appearance:none;font-size:18px!important}
        input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
        .coin-flip-game{background:rgba(0,0,0,0.6);border-radius:20px;padding:20px;margin-bottom:20px;border:2px solid var(--primary-green);box-shadow:0 0 25px rgba(168,85,247,0.4)}
        .coin-bet-controls{display:flex;align-items:center;gap:10px;margin-bottom:20px}
        .bet-input{flex:1;padding:12px 15px;border-radius:12px;background:rgba(0,0,0,0.3);border:2px solid rgba(168,85,247,0.6);color:white;font-family:inherit;font-size:16px;font-weight:700;text-align:center;outline:none;min-height:44px}
        .bet-input:focus{box-shadow:0 0 15px rgba(168,85,247,0.6);border-color:#a855f7}
        .bet-buttons{display:flex;gap:8px;margin-top:15px}
        .bet-btn{padding:12px 15px;background:rgba(168,85,247,0.2);border:2px solid rgba(168,85,247,0.5);border-radius:10px;color:white;cursor:pointer;font-size:14px;font-weight:700;min-width:65px;text-align:center;flex:1}
        .bet-btn.active{background:linear-gradient(135deg,#a855f7,#7c3aed);border-color:#a855f7;box-shadow:0 5px 15px rgba(168,85,247,0.4)}
        .coin-container{width:150px;height:150px;margin:0 auto 20px;perspective:1000px}
        .coin{width:100%;height:100%;position:relative;transform-style:preserve-3d;transform:rotateY(0deg);transition:none}
        .coin-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 0 20px rgba(0,0,0,0.5);overflow:hidden}
        .coin-face img{width:100%;height:100%;object-fit:cover}
        .coin-front{background:linear-gradient(45deg,#a855f7,#7c3aed);transform:rotateY(0deg)}
        .coin-back{background:linear-gradient(45deg,#7c3aed,#a855f7);transform:rotateY(180deg)}
        .gold-side{filter:sepia(1) saturate(2) hue-rotate(10deg) brightness(1.2)}
        @keyframes coinSpin{0%{transform:rotateY(0)}25%{transform:rotateY(180deg) translateY(-20px)}50%{transform:rotateY(360deg) translateY(0)}75%{transform:rotateY(540deg) translateY(-10px)}100%{transform:rotateY(var(--final-rotation,720deg)) translateY(0)}}
        .coin-spinning{animation:coinSpin 2.5s cubic-bezier(0.4,2.4,0.8,0.9) forwards}
        .coin-final{animation:none!important;transform:rotateY(var(--final-rotation,0deg))!important}
        .game-result{background:rgba(0,0,0,0.8);border-radius:15px;padding:15px;margin-top:20px;text-align:center}
        .result-text{font-size:18px;font-weight:700;margin-bottom:10px}
        .win-amount{font-size:24px;font-weight:800;color:#27ae60}
        .loss-amount{font-size:24px;font-weight:800;color:#e74c3c}
        .bonus-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
        .bonus-game-card{background:var(--glass-bg);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);border-radius:16px;overflow:hidden;border:1px solid var(--glass-border);cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(0,0,0,0.3)}
        .bonus-game-card:active{transform:scale(0.97)}
        .game-banner{width:100%;height:120px;object-fit:cover;display:block}
        .game-content{padding:12px}
        .game-title{font-size:14px;font-weight:700;color:white;margin-bottom:4px;text-align:center}
        .game-description{font-size:11px;color:var(--text-muted);text-align:center;line-height:1.3}
        .game-icon{font-size:20px;margin-bottom:8px;text-align:center;color:var(--primary-green)}
        .side-selection{display:flex;gap:10px;margin-bottom:20px}
        .side-btn{flex:1;padding:20px 15px;border-radius:15px;background:rgba(255,255,255,0.05);border:2px solid transparent;cursor:pointer;text-align:center;transition:all 0.3s;min-height:140px;display:flex;flex-direction:column;justify-content:center;align-items:center}
        .side-btn.active{border-color:var(--primary-green);background:rgba(168,85,247,0.2);box-shadow:0 5px 20px rgba(168,85,247,0.3)}
        .side-btn.win{border-color:#27ae60;background:rgba(39,174,96,0.2)}
        .side-btn.lose{border-color:#e74c3c;background:rgba(231,76,60,0.2)}
        .side-icon{font-size:24px;margin-bottom:10px;width:70px;height:70px;display:flex;align-items:center;justify-content:center}
        .side-name{font-size:16px;font-weight:700;margin-bottom:5px}
        .side-description{font-size:12px;color:var(--text-muted);text-align:center}
        .probability-display{display:none!important}
        .competition-nav-item{position:relative}
        .competition-nav-icon{position:relative;display:flex;align-items:center;justify-content:center}
        @keyframes trophyGlow{0%,100%{filter:drop-shadow(0 0 8px rgba(255,215,0,0.7))}50%{filter:drop-shadow(0 0 20px rgba(255,215,0,0.9))}}
        .nav-item.competition-nav-item.active svg{animation:trophyGlow 2s infinite alternate}
        .nav-item[data-target="withdrawal-history"] svg{filter:drop-shadow(0 0 8px rgba(168,85,247,0.4));animation:none}
        .galaxy-log-icon{width:40px;height:40px;background:rgba(168,85,247,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(168,85,247,0.4);transition:all 0.3s}
        .galaxy-log-icon:hover{transform:scale(1.05);background:rgba(168,85,247,0.3);border-color:#a855f7}
        .btn-filter{padding:8px 15px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--text-muted);font-size:12px;cursor:pointer;transition:all 0.3s}
        .btn-filter.active{background:var(--primary-green);color:#000;font-weight:700;border-color:var(--primary-green)}
        .btn-filter.small{padding:5px 10px;font-size:10px}
        .log-stat-card{background:rgba(0,0,0,0.3);border-radius:12px;padding:12px;text-align:center;border:1px solid rgba(255,255,255,0.1)}
        .log-item{display:flex;align-items:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:12px;margin-bottom:8px;border-left:4px solid transparent}
        .log-item.earn{border-left-color:#27ae60;background:rgba(39,174,96,0.1)}
        .log-item.spend{border-left-color:#e74c3c;background:rgba(231,76,60,0.1)}
        .log-item.swap{border-left-color:#3498db;background:rgba(52,152,219,0.1)}
        .log-item.withdraw{border-left-color:#9b59b6;background:rgba(155,89,182,0.1)}
        .support-channel-card{background:rgba(255,255,255,0.05);border-radius:12px;padding:15px;margin-bottom:10px;cursor:pointer;transition:all 0.3s;border:1px solid rgba(255,255,255,0.1)}
        .support-channel-card:hover{background:rgba(255,255,255,0.08);transform:translateY(-2px);border-color:rgba(168,85,247,0.4)}
        .withdrawal-overview{text-align:center;margin-bottom:20px}
        .coin-game-rules{margin-top:25px;padding:20px;background:rgba(0,0,0,0.4);border-radius:15px;border:1px solid rgba(255,255,255,0.1)}
        .coin-game-rules h4{font-size:14px;color:var(--gold);margin-bottom:15px}
        .coin-game-rules ul{font-size:12px;color:var(--text-muted);padding-left:20px}
        .coin-game-rules li{margin-bottom:8px}
        .competition-timer-card{background:linear-gradient(135deg,rgba(168,85,247,0.2),rgba(123,97,255,0.2));border:2px solid rgba(168,85,247,0.3);border-radius:20px;padding:25px;margin-bottom:20px;text-align:center;box-shadow:0 10px 30px rgba(168,85,247,0.2)}
        .countdown-display{font-size:36px;font-weight:800;color:#fff;text-shadow:0 0 15px rgba(168,85,247,0.8);margin-bottom:8px;font-family:'Courier New',monospace}
        .timer-label{font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}
        .status-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
        .status-card{background:var(--glass-bg);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);border-radius:16px;padding:20px;text-align:center;border:1px solid var(--glass-border)}
        .status-icon{font-size:30px;margin-bottom:10px}
        .status-value{font-size:24px;font-weight:800;color:#fff;margin-bottom:5px}
        .status-label{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
        .ticket-price-note{background:rgba(168,85,247,0.1);border-radius:12px;padding:15px;margin-bottom:20px;text-align:center;font-size:12px;border:1px solid rgba(168,85,247,0.3)}
        .ticket-controls{display:flex;align-items:center;gap:10px;margin-bottom:20px}
        .ticket-input{flex:1;padding:15px;border-radius:12px;background:rgba(0,0,0,0.3);border:2px solid rgba(168,85,247,0.5);color:white;font-size:18px;font-weight:700;text-align:center;outline:none;min-height:44px}
        .competition-leaderboard{margin-top:25px}
        .leaderboard-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.1)}
        .previous-winners-card{background:var(--glass-bg);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);border-radius:16px;padding:20px;margin-top:20px;border:1px solid var(--glass-border)}
        .winner-item{display:flex;align-items:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:12px;margin-bottom:10px}
        .winner-rank{width:30px;height:30px;background:var(--primary-green);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;margin-right:15px}
        .winner-avatar{width:40px;height:40px;border-radius:50%;margin-right:12px;border:2px solid var(--primary-green)}
        .winner-info{flex:1}
        .winner-name{font-size:14px;font-weight:600;margin-bottom:2px}
        .winner-date{font-size:10px;color:var(--text-muted)}
        .winner-prize{font-size:14px;font-weight:700;color:var(--primary-green)}
        .withdraw-max-btn{position:absolute;right:15px;top:50%;transform:translateY(-50%);background:rgba(168,85,247,0.2);border:1px solid rgba(168,85,247,0.5);border-radius:8px;padding:6px 12px;color:white;font-size:10px;cursor:pointer;font-weight:700;z-index:10}
        .bet-btn.k-style{min-width:55px;padding:10px 12px;font-size:13px;flex:1}
        .user-withdrawal-item{background:rgba(255,255,255,0.05);border-radius:12px;padding:12px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.1)}
        .withdrawal-status{font-size:10px;padding:3px 10px;border-radius:20px;font-weight:700}
        .status-completed{background:rgba(39,174,96,0.2);color:#27ae60}
        .status-pending{background:rgba(255,193,7,0.2);color:#FFC107}
        .status-rejected{background:rgba(231,76,60,0.2);color:#e74c3c}
        .masked-email{font-family:'Courier New',monospace;letter-spacing:1px}
        .competition-rank-card{display:flex;align-items:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:12px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.1)}
        .competition-rank{width:30px;font-weight:800;font-size:14px;text-align:center;margin-right:10px}
        .rank-1 .competition-rank{color:#27ae60;font-weight:900}
        .rank-2 .competition-rank{color:#C0C0C0}
        .rank-3 .competition-rank{color:#CD7F32}
        .competition-user-avatar{width:36px;height:36px;border-radius:50%;margin-right:12px;border:2px solid var(--primary-green)}
        .competition-user-info{flex:1}
        .competition-user-name{font-size:13px;font-weight:600;margin-bottom:2px}
        .competition-ticket-count{font-size:14px;font-weight:700;color:var(--primary-green)}
        .competition-rules-card{background:rgba(0,0,0,0.4);border-radius:16px;padding:20px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.1)}
        .rules-header{display:flex;align-items:center;gap:10px;margin-bottom:15px;color:var(--gold);font-size:16px;font-weight:700}
        .rules-list{font-size:12px;color:var(--text-muted);line-height:1.6;padding-left:20px}
        .rules-list li{margin-bottom:8px}
        .winner-highlight{color:#27ae60;font-weight:700}
        .loser-note{color:#e74c3c;font-weight:600}
        .important-note{background:rgba(255,193,7,0.1);border-left:3px solid #FFC107;padding:10px;margin-top:15px;border-radius:5px;font-size:11px}
        .swap-direction-selector{display:flex;background:rgba(0,0,0,0.3);border-radius:50px;padding:4px;margin-bottom:20px}
        .swap-direction-btn{flex:1;text-align:center;padding:12px;border-radius:50px;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.3s;border:1px solid transparent}
        .swap-direction-btn.active{background:var(--primary-green);color:#000;border-color:var(--primary-green)}
        .withdraw-input-with-max{position:relative}
        .withdraw-input-with-max .custom-input{padding-right:70px}
        .email-display{font-family:'Courier New',monospace;background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;border:1px solid rgba(255,255,255,0.2);font-size:16px;letter-spacing:2px;color:white;text-align:center;margin-top:10px}
        .swap-mode-text{font-size:12px;color:var(--text-muted);text-align:center;margin:10px 0}
        .verification-container{background:var(--glass-bg);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:24px;padding:30px;margin:20px;text-align:center;border:2px solid rgba(168,85,247,0.3);box-shadow:0 10px 40px rgba(0,0,0,0.5)}
        .verification-step{display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,0.3);border-radius:12px;padding:15px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.1);transition:all 0.3s ease}
        .verification-step.active{border-color:var(--primary-green);background:rgba(168,85,247,0.1)}
        .verification-step.completed{border-color:#27ae60;background:rgba(39,174,96,0.1)}
        .verification-step.failed{border-color:#e74c3c;background:rgba(231,76,60,0.1)}
        .step-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold}
        .step-info{flex:1;text-align:left;padding:0 15px}
        .step-title{font-size:14px;font-weight:600;color:white;margin-bottom:3px}
        .step-description{font-size:11px;color:var(--text-muted)}
        .step-status{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px}
        .security-message{background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.3);border-radius:12px;padding:15px;margin:15px 0;color:#e74c3c;font-size:14px}
        .verification-progress{width:100%;height:8px;background:rgba(255,255,255,0.1);border-radius:4px;margin:20px 0;overflow:hidden}
        .progress-bar{height:100%;background:linear-gradient(90deg,var(--primary-green),#7c3aed);border-radius:4px;transition:width 0.5s ease}
        .blocked-container{background:rgba(0,0,0,0.8);border-radius:24px;padding:40px 30px;text-align:center;margin:20px;border:2px solid rgba(231,76,60,0.3);animation:pulse 2s infinite}
        @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(231,76,60,0.4)}70%{box-shadow:0 0 0 10px rgba(231,76,60,0)}100%{box-shadow:0 0 0 0 rgba(231,76,60,0)}}
        .blocked-icon{font-size:60px;margin-bottom:20px;color:#e74c3c}
        .blocked-title{font-size:24px;font-weight:800;color:#e74c3c;margin-bottom:15px}
        .blocked-reason{background:rgba(231,76,60,0.1);border-radius:12px;padding:15px;margin:20px 0;font-size:14px;line-height:1.5}
        .verification-loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:var(--primary-green);animation:spin 1s ease-in-out infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .ip-display{background:rgba(0,0,0,0.5);padding:10px;border-radius:8px;font-family:'Courier New',monospace;font-size:12px;color:#fff;margin-top:5px}
        .notification-message{position:fixed;top:100px;left:50%;transform:translateX(-50%);z-index:1000;background:var(--glass-bg);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:15px;padding:15px 20px;max-width:90%;width:400px;text-align:center;box-shadow:0 5px 20px rgba(0,0,0,0.3);animation:fadeIn 0.3s ease}
        .notification-success{border-color:#27ae60;background:rgba(39,174,96,0.1)}
        .notification-error{border-color:#e74c3c;background:rgba(231,76,60,0.1)}
        .notification-warning{border-color:#FFC107;background:rgba(255,193,7,0.1)}
        .notification-info{border-color:#3498db;background:rgba(52,152,219,0.1)}
        .browser-block-container{position:fixed;top:0;left:0;width:100%;height:100%;background:#202020;z-index:9999;display:flex;justify-content:center;align-items:center;padding:20px}
        .browser-block-box{background:rgba(32,32,32,0.95);border:2px solid #e74c3c;border-radius:20px;padding:40px 30px;text-align:center;max-width:400px;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
        .browser-block-icon{font-size:60px;color:#e74c3c;margin-bottom:20px}
        .browser-block-title{font-size:24px;font-weight:800;color:#e74c3c;margin-bottom:15px}
        .browser-block-text{color:#fff;font-size:14px;line-height:1.5;margin-bottom:25px}
        .browser-open-btn{display:inline-flex;align-items:center;gap:10px;padding:15px 25px;background:linear-gradient(90deg,#0088cc,#0099ff);color:#fff;border-radius:15px;font-weight:800;text-decoration:none;font-size:16px;margin-top:10px}
    </style>
</head>
<body>
    <!-- ===== ŸÜÿ∏ÿßŸÖ ŸÖŸÜÿπ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä ===== -->
    <div id="browser-block" class="browser-block-container" style="display:none">
        <div class="browser-block-box">
            <div class="browser-block-icon">üö´</div>
            <div class="browser-block-title">OPEN IN TELEGRAM ONLY</div>
            <div class="browser-block-text">
                This web app works only inside <strong>Telegram</strong>.<br><br>
                Please open this link in:<br>
                ‚Ä¢ Telegram mobile app<br>
                ‚Ä¢ Telegram Web (web.telegram.org)<br>
                <br>
                <span style="color:#FFC107">‚õî Blocked: Chrome, Firefox, Safari, Edge, etc.</span>
            </div>
            <div style="margin-top:20px">
                <a href="https://t.me/GLXGalaxyBot" class="browser-open-btn" target="_blank">
                    <i class="fab fa-telegram"></i> OPEN IN TELEGRAM
                </a>
            </div>
        </div>
    </div>

    <div id="security-verification" class="verification-container" style="display:none">
        <div style="margin-bottom:25px">
            <img src="https://i.ibb.co/tTkJX1Qy/logo.png" alt="GLX Galaxy" style="width:80px;height:80px;border-radius:50%;margin-bottom:15px;border:3px solid var(--primary-green)">
            <h1 style="font-size:24px;margin-bottom:8px;color:#fff">GLX Galaxy Security</h1>
            <p style="color:var(--text-muted);font-size:13px">Secure verification process in progress</p>
        </div>
        <div class="verification-progress">
            <div id="verification-progress-bar" class="progress-bar" style="width:0%"></div>
        </div>
        <div id="verification-steps"></div>
        <div id="verification-result" style="display:none;margin-top:20px"></div>
    </div>
    
    <div id="blocked-access" class="blocked-container" style="display:none">
        <div class="blocked-icon">üö´</div>
        <div class="blocked-title">ACCESS BLOCKED</div>
        <div id="blocked-reason" class="blocked-reason"></div>
        <p style="color:var(--text-muted);font-size:12px;margin-top:20px">If you believe this is an error, please contact support.</p>
    </div>
    
    <div class="app-container" style="display:none" id="app-container">
        <!-- ÿ®ÿßŸÇŸä ÿßŸÑŸÉŸàÿØ ŸÉŸÖÿß ŸáŸà ÿ®ÿØŸàŸÜ ÿ™ÿ∫ŸäŸäÿ± -->
        <div class="hud-container">
            <div>
                <div class="user-name" id="home-username">Explorer</div>
                <div class="user-rank" id="home-user-level" style="display:none"></div>
                <div style="display:flex;align-items:center;gap:15px;margin-top:5px">
                    <div class="stats-pill" style="margin:0;padding:6px 12px">
                        <span style="color:var(--gold)">GLX:</span>
                        <span id="hud-glx-balance" style="color:#fff;font-weight:700">0</span>
                    </div>
                    <div class="stats-pill" style="margin:0;padding:6px 12px">
                        <span style="color:var(--gold)">TON:</span>
                        <span id="hud-ton-balance" style="color:#fff;font-weight:700">0.0000</span>
                    </div>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:10px">
                <div class="galaxy-log-icon" id="galaxy-log-button">
                    <span style="font-size:20px">üìú</span>
                </div>
                <div class="hud-avatar">
                    <img src="https://i.ibb.co/tTkJX1Qy/logo.png" alt="User">
                </div>
            </div>
        </div>
        
        <main id="home" class="content-section active">
            <!-- ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© -->
        </main>
        
        <!-- ÿ®ÿßŸÇŸä ÿßŸÑÿµŸÅÿ≠ÿßÿ™ ŸÉŸÖÿß ŸáŸä -->
        
    </div>
    
    <!-- ===== ÿ®ÿßŸÇŸä ÿßŸÑŸÉŸàÿØ ŸÉŸÖÿß ŸáŸà ===== -->
    
    <script>
        (function(){
            'use strict';
            
            // ===== 1. ŸÜÿ∏ÿßŸÖ ŸÖŸÜÿπ ŸÅÿ™ÿ≠ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä =====
            function isInTelegramApp() {
                const ua = navigator.userAgent.toLowerCase();
                const hostname = window.location.hostname;
                
                // 1. ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Telegram WebApp API
                if (window.Telegram && window.Telegram.WebApp) {
                    return true;
                }
                
                // 2. ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ hostname
                if (hostname.includes('web.telegram.org') || 
                    hostname.includes('t.me')) {
                    return true;
                }
                
                // 3. ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ user agent
                if (ua.includes('telegram') || ua.includes('webview')) {
                    return true;
                }
                
                // 4. ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ referrer
                if (document.referrer) {
                    const ref = document.referrer.toLowerCase();
                    if (ref.includes('telegram.org') || ref.includes('t.me')) {
                        return true;
                    }
                }
                
                // 5. ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÖÿπŸÑŸÖÿßÿ™ URL
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('tgWebAppStartParam') || urlParams.get('tgWebAppData')) {
                    return true;
                }
                
                return false;
            }
            
            // ===== 2. ŸÜÿ∏ÿßŸÖ ÿ®ÿµŸÖÿ© ÿßŸÑÿ¨Ÿáÿßÿ≤ =====
            async function generateDeviceFingerprint() {
                try {
                    const components = [];
                    
                    // 1. User Agent
                    components.push(navigator.userAgent);
                    
                    // 2. Screen Properties
                    components.push(`${screen.width}x${screen.height}`);
                    components.push(screen.colorDepth.toString());
                    components.push(screen.pixelDepth?.toString() || '');
                    
                    // 3. Platform
                    components.push(navigator.platform);
                    components.push(navigator.vendor || '');
                    
                    // 4. Languages
                    components.push(navigator.languages ? navigator.languages.join(',') : navigator.language);
                    
                    // 5. Timezone
                    components.push(new Date().getTimezoneOffset().toString());
                    components.push(Intl.DateTimeFormat().resolvedOptions().timeZone);
                    
                    // 6. Canvas Fingerprinting
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    if (ctx) {
                        canvas.width = 200;
                        canvas.height = 50;
                        ctx.textBaseline = 'top';
                        ctx.font = '14px Arial';
                        ctx.fillText('GLX Galaxy Fingerprint', 10, 10);
                        components.push(canvas.toDataURL().substring(0, 100));
                    }
                    
                    // 7. WebGL Info
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    if (gl) {
                        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                        if (debugInfo) {
                            components.push(gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL));
                            components.push(gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL));
                        }
                    }
                    
                    // 8. Audio Context
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        components.push(audioContext.sampleRate.toString());
                        audioContext.close();
                    } catch(e) {}
                    
                    // 9. Plugins
                    if (navigator.plugins) {
                        for (let i = 0; i < navigator.plugins.length; i++) {
                            components.push(navigator.plugins[i].name);
                        }
                    }
                    
                    // 10. Fonts
                    const fonts = ['Arial', 'Times New Roman', 'Courier New', 'Verdana', 'Tahoma'];
                    const fontCheck = [];
                    fonts.forEach(font => {
                        fontCheck.push(document.fonts.check(`12px "${font}"`));
                    });
                    components.push(fontCheck.join(','));
                    
                    // 11. Touch Support
                    components.push('ontouchstart' in window);
                    components.push(navigator.maxTouchPoints || 0);
                    
                    // 12. Hardware Concurrency
                    components.push(navigator.hardwareConcurrency || 0);
                    
                    // 13. Device Memory
                    components.push(navigator.deviceMemory || 0);
                    
                    // 14. Generate SHA-256 Hash
                    const fingerprintString = components.join('|');
                    
                    async function sha256(message) {
                        const msgBuffer = new TextEncoder().encode(message);
                        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                        const hashArray = Array.from(new Uint8Array(hashBuffer));
                        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    }
                    
                    return await sha256(fingerprintString);
                    
                } catch (error) {
                    console.error('Error generating fingerprint:', error);
                    // Fallback to simple fingerprint
                    const fallback = [
                        navigator.userAgent,
                        screen.width + 'x' + screen.height,
                        navigator.platform,
                        new Date().getTimezoneOffset()
                    ].join('|');
                    
                    // Simple hash function for fallback
                    let hash = 0;
                    for (let i = 0; i < fallback.length; i++) {
                        const char = fallback.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash;
                    }
                    return 'fallback_' + Math.abs(hash).toString(16);
                }
            }
            
            // ===== ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ÿπŸÜÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ =====
            function performInitialSecurityCheck() {
                // 1. ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠
                if (!isInTelegramApp()) {
                    document.getElementById('browser-block').style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    console.error('‚ùå BLOCKED: Attempt to open in external browser');
                    return false;
                }
                
                // 2. ÿπÿ±ÿ∂ ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ
                document.getElementById('security-verification').style.display = 'block';
                return true;
            }
            
            // ===== ÿ®ÿØÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ =====
            if (!performInitialSecurityCheck()) {
                // ÿ™ŸÖ ŸÖŸÜÿπ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
                throw new Error('Access blocked: External browser detected');
            }
            
            console.log("‚úÖ Passed initial browser check");
            
        })();
    </script>
    
    <script>
        // ===== ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ =====
        const SECURITY_CONFIG = {
            errorStyle: {background:'rgba(231,76,60,0.1)',border:'1px solid rgba(231,76,60,0.3)',color:'#e74c3c',borderRadius:'12px',padding:'15px',margin:'15px 0'},
            warningStyle: {background:'rgba(255,193,7,0.1)',border:'1px solid rgba(255,193,7,0.3)',color:'#FFC107',borderRadius:'12px',padding:'15px',margin:'15px 0'},
            successStyle: {background:'rgba(39,174,96,0.1)',border:'1px solid rgba(39,174,96,0.3)',color:'#27ae60',borderRadius:'12px',padding:'15px',margin:'15px 0'},
            infoStyle: {background:'rgba(52,152,219,0.1)',border:'1px solid rgba(52,152,219,0.3)',color:'#3498db',borderRadius:'12px',padding:'15px',margin:'15px 0'}
        };
        
        const APP_CONFIG = {
            botUsername: 'testtt1257bot',
            botWallet: 'UQB2IqqJtC8NtRgxksq80c_FC8RqShxpGDKA3e4aJFwjvwgv',
            botToken: '7066931017:AAHwuXbgaKHNrHrbf6jaoC8LDk0lSCPimgI',
            defaultSettings: {
                adRewardMonetag: 1000, adRewardGiga: 2000, adRewardAdsgram: 2000,
                limitMonetag: 50, limitGiga: 300, limitAdsgram: 300,
                minTonWithdrawal: 0.05, minFaucetPayWithdrawal: 0.0001,
                referralReward: 10000, pricePerClick: 0.0015,
                glxToTonRate: 0.0000001, tonToGlxRate: 10000000,
                ticketPrice: 10000, ticketTonValue: 0.001,
                competitionDuration: 86400000, breakDuration: 3600000,
                dailyRewards: [2000, 3000, 5000, 7000, 9000, 12000, 15000],
                coinFlipWinChance: 45,
                slotsPayouts: {'üåüüåüüåü':10000,'ü™êü™êü™ê':5000,'üí´üí´üí´':2500,'‚≠ê‚≠ê‚≠ê':1200,'üåüüåü':700,'default':500},
                promoCodeRewards: 5000
            }
        };
        
        const BOT_USERNAME = APP_CONFIG.botUsername;
        const BOT_WALLET = APP_CONFIG.botWallet;
        const BOT_TOKEN = APP_CONFIG.botToken;
        
        const GLX_TO_TON_RATE = 0.0000001;
        const TON_TO_GLX_RATE = 10000000;
        const TICKET_PRICE = 10000;
        const TICKET_TON_VALUE = 0.001;
        const COMPETITION_DURATION = 86400000;
        const BREAK_DURATION = 3600000;
        const ADSGRAM_BLOCK_ID = 'int-18879';
        const AD_CLICK_DELAY = 3000;
        
        const slotsSymbols = ['üåü', 'ü™ê', 'üí´', '‚≠ê', 'üöÄ', 'üåå'];
        const slotsPayouts = {
            'üåüüåüüåü': 10000, 'ü™êü™êü™ê': 5000, 'üí´üí´üí´': 2500,
            '‚≠ê‚≠ê‚≠ê': 1200, 'üåüüåü': 700, 'default': 500
        };
        
        // ===== ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ© =====
        let db = null;
        let appData = {};
        let appSettings = { ...APP_CONFIG.defaultSettings };
        let isAdScriptLoaded = false;
        let isLeaderboardLoaded = false;
        let AdController = null;
        let selectedCategory = 'channel';
        let selectedCount = 100;
        let selectedCost = 0.15;
        let currentTaskId = '';
        let depositTransactionId = '';
        let isSpinning = false;
        let lastAdClickTime = 0;
        let withdrawalType = 'faucetpay';
        let swapDirection = 'glx_to_ton';
        let competitionInterval = null;
        let countdownInterval = null;
        
        let coinGame = {
            isFlipping: false, chosenSide: 'glx', betAmount: 1000,
            lastFlipResult: null, winChance: 45, lossChance: 55,
            currentRotation: 0, animationId: null
        };
        
        let competitionData = {
            isActive: true, startTime: Date.now(),
            endTime: Date.now() + COMPETITION_DURATION,
            totalTickets: 0, prizePool: 0,
            userTickets: {}, winners: []
        };
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ© =====
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification-message notification-${type}`;
            notification.innerHTML = `<div style="font-size:14px;font-weight:600">${message}</div>`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }
        
        function showStyledMessage(message, type = 'error', containerId = 'app-container') {
            const container = document.getElementById(containerId);
            if (!container) return;
            const existingMsg = container.querySelector('.security-message');
            if (existingMsg) existingMsg.remove();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'security-message';
            const style = SECURITY_CONFIG[type + 'Style'] || SECURITY_CONFIG.errorStyle;
            Object.assign(messageDiv.style, style);
            let icon = '‚ùå';
            if (type === 'warning') icon = '‚ö†Ô∏è';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'info') icon = '‚ÑπÔ∏è';
            messageDiv.innerHTML = `<div style="display:flex;align-items:center;gap:10px;font-size:14px"><div style="font-size:20px">${icon}</div><div>${message}</div></div>`;
            container.insertBefore(messageDiv, container.firstChild);
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.opacity = '0';
                    messageDiv.style.transition = 'opacity 0.5s';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 500);
                }
            }, 5000);
            return messageDiv;
        }
        
        // ===== ŸÜÿ∏ÿßŸÖ ÿ®ÿµŸÖÿ© ÿßŸÑÿ¨Ÿáÿßÿ≤ ÿßŸÑŸÖÿ≠ÿ≥ŸÜ =====
        async function getDeviceFingerprint() {
            return await generateDeviceFingerprint();
        }
        
        async function checkDeviceFingerprint(userId) {
            try {
                const deviceFingerprint = await getDeviceFingerprint();
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ÿµŸÖÿ© ŸÖÿπ ÿßŸÑÿÆÿßÿØŸÖ
                const result = await callAPI('checkDeviceFingerprint', {
                    userId: userId,
                    deviceFingerprint: deviceFingerprint
                });
                
                if (result.success) {
                    if (result.data.isDuplicate) {
                        return {
                            allowed: false,
                            reason: `‚ùå Device already used by another account\n\nDevice fingerprint detected on account: ${result.data.existingUserId}\nThis device can only be used for one account.`,
                            fingerprint: deviceFingerprint
                        };
                    }
                    return {
                        allowed: true,
                        fingerprint: deviceFingerprint,
                        isNewDevice: result.data.isNewDevice
                    };
                } else {
                    return {
                        allowed: false,
                        reason: '‚ùå Device verification failed: ' + result.error,
                        fingerprint: deviceFingerprint
                    };
                }
            } catch (error) {
                console.error('Device fingerprint check error:', error);
                return {
                    allowed: false,
                    reason: '‚ùå Device verification error. Please try again.',
                    fingerprint: null
                };
            }
        }
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ£ŸÖŸÜŸä =====
        function createVerificationStep(stepNumber, title, description, status = 'pending') {
            let icon = 'üîí', statusIcon = '<div class="verification-loading"></div>', statusClass = '';
            if (status === 'completed') { icon = '‚úÖ'; statusIcon = '‚úì'; statusClass = 'completed'; }
            else if (status === 'failed') { icon = '‚ùå'; statusIcon = '‚úó'; statusClass = 'failed'; }
            else if (status === 'active') { icon = '‚è≥'; statusClass = 'active'; }
            return `<div class="verification-step ${statusClass}"><div class="step-icon">${icon}</div><div class="step-info"><div class="step-title">${title}</div><div class="step-description">${description}</div></div><div class="step-status">${statusIcon}</div></div>`;
        }
        
        async function performSecurityVerification() {
            const stepsContainer = document.getElementById('verification-steps');
            const progressBar = document.getElementById('verification-progress-bar');
            const resultContainer = document.getElementById('verification-result');
            
            // ÿßŸÑÿÆÿ∑Ÿàÿ© 1: ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠
            stepsContainer.innerHTML = createVerificationStep(1, 'Browser Check', 'Verifying Telegram environment', 'active');
            progressBar.style.width = '25%';
            await new Promise(resolve => setTimeout(resolve, 800));
            
            if (!isInTelegramApp()) {
                stepsContainer.innerHTML += createVerificationStep(1, 'Browser Check', 'External browser detected - BLOCKED', 'failed');
                showBlockedAccess('‚ùå This web app works only inside Telegram. Please open in Telegram app or Telegram Web.');
                return null;
            }
            stepsContainer.innerHTML = createVerificationStep(1, 'Browser Check', 'Telegram environment verified', 'completed');
            progressBar.style.width = '50%';
            
            // ÿßŸÑÿÆÿ∑Ÿàÿ© 2: ÿ¨ŸÖÿπ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            let user = null;
            let isExisting = false;
            
            if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
                user = {
                    id: tgUser.id.toString(),
                    first_name: tgUser.first_name,
                    last_name: tgUser.last_name || '',
                    username: tgUser.username || ''
                };
                isExisting = true;
            } else {
                user = {
                    id: 'telegram_user_' + Date.now(),
                    first_name: 'Telegram',
                    last_name: 'User',
                    username: 'telegram_user'
                };
                isExisting = false;
            }
            
            stepsContainer.innerHTML += createVerificationStep(2, 'User Identification', isExisting ? 'Existing user detected' : 'New user session', 'active');
            progressBar.style.width = '75%';
            await new Promise(resolve => setTimeout(resolve, 800));
            
            // ÿßŸÑÿÆÿ∑Ÿàÿ© 3: ÿ®ÿµŸÖÿ© ÿßŸÑÿ¨Ÿáÿßÿ≤
            stepsContainer.innerHTML += createVerificationStep(3, 'Device Fingerprint', 'Generating device signature', 'active');
            progressBar.style.width = '90%';
            
            const deviceCheck = await checkDeviceFingerprint(user.id);
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            if (!deviceCheck.allowed) {
                stepsContainer.innerHTML += createVerificationStep(3, 'Device Fingerprint', 'Device already used - BLOCKED', 'failed');
                showBlockedAccess(deviceCheck.reason);
                return null;
            }
            
            stepsContainer.innerHTML += createVerificationStep(3, 'Device Fingerprint', 'Device verified successfully', 'completed');
            progressBar.style.width = '100%';
            
            resultContainer.innerHTML = `<div style="background:rgba(39,174,96,0.1);border:1px solid rgba(39,174,96,0.3);border-radius:12px;padding:15px;text-align:center"><div style="font-size:20px;margin-bottom:10px">‚úÖ</div><div style="font-weight:700;color:#27ae60;margin-bottom:5px">Verification Complete</div><div style="font-size:12px;color:var(--text-muted)">Security checks passed. Loading app...</div></div>`;
            resultContainer.style.display = 'block';
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            return { user, isExisting, deviceFingerprint: deviceCheck.fingerprint };
        }
        
        function showBlockedAccess(reason) {
            document.getElementById('security-verification').style.display = 'none';
            document.getElementById('blocked-access').style.display = 'block';
            document.getElementById('blocked-reason').innerHTML = reason;
        }
        
        function showMainApp() {
            document.getElementById('security-verification').style.display = 'none';
            document.getElementById('blocked-access').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
        }
        
        // ===== ÿØŸàÿßŸÑ Firebase =====
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        try {
            if (firebase && firebase.initializeApp) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log("‚úÖ Firebase initialized");
            }
        } catch (error) {
            console.error("‚ùå Firebase error:", error);
        }
        
        async function fetchAppSettings() {
            if (!db) return appSettings;
            try {
                const doc = await db.collection('settings').doc('appSettings').get();
                if (doc.exists) {
                    const firebaseSettings = doc.data();
                    const updatedSettings = { ...appSettings, ...firebaseSettings };
                    console.log("‚úÖ Settings loaded from Firebase");
                    return updatedSettings;
                }
                return appSettings;
            } catch (error) {
                console.error("Error fetching settings:", error);
                return appSettings;
            }
        }
        
        async function getUpdatedSettings() {
            const newSettings = await fetchAppSettings();
            appSettings = newSettings;
            return newSettings;
        }
        
        // ===== ÿØŸàÿßŸÑ API =====
        const API_URL = "https://silent-block-bedf.ahmedrabieharoun.workers.dev";
        
        async function callAPI(action, data = {}) {
            try {
                const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
                const response = await fetch(`${API_URL}/api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId || '',
                        'X-Telegram-Data': window.Telegram?.WebApp?.initData || '',
                        'X-Action': action
                    },
                    body: JSON.stringify({
                        action: action, data: data, userId: userId, timestamp: Date.now()
                    })
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                if (action === 'getCompetitionData' && result.success && result.data.competitionData && !result.data.competitionData.userTickets) {
                    result.data.competitionData.userTickets = {};
                }
                return result;
            } catch (error) {
                console.error('API call failed:', error);
                showNotification("Connection error. Please try again.", "error");
                return { success: false, error: error.message };
            }
        }
        
        // ===== ÿßŸÑÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© =====
        document.addEventListener('DOMContentLoaded', async function() {
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ£ŸÖŸÜŸä
            const verificationResult = await performSecurityVerification();
            if (!verificationResult) return;
            
            showMainApp();
            const { user, isExisting, deviceFingerprint } = verificationResult;
            
            // ÿ•ÿπÿØÿßÿØ Telegram WebApp
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.headerColor = '#202020';
                window.Telegram.WebApp.backgroundColor = '#202020';
            }
            
            // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            await initializeUser(user, deviceFingerprint);
            initializeApp(user);
        });
        
        async function initializeUser(user, deviceFingerprint) {
            const result = await callAPI('initializeUser', { 
                user: user,
                deviceFingerprint: deviceFingerprint
            });
            
            if (result.success) {
                appData = result.data.userData || {};
                await getUpdatedSettings();
                renderUI(user);
                renderDailyBonusUI();
                updateAvailableSpins();
                handleReferral(user);
            } else {
                console.error('Error initializing user:', result.error);
            }
        }
        
        async function handleReferral(user) {
            const tg = window.Telegram?.WebApp;
            const startParam = tg?.initDataUnsafe?.start_param;
            if (startParam && startParam.startsWith('ref')) {
                const referrerId = startParam.replace('ref', '');
                if (referrerId && referrerId !== user.id) {
                    const result = await callAPI('handleReferral', {
                        userId: user.id, referrerId: referrerId, rewardAmount: 10000
                    });
                    if (result.success) {
                        showNotification("üéâ Welcome bonus activated! +10,000 GLX", "success");
                    }
                }
            }
        }
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© =====
        function renderUI(user) {
            if (!appData) return;
            const GLX = Math.floor(appData.dogsBalance || 0);
            const ton = (appData.tonBalance || 0).toFixed(7);
            const userLevel = getLevel(GLX);
            const userTickets = appData.competitionTickets || 0;
            
            document.getElementById('home-user-level').textContent = `Level ${userLevel}`;
            document.getElementById('total-GLX-balance').textContent = GLX.toLocaleString();
            document.getElementById('home-ton-balance').textContent = parseFloat(ton).toFixed(4);
            document.getElementById('swap-max-GLX').textContent = GLX.toLocaleString();
            document.getElementById('swap-max-TON').textContent = parseFloat(ton).toFixed(4);
            document.getElementById('user-tickets').textContent = userTickets;
            document.querySelectorAll('.user-ton-balance').forEach(el => el.textContent = parseFloat(ton).toFixed(4));
            document.getElementById('referral-count-display').textContent = (appData.referrals || 0);
            document.getElementById('hud-glx-balance').textContent = GLX.toLocaleString();
            document.getElementById('hud-ton-balance').textContent = parseFloat(ton).toFixed(4);
            
            const monetagCount = appData.adsMonetag || 0;
            const gigaCount = appData.adsGiga || 0;
            const adsgramCount = appData.adsAdsgram || 0;
            const limitM = appSettings.limitMonetag || 50;
            const limitG = appSettings.limitGiga || 300;
            const limitA = appSettings.limitAdsgram || 300;
            
            document.getElementById('monetag-count').textContent = monetagCount;
            document.getElementById('monetag-limit').textContent = limitM;
            document.getElementById('giga-count').textContent = gigaCount;
            document.getElementById('giga-limit').textContent = limitG;
            document.getElementById('adsgram-count').textContent = adsgramCount;
            document.getElementById('adsgram-limit').textContent = limitA;
            
            if (monetagCount >= limitM) {
                const el = document.getElementById('monetag-ad-task');
                el.style.opacity = '0.5';
                el.style.pointerEvents = 'none';
            }
            if (gigaCount >= limitG) {
                const el = document.getElementById('gigapub-ad-task');
                el.style.opacity = '0.5';
                el.style.pointerEvents = 'none';
            }
            if (adsgramCount >= limitA) {
                const el = document.getElementById('adsgram-ad-task');
                el.style.opacity = '0.5';
                el.style.pointerEvents = 'none';
            }
            
            fetchAndRenderTasks(user);
            renderHistory(document.getElementById('full-history-list'), 50, user);
            calculateSwap();
        }
        
        function initializeApp(user) {
            const fullName = `${user.first_name} ${user.last_name}`.trim();
            document.getElementById('home-username').textContent = fullName;
            document.getElementById('referral-link-display').textContent = `https://t.me/${BOT_USERNAME}?startapp=ref${user.id}`;
            
            if (window.Adsgram) {
                AdController = window.Adsgram.init({ blockId: ADSGRAM_BLOCK_ID });
            }
            
            setupEventListeners(user);
            setupGalaxyLogButton();
            renderCreateTaskUI();
            initSlotsGame();
            initCoinFlipGame();
            initPromoCodes();
            
            setTimeout(() => {
                isAdScriptLoaded = typeof show_10286382 === "function";
            }, 2500);
            
            selectWithdrawalType('faucetpay');
            selectSwapDirection('glx_to_ton');
            
            const ticketInput = document.getElementById('ticket-amount');
            if (ticketInput) {
                ticketInput.addEventListener('input', updateTicketCostDisplay);
                updateTicketCostDisplay();
            }
            
            initializeCompetition();
            loadUserCompetitionData();
        }
        
        // ===== ÿØŸàÿßŸÑ Swap =====
        window.selectSwapDirection = function(direction) {
            swapDirection = direction;
            document.querySelectorAll('.swap-direction-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.swap-direction-btn').forEach(btn => {
                if (btn.textContent.includes(direction === 'glx_to_ton' ? 'GLX ‚Üí TON' : 'TON ‚Üí GLX')) {
                    btn.classList.add('active');
                }
            });
            if (direction === 'glx_to_ton') {
                document.getElementById('glx-to-ton-section').style.display = 'block';
                document.getElementById('ton-to-glx-section').style.display = 'none';
                document.querySelector('.page-header p').textContent = '100K GLX = 0.01 TON';
            } else {
                document.getElementById('glx-to-ton-section').style.display = 'none';
                document.getElementById('ton-to-glx-section').style.display = 'block';
                document.querySelector('.page-header p').textContent = '0.01 TON = 100K GLX';
            }
            calculateSwap();
        };
        
        window.calculateSwap = function() {
            if (swapDirection === 'glx_to_ton') {
                const GLXInput = parseFloat(document.getElementById('swap-input-amount').value) || 0;
                const tonOutput = GLXInput * GLX_TO_TON_RATE;
                document.getElementById('swap-output-amount').textContent = tonOutput.toFixed(7);
            } else {
                const TONInput = parseFloat(document.getElementById('ton-input-amount').value) || 0;
                const glxOutput = TONInput * TON_TO_GLX_RATE;
                document.getElementById('ton-output-amount').textContent = Math.floor(glxOutput).toLocaleString();
            }
        };
        
        window.setMaxSwap = function(type) {
            if (type === 'glx' || swapDirection === 'glx_to_ton') {
                const currentBalance = appData.dogsBalance || 0;
                if (currentBalance < 1000) {
                    showNotification("Minimum swap is 1,000 GLX", "warning");
                    return;
                }
                document.getElementById('swap-input-amount').value = currentBalance;
                calculateSwap();
            } else {
                const currentBalance = appData.tonBalance || 0;
                if (currentBalance < 0.0001) {
                    showNotification("Minimum swap is 0.0001 TON", "warning");
                    return;
                }
                document.getElementById('ton-input-amount').value = currentBalance.toFixed(4);
                calculateSwap();
            }
        };
        
        window.executeSwap = function() {
            if (swapDirection === 'glx_to_ton') executeGLXtoTONSwap();
            else executeTONtoGLXSwap();
        };
        
        async function executeGLXtoTONSwap() {
            const GLXInput = parseFloat(document.getElementById('swap-input-amount').value) || 0;
            const currentGLX = appData.dogsBalance || 0;
            if (GLXInput < 1000) { showNotification("Min swap: 1,000 GLX", "warning"); return; }
            if (GLXInput > currentGLX) { showNotification("Insufficient GLX Balance", "warning"); return; }
            const tonValue = GLXInput * GLX_TO_TON_RATE;
            if (!confirm(`Swap ${GLXInput.toLocaleString()} GLX for ${tonValue.toFixed(7)} TON?\n\nRate: 100,000 GLX = 0.01 TON`)) return;
            const result = await callAPI('executeSwap', { type: 'glx_to_ton', amount: GLXInput, tonValue: tonValue });
            if (result.success) {
                appData.dogsBalance = result.data.newGLXBalance;
                appData.tonBalance = result.data.newTONBalance;
                showNotification(`Swap Complete!\n\n-${GLXInput.toLocaleString()} GLX\n+${tonValue.toFixed(7)} TON`, "success");
                document.getElementById('swap-input-amount').value = '';
                document.getElementById('swap-output-amount').textContent = '0.0000000';
                switchTab('home');
                renderUI({ id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id });
            } else {
                showNotification("Error: " + result.error, "error");
            }
        }
        
        async function executeTONtoGLXSwap() {
            const TONInput = parseFloat(document.getElementById('ton-input-amount').value) || 0;
            const currentTON = appData.tonBalance || 0;
            if (TONInput < 0.0001) { showNotification("Min swap: 0.0001 TON", "warning"); return; }
            if (TONInput > currentTON) { showNotification("Insufficient TON Balance", "warning"); return; }
            const glxValue = TONInput * TON_TO_GLX_RATE;
            if (!confirm(`Swap ${TONInput.toFixed(4)} TON for ${glxValue.toLocaleString()} GLX?\n\nRate: 0.01 TON = 100,000 GLX`)) return;
            const result = await callAPI('executeSwap', { type: 'ton_to_glx', amount: TONInput, glxValue: glxValue });
            if (result.success) {
                appData.tonBalance = result.data.newTONBalance;
                appData.dogsBalance = result.data.newGLXBalance;
                showNotification(`Swap Complete!\n\n-${TONInput.toFixed(4)} TON\n+${glxValue.toLocaleString()} GLX`, "success");
                document.getElementById('ton-input-amount').value = '';
                document.getElementById('ton-output-amount').textContent = '0';
                switchTab('home');
                renderUI({ id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id });
            } else {
                showNotification("Error: " + result.error, "error");
            }
        }
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑÿ£ŸÑÿπÿßÿ® =====
        window.openGame = function(gameType) {
            document.getElementById('coin-flip-section').style.display = 'none';
            document.getElementById('promo-codes-section').style.display = 'none';
            document.getElementById('daily-streak-section').style.display = 'none';
            document.getElementById('galaxy-slots-section').style.display = 'none';
            const grid = document.querySelector('.bonus-grid');
            grid.style.display = 'none';
            document.getElementById(gameType + '-section').style.display = 'block';
            if (gameType === 'coin-flip') resetCoinFlipGame();
            else if (gameType === 'galaxy-slots') { initSlotsGame(); updateAvailableSpins(); }
            else if (gameType === 'daily-streak') renderDailyBonusUI();
        };
        
        window.closeGame = function() {
            document.getElementById('coin-flip-section').style.display = 'none';
            document.getElementById('promo-codes-section').style.display = 'none';
            document.getElementById('daily-streak-section').style.display = 'none';
            document.getElementById('galaxy-slots-section').style.display = 'none';
            const grid = document.querySelector('.bonus-grid');
            grid.style.display = 'grid';
        };
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ© =====
        async function initializeCompetition() {
            try {
                const result = await callAPI('getCompetitionData');
                if (result.success) {
                    competitionData = result.data.competitionData || competitionData;
                    if (!competitionData.isActive) {
                        await createNewCompetition();
                    } else {
                        startCountdown();
                        updateCompetitionUI();
                        loadPreviousWinners();
                    }
                } else {
                    await createNewCompetition();
                }
            } catch (error) {
                console.error("Error initializing competition:", error);
                await createNewCompetition();
            }
        }
        
        async function createNewCompetition() {
            const now = Date.now();
            competitionData = {
                isActive: true, breakMode: false,
                startTime: now, endTime: now + COMPETITION_DURATION,
                totalTickets: 0, prizePool: 0,
                userTickets: {}, winners: []
            };
            await callAPI('createCompetition', { startTime: now, endTime: now + COMPETITION_DURATION });
            startCountdown();
            updateCompetitionUI();
        }
        
        function updateCompetitionUI() {
            const now = Date.now();
            const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
            if (!userId) { console.error("User ID not found"); return; }
            document.getElementById('competition-status').textContent = competitionData.isActive ? 'ACTIVE' : 'ENDED';
            document.getElementById('competition-status').style.color = competitionData.isActive ? '#27ae60' : '#e74c3c';
            document.getElementById('prize-pool').textContent = competitionData.prizePool ? competitionData.prizePool.toFixed(3) + ' TON' : '0.000 TON';
            document.getElementById('total-tickets').textContent = competitionData.totalTickets || 0;
            let userTicketsValue = 0;
            if (competitionData && competitionData.userTickets) {
                if (typeof competitionData.userTickets === 'object') {
                    const userIdStr = userId.toString();
                    userTicketsValue = competitionData.userTickets[userIdStr] || 0;
                } else if (Array.isArray(competitionData.userTickets)) {
                    const userEntry = competitionData.userTickets.find(entry => entry.userId === userId);
                    userTicketsValue = userEntry ? userEntry.tickets || 0 : 0;
                } else {
                    userTicketsValue = parseInt(competitionData.userTickets) || 0;
                }
            }
            document.getElementById('user-tickets').textContent = userTicketsValue;
            const ticketInput = document.getElementById('ticket-amount');
            if (ticketInput) updateTicketCostDisplay();
            const buyBtn = document.getElementById('buy-tickets-btn');
            if (buyBtn) {
                const isBreak = competitionData.breakMode || false;
                buyBtn.disabled = isBreak || !competitionData.isActive;
                buyBtn.style.opacity = isBreak || !competitionData.isActive ? '0.5' : '1';
            }
            updateCompetitionLeaderboard();
        }
        
        async function loadUserCompetitionData() {
            const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
            if (!userId) {
                const tempUserId = 'browser_user_' + Date.now();
                return;
            }
            const result = await callAPI('getUserCompetitionData', { userId: userId });
            if (result.success && result.data) {
                if (result.data.userTickets || result.data.competitionTickets) {
                    if (!competitionData.userTickets) competitionData.userTickets = {};
                    const ticketsFromAPI = result.data.userTickets || result.data.competitionTickets || 0;
                    competitionData.userTickets[userId] = ticketsFromAPI;
                    appData.competitionTickets = ticketsFromAPI;
                    updateCompetitionUI();
                }
            } else {
                appData.competitionTickets = appData.competitionTickets || 0;
            }
        }
        
        function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            const updateTimer = () => {
                const now = Date.now();
                if (competitionData.endTime) {
                    let timeRemaining = Math.max(0, competitionData.endTime - now);
                    if (timeRemaining <= 0 && competitionData.isActive) {
                        timeRemaining = 0;
                        competitionData.isActive = false;
                        setTimeout(() => { createNewCompetition(); }, BREAK_DURATION);
                    }
                    const hours = Math.floor(timeRemaining / 3600000);
                    const minutes = Math.floor((timeRemaining % 3600000) / 60000);
                    const seconds = Math.floor((timeRemaining % 60000) / 1000);
                    const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    const timerElement = document.getElementById('countdown-timer');
                    if (timerElement) timerElement.textContent = formattedTime;
                }
                updateCompetitionUI();
            };
            updateTimer();
            countdownInterval = setInterval(updateTimer, 1000);
        }
        
        function updateTicketCostDisplay() {
            const ticketInput = document.getElementById('ticket-amount');
            if (!ticketInput) return;
            const tickets = parseInt(ticketInput.value) || 1;
            const cost = tickets * TICKET_PRICE;
            document.getElementById('tickets-count-display').textContent = tickets;
            document.getElementById('tickets-cost-display').textContent = cost.toLocaleString() + ' GLX';
        }
        
        window.setMaxTickets = function() {
            const currentBalance = appData.dogsBalance || 0;
            const maxTickets = Math.floor(currentBalance / TICKET_PRICE);
            if (maxTickets < 1) {
                showNotification("You don't have enough GLX to buy a ticket (10,000 GLX required)", "warning");
                return;
            }
            const ticketInput = document.getElementById('ticket-amount');
            ticketInput.value = maxTickets;
            updateTicketCostDisplay();
        };
        
        window.buyTickets = async function() {
            const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
            if (!userId) { showNotification("User authentication error. Please restart the bot.", "error"); return; }
            if (competitionData.breakMode) { showNotification("Competition is on break. Please wait for the next round.", "warning"); return; }
            if (!competitionData.isActive) { showNotification("Competition has ended. Please wait for the next round.", "warning"); return; }
            const ticketInput = document.getElementById('ticket-amount');
            const tickets = parseInt(ticketInput.value) || 0;
            if (tickets < 1) { showNotification("Please enter at least 1 ticket", "warning"); return; }
            const totalCost = tickets * TICKET_PRICE;
            const currentBalance = appData.dogsBalance || 0;
            if (totalCost > currentBalance) { showNotification(`Insufficient GLX balance. You need ${totalCost.toLocaleString()} GLX`, "warning"); return; }
            if (!confirm(`Buy ${tickets} ticket${tickets > 1 ? 's' : ''} for ${totalCost.toLocaleString()} GLX?\n\nEach ticket = 10,000 GLX = 0.001 TON\n\nüèÜ Remember: Only #1 wins, all others lose!`)) return;
            const buyBtn = document.getElementById('buy-tickets-btn');
            const statusMsg = document.getElementById('buy-tickets-status');
            buyBtn.disabled = true;
            buyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            statusMsg.textContent = "Processing your purchase...";
            statusMsg.style.color = "#FFC107";
            try {
                const result = await callAPI('buyTickets', { userId: userId, tickets: tickets, totalCost: totalCost });
                if (result.success) {
                    appData.dogsBalance = result.data.newBalance;
                    appData.competitionTickets = (appData.competitionTickets || 0) + tickets;
                    competitionData = { ...competitionData, userTickets: result.data.userTickets || competitionData.userTickets, totalTickets: result.data.totalTickets || competitionData.totalTickets, prizePool: result.data.prizePool || competitionData.prizePool };
                    buyBtn.disabled = false;
                    buyBtn.innerHTML = '<i class="fa-solid fa-ticket"></i> BUY TICKETS';
                    statusMsg.textContent = `‚úÖ Successfully purchased ${tickets} ticket${tickets > 1 ? 's' : ''}!`;
                    statusMsg.style.color = "#27ae60";
                    ticketInput.value = 1;
                    updateTicketCostDisplay();
                    setTimeout(() => { statusMsg.textContent = ""; }, 3000);
                    renderUI({ id: userId });
                    updateCompetitionUI();
                } else throw new Error(result.error || "Unknown error");
            } catch (error) {
                console.error("Ticket purchase error:", error);
                showNotification("Error: " + error.message, "error");
                buyBtn.disabled = false;
                buyBtn.innerHTML = '<i class="fa-solid fa-ticket"></i> BUY TICKETS';
                statusMsg.textContent = "‚ùå Error processing purchase";
                statusMsg.style.color = "#e74c3c";
            }
        };
        
        async function updateCompetitionLeaderboard() {
            const result = await callAPI('getCompetitionLeaderboard');
            if (result.success) {
                const leaderboardContainer = document.getElementById('competition-leaderboard-list');
                const leaderboardData = result.data.leaderboard || [];
                if (leaderboardData.length === 0) {
                    leaderboardContainer.innerHTML = '<p style="text-align:center;padding:20px;color:var(--text-muted)">No tickets purchased yet</p>';
                    return;
                }
                leaderboardContainer.innerHTML = '';
                leaderboardData.forEach((entry, index) => {
                    const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
                    const html = `<div class="competition-rank-card ${rankClass}"><div class="competition-rank">#${index + 1}</div><img src="${entry.photoUrl || 'https://i.ibb.co/tTkJX1Qy/logo.png'}" class="competition-user-avatar" alt="${entry.name}"><div class="competition-user-info"><div class="competition-user-name">${entry.name}</div></div><div class="competition-ticket-count">${entry.tickets} ticket${entry.tickets !== 1 ? 's' : ''}</div></div>`;
                    leaderboardContainer.insertAdjacentHTML('beforeend', html);
                });
            }
        }
        
        async function loadPreviousWinners() {
            const result = await callAPI('getPreviousWinners');
            if (result.success) {
                const winnersContainer = document.getElementById('previous-winners-list');
                const winners = result.data.winners || [];
                if (winners.length === 0) {
                    winnersContainer.innerHTML = '<p style="text-align:center;padding:20px;color:var(--text-muted)">No previous winners yet</p>';
                    return;
                }
                winnersContainer.innerHTML = '';
                winners.forEach(winner => {
                    const winnerDate = new Date(winner.timestamp).toLocaleDateString();
                    const prizeAmount = winner.prize ? parseFloat(winner.prize).toFixed(3) : '0.000';
                    const html = `<div class="winner-item"><div class="winner-rank">üèÜ</div><img src="${winner.photoUrl || 'https://i.ibb.co/tTkJX1Qy/logo.png'}" class="winner-avatar" alt="${winner.name}"><div class="winner-info"><div class="winner-name">${winner.name}</div><div class="winner-date">${winnerDate}</div></div><div class="winner-prize">${prizeAmount} TON</div></div>`;
                    winnersContainer.insertAdjacentHTML('beforeend', html);
                });
            }
        }
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑÿ≥ÿ≠ÿ® =====
        window.maskEmail = function() {
            const emailInput = document.getElementById('faucetpay-email');
            const emailPreview = document.getElementById('email-preview');
            if (!emailInput || !emailPreview) return;
            const email = emailInput.value.trim();
            if (email && email.includes('@')) {
                const [localPart, domain] = email.split('@');
                if (localPart.length > 3) {
                    const maskedLocal = localPart.charAt(0) + '*'.repeat(Math.max(3, localPart.length - 2)) + localPart.charAt(localPart.length - 1);
                    const maskedEmail = `${maskedLocal}@${domain}`;
                    emailPreview.textContent = maskedEmail;
                    emailPreview.style.display = 'block';
                } else emailPreview.style.display = 'none';
            } else emailPreview.style.display = 'none';
        };
        
        window.setMaxFaucetPay = function() {
            const currentBalance = appData.tonBalance || 0;
            const minAmount = 0.0001;
            if (currentBalance < minAmount) {
                showNotification(`Minimum withdrawal is ${minAmount} TON`, "warning");
                return;
            }
            document.getElementById('faucetpay-amount').value = currentBalance.toFixed(4);
        };
        
        window.setMaxTonWallet = function() {
            const currentBalance = appData.tonBalance || 0;
            const minAmount = 0.05;
            if (currentBalance < minAmount) {
                showNotification(`Minimum withdrawal is ${minAmount} TON`, "warning");
                return;
            }
            document.getElementById('ton-withdraw-amount').value = currentBalance.toFixed(2);
        };
        
        window.renderGalaxyLog = async function() {
            const result = await callAPI('getTransactionHistory');
            if (result.success) {
                const historyData = result.data.history || [];
                let totalEarned = 0, totalSpent = 0;
                historyData.forEach(item => {
                    if (item.type.includes('earn') || item.type === 'referral') totalEarned += parseFloat(item.amount) || 0;
                    else if (item.type.includes('spend') || item.type.includes('loss') || item.type.includes('withdraw')) totalSpent += parseFloat(item.amount) || 0;
                });
                document.getElementById('total-earned').textContent = Math.floor(totalEarned).toLocaleString() + ' GLX';
                document.getElementById('total-spent').textContent = Math.floor(totalSpent).toLocaleString() + ' GLX';
                const container = document.getElementById('galaxy-log-filtered-list');
                container.innerHTML = '';
                historyData.forEach(item => {
                    let icon = 'üìú', color = '#fff', typeClass = '';
                    if (item.type.includes('earn') || item.type === 'referral') { icon = 'üí∞'; color = '#27ae60'; typeClass = 'earn'; }
                    else if (item.type.includes('spend') || item.type.includes('loss')) { icon = 'üìâ'; color = '#e74c3c'; typeClass = 'spend'; }
                    else if (item.type.includes('swap')) { icon = 'üîÑ'; color = '#3498db'; typeClass = 'swap'; }
                    else if (item.type.includes('withdraw')) { icon = 'üè¶'; color = '#9b59b6'; typeClass = 'withdraw'; }
                    const amount = item.currency === 'TON' ? parseFloat(item.amount).toFixed(4) + ' TON' : Math.floor(item.amount).toLocaleString() + ' GLX';
                    const html = `<div class="log-item ${typeClass}"><div style="font-size:20px;margin-right:12px">${icon}</div><div style="flex:1"><div style="font-size:13px;font-weight:600;margin-bottom:2px">${item.description}</div><div style="font-size:10px;color:var(--text-muted)">${new Date(item.date).toLocaleString()}</div></div><div style="font-size:14px;font-weight:700;color:${color}">${amount}</div></div>`;
                    container.insertAdjacentHTML('beforeend', html);
                });
            }
        };
        
        window.filterUserWithdrawals = async function(type) {
            await updateUserWithdrawalsList(type);
        };
        
        async function updateUserWithdrawalsStats() {
            const result = await callAPI('getUserWithdrawals');
            if (result.success) {
                const withdrawals = result.data.withdrawals || [];
                await updateUserWithdrawalsList('all', withdrawals);
            }
        }
        
        async function updateUserWithdrawalsList(filterType, withdrawalsData) {
            if (!withdrawalsData) {
                const result = await callAPI('getUserWithdrawals');
                if (result.success) withdrawalsData = result.data.withdrawals || [];
                else withdrawalsData = [];
            }
            const container = document.getElementById('user-withdrawals-list');
            container.innerHTML = '';
            const filteredWithdrawals = withdrawalsData.filter(withdrawal => {
                if (filterType === 'all') return true;
                if (filterType === 'pending') return withdrawal.status === 'pending' || withdrawal.processed === false;
                if (filterType === 'completed') return withdrawal.status === 'completed' || withdrawal.processed === true;
                return true;
            });
            filteredWithdrawals.sort((a, b) => b.timestamp - a.timestamp);
            if (filteredWithdrawals.length === 0) {
                container.innerHTML = '<p style="text-align:center;padding:20px;color:var(--text-muted)">No withdrawals found</p>';
                return;
            }
            filteredWithdrawals.forEach(withdrawal => {
                const timeAgo = getTimeAgo(withdrawal.timestamp);
                const amount = parseFloat(withdrawal.amount || 0).toFixed(7);
                let status = '', statusText = '', statusClass = '';
                if (withdrawal.status === 'rejected') { status = 'rejected'; statusText = '‚ùå Rejected'; statusClass = 'status-rejected'; }
                else if (withdrawal.status === 'completed' || withdrawal.processed === true) { status = 'completed'; statusText = '‚úÖ Completed'; statusClass = 'status-completed'; }
                else { status = 'pending'; statusText = '‚è≥ Pending'; statusClass = 'status-pending'; }
                let maskedAccount = withdrawal.account || '';
                if (withdrawal.method === 'faucetpay' && maskedAccount.includes('@')) {
                    const [localPart, domain] = maskedAccount.split('@');
                    if (localPart.length > 3) maskedAccount = localPart.charAt(0) + '*'.repeat(Math.max(3, localPart.length - 2)) + localPart.charAt(localPart.length - 1) + '@' + domain;
                } else if (withdrawal.method === 'ton') {
                    if (maskedAccount.length > 16) maskedAccount = maskedAccount.substring(0, 8) + '...' + maskedAccount.substring(maskedAccount.length - 4);
                }
                const html = `<div class="user-withdrawal-item"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px"><div style="font-size:12px;font-weight:600">${withdrawal.method === 'ton' ? 'TON Wallet' : 'FaucetPay'}</div><div class="withdrawal-status ${statusClass}">${statusText}</div></div><div style="font-size:11px;color:var(--text-muted);margin-bottom:5px" class="masked-email">${maskedAccount}</div><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-size:14px;font-weight:700;color:var(--primary-green)">${amount} TON</div><div style="font-size:9px;color:var(--text-muted)">${timeAgo}</div></div></div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }
        
        function getTimeAgo(timestamp) {
            if (!timestamp) return "Unknown time";
            const now = Date.now();
            const diff = now - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
            if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            if (seconds > 0) return `${seconds} second${seconds !== 1 ? 's' : ''} ago`;
            return "Just now";
        }
        
        // ===== ÿØŸàÿßŸÑ ŸÑÿπÿ®ÿ© ÿßŸÑÿπŸÖŸÑÿ© =====
        window.setMaxBet = function() {
            const currentBalance = appData.dogsBalance || 0;
            const maxBet = Math.floor(currentBalance / 1000) * 1000;
            if (maxBet < 1000) { showNotification("Minimum bet is 1,000 GLX", "warning"); return; }
            document.getElementById('coin-bet-amount').value = maxBet;
            coinGame.betAmount = maxBet;
        };
        
        window.setBetAmount = function(amount) {
            coinGame.betAmount = amount;
            document.getElementById('coin-bet-amount').value = amount;
            document.querySelectorAll('.bet-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnAmount = parseInt(btn.dataset.amount) || 0;
                if (btnAmount === amount) btn.classList.add('active');
            });
        };
        
        window.chooseSide = function(side) {
            coinGame.chosenSide = side;
            document.querySelectorAll('.side-btn').forEach(btn => {
                btn.classList.remove('active', 'win', 'lose');
            });
            const selectedBtn = side === 'glx' ? document.getElementById('choose-glx') : document.getElementById('choose-gold');
            selectedBtn.classList.add('active');
        };
        
        window.flipCoin = async function() {
            if (coinGame.isFlipping) return;
            const inputElement = document.getElementById('coin-bet-amount');
            const inputAmount = parseInt(inputElement.value);
            if (!inputAmount || inputAmount < 1000) {
                showNotification("‚ùå Minimum bet is 1,000 GLX", "warning");
                inputElement.focus();
                inputElement.style.borderColor = '#e74c3c';
                setTimeout(() => inputElement.style.borderColor = '', 2000);
                return;
            }
            const currentBalance = appData.dogsBalance || 0;
            if (inputAmount > currentBalance) { showNotification("üí∞ Insufficient GLX balance!", "warning"); return; }
            coinGame.betAmount = inputAmount;
            coinGame.isFlipping = true;
            const coin = document.getElementById('coin');
            coin.classList.remove('coin-spinning', 'coin-final');
            coin.style.transform = 'rotateY(0deg)';
            coin.style.transition = 'none';
            const resultElement = document.getElementById('coin-game-result');
            resultElement.style.display = 'none';
            document.querySelectorAll('.bet-btn').forEach(btn => { btn.style.opacity = '0.5'; btn.style.pointerEvents = 'none'; });
            document.querySelectorAll('.side-btn').forEach(btn => { btn.classList.remove('win', 'lose'); });
            const result = await callAPI('flipCoin', { betAmount: inputAmount, chosenSide: coinGame.chosenSide });
            if (result.success) {
                coinGame.isFlipping = false;
                const flipBtn = document.getElementById('flip-coin-btn');
                flipBtn.disabled = true;
                flipBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> FLIPPING...';
                setTimeout(() => {
                    const isWin = result.data.isWin;
                    const resultSide = result.data.resultSide;
                    const winAmount = result.data.winAmount || 0;
                    let finalRotation = 0;
                    if (resultSide === 'glx') finalRotation = 720 + (Math.floor(Math.random() * 4) * 360);
                    else finalRotation = 720 + 180 + (Math.floor(Math.random() * 4) * 360);
                    coin.style.setProperty('--final-rotation', `${finalRotation}deg`);
                    coin.classList.add('coin-spinning');
                    setTimeout(() => {
                        setTimeout(() => {
                            coin.classList.remove('coin-spinning');
                            coin.classList.add('coin-final');
                            showCoinFlipResult(isWin, resultSide, inputAmount, winAmount, finalRotation);
                            flipBtn.disabled = false;
                            flipBtn.innerHTML = '<i class="fa-solid fa-play"></i> FLIP COIN';
                            document.querySelectorAll('.bet-btn').forEach(btn => { btn.style.opacity = '1'; btn.style.pointerEvents = 'auto'; });
                            coinGame.lastFlipResult = resultSide;
                            coinGame.currentRotation = finalRotation % 360;
                            setTimeout(() => {
                                appData.dogsBalance = result.data.newBalance;
                                renderUI({ id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id });
                            }, 500);
                        }, 2500);
                    }, 50);
                }, 100);
            } else {
                showNotification("Error: " + result.error, "error");
                coinGame.isFlipping = false;
                const flipBtn = document.getElementById('flip-coin-btn');
                flipBtn.disabled = false;
                flipBtn.innerHTML = '<i class="fa-solid fa-play"></i> FLIP COIN';
                document.querySelectorAll('.bet-btn').forEach(btn => { btn.style.opacity = '1'; btn.style.pointerEvents = 'auto'; });
            }
        };
        
        function showCoinFlipResult(isWin, resultSide, betAmount, winAmount, finalRotation) {
            const resultElement = document.getElementById('coin-game-result');
            const resultText = document.getElementById('coin-result-text');
            const winAmountElement = document.getElementById('coin-win-amount');
            const lossAmountElement = document.getElementById('coin-loss-amount');
            winAmountElement.style.display = 'none';
            lossAmountElement.style.display = 'none';
            if (isWin) {
                resultText.innerHTML = `üéâ <strong>YOU WIN!</strong><br>${coinGame.chosenSide.toUpperCase()} appeared!`;
                resultText.style.color = '#27ae60';
                winAmountElement.textContent = `+${winAmount.toLocaleString()} GLX`;
                winAmountElement.style.display = 'block';
                const selectedBtn = coinGame.chosenSide === 'glx' ? document.getElementById('choose-glx') : document.getElementById('choose-gold');
                selectedBtn.classList.add('win');
                selectedBtn.classList.remove('active');
                if (winAmount >= 5000) {
                    setTimeout(() => {
                        showNotification(`üéä BIG WIN! You won ${winAmount.toLocaleString()} GLX!`, "success");
                    }, 500);
                }
            } else {
                const lossAmount = betAmount;
                resultText.innerHTML = `üò¢ <strong>YOU LOSE</strong><br>${resultSide.toUpperCase()} appeared`;
                resultText.style.color = '#e74c3c';
                lossAmountElement.textContent = `-${lossAmount.toLocaleString()} GLX`;
                lossAmountElement.style.display = 'block';
                const selectedBtn = coinGame.chosenSide === 'glx' ? document.getElementById('choose-glx') : document.getElementById('choose-gold');
                selectedBtn.classList.add('lose');
                selectedBtn.classList.remove('active');
            }
            resultElement.style.display = 'block';
            const coin = document.getElementById('coin');
            setTimeout(() => { coin.style.transform = `rotateY(${finalRotation}deg)`; }, 100);
        }
        
        function resetCoinFlipGame() {
            const coin = document.getElementById('coin');
            coin.classList.remove('coin-spinning', 'coin-final');
            coin.style.transform = 'rotateY(0deg)';
            coin.style.transition = 'none';
            document.getElementById('coin-game-result').style.display = 'none';
            document.querySelectorAll('.side-btn').forEach(btn => {
                btn.classList.remove('win', 'lose');
                if (btn.id === 'choose-glx') btn.classList.add('active');
                else btn.classList.remove('active');
            });
            coinGame.isFlipping = false;
            coinGame.chosenSide = 'glx';
            coinGame.betAmount = 1000;
            coinGame.currentRotation = 0;
            document.getElementById('coin-bet-amount').value = 1000;
            updateBetButtons();
        }
        
        window.initCoinFlipGame = function() { resetCoinFlipGame(); };
        
        function updateBetButtons() {
            const amounts = [1000, 5000, 10000, 25000];
            const buttons = document.querySelectorAll('.bet-btn');
            buttons.forEach((btn, index) => {
                if (index < amounts.length) {
                    btn.textContent = amounts[index] >= 1000 ? (amounts[index] / 1000) + 'k' : amounts[index];
                    btn.dataset.amount = amounts[index];
                    if (amounts[index] === 1000) btn.classList.add('active');
                    else btn.classList.remove('active');
                }
            });
        }
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑÿ±ŸÖŸàÿ≤ ÿßŸÑÿ™ÿ±ŸàŸäÿ¨Ÿäÿ© =====
        function initPromoCodes() {
            const redeemBtn = document.getElementById('redeem-code-btn');
            const promoInput = document.getElementById('promo-code-input');
            if (redeemBtn) redeemBtn.addEventListener('click', handlePromoCode);
            if (promoInput) promoInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') handlePromoCode(); });
        }
        
        async function handlePromoCode() {
            const codeInput = document.getElementById('promo-code-input');
            const resultDiv = document.getElementById('promo-result');
            const redeemBtn = document.getElementById('redeem-code-btn');
            if (!codeInput || !resultDiv || !redeemBtn) return;
            const code = codeInput.value.trim().toUpperCase();
            if (!code) { showPromoResult('Please enter a promo code', 'error'); return; }
            redeemBtn.disabled = true;
            redeemBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            const result = await callAPI('redeemPromoCode', { code: code });
            if (result.success) {
                const reward = result.data.reward;
                appData.dogsBalance = result.data.newBalance;
                showPromoResult(`üéâ Success! You got +${reward} GLX`, 'success');
                codeInput.value = '';
                renderUI({ id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id });
            } else showPromoResult('‚ùå ' + result.error, 'error');
            redeemBtn.disabled = false;
            redeemBtn.innerHTML = '<i class="fa-solid fa-gift"></i> Redeem';
        }
        
        function showPromoResult(message, type) {
            const resultDiv = document.getElementById('promo-result');
            if (!resultDiv) return;
            resultDiv.textContent = message;
            resultDiv.style.display = 'block';
            if (type === 'success') { resultDiv.style.background = 'rgba(39,174,96,0.2)'; resultDiv.style.border = '1px solid rgba(39,174,96,0.5)'; resultDiv.style.color = '#27ae60'; }
            else if (type === 'error') { resultDiv.style.background = 'rgba(231,76,60,0.2)'; resultDiv.style.border = '1px solid rgba(231,76,60,0.5)'; resultDiv.style.color = '#e74c3c'; }
            else { resultDiv.style.background = 'rgba(255,193,7,0.2)'; resultDiv.style.border = '1px solid rgba(255,193,7,0.5)'; resultDiv.style.color = '#FFC107'; }
            setTimeout(() => { resultDiv.style.display = 'none'; }, 5000);
        }
        
        // ===== ÿØŸàÿßŸÑ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖŸáÿßŸÖ =====
        window.selectCat = function(el, cat) {
            document.querySelectorAll('.cat-opt').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            selectedCategory = cat;
            const warningEl = document.getElementById('admin-required-msg');
            if (cat === 'channel') warningEl.style.display = 'block';
            else warningEl.style.display = 'none';
        };
        
        function renderCreateTaskUI() {
            const container = document.getElementById('price-options');
            container.innerHTML = '';
            const options = [100, 500, 1000, 2000, 5000, 10000];
            options.forEach((opt, idx) => {
                const html = `<div class="price-opt ${idx === 0 ? 'active' : ''}" data-count="${opt}" onclick="selectPrice(this)"><div class="price-count">${opt.toLocaleString()}</div><div class="price-cost" id="cost-${opt}">Loading...</div></div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
            calculateCost();
        }
        
        window.selectPrice = function(el) {
            document.querySelectorAll('.price-opt').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            selectedCount = parseInt(el.dataset.count);
            calculateCost();
        };
        
        function calculateCost() {
            const rate = appSettings.pricePerClick || 0.0015;
            document.querySelectorAll('.price-opt').forEach(el => {
                const cnt = parseInt(el.dataset.count);
                const cst = (cnt * rate).toFixed(4);
                const costDiv = el.querySelector('.price-cost');
                if (costDiv) costDiv.textContent = `${cst} TON`;
            });
            selectedCost = (selectedCount * rate).toFixed(4);
            document.getElementById('pay-amount-display').textContent = selectedCost;
        }
        
        window.initiatePayment = async function() {
            const name = document.getElementById('new-task-name').value.trim();
            const link = document.getElementById('new-task-link').value.trim();
            if (!name || !link) { showNotification("Please fill all fields.", "warning"); return; }
            if (!link.startsWith('http')) { showNotification("Invalid link.", "warning"); return; }
            currentTaskId = 'task_' + Math.floor(Date.now() / 1000);
            const result = await callAPI('createTask', { taskId: currentTaskId, name: name, link: link, category: selectedCategory, count: selectedCount, cost: selectedCost });
            if (result.success) {
                const nanoTon = Math.floor(selectedCost * 1000000000);
                const paymentUrl = `https://app.tonkeeper.com/transfer/${BOT_WALLET}?amount=${nanoTon}&text=${currentTaskId}`;
                if (window.Telegram?.WebApp) window.Telegram.WebApp.openLink(paymentUrl);
                else window.open(paymentUrl, '_blank');
                document.getElementById('payment-step-1').style.display = 'none';
                document.getElementById('payment-step-2').style.display = 'block';
            } else showNotification("Error: " + result.error, "error");
        };
        
        window.verifyPayment = async function() {
            const btn = document.getElementById('check-payment-btn');
            const msg = document.getElementById('payment-status-msg');
            btn.disabled = true;
            btn.textContent = "Checking Blockchain...";
            msg.textContent = "Connecting to TON API...";
            msg.style.color = "#ffb300";
            try {
                const result = await callAPI('verifyTaskPayment', { taskId: currentTaskId });
                if (result.success) {
                    msg.textContent = "Payment Verified! Activating Mission...";
                    msg.style.color = "#a855f7";
                    showNotification("Success! Your mission is now live.", "success");
                    document.getElementById('payment-step-1').style.display = 'block';
                    document.getElementById('payment-step-2').style.display = 'none';
                    document.getElementById('new-task-name').value = '';
                    document.getElementById('new-task-link').value = '';
                    btn.disabled = false;
                    btn.textContent = "Check Payment";
                    switchTab('tasks');
                } else {
                    msg.textContent = "Payment not found yet. Please wait 10s and try again.";
                    msg.style.color = "#e74c3c";
                    btn.disabled = false;
                    btn.textContent = "Check Again";
                }
            } catch (e) {
                console.error(e);
                msg.textContent = "Error checking payment. Try again.";
                btn.disabled = false;
                btn.textContent = "Check Again";
            }
        };
        
        // ===== ÿØŸàÿßŸÑ ŸÖÿßŸÉŸäŸÜÿßÿ™ ÿßŸÑŸÇŸÖÿßÿ± =====
        function initSlotsGame() {
            for (let i = 1; i <= 3; i++) {
                const reel = document.getElementById(`reel${i}`);
                reel.innerHTML = '';
                for (let j = 0; j < 10; j++) {
                    slotsSymbols.forEach(symbol => {
                        const item = document.createElement('div');
                        item.className = 'slot-item';
                        item.textContent = symbol;
                        reel.appendChild(item);
                    });
                }
            }
            document.getElementById('slots-spin-btn').addEventListener('click', handleSlotsSpin);
        }
        
        function updateAvailableSpins() {
            const extraSpins = appData.extraSpins || 0;
            document.getElementById('available-spins').textContent = extraSpins;
            const spinBtn = document.getElementById('slots-spin-btn');
            if (extraSpins > 0) {
                spinBtn.disabled = false;
                spinBtn.classList.remove('btn-disabled');
                spinBtn.textContent = `üöÄ SPIN NOW (${extraSpins} left)`;
            } else {
                spinBtn.disabled = true;
                spinBtn.classList.add('btn-disabled');
                spinBtn.textContent = "üöÄ NO SPINS LEFT";
            }
        }
        
        async function handleSlotsSpin() {
            if (isSpinning) return;
            const extraSpins = appData.extraSpins || 0;
            if (extraSpins <= 0) {
                showNotification("You don't have any spins left! Watch an ad to get more spins.", "warning");
                return;
            }
            isSpinning = true;
            const spinBtn = document.getElementById('slots-spin-btn');
            const resultText = document.getElementById('slots-result-text');
            const winAmount = document.getElementById('slots-win-amount');
            spinBtn.disabled = true;
            resultText.textContent = "Spinning...";
            winAmount.textContent = "0 GLX";
            const result = await callAPI('spinSlots');
            if (result.success) {
                const results = result.data.results;
                const winGLX = result.data.winAmount;
                const newBalance = result.data.newBalance;
                const newSpins = result.data.newSpins;
                const reelPositions = [0, 0, 0];
                for (let i = 0; i < 3; i++) {
                    const targetIndex = slotsSymbols.indexOf(results[i]);
                    reelPositions[i] = -((targetIndex + 5) * 80);
                }
                const reels = [document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3')];
                reels.forEach((reel, index) => {
                    reel.style.transition = 'transform 2s cubic-bezier(0.1,0,0.2,1)';
                    reel.style.transform = `translateY(${reelPositions[index]}px)`;
                });
                setTimeout(() => {
                    const resultString = results.join('');
                    if (winGLX > 0) {
                        resultText.textContent = `üéâ You won! (${resultString})`;
                        winAmount.textContent = `+${winGLX} GLX`;
                        appData.dogsBalance = newBalance;
                        appData.extraSpins = newSpins;
                        if (winGLX >= 1000) {
                            setTimeout(() => {
                                showNotification(`üéä JACKPOT! You won ${winGLX} GLX!`, "success");
                            }, 500);
                        }
                    } else {
                        resultText.textContent = `No win this time (${resultString})`;
                        winAmount.textContent = "0 GLX";
                        appData.extraSpins = newSpins;
                    }
                    setTimeout(() => {
                        isSpinning = false;
                        updateAvailableSpins();
                        renderUI({ id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id });
                    }, 1000);
                }, 2000);
            } else {
                showNotification("Error: " + result.error, "error");
                isSpinning = false;
                spinBtn.disabled = false;
            }
        }
        
        window.getExtraSpin = async function() {
            if (typeof window.showGiga === 'function') {
                try {
                    await window.showGiga();
                    const result = await callAPI('addExtraSpin');
                    if (result.success) {
                        appData.extraSpins = result.data.newSpins;
                        showNotification("üéâ You earned an extra spin!", "success");
                        updateAvailableSpins();
                    }
                } catch (e) {
                    console.error("Ad error:", e);
                    showNotification("Ad not available.", "warning");
                }
            } else showNotification("Ads system loading...", "info");
        };
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™ ÿßŸÑŸäŸàŸÖŸäÿ© =====
        function renderDailyBonusUI() {
            const container = document.getElementById('daily-checkin-grid');
            container.innerHTML = '';
            const streak = appData.dailyStreak || 0;
            const lastClaim = appData.lastDailyClaim || 0;
            const now = Date.now();
            const msInDay = 86400000;
            const canClaim = (now - lastClaim) >= msInDay;
            const rewards = appSettings.dailyRewards || [2000, 3000, 5000, 7000, 9000, 12000, 15000];
            for (let i = 0; i < 7; i++) {
                let statusClass = '';
                if (i < streak) statusClass = 'claimed';
                else if (i === streak && canClaim) statusClass = 'active';
                const html = `<div class="daily-box ${statusClass}"><div style="font-size:9px">DAY ${i + 1}</div><div style="font-weight:700">+${rewards[i]}</div></div>`;
                container.insertAdjacentHTML('beforeend', html);
            }
            const btn = document.getElementById('claim-daily-btn');
            const timer = document.getElementById('next-claim-timer');
            if (canClaim) {
                btn.disabled = false;
                btn.classList.remove('btn-disabled');
                btn.textContent = `Claim +${rewards[streak] || 100}`;
                timer.textContent = "Ready to claim!";
            } else {
                btn.disabled = true;
                btn.classList.add('btn-disabled');
                btn.textContent = "Claimed";
                const timeLeft = msInDay - (now - lastClaim);
                const hours = Math.floor(timeLeft / 3600000);
                const mins = Math.floor((timeLeft % 3600000) / 60000);
                timer.textContent = `Next reward in: ${hours}h ${mins}m`;
            }
        }
        
        async function handleDailyClaim() {
            const result = await callAPI('claimDailyBonus');
            if (result.success) {
                appData.lastDailyClaim = result.data.lastDailyClaim;
                appData.dailyStreak = result.data.dailyStreak;
                appData.dogsBalance = result.data.newBalance;
                showNotification(`üéâ Daily bonus claimed! +${result.data.reward} GLX`, "success");
                renderDailyBonusUI();
                renderUI({ id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id });
            } else showNotification("Error: " + result.error, "error");
        }
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑÿ≥ÿ¨ŸÑ =====
        async function renderHistory(container, limit, user) {
            container.innerHTML = '';
            const result = await callAPI('getTransactionHistory', { limit: limit });
            if (result.success) {
                const historyData = result.data.history || [];
                if (historyData.length === 0) {
                    container.innerHTML = '<p style="text-align:center;padding:20px 0;font-size:12px;color:var(--text-muted)">No logs yet.</p>';
                    return;
                }
                historyData.forEach(item => {
                    const isMinus = item.type.includes('withdraw') || item.type.includes('loss') || item.type.includes('swap_out');
                    const sign = isMinus ? '-' : '+';
                    const color = isMinus ? '#fff' : 'var(--primary-green)';
                    let displayAmount = item.amount;
                    if (item.currency === 'TON') displayAmount = parseFloat(item.amount).toFixed(7);
                    else displayAmount = Number(item.amount).toLocaleString();
                    let iconImg = 'https://i.ibb.co/tTkJX1Qy/logo.png';
                    const desc = item.description.toLowerCase();
                    if (item.currency === 'TON') iconImg = 'https://i.ibb.co/8DsyHqwK/toncoin-ton-logo.png';
                    else if (desc.includes('ad')) iconImg = 'https://i.ibb.co/tTkJX1Qy/logo.png';
                    else if (desc.includes('telegram') || desc.includes('channel') || desc.includes('group')) iconImg = 'https://i.ibb.co/s9YygTBd/20251203-195134.png';
                    else if (desc.includes('youtube') || desc.includes('subscribe')) iconImg = 'https://i.ibb.co/CSz6kg9/20251203-200546.png';
                    else if (desc.includes('twitter') || desc.includes('follow')) iconImg = 'https://i.ibb.co/60jp6MsF/20251203-200516.png';
                    else if (desc.includes('instagram')) iconImg = 'https://img.icons8.com/fluency/96/instagram-new.png';
                    else if (desc.includes('coin flip')) iconImg = 'https://i.ibb.co/tTkJX1Qy/logo.png';
                    const html = `<div class="list-card"><div class="lc-icon"><img src="${iconImg}"></div><div class="lc-content"><div class="lc-title">${item.description}</div><div class="lc-sub">${new Date(item.date).toLocaleDateString()}</div></div><div class="lc-end"><div class="lc-val" style="color:${color}">${sign}${displayAmount} ${item.currency}</div></div></div>`;
                    container.insertAdjacentHTML('beforeend', html);
                });
            }
        }
        
        async function renderWithdrawalHistory() {
            const result = await callAPI('getWithdrawalHistory');
            if (result.success) {
                const container = document.getElementById('withdrawal-history-list');
                container.innerHTML = '';
                const withdrawals = result.data.withdrawals || [];
                if (withdrawals.length === 0) {
                    container.innerHTML = '<p style="text-align:center;padding:20px;color:var(--text-muted)">No withdrawals yet.</p>';
                    return;
                }
                withdrawals.forEach(withdrawal => {
                    const timeAgo = getTimeAgo(withdrawal.timestamp);
                    const amount = parseFloat(withdrawal.amount || 0).toFixed(7);
                    let maskedAccount = withdrawal.account || '';
                    if (withdrawal.method === 'faucetpay' && maskedAccount.includes('@')) {
                        const [localPart, domain] = maskedAccount.split('@');
                        if (localPart.length > 3) maskedAccount = localPart.charAt(0) + '*'.repeat(Math.max(3, localPart.length - 2)) + localPart.charAt(localPart.length - 1) + '@' + domain;
                    } else if (withdrawal.method === 'ton') {
                        if (maskedAccount.length > 16) maskedAccount = maskedAccount.substring(0, 8) + '...' + maskedAccount.substring(maskedAccount.length - 4);
                    }
                    const html = `<div class="list-card" style="margin-bottom:8px"><div class="lc-icon"><img src="${withdrawal.photoUrl || 'https://i.ibb.co/tTkJX1Qy/logo.png'}" style="border-radius:50%"></div><div class="lc-content"><div class="lc-title">${withdrawal.name || 'Anonymous'}</div><div class="lc-sub">${withdrawal.method === 'ton' ? 'TON Wallet: ' + maskedAccount : 'FaucetPay: ' + maskedAccount}</div></div><div class="lc-end"><div class="lc-val" style="color:var(--primary-green)">${amount} TON</div><div class="lc-sub" style="font-size:9px">${timeAgo}</div></div></div>`;
                    container.insertAdjacentHTML('beforeend', html);
                });
            }
        }
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑÿ•ŸäÿØÿßÿπ =====
        async function initiateDeposit() {
            const amount = parseFloat(document.getElementById('deposit-amount').value) || 0.01;
            if (amount < 0.01) { showNotification("Minimum deposit is 0.01 TON", "warning"); return; }
            const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
            if (!userId) { showNotification("User authentication error", "error"); return; }
            depositTransactionId = 'deposit_' + Date.now() + '_' + userId;
            const nanoTon = Math.floor(amount * 1000000000);
            const paymentUrl = `https://app.tonkeeper.com/transfer/${BOT_WALLET}?amount=${nanoTon}&text=${depositTransactionId}`;
            document.getElementById('deposit-status').style.display = 'block';
            document.getElementById('deposit-status-message').textContent = "Payment link generated. Opening Tonkeeper...";
            document.getElementById('deposit-status-message').style.color = "#FFC107";
            if (window.Telegram?.WebApp) window.Telegram.WebApp.openLink(paymentUrl);
            else window.open(paymentUrl, '_blank');
        }
        
        async function verifyDeposit() {
            const btn = document.getElementById('check-deposit-btn');
            const msg = document.getElementById('deposit-status-message');
            btn.disabled = true;
            btn.textContent = "Checking...";
            msg.textContent = "Verifying payment on blockchain...";
            msg.style.color = "#FFC107";
            try {
                const result = await callAPI('verifyDeposit', { transactionId: depositTransactionId });
                if (result.success) {
                    if (result.data.verified) {
                        msg.textContent = `‚úÖ Deposit verified! +${result.data.amount} TON added to your account`;
                        msg.style.color = "#27ae60";
                        appData.tonBalance = result.data.newBalance;
                        renderUI({ id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id });
                        setTimeout(() => {
                            document.getElementById('deposit-status').style.display = 'none';
                            document.getElementById('deposit-amount').value = "0.01";
                            depositTransactionId = '';
                        }, 3000);
                    } else {
                        msg.textContent = "Payment not found yet. Please wait 10-30 seconds and try again.";
                        msg.style.color = "#e74c3c";
                        btn.disabled = false;
                        btn.textContent = "Check Again";
                    }
                } else {
                    msg.textContent = "Error: " + (result.error || "Unknown error");
                    msg.style.color = "#e74c3c";
                    btn.disabled = false;
                    btn.textContent = "Check Again";
                }
            } catch (error) {
                console.error("Deposit verification error:", error);
                msg.textContent = "Connection error. Please try again.";
                msg.style.color = "#e74c3c";
                btn.disabled = false;
                btn.textContent = "Check Again";
            }
        }
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÇŸÜŸàÿßÿ™ =====
        async function verifyTelegramMembership(channelUsername, userId) {
            try {
                const username = channelUsername.replace('@', '');
                const result = await callAPI('verifyTelegramMembership', { channelUsername: username, userId: userId });
                return result.success && result.data.isMember === true;
            } catch (error) {
                console.error('Error verifying Telegram membership:', error);
                return false;
            }
        }
        
        async function verifyTaskChannel(taskId, channelUsername) {
            try {
                const username = channelUsername.replace('@', '');
                const result = await callAPI('verifyTaskChannel', { taskId: taskId, channelUsername: username });
                return result;
            } catch (error) {
                console.error('Error verifying task channel:', error);
                return { success: false, error: error.message };
            }
        }
        
        function extractChannelUsernameFromLink(link) {
            try {
                if (link.includes('t.me/')) {
                    const url = new URL(link);
                    const pathParts = url.pathname.split('/');
                    const username = pathParts[1];
                    if (username && !username.includes('joinchat') && !username.includes('+')) return '@' + username;
                }
                return null;
            } catch (e) {
                console.error('Error parsing link:', e);
                return null;
            }
        }
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑŸÖŸáÿßŸÖ =====
        async function fetchAndRenderTasks(user) {
            const result = await callAPI('getTasks');
            if (result.success) {
                const pCont = document.getElementById('partner-tasks-list');
                const cCont = document.getElementById('community-tasks-list');
                pCont.innerHTML = '';
                cCont.innerHTML = '';
                const tasks = result.data.tasks || [];
                const completedTasks = appData.completedTasks || {};
                tasks.forEach(task => {
                    if (task.status !== 'active' || (task.remaining !== undefined && task.remaining <= 0)) return;
                    const isDone = completedTasks[task.id];
                    let iconImg = 'https://img.icons8.com/fluency/96/task.png';
                    const lt = task.title.toLowerCase();
                    const ll = (task.link || '').toLowerCase();
                    if (lt.includes('bot') || ll.includes('bot') || ll.includes('start=')) iconImg = 'https://i.ibb.co/Myz4Gkmy/Picsart-25-12-10-04-34-59-799.png';
                    else if (lt.includes('telegram') || lt.includes('channel') || lt.includes('group') || lt.includes('join') || ll.includes('t.me')) iconImg = 'https://i.ibb.co/5WZRG8fw/tele.png';
                    else if (lt.includes('youtube') || lt.includes('subscribe')) iconImg = 'https://i.ibb.co/CSz6kg9/20251203-200546.png';
                    else if (lt.includes('twitter') || lt.includes('retweet') || lt.includes('follow') || lt.includes('x ')) iconImg = 'https://i.ibb.co/60jp6MsF/20251203-200516.png';
                    else if (lt.includes('instagram')) iconImg = 'https://img.icons8.com/fluency/96/instagram-new.png';
                    const html = `<div class="list-card dynamic-task ${isDone ? 'disabled' : ''}" style="${isDone ? 'opacity:0.5;pointer-events:none;' : ''}" data-id="${task.id}" data-reward="${task.reward}" data-title="${task.title}" data-link="${task.link}" onclick="handleDynamicTask(this)"><div class="lc-icon"><img src="${iconImg}"></div><div class="lc-content"><div class="lc-title">${task.title}</div><div class="lc-sub" id="status-${task.id}">${task.description}</div></div><div class="lc-end"><div class="lc-val" id="reward-${task.id}">+${task.reward}</div></div></div>`;
                    if (task.category === 'partner') pCont.insertAdjacentHTML('beforeend', html);
                    else cCont.insertAdjacentHTML('beforeend', html);
                });
                if (pCont.innerHTML === '') document.getElementById('partner-tasks-card').style.display = 'none';
            }
        }
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπŸäŸÜ =====
        function setupEventListeners(user) {
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.target));
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchTab(link.dataset.target);
                });
            });
            document.getElementById('monetag-ad-task').addEventListener('click', handleMonetagAd);
            document.getElementById('gigapub-ad-task').addEventListener('click', handleGigaAd);
            document.getElementById('adsgram-ad-task').addEventListener('click', handleAdsgramAd);
            document.getElementById('share-referral-btn').addEventListener('click', () => {
                const link = document.getElementById('referral-link-display').textContent;
                window.Telegram?.WebApp.openTelegramLink(`https://t.me/share/url?url=${link}&text=Join GLX Galaxy!`);
            });
            document.getElementById('copy-referral-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(document.getElementById('referral-link-display').textContent).then(() => {
                    showNotification("Copied!", "success");
                });
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.podium-list').forEach(l => l.classList.add('hidden'));
                    e.target.classList.add('active');
                    document.getElementById(e.target.dataset.target).classList.remove('hidden');
                });
            });
            document.getElementById('claim-daily-btn').addEventListener('click', handleDailyClaim);
            document.getElementById('coin-bet-amount').addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value && value >= 1000) coinGame.betAmount = value;
            });
            document.getElementById('floatingAddTask').addEventListener('click', function() { switchTab('create-task-page'); });
            document.getElementById('faucetpay-email')?.addEventListener('input', maskEmail);
            document.querySelectorAll('.btn-filter').forEach(btn => {
                if (!btn.hasAttribute('data-setup')) {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                    btn.setAttribute('data-setup', 'true');
                }
            });
        }
        
        function setupGalaxyLogButton() {
            const galaxyLogBtn = document.getElementById('galaxy-log-button');
            if (galaxyLogBtn) galaxyLogBtn.addEventListener('click', function() { switchTab('galaxy-log-page'); });
        }
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ =====
        function canClickAd() {
            const now = Date.now();
            return (now - lastAdClickTime) >= AD_CLICK_DELAY;
        }
        
        async function handleMonetagAd() {
            if (!canClickAd()) { showNotification("Please wait 3 seconds before clicking again.", "warning"); return; }
            await getUpdatedSettings();
            lastAdClickTime = Date.now();
            const limit = appSettings.limitMonetag || 50;
            if ((appData.adsMonetag || 0) >= limit) return;
            if (!isAdScriptLoaded) { showNotification("Loading ad...", "info"); return; }
            try {
                await show_10286382({ ymid: window.Telegram?.WebApp?.initDataUnsafe?.user?.id });
                const result = await callAPI('handleAdClick', { adType: 'monetag', reward: appSettings.adRewardMonetag || 1000 });
                if (result.success) {
                    appData.adsMonetag = result.data.adsMonetag;
                    appData.adsWatched = result.data.adsWatched;
                    appData.dogsBalance = result.data.newBalance;
                    showNotification(`‚úÖ +${appSettings.adRewardMonetag || 1000} GLX added!`, "success");
                    renderUI({ id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id });
                }
            } catch (e) { showNotification("Ad not ready", "warning"); }
        }
        
        async function handleGigaAd() {
            if (!canClickAd()) { showNotification("Please wait 3 seconds before clicking again.", "warning"); return; }
            await getUpdatedSettings();
            lastAdClickTime = Date.now();
            const limit = appSettings.limitGiga || 300;
            if ((appData.adsGiga || 0) >= limit) return;
            if (typeof window.showGiga !== 'function') { showNotification("Giga Ads loading...", "info"); return; }
            try {
                await window.showGiga();
                const result = await callAPI('handleAdClick', { adType: 'giga', reward: appSettings.adRewardGiga || 2000 });
                if (result.success) {
                    appData.adsGiga = result.data.adsGiga;
                    appData.adsWatched = result.data.adsWatched;
                    appData.dogsBalance = result.data.newBalance;
                    showNotification(`‚úÖ +${appSettings.adRewardGiga || 2000} GLX added!`, "success");
                    renderUI({ id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id });
                }
            } catch (e) {
                console.error(e);
                showNotification("Ad failed or closed.", "warning");
            }
        }
        
        async function handleAdsgramAd() {
            if (!canClickAd()) { showNotification("Please wait 3 seconds before clicking again.", "warning"); return; }
            await getUpdatedSettings();
            lastAdClickTime = Date.now();
            const limit = appSettings.limitAdsgram || 300;
            if ((appData.adsAdsgram || 0) >= limit) return;
            if (!AdController) { showNotification("AdsGram not initialized", "warning"); return; }
            try {
                const result = await AdController.show();
                if (result.done) {
                    const apiResult = await callAPI('handleAdClick', { adType: 'adsgram', reward: appSettings.adRewardAdsgram || 2000 });
                    if (apiResult.success) {
                        appData.adsAdsgram = apiResult.data.adsAdsgram;
                        appData.dogsBalance = apiResult.data.newBalance;
                        showNotification(`‚úÖ +${appSettings.adRewardAdsgram || 2000} GLX added!`, "success");
                        renderUI({ id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id });
                    }
                }
            } catch (error) {
                console.error("AdsGram error:", error);
                showNotification("Ad playback error.", "error");
            }
        }
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑÿ≥ÿ≠ÿ® =====
        window.selectWithdrawalType = function(type) {
            withdrawalType = type;
            document.querySelectorAll('.withdrawal-type-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.withdrawal-type-btn[data-type="${type}"]`).classList.add('active');
            if (type === 'faucetpay') {
                document.getElementById('faucetpay-form').style.display = 'block';
                document.getElementById('tonwallet-form').style.display = 'none';
            } else {
                document.getElementById('faucetpay-form').style.display = 'none';
                document.getElementById('tonwallet-form').style.display = 'block';
            }
        };
        
        async function handleFaucetPayWithdraw() {
            const email = document.getElementById('faucetpay-email').value.trim();
            const amount = parseFloat(document.getElementById('faucetpay-amount').value);
            const minAmount = appSettings.minFaucetPayWithdrawal || 0.0001;
            const currentBalance = appData.tonBalance || 0;
            if (!email || !email.includes('@')) { showNotification("Please enter a valid email address.", "warning"); return; }
            if (amount < minAmount) { showNotification(`Minimum withdrawal is ${minAmount} TON for FaucetPay.`, "warning"); return; }
            if (amount >= currentBalance) { showNotification(`Insufficient TON balance. You need at least ${(amount + 0.000001).toFixed(6)} TON.`, "warning"); return; }
            const [localPart, domain] = email.split('@');
            let maskedEmail = '';
            if (localPart.length > 3) maskedEmail = localPart.charAt(0) + '*'.repeat(Math.max(3, localPart.length - 2)) + localPart.charAt(localPart.length - 1) + '@' + domain;
            else maskedEmail = '*'.repeat(localPart.length) + '@' + domain;
            if (!confirm(`Withdraw ${amount} TON to ${maskedEmail} via FaucetPay?\n\nEmail will be partially hidden for privacy.`)) return;
            const result = await callAPI('submitWithdrawal', { method: 'faucetpay', account: email, amount: amount, maskedAccount: maskedEmail });
            if (result.success) {
                appData.tonBalance = result.data.newBalance;
                showNotification(`‚úÖ Withdrawal request submitted!\n\n${amount} TON will be sent to ${maskedEmail} within 1 minute.\n\nYour email is partially hidden for privacy.`, "success");
                document.getElementById('faucetpay-email').value = '';
                document.getElementById('faucetpay-amount').value = minAmount;
                document.getElementById('email-preview').style.display = 'none';
                switchTab('home');
                renderUI({ id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id });
            } else showNotification("Error: " + result.error, "error");
        }
        
        async function handleTonWalletWithdraw() {
            const address = document.getElementById('ton-wallet-address').value.trim();
            const amount = parseFloat(document.getElementById('ton-withdraw-amount').value);
            const memo = document.getElementById('ton-memo').value.trim();
            const minAmount = appSettings.minTonWithdrawal || 0.05;
            const currentBalance = appData.tonBalance || 0;
            if (!address || address.length < 5) { showNotification("Please enter a valid TON wallet address.", "warning"); return; }
            if (amount < minAmount) { showNotification(`Minimum withdrawal is ${minAmount} TON for TON Wallet.`, "warning"); return; }
            if (amount >= currentBalance) { showNotification(`Insufficient TON balance. You need at least ${(amount + 0.0001).toFixed(4)} TON.`, "warning"); return; }
            let shortAddress = address;
            if (address.length > 16) shortAddress = address.substring(0, 8) + '...' + address.substring(address.length - 4);
            if (!confirm(`Withdraw ${amount} TON to ${shortAddress}?\n\nAddress: ${shortAddress}\n${memo ? 'Memo: ' + memo + '\n' : ''}`)) return;
            const result = await callAPI('submitWithdrawal', { method: 'ton', account: address, amount: amount, memo: memo || '' });
            if (result.success) {
                appData.tonBalance = result.data.newBalance;
                showNotification(`‚úÖ Withdrawal request submitted!\n\n${amount} TON will be sent to your wallet within 24 hours.\n\nAddress: ${shortAddress}`, "success");
                document.getElementById('ton-wallet-address').value = '';
                document.getElementById('ton-memo').value = '';
                document.getElementById('ton-withdraw-amount').value = minAmount;
                switchTab('home');
                renderUI({ id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id });
            } else showNotification("Error: " + result.error, "error");
        }
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖŸáÿßŸÖ =====
        window.handleDynamicTask = async function(element) {
            const { id, reward, title, link } = element.dataset;
            const statusEl = document.getElementById(`status-${id}`);
            const rewardEl = document.getElementById(`reward-${id}`);
            if (element.classList.contains('waiting-verify')) {
                await verifyMembership(element, link, id, reward, title);
                return;
            }
            if (window.Telegram?.WebApp) window.Telegram.WebApp.openLink(link);
            else window.open(link, '_blank');
            element.classList.add('waiting-verify');
            statusEl.textContent = "Tap again to Verify";
            statusEl.style.color = "#ffb300";
            rewardEl.textContent = "Check";
            rewardEl.style.fontSize = "12px";
        };
        
        async function verifyMembership(element, link, taskId, reward, title) {
            const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
            if (!userId) { showNotification("‚ùå User authentication error", "error"); element.classList.remove('waiting-verify'); return; }
            const channelUsername = extractChannelUsernameFromLink(link);
            if (!channelUsername) { showNotification("‚ùå Invalid channel link", "error"); element.classList.remove('waiting-verify'); return; }
            const statusEl = document.getElementById(`status-${taskId}`);
            statusEl.textContent = "Verifying membership...";
            statusEl.style.color = "#FFC107";
            try {
                const verificationResult = await verifyTaskChannel(taskId, channelUsername);
                if (verificationResult.success) {
                    const isMember = verificationResult.data.isMember;
                    if (isMember) {
                        const result = await callAPI('verifyTaskCompletion', { taskId: taskId, reward: reward, title: title, link: link, channelUsername: channelUsername, verified: true });
                        if (result.success) {
                            appData.dogsBalance = result.data.newBalance;
                            element.style.opacity = '0.5';
                            element.style.pointerEvents = 'none';
                            document.getElementById(`status-${taskId}`).textContent = "Verified ‚úì";
                            document.getElementById(`status-${taskId}`).style.color = "#27ae60";
                            document.getElementById(`reward-${taskId}`).textContent = "Done";
                            showNotification(`‚úÖ Channel Verified! +${reward} GLX`, "success");
                            renderUI({ id: userId });
                        } else {
                            showNotification("‚ùå " + result.error, "warning");
                            element.classList.remove('waiting-verify');
                            statusEl.textContent = "Join First!";
                            statusEl.style.color = "#ff4444";
                        }
                    } else {
                        showNotification("‚ùå You must join the channel first!", "warning");
                        element.classList.remove('waiting-verify');
                        statusEl.textContent = "Join First!";
                        statusEl.style.color = "#ff4444";
                    }
                } else {
                    showNotification("‚ùå Verification failed: " + verificationResult.error, "error");
                    element.classList.remove('waiting-verify');
                    statusEl.textContent = "Error - Try Again";
                    statusEl.style.color = "#ff4444";
                }
            } catch (error) {
                console.error("Verification error:", error);
                showNotification("‚ùå Verification error. Please try again.", "error");
                element.classList.remove('waiting-verify');
                statusEl.textContent = "Error - Try Again";
                statusEl.style.color = "#ff4444";
            }
        }
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑÿ™ŸÜŸÇŸÑ =====
        function switchTab(targetId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById(targetId).classList.add('active');
            document.querySelector(`.nav-item[data-target="${targetId}"]`)?.classList.add('active');
            const floatingBtn = document.getElementById('floatingAddTask');
            if (targetId === 'tasks') floatingBtn.classList.remove('hidden');
            else floatingBtn.classList.add('hidden');
            if (targetId === 'leaderboard' && !isLeaderboardLoaded) {
                renderLeaderboard();
                isLeaderboardLoaded = true;
            }
            if (targetId === 'bonus') {
                const grid = document.querySelector('.bonus-grid');
                grid.style.display = 'grid';
                document.getElementById('coin-flip-section').style.display = 'none';
                document.getElementById('promo-codes-section').style.display = 'none';
                document.getElementById('daily-streak-section').style.display = 'none';
                document.getElementById('galaxy-slots-section').style.display = 'none';
                renderDailyBonusUI();
                updateAvailableSpins();
                resetCoinFlipGame();
            }
            if (targetId === 'withdrawal-history') renderWithdrawalHistory();
            if (targetId === 'referrals') {}
            if (targetId === 'competition') initializeCompetition().then(() => { updateCompetitionUI(); });
            if (targetId === 'galaxy-log-page') renderGalaxyLog();
            if (targetId === 'user-withdrawals') updateUserWithdrawalsStats();
            window.scrollTo(0, 0);
        }
        
        // ===== ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® =====
        async function renderLeaderboard() {
            const result = await callAPI('getLeaderboard');
            if (result.success) {
                const byInv = result.data.byInvites || [];
                const byGLX = result.data.byGLX || [];
                fillList(byInv, 'invites-leaderboard-list', 'referrals', 'Frens');
                fillList(byGLX, 'earnings-leaderboard-list', 'dogsBalance', 'GLX');
            }
        }
        
        function fillList(data, containerId, key, suffix) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align:center;padding:20px">No Data</p>';
                return;
            }
            data.slice(0, 50).forEach((u, idx) => {
                const val = key === 'dogsBalance' ? Math.floor(u[key] || 0).toLocaleString() : (u[key] || 0);
                const html = `<div class="list-card"><div style="width:30px;font-weight:800;color:#fff">#${idx + 1}</div><div class="lc-content"><div class="lc-title">${u.name || 'Anonymous'}</div></div><div class="lc-end"><div class="lc-val" style="color:#fff">${val} ${suffix}</div></div></div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }
        
        function getLevel(balance) {
            if (balance >= 5000000) return 10;
            if (balance >= 2500000) return 9;
            if (balance >= 1000000) return 8;
            if (balance >= 500000) return 7;
            if (balance >= 250000) return 6;
            if (balance >= 100000) return 5;
            if (balance >= 50000) return 4;
            if (balance >= 25000) return 3;
            if (balance >= 5000) return 2;
            return 1;
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="bn">
<head>
    <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„head ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ -->
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¸Ø± -->
    <div id="banned-page" class="banned-container">
        <!-- Ù…Ø­ØªÙˆÙ‰ Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¸Ø± -->
    </div>

    <!-- Ø§Ù„Ù†Ø¬ÙˆÙ… ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© -->
    <div class="stars" id="stars"></div>

    <div id="app-loader">
        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    </div>
    
    <!-- Ø§Ù„Ø¨ÙˆØ¨ Ø£Ø¨ -->
    <div id="popup" class="popup-overlay">
        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨ÙˆØ¨ Ø£Ø¨ -->
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„ÙŠÙˆÙ…ÙŠ -->
    <div id="daily-calendar-popup" class="popup-overlay" style="display: none;">
        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… -->
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø´Ø±Ø­ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© -->
    <div id="contest-guide-popup" class="popup-overlay" style="display: none;">
        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© -->
    </div>
    
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ - ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
    <div id="subscription-page" style="display: none;">
        <div class="subscription-container">
            <h2 style="color: var(--ship-gold); margin-bottom: 10px;">ğŸ“¢ Required Subscription</h2>
            <p style="margin-bottom: 20px;">You must subscribe to our channels to use the bot and earn rewards!</p>
            
            <div id="channels-list">
                <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
            
            <!-- Ù‚Ø³Ù… Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù‚Ù†ÙˆØ§Øª -->
            <div id="ad-channels-section" style="margin-top: 30px; display: none;">
                <h3 style="color: var(--ship-gold); margin-bottom: 15px;">ğŸ¯ Advertised Channels</h3>
                <p style="margin-bottom: 15px; font-size: 0.9rem;">Subscribe to these channels for extra rewards!</p>
                <div id="ad-channels-list">
                    <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>
                <p style="margin-top: 15px; font-size: 0.8rem; color: var(--text-secondary-dark); text-align: center;">
                    ğŸ’¡ Want to advertise your channel here? Contact @aborabie777
                </p>
            </div>
            
            <button id="check-subscription-btn" class="check-subscription-btn" style="margin-top: 20px; width: 100%;">
                ğŸ”„ Check Subscription
            </button>
            
            <p style="margin-top: 15px; font-size: 0.9rem; opacity: 0.8;">
                After subscribing, click the button above to verify
            </p>

            <!-- Ø²Ø± Ø§Ù„ØªØ®Ø·ÙŠ Ù„Ù„ØªØ·ÙˆÙŠØ± ÙÙ‚Ø· -->
            <button id="skip-subscription-btn" style="margin-top: 10px; padding: 8px 15px; background: transparent; color: var(--ship-gold); border: 1px solid var(--ship-gold); border-radius: 5px; cursor: pointer; font-size: 0.8rem;">
                ğŸš¨ Skip for Testing (Dev Only)
            </button>
        </div>
    </div>

    <!-- ØªØµÙ…ÙŠÙ… Ø§Ù„Ø³ÙÙŠÙ†Ø© -->
    <div class="ship-container" style="display: none;">
        <!-- Ø¨Ø§Ù‚ÙŠ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³ÙÙŠÙ†Ø© -->
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const tg = window.Telegram?.WebApp || {};
        
        // âœ… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ
        const firebaseConfig = JSON.parse(atob("eyJhcGlLZXkiOiJBSXphU3lBazkwOUNGblc0Wk1lQkVNMXl4UmJRYlc5dzZVTm81OCIsImF1dGhEb21haW4iOiJlYXJuLW1vbmV5LWMzYmFkLmZpcmViYXNlYXBwLmNvbSIsImRhdGFiYXNlVVJMIjoiaHR0cHM6Ly9lYXJuLW1vbmV5LWMzYmFkLWRlZmF1bHQtcnRkYi5maXJlYmFzZWlvLmNvbSIsInByb2plY3RJZCI6ImVhcm4tbW9uZXktYzNiYWQiLCJzdG9yYWdlQnVja2V0IjoiZWFybi1tb25leS1jM2JhZC5maXJlYmFzZXN0b3JhZ2UuYXBwIiwibWVzc2FnaW5nU2VuZGVySWQiOiIxMDIyNjg4NTY2MDExIiwiYXBwSWQiOiIxOjEwMjI2ODg1NjYwMTE6d2ViOjY5MGY2ZmFhMTlkZDMzMzdhMmVlNWUiLCJtZWFzdXJlbWVudElkIjoiRy0wQ0gxTEJGTEgyIn0="));

        // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ...

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        const setupSubscriptionEventListeners = () => {
            console.log('ğŸ”§ Setting up subscription event listeners...');
            
            // âœ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø§Ø³ØªØ®Ø¯Ø§Ù… event delegation Ù„Ø£Ø²Ø±Ø§Ø± Join
            document.addEventListener('click', function(event) {
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± Join ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                if (event.target.classList.contains('join-channel-btn') || 
                    event.target.closest('.join-channel-btn')) {
                    
                    const joinButton = event.target.classList.contains('join-channel-btn') ? 
                        event.target : event.target.closest('.join-channel-btn');
                    
                    if (joinButton) {
                        const channelUrl = joinButton.getAttribute('data-channel-url');
                        console.log('ğŸ¯ Join button clicked:', channelUrl);
                        
                        try {
                            if (window.Telegram?.WebApp?.openLink) {
                                window.Telegram.WebApp.openLink(channelUrl);
                            } else {
                                window.open(channelUrl, '_blank');
                            }
                        } catch (error) {
                            window.open(channelUrl, '_blank');
                        }
                    }
                }
                
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± Subscribe ÙÙŠ Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
                if (event.target.classList.contains('subscribe-ad-btn') || 
                    event.target.closest('.subscribe-ad-btn')) {
                    
                    const subscribeButton = event.target.classList.contains('subscribe-ad-btn') ? 
                        event.target : event.target.closest('.subscribe-ad-btn');
                    
                    if (subscribeButton && !subscribeButton.disabled) {
                        const channelUrl = subscribeButton.getAttribute('data-channel-url');
                        console.log('ğŸ¯ Subscribe button clicked:', channelUrl);
                        
                        try {
                            if (window.Telegram?.WebApp?.openLink) {
                                window.Telegram.WebApp.openLink(channelUrl);
                            } else {
                                window.open(channelUrl, '_blank');
                            }
                        } catch (error) {
                            window.open(channelUrl, '_blank');
                        }
                    }
                }
            });

            // âœ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù…Ø¨Ø§Ø´Ø± Ù„Ø²Ø± Check Subscription
            const checkSubscriptionBtn = document.getElementById('check-subscription-btn');
            if (checkSubscriptionBtn) {
                checkSubscriptionBtn.addEventListener('click', handleCheckSubscription);
            } else {
                console.error('âŒ Check subscription button not found!');
            }

            // âœ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù…Ø¨Ø§Ø´Ø± Ù„Ø²Ø± Skip
            const skipSubscriptionBtn = document.getElementById('skip-subscription-btn');
            if (skipSubscriptionBtn) {
                skipSubscriptionBtn.addEventListener('click', handleSkipSubscription);
            } else {
                console.error('âŒ Skip subscription button not found!');
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø²Ø± Check Subscription
        const handleCheckSubscription = async () => {
            console.log('ğŸ”„ Check Subscription button clicked');
            
            const checkBtn = document.getElementById('check-subscription-btn');
            checkBtn.disabled = true;
            checkBtn.textContent = 'Checking...';
            
            showPopup(`
                <div style="margin-bottom:10px;">
                    <div class="spinner" style="width:40px;height:40px;border-radius:50%;border:4px solid var(--ship-gold);border-top-color:transparent;animation:spin 1s linear infinite;margin:0 auto;"></div>
                </div>
                <h2>Checking Subscription</h2>
                <p>Verifying channel subscriptions...</p>
            `);

            try {
                const newResults = await checkAllSubscriptions();
                closePopup();
                
                updateSubscriptionUI(newResults.subscriptionResults);
                await renderAdChannels();
                
                if (newResults.allSubscribed) {
                    document.getElementById('subscription-page').style.display = 'none';
                    await continueAppInitialization(firebase.database());
                } else {
                    try {
                        if (tg.showAlert) tg.showAlert("Please subscribe to all channels first!");
                    } catch(e) {}
                }
            } catch (error) {
                console.error('Error checking subscription:', error);
                closePopup();
                try {
                    if (tg.showAlert) tg.showAlert("Error checking subscription. Please try again.");
                } catch(e) {}
            } finally {
                checkBtn.disabled = false;
                checkBtn.textContent = 'ğŸ”„ Check Subscription';
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø²Ø± Skip
        const handleSkipSubscription = () => {
            if (confirm('ğŸš¨ This is for development only! Are you sure you want to skip subscription?')) {
                skipSubscription();
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        const updateSubscriptionUI = (subscriptionResults) => {
            const channelsList = document.getElementById('channels-list');
            if (!channelsList) {
                console.error('âŒ channels-list element not found!');
                return;
            }
            
            channelsList.innerHTML = '';
            
            subscriptionResults.forEach(channel => {
                const channelElement = document.createElement('div');
                channelElement.className = 'channel-item';
                
                let statusText = 'âŒ Not Subscribed';
                let statusClass = 'status-not-subscribed';
                
                if (channel.subscribed) {
                    statusText = 'âœ… Subscribed';
                    statusClass = 'status-subscribed';
                } else if (channel.error) {
                    statusText = 'âš ï¸ Check Failed';
                    statusClass = 'status-not-subscribed';
                }
                
                channelElement.innerHTML = `
                    <div class="channel-info">
                        <img src="${channel.icon}" alt="${channel.name}" class="channel-icon">
                        <div style="text-align: left;">
                            <h4 style="margin: 0; font-size: 1rem;">${channel.name}</h4>
                            <small style="opacity: 0.7;">@${channel.username}</small>
                        </div>
                    </div>
                    <span class="channel-status ${statusClass}">
                        ${statusText}
                    </span>
                    <button class="action-btn join-channel-btn" data-channel-url="${channel.url}" style="padding: 8px 12px; font-size: 0.8rem;">
                        Join
                    </button>
                `;
                channelsList.appendChild(channelElement);
            });
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø¹Ø±Ø¶ Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
        const renderAdChannels = async () => {
            const adChannelsList = document.getElementById('ad-channels-list');
            const adChannelsSection = document.getElementById('ad-channels-section');
            
            if (!adChannelsList || !adChannelsSection) {
                console.error('âŒ Ad channels elements not found!');
                return;
            }
            
            if (!adChannels || adChannels.length === 0) {
                adChannelsSection.style.display = 'none';
                return;
            }
            
            adChannelsSection.style.display = 'block';
            adChannelsList.innerHTML = '';
            
            for (const channel of adChannels) {
                const isSubscribed = await checkAdChannelSubscription(channel.username);
                
                const channelElement = document.createElement('div');
                channelElement.className = 'ad-channel-item';
                
                channelElement.innerHTML = `
                    <div class="ad-channel-info">
                        <img src="${channel.icon}" alt="${channel.name}" class="ad-channel-icon">
                        <div class="ad-channel-details">
                            <div class="ad-channel-name">${channel.name}</div>
                            <div class="ad-channel-description">${channel.description || 'Subscribe for rewards'}</div>
                            <div class="ad-channel-contact">Contact: @${channel.contact || 'aborabie777'}</div>
                        </div>
                    </div>
                    <div class="ad-channel-reward">
                        <div class="ad-reward-amount">+${channel.reward || 0} Points</div>
                        <div class="ad-reward-label">Contest Points</div>
                    </div>
                    <button class="action-btn subscribe-ad-btn" data-channel-url="${channel.url}" ${isSubscribed ? 'disabled' : ''} style="padding: 8px 12px; font-size: 0.8rem;">
                        ${isSubscribed ? 'âœ… Subscribed' : 'Subscribe'}
                    </button>
                `;
                adChannelsList.appendChild(channelElement);
            }
        };

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const initApp = async () => {
            try {
                createStars();
                
                if (tg.ready) { tg.ready(); try { tg.expand(); } catch(e){} }
                
                tgUser = (tg.initDataUnsafe && tg.initDataUnsafe.user) || {};
                if (!tgUser || !tgUser.id) { 
                    console.warn("Telegram user not available in this environment."); 
                    tgUser = { id: 'dev_user_' + Date.now(), first_name: 'Dev', last_name: 'User' };
                }

                console.log('ğŸ“± Telegram WebApp Data:', {
                    user: tgUser,
                    initData: tg.initData,
                    initDataUnsafe: tg.initDataUnsafe
                });

                firebase.initializeApp(firebaseConfig); 
                const db = firebase.database();

                await loadDynamicSettings(db);

                const configSnapshot = await db.ref('config').once('value');
                appConfig = configSnapshot.val() || {};
                
                appConfig.referralBonus = appConfig.referralBonus || 0.001;
                appConfig.botUsername = appConfig.botUsername || "Aborabie777_bot";
                appConfig.minimumWithdrawReferrals = appConfig.minimumWithdrawReferrals || 0;
                
                console.log('ğŸ”§ Firebase Config Loaded:', {
                    botToken: appConfig.botToken ? 'âœ… Loaded' : 'âŒ Missing',
                    botUsername: appConfig.botUsername,
                    adValue: appConfig.adValue,
                    dailyAdLimit: appConfig.dailyAdLimit
                });

                // ... ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ ...

                showPopup(`
                    <div style="margin-bottom:10px;">
                        <div class="spinner" style="width:40px;height:40px;border-radius:50%;border:4px solid var(--ship-gold);border-top-color:transparent;animation:spin 1s linear infinite;margin:0 auto;"></div>
                    </div>
                    <h2>Checking Subscription</h2>
                    <p>Verifying channel subscriptions...</p>
                `);

                const { subscriptionResults, allSubscribed, allSuccessful } = await checkAllSubscriptions();
                closePopup();
                
                if (!allSubscribed) {
                    document.getElementById('app-loader').style.display = 'none';
                    document.getElementById('subscription-page').style.display = 'block';
                    updateSubscriptionUI(subscriptionResults);
                    await renderAdChannels();
                    
                    // âœ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø¨Ø¹Ø¯ Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø©
                    setTimeout(() => {
                        setupSubscriptionEventListeners();
                    }, 100);
                    
                    return;
                }
                
                await continueAppInitialization(db);
                
            } catch (error) { 
                console.error("Initialization failed:", error); 
                try { 
                    if (tg.showAlert) tg.showAlert("Failed to load app data. Please try again."); 
                } catch(e){} 
            }
        };

        // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ ...

        // âœ… Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        initApp();
    });

    // Ø¥Ø¶Ø§ÙØ© keyframes Ù„Ù„Ù€ spinner
    (function addSpinKeyframes(){ 
        const style = document.createElement('style'); 
        style.innerHTML='@keyframes spin{to{transform:rotate(360deg)}}'; 
        document.head.appendChild(style); 
    })();
    </script>
</body>
</html>

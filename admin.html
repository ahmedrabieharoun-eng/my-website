<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crystal Ranch ¬∑ Market Dashboard (20k+ Orders)</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            border: 1px solid rgba(255, 92, 168, 0.3);
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header h1 i {
            color: #FF5CA8;
        }
        
        .header h1 span {
            background: linear-gradient(145deg, #FFD700, #FFA500);
            color: black;
            padding: 5px 20px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .stats-grid {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px 25px;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.3);
            min-width: 140px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #FFD700;
        }
        
        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }
        
        /* Threshold Banner */
        .threshold-banner {
            background: linear-gradient(145deg, rgba(255, 92, 168, 0.2), rgba(255, 215, 0, 0.2));
            border: 2px solid #FFD700;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .threshold-icon {
            font-size: 48px;
            color: #FFD700;
        }
        
        .threshold-text {
            flex: 1;
        }
        
        .threshold-title {
            font-size: 24px;
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 5px;
        }
        
        .threshold-desc {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .threshold-value {
            background: rgba(255, 215, 0, 0.2);
            padding: 10px 30px;
            border-radius: 50px;
            font-size: 32px;
            font-weight: 800;
            color: #FFD700;
            border: 2px solid #FFD700;
        }
        
        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }
        
        .btn-primary {
            background: linear-gradient(145deg, #FF5CA8, #D94A8F);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 92, 168, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(145deg, #FF4B5C, #d63f4f);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 75, 92, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(145deg, #FFD700, #FFA500);
            color: black;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(145deg, #00F27A, #00b35e);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 242, 122, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(145deg, #00D4FF, #0099cc);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
        }
        
        .btn-purple {
            background: linear-gradient(145deg, #9B5DE5, #7A3EC8);
            color: white;
            box-shadow: 0 4px 15px rgba(155, 93, 229, 0.4);
        }
        
        .btn:hover {
            transform: scale(1.02);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #FFD700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        /* Summary Cards */
        .summary-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .summary-title {
            font-size: 16px;
            font-weight: 600;
            color: #FFD700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .summary-list {
            max-height: 250px;
            overflow-y: auto;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 13px;
        }
        
        .summary-item:hover {
            background: rgba(255, 215, 0, 0.1);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .badge-danger {
            background: rgba(255, 75, 92, 0.2);
            color: #FF4B5C;
            border: 1px solid rgba(255, 75, 92, 0.3);
        }
        
        .badge-warning {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .badge-success {
            background: rgba(0, 242, 122, 0.2);
            color: #00F27A;
            border: 1px solid rgba(0, 242, 122, 0.3);
        }
        
        .badge-info {
            background: rgba(0, 212, 255, 0.2);
            color: #00D4FF;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .badge-purple {
            background: rgba(155, 93, 229, 0.2);
            color: #9B5DE5;
            border: 1px solid rgba(155, 93, 229, 0.3);
        }
        
        /* Progress */
        .progress-container {
            margin-bottom: 20px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FF5CA8, #00D4FF);
            transition: width 0.3s;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.3) 0%, 
                rgba(255,255,255,0.1) 50%, 
                rgba(255,255,255,0.3) 100%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00F27A;
            color: black;
            padding: 15px 25px;
            border-radius: 30px;
            font-weight: 600;
            z-index: 2000;
            animation: slideIn 0.3s;
            box-shadow: 0 5px 20px rgba(0, 242, 122, 0.4);
        }
        
        .toast.error {
            background: #FF4B5C;
            color: white;
        }
        
        .toast.warning {
            background: #FFA500;
            color: black;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 50px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .loading i {
            font-size: 40px;
            margin-bottom: 15px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Table */
        .table-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            overflow: auto;
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }
        
        th {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px 10px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #FFD700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #FFD700;
        }
        
        td {
            padding: 15px 10px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            font-size: 13px;
        }
        
        tr:hover {
            background: rgba(255, 215, 0, 0.05);
        }
        
        tr.high-value {
            background: rgba(255, 75, 92, 0.1);
            border-left: 3px solid #FF4B5C;
        }
        
        tr.suspicious {
            background: rgba(255, 215, 0, 0.15);
            border-left: 3px solid #FFD700;
        }
        
        .user-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(145deg, #FF5CA8, #00D4FF);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 6px 10px;
            border-radius: 8px;
            border: none;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .action-btn.view {
            background: rgba(0, 212, 255, 0.2);
            color: #00D4FF;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .action-btn.view:hover {
            background: rgba(0, 212, 255, 0.4);
        }
        
        .action-btn.cancel {
            background: rgba(255, 75, 92, 0.2);
            color: #FF4B5C;
            border: 1px solid rgba(255, 75, 92, 0.3);
        }
        
        .action-btn.cancel:hover {
            background: rgba(255, 75, 92, 0.4);
        }
        
        .action-btn.refund {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .action-btn.refund:hover {
            background: rgba(255, 215, 0, 0.4);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: #1a1a2e;
            border: 1px solid #FFD700;
            border-radius: 24px;
            padding: 25px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #FFD700;
        }
        
        .modal-close {
            font-size: 24px;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
        }
        
        .detail-label {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .detail-value {
            font-weight: 600;
            color: #FFD700;
        }
        
        .detail-value.high {
            color: #FF4B5C;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .threshold-banner {
                flex-direction: column;
                text-align: center;
            }
            
            .controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-chart-line"></i>
                Market Dashboard
                <span>20k+ Monitor</span>
            </h1>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="activeOrders">0</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="largeOrders">0</div>
                    <div class="stat-label">20k+ Orders</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalVolume">0</div>
                    <div class="stat-label">Total Volume</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="uniqueUsers">0</div>
                    <div class="stat-label">Unique Users</div>
                </div>
            </div>
        </div>
        
        <!-- Threshold Banner -->
        <div class="threshold-banner">
            <div class="threshold-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="threshold-text">
                <div class="threshold-title">Large Orders Monitor</div>
                <div class="threshold-desc">Showing all orders with quantity greater than 20,000 units</div>
            </div>
            <div class="threshold-value">
                > 20,000
            </div>
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-primary" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>
            <button class="btn btn-warning" id="scanLargeBtn">
                <i class="fas fa-search"></i> Scan Large Orders
            </button>
            <button class="btn btn-danger" id="cancelAllLargeBtn">
                <i class="fas fa-ban"></i> Cancel All 20k+ Orders
            </button>
            <button class="btn btn-info" id="exportBtn">
                <i class="fas fa-download"></i> Export CSV
            </button>
            <button class="btn btn-purple" id="cleanupDeadOrdersBtn">
                <i class="fas fa-broom"></i> üßπ ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖŸäÿ™ÿ©
            </button>
        </div>
        
        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    Orders by Resource
                </div>
                <div class="chart-container">
                    <canvas id="resourceChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">
                    <i class="fas fa-chart-bar"></i>
                    Orders by Status
                </div>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    Order Volume Trend
                </div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Summary Cards -->
        <div class="summary-section">
            <div class="summary-card">
                <div class="summary-title">
                    <i class="fas fa-trophy" style="color: #FFD700;"></i>
                    Top 10 Largest Orders
                </div>
                <div class="summary-list" id="topOrdersList">
                    <div class="loading" style="padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-title">
                    <i class="fas fa-users" style="color: #FF5CA8;"></i>
                    Top Users by Volume
                </div>
                <div class="summary-list" id="topUsersList">
                    <div class="loading" style="padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-title">
                    <i class="fas fa-clock" style="color: #00D4FF;"></i>
                    Recent Large Orders
                </div>
                <div class="summary-list" id="recentOrdersList">
                    <div class="loading" style="padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Progress -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <div class="progress-text" id="progressText">Processing...</div>
            <div class="progress-stats" id="progressStats">
                <span id="progressCurrent">0</span> / <span id="progressTotal">0</span>
                <span id="progressSuccess">‚úÖ 0</span>
                <span id="progressFailed">‚ùå 0</span>
            </div>
        </div>
        
        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-group">
                <span class="filter-label">Show:</span>
                <select class="filter-select" id="filterType">
                    <option value="all">All Orders</option>
                    <option value="large" selected>20k+ Only</option>
                    <option value="active">Active Only</option>
                    <option value="cancelled">Cancelled Only</option>
                </select>
            </div>
            
            <div class="filter-group">
                <span class="filter-label">Resource:</span>
                <select class="filter-select" id="filterResource">
                    <option value="all">All</option>
                    <option value="milk">Milk ü•õ</option>
                    <option value="eggs">Eggs ü•ö</option>
                </select>
            </div>
            
            <div class="filter-group">
                <span class="filter-label">Min Quantity:</span>
                <input type="number" class="filter-input" id="minQuantity" value="20000" step="1000">
            </div>
            
            <div class="filter-group">
                <span class="filter-label">Sort by:</span>
                <select class="filter-select" id="sortBy">
                    <option value="quantity-desc">Quantity (High to Low)</option>
                    <option value="quantity-asc">Quantity (Low to High)</option>
                    <option value="date-desc">Date (Newest)</option>
                    <option value="date-asc">Date (Oldest)</option>
                    <option value="price-desc">Price (High to Low)</option>
                    <option value="price-asc">Price (Low to High)</option>
                </select>
            </div>
        </div>
        
        <!-- Orders Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>User</th>
                        <th>Type</th>
                        <th>Resource</th>
                        <th>Quantity</th>
                        <th>Remaining</th>
                        <th>Price/Unit</th>
                        <th>Total Value</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <tr>
                        <td colspan="11" class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <div>Loading orders...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Order Details Modal -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-receipt"></i> Order Details
                </div>
                <i class="fas fa-times modal-close" id="closeModal"></i>
            </div>
            <div id="orderDetails"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-danger" id="cancelOrderBtn" style="flex: 1;">
                    <i class="fas fa-ban"></i> Cancel Order
                </button>
                <button class="btn btn-secondary" id="closeModalBtn" style="flex: 1;">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Cancel Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle" style="color: #FF4B5C;"></i> Confirm Cancel
                </div>
                <i class="fas fa-times modal-close" id="closeConfirmModal"></i>
            </div>
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-ban" style="font-size: 48px; color: #FF4B5C; margin-bottom: 15px;"></i>
                <p id="confirmText">Are you sure you want to cancel this order?</p>
                <p style="font-size: 12px; color: #FFD700; margin-top: 10px;" id="confirmDetails"></p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-danger" id="confirmCancelBtn" style="flex: 1;">
                    Yes, Cancel
                </button>
                <button class="btn btn-secondary" id="cancelConfirmBtn" style="flex: 1;">
                    No
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC5dwRaz3L-aK7I5CoPkbB31MzXB62lgrU",
            authDomain: "earnmoney124553.firebaseapp.com",
            databaseURL: "https://earnmoney124553-default-rtdb.firebaseio.com",
            projectId: "earnmoney124553",
            storageBucket: "earnmoney124553.firebasestorage.app",
            messagingSenderId: "325528918523",
            appId: "1:325528918523:web:73d84f48a24c1e0cbfd35e",
            measurementId: "G-G1H96Q5XCJ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ============================================
        // CONSTANTS
        // ============================================
        const LARGE_ORDER_THRESHOLD = 20000; // 20,000 units
        
        // ============================================
        // STATE
        // ============================================
        let App = {
            orders: {},
            users: {},
            filteredOrders: [],
            largeOrders: [],
            
            stats: {
                total: 0,
                active: 0,
                cancelled: 0,
                filled: 0,
                large: 0,
                milkVolume: 0,
                eggsVolume: 0,
                totalVolume: 0,
                uniqueUsers: 0
            },
            
            charts: {
                resource: null,
                status: null,
                trend: null
            },
            
            filters: {
                type: 'large',
                resource: 'all',
                minQuantity: LARGE_ORDER_THRESHOLD,
                sortBy: 'quantity-desc'
            },
            
            pendingOrder: null,
            isProcessing: false
        };

        // ============================================
        // LOAD DATA
        // ============================================
        async function loadData() {
            showProgress(true, 'Loading data...');
            
            try {
                // Load orders
                const ordersSnapshot = await database.ref('orders').once('value');
                App.orders = ordersSnapshot.val() || {};
                
                // Load users
                const usersSnapshot = await database.ref('users').once('value');
                App.users = usersSnapshot.val() || {};
                
                processOrders();
                updateStats();
                filterOrders();
                renderTable();
                updateSummaryCards();
                updateCharts();
                
                showToast(`‚úÖ Loaded ${App.stats.total} orders, ${App.stats.large} large orders`);
                
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('‚ùå Error loading data: ' + error.message, 'error');
            } finally {
                showProgress(false);
            }
        }

        // ============================================
        // PROCESS ORDERS
        // ============================================
        function processOrders() {
            App.largeOrders = [];
            App.stats = {
                total: 0,
                active: 0,
                cancelled: 0,
                filled: 0,
                large: 0,
                milkVolume: 0,
                eggsVolume: 0,
                totalVolume: 0,
                uniqueUsers: new Set()
            };
            
            for (const [orderId, order] of Object.entries(App.orders)) {
                if (!order) continue;
                
                App.stats.total++;
                App.stats.uniqueUsers.add(order.userId);
                
                switch(order.status) {
                    case 'active': App.stats.active++; break;
                    case 'cancelled': App.stats.cancelled++; break;
                    case 'filled': App.stats.filled++; break;
                }
                
                const quantity = order.quantity || 0;
                if (order.resource === 'milk') {
                    App.stats.milkVolume += quantity;
                } else if (order.resource === 'eggs') {
                    App.stats.eggsVolume += quantity;
                }
                App.stats.totalVolume += quantity;
                
                // Check if large order
                if (quantity >= LARGE_ORDER_THRESHOLD) {
                    App.stats.large++;
                    App.largeOrders.push({
                        orderId,
                        ...order
                    });
                }
            }
            
            App.stats.uniqueUsers = App.stats.uniqueUsers.size;
            
            // Sort large orders by quantity
            App.largeOrders.sort((a, b) => (b.quantity || 0) - (a.quantity || 0));
        }

        // ============================================
        // FILTER ORDERS
        // ============================================
        function filterOrders() {
            const { type, resource, minQuantity, sortBy } = App.filters;
            
            let orders = Object.entries(App.orders).map(([orderId, order]) => ({
                orderId,
                ...order
            }));
            
            // Apply type filter
            if (type === 'large') {
                orders = orders.filter(o => (o.quantity || 0) >= minQuantity);
            } else if (type === 'active') {
                orders = orders.filter(o => o.status === 'active');
            } else if (type === 'cancelled') {
                orders = orders.filter(o => o.status === 'cancelled');
            }
            
            // Apply resource filter
            if (resource !== 'all') {
                orders = orders.filter(o => o.resource === resource);
            }
            
            // Apply sorting
            switch(sortBy) {
                case 'quantity-desc':
                    orders.sort((a, b) => (b.quantity || 0) - (a.quantity || 0));
                    break;
                case 'quantity-asc':
                    orders.sort((a, b) => (a.quantity || 0) - (b.quantity || 0));
                    break;
                case 'date-desc':
                    orders.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    break;
                case 'date-asc':
                    orders.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                    break;
                case 'price-desc':
                    orders.sort((a, b) => (b.pricePerUnit || 0) - (a.pricePerUnit || 0));
                    break;
                case 'price-asc':
                    orders.sort((a, b) => (a.pricePerUnit || 0) - (b.pricePerUnit || 0));
                    break;
            }
            
            App.filteredOrders = orders;
        }

        // ============================================
        // CANCEL ORDER FUNCTION (ŸÖÿ≠ÿØÿ´)
        // ============================================
        async function cancelOrder(orderId, order, shouldRefund = true) {
            try {
                const updates = {};
                
                // 1. ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∑ŸÑÿ® ŸÅŸä ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿπÿßŸÖ
                updates[`orders/${orderId}`] = {
                    ...order,
                    status: 'cancelled',
                    updatedAt: Date.now(),
                    cancelledBy: 'admin-dashboard',
                    cancelReason: 'Cancelled from Market Dashboard'
                };
                
                // 2. ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∑ŸÑÿ® ŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                if (order.userId) {
                    updates[`users/${order.userId}/orders/${orderId}`] = {
                        ...order,
                        status: 'cancelled',
                        updatedAt: Date.now(),
                        cancelledBy: 'admin-dashboard',
                        cancelReason: 'Cancelled from Market Dashboard'
                    };
                }
                
                // 3. ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖŸàÿßÿ±ÿØ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ∑ŸÑÿ® active
                if (shouldRefund && order.status === 'active' && order.userId) {
                    const userRef = database.ref(`users/${order.userId}`);
                    const userSnapshot = await userRef.once('value');
                    const user = userSnapshot.val() || {};
                    
                    const resource = order.resource;
                    const quantity = order.remaining || order.quantity;
                    
                    // ÿ™ÿ≠ÿØŸäÿ´ ÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                    updates[`users/${order.userId}/${resource}`] = (user[resource] || 0) + quantity;
                    updates[`users/${order.userId}/updatedAt`] = Date.now();
                    
                    // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπÿßŸÖŸÑÿ© ŸÑŸÑÿ≥ÿ¨ŸÑ
                    const transactionId = `transaction_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    updates[`users/${order.userId}/transactions/${transactionId}`] = {
                        type: 'admin_cancel',
                        orderId: orderId,
                        resource: resource,
                        quantity: quantity,
                        reason: 'Cancelled from Market Dashboard',
                        timestamp: Date.now()
                    };
                }
                
                // ÿ™ŸÜŸÅŸäÿ∞ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿØŸÅÿπÿ© Ÿàÿßÿ≠ÿØÿ©
                await database.ref().update(updates);
                
                return true;
                
            } catch (error) {
                console.error('Cancel error:', error);
                throw error;
            }
        }

        // ============================================
        // DELETE DEAD ORDER (ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ŸÑÿ® ÿßŸÑŸÖŸäÿ™ ŸÜŸáÿßÿ¶ŸäÿßŸã)
        // ============================================
        async function deleteDeadOrder(userId, orderId) {
            try {
                // ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ŸÑÿ® ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸÇÿ∑ (ŸÑÿ£ŸÜŸá ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑÿ≥ŸàŸÇ)
                await database.ref(`users/${userId}/orders/${orderId}`).remove();
                return true;
            } catch (error) {
                console.error(`Error deleting dead order ${orderId}:`, error);
                throw error;
            }
        }

        // ============================================
        // CLEAN UP DEAD ORDERS (ŸÖÿ≠ÿØÿ´ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ)
        // ============================================
        async function cleanupDeadOrders() {
            if (App.isProcessing) {
                showToast('‚ö†Ô∏è ÿ¨ÿßÿ±Ÿä ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ® ÿ≥ÿßÿ®ŸÇ...', 'warning');
                return;
            }
            
            // ÿ™ÿ£ŸÉŸäÿØ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÅŸÇÿ∑
            if (!confirm('üßπ ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ŸÜÿ∏ŸäŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖŸäÿ™ÿ©ÿü\n\n' +
                         'ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ:\n' +
                         '‚Ä¢ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿ∫Ÿäÿ± ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ© ŸÅŸä ÿßŸÑÿ≥ŸàŸÇ ŸÜŸáÿßÿ¶ŸäÿßŸã\n' +
                         '‚Ä¢ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÜÿ¥ÿ∑ÿ© ÿ∫Ÿäÿ± ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ© ŸÅŸä ÿßŸÑÿ≥ŸàŸÇ\n' +
                         '‚Ä¢ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿ™Ÿä ÿ™ÿÆÿ™ŸÑŸÅ ÿ≠ÿßŸÑÿ™Ÿáÿß ÿπŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≥ŸàŸÇ\n' +
                         '‚Ä¢ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿ™ÿßŸÑŸÅÿ© ŸÅŸä ÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ')) {
                return;
            }
            
            App.isProcessing = true;
            document.getElementById('cleanupDeadOrdersBtn').disabled = true;
            
            showProgress(true, 'ÿ¨ÿßÿ±Ÿä ŸÅÿ≠ÿµ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖŸäÿ™ÿ©...');
            
            try {
                // ÿ™ÿ¨ŸÖŸäÿπ ŸÇÿßÿ¶ŸÖÿ© ÿ®ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖŸäÿ™ÿ©
                const deadOrders = [];
                const marketOrderIds = new Set(Object.keys(App.orders));
                
                console.log('üîç ÿ®ÿØÿ° ŸÅÿ≠ÿµ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖŸäÿ™ÿ©...');
                console.log(`üìä ÿπÿØÿØ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ŸÅŸä ÿßŸÑÿ≥ŸàŸÇ: ${marketOrderIds.size}`);
                console.log(`üë• ÿπÿØÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ: ${Object.keys(App.users).length}`);
                
                for (const [userId, user] of Object.entries(App.users)) {
                    if (user.orders) {
                        for (const [orderId, userOrder] of Object.entries(user.orders)) {
                            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿ∑ŸÑÿ® ŸÅŸä ÿßŸÑÿ≥ŸàŸÇ
                            const marketOrder = App.orders[orderId];
                            
                            let isDead = false;
                            let reason = '';
                            
                            if (!marketOrder) {
                                // ÿßŸÑÿ≠ÿßŸÑÿ© 1: ÿßŸÑÿ∑ŸÑÿ® ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑÿ≥ŸàŸÇ ŸÜŸáÿßÿ¶ŸäÿßŸã
                                isDead = true;
                                reason = 'ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑÿ≥ŸàŸÇ';
                                
                                // ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÅŸä ÿßŸÑŸÉŸàŸÜÿ≥ŸàŸÑ
                                console.log(`‚ö†Ô∏è ÿ∑ŸÑÿ® ŸÖŸäÿ™: ${orderId}`, {
                                    userId,
                                    userOrder,
                                    reason
                                });
                                
                            } else {
                                // ÿßŸÑÿ∑ŸÑÿ® ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑÿ≥ŸàŸÇ - ŸÜÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ∑ÿßÿ®ŸÇ
                                if (marketOrder.status !== userOrder.status) {
                                    isDead = true;
                                    reason = `ÿ≠ÿßŸÑÿ© ŸÖÿÆÿ™ŸÑŸÅÿ© (ÿßŸÑÿ≥ŸàŸÇ: ${marketOrder.status}, ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${userOrder.status})`;
                                } else if (marketOrder.quantity !== userOrder.quantity) {
                                    isDead = true;
                                    reason = `ŸÉŸÖŸäÿ© ŸÖÿÆÿ™ŸÑŸÅÿ© (ÿßŸÑÿ≥ŸàŸÇ: ${marketOrder.quantity}, ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${userOrder.quantity})`;
                                } else if (marketOrder.remaining !== userOrder.remaining) {
                                    isDead = true;
                                    reason = `ŸÖÿ™ÿ®ŸÇŸä ŸÖÿÆÿ™ŸÑŸÅ (ÿßŸÑÿ≥ŸàŸÇ: ${marketOrder.remaining}, ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${userOrder.remaining})`;
                                } else if (marketOrder.pricePerUnit !== userOrder.pricePerUnit) {
                                    isDead = true;
                                    reason = `ÿ≥ÿπÿ± ŸÖÿÆÿ™ŸÑŸÅ (ÿßŸÑÿ≥ŸàŸÇ: ${marketOrder.pricePerUnit}, ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${userOrder.pricePerUnit})`;
                                } else if (marketOrder.type !== userOrder.type) {
                                    isDead = true;
                                    reason = `ŸÜŸàÿπ ŸÖÿÆÿ™ŸÑŸÅ (ÿßŸÑÿ≥ŸàŸÇ: ${marketOrder.type}, ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${userOrder.type})`;
                                } else if (marketOrder.resource !== userOrder.resource) {
                                    isDead = true;
                                    reason = `ŸÖŸàÿ±ÿØ ŸÖÿÆÿ™ŸÑŸÅ (ÿßŸÑÿ≥ŸàŸÇ: ${marketOrder.resource}, ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${userOrder.resource})`;
                                }
                                
                                if (isDead) {
                                    console.log(`‚ö†Ô∏è ÿ∑ŸÑÿ® ÿ∫Ÿäÿ± ŸÖÿ™ÿ∑ÿßÿ®ŸÇ: ${orderId}`, {
                                        userId,
                                        reason,
                                        marketOrder,
                                        userOrder
                                    });
                                }
                            }
                            
                            if (isDead) {
                                deadOrders.push({
                                    userId,
                                    orderId,
                                    userOrder,
                                    marketOrder,
                                    reason
                                });
                            }
                        }
                    }
                }
                
                console.log(`üìä ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖŸäÿ™ÿ©: ${deadOrders.length}`);
                
                if (deadOrders.length === 0) {
                    showToast('‚úÖ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ŸÖŸäÿ™ÿ©!', 'success');
                    App.isProcessing = false;
                    document.getElementById('cleanupDeadOrdersBtn').disabled = false;
                    showProgress(false);
                    return;
                }
                
                // ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖŸäÿ™ÿ© ŸÅŸä ÿ¨ÿØŸàŸÑ
                console.table(deadOrders.map(d => ({
                    userId: d.userId.substring(0, 8) + '...',
                    orderId: d.orderId.substring(0, 12) + '...',
                    reason: d.reason,
                    status: d.userOrder.status,
                    quantity: d.userOrder.quantity
                })));
                
                // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                document.getElementById('progressTotal').textContent = deadOrders.length;
                document.getElementById('progressCurrent').textContent = '0';
                document.getElementById('progressSuccess').textContent = '‚úÖ 0';
                document.getElementById('progressFailed').textContent = '‚ùå 0';
                
                let success = 0;
                let failed = 0;
                let failedDetails = [];
                
                // ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖŸäÿ™ÿ©
                for (let i = 0; i < deadOrders.length; i++) {
                    const { userId, orderId, reason } = deadOrders[i];
                    
                    try {
                        // ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ŸÑÿ® ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                        await database.ref(`users/${userId}/orders/${orderId}`).remove();
                        success++;
                        
                        console.log(`‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ: ${orderId} (${reason})`);
                        
                    } catch (error) {
                        console.error(`‚ùå ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ${orderId}:`, error);
                        failed++;
                        failedDetails.push({ orderId, userId, error: error.message });
                    }
                    
                    // ÿ™ÿ≠ÿØŸäÿ´ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÇÿØŸÖ
                    const progress = ((i + 1) / deadOrders.length) * 100;
                    document.getElementById('progressFill').style.width = `${progress}%`;
                    document.getElementById('progressCurrent').textContent = i + 1;
                    document.getElementById('progressSuccess').textContent = `‚úÖ ${success}`;
                    document.getElementById('progressFailed').textContent = `‚ùå ${failed}`;
                    document.getElementById('progressText').textHTML = 
                        `ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ŸÜÿ∏ŸäŸÅ... ${i + 1}/${deadOrders.length}`;
                }
                
                // ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÅÿßÿ¥ŸÑ ÿ•ŸÜ Ÿàÿ¨ÿØÿ™
                if (failed > 0) {
                    console.error('‚ùå ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿ™Ÿä ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅŸáÿß:', failedDetails);
                    showToast(`‚ö†Ô∏è ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${success} ÿ∑ŸÑÿ®ÿå ŸÅÿ¥ŸÑ ${failed} ÿ∑ŸÑÿ®`, 'warning');
                } else {
                    showToast(`‚úÖ ÿ™ŸÖ ÿ™ŸÜÿ∏ŸäŸÅ ${success} ÿ∑ŸÑÿ® ŸÖŸäÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!`, 'success');
                }
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                await loadData();
                
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ŸÜÿ∏ŸäŸÅ:', error);
                showToast('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ŸÜÿ∏ŸäŸÅ: ' + error.message, 'error');
            } finally {
                App.isProcessing = false;
                document.getElementById('cleanupDeadOrdersBtn').disabled = false;
                showProgress(false);
            }
        }

        // ============================================
        // CANCEL ALL LARGE ORDERS (ŸÖÿ≠ÿØÿ´)
        // ============================================
        async function cancelAllLargeOrders() {
            if (App.isProcessing) {
                showToast('‚ö†Ô∏è ÿ¨ÿßÿ±Ÿä ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ® ÿ≥ÿßÿ®ŸÇ...', 'warning');
                return;
            }
            
            if (App.largeOrders.length === 0) {
                showToast('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ŸÉÿ®Ÿäÿ±ÿ© ŸÑŸÑÿ•ŸÑÿ∫ÿßÿ°', 'error');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è ÿ•ŸÑÿ∫ÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÉÿ®Ÿäÿ±ÿ© (${App.largeOrders.length})ÿü\nÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖŸàÿßÿ±ÿØ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ Ÿàÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ŸÅŸä ÿ≠ÿ≥ÿßÿ®ÿßÿ™ŸáŸÖ.`)) {
                return;
            }
            
            App.isProcessing = true;
            document.getElementById('cancelAllLargeBtn').disabled = true;
            
            showProgress(true, `ÿ¨ÿßÿ±Ÿä ÿ•ŸÑÿ∫ÿßÿ° ${App.largeOrders.length} ÿ∑ŸÑÿ®...`);
            
            let success = 0;
            let failed = 0;
            
            for (let i = 0; i < App.largeOrders.length; i++) {
                const order = App.largeOrders[i];
                try {
                    await cancelOrder(order.orderId, order, true);
                    success++;
                } catch (error) {
                    console.error(`ŸÅÿ¥ŸÑ ÿ•ŸÑÿ∫ÿßÿ° ${order.orderId}:`, error);
                    failed++;
                }
                
                const progress = ((i + 1) / App.largeOrders.length) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = 
                    `${i + 1}/${App.largeOrders.length} - ŸÜÿ¨ÿßÿ≠: ${success}, ŸÅÿ¥ŸÑ: ${failed}`;
            }
            
            showProgress(false);
            showToast(`‚úÖ ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ${success} ÿ∑ŸÑÿ®ÿå ŸÅÿ¥ŸÑ: ${failed}`);
            
            App.isProcessing = false;
            document.getElementById('cancelAllLargeBtn').disabled = false;
            
            // Reload data
            await loadData();
        }

        // ============================================
        // EXPORT TO CSV
        // ============================================
        function exportToCSV() {
            const orders = App.filteredOrders;
            
            if (orders.length === 0) {
                showToast('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±', 'error');
                return;
            }
            
            const headers = ['Order ID', 'User ID', 'Type', 'Resource', 'Quantity', 'Remaining', 'Price/Unit', 'Total Value', 'Status', 'Created At'];
            const csvRows = [];
            
            csvRows.push(headers.join(','));
            
            orders.forEach(order => {
                const row = [
                    order.orderId,
                    order.userId,
                    order.type,
                    order.resource,
                    order.quantity || 0,
                    order.remaining || 0,
                    order.pricePerUnit || 0,
                    (order.quantity || 0) * (order.pricePerUnit || 0),
                    order.status,
                    new Date(order.createdAt).toISOString()
                ];
                csvRows.push(row.join(','));
            });
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `market-orders-${Date.now()}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showToast(`‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ${orders.length} ÿ∑ŸÑÿ®`);
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        function updateStats() {
            document.getElementById('totalOrders').textContent = App.stats.total;
            document.getElementById('activeOrders').textContent = App.stats.active;
            document.getElementById('largeOrders').textContent = App.stats.large;
            document.getElementById('totalVolume').textContent = formatNumber(App.stats.totalVolume);
            document.getElementById('uniqueUsers').textContent = App.stats.uniqueUsers;
        }

        function renderTable() {
            const tbody = document.getElementById('ordersTableBody');
            const orders = App.filteredOrders.slice(0, 100); // Show top 100
            
            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px;">
                            <i class="fas fa-inbox" style="font-size: 40px; margin-bottom: 10px;"></i>
                            <div>No orders found</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            orders.forEach(order => {
                const user = App.users[order.userId] || {};
                const userName = user.firstName || 'Unknown';
                const userAvatar = user.photoUrl ? 
                    `<img src="${user.photoUrl}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">` :
                    `<div class="user-avatar">${userName.charAt(0).toUpperCase()}</div>`;
                
                const isLarge = (order.quantity || 0) >= LARGE_ORDER_THRESHOLD;
                const rowClass = isLarge ? 'high-value' : '';
                
                const date = new Date(order.createdAt).toLocaleString();
                const totalValue = (order.quantity || 0) * (order.pricePerUnit || 0);
                
                const statusClass = order.status === 'active' ? 'badge-success' : 
                                   order.status === 'cancelled' ? 'badge-danger' : 'badge-info';
                
                html += `
                    <tr class="${rowClass}">
                        <td><code>${order.orderId.substring(0, 12)}...</code></td>
                        <td>
                            <div class="user-cell">
                                ${userAvatar}
                                <span>${userName}</span>
                            </div>
                        </td>
                        <td><span class="badge ${order.type === 'sell' ? 'badge-warning' : 'badge-info'}">${order.type}</span></td>
                        <td>${order.resource === 'milk' ? 'ü•õ Milk' : 'ü•ö Eggs'}</td>
                        <td><span class="metric-highlight">${formatNumber(order.quantity)}</span></td>
                        <td>${formatNumber(order.remaining)}</td>
                        <td>${formatTON(order.pricePerUnit)} TON</td>
                        <td>${formatTON(totalValue)} TON</td>
                        <td><span class="badge ${statusClass}">${order.status}</span></td>
                        <td>${date}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn view" onclick="showOrderDetails('${order.orderId}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${order.status === 'active' ? `
                                    <button class="action-btn cancel" onclick="promptCancelOrder('${order.orderId}')">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function updateSummaryCards() {
            // Top 10 Largest Orders
            const topList = document.getElementById('topOrdersList');
            if (App.largeOrders.length > 0) {
                let html = '';
                App.largeOrders.slice(0, 10).forEach(order => {
                    const user = App.users[order.userId] || {};
                    const userName = user.firstName || 'Unknown';
                    html += `
                        <div class="summary-item">
                            <span>${userName}</span>
                            <span class="badge badge-danger">${formatNumber(order.quantity)} ${order.resource}</span>
                        </div>
                    `;
                });
                topList.innerHTML = html;
            } else {
                topList.innerHTML = '<div style="text-align: center; padding: 20px;">No large orders</div>';
            }
            
            // Top Users by Volume
            const userVolumes = {};
            for (const order of App.largeOrders) {
                if (!userVolumes[order.userId]) {
                    userVolumes[order.userId] = 0;
                }
                userVolumes[order.userId] += order.quantity || 0;
            }
            
            const topUsers = Object.entries(userVolumes)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const usersList = document.getElementById('topUsersList');
            if (topUsers.length > 0) {
                let html = '';
                topUsers.forEach(([userId, volume]) => {
                    const user = App.users[userId] || {};
                    const userName = user.firstName || 'Unknown';
                    html += `
                        <div class="summary-item">
                            <span>${userName}</span>
                            <span class="badge badge-warning">${formatNumber(volume)} total</span>
                        </div>
                    `;
                });
                usersList.innerHTML = html;
            } else {
                usersList.innerHTML = '<div style="text-align: center; padding: 20px;">No data</div>';
            }
            
            // Recent Large Orders
            const recentList = document.getElementById('recentOrdersList');
            const recent = [...App.largeOrders]
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
                .slice(0, 10);
            
            if (recent.length > 0) {
                let html = '';
                recent.forEach(order => {
                    const user = App.users[order.userId] || {};
                    const userName = user.firstName || 'Unknown';
                    const date = new Date(order.createdAt).toLocaleDateString();
                    html += `
                        <div class="summary-item">
                            <span>${userName}</span>
                            <span class="badge badge-info">${date}</span>
                        </div>
                    `;
                });
                recentList.innerHTML = html;
            } else {
                recentList.innerHTML = '<div style="text-align: center; padding: 20px;">No recent orders</div>';
            }
        }

        function updateCharts() {
            // Resource Chart
            const resourceCtx = document.getElementById('resourceChart').getContext('2d');
            if (App.charts.resource) App.charts.resource.destroy();
            
            App.charts.resource = new Chart(resourceCtx, {
                type: 'pie',
                data: {
                    labels: ['Milk', 'Eggs'],
                    datasets: [{
                        data: [App.stats.milkVolume, App.stats.eggsVolume],
                        backgroundColor: ['#FF5CA8', '#00D4FF'],
                        borderWidth: 0
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    }
                }
            });
            
            // Status Chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            if (App.charts.status) App.charts.status.destroy();
            
            App.charts.status = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Active', 'Cancelled', 'Filled'],
                    datasets: [{
                        data: [App.stats.active, App.stats.cancelled, App.stats.filled],
                        backgroundColor: ['#00F27A', '#FF4B5C', '#FFD700'],
                        borderWidth: 0
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    }
                }
            });
            
            // Trend Chart (last 7 days)
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            if (App.charts.trend) App.charts.trend.destroy();
            
            const last7Days = [];
            const volumes = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                
                const nextDate = new Date(date);
                nextDate.setDate(nextDate.getDate() + 1);
                
                let volume = 0;
                for (const order of App.largeOrders) {
                    if (order.createdAt >= date.getTime() && order.createdAt < nextDate.getTime()) {
                        volume += order.quantity || 0;
                    }
                }
                
                last7Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                volumes.push(volume);
            }
            
            App.charts.trend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Daily Volume',
                        data: volumes,
                        borderColor: '#FFD700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    scales: {
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: 'white' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'white' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        window.showOrderDetails = function(orderId) {
            const order = App.orders[orderId];
            const user = App.users[order.userId] || {};
            
            if (!order) return;
            
            const modal = document.getElementById('orderModal');
            const details = document.getElementById('orderDetails');
            
            const date = new Date(order.createdAt).toLocaleString();
            const totalValue = (order.quantity || 0) * (order.pricePerUnit || 0);
            
            details.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Order ID:</span>
                    <span class="detail-value"><code>${orderId}</code></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">User:</span>
                    <span class="detail-value">${user.firstName || 'Unknown'} (${order.userId})</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Type:</span>
                    <span class="detail-value">${order.type}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Resource:</span>
                    <span class="detail-value">${order.resource === 'milk' ? 'ü•õ Milk' : 'ü•ö Eggs'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Quantity:</span>
                    <span class="detail-value ${(order.quantity || 0) >= LARGE_ORDER_THRESHOLD ? 'high' : ''}">${formatNumber(order.quantity)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Remaining:</span>
                    <span class="detail-value">${formatNumber(order.remaining)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Price per Unit:</span>
                    <span class="detail-value">${formatTON(order.pricePerUnit)} TON</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Total Value:</span>
                    <span class="detail-value">${formatTON(totalValue)} TON</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value">${order.status}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Created:</span>
                    <span class="detail-value">${date}</span>
                </div>
            `;
            
            document.getElementById('cancelOrderBtn').style.display = order.status === 'active' ? 'block' : 'none';
            App.pendingOrder = { orderId, order };
            
            modal.classList.add('active');
        };

        window.promptCancelOrder = function(orderId) {
            const order = App.orders[orderId];
            if (!order) return;
            
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmText').innerHTML = 'Cancel this order?';
            document.getElementById('confirmDetails').innerHTML = 
                `Order: ${orderId.substring(0, 12)}...<br>
                Quantity: ${formatNumber(order.quantity)} ${order.resource}<br>
                User: ${order.userId.substring(0, 8)}...`;
            
            App.pendingOrder = { orderId, order };
            modal.classList.add('active');
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function formatTON(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) return '0.0000';
            return parseFloat(amount).toFixed(4);
        }

        function showProgress(show, text = 'Processing...') {
            const container = document.getElementById('progressContainer');
            if (show) {
                container.style.display = 'block';
                document.getElementById('progressText').textContent = text;
            } else {
                container.style.display = 'none';
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('refreshBtn').addEventListener('click', loadData);
        document.getElementById('scanLargeBtn').addEventListener('click', () => {
            App.filters.type = 'large';
            document.getElementById('filterType').value = 'large';
            filterOrders();
            renderTable();
        });
        
        document.getElementById('cancelAllLargeBtn').addEventListener('click', cancelAllLargeOrders);
        document.getElementById('exportBtn').addEventListener('click', exportToCSV);
        document.getElementById('cleanupDeadOrdersBtn').addEventListener('click', cleanupDeadOrders);

        // Filter controls
        document.getElementById('filterType').addEventListener('change', (e) => {
            App.filters.type = e.target.value;
            filterOrders();
            renderTable();
        });

        document.getElementById('filterResource').addEventListener('change', (e) => {
            App.filters.resource = e.target.value;
            filterOrders();
            renderTable();
        });

        document.getElementById('minQuantity').addEventListener('change', (e) => {
            App.filters.minQuantity = parseInt(e.target.value) || LARGE_ORDER_THRESHOLD;
            filterOrders();
            renderTable();
        });

        document.getElementById('sortBy').addEventListener('change', (e) => {
            App.filters.sortBy = e.target.value;
            filterOrders();
            renderTable();
        });

        // Modal controls
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('orderModal').classList.remove('active');
        });

        document.getElementById('closeModalBtn').addEventListener('click', () => {
            document.getElementById('orderModal').classList.remove('active');
        });

        document.getElementById('closeConfirmModal').addEventListener('click', () => {
            document.getElementById('confirmModal').classList.remove('active');
        });

        document.getElementById('cancelConfirmBtn').addEventListener('click', () => {
            document.getElementById('confirmModal').classList.remove('active');
        });

        document.getElementById('cancelOrderBtn').addEventListener('click', async () => {
            if (App.pendingOrder) {
                await cancelOrder(App.pendingOrder.orderId, App.pendingOrder.order, true);
                document.getElementById('orderModal').classList.remove('active');
                await loadData();
            }
        });

        document.getElementById('confirmCancelBtn').addEventListener('click', async () => {
            if (App.pendingOrder) {
                await cancelOrder(App.pendingOrder.orderId, App.pendingOrder.order, true);
                document.getElementById('confirmModal').classList.remove('active');
                await loadData();
            }
        });

        window.addEventListener('click', (e) => {
            const orderModal = document.getElementById('orderModal');
            if (e.target === orderModal) {
                orderModal.classList.remove('active');
            }
            
            const confirmModal = document.getElementById('confirmModal');
            if (e.target === confirmModal) {
                confirmModal.classList.remove('active');
            }
        });

        // Initialize
        loadData();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crystal Ranch ¬∑ Delete Orphaned Orders</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            border: 1px solid rgba(255, 92, 168, 0.3);
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header h1 i {
            color: #FF5CA8;
        }
        
        .header h1 span {
            background: rgba(255, 75, 92, 0.2);
            color: #FF4B5C;
            padding: 5px 20px;
            border-radius: 30px;
            font-size: 16px;
            margin-left: 10px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .stat-title {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #FFD700;
        }
        
        .stat-sub {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
        }
        
        /* Control Panel */
        .control-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #FF4B5C;
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #FF4B5C;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .user-input {
            flex: 1;
            min-width: 300px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #FFD700;
            border-radius: 12px;
            padding: 15px 20px;
            color: white;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
        }
        
        .user-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }
        
        .btn {
            padding: 15px 30px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }
        
        .btn-danger {
            background: linear-gradient(145deg, #FF4B5C, #d63f4f);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 75, 92, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(145deg, #FFD700, #FFA500);
            color: black;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }
        
        .btn-primary {
            background: linear-gradient(145deg, #FF5CA8, #D94A8F);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 92, 168, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(145deg, #00F27A, #00b35e);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 242, 122, 0.4);
        }
        
        .btn:hover {
            transform: scale(1.02);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Info Box */
        .info-box {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .info-title {
            color: #FFD700;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Progress */
        .progress-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FF5CA8);
            transition: width 0.3s;
        }
        
        /* Table */
        .table-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            overflow: auto;
            margin: 20px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px 10px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #FFD700;
            text-transform: uppercase;
            border-bottom: 2px solid #FFD700;
        }
        
        td {
            padding: 15px 10px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            font-size: 13px;
        }
        
        tr.orphaned {
            background: rgba(255, 75, 92, 0.1);
            border-left: 3px solid #FF4B5C;
        }
        
        tr:hover {
            background: rgba(255, 215, 0, 0.05);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .badge-danger {
            background: rgba(255, 75, 92, 0.2);
            color: #FF4B5C;
            border: 1px solid rgba(255, 75, 92, 0.3);
        }
        
        .action-btn {
            padding: 6px 12px;
            border-radius: 8px;
            border: none;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255, 75, 92, 0.2);
            color: #FF4B5C;
            border: 1px solid rgba(255, 75, 92, 0.3);
        }
        
        .action-btn:hover {
            background: rgba(255, 75, 92, 0.4);
        }
        
        /* Log */
        .log-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .log-entry.success {
            color: #00F27A;
        }
        
        .log-entry.error {
            color: #FF4B5C;
        }
        
        .log-entry.warning {
            color: #FFD700;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .loading i {
            font-size: 40px;
            margin-bottom: 15px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* User Summary */
        .user-summary {
            background: rgba(255, 215, 0, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .user-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .user-label {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .user-value {
            font-weight: 600;
            color: #FFD700;
        }
        
        .user-value.highlight {
            color: #FF4B5C;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-trash-alt"></i>
                Delete Orphaned Orders
                <span>Fix My Orders</span>
            </h1>
        </div>
        
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">Total Users</div>
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-sub">in database</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Main Orders</div>
                <div class="stat-value" id="mainOrders">0</div>
                <div class="stat-sub">in /orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">User Orders</div>
                <div class="stat-value" id="userOrders">0</div>
                <div class="stat-sub">in /users/*/orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Orphaned Orders</div>
                <div class="stat-value" id="orphanedCount">0</div>
                <div class="stat-sub">need deletion</div>
            </div>
        </div>
        
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="panel-title">
                <i class="fas fa-exclamation-triangle"></i>
                Fix Specific User
            </div>
            
            <div class="user-input-group">
                <input type="text" class="user-input" id="userIdInput" placeholder="Enter User ID (e.g., 6970148965)" value="6970148965">
                <button class="btn btn-primary" id="loadUserBtn">
                    <i class="fas fa-search"></i> Load User
                </button>
            </div>
            
            <div class="info-box" id="userInfoBox" style="display: none;">
                <div class="info-title">
                    <i class="fas fa-user"></i>
                    User Information
                </div>
                <div id="userDetails"></div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
                <button class="btn btn-danger" id="scanOrphanedBtn">
                    <i class="fas fa-search"></i> Scan All Users
                </button>
                <button class="btn btn-warning" id="deleteAllOrphanedBtn" disabled>
                    <i class="fas fa-trash"></i> Delete All Orphaned Orders
                </button>
                <button class="btn btn-success" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh Stats
                </button>
            </div>
        </div>
        
        <!-- Progress -->
        <div class="progress-container" id="progressContainer" style="display: none;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span><i class="fas fa-spinner fa-spin"></i> <span id="progressMessage">Processing...</span></span>
                <span id="progressPercentage">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <div class="progress-stats" style="display: flex; justify-content: space-between; margin-top: 10px;">
                <span id="progressCurrent">0</span> / <span id="progressTotal">0</span> operations
            </div>
        </div>
        
        <!-- Orphaned Orders Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>User ID</th>
                        <th>Resource</th>
                        <th>Quantity</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="orphanedTableBody">
                    <tr>
                        <td colspan="7" class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <div>Click "Scan All Users" to find orphaned orders</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Log -->
        <div class="log-container" id="logContainer">
            <div class="log-entry">Ready to fix orphaned orders...</div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC5dwRaz3L-aK7I5CoPkbB31MzXB62lgrU",
            authDomain: "earnmoney124553.firebaseapp.com",
            databaseURL: "https://earnmoney124553-default-rtdb.firebaseio.com",
            projectId: "earnmoney124553",
            storageBucket: "earnmoney124553.firebasestorage.app",
            messagingSenderId: "325528918523",
            appId: "1:325528918523:web:73d84f48a24c1e0cbfd35e",
            measurementId: "G-G1H96Q5XCJ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ============================================
        // STATE
        // ============================================
        let App = {
            mainOrders: {},
            users: {},
            userOrders: {},
            orphanedOrders: [],
            
            stats: {
                totalUsers: 0,
                mainCount: 0,
                userCount: 0,
                orphanedCount: 0
            },
            
            currentUser: null,
            logs: []
        };

        // ============================================
        // LOGGING
        // ============================================
        function addLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString('en-US', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const logEntry = `[${time}] ${message}`;
            App.logs.unshift(logEntry);
            if (App.logs.length > 50) App.logs.pop();
            
            renderLogs();
            console.log(`${type.toUpperCase()}: ${message}`);
        }

        function renderLogs() {
            const container = document.getElementById('logContainer');
            let html = '';
            
            App.logs.forEach(log => {
                let typeClass = 'info';
                if (log.includes('‚úÖ')) typeClass = 'success';
                else if (log.includes('‚ùå')) typeClass = 'error';
                else if (log.includes('‚ö†Ô∏è')) typeClass = 'warning';
                else if (log.includes('üóëÔ∏è')) typeClass = 'warning';
                
                html += `<div class="log-entry ${typeClass}">${log}</div>`;
            });
            
            container.innerHTML = html;
        }

        // ============================================
        // PROGRESS
        // ============================================
        function showProgress(show, message = 'Processing...', total = 0) {
            const container = document.getElementById('progressContainer');
            if (show) {
                container.style.display = 'block';
                document.getElementById('progressMessage').textContent = message;
                document.getElementById('progressPercentage').textContent = '0%';
                document.getElementById('progressCurrent').textContent = '0';
                document.getElementById('progressTotal').textContent = total || '?';
                document.getElementById('progressFill').style.width = '0%';
            } else {
                container.style.display = 'none';
            }
        }

        function updateProgress(current, total) {
            const percentage = (current / total) * 100;
            document.getElementById('progressFill').style.width = `${percentage}%`;
            document.getElementById('progressPercentage').textContent = `${Math.round(percentage)}%`;
            document.getElementById('progressCurrent').textContent = current;
        }

        // ============================================
        // LOAD DATA
        // ============================================
        async function loadData() {
            addLog('üì• Loading data from Firebase...');
            
            try {
                // Load main orders
                const mainSnapshot = await database.ref('orders').once('value');
                App.mainOrders = mainSnapshot.val() || {};
                App.stats.mainCount = Object.keys(App.mainOrders).length;
                
                // Load all users
                const usersSnapshot = await database.ref('users').once('value');
                App.users = usersSnapshot.val() || {};
                App.stats.totalUsers = Object.keys(App.users).length;
                
                // Load user orders
                App.userOrders = {};
                let userOrderCount = 0;
                
                for (const userId of Object.keys(App.users)) {
                    const ordersSnapshot = await database.ref(`users/${userId}/orders`).once('value');
                    const orders = ordersSnapshot.val();
                    if (orders && Object.keys(orders).length > 0) {
                        App.userOrders[userId] = orders;
                        userOrderCount += Object.keys(orders).length;
                    }
                }
                
                App.stats.userCount = userOrderCount;
                
                updateStats();
                addLog(`‚úÖ Loaded ${App.stats.mainCount} main orders, ${App.stats.userCount} user orders`);
                
            } catch (error) {
                console.error('Error loading data:', error);
                addLog(`‚ùå Error loading data: ${error.message}`, 'error');
            }
        }

        // ============================================
        // SCAN FOR ORPHANED ORDERS
        // ============================================
        async function scanOrphaned() {
            addLog('üîç Scanning for orphaned orders...');
            showProgress(true, 'Scanning for orphaned orders...', 1);
            
            App.orphanedOrders = [];
            
            // Check each user's orders
            for (const [userId, orders] of Object.entries(App.userOrders)) {
                for (const [orderId, userOrder] of Object.entries(orders)) {
                    const mainOrder = App.mainOrders[orderId];
                    
                    // If order doesn't exist in main orders, it's orphaned
                    if (!mainOrder) {
                        App.orphanedOrders.push({
                            orderId: orderId,
                            userId: userId,
                            order: userOrder
                        });
                    }
                }
            }
            
            App.stats.orphanedCount = App.orphanedOrders.length;
            updateStats();
            renderOrphanedTable();
            
            document.getElementById('deleteAllOrphanedBtn').disabled = App.orphanedOrders.length === 0;
            
            showProgress(false);
            
            if (App.orphanedOrders.length === 0) {
                addLog('‚úÖ No orphaned orders found!', 'success');
            } else {
                addLog(`‚ö†Ô∏è Found ${App.orphanedOrders.length} orphaned orders`, 'warning');
            }
        }

        // ============================================
        // LOAD SPECIFIC USER
        // ============================================
        async function loadUser(userId) {
            addLog(`üîç Loading user: ${userId}`);
            showProgress(true, `Loading user ${userId}...`, 1);
            
            try {
                // Load user data
                const userSnapshot = await database.ref(`users/${userId}`).once('value');
                const userData = userSnapshot.val();
                
                if (!userData) {
                    addLog(`‚ùå User ${userId} not found`, 'error');
                    showProgress(false);
                    return;
                }
                
                App.currentUser = {
                    id: userId,
                    data: userData
                };
                
                // Load user's orders
                const ordersSnapshot = await database.ref(`users/${userId}/orders`).once('value');
                const userOrders = ordersSnapshot.val() || {};
                
                // Find orphaned orders for this user
                const userOrphaned = [];
                for (const [orderId, order] of Object.entries(userOrders)) {
                    if (!App.mainOrders[orderId]) {
                        userOrphaned.push({
                            orderId: orderId,
                            order: order
                        });
                    }
                }
                
                // Display user info
                const infoBox = document.getElementById('userInfoBox');
                const details = document.getElementById('userDetails');
                
                let orphanedHtml = '';
                if (userOrphaned.length > 0) {
                    orphanedHtml = `<div style="margin-top: 10px; color: #FF4B5C;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Has ${userOrphaned.length} orphaned order(s) in My Orders
                    </div>`;
                }
                
                details.innerHTML = `
                    <div class="user-detail">
                        <span class="user-label">User ID:</span>
                        <span class="user-value">${userId}</span>
                    </div>
                    <div class="user-detail">
                        <span class="user-label">Name:</span>
                        <span class="user-value">${userData.firstName || 'Unknown'}</span>
                    </div>
                    <div class="user-detail">
                        <span class="user-label">Milk:</span>
                        <span class="user-value ${userData.milk > 10000 ? 'highlight' : ''}">${formatNumber(userData.milk || 0)}</span>
                    </div>
                    <div class="user-detail">
                        <span class="user-label">TON Balance:</span>
                        <span class="user-value">${formatTON(userData.tonBalance || 0)}</span>
                    </div>
                    <div class="user-detail">
                        <span class="user-label">Cows Owned:</span>
                        <span class="user-value">${userData.cows_owned || 0}</span>
                    </div>
                    <div class="user-detail">
                        <span class="user-label">Total Orders:</span>
                        <span class="user-value">${Object.keys(userOrders).length}</span>
                    </div>
                    <div class="user-detail">
                        <span class="user-label">Orphaned Orders:</span>
                        <span class="user-value highlight">${userOrphaned.length}</span>
                    </div>
                    ${orphanedHtml}
                `;
                
                infoBox.style.display = 'block';
                
                // Show user's orphaned orders in table
                if (userOrphaned.length > 0) {
                    renderOrphanedTable(userOrphaned, userId);
                } else {
                    addLog(`‚úÖ User ${userId} has no orphaned orders`, 'success');
                }
                
            } catch (error) {
                console.error('Error loading user:', error);
                addLog(`‚ùå Error loading user: ${error.message}`, 'error');
            } finally {
                showProgress(false);
            }
        }

        // ============================================
        // DELETE ORPHANED ORDER
        // ============================================
        async function deleteOrphanedOrder(orderId, userId) {
            try {
                addLog(`üóëÔ∏è Deleting orphaned order ${orderId.substring(0, 8)}... from user ${userId}`, 'warning');
                
                // Delete from user's orders
                await database.ref(`users/${userId}/orders/${orderId}`).remove();
                
                addLog(`‚úÖ Successfully deleted order ${orderId.substring(0, 8)}...`, 'success');
                
                // Remove from list
                App.orphanedOrders = App.orphanedOrders.filter(o => 
                    !(o.orderId === orderId && o.userId === userId));
                
                App.stats.orphanedCount = App.orphanedOrders.length;
                updateStats();
                renderOrphanedTable();
                
                document.getElementById('deleteAllOrphanedBtn').disabled = App.orphanedOrders.length === 0;
                
                return true;
                
            } catch (error) {
                console.error('Delete error:', error);
                addLog(`‚ùå Error deleting order: ${error.message}`, 'error');
                return false;
            }
        }

        // ============================================
        // DELETE ALL ORPHANED ORDERS
        // ============================================
        async function deleteAllOrphaned() {
            if (App.orphanedOrders.length === 0) {
                addLog('‚ö†Ô∏è No orphaned orders to delete', 'warning');
                return;
            }
            
            if (!confirm(`Delete all ${App.orphanedOrders.length} orphaned orders from user profiles?\n\nThis will fix the "My Orders" section for affected users.`)) {
                return;
            }
            
            showProgress(true, 'Deleting orphaned orders...', App.orphanedOrders.length);
            
            let deleted = 0;
            let failed = 0;
            
            for (let i = 0; i < App.orphanedOrders.length; i++) {
                const orphan = App.orphanedOrders[i];
                try {
                    await database.ref(`users/${orphan.userId}/orders/${orphan.orderId}`).remove();
                    deleted++;
                    addLog(`‚úÖ Deleted ${orphan.orderId.substring(0, 8)}...`, 'success');
                } catch (error) {
                    console.error('Delete error:', error);
                    failed++;
                }
                
                updateProgress(i + 1, App.orphanedOrders.length);
            }
            
            showProgress(false);
            addLog(`‚úÖ Deleted ${deleted} orphaned orders, Failed: ${failed}`, 'success');
            
            // Refresh data
            await loadData();
            await scanOrphaned();
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        function updateStats() {
            document.getElementById('totalUsers').textContent = App.stats.totalUsers;
            document.getElementById('mainOrders').textContent = App.stats.mainCount;
            document.getElementById('userOrders').textContent = App.stats.userCount;
            document.getElementById('orphanedCount').textContent = App.stats.orphanedCount;
        }

        function renderOrphanedTable(orders = null, highlightUserId = null) {
            const tbody = document.getElementById('orphanedTableBody');
            const ordersToShow = orders || App.orphanedOrders;
            
            if (ordersToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="loading">
                            <i class="fas fa-check-circle" style="color: #00F27A;"></i>
                            <div>No orphaned orders found!</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            ordersToShow.forEach(orphan => {
                const order = orphan.order;
                const date = order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'Unknown';
                const isHighlighted = orphan.userId === highlightUserId;
                
                html += `
                    <tr class="orphaned" ${isHighlighted ? 'style="background: rgba(255, 215, 0, 0.2);"' : ''}>
                        <td><code>${orphan.orderId.substring(0, 12)}...</code></td>
                        <td><code>${orphan.userId.substring(0, 8)}...</code></td>
                        <td>${order.resource === 'milk' ? 'ü•õ Milk' : 'ü•ö Eggs'}</td>
                        <td>${formatNumber(order.quantity || 0)}</td>
                        <td><span class="badge badge-danger">${order.status || 'unknown'}</span></td>
                        <td>${date}</td>
                        <td>
                            <button class="action-btn" onclick="deleteSingleOrder('${orphan.orderId}', '${orphan.userId}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function formatTON(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) return '0.0000';
            return parseFloat(amount).toFixed(4);
        }

        // ============================================
        // GLOBAL FUNCTIONS
        // ============================================
        window.deleteSingleOrder = async function(orderId, userId) {
            if (confirm(`Delete orphaned order ${orderId.substring(0, 12)}...?`)) {
                await deleteOrphanedOrder(orderId, userId);
            }
        };

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('loadUserBtn').addEventListener('click', async () => {
            const userId = document.getElementById('userIdInput').value.trim();
            if (userId) {
                await loadUser(userId);
            }
        });

        document.getElementById('scanOrphanedBtn').addEventListener('click', async () => {
            await loadData();
            await scanOrphaned();
        });

        document.getElementById('deleteAllOrphanedBtn').addEventListener('click', deleteAllOrphaned);

        document.getElementById('refreshBtn').addEventListener('click', async () => {
            await loadData();
        });

        // Enter key in input
        document.getElementById('userIdInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('loadUserBtn').click();
            }
        });

        // Initialize
        window.onload = async () => {
            addLog('üóëÔ∏è Orphaned Orders Deleter initialized');
            await loadData();
        };
    </script>
</body>
</html>

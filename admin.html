<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم TON Rewards - الإصدار المتقدم</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <style>
        :root {
            --primary: #2980B9; --secondary: #2C3E50; --light: #ECF0F1; --dark: #34495E;
            --success: #27AE60; --danger: #C0392B; --surface: #FFFFFF;
            --warning: #F39C12; --info: #3498DB; --purple: #8E44AD;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--light); direction: rtl; }
        
        /* Login Page */
        #login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        .login-card {
            background-color: var(--surface);
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
        }
        .login-card h2 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--secondary);
        }
        .login-card .form-group {
            margin-bottom: 20px;
        }
        .login-card label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        .login-card input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Tajawal', sans-serif;
            transition: border 0.3s;
        }
        .login-card input:focus {
            border-color: var(--primary);
            outline: none;
        }
        .login-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            font-family: 'Tajawal', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .login-btn:hover {
            background-color: #2471A3;
        }
        .error-message {
            color: var(--danger);
            text-align: center;
            margin-top: 15px;
            display: none;
        }
        
        /* Admin Panel Layout */
        #app-container { display: none; }
        #top-bar {
            background-color: var(--secondary); color: white; padding: 0 15px;
            display: flex; align-items: center; justify-content: space-between; height: 60px;
            position: sticky; top: 0; z-index: 1000;
        }
        #menu-toggle { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        #page-title { font-size: 1.2rem; }
        #logout-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1rem; }

        /* Sidebar */
        #sidebar {
            position: fixed; top: 0; right: 0; width: 280px; height: 100vh;
            background-color: var(--secondary); color: white; z-index: 2000;
            transform: translateX(100%); transition: transform 0.3s ease-in-out;
            display: flex; flex-direction: column; overflow-y: auto;
        }
        #sidebar.open { transform: translateX(0); }
        #sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        #sidebar-header .close-btn { position: absolute; top: 15px; left: 20px; font-size: 1.8rem; cursor: pointer; }
        .nav-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .nav-menu li { padding: 15px 20px; cursor: pointer; border-right: 4px solid transparent; transition: all 0.2s; display: flex; align-items: center; }
        .nav-menu li:hover, .nav-menu li.active { background-color: var(--dark); border-right-color: var(--primary); }
        .nav-menu li i { margin-left: 12px; width: 20px; text-align: center; }
        .nav-submenu { list-style: none; padding: 0; margin: 0; background: rgba(0,0,0,0.2); display: none; }
        .nav-submenu li { padding: 12px 20px 12px 40px; font-size: 0.9rem; }
        .nav-submenu.active { display: block; }
        #sidebar-logout-btn { margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1); }

        /* Overlay */
        #overlay {
            position: fixed; top: 0; right: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 1999; display: none;
        }
        #overlay.show { display: block; }
        
        /* Main Content */
        #main-content { padding: 20px; }
        .page { display: none; } 
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Cards */
        .card { background-color: var(--surface); border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 20px; }
        h1, h2, h3, h4 { color: var(--secondary); margin-bottom: 15px; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        thead { display: none; }
        tr { display: block; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; padding: 10px; }
        td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        td:last-child { border-bottom: none; }
        td::before { content: attr(data-label); font-weight: bold; margin-left: 10px; }
        .action-buttons { text-align: left; width: 100%; display: flex; flex-wrap: wrap; gap: 5px; }
        .action-btn { padding: 8px 12px; border: none; border-radius: 5px; color: white; cursor: pointer; font-family: 'Tajawal', sans-serif; font-size: 0.85rem; }
        
        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; text-align: right; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; 
            box-sizing: border-box; font-family: 'Tajawal', sans-serif; 
        }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-row .form-group { flex: 1; margin-bottom: 0; }
        
        /* Buttons */
        .btn-success { background-color: var(--success); } 
        .btn-danger { background-color: var(--danger); } 
        .btn-primary { background-color: var(--primary); } 
        .btn-warning { background-color: var(--warning); }
        .btn-info { background-color: var(--info); }
        .btn-purple { background-color: var(--purple); }
        
        /* Code Type Badges */
        .code-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 8px; }
        .code-type-contest { background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid #ffc107; }
        .code-type-ton { background: rgba(33, 150, 243, 0.2); color: #2196f3; border: 1px solid #2196f3; }
        .code-type-rr { background: rgba(76, 175, 80, 0.2); color: #4caf50; border: 1px solid #4caf50; }
        
        /* Task Type Badges */
        .task-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .task-type-channel { background: rgba(33, 150, 243, 0.2); color: #2196f3; border: 1px solid #2196f3; }
        .task-type-bot { background: rgba(156, 39, 176, 0.2); color: #9c27b0; border: 1px solid #9c27b0; }
        .task-type-custom { background: rgba(255, 152, 0, 0.2); color: #ff9800; border: 1px solid #ff9800; }
        
        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { background-color: var(--surface); border-radius: 8px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-value { font-size: 2rem; font-weight: bold; margin: 10px 0; }
        .stat-label { color: var(--dark); font-size: 0.9rem; }
        
        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 15px; overflow-x: auto; }
        .tab { padding: 10px 15px; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
        .tab.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: bold; }
        
        /* Image Preview */
        .image-preview { max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 10px; display: none; }
        .image-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); display: none; justify-content: center; 
            align-items: center; z-index: 3000; 
        }
        .image-modal img { max-width: 90%; max-height: 90%; border-radius: 8px; }
        .image-modal .close { 
            position: absolute; top: 20px; right: 20px; color: white; 
            font-size: 2rem; cursor: pointer; 
        }
        
        /* Status Badges */
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .status-pending { background: rgba(255, 152, 0, 0.2); color: #ff9800; border: 1px solid #ff9800; }
        .status-approved { background: rgba(76, 175, 80, 0.2); color: #4caf50; border: 1px solid #4caf50; }
        .status-rejected { background: rgba(244, 67, 54, 0.2); color: #f44336; border: 1px solid #f44336; }
        .status-active { background: rgba(76, 175, 80, 0.2); color: #4caf50; border: 1px solid #4caf50; }
        .status-inactive { background: rgba(158, 158, 158, 0.2); color: #9e9e9e; border: 1px solid #9e9e9e; }
        
        /* Search and Filter */
        .search-box { margin-bottom: 20px; }
        .search-box input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .filter-bar select, .filter-bar input { padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; }
        
        @media (min-width: 768px) {
            #app-container { display: flex; }
            #top-bar { display: none; }
            #sidebar { position: static; transform: translateX(0); width: 280px; height: 100vh; }
            #sidebar-header .close-btn { display: none; }
            #main-content { flex-grow: 1; padding: 30px; }
            thead { display: table-header-group; }
            tr { display: table-row; margin-bottom: 0; border: none; padding: 0; }
            td { display: table-cell; padding: 12px; border-bottom: 1px solid #ddd; }
            td::before { display: none; }
            .action-buttons { text-align: right; justify-content: flex-end; }
            .stats-grid { grid-template-columns: repeat(4, 1fr); }
            .form-row { flex-direction: row; }
        }
        
        @media (max-width: 767px) {
            .form-row { flex-direction: column; }
            .action-buttons { justify-content: center; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page">
        <div class="login-card">
            <h2><i class="fas fa-shield-alt"></i> تسجيل الدخول للإدارة</h2>
            <div class="form-group">
                <label for="username">اسم المستخدم</label>
                <input type="text" id="username" placeholder="أدخل اسم المستخدم">
            </div>
            <div class="form-group">
                <label for="password">كلمة المرور</label>
                <input type="password" id="password" placeholder="أدخل كلمة المرور">
            </div>
            <button class="login-btn" id="login-button">تسجيل الدخول</button>
            <div class="error-message" id="login-error">اسم المستخدم أو كلمة المرور غير صحيحة</div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="app-container">
        <aside id="sidebar">
            <div>
                <div id="sidebar-header">
                    <h2><i class="fas fa-shield-alt"></i> لوحة التحكم</h2>
                    <span class="close-btn">&times;</span>
                </div>
                <ul class="nav-menu">
                    <li data-page="dashboard" class="active">
                        <i class="fas fa-tachometer-alt"></i> لوحة التحكم
                    </li>
                    <li data-page="users">
                        <i class="fas fa-users"></i> إدارة المستخدمين
                    </li>
                    <li data-page="user-search">
                        <i class="fas fa-search"></i> البحث عن مستخدم
                    </li>
                    <li data-page="withdrawals">
                        <i class="fas fa-wallet"></i> طلبات السحب المعلقة
                    </li>
                    <li data-page="history">
                        <i class="fas fa-history"></i> سجل السحوبات
                    </li>
                    
                    <!-- قسم إدارة الأكواد المتقدمة -->
                    <li class="has-submenu">
                        <i class="fas fa-ticket-alt"></i> إدارة الأكواد
                        <i class="fas fa-chevron-down" style="margin-right: auto; font-size: 0.8rem;"></i>
                    </li>
                    <ul class="nav-submenu">
                        <li data-page="codes-all">جميع الأكواد</li>
                        <li data-page="codes-create">إنشاء كود جديد</li>
                        <li data-page="codes-stats">إحصائيات الأكواد</li>
                    </ul>
                    
                    <!-- قسم إدارة المهام المتقدمة -->
                    <li class="has-submenu">
                        <i class="fas fa-tasks"></i> إدارة المهام
                        <i class="fas fa-chevron-down" style="margin-right: auto; font-size: 0.8rem;"></i>
                    </li>
                    <ul class="nav-submenu">
                        <li data-page="tasks-all">جميع المهام</li>
                        <li data-page="tasks-create">إنشاء مهمة جديدة</li>
                        <li data-page="tasks-stats">إحصائيات المهام</li>
                    </ul>
                    
                    <!-- قسم مراجعة طلبات البوت -->
                    <li data-page="bot-requests">
                        <i class="fas fa-robot"></i> طلبات البوت
                        <span class="notification-badge" id="bot-requests-badge" style="display: none;">0</span>
                    </li>
                    
                    <li data-page="contest">
                        <i class="fas fa-trophy"></i> إدارة المسابقة
                    </li>
                    <li data-page="settings">
                        <i class="fas fa-cog"></i> إعدادات التطبيق
                    </li>
                    <li data-page="broadcast">
                        <i class="fas fa-bullhorn"></i> البث الجماعي
                    </li>
                </ul>
            </div>
            <button id="sidebar-logout-btn" class="nav-menu">
                <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
            </button>
        </aside>
        
        <div id="overlay"></div>

        <div id="content-wrapper" style="width: 100%;">
            <header id="top-bar">
                <button id="menu-toggle"><i class="fas fa-bars"></i></button>
                <h1 id="page-title">لوحة التحكم</h1>
                <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
            </header>
            <main id="main-content">
                <!-- سيتم تحميل المحتوى هنا ديناميكيًا -->
            </main>
        </div>
    </div>

    <!-- Modal for Image Preview -->
    <div class="image-modal" id="imageModal">
        <span class="close">&times;</span>
        <img id="modalImage" src="" alt="صورة مكبرة">
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
            apiKey: "AIzaSyC5dwRaz3L-aK7I5CoPkbB31MzXB62lgrU",
            authDomain: "earnmoney124553.firebaseapp.com",
            databaseURL: "https://earnmoney124553-default-rtdb.firebaseio.com",
            projectId: "earnmoney124553",
            storageBucket: "earnmoney124553.firebasestorage.app",
            messagingSenderId: "325528918523",
            appId: "1:325528918523:web:73d84f48a24c1e0cbfd35e",
            measurementId: "G-G1H96Q5XCJ"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // عناصر DOM
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');
        const mainContent = document.getElementById('main-content');
        const pageTitle = document.getElementById('page-title');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        const logoutButtons = document.querySelectorAll('#logout-btn, #sidebar-logout-btn');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const modalClose = document.querySelector('.image-modal .close');

        // بيانات الاعتماد الافتراضية
        const DEFAULT_ADMIN_USERNAME = "aborabie";
        const DEFAULT_ADMIN_PASSWORD = "KLKFijkj-48@#$lk$Uu";

        // التحقق من وجود بيانات المسؤول وإنشاؤها إذا لزم الأمر
        const checkAndCreateDefaultAdmin = async () => {
            const adminSnap = await db.ref('admin').once('value');
            if (!adminSnap.exists()) {
                await db.ref('admin').set({
                    username: DEFAULT_ADMIN_USERNAME,
                    password: DEFAULT_ADMIN_PASSWORD
                });
                console.log("تم إنشاء بيانات المسؤول الافتراضية");
            }
        };

        // تسجيل الدخول
        const login = async (username, password) => {
            try {
                const adminSnap = await db.ref('admin').once('value');
                const adminData = adminSnap.val();
                
                if (adminData && adminData.username === username && adminData.password === password) {
                    sessionStorage.setItem('adminLoggedIn', 'true');
                    loginPage.style.display = 'none';
                    appContainer.style.display = 'flex';
                    initAdminPanel();
                    return true;
                } else {
                    loginError.style.display = 'block';
                    return false;
                }
            } catch (error) {
                console.error("خطأ في تسجيل الدخول:", error);
                loginError.style.display = 'block';
                return false;
            }
        };

        // تسجيل الخروج
        const logout = () => {
            sessionStorage.removeItem('adminLoggedIn');
            appContainer.style.display = 'none';
            loginPage.style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            loginError.style.display = 'none';
        };

        // التحقق من حالة تسجيل الدخول
        const checkLoginStatus = () => {
            if (sessionStorage.getItem('adminLoggedIn') === 'true') {
                loginPage.style.display = 'none';
                appContainer.style.display = 'flex';
                initAdminPanel();
            } else {
                loginPage.style.display = 'flex';
                appContainer.style.display = 'none';
            }
        };

        // مستمعي الأحداث لتسجيل الدخول والخروج
        loginButton.addEventListener('click', async () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                loginError.textContent = 'يرجى إدخال اسم المستخدم وكلمة المرور';
                loginError.style.display = 'block';
                return;
            }
            
            await login(username, password);
        });

        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loginButton.click();
            }
        });

        logoutButtons.forEach(button => {
            button.addEventListener('click', logout);
        });

        // تهيئة المسؤول الافتراضي والتحقق من حالة تسجيل الدخول
        checkAndCreateDefaultAdmin();
        checkLoginStatus();

        // ========== الأقسام الجديدة ==========

        // 1. قسم إدارة الأكواد المتعددة
        const renderCodesAll = async () => {
            mainContent.innerHTML = '<div class="card"><h3>جاري تحميل الأكواد...</h3></div>';
            
            const snap = await db.ref('codes').once('value');
            let codes = [];
            snap.forEach(child => {
                codes.push({ key: child.key, ...child.val() });
            });
            
            // تصفية حسب النوع
            const filterType = document.getElementById('code-type-filter') ? document.getElementById('code-type-filter').value : 'all';
            if (filterType !== 'all') {
                codes = codes.filter(code => code.type === filterType);
            }
            
            // تصفية حسب الحالة
            const filterStatus = document.getElementById('code-status-filter') ? document.getElementById('code-status-filter').value : 'all';
            if (filterStatus !== 'all') {
                const now = Date.now();
                if (filterStatus === 'active') {
                    codes = codes.filter(code => 
                        (!code.expires || code.expires > now) && 
                        (!code.maxUses || (code.usedCount || 0) < code.maxUses)
                    );
                } else if (filterStatus === 'expired') {
                    codes = codes.filter(code => code.expires && code.expires <= now);
                } else if (filterStatus === 'used') {
                    codes = codes.filter(code => code.maxUses && (code.usedCount || 0) >= code.maxUses);
                }
            }
            
            let tableContent = '';
            if (codes.length > 0) {
                codes.forEach(code => {
                    const usedCount = code.usedCount || 0;
                    const maxUses = code.maxUses || 0;
                    const isExpired = code.expires && Date.now() > code.expires;
                    const isMaxed = maxUses > 0 && usedCount >= maxUses;
                    const status = isExpired ? 'منتهي' : isMaxed ? 'مكتمل' : 'نشط';
                    const statusClass = isExpired || isMaxed ? 'status-inactive' : 'status-active';
                    
                    let typeBadge = '';
                    if (code.type === 'contest') {
                        typeBadge = '<span class="code-badge code-type-contest">نقاط مسابقة</span>';
                    } else if (code.type === 'ton') {
                        typeBadge = '<span class="code-badge code-type-ton">TON</span>';
                    } else if (code.type === 'rr') {
                        typeBadge = '<span class="code-badge code-type-rr">RR</span>';
                    }
                    
                    let valueText = '';
                    if (code.type === 'contest') {
                        valueText = `${code.points || 0} نقطة`;
                    } else if (code.type === 'ton') {
                        valueText = `${code.amount || 0} TON`;
                    } else if (code.type === 'rr') {
                        valueText = `${(code.amount || 0).toLocaleString()} RR`;
                    }
                    
                    tableContent += `<tr>
                        <td data-label="الكود">
                            <strong>${code.key}</strong>
                            ${typeBadge}
                            <br><small>${code.description || 'لا يوجد وصف'}</small>
                        </td>
                        <td data-label="القيمة">${valueText}</td>
                        <td data-label="الاستخدام">${usedCount}/${maxUses > 0 ? maxUses : '∞'}</td>
                        <td data-label="الحالة"><span class="status-badge ${statusClass}">${status}</span></td>
                        <td data-label="الإجراءات">
                            <div class="action-buttons">
                                <button class="action-btn btn-primary" onclick="window.adminActions.editCode('${code.key}')">تعديل</button>
                                <button class="action-btn btn-danger" onclick="window.adminActions.deleteCode('${code.key}')">حذف</button>
                                <button class="action-btn btn-warning" onclick="window.adminActions.toggleCodeStatus('${code.key}', ${isExpired || isMaxed})">${isExpired || isMaxed ? 'تفعيل' : 'تعطيل'}</button>
                            </div>
                        </td>
                    </tr>`;
                });
            } else {
                tableContent = '<tr><td colspan="5" style="text-align: center;">لا توجد أكواد.</td></tr>';
            }
            
            mainContent.innerHTML = `<div id="codes-all" class="page active">
                <h3><i class="fas fa-ticket-alt"></i> جميع الأكواد</h3>
                
                <div class="card">
                    <div class="filter-bar">
                        <select id="code-type-filter">
                            <option value="all">جميع الأنواع</option>
                            <option value="contest">نقاط المسابقة</option>
                            <option value="ton">TON</option>
                            <option value="rr">RR</option>
                        </select>
                        <select id="code-status-filter">
                            <option value="all">جميع الحالات</option>
                            <option value="active">نشط فقط</option>
                            <option value="expired">منتهي</option>
                            <option value="used">مكتمل الاستخدام</option>
                        </select>
                        <input type="text" id="code-search" placeholder="بحث في الأكواد...">
                        <button class="action-btn btn-primary" onclick="renderCodesAll()">تطبيق</button>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>الكود</th>
                                <th>القيمة</th>
                                <th>الاستخدام</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>${tableContent}</tbody>
                    </table>
                </div>
            </div>`;
            
            // إضافة مستمعي الأحداث للتصفية
            document.getElementById('code-type-filter').addEventListener('change', renderCodesAll);
            document.getElementById('code-status-filter').addEventListener('change', renderCodesAll);
            document.getElementById('code-search').addEventListener('input', renderCodesAll);
        };

        const renderCodesCreate = () => {
            mainContent.innerHTML = `<div id="codes-create" class="page active">
                <h3><i class="fas fa-plus-circle"></i> إنشاء كود جديد</h3>
                
                <div class="card">
                    <h4>إعدادات الكود</h4>
                    <div class="form-group">
                        <label>نوع الكود</label>
                        <select id="code-type">
                            <option value="contest">نقاط المسابقة</option>
                            <option value="ton">رصيد TON</option>
                            <option value="rr">عملة RR</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>نص الكود (أحرف كبيرة فقط)</label>
                        <input type="text" id="code-text" placeholder="مثال: WELCOME50" style="text-transform: uppercase;">
                    </div>
                    
                    <div class="form-group">
                        <label>وصف الكود (اختياري)</label>
                        <input type="text" id="code-description" placeholder="وصف مختصر للكود">
                    </div>
                    
                    <div id="code-value-container">
                        <!-- سيتم تحديثه بناءً على نوع الكود -->
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>الحد الأقصى للاستخدام (0 = لا نهائي)</label>
                            <input type="number" id="code-max-uses" value="100" min="0">
                        </div>
                        <div class="form-group">
                            <label>تاريخ الانتهاء (اختياري)</label>
                            <input type="datetime-local" id="code-expiry">
                        </div>
                    </div>
                    
                    <button class="action-btn btn-success" onclick="window.adminActions.createCode()" style="width: 100%; padding: 15px;">
                        <i class="fas fa-save"></i> إنشاء الكود
                    </button>
                </div>
            </div>`;
            
            updateCodeValueField();
            document.getElementById('code-type').addEventListener('change', updateCodeValueField);
        };

        const updateCodeValueField = () => {
            const type = document.getElementById('code-type').value;
            const container = document.getElementById('code-value-container');
            
            let html = '';
            if (type === 'contest') {
                html = `
                    <label>عدد النقاط (10-1000)</label>
                    <input type="number" id="code-value" min="10" max="1000" value="50">
                `;
            } else if (type === 'ton') {
                html = `
                    <label>المبلغ (0.001 - 1 TON)</label>
                    <input type="number" id="code-value" min="0.001" max="1" step="0.001" value="0.01">
                `;
            } else if (type === 'rr') {
                html = `
                    <label>المبلغ (1000 - 100000 RR)</label>
                    <input type="number" id="code-value" min="1000" max="100000" value="5000">
                `;
            }
            
            container.innerHTML = html;
        };

        const renderCodesStats = async () => {
            const snap = await db.ref('codes').once('value');
            let codes = [];
            snap.forEach(child => {
                codes.push({ key: child.key, ...child.val() });
            });
            
            const totalCodes = codes.length;
            const activeCodes = codes.filter(code => {
                const now = Date.now();
                return (!code.expires || code.expires > now) && 
                       (!code.maxUses || (code.usedCount || 0) < code.maxUses);
            }).length;
            
            const contestCodes = codes.filter(code => code.type === 'contest').length;
            const tonCodes = codes.filter(code => code.type === 'ton').length;
            const rrCodes = codes.filter(code => code.type === 'rr').length;
            
            const totalUses = codes.reduce((sum, code) => sum + (code.usedCount || 0), 0);
            const totalPoints = codes
                .filter(code => code.type === 'contest')
                .reduce((sum, code) => sum + ((code.points || 0) * (code.usedCount || 0)), 0);
                
            const totalTON = codes
                .filter(code => code.type === 'ton')
                .reduce((sum, code) => sum + ((code.amount || 0) * (code.usedCount || 0)), 0);
                
            const totalRR = codes
                .filter(code => code.type === 'rr')
                .reduce((sum, code) => sum + ((code.amount || 0) * (code.usedCount || 0)), 0);
            
            mainContent.innerHTML = `<div id="codes-stats" class="page active">
                <h3><i class="fas fa-chart-bar"></i> إحصائيات الأكواد</h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">إجمالي الأكواد</div>
                        <div class="stat-value">${totalCodes}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">الأكواد النشطة</div>
                        <div class="stat-value">${activeCodes}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">أكواد المسابقة</div>
                        <div class="stat-value">${contestCodes}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">أكواد TON</div>
                        <div class="stat-value">${tonCodes}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">أكواد RR</div>
                        <div class="stat-value">${rrCodes}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">إجمالي الاستخدامات</div>
                        <div class="stat-value">${totalUses}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">إجمالي النقاط الممنوحة</div>
                        <div class="stat-value">${totalPoints}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">إجمالي TON الممنوح</div>
                        <div class="stat-value">${totalTON.toFixed(4)}</div>
                    </div>
                </div>
                
                <div class="card">
                    <h4>أكثر الأكواد استخداماً</h4>
                    <div id="top-codes-list">
                        ${generateTopCodesList(codes)}
                    </div>
                </div>
            </div>`;
        };

        const generateTopCodesList = (codes) => {
            // ترتيب الأكواد حسب عدد الاستخدامات
            const sortedCodes = codes.sort((a, b) => (b.usedCount || 0) - (a.usedCount || 0)).slice(0, 10);
            
            if (sortedCodes.length === 0) {
                return '<p>لا توجد بيانات عن الأكواد.</p>';
            }
            
            let html = '<table><thead><tr><th>الكود</th><th>النوع</th><th>الاستخدامات</th><th>القيمة الإجمالية</th></tr></thead><tbody>';
            
            sortedCodes.forEach(code => {
                let totalValue = '';
                if (code.type === 'contest') {
                    totalValue = `${((code.points || 0) * (code.usedCount || 0)).toLocaleString()} نقطة`;
                } else if (code.type === 'ton') {
                    totalValue = `${((code.amount || 0) * (code.usedCount || 0)).toFixed(4)} TON`;
                } else if (code.type === 'rr') {
                    totalValue = `${((code.amount || 0) * (code.usedCount || 0)).toLocaleString()} RR`;
                }
                
                let typeText = '';
                if (code.type === 'contest') typeText = 'نقاط مسابقة';
                else if (code.type === 'ton') typeText = 'TON';
                else if (code.type === 'rr') typeText = 'RR';
                
                html += `<tr>
                    <td>${code.key}</td>
                    <td>${typeText}</td>
                    <td>${code.usedCount || 0}</td>
                    <td>${totalValue}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            return html;
        };

        // 2. قسم إدارة المهام المتعددة
        const renderTasksAll = async () => {
            mainContent.innerHTML = '<div class="card"><h3>جاري تحميل المهام...</h3></div>';
            
            const tasksSnap = await db.ref('config/tasks').once('value');
            const botTasksSnap = await db.ref('botTasks').once('value');
            
            let tasks = [];
            tasksSnap.forEach(child => {
                tasks.push({ key: child.key, type: 'channel', ...child.val() });
            });
            
            botTasksSnap.forEach(child => {
                tasks.push({ key: child.key, type: 'bot', ...child.val() });
            });
            
            let tableContent = '';
            if (tasks.length > 0) {
                tasks.forEach(task => {
                    let typeBadge = '';
                    if (task.type === 'channel') {
                        typeBadge = '<span class="task-badge task-type-channel">انضمام قناة</span>';
                    } else if (task.type === 'bot') {
                        typeBadge = '<span class="task-badge task-type-bot">مهمة بوت</span>';
                    }
                    
                    let rewardText = '';
                    if (task.reward) {
                        rewardText = `${task.reward} TON`;
                    } else if (task.rewardRR) {
                        rewardText = `${task.rewardRR.toLocaleString()} RR`;
                    }
                    
                    const status = task.active === false ? 'معطلة' : 'نشطة';
                    const statusClass = task.active === false ? 'status-inactive' : 'status-active';
                    
                    tableContent += `<tr>
                        <td data-label="المهمة">
                            <strong>${task.name}</strong>
                            ${typeBadge}
                            <br><small>${task.description || 'لا يوجد وصف'}</small>
                        </td>
                        <td data-label="المكافأة">${rewardText}</td>
                        <td data-label="النوع">${task.type === 'channel' ? 'انضمام قناة' : 'مهمة بوت'}</td>
                        <td data-label="الحالة"><span class="status-badge ${statusClass}">${status}</span></td>
                        <td data-label="الإجراءات">
                            <div class="action-buttons">
                                <button class="action-btn btn-primary" onclick="window.adminActions.editTask('${task.key}', '${task.type}')">تعديل</button>
                                <button class="action-btn btn-danger" onclick="window.adminActions.deleteTask('${task.key}', '${task.type}')">حذف</button>
                                <button class="action-btn btn-warning" onclick="window.adminActions.toggleTaskStatus('${task.key}', '${task.type}', ${task.active === false})">${task.active === false ? 'تفعيل' : 'تعطيل'}</button>
                                ${task.type === 'bot' ? `<button class="action-btn btn-info" onclick="window.adminActions.viewTaskRequirements('${task.key}')">المتطلبات</button>` : ''}
                            </div>
                        </td>
                    </tr>`;
                });
            } else {
                tableContent = '<tr><td colspan="5" style="text-align: center;">لا توجد مهام.</td></tr>';
            }
            
            mainContent.innerHTML = `<div id="tasks-all" class="page active">
                <h3><i class="fas fa-tasks"></i> جميع المهام</h3>
                
                <div class="card">
                    <div class="filter-bar">
                        <select id="task-type-filter">
                            <option value="all">جميع الأنواع</option>
                            <option value="channel">مهام القنوات</option>
                            <option value="bot">مهام البوت</option>
                        </select>
                        <select id="task-status-filter">
                            <option value="all">جميع الحالات</option>
                            <option value="active">نشطة فقط</option>
                            <option value="inactive">معطلة</option>
                        </select>
                        <input type="text" id="task-search" placeholder="بحث في المهام...">
                        <button class="action-btn btn-primary" onclick="renderTasksAll()">تطبيق</button>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>المهمة</th>
                                <th>المكافأة</th>
                                <th>النوع</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>${tableContent}</tbody>
                    </table>
                </div>
            </div>`;
            
            // إضافة مستمعي الأحداث للتصفية
            document.getElementById('task-type-filter').addEventListener('change', renderTasksAll);
            document.getElementById('task-status-filter').addEventListener('change', renderTasksAll);
            document.getElementById('task-search').addEventListener('input', renderTasksAll);
        };

        const renderTasksCreate = () => {
            mainContent.innerHTML = `<div id="tasks-create" class="page active">
                <h3><i class="fas fa-plus-circle"></i> إنشاء مهمة جديدة</h3>
                
                <div class="card">
                    <h4>نوع المهمة</h4>
                    <div class="form-group">
                        <select id="task-type">
                            <option value="channel">مهمة انضمام قناة</option>
                            <option value="bot">مهمة بوت</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>اسم المهمة</label>
                        <input type="text" id="task-name" placeholder="اسم المهمة">
                    </div>
                    
                    <div class="form-group">
                        <label>وصف المهمة</label>
                        <textarea id="task-description" placeholder="وصف مختصر للمهمة"></textarea>
                    </div>
                    
                    <div id="task-specific-fields">
                        <!-- سيتم تحديثه بناءً على نوع المهمة -->
                    </div>
                    
                    <div class="form-group">
                        <label>نوع المكافأة</label>
                        <select id="reward-type">
                            <option value="ton">TON</option>
                            <option value="rr">RR</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>قيمة المكافأة</label>
                        <input type="number" id="task-reward" step="any" placeholder="قيمة المكافأة">
                    </div>
                    
                    <div class="form-group">
                        <label>أيقونة المهمة (رابط الصورة)</label>
                        <input type="text" id="task-icon" placeholder="رابط أيقونة المهمة">
                    </div>
                    
                    <button class="action-btn btn-success" onclick="window.adminActions.createTask()" style="width: 100%; padding: 15px;">
                        <i class="fas fa-save"></i> إنشاء المهمة
                    </button>
                </div>
            </div>`;
            
            updateTaskSpecificFields();
            document.getElementById('task-type').addEventListener('change', updateTaskSpecificFields);
        };

        const updateTaskSpecificFields = () => {
            const type = document.getElementById('task-type').value;
            const container = document.getElementById('task-specific-fields');
            
            let html = '';
            if (type === 'channel') {
                html = `
                    <div class="form-group">
                        <label>رابط القناة</label>
                        <input type="text" id="task-url" placeholder="رابط القناة على التليجرام">
                    </div>
                `;
            } else if (type === 'bot') {
                html = `
                    <div class="form-group">
                        <label>رابط البوت</label>
                        <input type="text" id="task-url" placeholder="رابط البوت على التليجرام">
                    </div>
                    <div class="form-group">
                        <label>متطلبات المهمة (كل سطر يمثل متطلب)</label>
                        <textarea id="task-requirements" placeholder="اكتب كل متطلب في سطر منفصل" rows="5"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ملاحظات مهمة للمستخدم</label>
                        <textarea id="task-notes" placeholder="ملاحظات إضافية للمستخدم" rows="3"></textarea>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        };

        const renderTasksStats = async () => {
            // جمع إحصائيات المهام
            const tasksSnap = await db.ref('config/tasks').once('value');
            const botTasksSnap = await db.ref('botTasks').once('value');
            const usersSnap = await db.ref('users').once('value');
            
            let channelTasks = [];
            tasksSnap.forEach(child => {
                channelTasks.push({ key: child.key, ...child.val() });
            });
            
            let botTasks = [];
            botTasksSnap.forEach(child => {
                botTasks.push({ key: child.key, ...child.val() });
            });
            
            // حساب عدد المستخدمين الذين أكملوا كل مهمة
            let userCompletionStats = {};
            usersSnap.forEach(child => {
                const user = child.val();
                if (user.completedTasks) {
                    Object.keys(user.completedTasks).forEach(taskKey => {
                        if (!userCompletionStats[taskKey]) {
                            userCompletionStats[taskKey] = 0;
                        }
                        userCompletionStats[taskKey]++;
                    });
                }
            });
            
            const totalTasks = channelTasks.length + botTasks.length;
            const activeTasks = [...channelTasks, ...botTasks].filter(task => task.active !== false).length;
            
            mainContent.innerHTML = `<div id="tasks-stats" class="page active">
                <h3><i class="fas fa-chart-bar"></i> إحصائيات المهام</h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">إجمالي المهام</div>
                        <div class="stat-value">${totalTasks}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">المهام النشطة</div>
                        <div class="stat-value">${activeTasks}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">مهام القنوات</div>
                        <div class="stat-value">${channelTasks.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">مهام البوت</div>
                        <div class="stat-value">${botTasks.length}</div>
                    </div>
                </div>
                
                <div class="card">
                    <h4>إحصائيات إكمال المهام</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>المهمة</th>
                                <th>النوع</th>
                                <th>عدد المستخدمين الذين أكملوا</th>
                                <th>نسبة الإكمال</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generateTaskCompletionStats([...channelTasks, ...botTasks], userCompletionStats, usersSnap.numChildren())}
                        </tbody>
                    </table>
                </div>
            </div>`;
        };

        const generateTaskCompletionStats = (tasks, completionStats, totalUsers) => {
            if (tasks.length === 0) {
                return '<tr><td colspan="4" style="text-align: center;">لا توجد مهام.</td></tr>';
            }
            
            let html = '';
            tasks.forEach(task => {
                const completions = completionStats[task.key] || 0;
                const completionRate = totalUsers > 0 ? ((completions / totalUsers) * 100).toFixed(1) : 0;
                
                let typeText = '';
                if (task.type === 'channel' || !task.type) typeText = 'انضمام قناة';
                else if (task.type === 'bot') typeText = 'مهمة بوت';
                
                html += `<tr>
                    <td>${task.name}</td>
                    <td>${typeText}</td>
                    <td>${completions}</td>
                    <td>${completionRate}%</td>
                </tr>`;
            });
            
            return html;
        };

        // 3. قسم مراجعة طلبات البوت
        const renderBotRequests = async () => {
            mainContent.innerHTML = '<div class="card"><h3>جاري تحميل الطلبات...</h3></div>';
            
            const snap = await db.ref('botVerifications').orderByChild('submittedAt').once('value');
            let requests = [];
            snap.forEach(child => {
                requests.push({ key: child.key, ...child.val() });
            });
            
            requests.reverse(); // عرض أحدث الطلبات أولاً
            
            let pendingRequests = requests.filter(req => req.status === 'pending');
            let processedRequests = requests.filter(req => req.status !== 'pending');
            
            // تحديث عدد الإشعارات
            const badge = document.getElementById('bot-requests-badge');
            if (pendingRequests.length > 0) {
                badge.textContent = pendingRequests.length;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
            
            mainContent.innerHTML = `<div id="bot-requests" class="page active">
                <h3><i class="fas fa-robot"></i> طلبات البوت المعلقة</h3>
                
                <div class="tabs">
                    <div class="tab active" data-tab="pending">معلقة (${pendingRequests.length})</div>
                    <div class="tab" data-tab="processed">المعالجة (${processedRequests.length})</div>
                </div>
                
                <div id="pending-tab" class="tab-content active">
                    ${generateBotRequestsTable(pendingRequests, 'pending')}
                </div>
                
                <div id="processed-tab" class="tab-content">
                    ${generateBotRequestsTable(processedRequests, 'processed')}
                </div>
            </div>`;
            
            setupBotRequestsTabs();
        };

        const generateBotRequestsTable = (requests, type) => {
            if (requests.length === 0) {
                return '<div class="card"><p>لا توجد طلبات.</p></div>';
            }
            
            let tableContent = '';
            requests.forEach(request => {
                const status = request.status || 'pending';
                const statusText = status === 'pending' ? 'قيد المراجعة' : 
                                 status === 'approved' ? 'مقبولة' : 'مرفوضة';
                const statusClass = status === 'pending' ? 'status-pending' : 
                                  status === 'approved' ? 'status-approved' : 'status-rejected';
                
                tableContent += `<tr>
                    <td data-label="المستخدم">
                        <strong>${request.userName || 'غير معروف'}</strong>
                        <br><small>@${request.username || 'لا يوجد'}</small>
                        <br><small>ID: ${request.userId}</small>
                    </td>
                    <td data-label="التاريخ">
                        ${new Date(request.submittedAt).toLocaleString('ar-EG')}
                        ${request.processedAt ? `<br><small>معالجة: ${new Date(request.processedAt).toLocaleString('ar-EG')}</small>` : ''}
                    </td>
                    <td data-label="الصورة">
                        ${request.screenshot ? 
                            `<img src="${request.screenshot}" alt="لقطة الشاشة" class="image-preview" style="max-width: 100px; cursor: pointer;" onclick="window.adminActions.viewImage('${request.screenshot}')">` : 
                            'لا توجد صورة'
                        }
                    </td>
                    <td data-label="الحالة">
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </td>
                    <td data-label="الإجراءات">
                        <div class="action-buttons">
                            ${type === 'pending' ? `
                                <button class="action-btn btn-success" onclick="window.adminActions.approveBotRequest('${request.key}', '${request.userId}')">قبول</button>
                                <button class="action-btn btn-danger" onclick="window.adminActions.rejectBotRequest('${request.key}', '${request.userId}')">رفض</button>
                            ` : ''}
                            <button class="action-btn btn-info" onclick="window.adminActions.viewBotRequestDetails('${request.key}')">تفاصيل</button>
                            ${type === 'processed' ? `
                                <button class="action-btn btn-warning" onclick="window.adminActions.deleteBotRequest('${request.key}')">حذف</button>
                            ` : ''}
                        </div>
                    </td>
                </tr>`;
            });
            
            return `<div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>المستخدم</th>
                            <th>التاريخ</th>
                            <th>الصورة</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>${tableContent}</tbody>
                </table>
            </div>`;
        };

        const setupBotRequestsTabs = () => {
            const tabs = document.querySelectorAll('#bot-requests .tab');
            const tabContents = document.querySelectorAll('#bot-requests .tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        };

        // ========== دوال المساعدة ==========

        const setupSubmenus = () => {
            const submenuItems = document.querySelectorAll('.has-submenu');
            
            submenuItems.forEach(item => {
                item.addEventListener('click', function() {
                    const submenu = this.nextElementSibling;
                    submenu.classList.toggle('active');
                    
                    const icon = this.querySelector('.fa-chevron-down');
                    if (icon) {
                        icon.classList.toggle('fa-chevron-up');
                    }
                });
            });
        };

        // ========== إجراءات المسؤول ==========

        window.adminActions = {
            // إدارة الأكواد
            createCode: async () => {
                const type = document.getElementById('code-type').value;
                const codeText = document.getElementById('code-text').value.trim().toUpperCase();
                const description = document.getElementById('code-description').value.trim();
                const value = parseFloat(document.getElementById('code-value').value);
                const maxUses = parseInt(document.getElementById('code-max-uses').value) || 0;
                const expiry = document.getElementById('code-expiry').value;
                
                if (!codeText) {
                    alert('يرجى إدخال نص الكود');
                    return;
                }
                
                if (!value || value <= 0) {
                    alert('يرجى إدخال قيمة صحيحة للكود');
                    return;
                }
                
                const codeData = {
                    type: type,
                    description: description || '',
                    maxUses: maxUses,
                    usedCount: 0,
                    created: firebase.database.ServerValue.TIMESTAMP,
                    createdBy: 'admin'
                };
                
                if (type === 'contest') {
                    codeData.points = value;
                } else if (type === 'ton') {
                    codeData.amount = value;
                } else if (type === 'rr') {
                    codeData.amount = value;
                }
                
                if (expiry) {
                    codeData.expires = new Date(expiry).getTime();
                }
                
                try {
                    // التحقق من عدم وجود كود بنفس النص
                    const existingSnap = await db.ref(`codes/${codeText}`).once('value');
                    if (existingSnap.exists()) {
                        alert('هذا الكود موجود مسبقاً!');
                        return;
                    }
                    
                    await db.ref(`codes/${codeText}`).set(codeData);
                    alert('تم إنشاء الكود بنجاح!');
                    
                    // إعادة تعيين الحقول
                    document.getElementById('code-text').value = '';
                    document.getElementById('code-description').value = '';
                    document.getElementById('code-max-uses').value = '100';
                    document.getElementById('code-expiry').value = '';
                    
                    renderCodesAll();
                } catch (e) {
                    alert('خطأ في إنشاء الكود: ' + e.message);
                }
            },
            
            editCode: async (codeText) => {
                const snap = await db.ref(`codes/${codeText}`).once('value');
                const codeData = snap.val();
                
                if (!codeData) {
                    alert('الكود غير موجود');
                    return;
                }
                
                const newMaxUses = prompt(`الحد الأقصى الحالي: ${codeData.maxUses || 0}\nأدخل الحد الأقصى الجديد:`, codeData.maxUses || 100);
                if (newMaxUses !== null) {
                    const maxUses = parseInt(newMaxUses);
                    if (!isNaN(maxUses) && maxUses >= 0) {
                        try {
                            await db.ref(`codes/${codeText}/maxUses`).set(maxUses);
                            alert('تم تحديث الحد الأقصى للاستخدام!');
                            renderCodesAll();
                        } catch (e) {
                            alert('خطأ في التحديث: ' + e.message);
                        }
                    } else {
                        alert('يرجى إدخال رقم صحيح موجب');
                    }
                }
            },
            
            deleteCode: async (codeText) => {
                if (confirm(`هل أنت متأكد من رغبتك في حذف الكود "${codeText}"؟`)) {
                    try {
                        await db.ref(`codes/${codeText}`).remove();
                        alert('تم حذف الكود بنجاح!');
                        renderCodesAll();
                    } catch (e) {
                        alert('خطأ في حذف الكود: ' + e.message);
                    }
                }
            },
            
            toggleCodeStatus: async (codeText, isInactive) => {
                if (isInactive) {
                    // تفعيل الكود من خلال إزالة تاريخ الانتهاء
                    try {
                        await db.ref(`codes/${codeText}/expires`).remove();
                        alert('تم تفعيل الكود!');
                        renderCodesAll();
                    } catch (e) {
                        alert('خطأ في التفعيل: ' + e.message);
                    }
                } else {
                    // تعطيل الكود من خلال تعيين تاريخ انتهاء في الماضي
                    try {
                        await db.ref(`codes/${codeText}/expires`).set(Date.now() - 86400000); // قبل يوم
                        alert('تم تعطيل الكود!');
                        renderCodesAll();
                    } catch (e) {
                        alert('خطأ في التعطيل: ' + e.message);
                    }
                }
            },
            
            // إدارة المهام
            createTask: async () => {
                const type = document.getElementById('task-type').value;
                const name = document.getElementById('task-name').value.trim();
                const description = document.getElementById('task-description').value.trim();
                const url = document.getElementById('task-url').value.trim();
                const rewardType = document.getElementById('reward-type').value;
                const rewardValue = parseFloat(document.getElementById('task-reward').value);
                const icon = document.getElementById('task-icon').value.trim();
                
                if (!name || !description || !url) {
                    alert('يرجى ملء جميع الحقول الإلزامية');
                    return;
                }
                
                if (!rewardValue || rewardValue <= 0) {
                    alert('يرجى إدخال مكافأة صحيحة');
                    return;
                }
                
                const taskData = {
                    name: name,
                    description: description,
                    url: url,
                    icon: icon || 'https://img.icons8.com/ios-filled/100/group.png',
                    active: true,
                    created: firebase.database.ServerValue.TIMESTAMP
                };
                
                if (rewardType === 'ton') {
                    taskData.reward = rewardValue;
                } else if (rewardType === 'rr') {
                    taskData.rewardRR = rewardValue;
                }
                
                if (type === 'bot') {
                    const requirements = document.getElementById('task-requirements').value.split('\n').filter(line => line.trim());
                    const notes = document.getElementById('task-notes').value.trim();
                    
                    taskData.requirements = requirements;
                    taskData.notes = notes;
                    
                    try {
                        await db.ref('botTasks').push(taskData);
                        alert('تم إنشاء مهمة البوت بنجاح!');
                        renderTasksAll();
                    } catch (e) {
                        alert('خطأ في إنشاء المهمة: ' + e.message);
                    }
                } else {
                    try {
                        await db.ref('config/tasks').push(taskData);
                        alert('تم إنشاء المهمة بنجاح!');
                        renderTasksAll();
                    } catch (e) {
                        alert('خطأ في إنشاء المهمة: ' + e.message);
                    }
                }
            },
            
            editTask: async (taskKey, taskType) => {
                const ref = taskType === 'bot' ? db.ref(`botTasks/${taskKey}`) : db.ref(`config/tasks/${taskKey}`);
                const snap = await ref.once('value');
                const taskData = snap.val();
                
                if (!taskData) {
                    alert('المهمة غير موجودة');
                    return;
                }
                
                const newName = prompt(`اسم المهمة الحالي: ${taskData.name}\nأدخل الاسم الجديد:`, taskData.name);
                if (newName !== null && newName.trim()) {
                    try {
                        await ref.child('name').set(newName.trim());
                        alert('تم تحديث اسم المهمة!');
                        renderTasksAll();
                    } catch (e) {
                        alert('خطأ في التحديث: ' + e.message);
                    }
                }
            },
            
            deleteTask: async (taskKey, taskType) => {
                if (confirm('هل أنت متأكد من رغبتك في حذف هذه المهمة؟')) {
                    try {
                        if (taskType === 'bot') {
                            await db.ref(`botTasks/${taskKey}`).remove();
                        } else {
                            await db.ref(`config/tasks/${taskKey}`).remove();
                        }
                        alert('تم حذف المهمة بنجاح!');
                        renderTasksAll();
                    } catch (e) {
                        alert('خطأ في حذف المهمة: ' + e.message);
                    }
                }
            },
            
            toggleTaskStatus: async (taskKey, taskType, isInactive) => {
                try {
                    if (taskType === 'bot') {
                        await db.ref(`botTasks/${taskKey}/active`).set(!isInactive);
                    } else {
                        await db.ref(`config/tasks/${taskKey}/active`).set(!isInactive);
                    }
                    alert(`تم ${isInactive ? 'تفعيل' : 'تعطيل'} المهمة بنجاح!`);
                    renderTasksAll();
                } catch (e) {
                    alert('خطأ في تغيير حالة المهمة: ' + e.message);
                }
            },
            
            viewTaskRequirements: async (taskKey) => {
                const snap = await db.ref(`botTasks/${taskKey}`).once('value');
                const taskData = snap.val();
                
                if (!taskData) {
                    alert('المهمة غير موجودة');
                    return;
                }
                
                const requirements = taskData.requirements || [];
                const notes = taskData.notes || '';
                
                let requirementsHTML = '';
                if (requirements.length > 0) {
                    requirementsHTML = '<ol>';
                    requirements.forEach(req => {
                        requirementsHTML += `<li>${req}</li>`;
                    });
                    requirementsHTML += '</ol>';
                } else {
                    requirementsHTML = '<p>لا توجد متطلبات محددة</p>';
                }
                
                mainContent.innerHTML = `<div class="page active">
                    <h3>متطلبات المهمة: ${taskData.name}</h3>
                    <div class="card">
                        <h4>المتطلبات</h4>
                        ${requirementsHTML}
                    </div>
                    ${notes ? `
                    <div class="card">
                        <h4>ملاحظات</h4>
                        <p>${notes}</p>
                    </div>
                    ` : ''}
                    <button class="action-btn btn-primary" onclick="renderTasksAll()">العودة إلى قائمة المهام</button>
                </div>`;
            },
            
            // إدارة طلبات البوت
            approveBotRequest: async (requestKey, userId) => {
                if (confirm('هل أنت متأكد من قبول هذا الطلب؟')) {
                    try {
                        const requestRef = db.ref(`botVerifications/${requestKey}`);
                        const requestSnap = await requestRef.once('value');
                        const requestData = requestSnap.val();
                        
                        if (!requestData) {
                            alert('الطلب غير موجود');
                            return;
                        }
                        
                        // منح المكافأة للمستخدم
                        const userRef = db.ref(`users/${userId}`);
                        await userRef.child('completedTasks/join_bot_task').set(true);
                        
                        // تحديث حالة الطلب
                        await requestRef.update({
                            status: 'approved',
                            processedAt: firebase.database.ServerValue.TIMESTAMP,
                            processedBy: 'admin'
                        });
                        
                        alert('تم قبول الطلب ومنح المكافأة للمستخدم!');
                        renderBotRequests();
                    } catch (e) {
                        alert('خطأ في معالجة الطلب: ' + e.message);
                    }
                }
            },
            
            rejectBotRequest: async (requestKey, userId) => {
                const reason = prompt('يرجى إدخال سبب الرفض (اختياري):');
                
                try {
                    const requestRef = db.ref(`botVerifications/${requestKey}`);
                    
                    // تحديث حالة الطلب
                    await requestRef.update({
                        status: 'rejected',
                        processedAt: firebase.database.ServerValue.TIMESTAMP,
                        processedBy: 'admin',
                        rejectionReason: reason || ''
                    });
                    
                    // إعادة تعيين حالة المستخدم للسماح بإعادة المحاولة
                    const userRef = db.ref(`users/${userId}`);
                    await userRef.child('pendingBotVerification').set(false);
                    
                    alert('تم رفض الطلب!');
                    renderBotRequests();
                } catch (e) {
                    alert('خطأ في معالجة الطلب: ' + e.message);
                }
            },
            
            viewBotRequestDetails: async (requestKey) => {
                const snap = await db.ref(`botVerifications/${requestKey}`).once('value');
                const requestData = snap.val();
                
                if (!requestData) {
                    alert('الطلب غير موجود');
                    return;
                }
                
                let requirementsHTML = '';
                if (requestData.requirements && requestData.requirements.steps) {
                    requirementsHTML = '<ol>';
                    requestData.requirements.steps.forEach(step => {
                        requirementsHTML += `<li>${step}</li>`;
                    });
                    requirementsHTML += '</ol>';
                }
                
                mainContent.innerHTML = `<div class="page active">
                    <h3>تفاصيل طلب البوت</h3>
                    
                    <div class="card">
                        <h4>معلومات المستخدم</h4>
                        <div class="user-info-item">
                            <span>الاسم:</span>
                            <span>${requestData.userName || 'غير معروف'}</span>
                        </div>
                        <div class="user-info-item">
                            <span>اسم المستخدم:</span>
                            <span>@${requestData.username || 'لا يوجد'}</span>
                        </div>
                        <div class="user-info-item">
                            <span>معرف المستخدم:</span>
                            <span>${requestData.userId}</span>
                        </div>
                        <div class="user-info-item">
                            <span>تاريخ الطلب:</span>
                            <span>${new Date(requestData.submittedAt).toLocaleString('ar-EG')}</span>
                        </div>
                        ${requestData.processedAt ? `
                        <div class="user-info-item">
                            <span>تاريخ المعالجة:</span>
                            <span>${new Date(requestData.processedAt).toLocaleString('ar-EG')}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${requirementsHTML ? `
                    <div class="card">
                        <h4>متطلبات المهمة</h4>
                        ${requirementsHTML}
                    </div>
                    ` : ''}
                    
                    ${requestData.screenshot ? `
                    <div class="card">
                        <h4>لقطة الشاشة المرفوعة</h4>
                        <img src="${requestData.screenshot}" alt="لقطة الشاشة" style="max-width: 100%; border-radius: 8px; cursor: pointer;" onclick="window.adminActions.viewImage('${requestData.screenshot}')">
                    </div>
                    ` : ''}
                    
                    <button class="action-btn btn-primary" onclick="renderBotRequests()">العودة إلى طلبات البوت</button>
                </div>`;
            },
            
            deleteBotRequest: async (requestKey) => {
                if (confirm('هل أنت متأكد من حذف هذا الطلب؟')) {
                    try {
                        await db.ref(`botVerifications/${requestKey}`).remove();
                        alert('تم حذف الطلب بنجاح!');
                        renderBotRequests();
                    } catch (e) {
                        alert('خطأ في حذف الطلب: ' + e.message);
                    }
                }
            },
            
            // عرض الصور
            viewImage: (imageUrl) => {
                modalImage.src = imageUrl;
                imageModal.style.display = 'flex';
            }
        };

        // إغلاق modal الصورة
        modalClose.addEventListener('click', () => {
            imageModal.style.display = 'none';
        });

        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                imageModal.style.display = 'none';
            }
        });

        // ========== تهيئة لوحة التحكم ==========

        const initAdminPanel = () => {
            renderDashboard();
            setupSubmenus();
            
            // مستمعي الأحداث للقائمة
            document.querySelectorAll('.nav-menu li, .nav-submenu li').forEach(item => {
                if (item.classList.contains('has-submenu')) return;
                
                item.addEventListener('click', function() {
                    if (this.parentElement.classList.contains('nav-submenu')) {
                        document.querySelectorAll('.nav-menu li').forEach(i => i.classList.remove('active'));
                        this.parentElement.previousElementSibling.classList.add('active');
                    } else {
                        document.querySelectorAll('.nav-menu li').forEach(i => i.classList.remove('active'));
                        this.classList.add('active');
                    }
                    
                    const page = this.getAttribute('data-page');
                    pageTitle.textContent = this.textContent.trim();
                    
                    // تحميل الصفحة المناسبة
                    if (page === 'dashboard') renderDashboard();
                    else if (page === 'users') renderUsers();
                    else if (page === 'user-search') renderUserSearch();
                    else if (page === 'withdrawals') renderWithdrawals();
                    else if (page === 'history') renderWithdrawalHistory();
                    else if (page === 'codes-all') renderCodesAll();
                    else if (page === 'codes-create') renderCodesCreate();
                    else if (page === 'codes-stats') renderCodesStats();
                    else if (page === 'tasks-all') renderTasksAll();
                    else if (page === 'tasks-create') renderTasksCreate();
                    else if (page === 'tasks-stats') renderTasksStats();
                    else if (page === 'bot-requests') renderBotRequests();
                    else if (page === 'contest') renderContest();
                    else if (page === 'settings') renderSettings();
                    else if (page === 'broadcast') renderBroadcast();
                    
                    if (window.innerWidth < 768) {
                        sidebar.classList.remove('open');
                        overlay.classList.remove('show');
                    }
                });
            });
            
            // مستمعي الأحداث للقائمة الجانبية
            document.getElementById('menu-toggle').addEventListener('click', () => {
                sidebar.classList.add('open');
                overlay.classList.add('show');
            });
            
            document.querySelector('#sidebar .close-btn').addEventListener('click', () => {
                sidebar.classList.remove('open');
                overlay.classList.remove('show');
            });
            
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                overlay.classList.remove('show');
            });
        };

        // ========== دوال الصفحات الأساسية (سيتم استكمالها) ==========

        const renderDashboard = async () => {
            // كود لوحة التحكم الأساسية
            mainContent.innerHTML = `<div id="dashboard" class="page active">
                <h3>لوحة التحكم الرئيسية</h3>
                <div class="card">
                    <p>مرحباً بك في لوحة التحكم المتقدمة لتطبيق TON Rewards</p>
                    <p>استخدم القائمة الجانبية للوصول إلى جميع الأقسام المتاحة.</p>
                </div>
            </div>`;
        };

        const renderUsers = () => {
            mainContent.innerHTML = `<div id="users" class="page active">
                <h3>إدارة المستخدمين</h3>
                <div class="card">
                    <p>هذا القسم قيد التطوير...</p>
                </div>
            </div>`;
        };

        // باقي دوالت الصفحات الأساسية...
        const renderUserSearch = () => { /* ... */ };
        const renderWithdrawals = () => { /* ... */ };
        const renderWithdrawalHistory = () => { /* ... */ };
        const renderContest = () => { /* ... */ };
        const renderSettings = () => { /* ... */ };
        const renderBroadcast = () => { /* ... */ };
    });
    </script>
</body>
</html>

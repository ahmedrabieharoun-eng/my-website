<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <style>
        :root {
            --primary: #2980B9; --secondary: #2C3E50; --light: #ECF0F1; --dark: #34495E;
            --success: #27AE60; --danger: #C0392B; --surface: #FFFFFF;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--light); }
        #app-container { transition: filter 0.3s; }
        
        #top-bar {
            background-color: var(--secondary); color: white; padding: 0 15px;
            display: flex; align-items: center; height: 60px;
            position: sticky; top: 0; z-index: 1000;
        }
        #menu-toggle { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        #page-title { font-size: 1.2rem; margin-left: 15px; }

        #sidebar {
            position: fixed; top: 0; left: 0; width: 260px; height: 100vh;
            background-color: var(--secondary); color: white; z-index: 2000;
            transform: translateX(-100%); transition: transform 0.3s ease-in-out;
            display: flex; flex-direction: column;
        }
        #sidebar.open { transform: translateX(0); }
        #sidebar-header { padding: 20px; text-align: center; }
        #sidebar-header .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.8rem; cursor: pointer; }
        .nav-menu { list-style: none; padding: 0; margin: 0; }
        .nav-menu li { padding: 15px 20px; cursor: pointer; border-left: 4px solid transparent; transition: all 0.2s; }
        .nav-menu li:hover, .nav-menu li.active { background-color: var(--dark); border-left-color: var(--primary); }
        .nav-menu li i { margin-right: 12px; width: 20px; text-align: center; }
        #logout-btn { margin-top: auto; }

        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 1999; display: none;
        }
        #overlay.show { display: block; }
        
        #main-content { padding: 20px; }
        .page { display: none; } .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background-color: var(--surface); border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 20px; }
        h1, h3, h4 { color: var(--secondary); margin-bottom: 15px; }
        
        table { width: 100%; border-collapse: collapse; }
        thead { display: none; }
        tr { display: block; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; padding: 10px; }
        td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        td:last-child { border-bottom: none; }
        td::before { content: attr(data-label); font-weight: bold; margin-right: 10px; }
        .action-buttons { text-align: right; width: 100%; }
        .action-btn { padding: 8px 12px; border: none; border-radius: 5px; color: white; cursor: pointer; margin: 2px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; text-align: left; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        .btn-success { background-color: var(--success); } .btn-danger { background-color: var(--danger); } .btn-primary { background-color: var(--primary); } .btn-warning { background-color: #F39C12; }
        .dynamic-item-list { list-style: none; padding-left: 0; }
        .dynamic-item-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--light); }
        .withdraw-method-group { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        
        /* أنماط جديدة */
        .user-status-banned { background-color: rgba(192, 57, 43, 0.1); border-left: 4px solid var(--danger); }
        .user-status-banned td:first-child::before { content: "🚫 " attr(data-label); }
        .settings-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 768px) { .settings-grid { grid-template-columns: 1fr 1fr; } }
        .setting-card { background-color: var(--surface); border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        @media (min-width: 768px) {
            #app-container { display: flex; }
            #top-bar { display: none; }
            #sidebar { position: static; transform: translateX(0); width: 250px; height: 100vh; }
            #sidebar-header .close-btn { display: none; }
            #main-content { flex-grow: 1; padding: 30px; }
            thead { display: table-header-group; }
            tr { display: table-row; margin-bottom: 0; border: none; padding: 0; }
            td { display: table-cell; padding: 12px; border-bottom: 1px solid #ddd; }
            td::before { display: none; }
            .action-buttons { text-align: left; }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <aside id="sidebar">
            <div>
                <div id="sidebar-header"><h2><i class="fas fa-shield-alt"></i> Admin Panel</h2><span class="close-btn">&times;</span></div>
                <ul class="nav-menu">
                    <li data-page="dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
                    <li data-page="users"><i class="fas fa-users"></i> Users</li>
                    <li data-page="withdrawals"><i class="fas fa-wallet"></i> Pending Withdrawals</li>
                    <li data-page="history"><i class="fas fa-history"></i> Withdrawal History</li>
                    <li data-page="tasks"><i class="fas fa-tasks"></i> Tasks & Links</li>
                    <li data-page="settings"><i class="fas fa-cog"></i> App Settings</li>
                    <li data-page="broadcast"><i class="fas fa-bullhorn"></i> Broadcast</li>
                </ul>
            </div>
            <!-- Logout button is removed as there is no login -->
        </aside>
        
        <div id="overlay"></div>

        <div id="content-wrapper" style="width: 100%;">
            <header id="top-bar">
                <button id="menu-toggle"><i class="fas fa-bars"></i></button>
                <h1 id="page-title">Dashboard</h1>
            </header>
            <main id="main-content"></main>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
            apiKey: "AIzaSyAk909CcFWn4ZMeBEM1yxRbQbW9w6UNo58",
            authDomain: "earn-money-c3bad.firebaseapp.com",
            databaseURL: "https://earn-money-c3bad-default-rtdb.firebaseio.com",
            projectId: "earn-money-c3bad",
            storageBucket: "earn-money-c3bad.firebasestorage.app",
            messagingSenderId: "1022688566011",
            appId: "1:1022688566011:web:690f6faa19dd3337a2ee5e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        const mainContent = document.getElementById('main-content');
        const pageTitle = document.getElementById('page-title');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        // Login system removed, panel loads directly.
        
        const renderDashboard = async () => {
            const usersSnap = await db.ref('users').once('value');
            const withdrawalsSnap = await db.ref('withdrawals/pending').once('value');
            
            // حساب المستخدمين المحظورين
            let bannedUsersCount = 0;
            usersSnap.forEach(child => {
                if (child.val().banned) bannedUsersCount++;
            });
            
            mainContent.innerHTML = `<div id="dashboard" class="page active">
                <div class="card"><h3>Total Users</h3><h1>${usersSnap.numChildren()}</h1></div>
                <div class="card"><h3>Pending Withdrawals</h3><h1>${withdrawalsSnap.numChildren()}</h1></div>
                <div class="card"><h3>Banned Users</h3><h1>${bannedUsersCount}</h1></div>
            </div>`;
        };
        
        const renderUsers = async () => {
            mainContent.innerHTML = '<div class="card"><h3>Loading Users...</h3></div>';
            const snap = await db.ref('users').orderByChild('firstName').once('value'); 
            let tableContent = '';
            
            snap.forEach(child => {
                const user = child.val();
                const isBanned = user.banned || false;
                const statusClass = isBanned ? 'user-status-banned' : '';
                const banButtonText = isBanned ? 'Unban User' : 'Ban User';
                const banButtonClass = isBanned ? 'btn-warning' : 'btn-danger';
                
                tableContent += `<tr class="${statusClass}">
                    <td data-label="User">${user.firstName || ''} ${user.lastName || ''}<br><small>${user.id}</small>${isBanned ? ' <span style="color:red">🚫 BANNED</span>' : ''}</td>
                    <td data-label="Balance">${(user.balance || 0).toFixed(4)} TON</td>
                    <td data-label="Referrals">${user.referrals || 0}</td>
                    <td data-label="Actions">
                        <div class="action-buttons">
                            <button class="action-btn btn-primary" onclick="window.adminActions.addBalance('${user.id}', '${user.firstName}')">Add Balance</button>
                            <button class="action-btn btn-danger" onclick="window.adminActions.removeBalance('${user.id}', '${user.firstName}')">Remove Balance</button>
                            <button class="action-btn ${banButtonClass}" onclick="window.adminActions.toggleUserBan('${user.id}', '${user.firstName}', ${isBanned})">${banButtonText}</button>
                        </div>
                    </td>
                </tr>`;
            });
            
            mainContent.innerHTML = `<div id="users" class="page active">
                <h3>All Users</h3>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Balance</th>
                                <th>Referrals</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>${tableContent}</tbody>
                    </table>
                </div>
            </div>`;
        };
        
        const renderWithdrawals = async () => {
            mainContent.innerHTML = '<div class="card"><h3>Loading Requests...</h3></div>';
            const snap = await db.ref('withdrawals/pending').orderByChild('timestamp').once('value'); 
            let tableContent = '';
            let requests = [];
            snap.forEach(child => { requests.push(child.val()); });
            requests.reverse(); // Show newest first
            requests.forEach(req => {
                tableContent += `<tr>
                    <td data-label="User">${req.userName}<br><small>${new Date(req.timestamp).toLocaleString()}</small></td>
                    <td data-label="Amount"><b>${req.amount.toFixed(4)} TON</b><br><small>${req.method} | ${req.account}</small></td>
                    <td data-label="Actions">
                        <div class="action-buttons">
                            <button class="action-btn btn-success" onclick="window.adminActions.handleWithdrawal('${req.id}', 'approve')">Approve</button>
                            <button class="action-btn btn-danger" onclick="window.adminActions.handleWithdrawal('${req.id}', 'reject')">Reject</button>
                        </div>
                    </td>
                </tr>`;
            });
            mainContent.innerHTML = `<div id="withdrawals" class="page active">
                <h3>Pending Withdrawals</h3>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>User & Date</th>
                                <th>Amount & Details</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>${tableContent || '<tr><td colspan=3>No pending requests</td></tr>'}</tbody>
                    </table>
                </div>
            </div>`;
        };
        
        const renderWithdrawalHistory = async () => {
            mainContent.innerHTML = '<div class="card"><h3>Loading History...</h3></div>';
            const completedSnap = await db.ref('withdrawals/completed').orderByChild('timestamp').limitToLast(100).once('value');
            const rejectedSnap = await db.ref('withdrawals/rejected').orderByChild('timestamp').limitToLast(100).once('value');
            let completedRows = '', rejectedRows = '';
            
            let completed = [];
            completedSnap.forEach(child => { completed.push(child.val()); });
            completed.reverse();
            completed.forEach(req => { 
                completedRows += `<tr>
                    <td data-label="User">${req.userName}</td>
                    <td data-label="Amount">${req.amount.toFixed(4)} TON</td>
                    <td data-label="Date">${new Date(req.timestamp).toLocaleDateString()}</td>
                    <td data-label="Status">Completed</td>
                </tr>`; 
            });

            let rejected = [];
            rejectedSnap.forEach(child => { rejected.push(child.val()); });
            rejected.reverse();
            rejected.forEach(req => { 
                rejectedRows += `<tr>
                    <td data-label="User">${req.userName}</td>
                    <td data-label="Amount">${req.amount.toFixed(4)} TON</td>
                    <td data-label="Date">${new Date(req.timestamp).toLocaleDateString()}</td>
                    <td data-label="Status">Rejected</td>
                </tr>`; 
            });
            
            mainContent.innerHTML = `
                <div id="history" class="page active">
                    <h3>Withdrawal History</h3>
                    <div class="card">
                        <h4>Completed Requests</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>${completedRows || '<tr><td colspan="4">No completed requests.</td></tr>'}</tbody>
                        </table>
                    </div>
                    <div class="card">
                        <h4>Rejected Requests</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>${rejectedRows || '<tr><td colspan="4">No rejected requests.</td></tr>'}</tbody>
                        </table>
                    </div>
                </div>`;
        };

        const renderTasks = async () => {
             mainContent.innerHTML = `<div id="tasks" class="page active">
                <h3>Manage Tasks & Links</h3>
                <div class="card" id="tasks-list"><h4>Loading tasks...</h4></div>
                <div class="card">
                    <h4>Add New Task</h4>
                    <div class="form-group"><input id="task-name" placeholder="Task Name (e.g., Join Telegram)"></div>
                    <div class="form-group"><input id="task-url" placeholder="URL"></div>
                    <div class="form-group"><input id="task-reward" type="number" step="any" placeholder="Reward Amount"></div>
                    <div class="form-group"><input id="task-icon" placeholder="Image Icon URL"></div>
                    <button class="action-btn btn-primary" onclick="window.adminActions.addTask()">Add Task</button>
                </div>
                <div class="card" id="links-list"><h4>Loading links...</h4></div>
                <div class="card">
                    <h4>Add New Link/Button</h4>
                    <div class="form-group"><input id="link-name" placeholder="Button Name (e.g., Official Channel)"></div>
                    <div class="form-group"><input id="link-url" placeholder="URL"></div>
                    <div class="form-group"><input id="link-icon" placeholder="Image Icon URL"></div>
                    <button class="action-btn btn-primary" onclick="window.adminActions.addLink()">Add Link</button>
                </div>
            </div>`;
            loadDynamicContent('tasks'); 
            loadDynamicContent('links');
        };

        const renderSettings = async () => {
            const snap = await db.ref('config').once('value'); 
            const config = snap.val() || {};
            
            mainContent.innerHTML = `<div id="settings" class="page active">
                <h3>App Settings</h3>
                <div class="card">
                    <div class="settings-grid">
                        <div class="setting-card">
                            <h4>Bot Settings</h4>
                            <div class="form-group">
                                <label>Bot Username (without @)</label>
                                <input type="text" id="botUsername" value="${config.botUsername || ''}">
                            </div>
                            <div class="form-group">
                                <label>Telegram Bot Token</label>
                                <input type="text" id="botToken" value="${config.botToken || ''}">
                            </div>
                            <div class="form-group">
                                <label>Welcome Message</label>
                                <textarea id="welcomeMessage">${config.welcomeMessage || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="setting-card">
                            <h4>Ad Settings</h4>
                            <div class="form-group">
                                <label>Ad Network Zone ID</label>
                                <input type="number" id="adZoneId" value="${config.adZoneId || ''}">
                            </div>
                            <div class="form-group">
                                <label>Value per Ad (TON)</label>
                                <input type="number" step="any" id="adValue" value="${config.adValue || 0}">
                            </div>
                            <div class="form-group">
                                <label>Daily Ad Limit</label>
                                <input type="number" id="dailyAdLimit" value="${config.dailyAdLimit || 0}">
                            </div>
                        </div>
                        
                        <div class="setting-card">
                            <h4>Ad Cooldown Settings</h4>
                            <div class="form-group">
                                <label>Ad Cooldown (Seconds)</label>
                                <input type="number" id="adCooldown" value="${config.adCooldown || 10}">
                                <small>Time between ads in seconds</small>
                            </div>
                            <div class="form-group">
                                <label>Minimum Ad Duration (Seconds)</label>
                                <input type="number" id="minAdDuration" value="${config.minAdDuration || 5}">
                                <small>Minimum time user must watch ad to earn reward</small>
                            </div>
                            <div class="form-group">
                                <label>Ads Before Break</label>
                                <input type="number" id="adsPerBreak" value="${config.adsPerBreak || 0}">
                            </div>
                            <div class="form-group">
                                <label>Break Duration (Minutes)</label>
                                <input type="number" id="breakDuration" value="${config.breakDuration || 0}">
                            </div>
                        </div>
                        
                        <div class="setting-card">
                            <h4>Referral & Withdrawal</h4>
                            <div class="form-group">
                                <label>Referral Bonus (TON)</label>
                                <input type="number" step="any" id="referralBonus" value="${config.referralBonus || 0}">
                            </div>
                            <div class="form-group">
                                <label>Minimum Referrals for Withdraw</label>
                                <input type="number" id="minimumWithdrawReferrals" value="${config.minimumWithdrawReferrals || 0}">
                            </div>
                            <div id="withdraw-methods-container"></div>
                            <button class="action-btn btn-primary" onclick="window.adminActions.addWithdrawMethodField()">+ Add Method</button>
                        </div>
                    </div>
                    
                    <hr style="margin: 20px 0;">
                    <button class="action-btn btn-success" style="width:100%; padding:15px;" onclick="window.adminActions.saveSettings()">Save All Settings</button>
                </div>
            </div>`;
            renderWithdrawMethods(config.withdrawMethods);
        };
        
        const renderBroadcast = () => {
             mainContent.innerHTML = `<div id="broadcast" class="page active">
                <h3>Broadcast Message</h3>
                <div class="card">
                    <p>This message will be sent to all users. <strong>Important:</strong> This requires a server-side function (like Firebase Cloud Functions) to work correctly.</p>
                    <div class="form-group">
                        <textarea id="broadcast-message" rows="5" placeholder="Your message here..."></textarea>
                    </div>
                    <button class="action-btn btn-danger" onclick="window.adminActions.sendBroadcast()">Queue Broadcast</button>
                </div>
            </div>`;
        };

        const loadDynamicContent = async (type) => {
            const container = document.getElementById(`${type}-list`);
            const snap = await db.ref(`config/${type}`).once('value');
            let items = [];
            snap.forEach(child => { items.push({ key: child.key, ...child.val() }); });
            items.reverse(); // Show newest first
            
            let content = `<h4>Current ${type.charAt(0).toUpperCase() + type.slice(1)}</h4>`;
            if (items.length > 0) {
                content += '<ul class="dynamic-item-list">';
                items.forEach(item => {
                    content += `<li>${item.name} <button class="action-btn btn-danger" style="padding: 5px 8px;" onclick="window.adminActions.deleteDynamicItem('${type}', '${item.key}')"><i class="fas fa-trash"></i></button></li>`;
                });
                content += '</ul>';
            } else { content += `<p>No ${type} found.</p>`; }
            container.innerHTML = content;
        };
        
        const renderWithdrawMethods = (methods) => {
            const container = document.getElementById('withdraw-methods-container'); 
            container.innerHTML = '';
            if (methods) {
                methods.forEach((method, index) => {
                    container.innerHTML += `
                        <div class="withdraw-method-group" data-index="${index}">
                            <input value="${method.name || ''}" placeholder="Method Name">
                            <input type="number" step="any" value="${method.min || ''}" placeholder="Min Amount">
                            <button class="action-btn btn-danger" onclick="this.parentElement.remove()">X</button>
                        </div>`;
                });
            }
        };

        window.adminActions = {
            // ✅ إضافة رصيد
            addBalance: async (userId, userName) => {
                const amount = prompt(`Enter amount to ADD for ${userName}:`);
                if (amount && !isNaN(parseFloat(amount)) && parseFloat(amount) > 0) { 
                    try { 
                        await db.ref(`users/${userId}/balance`).set(firebase.database.ServerValue.increment(parseFloat(amount))); 
                        alert('Balance added successfully!'); 
                        renderUsers(); 
                    } catch (e) { 
                        alert('Error adding balance.'); 
                    } 
                } else {
                    alert('Please enter a valid positive amount.');
                }
            },
            
            // ✅ خصم رصيد
            removeBalance: async (userId, userName) => {
                const amount = prompt(`Enter amount to REMOVE from ${userName}:`);
                if (amount && !isNaN(parseFloat(amount)) && parseFloat(amount) > 0) { 
                    try { 
                        await db.ref(`users/${userId}/balance`).set(firebase.database.ServerValue.increment(-parseFloat(amount))); 
                        alert('Balance removed successfully!'); 
                        renderUsers(); 
                    } catch (e) { 
                        alert('Error removing balance.'); 
                    } 
                } else {
                    alert('Please enter a valid positive amount.');
                }
            },
            
            // ✅ حظر/فك حظر المستخدم
            toggleUserBan: async (userId, userName, isCurrentlyBanned) => {
                const action = isCurrentlyBanned ? 'unban' : 'ban';
                const confirmMessage = isCurrentlyBanned ? 
                    `Are you sure you want to UNBAN ${userName}?` : 
                    `Are you sure you want to BAN ${userName}? They will not be able to use the app.`;
                
                if (confirm(confirmMessage)) {
                    try {
                        await db.ref(`users/${userId}/banned`).set(!isCurrentlyBanned);
                        alert(`User ${isCurrentlyBanned ? 'unbanned' : 'banned'} successfully!`);
                        renderUsers();
                    } catch (e) {
                        alert('Error updating user status.');
                    }
                }
            },
            
            handleWithdrawal: async (reqId, action) => {
                const reqRef = db.ref(`withdrawals/pending/${reqId}`); 
                const snap = await reqRef.once('value'); 
                const request = snap.val();
                if (!request) { alert('Request not found.'); return; }
                if (action === 'reject') { 
                    await db.ref(`users/${request.userId}/balance`).set(firebase.database.ServerValue.increment(request.amount));
                }
                const status = action === 'approve' ? 'completed' : 'rejected';
                await db.ref(`withdrawals/${status}/${reqId}`).set({ ...request, status });
                await reqRef.remove(); 
                alert(`Request has been ${status}.`); 
                renderWithdrawals();
            },
            
            addTask: async () => {
                const data = { 
                    name: document.getElementById('task-name').value, 
                    url: document.getElementById('task-url').value, 
                    reward: parseFloat(document.getElementById('task-reward').value), 
                    icon: document.getElementById('task-icon').value 
                };
                if (!data.name || !data.url || !data.reward || !data.icon) { 
                    alert('All fields are required.'); 
                    return; 
                }
                await db.ref('config/tasks').push(data); 
                alert('Task added!'); 
                renderTasks();
            },
            
            addLink: async () => {
                const data = { 
                    name: document.getElementById('link-name').value, 
                    url: document.getElementById('link-url').value, 
                    icon: document.getElementById('link-icon').value 
                };
                if (!data.name || !data.url || !data.icon) { 
                    alert('Name, URL and Icon URL are required.'); 
                    return; 
                }
                await db.ref('config/links').push(data); 
                alert('Link added!'); 
                renderTasks();
            },
            
            deleteDynamicItem: async (type, key) => {
                if (confirm(`Are you sure you want to delete this item?`)) { 
                    await db.ref(`config/${type}/${key}`).remove(); 
                    alert('Item deleted.'); 
                    renderTasks(); 
                }
            },
            
            addWithdrawMethodField: () => {
                 document.getElementById('withdraw-methods-container').innerHTML += `
                    <div class="withdraw-method-group">
                        <input placeholder="Method Name">
                        <input type="number" step="any" placeholder="Min Amount">
                        <button class="action-btn btn-danger" onclick="this.parentElement.remove()">X</button>
                    </div>`;
            },
            
            saveSettings: async () => {
                const withdrawMethods = [];
                document.querySelectorAll('.withdraw-method-group').forEach(group => {
                    const name = group.children[0].value; 
                    const min = parseFloat(group.children[1].value);
                    if (name && min) { withdrawMethods.push({ name, min }); }
                });
                
                const settings = {
                    botUsername: document.getElementById('botUsername').value,
                    botToken: document.getElementById('botToken').value,
                    welcomeMessage: document.getElementById('welcomeMessage').value,
                    adZoneId: document.getElementById('adZoneId').value,
                    adValue: parseFloat(document.getElementById('adValue').value),
                    dailyAdLimit: parseInt(document.getElementById('dailyAdLimit').value),
                    // ✅ إعدادات مهلة الإعلانات الجديدة
                    adCooldown: parseInt(document.getElementById('adCooldown').value) || 10,
                    minAdDuration: parseInt(document.getElementById('minAdDuration').value) || 5,
                    adsPerBreak: parseInt(document.getElementById('adsPerBreak').value),
                    breakDuration: parseInt(document.getElementById('breakDuration').value),
                    referralBonus: parseFloat(document.getElementById('referralBonus').value),
                    minimumWithdrawReferrals: parseInt(document.getElementById('minimumWithdrawReferrals').value) || 0,
                    withdrawMethods: withdrawMethods
                };
                
                await db.ref('config').update(settings); 
                alert('Settings saved successfully!');
            },
            
            sendBroadcast: async () => {
                const message = document.getElementById('broadcast-message').value;
                if (!message || !confirm('Are you sure you want to queue this broadcast?')) { return; }
                await db.ref('broadcastQueue').push({ message, timestamp: Date.now(), status: 'pending' });
                alert('Broadcast has been added to the queue. The server will now process it.');
            }
        };

        const setupNavigation = () => {
            const navLinks = document.querySelectorAll('.nav-menu li');
            const pageMap = { 
                dashboard: renderDashboard, 
                users: renderUsers, 
                withdrawals: renderWithdrawals, 
                history: renderWithdrawalHistory, 
                tasks: renderTasks, 
                settings: renderSettings, 
                broadcast: renderBroadcast 
            };
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const pageKey = e.currentTarget.dataset.page;
                    if (pageKey) {
                        navLinks.forEach(l => l.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        pageTitle.textContent = e.currentTarget.textContent.trim();
                        pageMap[pageKey]();
                        sidebar.classList.remove('open'); 
                        overlay.classList.remove('show');
                    }
                });
            });
        };
        
        const setupMobileMenu = () => {
            const menuToggle = document.getElementById('menu-toggle');
            const closeBtn = document.querySelector('#sidebar .close-btn');
            menuToggle.addEventListener('click', () => { 
                sidebar.classList.add('open'); 
                overlay.classList.add('show'); 
            });
            closeBtn.addEventListener('click', () => { 
                sidebar.classList.remove('open'); 
                overlay.classList.remove('show'); 
            });
            overlay.addEventListener('click', () => { 
                sidebar.classList.remove('open'); 
                overlay.classList.remove('show'); 
            });
        };

        const initAdminPanel = () => { 
            setupNavigation(); 
            setupMobileMenu(); 
            renderDashboard(); 
        };
        
        // Initialize the panel directly
        initAdminPanel();
    });
    </script>
</body>
</html>